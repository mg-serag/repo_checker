[
  {
    "instance_id": "medplum__medplum-6843",
    "pr_id": 6843,
    "issue_id": 6392,
    "repo": "medplum/medplum",
    "problem_statement": "Reindex should log resource ID on errors\nTo facilitate debugging/addressing reindex logic errors such as:\n\n```\nTypeError: Cannot read properties of null (reading 'city')\n    at AddressTable.extractValues (/usr/src/medplum/packages/server/dist/fhir/lookups/address.js:63:31)\n    at AddressTable.batchIndexResources (/usr/src/medplum/packages/server/dist/fhir/lookups/lookuptable.js:50:22)\n    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at async AddressTable.batchIndexResources (/usr/src/medplum/packages/server/dist/fhir/lookups/address.js:75:9)\n    at async Repository.batchWriteLookupTables (/usr/src/medplum/packages/server/dist/fhir/repo.js:1379:13)\n    at async Repository.reindexResources (/usr/src/medplum/packages/server/dist/fhir/repo.js:705:9)\n    at async /usr/src/medplum/packages/server/dist/workers/reindex.js:161:21\n    at async Repository.withTransaction (/usr/src/medplum/packages/server/dist/fhir/repo.js:1857:32)\n    at async ReindexJob.processIteration (/usr/src/medplum/packages/server/dist/workers/reindex.js:157:13)\n    at async ReindexJob.execute (/usr/src/medplum/packages/server/dist/workers/reindex.js:120:28)\n```",
    "issue_word_count": 167,
    "test_files_count": 2,
    "non_test_files_count": 2,
    "pr_changed_files": [
      "packages/server/src/fhir/lookups/address.test.ts",
      "packages/server/src/fhir/lookups/lookuptable.ts",
      "packages/server/src/fhir/repo.test.ts",
      "packages/server/src/fhir/repo.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/lookups/address.test.ts",
      "packages/server/src/fhir/repo.test.ts"
    ],
    "base_commit": "5f02a1ded47955cf02de6fdd4d5ba0e4dace6cdd",
    "head_commit": "884180264a670cf367ebfe718c1a98f3a0caf8ca",
    "repo_url": "https://github.com/medplum/medplum/pull/6843",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6843",
    "dockerfile": "",
    "pr_merged_at": "2025-06-23T23:34:05.000Z",
    "patch": "diff --git a/packages/server/src/fhir/lookups/lookuptable.ts b/packages/server/src/fhir/lookups/lookuptable.ts\nindex 0a34f2f2c8..50b6d130a6 100644\n--- a/packages/server/src/fhir/lookups/lookuptable.ts\n+++ b/packages/server/src/fhir/lookups/lookuptable.ts\n@@ -1,6 +1,7 @@\n import { Operator as FhirOperator, Filter, SortRule, splitSearchOnComma, WithId } from '@medplum/core';\n import { Resource, ResourceType, SearchParameter } from '@medplum/fhirtypes';\n import { Pool, PoolClient } from 'pg';\n+import { getLogger } from '../../logger';\n import {\n   Column,\n   Condition,\n@@ -102,7 +103,15 @@ export abstract class LookupTable {\n             `batchIndexResources must be called with resources of the same type: ${resource.resourceType} vs ${resourceType}`\n           );\n         }\n-        this.extractValues(newRows, resource);\n+        try {\n+          this.extractValues(newRows, resource);\n+        } catch (err) {\n+          getLogger().error('Error extracting values for resource', {\n+            resource: `${resourceType}/${resource.id}`,\n+            err,\n+          });\n+          throw err;\n+        }\n       }\n \n       if (newRows.length > 0) {\n\ndiff --git a/packages/server/src/fhir/repo.ts b/packages/server/src/fhir/repo.ts\nindex a694d0e269..3ec3a986f2 100644\n--- a/packages/server/src/fhir/repo.ts\n+++ b/packages/server/src/fhir/repo.ts\n@@ -1457,8 +1457,16 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     const searchParams = getStandardAndDerivedSearchParameters(resourceType);\n     if (searchParams.length > 0) {\n       const startTime = process.hrtime.bigint();\n-      for (const searchParam of searchParams) {\n-        this.buildColumn(resource, row, searchParam);\n+      try {\n+        for (const searchParam of searchParams) {\n+          this.buildColumn(resource, row, searchParam);\n+        }\n+      } catch (err) {\n+        getLogger().error('Error building row for resource', {\n+          resource: `${resourceType}/${resource.id}`,\n+          err,\n+        });\n+        throw err;\n       }\n       recordHistogramValue(\n         'medplum.server.indexingDurationMs',\n",
    "test_patch": "diff --git a/packages/server/src/fhir/lookups/address.test.ts b/packages/server/src/fhir/lookups/address.test.ts\nindex 295414ee41..382b6dd036 100644\n--- a/packages/server/src/fhir/lookups/address.test.ts\n+++ b/packages/server/src/fhir/lookups/address.test.ts\n@@ -4,6 +4,7 @@ import { randomUUID } from 'crypto';\n import { PoolClient } from 'pg';\n import { initAppServices, shutdownApp } from '../../app';\n import { loadTestConfig } from '../../config/loader';\n+import { getLogger } from '../../logger';\n import { withTestContext } from '../../test.setup';\n import { getSystemRepo } from '../repo';\n import { AddressTable, AddressTableRow } from './address';\n@@ -402,4 +403,38 @@ describe('Address Lookup Table', () => {\n       },\n     ]);\n   });\n+\n+  test('Errors logged and rethrown', async () => {\n+    const db = { query: jest.fn().mockReturnValue({ rowCount: 0, rows: [] }) } as unknown as PoolClient;\n+    const table = new AddressTable();\n+    const r1: WithId<Patient> = {\n+      resourceType: 'Patient',\n+      id: '1',\n+      name: [{ given: ['Alice'], family: 'Smith' }],\n+      address: [\n+        {\n+          line: ['500 Jefferson Street'],\n+          city: 'San Francisco',\n+          state: 'CA',\n+          postalCode: '94109',\n+        },\n+      ] as unknown as Address[],\n+    };\n+\n+    const extractValuesSpy = jest.spyOn(table, 'extractValues').mockImplementation(() => {\n+      throw new Error('test error');\n+    });\n+\n+    const logger = getLogger();\n+    const errorSpy = jest.spyOn(logger, 'error').mockImplementation(() => {});\n+\n+    await expect(async () => table.batchIndexResources(db, [r1], false)).rejects.toThrow('test error');\n+    expect(extractValuesSpy).toHaveBeenCalledTimes(1);\n+    expect(errorSpy).toHaveBeenCalledWith('Error extracting values for resource', {\n+      resource: 'Patient/1',\n+      err: expect.any(Error),\n+    });\n+\n+    errorSpy.mockClear();\n+  });\n });\n\ndiff --git a/packages/server/src/fhir/repo.test.ts b/packages/server/src/fhir/repo.test.ts\nindex 470cbe434b..fc36143895 100644\n--- a/packages/server/src/fhir/repo.test.ts\n+++ b/packages/server/src/fhir/repo.test.ts\n@@ -41,6 +41,7 @@ import { registerNew, RegisterRequest } from '../auth/register';\n import { loadTestConfig } from '../config/loader';\n import { r4ProjectId } from '../constants';\n import { DatabaseMode, getDatabasePool } from '../database';\n+import { getLogger } from '../logger';\n import { bundleContains, createTestProject, withTestContext } from '../test.setup';\n import { getRepoForLogin } from './accesspolicy';\n import { TokenTable } from './lookups/token';\n@@ -651,6 +652,33 @@ describe('FHIR Repo', () => {\n     }\n   });\n \n+  test('Reindex resource errors logged', async () => {\n+    const patient1 = await systemRepo.createResource<Patient>({\n+      resourceType: 'Patient',\n+      name: [{ given: ['Identifier'], family: 'Test' }],\n+      identifier: [{ system: 'https://example.com/', value: 'some-value' }],\n+    });\n+\n+    const buildColumnSpy = jest.spyOn(Repository.prototype as any, 'buildColumn').mockImplementation(() => {\n+      throw new Error('test error');\n+    });\n+    const logger = getLogger();\n+    const errorSpy = jest.spyOn(logger, 'error').mockImplementation(() => {});\n+\n+    await expect(\n+      systemRepo.withTransaction(async (conn) => {\n+        await systemRepo.reindexResources(conn, [patient1]);\n+      })\n+    ).rejects.toThrow('test error');\n+    expect(errorSpy).toHaveBeenCalledWith('Error building row for resource', {\n+      resource: 'Patient/' + patient1.id,\n+      err: expect.any(Error),\n+    });\n+\n+    buildColumnSpy.mockRestore();\n+    errorSpy.mockRestore();\n+  });\n+\n   test('Remove property', () =>\n     withTestContext(async () => {\n       const value = randomUUID();\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6773",
    "pr_id": 6773,
    "issue_id": 6774,
    "repo": "medplum/medplum",
    "problem_statement": "Add support for configuring WAF ACL logging destination in Medplum CDK stacks\nIssue Summary:\nCurrently, there's no way to configure the logging destination for WAF ACLs that are generated by the Medplum CDK stacks through Medplum's configuration settings.\n\n\nCurrent State:\n- Medplum config settings support WAF IP sets configuration\n- Load balancer logging bucket can be configured via loadBalancerLoggingBucket setting\n- No equivalent configuration option exists for WAF ACL logs\n\nExpected Behavior:\nUsers should be able to configure the logging destination for WAF ACLs through Medplum's config settings, similar to how other logging destinations are configured.\n\nWorkaround:\nCurrently requires manual AWS-side configuration following [AWS WAF logging documentation](https://docs.aws.amazon.com/waf/latest/developerguide/logging.html).",
    "issue_word_count": 118,
    "test_files_count": 1,
    "non_test_files_count": 5,
    "pr_changed_files": [
      "packages/cdk/src/backend.ts",
      "packages/cdk/src/frontend.ts",
      "packages/cdk/src/index.test.ts",
      "packages/cdk/src/storage.ts",
      "packages/cdk/src/waf.ts",
      "packages/core/src/config.ts"
    ],
    "pr_changed_test_files": [
      "packages/cdk/src/index.test.ts"
    ],
    "base_commit": "e6fb6c24ebff7ab02178441b572f59eb26c0bcdc",
    "head_commit": "173b5e5d55cd846fd61f579c3518c2aed4370c9c",
    "repo_url": "https://github.com/medplum/medplum/pull/6773",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6773",
    "dockerfile": "",
    "pr_merged_at": "2025-06-16T21:45:10.000Z",
    "patch": "diff --git a/packages/cdk/src/backend.ts b/packages/cdk/src/backend.ts\nindex 436f372899..63d1ccdec7 100644\n--- a/packages/cdk/src/backend.ts\n+++ b/packages/cdk/src/backend.ts\n@@ -19,7 +19,7 @@ import {\n import { Repository } from 'aws-cdk-lib/aws-ecr';\n import { ClusterInstance, DBClusterStorageType, ParameterGroup } from 'aws-cdk-lib/aws-rds';\n import { Construct } from 'constructs';\n-import { buildWafConfig } from './waf';\n+import { buildWaf } from './waf';\n \n /**\n  * Based on: https://github.com/aws-samples/http-api-aws-fargate-cdk/blob/master/cdk/singleAccount/lib/fargate-vpclink-stack.ts\n@@ -576,10 +576,14 @@ export class BackEnd extends Construct {\n     });\n \n     // WAF\n-    this.waf = new wafv2.CfnWebACL(\n+    this.waf = buildWaf(\n       this,\n       'BackEndWAF',\n-      buildWafConfig(`${config.stackName}-BackEndWAF`, 'REGIONAL', config.apiWafIpSetArn)\n+      `${config.stackName}-BackEndWAF`,\n+      'REGIONAL',\n+      config.apiWafIpSetArn,\n+      config.wafLogGroupName,\n+      config.wafLogGroupCreate\n     );\n \n     // Create an association between the load balancer and the WAF\n\ndiff --git a/packages/cdk/src/frontend.ts b/packages/cdk/src/frontend.ts\nindex 7be567f998..e143c1c6c1 100644\n--- a/packages/cdk/src/frontend.ts\n+++ b/packages/cdk/src/frontend.ts\n@@ -13,7 +13,7 @@ import {\n } from 'aws-cdk-lib';\n import { Construct } from 'constructs';\n import { grantBucketAccessToOriginAccessIdentity } from './oai';\n-import { buildWafConfig } from './waf';\n+import { buildWaf } from './waf';\n \n /**\n  * Static app infrastructure, which deploys app content to an S3 bucket.\n@@ -111,10 +111,14 @@ export class FrontEnd extends Construct {\n       });\n \n       // WAF\n-      this.waf = new wafv2.CfnWebACL(\n+      this.waf = buildWaf(\n         this,\n         'FrontEndWAF',\n-        buildWafConfig(`${config.stackName}-FrontEndWAF`, 'CLOUDFRONT', config.appWafIpSetArn)\n+        `${config.stackName}-FrontEndWAF`,\n+        'CLOUDFRONT',\n+        config.appWafIpSetArn,\n+        config.wafLogGroupName,\n+        config.wafLogGroupCreate\n       );\n \n       // API Origin Cache Policy\n\ndiff --git a/packages/cdk/src/storage.ts b/packages/cdk/src/storage.ts\nindex 9dbb8d2e92..7827b4873e 100644\n--- a/packages/cdk/src/storage.ts\n+++ b/packages/cdk/src/storage.ts\n@@ -13,7 +13,7 @@ import {\n import { ServerlessClamscan } from 'cdk-serverless-clamscan';\n import { Construct } from 'constructs';\n import { grantBucketAccessToOriginAccessIdentity } from './oai';\n-import { buildWafConfig } from './waf';\n+import { buildWaf } from './waf';\n \n /**\n  * Binary storage bucket and CloudFront distribution.\n@@ -126,10 +126,14 @@ export class Storage extends Construct {\n       });\n \n       // WAF\n-      this.waf = new wafv2.CfnWebACL(\n+      this.waf = buildWaf(\n         this,\n         'StorageWAF',\n-        buildWafConfig(`${config.stackName}-StorageWAF`, 'CLOUDFRONT', config.storageWafIpSetArn)\n+        `${config.stackName}-StorageWAF`,\n+        'CLOUDFRONT',\n+        config.storageWafIpSetArn,\n+        config.wafLogGroupName,\n+        config.wafLogGroupCreate\n       );\n \n       // Origin access identity\n\ndiff --git a/packages/cdk/src/waf.ts b/packages/cdk/src/waf.ts\nindex 76dd3006de..76d23092e6 100644\n--- a/packages/cdk/src/waf.ts\n+++ b/packages/cdk/src/waf.ts\n@@ -1,6 +1,7 @@\n // Based on https://gist.github.com/statik/f1ac9d6227d98d30c7a7cec0c83f4e64\n \n-import { aws_wafv2 as wafv2 } from 'aws-cdk-lib';\n+import { aws_logs as logs, aws_wafv2 as wafv2 } from 'aws-cdk-lib';\n+import { Construct } from 'constructs';\n \n const awsManagedRules: wafv2.CfnWebACL.RuleProperty[] = [\n   // Common Rule Set aligns with major portions of OWASP Core Rule Set\n@@ -154,18 +155,26 @@ function buildWafRules(ipSetArn: string | undefined): wafv2.CfnWebACL.RuleProper\n }\n \n /**\n- * Builds a WAF configuration.\n+ * Builds a WAF.\n+ * @param construct - The CDK construct scope.\n+ * @param id - The ID of the WAF configuration.\n  * @param name - The name of the WAF configuration.\n  * @param scope - The scope of the WAF configuration. Use \"CLOUDFRONT\" for CloudFront distributions. Use \"REGIONAL\" for Application Load Balancers.\n  * @param ipSetArn - The ARN of the IP set to use for IP allow listing. IP Set scope must match the WAF scope.\n- * @returns The WAF configuration.\n+ * @param logGroupName - The name of the CloudWatch Log Group to use for WAF logging.\n+ * @param logGroupCreate - Whether to create a new CloudWatch Log Group for WAF logging.\n+ * @returns The WAF construct.\n  */\n-export function buildWafConfig(\n+export function buildWaf(\n+  construct: Construct,\n+  id: string,\n   name: string,\n   scope: 'REGIONAL' | 'CLOUDFRONT',\n-  ipSetArn: string | undefined\n-): wafv2.CfnWebACLProps {\n-  return {\n+  ipSetArn: string | undefined,\n+  logGroupName: string | undefined,\n+  logGroupCreate: boolean | undefined\n+): wafv2.CfnWebACL {\n+  const waf = new wafv2.CfnWebACL(construct, id, {\n     name,\n     scope,\n     defaultAction: ipSetArn ? { block: {} } : { allow: {} },\n@@ -175,5 +184,22 @@ export function buildWafConfig(\n       cloudWatchMetricsEnabled: true,\n       sampledRequestsEnabled: false,\n     },\n-  };\n+  });\n+\n+  if (logGroupName) {\n+    let wafLogGroup: logs.ILogGroup;\n+    if (logGroupCreate) {\n+      wafLogGroup = new logs.LogGroup(construct, 'WAFLogs', { logGroupName });\n+    } else {\n+      wafLogGroup = logs.LogGroup.fromLogGroupName(construct, 'WAFLogs', logGroupName);\n+    }\n+\n+    const wafLogging = new wafv2.CfnLoggingConfiguration(construct, 'WAFLoggingConfiguration', {\n+      resourceArn: waf.attrArn,\n+      logDestinationConfigs: [wafLogGroup.logGroupArn],\n+    });\n+    wafLogging.addDependency(waf);\n+  }\n+\n+  return waf;\n }\n\ndiff --git a/packages/core/src/config.ts b/packages/core/src/config.ts\nindex 219fe2b361..565672a264 100644\n--- a/packages/core/src/config.ts\n+++ b/packages/core/src/config.ts\n@@ -64,6 +64,8 @@ export interface MedplumSourceInfraConfig {\n   clamscanLoggingPrefix: ValueOrExternalSecret<string>;\n   skipDns?: ValueOrExternalSecret<boolean>;\n   hostedZoneName?: ValueOrExternalSecret<string>;\n+  wafLogGroupName?: ValueOrExternalSecret<string>;\n+  wafLogGroupCreate?: ValueOrExternalSecret<boolean>;\n   additionalContainers?: {\n     name: ValueOrExternalSecret<string>;\n     image: ValueOrExternalSecret<string>;\n@@ -144,6 +146,8 @@ export interface MedplumInfraConfig {\n   clamscanLoggingPrefix: string;\n   skipDns?: boolean;\n   hostedZoneName?: string;\n+  wafLogGroupName?: string;\n+  wafLogGroupCreate?: boolean;\n   additionalContainers?: {\n     name: string;\n     image: string;\n",
    "test_patch": "diff --git a/packages/cdk/src/index.test.ts b/packages/cdk/src/index.test.ts\nindex c9f6b1c176..c7f2e15251 100644\n--- a/packages/cdk/src/index.test.ts\n+++ b/packages/cdk/src/index.test.ts\n@@ -338,4 +338,30 @@ describe('Infra', () => {\n     expect(() => main({ config: filename })).not.toThrow();\n     unlinkSync(filename);\n   });\n+\n+  test('Create WAF logging group', () => {\n+    const filename = writeConfig('./medplum.createWafLogGroup.config.json', {\n+      ...baseConfig,\n+      name: 'createWafLogGroup',\n+      stackName: 'MedplumCreateWafLogGroupStack',\n+      wafLogGroupName: 'waf-logs',\n+      wafLogGroupCreate: true,\n+    });\n+\n+    expect(() => main({ config: filename })).not.toThrow();\n+    unlinkSync(filename);\n+  });\n+\n+  test('Use existing WAF logging group', () => {\n+    const filename = writeConfig('./medplum.existingWafLogGroup.config.json', {\n+      ...baseConfig,\n+      name: 'existingWafLogGroup',\n+      stackName: 'MedplumExistingWafLogGroupStack',\n+      wafLogGroupName: 'waf-logs',\n+      wafLogGroupCreate: true,\n+    });\n+\n+    expect(() => main({ config: filename })).not.toThrow();\n+    unlinkSync(filename);\n+  });\n });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6761",
    "pr_id": 6761,
    "issue_id": 6757,
    "repo": "medplum/medplum",
    "problem_statement": "Medplum Agent \"Fast-ACK\" via CA/AE/AA\nImplement \"enhanced-mode\" ACK messages, so that Agent can ACK and allow single-threaded devices to send next message without having to wait for full Agent->Server->Agent turnaround. \n\nEnhanced-mode statuses documented here: https://hl7-definition.caristix.com/v2/HL7v2.3/Tables/0008\n\nCorepoint support for enhanced-mode statuses: https://rhapsody.health/resources/hl7-acknowledgement-ack/#:~:text=Enhanced%20Mode%20Acknowledgement%C2%A0%E2%80%93%20an%20%E2%80%9CApplication%E2%80%9D%20ACK%20that%20is%20a%20resultant%20status%20return%20rather%20than%20a%20communication%20response%20(i.e.%20query%20results%2C%20order%20response%2C%20etc.)",
    "issue_word_count": 104,
    "test_files_count": 3,
    "non_test_files_count": 4,
    "pr_changed_files": [
      "packages/agent/src/hl7.test.ts",
      "packages/agent/src/hl7.ts",
      "packages/core/src/hl7.test.ts",
      "packages/core/src/hl7.ts",
      "packages/hl7/src/connection.test.ts",
      "packages/hl7/src/connection.ts",
      "packages/hl7/src/server.ts"
    ],
    "pr_changed_test_files": [
      "packages/agent/src/hl7.test.ts",
      "packages/core/src/hl7.test.ts",
      "packages/hl7/src/connection.test.ts"
    ],
    "base_commit": "1c4550a0b254cd12be050e718eb4861396618788",
    "head_commit": "25ba2115dd99bf4ade3f1b09527342306940b18d",
    "repo_url": "https://github.com/medplum/medplum/pull/6761",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6761",
    "dockerfile": "",
    "pr_merged_at": "2025-06-14T05:27:15.000Z",
    "patch": "diff --git a/packages/agent/src/hl7.ts b/packages/agent/src/hl7.ts\nindex 7d88b73076..cdfaea60e1 100644\n--- a/packages/agent/src/hl7.ts\n+++ b/packages/agent/src/hl7.ts\n@@ -28,8 +28,9 @@ export class AgentHl7Channel extends BaseChannel {\n     this.started = true;\n     const address = new URL(this.getEndpoint().address as string);\n     const encoding = address.searchParams.get('encoding') ?? undefined;\n+    const enhancedMode = address.searchParams.get('enhanced')?.toLowerCase() === 'true';\n     this.log.info(`Channel starting on ${address}...`);\n-    this.server.start(Number.parseInt(address.port, 10), encoding);\n+    this.server.start(Number.parseInt(address.port, 10), encoding, enhancedMode);\n     this.log.info('Channel started successfully');\n   }\n \n\ndiff --git a/packages/core/src/hl7.ts b/packages/core/src/hl7.ts\nindex 4bf7d7b0b8..18da65b0bc 100644\n--- a/packages/core/src/hl7.ts\n+++ b/packages/core/src/hl7.ts\n@@ -1,5 +1,35 @@\n import { isStringArray } from './utils';\n \n+export const AckCode = {\n+  /** AA - Application Accept */\n+  AA: 'AA',\n+  /** AE - Application Error */\n+  AE: 'AE',\n+  /** AR - Application Reject */\n+  AR: 'AR',\n+  /** CA - Commit Accept */\n+  CA: 'CA',\n+  /** CE - Commit Error */\n+  CE: 'CE',\n+  /** CR - Commit Reject */\n+  CR: 'CR',\n+} as const;\n+export type AckCode = keyof typeof AckCode;\n+\n+export interface Hl7AckOptions {\n+  ackCode: AckCode;\n+  errSegment?: Hl7Segment;\n+}\n+\n+const TEXT_MSG_FOR_ACK_CODE = {\n+  AA: 'OK',\n+  AE: 'Application Error',\n+  AR: 'Application Reject',\n+  CA: 'Commit Accept',\n+  CE: 'Commit Error',\n+  CR: 'Commit Reject',\n+} as Record<AckCode, string>;\n+\n /**\n  * The Hl7Context class represents the parsing context for an HL7 message.\n  *\n@@ -130,9 +160,10 @@ export class Hl7Message {\n \n   /**\n    * Returns an HL7 \"ACK\" (acknowledgement) message for this message.\n+   * @param options - The optional options to configure the \"ACK\" message.\n    * @returns The HL7 \"ACK\" message.\n    */\n-  buildAck(): Hl7Message {\n+  buildAck(options?: Hl7AckOptions): Hl7Message {\n     const now = new Date();\n     const msh = this.getSegment('MSH');\n     const sendingApp = msh?.getField(3)?.toString() ?? '';\n@@ -141,6 +172,7 @@ export class Hl7Message {\n     const receivingFacility = msh?.getField(6)?.toString() ?? '';\n     const controlId = msh?.getField(10)?.toString() ?? '';\n     const versionId = msh?.getField(12)?.toString() ?? '2.5.1';\n+    const ackCode = options?.ackCode ?? 'AA';\n \n     return new Hl7Message([\n       new Hl7Segment(\n@@ -160,7 +192,8 @@ export class Hl7Message {\n         ],\n         this.context\n       ),\n-      new Hl7Segment(['MSA', 'AA', controlId, 'OK'], this.context),\n+      new Hl7Segment(['MSA', ackCode, controlId, TEXT_MSG_FOR_ACK_CODE[ackCode]], this.context),\n+      ...(options?.errSegment ? [options.errSegment] : []),\n     ]);\n   }\n \n\ndiff --git a/packages/hl7/src/connection.ts b/packages/hl7/src/connection.ts\nindex e2425115e6..7530ef960b 100644\n--- a/packages/hl7/src/connection.ts\n+++ b/packages/hl7/src/connection.ts\n@@ -17,14 +17,16 @@ export type Hl7MessageQueueItem = {\n export class Hl7Connection extends Hl7Base {\n   readonly socket: net.Socket;\n   readonly encoding: string;\n+  readonly enhancedMode: boolean;\n   private chunks: Buffer[] = [];\n   private readonly messageQueue: Hl7MessageQueueItem[] = [];\n \n-  constructor(socket: net.Socket, encoding: string = 'utf-8') {\n+  constructor(socket: net.Socket, encoding: string = 'utf-8', enhancedMode = false) {\n     super();\n \n     this.socket = socket;\n     this.encoding = encoding;\n+    this.enhancedMode = enhancedMode;\n \n     socket.on('data', (data: Buffer) => {\n       try {\n@@ -52,6 +54,9 @@ export class Hl7Connection extends Hl7Base {\n     });\n \n     this.addEventListener('message', (event) => {\n+      if (enhancedMode) {\n+        this.send(event.message.buildAck({ ackCode: 'CA' }));\n+      }\n       // Get the queue item at the head of the queue\n       const next = this.messageQueue.shift();\n       // If there isn't an item, then throw an error\n\ndiff --git a/packages/hl7/src/server.ts b/packages/hl7/src/server.ts\nindex 6a6a03a434..1022270d55 100644\n--- a/packages/hl7/src/server.ts\n+++ b/packages/hl7/src/server.ts\n@@ -9,9 +9,9 @@ export class Hl7Server {\n     this.handler = handler;\n   }\n \n-  start(port: number, encoding?: string): void {\n+  start(port: number, encoding?: string, enhancedMode = false): void {\n     const server = net.createServer((socket) => {\n-      const connection = new Hl7Connection(socket, encoding);\n+      const connection = new Hl7Connection(socket, encoding, enhancedMode);\n       this.handler(connection);\n     });\n \n",
    "test_patch": "diff --git a/packages/agent/src/hl7.test.ts b/packages/agent/src/hl7.test.ts\nindex 42e9f9a8c6..ae5cd5f32a 100644\n--- a/packages/agent/src/hl7.test.ts\n+++ b/packages/agent/src/hl7.test.ts\n@@ -265,6 +265,87 @@ describe('HL7', () => {\n     console.log = originalConsoleLog;\n   });\n \n+  test('Send and receive -- enhanced mode', async () => {\n+    const mockServer = new Server('wss://example.com/ws/agent');\n+\n+    mockServer.on('connection', (socket) => {\n+      socket.on('message', (data) => {\n+        const command = JSON.parse((data as Buffer).toString('utf8'));\n+        if (command.type === 'agent:connect:request') {\n+          socket.send(\n+            Buffer.from(\n+              JSON.stringify({\n+                type: 'agent:connect:response',\n+              })\n+            )\n+          );\n+        }\n+\n+        if (command.type === 'agent:transmit:request') {\n+          const hl7Message = Hl7Message.parse(command.body);\n+          const ackMessage = hl7Message.buildAck();\n+          socket.send(\n+            Buffer.from(\n+              JSON.stringify({\n+                type: 'agent:transmit:response',\n+                channel: command.channel,\n+                callback: command.callback,\n+                remote: command.remote,\n+                body: ackMessage.toString(),\n+              })\n+            )\n+          );\n+        }\n+      });\n+    });\n+\n+    const enhancedEndpoint = await medplum.createResource<Endpoint>({\n+      ...endpoint,\n+      address: endpoint.address + '?enhanced=true',\n+    });\n+\n+    const agent = await medplum.createResource<Agent>({\n+      resourceType: 'Agent',\n+      name: 'Test Agent',\n+      status: 'active',\n+      channel: [\n+        {\n+          name: 'test',\n+          endpoint: createReference(enhancedEndpoint),\n+          targetReference: createReference(bot),\n+        },\n+      ],\n+    });\n+\n+    const app = new App(medplum, agent.id, LogLevel.INFO);\n+    await app.start();\n+\n+    const client = new Hl7Client({\n+      host: 'localhost',\n+      port: 57000,\n+    });\n+\n+    const response = await client.sendAndWait(\n+      Hl7Message.parse(\n+        'MSH|^~\\\\&|ADT1|MCM|LABADT|MCM|198808181126|SECURITY|ADT^A01|MSG00001|P|2.5\\r' +\n+          'PID|||PATID1234^5^M11||JONES^WILLIAM^A^III||19610615|M-\\r' +\n+          'NK1|1|JONES^BARBARA^K|SPO|||||20011105\\r' +\n+          'PV1|1|I|2000^2012^01||||004777^LEBAUER^SIDNEY^J.|||SUR||-||1|A0-'\n+      )\n+    );\n+    expect(response).toBeDefined();\n+    expect(response.header.getComponent(9, 1)).toBe('ACK');\n+    // Should get a commit ACK\n+    expect(response.getSegment('MSA')?.getComponent(1, 1)).toStrictEqual('CA');\n+    // Should see info severity level\n+    expect(response.segments).toHaveLength(2);\n+    expect(response.segments[1].name).toBe('MSA');\n+\n+    client.close();\n+    await app.stop();\n+    mockServer.stop();\n+  });\n+\n   test('Push', async () => {\n     const mockServer = new Server('wss://example.com/ws/agent');\n     let mySocket: Client | undefined = undefined;\n\ndiff --git a/packages/core/src/hl7.test.ts b/packages/core/src/hl7.test.ts\nindex d00dcdf4cd..91eb1ed9ba 100644\n--- a/packages/core/src/hl7.test.ts\n+++ b/packages/core/src/hl7.test.ts\n@@ -81,6 +81,40 @@ describe('HL7', () => {\n     expect(msg3.buildAck().getSegment('MSH')?.getField(9)?.toString()).toBe('ACK^A01^ACK');\n   });\n \n+  test.each(['CA', 'CR', 'CE', 'AE', 'AR'] as const)('Build ACK -- %s, no ERR segment', (ackCode) => {\n+    // 1 message type components\n+    const text1 =\n+      'MSH|^~\\\\&|ADT1|MCM|LABADT|MCM|198808181126|SECURITY|ADT|MSG00001|P|2.1\\r' +\n+      'PID|||PATID1234^5^M11||JONES^WILLIAM^A^III||19610615|M-||C|1200 N ELM STREET^^GREENSBORO^NC^27401-1020|GL|(919)379-1212|(919)271-3434||S||PATID12345001^2^M10|123456789|987654^NC\\r' +\n+      'NK1|1|JONES^BARBARA^K|SPO|||||20011105\\r' +\n+      'PV1|1|I|2000^2012^01||||004777^LEBAUER^SIDNEY^J.|||SUR||-||1|A0-';\n+    const msg1 = Hl7Message.parse(text1);\n+    expect(msg1).toBeDefined();\n+    const ackMsg = msg1.buildAck({ ackCode });\n+    expect(ackMsg.getSegment('MSH')?.getField(9)?.toString()).toBe('ACK');\n+    expect(ackMsg.getSegment('MSA')?.getField(1)?.toString()).toBe(ackCode);\n+    expect(ackMsg.getSegment('ERR')).toBeUndefined();\n+  });\n+\n+  test('Build ACK -- ERR segment defined', () => {\n+    // 1 message type components\n+    const text1 =\n+      'MSH|^~\\\\&|ADT1|MCM|LABADT|MCM|198808181126|SECURITY|ADT|MSG00001|P|2.1\\r' +\n+      'PID|||PATID1234^5^M11||JONES^WILLIAM^A^III||19610615|M-||C|1200 N ELM STREET^^GREENSBORO^NC^27401-1020|GL|(919)379-1212|(919)271-3434||S||PATID12345001^2^M10|123456789|987654^NC\\r' +\n+      'NK1|1|JONES^BARBARA^K|SPO|||||20011105\\r' +\n+      'PV1|1|I|2000^2012^01||||004777^LEBAUER^SIDNEY^J.|||SUR||-||1|A0-';\n+    const msg1 = Hl7Message.parse(text1);\n+    expect(msg1).toBeDefined();\n+    const ackMsg = msg1.buildAck({\n+      ackCode: 'AE',\n+      errSegment: new Hl7Segment(['ERR', '^^^207&Application Error&HL70357']),\n+    });\n+    expect(ackMsg.getSegment('MSH')?.getField(9)?.toString()).toBe('ACK');\n+    expect(ackMsg.getSegment('MSA')?.getField(1)?.toString()).toBe('AE');\n+    expect(ackMsg.getSegment('MSA')?.getField(3)?.toString()).toBe('Application Error');\n+    expect(ackMsg.getSegment('ERR')?.getField(1)?.toString()).toBe('^^^207&Application Error&HL70357');\n+  });\n+\n   test('ADT', () => {\n     const text = `MSH|^~\\\\&|EPIC|EPICADT|SMS|SMSADT|199912271408|CHARRIS|ADT^A04|1817457|D|2.5|\n PID||0493575^^^2^ID 1|454721||DOE^JOHN^^^^|DOE^JOHN^^^^|19480203|M||B|254 MYSTREET AVE^^MYTOWN^OH^44123^USA||(216)123-4567|||M|NON|400003403~1129086|\n\ndiff --git a/packages/hl7/src/connection.test.ts b/packages/hl7/src/connection.test.ts\nindex ad7e1a4c8d..d8ff3a05b4 100644\n--- a/packages/hl7/src/connection.test.ts\n+++ b/packages/hl7/src/connection.test.ts\n@@ -1,5 +1,8 @@\n+import { Hl7Message } from '@medplum/core';\n+import iconv from 'iconv-lite';\n import { Hl7Connection } from './connection';\n import { CR, FS, VT } from './constants';\n+import { Hl7MessageEvent } from './events';\n \n describe('HL7 Connection', () => {\n   test('Error', async () => {\n@@ -41,4 +44,51 @@ describe('HL7 Connection', () => {\n     connection.close();\n     connection.close();\n   });\n+\n+  test('enhancedMode', () => {\n+    const handlers: Record<string, (event: any) => void> = {};\n+\n+    // Create a mock net.Socket\n+    const mockSocket: any = {\n+      on: jest.fn((event: string, handler: (event: any) => void) => {\n+        handlers[event] = handler;\n+        return mockSocket;\n+      }),\n+      setEncoding: jest.fn(() => mockSocket),\n+      end: jest.fn(),\n+      destroy: jest.fn(),\n+      write: jest.fn(),\n+    };\n+\n+    const connection = new Hl7Connection(mockSocket as any, undefined, true);\n+    expect(handlers.data).toBeDefined();\n+\n+    const msg =\n+      Hl7Message.parse(`MSH|^~\\\\&|SENDING_APP|SENDING_FAC|REC_APP|REC_FAC|20240218153044||DFT^P03|MSG00002|P|2.3\n+EVN|P03|20240218153044\n+PID|1||12345^^^MRN^MR||DOE^JOHN^A||19800101|M|||123 MAIN ST^^CITY^ST^12345^USA\n+FT1|1|ABC123|9876|20240218|20240218|CG|150.00|1|Units|||||||||||||99213^Office Visit^CPT\n+PR1|1||99213^Office Visit^CPT|20240218|GP||||||||||J45.909^Unspecified asthma, uncomplicated^ICD-10\n+PR1|2||85025^Blood Test^CPT|20240218|GP||||||||||D64.9^Anemia, unspecified^ICD-10\n+IN1|1|BCBS|67890|Blue Cross Blue Shield||||||||||||||||||||||||||||||||XYZ789`);\n+\n+    connection.dispatchEvent(new Hl7MessageEvent(connection, msg));\n+    expect(mockSocket.write).toHaveBeenCalled();\n+\n+    const writeBuffer = mockSocket.write.mock.calls[0][0] as Buffer;\n+    const decodedStr = iconv.decode(writeBuffer.subarray(1, writeBuffer.byteLength - 2), 'utf-8');\n+\n+    const receivedMsg = Hl7Message.parse(decodedStr);\n+    const ackToCompare = msg.buildAck({ ackCode: 'CA' });\n+\n+    // Timestamp is based on when ACK is created so these will always be different\n+    receivedMsg.getSegment('MSH')?.setField(7, 'TIMESTAMP');\n+    ackToCompare.getSegment('MSH')?.setField(7, 'TIMESTAMP');\n+    // Control ID is based on timestamp so they will always be different\n+    receivedMsg.getSegment('MSH')?.setField(10, 'CONTROLID');\n+    ackToCompare.getSegment('MSH')?.setField(10, 'CONTROLID');\n+\n+    expect(receivedMsg.toString().replaceAll('\\r', '\\n')).toStrictEqual(ackToCompare.toString().replaceAll('\\r', '\\n'));\n+    connection.close();\n+  });\n });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6758",
    "pr_id": 6758,
    "issue_id": 6715,
    "repo": "medplum/medplum",
    "problem_statement": "Control all FHIR interactions via AccessPolicy\nCurrently, Medplum's `AccessPolicy` resource type allow coarse-grained read-write control via a boolean field:\n\n```ts\n{\n  resourceType: 'AccessPolicy',\n  resource: [\n    { resourceType: 'Observation', readonly: true }\n  ]\n}\n```\n\nHowever, users need more fine-grained access control, and should be able to specify individual [FHIR interactions](http://hl7.org/fhir/valueset-type-restful-interaction.html) that are allowed (e.g. `create`, `delete`, `search`).  This can be represented in the AccessPolicy in a backwards-compatible way:\n\n```ts\n{\n  resourceType: 'AccessPolicy',\n  resource: [\n    // Old way\n    { resourceType: 'Observation', readonly: true },\n    // New way\n    { resourceType: 'Observation', interactions: ['read', 'search'] }\n  ]\n}\n```\n\nInternally, when [constructing the synthetic AccessPolicy](https://github.com/medplum/medplum/blob/bb84134ecf7cc4c6edeac8658e235fefa9baf6dd/packages/server/src/fhir/accesspolicy.ts#L85) to use during a server request, we should translate all `AccessPolicy.resource` entries to use the new format via the following conversion:\n\n| `readonly` | `interactions` |\n| --- | --- |\n| `false` or `undefined` | `['create', 'read', 'update', 'delete', 'search']` |\n| `true` | `['read', 'search']` |\n\nFirst, `matchesAccessPolicyResourcePolicy()` in `@medplum/core` will need to be updated to handle the new case, where the interaction can be directly checked against the `AccessPolicy.resource.interaction` value(s).\n\nThis will also require updating code throughout the server to honor the more comprehensive checks; namely, the logic in `packages/server/fhir/repo.ts` should call `satisfiedAccessPolicy` with the correct interaction in all locations where interactions take place",
    "issue_word_count": 215,
    "test_files_count": 2,
    "non_test_files_count": 11,
    "pr_changed_files": [
      "packages/core/src/access.test.ts",
      "packages/core/src/access.ts",
      "packages/definitions/dist/fhir/r4/fhir.schema.json",
      "packages/definitions/dist/fhir/r4/profiles-medplum.json",
      "packages/definitions/dist/fhir/r4/valuesets-medplum.json",
      "packages/docs/docs/access/access-policies.md",
      "packages/docs/static/data/medplumDefinitions/accesspolicy.json",
      "packages/fhirtypes/dist/AccessPolicy.d.ts",
      "packages/server/src/fhir/accesspolicy.test.ts",
      "packages/server/src/fhir/accesspolicy.ts",
      "packages/server/src/fhir/operations/export.ts",
      "packages/server/src/fhir/repo.ts",
      "packages/server/src/fhir/search.ts"
    ],
    "pr_changed_test_files": [
      "packages/core/src/access.test.ts",
      "packages/server/src/fhir/accesspolicy.test.ts"
    ],
    "base_commit": "5fc4c2928a66f881049d1ad50f82d3d87e96666e",
    "head_commit": "92be4f1818525ffc8d75dc160b5831e5dac18b35",
    "repo_url": "https://github.com/medplum/medplum/pull/6758",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6758",
    "dockerfile": "",
    "pr_merged_at": "2025-06-18T18:41:09.000Z",
    "patch": "diff --git a/packages/core/src/access.ts b/packages/core/src/access.ts\nindex 927cc9f86f..85f2eea6b0 100644\n--- a/packages/core/src/access.ts\n+++ b/packages/core/src/access.ts\n@@ -33,29 +33,18 @@ export const AccessPolicyInteraction = {\n   READ: 'read',\n   VREAD: 'vread',\n   UPDATE: 'update',\n-  PATCH: 'patch',\n   DELETE: 'delete',\n   HISTORY: 'history',\n-  HISTORY_INSTANCE: 'history-instance',\n-  HISTORY_TYPE: 'history-type',\n-  HISTORY_SYSTEM: 'history-system',\n   CREATE: 'create',\n   SEARCH: 'search',\n-  SEARCH_TYPE: 'search-type',\n-  SEARCH_SYSTEM: 'search-system',\n-  SEARCH_COMPARTMENT: 'search-compartment',\n-  CAPABILITIES: 'capabilities',\n-  TRANSACTION: 'transaction',\n-  BATCH: 'batch',\n-  OPERATION: 'operation',\n } as const;\n export type AccessPolicyInteraction = (typeof AccessPolicyInteraction)[keyof typeof AccessPolicyInteraction];\n \n-const resourceReadInteractions: AccessPolicyInteraction[] = [\n+export const readInteractions: AccessPolicyInteraction[] = [\n   AccessPolicyInteraction.READ,\n   AccessPolicyInteraction.VREAD,\n   AccessPolicyInteraction.HISTORY,\n-  AccessPolicyInteraction.HISTORY_INSTANCE,\n+  AccessPolicyInteraction.SEARCH,\n ];\n \n /**\n@@ -63,16 +52,10 @@ const resourceReadInteractions: AccessPolicyInteraction[] = [\n  * @param accessPolicy - The access policy.\n  * @param resourceType - The resource type.\n  * @returns True if the current user can read the specified resource type.\n+ * @deprecated Use accessPolicySupportsInteraction() instead.\n  */\n export function canReadResourceType(accessPolicy: AccessPolicy, resourceType: ResourceType): boolean {\n-  if (accessPolicy.resource) {\n-    for (const resourcePolicy of accessPolicy.resource) {\n-      if (matchesAccessPolicyResourceType(resourcePolicy.resourceType, resourceType)) {\n-        return true;\n-      }\n-    }\n-  }\n-  return false;\n+  return accessPolicySupportsInteraction(accessPolicy, AccessPolicyInteraction.SEARCH, resourceType);\n }\n \n /**\n@@ -82,19 +65,32 @@ export function canReadResourceType(accessPolicy: AccessPolicy, resourceType: Re\n  * @param accessPolicy - The access policy.\n  * @param resourceType - The resource type.\n  * @returns True if the current user can write the specified resource type.\n+ * @deprecated Use accessPolicySupportsInteraction() instead.\n  */\n export function canWriteResourceType(accessPolicy: AccessPolicy, resourceType: ResourceType): boolean {\n   if (protectedResourceTypes.includes(resourceType)) {\n     return false;\n   }\n-  if (accessPolicy.resource) {\n-    for (const resourcePolicy of accessPolicy.resource) {\n-      if (matchesAccessPolicyResourceType(resourcePolicy.resourceType, resourceType) && !resourcePolicy.readonly) {\n-        return true;\n-      }\n-    }\n-  }\n-  return false;\n+  return accessPolicySupportsInteraction(accessPolicy, AccessPolicyInteraction.UPDATE, resourceType);\n+}\n+\n+/**\n+ * Shallow check that an interaction is permitted by the AccessPolicy on a given resource type,\n+ * at least for some resources.  A more in-depth check for the specific resource(s) being accessed\n+ * is required in addition to this one.\n+ * @param accessPolicy - The AccessPolicy to check against.\n+ * @param interaction - The FHIR interaction being performed.\n+ * @param resourceType - The type of resource being interacted with.\n+ * @returns True when the interaction is provisionally permitted by the AccessPolicy.\n+ */\n+export function accessPolicySupportsInteraction(\n+  accessPolicy: AccessPolicy,\n+  interaction: AccessPolicyInteraction,\n+  resourceType: ResourceType\n+): boolean {\n+  return Boolean(\n+    accessPolicy.resource?.some((policy) => shallowMatchesResourcePolicy(policy, resourceType, interaction))\n+  );\n }\n \n /**\n@@ -103,12 +99,9 @@ export function canWriteResourceType(accessPolicy: AccessPolicy, resourceType: R\n  * @param accessPolicy - The access policy.\n  * @param resource - The resource.\n  * @returns True if the current user can write the specified resource type.\n+ * @deprecated Use satisfiedAccessPolicy() instead.\n  */\n export function canWriteResource(accessPolicy: AccessPolicy, resource: Resource): boolean {\n-  const resourceType = resource.resourceType;\n-  if (!canWriteResourceType(accessPolicy, resourceType)) {\n-    return false;\n-  }\n   return Boolean(satisfiedAccessPolicy(resource, AccessPolicyInteraction.UPDATE, accessPolicy));\n }\n \n@@ -127,14 +120,7 @@ export function satisfiedAccessPolicy(\n   if (!accessPolicy) {\n     return universalAccessPolicy;\n   }\n-  if (accessPolicy.resource) {\n-    for (const resourcePolicy of accessPolicy.resource) {\n-      if (matchesAccessPolicyResourcePolicy(resource, interaction, resourcePolicy)) {\n-        return resourcePolicy;\n-      }\n-    }\n-  }\n-  return undefined;\n+  return accessPolicy.resource?.find((policy) => matchesAccessPolicyResourcePolicy(resource, interaction, policy));\n }\n \n /**\n@@ -150,17 +136,14 @@ function matchesAccessPolicyResourcePolicy(\n   resourcePolicy: AccessPolicyResource\n ): boolean {\n   const resourceType = resource.resourceType;\n-  if (!matchesAccessPolicyResourceType(resourcePolicy.resourceType, resourceType)) {\n-    return false;\n-  }\n-  if (resourcePolicy.readonly && !resourceReadInteractions.includes(interaction)) {\n+  if (!shallowMatchesResourcePolicy(resourcePolicy, resourceType, interaction)) {\n     return false;\n   }\n   if (\n     resourcePolicy.compartment &&\n-    !resource.meta?.compartment?.find((c) => c.reference === resourcePolicy.compartment?.reference)\n+    !resource.meta?.compartment?.some((c) => c.reference === resourcePolicy.compartment?.reference)\n   ) {\n-    // Deprecated - to be removed\n+    // Deprecated - to be removed in v5\n     return false;\n   }\n   if (resourcePolicy.criteria && !matchesSearchRequest(resource, parseSearchRequest(resourcePolicy.criteria))) {\n@@ -170,22 +153,28 @@ function matchesAccessPolicyResourcePolicy(\n }\n \n /**\n- * Returns true if the resource type matches the access policy resource type.\n- * @param accessPolicyResourceType - The resource type from the access policy.\n- * @param resourceType - The candidate resource resource type.\n- * @returns True if the resource type matches the access policy resource type.\n+ * Shallow check if the given interaction on a resource type matches the resource access policy.\n+ * @param policy - The AccessPolicy resource policy.\n+ * @param resourceType - The candidate resource type.\n+ * @param interaction - Interaction type to check against the policy.\n+ * @returns True when the resource type matches the resource policy.\n  */\n-function matchesAccessPolicyResourceType(\n-  accessPolicyResourceType: string | undefined,\n-  resourceType: ResourceType\n+function shallowMatchesResourcePolicy(\n+  policy: AccessPolicyResource,\n+  resourceType: ResourceType,\n+  interaction: AccessPolicyInteraction\n ): boolean {\n-  if (accessPolicyResourceType === resourceType) {\n-    return true;\n+  if (\n+    policy.resourceType !== resourceType &&\n+    // Project admin resource types are not allowed to be wildcarded; they must be explicitly included\n+    (policy.resourceType !== '*' || projectAdminResourceTypes.includes(resourceType))\n+  ) {\n+    return false;\n   }\n-  if (accessPolicyResourceType === '*' && !projectAdminResourceTypes.includes(resourceType)) {\n-    // Project admin resource types are not allowed to be wildcarded\n-    // Project admin resource types must be explicitly included\n-    return true;\n+\n+  // Only use `readonly` if `interaction` is not specified\n+  if (!policy.interaction) {\n+    return !policy.readonly || readInteractions.includes(interaction);\n   }\n-  return false;\n+  return policy.interaction.includes(interaction);\n }\n\ndiff --git a/packages/definitions/dist/fhir/r4/fhir.schema.json b/packages/definitions/dist/fhir/r4/fhir.schema.json\nindex a4429674d0..5ca955d2a9 100644\n--- a/packages/definitions/dist/fhir/r4/fhir.schema.json\n+++ b/packages/definitions/dist/fhir/r4/fhir.schema.json\n@@ -62055,9 +62055,16 @@\n           \"$ref\": \"#/definitions/string\"\n         },\n         \"readonly\": {\n-          \"description\": \"Optional flag to indicate that the resource type is read-only.\",\n+          \"description\": \"@deprecated Use AccessPolicy.resource.interaction \\u003d [\\u0027search\\u0027, \\u0027read\\u0027, \\u0027vread\\u0027, \\u0027history\\u0027]\",\n           \"$ref\": \"#/definitions/boolean\"\n         },\n+        \"interaction\": {\n+          \"description\": \"Permitted FHIR interactions with this resource type\",\n+          \"items\": {\n+            \"enum\": [\"read\", \"vread\", \"update\", \"delete\", \"history\", \"create\", \"search\"]\n+          },\n+          \"type\": \"array\"\n+        },\n         \"hiddenFields\": {\n           \"description\": \"Optional list of hidden fields.  Hidden fields are not readable or writeable.\",\n           \"items\": {\n\ndiff --git a/packages/definitions/dist/fhir/r4/profiles-medplum.json b/packages/definitions/dist/fhir/r4/profiles-medplum.json\nindex f0db09ca7f..228c1ed16d 100644\n--- a/packages/definitions/dist/fhir/r4/profiles-medplum.json\n+++ b/packages/definitions/dist/fhir/r4/profiles-medplum.json\n@@ -3833,7 +3833,7 @@\n           {\n             \"id\" : \"AccessPolicy.resource.readonly\",\n             \"path\" : \"AccessPolicy.resource.readonly\",\n-            \"definition\" : \"Optional flag to indicate that the resource type is read-only.\",\n+            \"definition\" : \"@deprecated Use AccessPolicy.resource.interaction = ['search', 'read', 'vread', 'history']\",\n             \"min\" : 0,\n             \"max\" : \"1\",\n             \"type\" : [{\n@@ -3845,6 +3845,25 @@\n               \"max\" : \"1\"\n             }\n           },\n+          {\n+            \"id\" : \"AccessPolicy.resource.interaction\",\n+            \"path\" : \"AccessPolicy.resource.interaction\",\n+            \"definition\" : \"Permitted FHIR interactions with this resource type\",\n+            \"min\" : 0,\n+            \"max\" : \"*\",\n+            \"type\" : [{\n+              \"code\" : \"code\"\n+            }],\n+            \"base\" : {\n+              \"path\" : \"AccessPolicy.resource.interaction\",\n+              \"min\" : 0,\n+              \"max\" : \"*\"\n+            },\n+            \"binding\": {\n+              \"strength\": \"required\",\n+              \"valueSet\": \"https://medplum.com/fhir/ValueSet/access-poliicy-interactions\"\n+            }\n+          },\n           {\n             \"id\" : \"AccessPolicy.resource.hiddenFields\",\n             \"path\" : \"AccessPolicy.resource.hiddenFields\",\n\ndiff --git a/packages/definitions/dist/fhir/r4/valuesets-medplum.json b/packages/definitions/dist/fhir/r4/valuesets-medplum.json\nindex 76415a810c..3e64e98ac0 100644\n--- a/packages/definitions/dist/fhir/r4/valuesets-medplum.json\n+++ b/packages/definitions/dist/fhir/r4/valuesets-medplum.json\n@@ -3603,6 +3603,45 @@\n         \"content\": \"not-present\",\n         \"description\": \"Stub CodeSystem for ISO 3166-2\"\n       }\n+    },\n+    {\n+      \"fullUrl\": \"https://medplum.com/fhir/ValueSet/access-poliicy-interactions\",\n+      \"resource\": {\n+        \"resourceType\": \"ValueSet\",\n+        \"id\": \"access-policy-interactions\",\n+        \"url\": \"https://medplum.com/fhir/ValueSet/access-poliicy-interactions\",\n+        \"status\": \"active\",\n+        \"compose\": {\n+          \"include\": [\n+            {\n+              \"system\": \"http://hl7.org/fhir/restful-interaction\",\n+              \"concept\": [\n+                {\n+                  \"code\": \"read\"\n+                },\n+                {\n+                  \"code\": \"vread\"\n+                },\n+                {\n+                  \"code\": \"update\"\n+                },\n+                {\n+                  \"code\": \"delete\"\n+                },\n+                {\n+                  \"code\": \"history\"\n+                },\n+                {\n+                  \"code\": \"create\"\n+                },\n+                {\n+                  \"code\": \"search\"\n+                }\n+              ]\n+            }\n+          ]\n+        }\n+      }\n     }\n   ]\n }\n\ndiff --git a/packages/docs/docs/access/access-policies.md b/packages/docs/docs/access/access-policies.md\nindex 65dfdbff6a..2f13875b46 100644\n--- a/packages/docs/docs/access/access-policies.md\n+++ b/packages/docs/docs/access/access-policies.md\n@@ -74,9 +74,9 @@ While Medplum `AccessPolicies` use the [FHIR search syntax](/docs/search), it do\n \n :::\n \n-### Read-only Resource Type\n+### Read-only Access\n \n-The following access policy grants read-only access to the [`Patient`](/docs/api/fhir/resources/patient)resource type:\n+The following access policy grants read-only access to the [`Patient`](/docs/api/fhir/resources/patient) resource type:\n \n ```json\n {\n@@ -91,7 +91,7 @@ The following access policy grants read-only access to the [`Patient`](/docs/api\n }\n ```\n \n-Similarly, the following access policy grants read/write access to the Patient resource, and also grants _only_ read access to _all_ other resources: \n+Similarly, the following access policy grants read/write access to the Patient resource, and also grants _only_ read access to all other resources:\n \n ```json\n {\n@@ -109,7 +109,67 @@ Similarly, the following access policy grants read/write access to the Patient r\n }\n ```\n \n-Attempting to modify a read-only resource will result in an HTTP result of [`403: Forbidden`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/403).\n+Attempting to modify a read-only resource will result in an HTTP [`403 Forbidden`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/403) response.\n+\n+### FHIR Interactions\n+\n+The above read-only access is special case of the more general ability to control which interactions are allowed for a set of resources. The `AccessPolicy.resource.interaction` field can specify a subset of [FHIR interactions](http://hl7.org/fhir/R4/codesystem-restful-interaction.html) that can be performed on resources of the given type. The following are equivalent:\n+\n+```js\n+{\n+  \"resourceType\": \"AccessPolicy\",\n+  \"name\": \"Read-only modes\",\n+  \"resource\": [\n+    // Legacy shorthand\n+    {\n+      \"resourceType\": \"*\",\n+      \"readonly\": true,\n+    },\n+    // Explicit list of interactions\n+    {\n+      \"resourceType\": \"*\",\n+      \"interaction\": [\"read\", \"search\", \"history\", \"vread\"]\n+    }\n+  ]\n+}\n+```\n+\n+The `interaction` array can contain any of the supported interaction types:\n+\n+- `create`: Write new resources\n+- `read`: Read a specific resource by ID\n+- `update`: Update an existing resource, including patch operations\n+- `delete`: Soft-delete resources\n+- `search`: Search for resources of the given type\n+- `history`: View the list of previous versions of a resource\n+- `vread`: View a specific previous version of a resource\n+\n+:::tip Related interactions\n+\n+Some FHIR interactions are used in concert by the server, and so should be considered together:\n+\n+- [Upserts](/docs/fhir-datastore/working-with-fhir#upsert) require `search` to identify existing resources, in addition to both `create` and `update`\n+- `search` access may be required as part of a `create` or `update` if the resource contains any [Conditional references](/docs/migration/convert-to-fhir#linking-data-using-conditional-references), in order to resolve references to individual resources\n+- `read` access to referenced resource types is required in `create` and `update` interactions, if [`Project.checkReferencesOnWrite`](/docs/api/fhir/medplum/project) is set\n+- `history` and `vread` are often specified together, to grant access to the entire [version history](/docs/fhir-datastore/resource-history) of resources\n+\n+:::\n+\n+For example, this policy allows creating new resources and viewing any resources for which the ID is known, but will\n+prevent searching for or modifying existing resources:\n+\n+```json\n+{\n+  \"resourceType\": \"AccessPolicy\",\n+  \"name\": \"Write-only Sandbox\",\n+  \"resource\": [\n+    {\n+      \"resourceType\": \"*\",\n+      \"interaction\": [\"create\", \"read\"]\n+    }\n+  ]\n+}\n+```\n \n ### Read-only Elements\n \n@@ -151,7 +211,7 @@ Constraints on writes to a resource can also be specified using [FHIRPath expres\n \n :::tip\n \n-In resource constraints, `%before` will be undefined, so any expressions that refer to `%before` must account for this case. To select only updates or only creates, prefix the criteria with `%before.exists() implies` or `%before.exists().not() implies` respectively.\n+In case of a resource being created, `%before` will be undefined, so any expressions that refer to `%before` must account for this case. To select only updates or only creates, prefix the criteria with `%before.exists() implies` or `%before.exists().not() implies` respectively.\n \n :::\n \n\ndiff --git a/packages/docs/static/data/medplumDefinitions/accesspolicy.json b/packages/docs/static/data/medplumDefinitions/accesspolicy.json\nindex b4ad355847..744d280843 100644\n--- a/packages/docs/static/data/medplumDefinitions/accesspolicy.json\n+++ b/packages/docs/static/data/medplumDefinitions/accesspolicy.json\n@@ -294,7 +294,23 @@\n       \"min\": 0,\n       \"max\": \"1\",\n       \"short\": \"\",\n-      \"definition\": \"Optional flag to indicate that the resource type is read-only.\",\n+      \"definition\": \"@deprecated Use AccessPolicy.resource.interaction = ['search', 'read', 'vread', 'history']\",\n+      \"comment\": \"\",\n+      \"inherited\": false\n+    },\n+    {\n+      \"name\": \"interaction\",\n+      \"depth\": 2,\n+      \"types\": [\n+        {\n+          \"datatype\": \"code\"\n+        }\n+      ],\n+      \"path\": \"AccessPolicy.resource.interaction\",\n+      \"min\": 0,\n+      \"max\": \"*\",\n+      \"short\": \"\",\n+      \"definition\": \"Permitted FHIR interactions with this resource type\",\n       \"comment\": \"\",\n       \"inherited\": false\n     },\n\ndiff --git a/packages/fhirtypes/dist/AccessPolicy.d.ts b/packages/fhirtypes/dist/AccessPolicy.d.ts\nindex 7e8d66c4d0..f595697d68 100644\n--- a/packages/fhirtypes/dist/AccessPolicy.d.ts\n+++ b/packages/fhirtypes/dist/AccessPolicy.d.ts\n@@ -168,10 +168,16 @@ export interface AccessPolicyResource {\n   criteria?: string;\n \n   /**\n-   * Optional flag to indicate that the resource type is read-only.\n+   * @deprecated Use AccessPolicy.resource.interaction = ['search', 'read',\n+   * 'vread', 'history']\n    */\n   readonly?: boolean;\n \n+  /**\n+   * Permitted FHIR interactions with this resource type\n+   */\n+  interaction?: ('read' | 'vread' | 'update' | 'delete' | 'history' | 'create' | 'search')[];\n+\n   /**\n    * Optional list of hidden fields.  Hidden fields are not readable or\n    * writeable.\n\ndiff --git a/packages/server/src/fhir/accesspolicy.ts b/packages/server/src/fhir/accesspolicy.ts\nindex fee85e6a51..53806ae071 100644\n--- a/packages/server/src/fhir/accesspolicy.ts\n+++ b/packages/server/src/fhir/accesspolicy.ts\n@@ -104,34 +104,36 @@ export async function getAccessPolicyForLogin(authState: AuthState): Promise<Acc\n  * @returns The parameterized compound access policy.\n  */\n export async function buildAccessPolicy(membership: ProjectMembership): Promise<PopulatedAccessPolicy> {\n-  let access: ProjectMembershipAccess[] = [];\n-\n+  const access: ProjectMembershipAccess[] = [];\n   if (membership.accessPolicy) {\n     access.push({ policy: membership.accessPolicy });\n   }\n-\n   if (membership.access) {\n-    access = access.concat(membership.access);\n+    access.push(...membership.access);\n   }\n \n-  const profile = membership.profile as Reference<ProfileResource>;\n   let compartment: Reference | undefined = undefined;\n-  let resourcePolicies: AccessPolicyResource[] = [];\n-  let ipAccessRules: AccessPolicyIpAccessRule[] = [];\n+  const resourcePolicies: AccessPolicyResource[] = [];\n+  const ipAccessRules: AccessPolicyIpAccessRule[] = [];\n   for (const entry of access) {\n-    const replaced = await buildAccessPolicyResources(entry, profile);\n+    const replaced = await buildAccessPolicyResources(entry, membership.profile as Reference<ProfileResource>);\n     if (replaced.compartment) {\n       compartment = replaced.compartment;\n     }\n     if (replaced.resource) {\n-      resourcePolicies = resourcePolicies.concat(replaced.resource);\n+      for (const resourcePolicy of replaced.resource) {\n+        if (!resourcePolicy.interaction && resourcePolicy.readonly) {\n+          resourcePolicy.interaction = ['search', 'read', 'history', 'vread'];\n+        }\n+        resourcePolicies.push(resourcePolicy);\n+      }\n     }\n     if (replaced.ipAccessRule) {\n-      ipAccessRules = ipAccessRules.concat(replaced.ipAccessRule);\n+      ipAccessRules.push(...replaced.ipAccessRule);\n     }\n   }\n \n-  if ((!membership.access || membership.access.length === 0) && !membership.accessPolicy) {\n+  if (!membership?.access?.length && !membership.accessPolicy) {\n     // Preserve legacy behavior of null access policy\n     // TODO: This should be removed in future release when access policies are required\n     resourcePolicies.push({ resourceType: '*' });\n@@ -144,7 +146,7 @@ export async function buildAccessPolicy(membership: ProjectMembership): Promise<\n     basedOn: access.map((a) => a.policy),\n     compartment,\n     resource: resourcePolicies,\n-    ipAccessRule: ipAccessRules,\n+    ipAccessRule: ipAccessRules.length ? ipAccessRules : undefined,\n   };\n }\n \n\ndiff --git a/packages/server/src/fhir/operations/export.ts b/packages/server/src/fhir/operations/export.ts\nindex 3045f51183..5ef868a107 100644\n--- a/packages/server/src/fhir/operations/export.ts\n+++ b/packages/server/src/fhir/operations/export.ts\n@@ -1,5 +1,6 @@\n import {\n   accepted,\n+  AccessPolicyInteraction,\n   concatUrls,\n   getResourceTypes,\n   Operator,\n@@ -74,7 +75,7 @@ export async function exportResources(\n     if (\n       !canBeExported(resourceType) ||\n       (types && !types.includes(resourceType)) ||\n-      !exporter.repo.canReadResourceType(resourceType)\n+      !exporter.repo.supportsInteraction(AccessPolicyInteraction.SEARCH, resourceType)\n     ) {\n       continue;\n     }\n\ndiff --git a/packages/server/src/fhir/repo.ts b/packages/server/src/fhir/repo.ts\nindex 70d7a71446..5cb341075b 100644\n--- a/packages/server/src/fhir/repo.ts\n+++ b/packages/server/src/fhir/repo.ts\n@@ -11,11 +11,10 @@ import {\n   SearchRequest,\n   TypedValue,\n   WithId,\n+  accessPolicySupportsInteraction,\n   allOk,\n   arrayify,\n   badRequest,\n-  canReadResourceType,\n-  canWriteResourceType,\n   createReference,\n   deepClone,\n   deepEquals,\n@@ -41,6 +40,7 @@ import {\n   parseSearchRequest,\n   preconditionFailed,\n   protectedResourceTypes,\n+  readInteractions,\n   resolveId,\n   satisfiedAccessPolicy,\n   serverError,\n@@ -53,6 +53,7 @@ import {\n import { CreateResourceOptions, FhirRepository, RepositoryMode, UpdateResourceOptions } from '@medplum/fhir-router';\n import {\n   AccessPolicy,\n+  AccessPolicyResource,\n   Binary,\n   Bundle,\n   BundleEntry,\n@@ -358,7 +359,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n \n     validateResourceType(resourceType);\n \n-    if (!this.canReadResourceType(resourceType)) {\n+    if (!this.supportsInteraction(AccessPolicyInteraction.READ, resourceType)) {\n       throw new OperationOutcomeError(forbidden);\n     }\n \n@@ -371,7 +372,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n       // if (!this.canReadCacheEntry(cacheRecord)) {\n       //   throw new OperationOutcomeError(notFound);\n       // }\n-      if (this.canReadCacheEntry(cacheRecord)) {\n+      if (this.canPerformInteraction(AccessPolicyInteraction.READ, cacheRecord.resource)) {\n         return cacheRecord.resource;\n       }\n     }\n@@ -406,16 +407,6 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     return resource;\n   }\n \n-  private canReadCacheEntry(cacheEntry: CacheEntry): boolean {\n-    if (!this.isSuperAdmin() && !this.context.projects?.some((p) => p.id === cacheEntry.projectId)) {\n-      return false;\n-    }\n-    if (!satisfiedAccessPolicy(cacheEntry.resource, AccessPolicyInteraction.READ, this.context.accessPolicy)) {\n-      return false;\n-    }\n-    return true;\n-  }\n-\n   async readReferences<T extends Resource>(references: Reference<T>[]): Promise<(WithId<T> | Error)[]> {\n     await this.rateLimiter()?.recordRead(references.length);\n     const cacheEntries = await this.getCacheEntries(references);\n@@ -457,12 +448,12 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n       const [resourceType, id] = parseReference(reference);\n       validateResourceType(resourceType);\n \n-      if (!this.canReadResourceType(resourceType)) {\n+      if (!this.supportsInteraction(AccessPolicyInteraction.READ, resourceType)) {\n         return new OperationOutcomeError(forbidden);\n       }\n \n       if (cacheEntry) {\n-        if (!this.canReadCacheEntry(cacheEntry)) {\n+        if (!this.canPerformInteraction(AccessPolicyInteraction.READ, cacheEntry.resource)) {\n           return new OperationOutcomeError(notFound);\n         }\n         return cacheEntry.resource;\n@@ -509,6 +500,9 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n       let resource: T | undefined = undefined;\n       try {\n         resource = await this.readResourceImpl<T>(resourceType, id);\n+        if (!this.canPerformInteraction(AccessPolicyInteraction.HISTORY, resource)) {\n+          throw new OperationOutcomeError(forbidden);\n+        }\n       } catch (err) {\n         if (!(err instanceof OperationOutcomeError) || !isGone(err.outcome)) {\n           throw err;\n@@ -585,7 +579,10 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n       }\n \n       try {\n-        await this.readResourceImpl<T>(resourceType, id);\n+        const resource = await this.readResourceImpl<T>(resourceType, id);\n+        if (!this.canPerformInteraction(AccessPolicyInteraction.VREAD, resource)) {\n+          throw new OperationOutcomeError(forbidden);\n+        }\n       } catch (err) {\n         if (!isGone(normalizeOperationOutcome(err))) {\n           throw err;\n@@ -649,6 +646,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     if (!isUUID(id)) {\n       throw new OperationOutcomeError(badRequest('Invalid id'));\n     }\n+    const interaction = create ? AccessPolicyInteraction.CREATE : AccessPolicyInteraction.UPDATE;\n \n     // Add default profiles before validating resource\n     if (!resource.meta?.profile && this.currentProject()?.defaultProfile) {\n@@ -658,14 +656,14 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n       resource.meta = { ...resource.meta, profile: defaultProfiles };\n     }\n \n-    if (!this.canWriteResourceType(resourceType)) {\n+    if (!this.supportsInteraction(interaction, resourceType)) {\n       throw new OperationOutcomeError(forbidden);\n     }\n \n     const existing = create ? undefined : await this.checkExistingResource<T>(resourceType, id);\n     if (existing) {\n       (existing.meta as Meta).compartment = this.getCompartments(existing); // Update compartments with latest rules\n-      if (!this.canWriteToResource(existing)) {\n+      if (!this.canPerformInteraction(interaction, existing)) {\n         // Check before the update\n         throw new OperationOutcomeError(forbidden);\n       }\n@@ -713,7 +711,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n       return existing;\n     }\n \n-    if (!this.isResourceWriteable(existing, result)) {\n+    if (!this.isResourceWriteable(existing, result, interaction)) {\n       // Check after the update\n       throw new OperationOutcomeError(forbidden);\n     }\n@@ -721,10 +719,8 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     await this.handleStorage(result, create);\n     await this.postCommit(async () => {\n       await this.handleBinaryUpdate(existing, result);\n-      await addBackgroundJobs(result, existing, {\n-        project: await this.getProjectById(result.meta?.project),\n-        interaction: create ? 'create' : 'update',\n-      });\n+      const project = await this.getProjectById(result.meta?.project);\n+      await addBackgroundJobs(result, existing, { project, interaction });\n     });\n \n     const output = deepClone(result);\n@@ -1088,7 +1084,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     }\n \n     try {\n-      if (!this.canWriteResourceType(resourceType) || !this.isResourceWriteable(undefined, resource)) {\n+      if (!this.canPerformInteraction(AccessPolicyInteraction.DELETE, resource)) {\n         throw new OperationOutcomeError(forbidden);\n       }\n \n@@ -2086,85 +2082,81 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n   }\n \n   /**\n-   * Determines if the current user can read the specified resource type.\n-   * @param resourceType - The resource type.\n-   * @returns True if the current user can read the specified resource type.\n+   * Verifies that the current user would be allowed to perform the given interaction,\n+   * without the full check on the specific resource being interacted with.\n+   * @param interaction - The FHIR interaction being performed.\n+   * @param resourceType - The type of resource the interaction is performed on.\n+   * @returns True when the interaction is permitted by the access policy for the given resource type.\n    */\n-  canReadResourceType(resourceType: string): boolean {\n+  supportsInteraction(interaction: AccessPolicyInteraction, resourceType: string): boolean {\n     if (!this.isSuperAdmin() && protectedResourceTypes.includes(resourceType)) {\n       return false;\n     }\n     if (!this.context.accessPolicy) {\n       return true;\n     }\n-    return canReadResourceType(this.context.accessPolicy, resourceType as ResourceType);\n+    return accessPolicySupportsInteraction(this.context.accessPolicy, interaction, resourceType as ResourceType);\n   }\n \n   /**\n-   * Determines if the current user can write the specified resource type.\n-   * This is a preliminary check before evaluating a write operation in depth.\n-   * If a user cannot write a resource type at all, then don't bother looking up previous versions.\n-   * @param resourceType - The resource type.\n-   * @returns True if the current user can write the specified resource type.\n-   */\n-  private canWriteResourceType(resourceType: string): boolean {\n-    if (!this.isSuperAdmin() && protectedResourceTypes.includes(resourceType)) {\n-      return false;\n-    }\n-    if (!this.context.accessPolicy) {\n-      return true;\n-    }\n-    return canWriteResourceType(this.context.accessPolicy, resourceType as ResourceType);\n-  }\n-\n-  /**\n-   * Determines if the current user can write to the specified resource.\n-   * This is a more in-depth check after building the candidate result of a write operation.\n+   * Determines if the current user can actually perform some interaction on the specified resource.\n+   * This is a more in-depth check, e.g. after building the candidate result of a write operation.\n+   * @param interaction - The interaction to be performed.\n    * @param resource - The resource.\n-   * @returns True if the current user can write the specified resource type.\n+   * @returns The access policy permitting the interaction, or undefined if not permitted.\n    */\n-  private canWriteToResource(resource: Resource): boolean {\n-    const resourceType = resource.resourceType;\n+  private canPerformInteraction(\n+    interaction: AccessPolicyInteraction,\n+    resource: Resource\n+  ): AccessPolicyResource | undefined {\n     if (!this.isSuperAdmin()) {\n-      if (protectedResourceTypes.includes(resourceType)) {\n-        return false;\n+      // Only Super Admins can access server-critical resource types\n+      if (protectedResourceTypes.includes(resource.resourceType)) {\n+        return undefined;\n       }\n-      if (resource.meta?.project !== this.context.projects?.[0]?.id) {\n-        return false;\n+      // Non-Superusers can only access resources in their Project, with read-only access to linked Projects\n+      if (readInteractions.includes(interaction)) {\n+        if (!this.context.projects?.some((p) => p.id === resource.meta?.project)) {\n+          return undefined;\n+        }\n+      } else if (resource.meta?.project !== this.context.projects?.[0]?.id) {\n+        return undefined;\n       }\n     }\n-    return !!satisfiedAccessPolicy(resource, AccessPolicyInteraction.UPDATE, this.context.accessPolicy);\n+    return satisfiedAccessPolicy(resource, interaction, this.context.accessPolicy);\n   }\n \n   /**\n    * Check that a resource can be written in its current form.\n    * @param previous - The resource before updates were applied.\n    * @param current - The resource as it will be written.\n+   * @param interaction - The FHIR interaction being performed.\n    * @returns True if the current user can write the specified resource type.\n    */\n-  private isResourceWriteable(previous: Resource | undefined, current: Resource): boolean {\n-    if (!this.isSuperAdmin() && current.meta?.project !== this.context.projects?.[0]?.id) {\n-      return false;\n-    }\n-\n-    const matchingPolicy = satisfiedAccessPolicy(current, AccessPolicyInteraction.UPDATE, this.context.accessPolicy);\n+  private isResourceWriteable(\n+    previous: Resource | undefined,\n+    current: Resource,\n+    interaction: 'create' | 'update'\n+  ): boolean {\n+    const matchingPolicy = this.canPerformInteraction(interaction, current);\n     if (!matchingPolicy) {\n       return false;\n     }\n-    if (matchingPolicy?.writeConstraint) {\n-      return matchingPolicy.writeConstraint.every((constraint) => {\n-        const invariant = evalFhirPathTyped(\n-          constraint.expression as string,\n-          [{ type: current.resourceType, value: current }],\n-          {\n-            '%before': { type: previous?.resourceType ?? 'undefined', value: previous },\n-            '%after': { type: current.resourceType, value: current },\n-          }\n-        );\n-        return invariant.length === 1 && invariant[0].value === true;\n-      });\n+    if (!matchingPolicy.writeConstraint) {\n+      return true;\n     }\n-    return true;\n+\n+    return matchingPolicy.writeConstraint.every((constraint) => {\n+      const invariant = evalFhirPathTyped(\n+        constraint.expression as string,\n+        [{ type: current.resourceType, value: current }],\n+        {\n+          '%before': { type: previous?.resourceType ?? 'undefined', value: previous },\n+          '%after': { type: current.resourceType, value: current },\n+        }\n+      );\n+      return invariant.length === 1 && invariant[0].value === true;\n+    });\n   }\n \n   /**\n\ndiff --git a/packages/server/src/fhir/search.ts b/packages/server/src/fhir/search.ts\nindex 75daedcd35..4dd2c8e5ff 100644\n--- a/packages/server/src/fhir/search.ts\n+++ b/packages/server/src/fhir/search.ts\n@@ -1,4 +1,5 @@\n import {\n+  AccessPolicyInteraction,\n   badRequest,\n   DEFAULT_MAX_SEARCH_COUNT,\n   DEFAULT_SEARCH_COUNT,\n@@ -249,7 +250,7 @@ function validateSearchResourceType(repo: Repository, resourceType: ResourceType\n     throw new OperationOutcomeError(badRequest('Cannot search on Binary resource type'));\n   }\n \n-  if (!repo.canReadResourceType(resourceType)) {\n+  if (!repo.supportsInteraction(AccessPolicyInteraction.SEARCH, resourceType)) {\n     throw new OperationOutcomeError(forbidden);\n   }\n }\n",
    "test_patch": "diff --git a/packages/core/src/access.test.ts b/packages/core/src/access.test.ts\nindex 23d0c3f779..921c82b848 100644\n--- a/packages/core/src/access.test.ts\n+++ b/packages/core/src/access.test.ts\n@@ -43,6 +43,10 @@ const restrictedPolicy: AccessPolicy = {\n       readonly: true,\n       criteria: 'Communication?status=completed',\n     },\n+    {\n+      resourceType: 'List',\n+      interaction: ['read', 'search', 'create'],\n+    },\n   ],\n };\n \n@@ -127,6 +131,20 @@ describe('Access', () => {\n         restrictedPolicy\n       )\n     ).toBeUndefined();\n+    expect(\n+      satisfiedAccessPolicy(\n+        { resourceType: 'List', status: 'current', mode: 'working' },\n+        AccessPolicyInteraction.CREATE,\n+        restrictedPolicy\n+      )\n+    ).toStrictEqual(expect.objectContaining({ resourceType: 'List' }));\n+    expect(\n+      satisfiedAccessPolicy(\n+        { resourceType: 'List', status: 'current', mode: 'working' },\n+        AccessPolicyInteraction.UPDATE,\n+        restrictedPolicy\n+      )\n+    ).toBeUndefined();\n   });\n \n   test('Legacy compartment case', () => {\n\ndiff --git a/packages/server/src/fhir/accesspolicy.test.ts b/packages/server/src/fhir/accesspolicy.test.ts\nindex b1ab234c4e..8a1403c4a6 100644\n--- a/packages/server/src/fhir/accesspolicy.test.ts\n+++ b/packages/server/src/fhir/accesspolicy.test.ts\n@@ -3,7 +3,6 @@ import {\n   getReferenceString,\n   LOINC,\n   normalizeErrorString,\n-  OperationOutcomeError,\n   Operator,\n   parseSearchRequest,\n   WithId,\n@@ -12,6 +11,7 @@ import {\n   AccessPolicy,\n   AccessPolicyResource,\n   ClientApplication,\n+  Condition,\n   Login,\n   Observation,\n   Organization,\n@@ -76,12 +76,7 @@ describe('AccessPolicy', () => {\n         accessPolicy,\n       });\n \n-      try {\n-        await repo2.readResource('Patient', patient.id);\n-        fail('Expected error');\n-      } catch (err) {\n-        expect((err as OperationOutcomeError).outcome.id).toStrictEqual('forbidden');\n-      }\n+      await expect(repo2.readResource('Patient', patient.id)).rejects.toThrow('Forbidden');\n     }));\n \n   test('Access policy restricting search', () =>\n@@ -98,12 +93,7 @@ describe('AccessPolicy', () => {\n         accessPolicy,\n       });\n \n-      try {\n-        await repo2.search({ resourceType: 'Patient' });\n-        fail('Expected error');\n-      } catch (err) {\n-        expect((err as OperationOutcomeError).outcome.id).toStrictEqual('forbidden');\n-      }\n+      await expect(repo2.search({ resourceType: 'Patient' })).rejects.toThrow('Forbidden');\n     }));\n \n   test('Access policy restricting write', () =>\n@@ -132,15 +122,8 @@ describe('AccessPolicy', () => {\n         accessPolicy,\n       });\n \n-      const patient2 = await repo2.readResource('Patient', patient.id);\n-      expect(patient2).toBeDefined();\n-\n-      try {\n-        await repo2.updateResource(patient);\n-        fail('Expected error');\n-      } catch (err) {\n-        expect((err as OperationOutcomeError).outcome.id).toStrictEqual('forbidden');\n-      }\n+      await expect(repo2.readResource('Patient', patient.id)).resolves.toBeDefined();\n+      await expect(repo2.updateResource(patient)).rejects.toThrow('Forbidden');\n     }));\n \n   test('Access policy restricting write before update', () =>\n@@ -176,15 +159,8 @@ describe('AccessPolicy', () => {\n         accessPolicy,\n       });\n \n-      const serviceRequest = await repo2.readResource('ServiceRequest', resource.id);\n-      expect(serviceRequest).toBeDefined();\n-\n-      try {\n-        await repo2.updateResource(resource);\n-        fail('Expected error');\n-      } catch (err) {\n-        expect((err as OperationOutcomeError).outcome.id).toStrictEqual('forbidden');\n-      }\n+      await expect(repo2.readResource('ServiceRequest', resource.id)).resolves.toBeDefined();\n+      await expect(repo2.updateResource(resource)).rejects.toThrow('Forbidden');\n     }));\n \n   test('Access policy restricting write after update', () =>\n@@ -220,15 +196,8 @@ describe('AccessPolicy', () => {\n         accessPolicy,\n       });\n \n-      const serviceRequest = await repo2.readResource('ServiceRequest', resource.id);\n-      expect(serviceRequest).toBeDefined();\n-\n-      try {\n-        await repo2.updateResource({ ...resource, status: 'completed' });\n-        fail('Expected error');\n-      } catch (err) {\n-        expect((err as OperationOutcomeError).outcome.id).toStrictEqual('forbidden');\n-      }\n+      await expect(repo2.readResource('ServiceRequest', resource.id)).resolves.toBeDefined();\n+      await expect(repo2.updateResource({ ...resource, status: 'completed' })).rejects.toThrow('Forbidden');\n     }));\n \n   test('Access policy restricting delete', () =>\n@@ -257,15 +226,8 @@ describe('AccessPolicy', () => {\n         accessPolicy,\n       });\n \n-      const patient2 = await repo2.readResource('Patient', patient.id);\n-      expect(patient2).toBeDefined();\n-\n-      try {\n-        await repo2.deleteResource('Patient', patient.id);\n-        fail('Expected error');\n-      } catch (err) {\n-        expect((err as OperationOutcomeError).outcome.id).toStrictEqual('forbidden');\n-      }\n+      await expect(repo2.readResource('Patient', patient.id)).resolves.toBeDefined();\n+      await expect(repo2.deleteResource('Patient', patient.id)).rejects.toThrow('Forbidden');\n     }));\n \n   test('Access policy set compartment', () =>\n@@ -528,23 +490,8 @@ describe('AccessPolicy', () => {\n       expect(readPatient2.meta?.accounts).toHaveLength(1);\n       expect(readPatient2.meta?.accounts).toContainEqual({ reference: 'Organization/' + org2 });\n \n-      // Try to read patient1 with repo2\n-      // This should fail\n-      try {\n-        await repo2.readResource('Patient', patient1.id);\n-        fail('Expected error');\n-      } catch (err) {\n-        expect((err as OperationOutcomeError).outcome.id).toStrictEqual('not-found');\n-      }\n-\n-      // Try to read patient2 with repo1\n-      // This should fail\n-      try {\n-        await repo1.readResource('Patient', patient2.id);\n-        fail('Expected error');\n-      } catch (err) {\n-        expect((err as OperationOutcomeError).outcome.id).toStrictEqual('not-found');\n-      }\n+      await expect(repo2.readResource('Patient', patient1.id)).rejects.toThrow('Not found');\n+      await expect(repo1.readResource('Patient', patient2.id)).rejects.toThrow('Not found');\n     }));\n \n   test(\"Access policy won't override existing account\", () =>\n@@ -604,8 +551,6 @@ describe('AccessPolicy', () => {\n       patient.gender = 'female';\n \n       patient = await repo2.updateResource(patient);\n-\n-      expect(patient).toBeDefined();\n       expect(patient.meta?.account?.reference).toStrictEqual('Organization/' + org1);\n       expect(patient.meta?.accounts).toHaveLength(1);\n       expect(patient.meta?.accounts).toContainEqual({ reference: 'Organization/' + org1 });\n@@ -686,23 +631,8 @@ describe('AccessPolicy', () => {\n       expect(readPatient2.meta?.accounts).toHaveLength(1);\n       expect(readPatient2.meta?.accounts).toContainEqual({ reference: 'Organization/' + org2 });\n \n-      // Try to read patient1 with repo2\n-      // This should fail\n-      try {\n-        await repo2.readResource('Patient', patient1.id);\n-        fail('Expected error');\n-      } catch (err) {\n-        expect((err as OperationOutcomeError).outcome.id).toStrictEqual('not-found');\n-      }\n-\n-      // Try to read patient2 with repo1\n-      // This should fail\n-      try {\n-        await repo1.readResource('Patient', patient2.id);\n-        fail('Expected error');\n-      } catch (err) {\n-        expect((err as OperationOutcomeError).outcome.id).toStrictEqual('not-found');\n-      }\n+      await expect(repo2.readResource('Patient', patient1.id)).rejects.toThrow('Not found');\n+      await expect(repo1.readResource('Patient', patient2.id)).rejects.toThrow('Not found');\n     }));\n \n   test('Multiple entries per resource type', () =>\n@@ -742,17 +672,11 @@ describe('AccessPolicy', () => {\n       });\n       expect(serviceRequest2).toBeDefined();\n \n-      // Try to update the ServiceRequest with status=completed\n+      // Try to update the ServiceRequest to status=completed\n       // This should fail\n-      try {\n-        await repo.updateResource<ServiceRequest>({\n-          ...serviceRequest2,\n-          status: 'completed',\n-        });\n-        fail('Expected error');\n-      } catch (err) {\n-        expect((err as OperationOutcomeError).outcome.id).toStrictEqual('forbidden');\n-      }\n+      await expect(repo.updateResource<ServiceRequest>({ ...serviceRequest2, status: 'completed' })).rejects.toThrow(\n+        'Forbidden'\n+      );\n     }));\n \n   test('ClientApplication with account restriction', () =>\n@@ -858,12 +782,7 @@ describe('AccessPolicy', () => {\n       expect(patient2).toBeDefined();\n \n       // The ClientApplication should not be able to access it\n-      try {\n-        await clientRepo.readResource<Patient>('Patient', patient2.id);\n-        fail('Expected error');\n-      } catch (err) {\n-        expect((err as OperationOutcomeError).outcome.id).toStrictEqual('not-found');\n-      }\n+      await expect(clientRepo.readResource<Patient>('Patient', patient2.id)).rejects.toThrow('Not found');\n \n       // Create an Observation outside of the account\n       const observation2 = await systemRepo.createResource<Observation>({\n@@ -878,12 +797,7 @@ describe('AccessPolicy', () => {\n       expect(observation2).toBeDefined();\n \n       // The ClientApplication should not be able to access it\n-      try {\n-        await clientRepo.readResource<Observation>('Observation', observation2.id);\n-        fail('Expected error');\n-      } catch (err) {\n-        expect((err as OperationOutcomeError).outcome.id).toStrictEqual('not-found');\n-      }\n+      await expect(clientRepo.readResource<Observation>('Observation', observation2.id)).rejects.toThrow('Not found');\n     }));\n \n   test('ClientApplication with access policy', () =>\n@@ -939,8 +853,8 @@ describe('AccessPolicy', () => {\n       // Create an Observation using the ClientApplication\n       // Observation is not in the AccessPolicy\n       // So this should fail\n-      try {\n-        await clientRepo.createResource<Observation>({\n+      await expect(\n+        clientRepo.createResource<Observation>({\n           resourceType: 'Observation',\n           status: 'final',\n           subject: createReference(patient as Patient),\n@@ -948,11 +862,8 @@ describe('AccessPolicy', () => {\n             text: 'test',\n           },\n           valueString: 'positive',\n-        });\n-        fail('Expected error');\n-      } catch (err) {\n-        expect((err as OperationOutcomeError).outcome.id).toStrictEqual('forbidden');\n-      }\n+        })\n+      ).rejects.toThrow('Forbidden');\n     }));\n \n   test('Readonly fields on write', () =>\n@@ -1267,30 +1178,27 @@ describe('AccessPolicy', () => {\n \n   test('Hidden fields on read', () =>\n     withTestContext(async () => {\n+      const { repo: repo2, project } = await createTestProject({\n+        withRepo: true,\n+        // AccessPolicy that hides Patient name\n+        accessPolicy: {\n+          resourceType: 'AccessPolicy',\n+          resource: [\n+            {\n+              resourceType: 'Patient',\n+              hiddenFields: ['name'],\n+            },\n+          ],\n+        },\n+      });\n+\n       const patient = await systemRepo.createResource<Patient>({\n         resourceType: 'Patient',\n+        meta: { project: project.id },\n         name: [{ given: ['Alice'], family: 'Smith' }],\n         birthDate: '1970-01-01',\n       });\n \n-      // AccessPolicy that hides Patient name\n-      const accessPolicy: AccessPolicy = {\n-        resourceType: 'AccessPolicy',\n-        resource: [\n-          {\n-            resourceType: 'Patient',\n-            hiddenFields: ['name'],\n-          },\n-        ],\n-      };\n-\n-      const repo2 = new Repository({\n-        author: {\n-          reference: 'Practitioner/123',\n-        },\n-        accessPolicy,\n-      });\n-\n       const readResource = await repo2.readResource<Patient>('Patient', patient.id);\n       expect(readResource).toMatchObject({\n         resourceType: 'Patient',\n@@ -1316,8 +1224,23 @@ describe('AccessPolicy', () => {\n \n   test('Nested hidden fields on read', () =>\n     withTestContext(async () => {\n+      const { repo: repo2, project } = await createTestProject({\n+        withRepo: true,\n+        // AccessPolicy that hides ServiceRequest subject.display\n+        accessPolicy: {\n+          resourceType: 'AccessPolicy',\n+          resource: [\n+            {\n+              resourceType: 'ServiceRequest',\n+              hiddenFields: ['subject.display'],\n+            },\n+          ],\n+        },\n+      });\n+\n       const serviceRequest = await systemRepo.createResource<ServiceRequest>({\n         resourceType: 'ServiceRequest',\n+        meta: { project: project.id },\n         status: 'active',\n         intent: 'order',\n         code: {\n@@ -1329,24 +1252,6 @@ describe('AccessPolicy', () => {\n         },\n       });\n \n-      // AccessPolicy that hides ServiceRequest subject.display\n-      const accessPolicy: AccessPolicy = {\n-        resourceType: 'AccessPolicy',\n-        resource: [\n-          {\n-            resourceType: 'ServiceRequest',\n-            hiddenFields: ['subject.display'],\n-          },\n-        ],\n-      };\n-\n-      const repo2 = new Repository({\n-        author: {\n-          reference: 'Practitioner/123',\n-        },\n-        accessPolicy,\n-      });\n-\n       const readResource = await repo2.readResource<ServiceRequest>('ServiceRequest', serviceRequest.id);\n       expect(readResource).toMatchObject<Partial<ServiceRequest>>({\n         resourceType: 'ServiceRequest',\n@@ -1465,8 +1370,23 @@ describe('AccessPolicy', () => {\n \n   test('Hide nonexistent field', () =>\n     withTestContext(async () => {\n+      const { repo: repo2, project } = await createTestProject({\n+        withRepo: true,\n+        // AccessPolicy that hides ServiceRequest subject.display\n+        accessPolicy: {\n+          resourceType: 'AccessPolicy',\n+          resource: [\n+            {\n+              resourceType: 'ServiceRequest',\n+              hiddenFields: ['subject.display'],\n+            },\n+          ],\n+        },\n+      });\n+\n       const serviceRequest = await systemRepo.createResource<ServiceRequest>({\n         resourceType: 'ServiceRequest',\n+        meta: { project: project.id },\n         status: 'active',\n         intent: 'order',\n         code: {\n@@ -1477,24 +1397,6 @@ describe('AccessPolicy', () => {\n         },\n       });\n \n-      // AccessPolicy that hides ServiceRequest subject.display\n-      const accessPolicy: AccessPolicy = {\n-        resourceType: 'AccessPolicy',\n-        resource: [\n-          {\n-            resourceType: 'ServiceRequest',\n-            hiddenFields: ['subject.display'],\n-          },\n-        ],\n-      };\n-\n-      const repo2 = new Repository({\n-        author: {\n-          reference: 'Practitioner/123',\n-        },\n-        accessPolicy,\n-      });\n-\n       const readResource = await repo2.readResource<ServiceRequest>('ServiceRequest', serviceRequest.id);\n       expect(readResource).toMatchObject({\n         resourceType: 'ServiceRequest',\n@@ -1581,28 +1483,26 @@ describe('AccessPolicy', () => {\n \n   test('Identifier criteria', () =>\n     withTestContext(async () => {\n+      const identifier = randomUUID();\n+      const { repo: repo2, project } = await createTestProject({\n+        withRepo: true,\n+        // AccessPolicy that only allows one specific Questionnaire\n+        accessPolicy: {\n+          resourceType: 'AccessPolicy',\n+          resource: [\n+            {\n+              resourceType: 'Questionnaire',\n+              criteria: 'Questionnaire?identifier=https://example.com|' + identifier,\n+            },\n+          ],\n+        },\n+      });\n+\n       const questionnaire = await systemRepo.createResource<Questionnaire>({\n         resourceType: 'Questionnaire',\n+        meta: { project: project.id },\n         status: 'active',\n-        identifier: [{ system: 'https://example.com', value: randomUUID() }],\n-      });\n-\n-      // AccessPolicy that only allows one specific Questionnaire\n-      const accessPolicy: AccessPolicy = {\n-        resourceType: 'AccessPolicy',\n-        resource: [\n-          {\n-            resourceType: 'Questionnaire',\n-            criteria: 'Questionnaire?identifier=' + questionnaire.identifier?.[0].value,\n-          },\n-        ],\n-      };\n-\n-      const repo2 = new Repository({\n-        author: {\n-          reference: 'Practitioner/123',\n-        },\n-        accessPolicy,\n+        identifier: [{ system: 'https://example.com', value: identifier }],\n       });\n \n       const readResource = await repo2.readResource<Questionnaire>('Questionnaire', questionnaire.id);\n@@ -1658,11 +1558,11 @@ describe('AccessPolicy', () => {\n       expect(resource.status).toStrictEqual('preliminary');\n \n       resource.status = 'final';\n-      await expect(repo.updateResource(resource)).rejects.toThrow(new Error('Forbidden'));\n+      await expect(repo.updateResource(resource)).rejects.toThrow('Forbidden');\n       resource.subject = { reference: 'Patient/test' };\n       await expect(repo.updateResource(resource)).resolves.toBeDefined();\n       resource.status = 'cancelled';\n-      await expect(repo.updateResource(resource)).rejects.toThrow(new Error('Forbidden'));\n+      await expect(repo.updateResource(resource)).rejects.toThrow('Forbidden');\n     }));\n \n   test('Overlapping resource policies', () =>\n@@ -1702,41 +1602,15 @@ describe('AccessPolicy', () => {\n       expect(sr.id).toBeDefined();\n \n       // Can update in \"active\" status\n-      sr = await repo2.updateResource<ServiceRequest>({\n-        ...sr,\n-        priority: 'stat',\n-      });\n-\n+      sr = await repo2.updateResource<ServiceRequest>({ ...sr, priority: 'stat' });\n       // Cannot put into \"completed\" status\n-      try {\n-        await repo2.updateResource<ServiceRequest>({\n-          ...sr,\n-          status: 'completed',\n-        });\n-        throw new Error('Should not be able to update resource');\n-      } catch (err) {\n-        expect(normalizeErrorString(err)).toStrictEqual('Forbidden');\n-      }\n-\n+      await expect(repo2.updateResource<ServiceRequest>({ ...sr, status: 'completed' })).rejects.toThrow('Forbidden');\n       // As admin, set the status\n-      sr = await systemRepo.updateResource<ServiceRequest>({\n-        ...sr,\n-        status: 'completed',\n-      });\n-\n+      sr = await systemRepo.updateResource<ServiceRequest>({ ...sr, status: 'completed' });\n       // Can still read\n       sr = await repo2.readResource<ServiceRequest>('ServiceRequest', sr.id);\n-\n       // Cannot update\n-      try {\n-        await repo2.updateResource<ServiceRequest>({\n-          ...sr,\n-          priority: 'routine',\n-        });\n-        throw new Error('Should not be able to update resource');\n-      } catch (err) {\n-        expect(normalizeErrorString(err)).toStrictEqual('Forbidden');\n-      }\n+      await expect(repo2.updateResource<ServiceRequest>({ ...sr, priority: 'routine' })).rejects.toThrow('Forbidden');\n     }));\n \n   test('Compound parameterized access policy', () =>\n@@ -1789,12 +1663,8 @@ describe('AccessPolicy', () => {\n         userConfig: {} as UserConfiguration,\n       });\n \n-      const check1 = await repo2.readResource<Patient>('Patient', p1.id);\n-      expect(check1.id).toBe(p1.id);\n-\n-      const check2 = await repo2.readResource<Patient>('Patient', p2.id);\n-      expect(check2.id).toBe(p2.id);\n-\n+      await expect(repo2.readResource<Patient>('Patient', p1.id)).resolves.toBeDefined();\n+      await expect(repo2.readResource<Patient>('Patient', p2.id)).resolves.toBeDefined();\n       await expect(repo2.readResource<Patient>('Patient', p3.id)).rejects.toThrow('Not found');\n     }));\n \n@@ -1841,10 +1711,8 @@ describe('AccessPolicy', () => {\n         userConfig: {} as UserConfiguration,\n       });\n \n-      const check1 = await repo2.readResource<Task>('Task', t1.id);\n-      expect(check1.id).toBe(t1.id);\n-\n-      await expect(repo2.readResource<Task>('Task', t2.id)).rejects.toThrow('Not found');\n+      await expect(repo2.readResource('Task', t1.id)).resolves.toBeDefined();\n+      await expect(repo2.readResource('Task', t2.id)).rejects.toThrow('Not found');\n     }));\n \n   test('Project admin with access policy', () =>\n@@ -2461,18 +2329,9 @@ describe('AccessPolicy', () => {\n         checkReferencesOnWrite: true,\n       });\n \n-      const check1 = await repo1.readResource('Project', project1.id);\n-      expect(check1).toBeDefined();\n-\n-      const check2 = await repo2.readResource('Project', project2.id);\n-      expect(check2).toBeDefined();\n-\n-      try {\n-        await repo1.readResource('Project', project2.id);\n-        throw new Error('Should not be able to read resource');\n-      } catch (err) {\n-        expect(normalizeErrorString(err)).toStrictEqual('Not found');\n-      }\n+      await expect(repo1.readResource('Project', project1.id)).resolves.toBeDefined();\n+      await expect(repo2.readResource('Project', project2.id)).resolves.toBeDefined();\n+      await expect(repo1.readResource('Project', project2.id)).rejects.toThrow('Not found');\n \n       // Try to create a Patient in Project2 that references a Practitioner in Project1\n       const practitioner = await repo1.createResource<Practitioner>({ resourceType: 'Practitioner' });\n@@ -2517,10 +2376,7 @@ describe('AccessPolicy', () => {\n       const sd = bundle1.entry?.[0]?.resource as WithId<StructureDefinition>;\n       expect(sd.resourceType).toStrictEqual('StructureDefinition');\n \n-      // Try to update StructureDefinition, should fail\n       await expect(repo.updateResource<StructureDefinition>({ ...sd, url: randomUUID() })).rejects.toThrow('Forbidden');\n-\n-      // Try to delete StructureDefinition, should fail\n       await expect(repo.deleteResource('StructureDefinition', sd.id)).rejects.toThrow('Forbidden');\n     }));\n \n@@ -2537,15 +2393,10 @@ describe('AccessPolicy', () => {\n \n       // Try to search for StructureDefinitions, should succeed\n       const bundle1 = await repo.search<StructureDefinition>({ resourceType: 'StructureDefinition' });\n-      expect(bundle1).toBeDefined();\n-\n       const sd = bundle1.entry?.[0]?.resource as WithId<StructureDefinition>;\n       expect(sd.resourceType).toStrictEqual('StructureDefinition');\n \n-      // Try to update StructureDefinition, should fail\n       await expect(repo.updateResource<StructureDefinition>({ ...sd, url: randomUUID() })).rejects.toThrow('Forbidden');\n-\n-      // Try to delete StructureDefinition, should fail\n       await expect(repo.deleteResource('StructureDefinition', sd.id)).rejects.toThrow('Forbidden');\n     }));\n \n@@ -2841,10 +2692,7 @@ describe('AccessPolicy', () => {\n   ])('Server rejects invalid criteria %p', (policy, expectedError) =>\n     withTestContext(async () => {\n       await expect(\n-        systemRepo.createResource<AccessPolicy>({\n-          resourceType: 'AccessPolicy',\n-          resource: [policy],\n-        })\n+        systemRepo.createResource<AccessPolicy>({ resourceType: 'AccessPolicy', resource: [policy] })\n       ).rejects.toThrow(expectedError);\n     })\n   );\n@@ -2880,4 +2728,34 @@ describe('AccessPolicy', () => {\n       });\n       await expect(repo.readResource('Patient', patient2.id)).rejects.toThrow('Not found');\n     }));\n+\n+  test('Limit specific FHIR interactions', () =>\n+    withTestContext(async () => {\n+      const { repo } = await createTestProject({\n+        withRepo: true,\n+        accessPolicy: {\n+          resourceType: 'AccessPolicy',\n+          resource: [\n+            {\n+              resourceType: 'Condition',\n+              interaction: ['create', 'read'],\n+            },\n+          ],\n+        },\n+      });\n+\n+      const condition = await repo.createResource<Condition>({\n+        resourceType: 'Condition',\n+        subject: { reference: 'Patient/foo' },\n+      });\n+\n+      await expect(repo.readResource('Condition', condition.id)).resolves.toBeDefined();\n+      await expect(repo.search(parseSearchRequest('Condition?_id=' + condition.id))).rejects.toThrow('Forbidden');\n+      await expect(repo.readHistory('Condition', condition.id)).rejects.toThrow('Forbidden');\n+      await expect(repo.readVersion('Condition', condition.id, condition.meta?.versionId as string)).rejects.toThrow(\n+        'Forbidden'\n+      );\n+      await expect(repo.updateResource({ ...condition, onsetString: 'yesterday' })).rejects.toThrow('Forbidden');\n+      await expect(repo.deleteResource('Condition', condition.id)).rejects.toThrow('Forbidden');\n+    }));\n });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6676",
    "pr_id": 6676,
    "issue_id": 6663,
    "repo": "medplum/medplum",
    "problem_statement": "Allow for a way to fail silently on CCDA to FHIR converter for missing templateIds\nWhen calling the `convertCcdaToFhir(ccda)` function, there is an error that gets thrown pretty consistently across many of our CCDA files:\n\n`'Unhandled act templateId: 2.16.840.1.113883.10.20.22.2.6` The templateId can vary depending on the document.\n\nWould love a way to still use the CCDA to FHIR for what it can grab even if it's missing certain templateIds.\n\nLooks like this one is `2.16.840.1.113883.10.20.22.2.6` https://confluence.hl7.org/spaces/SD/pages/51227465/C-CDA+OIDs is Allergy Section (entries optional)",
    "issue_word_count": 111,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/ccda/src/ccda-to-fhir.ts",
      "packages/ccda/src/roundtrip.test.ts"
    ],
    "pr_changed_test_files": [
      "packages/ccda/src/roundtrip.test.ts"
    ],
    "base_commit": "e58e93f0c219828dd04ac35a7e6c05f637d5ae26",
    "head_commit": "26f3ef7e6dce3361f59a236138bff9a0bd3e4367",
    "repo_url": "https://github.com/medplum/medplum/pull/6676",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6676",
    "dockerfile": "",
    "pr_merged_at": "2025-05-29T20:16:17.000Z",
    "patch": "diff --git a/packages/ccda/src/ccda-to-fhir.ts b/packages/ccda/src/ccda-to-fhir.ts\nindex b759a75629..cb861b4007 100644\n--- a/packages/ccda/src/ccda-to-fhir.ts\n+++ b/packages/ccda/src/ccda-to-fhir.ts\n@@ -37,7 +37,10 @@ import {\n } from '@medplum/fhirtypes';\n import { mapCcdaToFhirDate, mapCcdaToFhirDateTime } from './datetime';\n import {\n+  OID_ALLERGIES_SECTION_ENTRIES_OPTIONAL,\n+  OID_ALLERGIES_SECTION_ENTRIES_OPTIONAL_V2,\n   OID_ALLERGIES_SECTION_ENTRIES_REQUIRED,\n+  OID_ALLERGIES_SECTION_ENTRIES_REQUIRED_V2,\n   OID_CARE_TEAMS_SECTION,\n   OID_GOAL_OBSERVATION,\n   OID_GOALS_SECTION,\n@@ -49,7 +52,10 @@ import {\n   OID_NOTES_SECTION,\n   OID_PAYERS_SECTION,\n   OID_PLAN_OF_CARE_SECTION,\n+  OID_PROBLEMS_SECTION_ENTRIES_OPTIONAL,\n   OID_PROBLEMS_SECTION_ENTRIES_REQUIRED,\n+  OID_PROBLEMS_SECTION_V2_ENTRIES_OPTIONAL,\n+  OID_PROBLEMS_SECTION_V2_ENTRIES_REQUIRED,\n   OID_PROCEDURES_SECTION_ENTRIES_REQUIRED,\n   OID_REASON_FOR_REFERRAL,\n } from './oids';\n@@ -111,6 +117,10 @@ import {\n } from './types';\n import { convertToCompactXml } from './xml';\n \n+export interface CcdaToFhirOptions {\n+  ignoreUnsupportedSections?: boolean;\n+}\n+\n /**\n  * Converts C-CDA documents to FHIR resources\n  * Following Medplum TypeScript rules:\n@@ -119,19 +129,22 @@ import { convertToCompactXml } from './xml';\n  * - Adds proper metadata and timestamps\n  *\n  * @param ccda - The C-CDA document to convert\n+ * @param options - Optional conversion options\n  * @returns The converted FHIR resources\n  */\n-export function convertCcdaToFhir(ccda: Ccda): Bundle {\n-  return new CcdaToFhirConverter(ccda).convert();\n+export function convertCcdaToFhir(ccda: Ccda, options?: CcdaToFhirOptions): Bundle {\n+  return new CcdaToFhirConverter(ccda, options).convert();\n }\n \n class CcdaToFhirConverter {\n   private readonly ccda: Ccda;\n+  private readonly options: CcdaToFhirOptions | undefined;\n   private readonly resources: Resource[] = [];\n   private patient?: Patient;\n \n-  constructor(ccda: Ccda) {\n+  constructor(ccda: Ccda, options?: CcdaToFhirOptions) {\n     this.ccda = ccda;\n+    this.options = options;\n   }\n \n   convert(): Bundle {\n@@ -373,8 +386,14 @@ class CcdaToFhirConverter {\n     const templateId = section.templateId[0]['@_root'];\n     switch (templateId) {\n       case OID_ALLERGIES_SECTION_ENTRIES_REQUIRED:\n+      case OID_ALLERGIES_SECTION_ENTRIES_OPTIONAL:\n+      case OID_ALLERGIES_SECTION_ENTRIES_REQUIRED_V2:\n+      case OID_ALLERGIES_SECTION_ENTRIES_OPTIONAL_V2:\n         return this.processAllergyIntoleranceAct(act);\n       case OID_PROBLEMS_SECTION_ENTRIES_REQUIRED:\n+      case OID_PROBLEMS_SECTION_ENTRIES_OPTIONAL:\n+      case OID_PROBLEMS_SECTION_V2_ENTRIES_REQUIRED:\n+      case OID_PROBLEMS_SECTION_V2_ENTRIES_OPTIONAL:\n         return this.processConditionAct(act);\n       case OID_PLAN_OF_CARE_SECTION:\n         return this.processCarePlanAct(act);\n@@ -392,6 +411,9 @@ class CcdaToFhirConverter {\n         // This is part of USCDI v3, which is optional, and not yet implemented\n         return undefined;\n       default:\n+        if (this.options?.ignoreUnsupportedSections) {\n+          return undefined;\n+        }\n         throw new Error('Unhandled act templateId: ' + templateId);\n     }\n   }\n@@ -544,6 +566,9 @@ class CcdaToFhirConverter {\n       case OID_IMMUNIZATIONS_SECTION_ENTRIES_REQUIRED:\n         return this.processImmunizationSubstanceAdministration(substanceAdmin);\n       default:\n+        if (this.options?.ignoreUnsupportedSections) {\n+          return undefined;\n+        }\n         throw new Error('Unhandled substance administration templateId: ' + templateId);\n     }\n   }\n",
    "test_patch": "diff --git a/packages/ccda/src/roundtrip.test.ts b/packages/ccda/src/roundtrip.test.ts\nindex 7e18b14726..fd578f2557 100644\n--- a/packages/ccda/src/roundtrip.test.ts\n+++ b/packages/ccda/src/roundtrip.test.ts\n@@ -46,6 +46,36 @@ describe('convertCcdaToFhir', () => {\n     const expected = JSON.parse(readFileSync(join(testDataFolder, `${name}.json`), 'utf8'));\n     expect(bundle).toEqual(expected);\n   });\n+\n+  test('unrecognized act element', () => {\n+    // Start with a valid CCDA XML file\n+    const ccda = convertXmlToCcda(readFileSync(join(testDataFolder, 'ProcedureSectionActEntry.xml'), 'utf8'));\n+\n+    // Change the section template ID to an unrecognized value\n+    (ccda as any).component.structuredBody.component[0].section[0].templateId[0]['@_root'] = '9.9.9999';\n+\n+    // By default, this should throw an error\n+    expect(() => convertCcdaToFhir(ccda)).toThrow('Unhandled act templateId: 9.9.9999');\n+\n+    // Or we can ignore it\n+    const bundle = convertCcdaToFhir(ccda, { ignoreUnsupportedSections: true });\n+    expect(bundle).toBeDefined();\n+  });\n+\n+  test('unrecognized substanceAdministration element', () => {\n+    // Start with a valid CCDA XML file\n+    const ccda = convertXmlToCcda(readFileSync(join(testDataFolder, 'MedicationAtBedtime.xml'), 'utf8'));\n+\n+    // Change the section template ID to an unrecognized value\n+    (ccda as any).component.structuredBody.component[0].section[0].templateId[0]['@_root'] = '9.9.9999';\n+\n+    // By default, this should throw an error\n+    expect(() => convertCcdaToFhir(ccda)).toThrow('Unhandled substance administration templateId: 9.9.9999');\n+\n+    // Or we can ignore it\n+    const bundle = convertCcdaToFhir(ccda, { ignoreUnsupportedSections: true });\n+    expect(bundle).toBeDefined();\n+  });\n });\n \n describe('convertFhirToCcda', () => {\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6671",
    "pr_id": 6671,
    "issue_id": 6153,
    "repo": "medplum/medplum",
    "problem_statement": "Contained reference validation\nContained references throw a validation warning when using `validateResource` from `@medplum/core`.\n\nHere's an example demonstrating this:\n\n```typescript\nimport { indexStructureDefinitionBundle, validateResource } from '@medplum/core';\nimport { Observation, Bundle } from '@medplum/fhirtypes';\nimport { readJson } from '@medplum/definitions';\n\nconst typesBundle = readJson('fhir/r4/profiles-types.json') as Bundle;\nconst resourcesBundle = readJson('fhir/r4/profiles-resources.json') as Bundle;\nconst medplumBundle = readJson('fhir/r4/profiles-medplum.json') as Bundle;\n\nindexStructureDefinitionBundle(typesBundle);\nindexStructureDefinitionBundle(resourcesBundle);\nindexStructureDefinitionBundle(medplumBundle);\n\nconst resource = {\n  resourceType: 'Observation',\n  status: 'final',\n  code: { coding: [{ system: 'http://loinc.org/', code: '72166-2' }] },\n  subject: { reference: '#patient' },\n  contained: [\n    {\n      resourceType: 'Patient',\n      birthDate: '1949-08-14',\n    },\n  ],\n} as Observation;\n\nconst issues = validateResource(resource);\n\nconsole.log(issues);\n```\n\nThis produces this warning validation:\n\n```typescript\n[\n  {\n    severity: \"warning\",\n    code: \"structure\",\n    details: {\n      text: \"Invalid reference: got \\\"#patient\\\", expected \\\"http://hl7.org/fhir/StructureDefinition/Patient\\\", \\\"http://hl7.org/fhir/StructureDefinition/Group\\\", \\\"http://hl7.org/fhir/StructureDefinition/Device\\\", \\\"http://hl7.org/fhir/StructureDefinition/Location\\\"\",\n    },\n    expression: [ \"Observation.subject\" ],\n  }\n]\n```\n\nAn easy fix would be to guard against contained reference validation here whatsoever: https://github.com/medplum/medplum/blob/main/packages/core/src/typeschema/validation.ts#L382\n",
    "issue_word_count": 180,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/core/src/typeschema/validation.test.ts",
      "packages/core/src/typeschema/validation.ts"
    ],
    "pr_changed_test_files": [
      "packages/core/src/typeschema/validation.test.ts"
    ],
    "base_commit": "e58e93f0c219828dd04ac35a7e6c05f637d5ae26",
    "head_commit": "2a8299d1709fde06be44106d784bf569f261986c",
    "repo_url": "https://github.com/medplum/medplum/pull/6671",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6671",
    "dockerfile": "",
    "pr_merged_at": "2025-05-28T15:51:09.000Z",
    "patch": "diff --git a/packages/core/src/typeschema/validation.ts b/packages/core/src/typeschema/validation.ts\nindex 33021a8ec1..d959f3744e 100644\n--- a/packages/core/src/typeschema/validation.ts\n+++ b/packages/core/src/typeschema/validation.ts\n@@ -384,7 +384,16 @@ class ResourceValidator implements CrawlerVisitor {\n       return;\n     }\n \n-    const referenceResourceType = reference.reference.split('/')[0];\n+    if (reference.reference.startsWith('#')) {\n+      // Silently ignore contained references\n+      return;\n+    }\n+\n+    // Pick out the resource type from the reference, either as a conditional reference or a literal reference\n+    const referenceResourceType = reference.reference.includes('?')\n+      ? reference.reference.split('?')[0]\n+      : reference.reference.split('/')[0];\n+    \n     if (!referenceResourceType) {\n       // Silently ignore empty references - that will get picked up by constraint validation\n       return;\n",
    "test_patch": "diff --git a/packages/core/src/typeschema/validation.test.ts b/packages/core/src/typeschema/validation.test.ts\nindex e69208d473..fb9b5d2914 100644\n--- a/packages/core/src/typeschema/validation.test.ts\n+++ b/packages/core/src/typeschema/validation.test.ts\n@@ -1519,6 +1519,56 @@ describe('FHIR resource validation', () => {\n     expect(issues[0].details?.text).toContain('Invalid reference');\n   });\n \n+  test('Contained reference type check', () => {\n+    const observation: Observation = {\n+      resourceType: 'Observation',\n+      status: 'final',\n+      code: { text: 'test' },\n+      subject: { reference: '#patient' },\n+      contained: [\n+        {\n+          resourceType: 'Patient',\n+          id: 'patient',\n+          birthDate: '1949-08-14',\n+        },\n+      ],\n+    };\n+\n+    // Contained references should not generate validation warnings\n+    const issues = validateResource(observation);\n+    expect(issues).toHaveLength(0);\n+  });\n+\n+  test('Conditional reference type check', () => {\n+    const observation: Observation = {\n+      resourceType: 'Observation',\n+      status: 'final',\n+      code: { text: 'test' },\n+      subject: { reference: 'Patient?identifier=http://example.com/mrn|12345' },\n+    };\n+\n+    // Conditional references should still validate the resource type\n+    const issues = validateResource(observation);\n+    expect(issues).toHaveLength(0);\n+  });\n+\n+  test('Invalid conditional reference type check', () => {\n+    const observation: Observation = {\n+      resourceType: 'Observation',\n+      status: 'final',\n+      code: { text: 'test' },\n+      // subject should reference a Patient, not an Organization\n+      subject: { reference: 'Organization?identifier=http://example.com/id|123' },\n+    };\n+\n+    // Conditional references should still validate the resource type\n+    const issues = validateResource(observation);\n+    expect(issues).toHaveLength(1);\n+    expect(issues[0].severity).toBe('warning');\n+    expect(issues[0].details?.text).toContain('Invalid reference');\n+    expect(issues[0].details?.text).toContain('Organization');\n+  });\n+\n   test('Nested recursive properties', () => {\n     const consent: Consent = {\n       resourceType: 'Consent',\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6562",
    "pr_id": 6562,
    "issue_id": 6560,
    "repo": "medplum/medplum",
    "problem_statement": "Enable per project/user ability to turn on FHIR operation based rate limits.\nWe'd like to have the ability to start rate limiting non-production projects as we roll out our new rate limit strategy. Let's add in the a project level super admin configuration setting to enable on a per project basis. \n\nRelated to #6556",
    "issue_word_count": 58,
    "test_files_count": 4,
    "non_test_files_count": 10,
    "pr_changed_files": [
      "packages/server/src/auth/me.ts",
      "packages/server/src/config/types.ts",
      "packages/server/src/config/utils.ts",
      "packages/server/src/context.ts",
      "packages/server/src/fhir/accesspolicy.test.ts",
      "packages/server/src/fhir/references.test.ts",
      "packages/server/src/fhir/repo.test.ts",
      "packages/server/src/fhir/routes.ts",
      "packages/server/src/fhirinteractionlimit.test.ts",
      "packages/server/src/fhirinteractionlimit.ts",
      "packages/server/src/oauth/middleware.ts",
      "packages/server/src/oauth/token.ts",
      "packages/server/src/oauth/utils.ts",
      "packages/server/src/workers/batch.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/accesspolicy.test.ts",
      "packages/server/src/fhir/references.test.ts",
      "packages/server/src/fhir/repo.test.ts",
      "packages/server/src/fhirinteractionlimit.test.ts"
    ],
    "base_commit": "e2d159d568f593d5074602105d699aebb75d15ae",
    "head_commit": "c67c6514e374f9ea8a6ecde94770d49cb386d8be",
    "repo_url": "https://github.com/medplum/medplum/pull/6562",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6562",
    "dockerfile": "",
    "pr_merged_at": "2025-05-08T21:13:25.000Z",
    "patch": "diff --git a/packages/server/src/auth/me.ts b/packages/server/src/auth/me.ts\nindex 342ff70622..c449eed4d5 100644\n--- a/packages/server/src/auth/me.ts\n+++ b/packages/server/src/auth/me.ts\n@@ -75,7 +75,7 @@ export async function meHandler(req: Request, res: Response): Promise<void> {\n   res.status(200).json(await rewriteAttachments(RewriteMode.PRESIGNED_URL, systemRepo, result));\n }\n \n-async function getUserConfiguration(\n+export async function getUserConfiguration(\n   systemRepo: Repository,\n   project: Project,\n   membership: ProjectMembership\n\ndiff --git a/packages/server/src/config/types.ts b/packages/server/src/config/types.ts\nindex b6c1abeddd..8858f2fbfb 100644\n--- a/packages/server/src/config/types.ts\n+++ b/packages/server/src/config/types.ts\n@@ -66,7 +66,7 @@ export interface MedplumServerConfig {\n   defaultRateLimit?: number;\n   defaultAuthRateLimit?: number;\n   /** Number of FHIR interaction rate limit units per minute users can consume by default; overridable by Project settings */\n-  defaultFhirInteractionLimit?: number;\n+  defaultFhirQuota?: number;\n \n   /** Max length of Bot AuditEvent.outcomeDesc when creating a FHIR Resource */\n   maxBotLogLengthForResource?: number;\n\ndiff --git a/packages/server/src/config/utils.ts b/packages/server/src/config/utils.ts\nindex 86a5fdf621..4149db2340 100644\n--- a/packages/server/src/config/utils.ts\n+++ b/packages/server/src/config/utils.ts\n@@ -39,7 +39,7 @@ export function addDefaults(config: MedplumServerConfig): ServerConfig {\n   config.defaultRateLimit ??= 60_000;\n   config.defaultAuthRateLimit ??= 160;\n \n-  config.defaultFhirInteractionLimit ??= 50_000;\n+  config.defaultFhirQuota ??= 50_000;\n   return config as ServerConfig;\n }\n \n@@ -65,9 +65,9 @@ type DefaultConfigKeys =\n   | 'emailProvider'\n   | 'defaultRateLimit'\n   | 'defaultAuthRateLimit'\n-  | 'defaultFhirInteractionLimit';\n+  | 'defaultFhirQuota';\n \n-const integerKeys = ['port', 'accurateCountThreshold'];\n+const integerKeys = ['port', 'accurateCountThreshold', 'defaultRateLimit', 'defaultAuthRateLimit', 'defaultFhirQuota'];\n \n export function isIntegerConfig(key: string): boolean {\n   return integerKeys.includes(key);\n\ndiff --git a/packages/server/src/context.ts b/packages/server/src/context.ts\nindex 3e4480e4ed..ba7da5de3c 100644\n--- a/packages/server/src/context.ts\n+++ b/packages/server/src/context.ts\n@@ -6,7 +6,7 @@ import { getConfig } from './config/loader';\n import { getRepoForLogin } from './fhir/accesspolicy';\n import { Repository, getSystemRepo } from './fhir/repo';\n import { FhirRateLimiter } from './fhirinteractionlimit';\n-import { systemLogger } from './logger';\n+import { globalLogger, systemLogger } from './logger';\n import { AuthState, authenticateTokenImpl, isExtendedMode } from './oauth/middleware';\n import { getRedis } from './redis';\n import { IRequestContext, requestContextStore } from './request-context-store';\n@@ -82,7 +82,7 @@ export class AuthenticatedRequestContext extends RequestContext {\n     return new AuthenticatedRequestContext(\n       ctx?.requestId ?? '',\n       ctx?.traceId ?? '',\n-      {} as unknown as AuthState,\n+      { userConfig: {} } as unknown as AuthState,\n       getSystemRepo(),\n       systemLogger\n     );\n@@ -213,10 +213,14 @@ function write(msg: string): void {\n }\n \n function getFhirRateLimiter(authState: AuthState, logger?: Logger): FhirRateLimiter | undefined {\n-  const projectLimit = authState.project?.systemSetting?.find(\n-    (s) => s.name === 'userFhirInteractionLimit'\n-  )?.valueInteger;\n-  const limit = projectLimit ?? getConfig().defaultFhirInteractionLimit;\n+  const defaultUserLimit = authState.project?.systemSetting?.find((s) => s.name === 'userFhirQuota')?.valueInteger;\n+  const userSpecificLimit = authState.userConfig.option?.find((o) => o.id === 'fhirQuota')?.valueInteger;\n+  const userLimit = userSpecificLimit ?? defaultUserLimit ?? getConfig().defaultFhirQuota;\n \n-  return authState.membership ? new FhirRateLimiter(getRedis(), authState, limit, logger) : undefined;\n+  const perProjectLimit = authState.project?.systemSetting?.find((s) => s.name === 'totalFhirQuota')?.valueInteger;\n+  const projectLimit = perProjectLimit ?? userLimit * 10;\n+\n+  return authState.membership\n+    ? new FhirRateLimiter(getRedis(), authState, userLimit, projectLimit, logger ?? globalLogger)\n+    : undefined;\n }\n\ndiff --git a/packages/server/src/fhir/routes.ts b/packages/server/src/fhir/routes.ts\nindex 9e684ab539..44c80a4905 100644\n--- a/packages/server/src/fhir/routes.ts\n+++ b/packages/server/src/fhir/routes.ts\n@@ -110,7 +110,7 @@ fhirRouter.use(function setupResponseInterceptors(req: Request, res: Response, n\n     const ctx = tryGetRequestContext();\n     if (ctx?.fhirRateLimiter) {\n       // Attach rate limit header before sending first part of response body\n-      res.append('RateLimit', ctx.fhirRateLimiter.rateLimitHeader());\n+      ctx.fhirRateLimiter.attachRateLimitHeader(res);\n     }\n \n     return oldSend.call(res, ...args);\n\ndiff --git a/packages/server/src/fhirinteractionlimit.ts b/packages/server/src/fhirinteractionlimit.ts\nindex 56f491818e..704bfa9897 100644\n--- a/packages/server/src/fhirinteractionlimit.ts\n+++ b/packages/server/src/fhirinteractionlimit.ts\n@@ -1,43 +1,62 @@\n-import { Logger } from '@medplum/core';\n+import { Logger, OperationOutcomeError, tooManyRequests } from '@medplum/core';\n+import { Response } from 'express';\n import Redis from 'ioredis';\n import { RateLimiterRedis, RateLimiterRes } from 'rate-limiter-flexible';\n-import { globalLogger } from './logger';\n import { AuthState } from './oauth/middleware';\n \n export class FhirRateLimiter {\n   private readonly limiter: RateLimiterRedis;\n-  private readonly key: string;\n+  private readonly userKey: string;\n+  private readonly projectLimiter: RateLimiterRedis;\n+  private readonly projectKey: string;\n \n-  private unitsRemaining: number;\n-  private secondsToReset = 60;\n+  private current?: RateLimiterRes;\n   private delta: number;\n   private logThreshold: number;\n+  private readonly enabled: boolean;\n \n   private readonly logger: Logger;\n \n-  constructor(redis: Redis, authState: AuthState, limit: number, logger = globalLogger) {\n+  constructor(redis: Redis, authState: AuthState, userLimit: number, projectLimit: number, logger: Logger) {\n     this.limiter = new RateLimiterRedis({\n-      keyPrefix: 'medplum:rl:fhir:',\n+      keyPrefix: 'medplum:rl:fhir:membership:',\n       storeClient: redis,\n-      points: limit,\n+      points: userLimit,\n       duration: 60, // Per minute\n     });\n-    this.key = this.getKey(authState);\n+    this.userKey = authState.membership.id;\n+\n+    this.projectLimiter = new RateLimiterRedis({\n+      keyPrefix: 'medplum:rl:fhir:project:',\n+      storeClient: redis,\n+      points: projectLimit,\n+      duration: 60, // Per minute\n+    });\n+    this.projectKey = authState.project.id;\n \n-    this.unitsRemaining = limit;\n     this.delta = 0;\n \n     this.logger = logger;\n-    this.logThreshold = Math.floor(limit * 0.1); // Log requests that consume at least 10% of the user's total limit\n+    this.logThreshold = Math.floor(userLimit * 0.1); // Log requests that consume at least 10% of the user's total limit\n+    this.enabled = Boolean(authState.project.systemSetting?.find((s) => s.name === 'enableFhirQuota')?.valueBoolean);\n   }\n \n-  private setState(result: RateLimiterRes): void {\n-    this.unitsRemaining = result.remainingPoints;\n-    this.secondsToReset = Math.ceil(result.msBeforeNext / 1_000);\n+  private setState(result: RateLimiterRes, ...others: RateLimiterRes[]): void {\n+    let min = result.remainingPoints;\n+    for (const other of others) {\n+      if (other.remainingPoints < min) {\n+        min = other.remainingPoints;\n+        result = other;\n+      }\n+    }\n+    this.current = result;\n   }\n \n-  rateLimitHeader(): string {\n-    return `\"fhirInteractions\";r=${this.unitsRemaining};t=${this.secondsToReset}`;\n+  attachRateLimitHeader(res: Response): void {\n+    if (this.current) {\n+      const t = Math.ceil(this.current.msBeforeNext / 1000);\n+      res.append('RateLimit', `\"fhirInteractions\";r=${this.current.remainingPoints};t=${t}`);\n+    }\n   }\n \n   /**\n@@ -46,13 +65,13 @@ export class FhirRateLimiter {\n    */\n   async consume(points: number): Promise<void> {\n     // If user is already over the limit, just block\n-    if (this.unitsRemaining <= 0) {\n-      // throw new OperationOutcomeError(tooManyRequests);\n+    if (this.current && this.current.remainingPoints <= 0 && this.enabled) {\n+      throw new OperationOutcomeError(tooManyRequests);\n     }\n \n     this.delta += points;\n     try {\n-      const result = await this.limiter.consume(this.key, points);\n+      const result = await this.limiter.consume(this.userKey, points);\n       if (this.delta > this.logThreshold) {\n         this.logger.warn('High rate limit consumption', {\n           limit: this.limiter.points,\n@@ -61,11 +80,11 @@ export class FhirRateLimiter {\n         });\n         this.logThreshold = Number.POSITIVE_INFINITY; // Disable additional logs for this request\n       }\n-      this.setState(result);\n-      // return result;\n+      const projectResult = await this.projectLimiter.consume(this.projectKey, points);\n+      this.setState(result, projectResult);\n     } catch (err: unknown) {\n-      if (err instanceof Error) {\n-        // throw err;\n+      if (err instanceof Error && this.enabled) {\n+        throw err;\n       }\n       const result = err as RateLimiterRes;\n       this.setState(result);\n@@ -74,7 +93,9 @@ export class FhirRateLimiter {\n         used: result.consumedPoints,\n         msToReset: result.msBeforeNext,\n       });\n-      // throw new OperationOutcomeError(tooManyRequests);\n+      if (this.enabled) {\n+        throw new OperationOutcomeError(tooManyRequests);\n+      }\n     }\n   }\n \n@@ -97,8 +118,4 @@ export class FhirRateLimiter {\n   get unitsConsumed(): number {\n     return this.delta;\n   }\n-\n-  private getKey(authState: AuthState): string {\n-    return authState.membership.id;\n-  }\n }\n\ndiff --git a/packages/server/src/oauth/middleware.ts b/packages/server/src/oauth/middleware.ts\nindex 9895fade81..c3ca3b4493 100644\n--- a/packages/server/src/oauth/middleware.ts\n+++ b/packages/server/src/oauth/middleware.ts\n@@ -1,5 +1,5 @@\n import { OperationOutcomeError, ProfileResource, unauthorized, WithId } from '@medplum/core';\n-import { Login, Project, ProjectMembership } from '@medplum/fhirtypes';\n+import { Login, Project, ProjectMembership, UserConfiguration } from '@medplum/fhirtypes';\n import { NextFunction, Request, Response } from 'express';\n import { IncomingMessage } from 'http';\n import { getConfig } from '../config/loader';\n@@ -10,6 +10,7 @@ export interface AuthState {\n   login: Login;\n   project: WithId<Project>;\n   membership: WithId<ProjectMembership>;\n+  userConfig: UserConfiguration;\n   accessToken?: string;\n \n   onBehalfOf?: WithId<ProfileResource>;\n\ndiff --git a/packages/server/src/oauth/token.ts b/packages/server/src/oauth/token.ts\nindex e56350fa5a..6e25c9a356 100644\n--- a/packages/server/src/oauth/token.ts\n+++ b/packages/server/src/oauth/token.ts\n@@ -19,6 +19,7 @@ import { createHash, randomUUID } from 'crypto';\n import { Request, RequestHandler, Response } from 'express';\n import { JWTVerifyOptions, createRemoteJWKSet, jwtVerify } from 'jose';\n import { asyncWrap } from '../async';\n+import { getUserConfiguration } from '../auth/me';\n import { getProjectIdByClientId } from '../auth/utils';\n import { getConfig } from '../config/loader';\n import { getAccessPolicyForLogin } from '../fhir/accesspolicy';\n@@ -146,7 +147,8 @@ async function handleClientCredentials(req: Request, res: Response): Promise<voi\n   // TODO: build full AuthState object, including on-behalf-of\n \n   try {\n-    const accessPolicy = await getAccessPolicyForLogin({ project, login, membership });\n+    const userConfig = await getUserConfiguration(systemRepo, project, membership);\n+    const accessPolicy = await getAccessPolicyForLogin({ project, login, membership, userConfig });\n     await checkIpAccessRules(login, accessPolicy);\n   } catch (err) {\n     sendTokenError(res, 'invalid_request', normalizeErrorString(err));\n\ndiff --git a/packages/server/src/oauth/utils.ts b/packages/server/src/oauth/utils.ts\nindex c86413826d..3034f0263f 100644\n--- a/packages/server/src/oauth/utils.ts\n+++ b/packages/server/src/oauth/utils.ts\n@@ -34,6 +34,7 @@ import fetch from 'node-fetch';\n import assert from 'node:assert/strict';\n import { timingSafeEqual } from 'node:crypto';\n import { authenticator } from 'otplib';\n+import { getUserConfiguration } from '../auth/me';\n import { getAccessPolicyForLogin, getRepoForLogin } from '../fhir/accesspolicy';\n import { getSystemRepo } from '../fhir/repo';\n import { parseSmartScopes, SmartScope } from '../fhir/smart';\n@@ -426,8 +427,10 @@ export async function setLoginMembership(login: Login, membershipId: string): Pr\n   // Or could this be done closer to call site?\n   // This method is used internally in a bunch of places that do not need to check IP access rules\n \n+  const userConfig = await getUserConfiguration(systemRepo, project, membership);\n+\n   // Get the access policy\n-  const accessPolicy = await getAccessPolicyForLogin({ project, login, membership });\n+  const accessPolicy = await getAccessPolicyForLogin({ project, login, membership, userConfig });\n \n   // Check IP Access Rules\n   await checkIpAccessRules(login, accessPolicy);\n@@ -882,7 +885,8 @@ export async function getLoginForAccessToken(\n \n   const membership = await systemRepo.readReference<ProjectMembership>(login.membership);\n   const project = await systemRepo.readReference<Project>(membership.project as Reference<Project>);\n-  const authState = { login, project, membership };\n+  const userConfig = await getUserConfiguration(systemRepo, project, membership);\n+  const authState = { login, project, membership, userConfig };\n   await tryAddOnBehalfOf(req, authState);\n   return authState;\n }\n@@ -925,8 +929,9 @@ export async function getLoginForBasicAuth(req: IncomingMessage, token: string):\n     authMethod: 'client',\n     authTime: new Date().toISOString(),\n   };\n+  const userConfig = await getUserConfiguration(systemRepo, project, membership);\n \n-  const authState: AuthState = { login, project, membership };\n+  const authState: AuthState = { login, project, membership, userConfig };\n   await tryAddOnBehalfOf(req, authState);\n   return authState;\n }\n\ndiff --git a/packages/server/src/workers/batch.ts b/packages/server/src/workers/batch.ts\nindex b3b57f2dad..a6842410dc 100644\n--- a/packages/server/src/workers/batch.ts\n+++ b/packages/server/src/workers/batch.ts\n@@ -10,6 +10,7 @@ import {\n import { FhirRequest, FhirRouter } from '@medplum/fhir-router';\n import { AsyncJob, Bundle, Login, Project, ProjectMembership } from '@medplum/fhirtypes';\n import { Job, Queue, QueueBaseOptions, Worker } from 'bullmq';\n+import { getUserConfiguration } from '../auth/me';\n import { getAuthenticatedContext, tryRunInRequestContext } from '../context';\n import { getRepoForLogin } from '../fhir/accesspolicy';\n import { uploadBinaryData } from '../fhir/binary';\n@@ -102,7 +103,8 @@ export async function execBatchJob(job: Job<BatchJobData>): Promise<void> {\n   const logger = getLogger();\n \n   // Prepare the original submitting user's repo\n-  const repo = await getRepoForLogin({ login, project, membership });\n+  const userConfig = await getUserConfiguration(getSystemRepo(), project, membership);\n+  const repo = await getRepoForLogin({ login, project, membership, userConfig });\n   const router = new FhirRouter();\n   const req: FhirRequest = {\n     method: 'POST',\n",
    "test_patch": "diff --git a/packages/server/src/fhir/accesspolicy.test.ts b/packages/server/src/fhir/accesspolicy.test.ts\nindex 4913d59444..6c52d2a193 100644\n--- a/packages/server/src/fhir/accesspolicy.test.ts\n+++ b/packages/server/src/fhir/accesspolicy.test.ts\n@@ -26,6 +26,7 @@ import {\n   Subscription,\n   Task,\n   User,\n+  UserConfiguration,\n } from '@medplum/fhirtypes';\n import { randomUUID } from 'crypto';\n import { inviteUser } from '../admin/invite';\n@@ -813,6 +814,7 @@ describe('AccessPolicy', () => {\n           user: createReference(clientApplication),\n         },\n         project: testProject,\n+        userConfig: {} as UserConfiguration,\n       });\n \n       // Create a Patient using the ClientApplication\n@@ -923,6 +925,7 @@ describe('AccessPolicy', () => {\n           user: createReference(clientApplication),\n         },\n         project: testProject,\n+        userConfig: {} as UserConfiguration,\n       });\n \n       // Create a Patient using the ClientApplication\n@@ -1783,6 +1786,7 @@ describe('AccessPolicy', () => {\n         login: { resourceType: 'Login' } as Login,\n         membership,\n         project: testProject,\n+        userConfig: {} as UserConfiguration,\n       });\n \n       const check1 = await repo2.readResource<Patient>('Patient', p1.id);\n@@ -1834,6 +1838,7 @@ describe('AccessPolicy', () => {\n         login: { resourceType: 'Login' } as Login,\n         membership,\n         project: testProject,\n+        userConfig: {} as UserConfiguration,\n       });\n \n       const check1 = await repo2.readResource<Task>('Task', t1.id);\n@@ -1891,7 +1896,12 @@ describe('AccessPolicy', () => {\n         sendEmail: false,\n       });\n \n-      const repo2 = await getRepoForLogin({ login: { resourceType: 'Login' } as Login, membership, project });\n+      const repo2 = await getRepoForLogin({\n+        login: { resourceType: 'Login' } as Login,\n+        membership,\n+        project,\n+        userConfig: {} as UserConfiguration,\n+      });\n \n       // Read Patient - allowed by AccessPolicy\n       const check1 = await repo2.readResource<Patient>('Patient', patient.id);\n@@ -1937,7 +1947,10 @@ describe('AccessPolicy', () => {\n         admin: true,\n       });\n \n-      const repo2 = await getRepoForLogin({ login: { resourceType: 'Login' } as Login, membership, project }, true);\n+      const repo2 = await getRepoForLogin(\n+        { login: { resourceType: 'Login' } as Login, membership, project, userConfig: {} as UserConfiguration },\n+        true\n+      );\n \n       const check1 = await repo2.readResource<Project>('Project', project.id);\n       expect(check1.id).toStrictEqual(project.id);\n@@ -2013,7 +2026,7 @@ describe('AccessPolicy', () => {\n           resource: [{ resourceType: '*' }, { resourceType: 'Project' }, { resourceType: 'ProjectMembership' }],\n         },\n       });\n-      const repo = await getRepoForLogin({ login, project, membership }, true);\n+      const repo = await getRepoForLogin({ login, project, membership, userConfig: {} as UserConfiguration }, true);\n \n       const check1 = await repo.readResource<Project>('Project', project.id);\n       expect(check1.id).toStrictEqual(project.id);\n@@ -2090,11 +2103,21 @@ describe('AccessPolicy', () => {\n       });\n \n       const adminRepo = await getRepoForLogin(\n-        { login: { resourceType: 'Login' } as Login, membership: adminMembership, project },\n+        {\n+          login: { resourceType: 'Login' } as Login,\n+          membership: adminMembership,\n+          project,\n+          userConfig: {} as UserConfiguration,\n+        },\n         true\n       );\n       const nonAdminRepo = await getRepoForLogin(\n-        { login: { resourceType: 'Login' } as Login, membership: nonAdminMembership, project },\n+        {\n+          login: { resourceType: 'Login' } as Login,\n+          membership: nonAdminMembership,\n+          project,\n+          userConfig: {} as UserConfiguration,\n+        },\n         true\n       );\n       const account1 = 'Organization/' + randomUUID();\n@@ -2172,11 +2195,21 @@ describe('AccessPolicy', () => {\n       });\n \n       const adminRepo = await getRepoForLogin(\n-        { login: { resourceType: 'Login' } as Login, membership: adminMembership, project },\n+        {\n+          login: { resourceType: 'Login' } as Login,\n+          membership: adminMembership,\n+          project,\n+          userConfig: {} as UserConfiguration,\n+        },\n         true\n       );\n       const nonAdminRepo = await getRepoForLogin(\n-        { login: { resourceType: 'Login' } as Login, membership: nonAdminMembership, project },\n+        {\n+          login: { resourceType: 'Login' } as Login,\n+          membership: nonAdminMembership,\n+          project,\n+          userConfig: {} as UserConfiguration,\n+        },\n         true\n       );\n       const account1 = 'Organization/' + randomUUID();\n@@ -2278,6 +2311,7 @@ describe('AccessPolicy', () => {\n         login: { resourceType: 'Login' } as Login,\n         membership: miniAdminMembership,\n         project,\n+        userConfig: {} as UserConfiguration,\n       });\n \n       // Read Patient - explicitly allowed by AccessPolicy\n@@ -2471,7 +2505,10 @@ describe('AccessPolicy', () => {\n       });\n \n       // Get a repo for the user\n-      const repo = await getRepoForLogin({ login, membership: updatedMembership, project }, true);\n+      const repo = await getRepoForLogin(\n+        { login, membership: updatedMembership, project, userConfig: {} as UserConfiguration },\n+        true\n+      );\n \n       // Try to search for StructureDefinitions, should succeed\n       const bundle1 = await repo.search<StructureDefinition>({ resourceType: 'StructureDefinition' });\n@@ -2557,7 +2594,7 @@ describe('AccessPolicy', () => {\n         password: randomUUID(),\n       });\n       expect(project.link).toBeUndefined();\n-      const repo = await getRepoForLogin({ login, membership, project }, true);\n+      const repo = await getRepoForLogin({ login, membership, project, userConfig: {} as UserConfiguration }, true);\n \n       project.link = [{ project: { reference: 'Project/foo' } }, { project: { reference: 'Project/bar' } }];\n \n@@ -2609,7 +2646,10 @@ describe('AccessPolicy', () => {\n       });\n \n       // Repo for project admin\n-      const projAdminRepo = await getRepoForLogin({ login, membership, project }, true);\n+      const projAdminRepo = await getRepoForLogin(\n+        { login, membership, project, userConfig: {} as UserConfiguration },\n+        true\n+      );\n \n       // Repos for the test user\n \n\ndiff --git a/packages/server/src/fhir/references.test.ts b/packages/server/src/fhir/references.test.ts\nindex 4d9ddc7fcf..dcb4ba3eba 100644\n--- a/packages/server/src/fhir/references.test.ts\n+++ b/packages/server/src/fhir/references.test.ts\n@@ -1,5 +1,5 @@\n import { createReference, normalizeErrorString, WithId } from '@medplum/core';\n-import { Login, Patient, Project, ServiceRequest } from '@medplum/fhirtypes';\n+import { Login, Patient, Project, ServiceRequest, UserConfiguration } from '@medplum/fhirtypes';\n import { randomUUID } from 'crypto';\n import { initAppServices, shutdownApp } from '../app';\n import { registerNew } from '../auth/register';\n@@ -35,6 +35,7 @@ describe('Reference checks', () => {\n         login: {} as Login,\n         membership,\n         project,\n+        userConfig: {} as UserConfiguration,\n       };\n \n       const repo = await getRepoForLogin(authState, true);\n@@ -102,13 +103,23 @@ describe('Reference checks', () => {\n       project.checkReferencesOnWrite = true;\n       project.link = [{ project: createReference(project2) }];\n \n-      const repo2 = await getRepoForLogin({ login: {} as Login, membership: membership2, project: project2 });\n+      const repo2 = await getRepoForLogin({\n+        login: {} as Login,\n+        membership: membership2,\n+        project: project2,\n+        userConfig: {} as UserConfiguration,\n+      });\n       const patient2 = await repo2.createResource({\n         resourceType: 'Patient',\n       });\n \n       // Reference available into linked Project\n-      let repo = await getRepoForLogin({ login: {} as Login, membership, project });\n+      let repo = await getRepoForLogin({\n+        login: {} as Login,\n+        membership,\n+        project,\n+        userConfig: {} as UserConfiguration,\n+      });\n       const patient = await repo.createResource({\n         resourceType: 'Patient',\n         link: [{ type: 'seealso', other: createReference(patient2) }],\n@@ -121,6 +132,7 @@ describe('Reference checks', () => {\n         login: {} as Login,\n         membership,\n         project,\n+        userConfig: {} as UserConfiguration,\n       });\n       await expect(\n         repo.createResource({\n@@ -152,7 +164,12 @@ describe('Reference checks', () => {\n       const systemRepo = getSystemRepo();\n       await systemRepo.updateResource(project1);\n \n-      const repo = await getRepoForLogin({ login: { resourceType: 'Login' } as Login, membership, project: project1 });\n+      const repo = await getRepoForLogin({\n+        login: { resourceType: 'Login' } as Login,\n+        membership,\n+        project: project1,\n+        userConfig: {} as UserConfiguration,\n+      });\n       let project = await repo.readResource<Project>('Project', project1.id);\n \n       // Checking the name change is ancillary; mostly confirming that the update\n@@ -176,7 +193,12 @@ describe('Reference checks', () => {\n       const systemRepo = getSystemRepo();\n       project = await systemRepo.updateResource({ ...project, checkReferencesOnWrite: true });\n \n-      const repo = await getRepoForLogin({ login: { resourceType: 'Login' } as Login, membership, project });\n+      const repo = await getRepoForLogin({\n+        login: { resourceType: 'Login' } as Login,\n+        membership,\n+        project,\n+        userConfig: {} as UserConfiguration,\n+      });\n \n       // Checking the externalId change is ancillary; mostly confirming that the update\n       // doesn't throw due to reference validation failure\n\ndiff --git a/packages/server/src/fhir/repo.test.ts b/packages/server/src/fhir/repo.test.ts\nindex 9dd253e645..10579b1e3a 100644\n--- a/packages/server/src/fhir/repo.test.ts\n+++ b/packages/server/src/fhir/repo.test.ts\n@@ -30,6 +30,7 @@ import {\n   ServiceRequest,\n   StructureDefinition,\n   User,\n+  UserConfiguration,\n } from '@medplum/fhirtypes';\n import { randomBytes, randomUUID } from 'crypto';\n import { readFileSync } from 'fs';\n@@ -74,6 +75,7 @@ describe('FHIR Repo', () => {\n         login: { resourceType: 'Login' } as Login,\n         membership: { resourceType: 'ProjectMembership' } as WithId<ProjectMembership>,\n         project: testProject,\n+        userConfig: {} as UserConfiguration,\n       })\n     ).rejects.toThrow('Invalid author reference');\n   });\n@@ -530,7 +532,12 @@ describe('FHIR Repo', () => {\n       const result1 = await registerNew(registration1);\n       expect(result1.profile).toBeDefined();\n \n-      const repo1 = await getRepoForLogin(result1);\n+      const repo1 = await getRepoForLogin({\n+        project: result1.project,\n+        membership: result1.membership,\n+        login: result1.login,\n+        userConfig: {} as UserConfiguration,\n+      });\n       const patient1 = await repo1.createResource<Patient>({\n         resourceType: 'Patient',\n       });\n@@ -553,7 +560,12 @@ describe('FHIR Repo', () => {\n       const result2 = await registerNew(registration2);\n       expect(result2.profile).toBeDefined();\n \n-      const repo2 = await getRepoForLogin(result2);\n+      const repo2 = await getRepoForLogin({\n+        project: result2.project,\n+        membership: result2.membership,\n+        login: result2.login,\n+        userConfig: {} as UserConfiguration,\n+      });\n       try {\n         await repo2.readResource('Patient', patient1.id);\n         fail('Should have thrown');\n@@ -1256,7 +1268,12 @@ describe('FHIR Repo', () => {\n       });\n       project.link = [{ project: createReference(project2) }];\n \n-      const repo2 = await getRepoForLogin({ login: {} as Login, membership: membership2, project: project2 });\n+      const repo2 = await getRepoForLogin({\n+        login: {} as Login,\n+        membership: membership2,\n+        project: project2,\n+        userConfig: {} as UserConfiguration,\n+      });\n       const profileJson = JSON.parse(\n         readFileSync(resolve(__dirname, '__test__/us-core-patient.json'), 'utf8')\n       ) as StructureDefinition;\n@@ -1270,7 +1287,12 @@ describe('FHIR Repo', () => {\n       };\n \n       // Resource upload should fail with profile linked\n-      let repo = await getRepoForLogin({ login: {} as Login, membership, project });\n+      let repo = await getRepoForLogin({\n+        login: {} as Login,\n+        membership,\n+        project,\n+        userConfig: {} as UserConfiguration,\n+      });\n       await expect(repo.createResource(patientJson)).rejects.toThrow(/Missing required property/);\n \n       // Unlink Project and verify that profile is not cached; resource upload should succeed without access to profile\n@@ -1279,6 +1301,7 @@ describe('FHIR Repo', () => {\n         login: {} as Login,\n         membership,\n         project,\n+        userConfig: {} as UserConfiguration,\n       });\n       await expect(repo.createResource(patientJson)).resolves.toBeDefined();\n     }));\n@@ -1290,7 +1313,10 @@ describe('FHIR Repo', () => {\n         withAccessToken: true,\n         withClient: true,\n       });\n-      const extendedRepo = await getRepoForLogin({ login, project, membership }, true);\n+      const extendedRepo = await getRepoForLogin(\n+        { login, project, membership, userConfig: {} as UserConfiguration },\n+        true\n+      );\n \n       const patient = await repo.createResource<Patient>({ resourceType: 'Patient' });\n       expect(patient.meta?.project).toBeUndefined();\n\ndiff --git a/packages/server/src/fhirinteractionlimit.test.ts b/packages/server/src/fhirinteractionlimit.test.ts\nindex 726d187753..45a2d0ea60 100644\n--- a/packages/server/src/fhirinteractionlimit.test.ts\n+++ b/packages/server/src/fhirinteractionlimit.test.ts\n@@ -1,7 +1,9 @@\n-import { sleep } from '@medplum/core';\n-import { Bundle } from '@medplum/fhirtypes';\n+import { createReference, sleep } from '@medplum/core';\n+import { Bundle, ProjectMembership, UserConfiguration } from '@medplum/fhirtypes';\n import express, { Express } from 'express';\n+import { randomUUID } from 'node:crypto';\n import request from 'supertest';\n+import { inviteUser } from './admin/invite';\n import { initApp, shutdownApp } from './app';\n import { loadTestConfig } from './config/loader';\n import { MedplumServerConfig } from './config/types';\n@@ -28,11 +30,14 @@ describe('FHIR Rate Limits', () => {\n     expect(await shutdownApp()).toBeUndefined();\n   });\n \n-  test.skip('Blocks request that would exceed limit', async () => {\n-    config.defaultFhirInteractionLimit = 1;\n+  test('Blocks request that would exceed limit', async () => {\n+    config.defaultFhirQuota = 100;\n     await initApp(app, config);\n \n-    ({ accessToken } = await createTestProject({ withAccessToken: true }));\n+    ({ accessToken } = await createTestProject({\n+      withAccessToken: true,\n+      project: { systemSetting: [{ name: 'enableFhirQuota', valueBoolean: true }] },\n+    }));\n \n     const res = await request(app).get('/fhir/R4/Patient?_count=20').auth(accessToken, { type: 'bearer' }).send();\n     expect(res.status).toBe(200);\n@@ -43,11 +48,14 @@ describe('FHIR Rate Limits', () => {\n     expect(res2.get('ratelimit')).toStrictEqual('\"fhirInteractions\";r=0;t=60');\n   });\n \n-  test.skip('Blocks single too-expensive request', async () => {\n-    config.defaultFhirInteractionLimit = 1;\n+  test('Blocks single too-expensive request', async () => {\n+    config.defaultFhirQuota = 1;\n     await initApp(app, config);\n \n-    ({ accessToken } = await createTestProject({ withAccessToken: true }));\n+    ({ accessToken } = await createTestProject({\n+      withAccessToken: true,\n+      project: { systemSetting: [{ name: 'enableFhirQuota', valueBoolean: true }] },\n+    }));\n \n     const res = await request(app)\n       .post('/fhir/R4/Patient')\n@@ -57,10 +65,13 @@ describe('FHIR Rate Limits', () => {\n   });\n \n   test('Allows batch under limit', async () => {\n-    config.defaultFhirInteractionLimit = 1;\n+    config.defaultFhirQuota = 1;\n     await initApp(app, config);\n \n-    ({ accessToken } = await createTestProject({ withAccessToken: true }));\n+    ({ accessToken } = await createTestProject({\n+      withAccessToken: true,\n+      project: { systemSetting: [{ name: 'enableFhirQuota', valueBoolean: true }] },\n+    }));\n \n     const res = await request(app)\n       .post('/fhir/R4/')\n@@ -73,13 +84,13 @@ describe('FHIR Rate Limits', () => {\n     expect(res.status).toBe(200);\n   });\n \n-  test.skip('Blocks oversized transaction bundle', async () => {\n-    config.defaultFhirInteractionLimit = 1;\n+  test('Blocks oversized transaction bundle', async () => {\n+    config.defaultFhirQuota = 1;\n     await initApp(app, config);\n \n     ({ accessToken } = await createTestProject({\n       withAccessToken: true,\n-      project: { features: ['transaction-bundles'] },\n+      project: { features: ['transaction-bundles'], systemSetting: [{ name: 'enableFhirQuota', valueBoolean: true }] },\n     }));\n \n     const res = await request(app)\n@@ -94,7 +105,7 @@ describe('FHIR Rate Limits', () => {\n   });\n \n   test('Reports multiple, in-progress rate limits', async () => {\n-    config.defaultFhirInteractionLimit = 500;\n+    config.defaultFhirQuota = 500;\n     config.defaultRateLimit = 100;\n     await initApp(app, config);\n \n@@ -112,12 +123,17 @@ describe('FHIR Rate Limits', () => {\n   });\n \n   test('Respects Project setting override', async () => {\n-    config.defaultFhirInteractionLimit = 1;\n+    config.defaultFhirQuota = 1;\n     await initApp(app, config);\n \n     ({ accessToken } = await createTestProject({\n       withAccessToken: true,\n-      project: { systemSetting: [{ name: 'defaultFhirInteractionLimit', valueInteger: 10 }] },\n+      project: {\n+        systemSetting: [\n+          { name: 'userFhirQuota', valueInteger: 1000 },\n+          { name: 'enableFhirQuota', valueBoolean: true },\n+        ],\n+      },\n     }));\n \n     const res = await request(app)\n@@ -126,4 +142,80 @@ describe('FHIR Rate Limits', () => {\n       .send({ resourceType: 'Patient' });\n     expect(res.status).toBe(201);\n   });\n+\n+  test('Respects ProjectMembership setting override', async () => {\n+    config.defaultFhirQuota = 1;\n+    await initApp(app, config);\n+\n+    const { accessToken, repo, membership } = await createTestProject({\n+      withAccessToken: true,\n+      withRepo: true,\n+      withClient: true,\n+      project: { systemSetting: [{ name: 'enableFhirQuota', valueBoolean: true }] },\n+    });\n+\n+    const userConfig = await repo.createResource<UserConfiguration>({\n+      resourceType: 'UserConfiguration',\n+      option: [{ id: 'fhirQuota', valueInteger: 1000 }],\n+    });\n+    await repo.updateResource<ProjectMembership>({\n+      ...membership,\n+      userConfiguration: createReference(userConfig),\n+    });\n+\n+    const res = await request(app)\n+      .post('/fhir/R4/Patient')\n+      .auth(accessToken, { type: 'bearer' })\n+      .send({ resourceType: 'Patient' });\n+    expect(res.status).toBe(201);\n+  });\n+\n+  test('Respects Project level limit', async () => {\n+    config.defaultFhirQuota = 100;\n+    await initApp(app, config);\n+\n+    const { accessToken, project } = await createTestProject({\n+      withAccessToken: true,\n+      project: {\n+        systemSetting: [\n+          { name: 'enableFhirQuota', valueBoolean: true },\n+          { name: 'totalFhirQuota', valueInteger: 100 },\n+        ],\n+      },\n+    });\n+\n+    const email = `${randomUUID()}@example.com`;\n+    const password = randomUUID();\n+    await inviteUser({ project, resourceType: 'Practitioner', firstName: 'A.', lastName: 'Zee', email, password });\n+\n+    const loginRes = await request(app).post('/auth/login').type('json').send({\n+      email,\n+      password,\n+      scope: 'openid offline',\n+      codeChallenge: 'xyz',\n+      codeChallengeMethod: 'plain',\n+    });\n+    expect(loginRes.status).toBe(200);\n+\n+    const tokenRes = await request(app).post('/oauth2/token').type('form').send({\n+      grant_type: 'authorization_code',\n+      code: loginRes.body.code,\n+      code_verifier: 'xyz',\n+    });\n+    expect(tokenRes.status).toBe(200);\n+    expect(tokenRes.body.access_token).toBeDefined();\n+    const otherToken = tokenRes.body.access_token;\n+\n+    const res = await request(app)\n+      .post('/fhir/R4/Patient')\n+      .auth(accessToken, { type: 'bearer' })\n+      .send({ resourceType: 'Patient' });\n+    expect(res.status).toBe(201);\n+\n+    const res2 = await request(app)\n+      .post('/fhir/R4/Patient')\n+      .auth(otherToken, { type: 'bearer' })\n+      .send({ resourceType: 'Patient' });\n+    expect(res2.status).toBe(429);\n+  });\n });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6531",
    "pr_id": 6531,
    "issue_id": 6529,
    "repo": "medplum/medplum",
    "problem_statement": "New config to enable systemRepo to read from new token implementation\n",
    "issue_word_count": 11,
    "test_files_count": 1,
    "non_test_files_count": 2,
    "pr_changed_files": [
      "packages/server/src/config/types.ts",
      "packages/server/src/fhir/search.test.ts",
      "packages/server/src/fhir/search.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/search.test.ts"
    ],
    "base_commit": "0787a061f9fcc54a5fa5100580963c7d4d9f60b0",
    "head_commit": "433abb8fe910587850d8f366c2a0428e323b90e2",
    "repo_url": "https://github.com/medplum/medplum/pull/6531",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6531",
    "dockerfile": "",
    "pr_merged_at": "2025-05-02T19:24:39.000Z",
    "patch": "diff --git a/packages/server/src/config/types.ts b/packages/server/src/config/types.ts\nindex e105103871..18c93be1fb 100644\n--- a/packages/server/src/config/types.ts\n+++ b/packages/server/src/config/types.ts\n@@ -74,6 +74,9 @@ export interface MedplumServerConfig {\n   /** Max length of Bot AuditEvent.outcomeDesc when logging to logger */\n   maxBotLogLengthForLogs?: number;\n \n+  /** Search strategy system repositories use when using token search parameters. */\n+  systemRepositoryTokenReadStrategy?: 'unified-tokens-column' | 'token-tables';\n+\n   /** @deprecated */\n   auditEventLogGroup?: string;\n \n\ndiff --git a/packages/server/src/fhir/search.ts b/packages/server/src/fhir/search.ts\nindex f748495c49..81066cb8e1 100644\n--- a/packages/server/src/fhir/search.ts\n+++ b/packages/server/src/fhir/search.ts\n@@ -1768,6 +1768,23 @@ function getCanonicalUrl(resource: Resource): string | undefined {\n export function readFromTokenColumns(repo: Repository): boolean {\n   const project = repo.currentProject();\n   const maybeSystemSettingBoolean = project?.systemSetting?.find((s) => s.name === 'searchTokenColumns')?.valueBoolean;\n-  // If the Project.systemSetting exists, return its value. Otherwise, fallback to global setting\n-  return maybeSystemSettingBoolean ?? TokenColumnsFeature.read;\n+\n+  // If the Project.systemSetting exists, return its value\n+  if (maybeSystemSettingBoolean !== undefined) {\n+    return maybeSystemSettingBoolean;\n+  }\n+\n+  // If the project is undefined, it is a system repository\n+  if (project === undefined) {\n+    const systemRepositoryTokenReadStrategy = getConfig().systemRepositoryTokenReadStrategy;\n+    // If specified, translate the config value to a boolean\n+    if (systemRepositoryTokenReadStrategy === 'unified-tokens-column') {\n+      return true;\n+    } else if (systemRepositoryTokenReadStrategy === 'token-tables') {\n+      return false;\n+    }\n+  }\n+\n+  // fallback to the global default\n+  return TokenColumnsFeature.read;\n }\n",
    "test_patch": "diff --git a/packages/server/src/fhir/search.test.ts b/packages/server/src/fhir/search.test.ts\nindex 77d0cf913c..69c2d6cfae 100644\n--- a/packages/server/src/fhir/search.test.ts\n+++ b/packages/server/src/fhir/search.test.ts\n@@ -51,7 +51,7 @@ import {\n } from '@medplum/fhirtypes';\n import { randomUUID } from 'crypto';\n import { initAppServices, shutdownApp } from '../app';\n-import { loadTestConfig } from '../config/loader';\n+import { getConfig, loadTestConfig } from '../config/loader';\n import { MedplumServerConfig } from '../config/types';\n import { DatabaseMode } from '../database';\n import { bundleContains, createTestProject, withTestContext } from '../test.setup';\n@@ -4787,6 +4787,8 @@ describe.each<'token columns' | 'lookup table'>(['token columns', 'lookup table'\n       });\n \n       test('readFromTokenColumns', () => {\n+        expect(getConfig().systemRepositoryTokenReadStrategy).toBeUndefined();\n+\n         if (tokenColumnsOrLookupTable === 'token columns') {\n           expect(readFromTokenColumns(systemRepo)).toBe(true);\n         } else {\n@@ -4794,6 +4796,19 @@ describe.each<'token columns' | 'lookup table'>(['token columns', 'lookup table'\n         }\n       });\n \n+      test('readFromTokenColumns with systemRepositoryTokenReadStrategy', () => {\n+        const config = getConfig();\n+        const originalValue = config.systemRepositoryTokenReadStrategy;\n+\n+        config.systemRepositoryTokenReadStrategy = 'unified-tokens-column';\n+        expect(readFromTokenColumns(systemRepo)).toBe(true);\n+\n+        config.systemRepositoryTokenReadStrategy = 'token-tables';\n+        expect(readFromTokenColumns(systemRepo)).toBe(false);\n+\n+        config.systemRepositoryTokenReadStrategy = originalValue;\n+      });\n+\n       test('Filter by _project', () =>\n         withTestContext(async () => {\n           const idValue = randomUUID();\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6511",
    "pr_id": 6511,
    "issue_id": 6246,
    "repo": "medplum/medplum",
    "problem_statement": "Flaky test\n![Image](https://github.com/user-attachments/assets/94385058-898d-414f-bdd0-54257356b1f6)\n\nhttps://github.com/medplum/medplum/actions/runs/14095966504/job/39483340728?pr=6245",
    "issue_word_count": 26,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/server/src/subscriptions/websockets.test.ts",
      "packages/server/src/subscriptions/websockets.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/subscriptions/websockets.test.ts"
    ],
    "base_commit": "3962fe4af8f4f7682227ac9f67c5578600f45589",
    "head_commit": "3023c22887477eec0b1452de3d1bbe1daec2cfea",
    "repo_url": "https://github.com/medplum/medplum/pull/6511",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6511",
    "dockerfile": "",
    "pr_merged_at": "2025-04-30T21:19:41.000Z",
    "patch": "diff --git a/packages/server/src/subscriptions/websockets.ts b/packages/server/src/subscriptions/websockets.ts\nindex ad8c471035..6e59c0c52e 100644\n--- a/packages/server/src/subscriptions/websockets.ts\n+++ b/packages/server/src/subscriptions/websockets.ts\n@@ -389,6 +389,12 @@ export async function markInMemorySubscriptionsInactive(\n   for (const subscriptionId of subscriptionIds) {\n     refStrs.push(`Subscription/${subscriptionId}`);\n   }\n-  const redis = getRedis();\n-  await redis.multi().srem(`medplum:subscriptions:r4:project:${projectId}:active`, refStrs).del(refStrs).exec();\n+  let redis: Redis | undefined;\n+  try {\n+    redis = getRedis();\n+  } catch {\n+    redis = undefined;\n+    globalLogger.debug('Attempted to mark subscriptions as inactive when Redis is closed');\n+  }\n+  await redis?.multi().srem(`medplum:subscriptions:r4:project:${projectId}:active`, refStrs).del(refStrs).exec();\n }\n",
    "test_patch": "diff --git a/packages/server/src/subscriptions/websockets.test.ts b/packages/server/src/subscriptions/websockets.test.ts\nindex 55975fd252..e45436e496 100644\n--- a/packages/server/src/subscriptions/websockets.test.ts\n+++ b/packages/server/src/subscriptions/websockets.test.ts\n@@ -691,9 +691,22 @@ describe('WebSocket Subscription', () => {\n           await sleep(0);\n         });\n \n-      expect(globalLoggerErrorSpy).toHaveBeenCalledWith('[WS] Error occurred while rewriting attachments', {\n-        err: expect.any(Error),\n-      });\n+      const startTime = Date.now();\n+      let success = false;\n+\n+      while (Date.now() - startTime < 5000 && !success) {\n+        try {\n+          expect(globalLoggerErrorSpy).toHaveBeenCalledWith('[WS] Error occurred while rewriting attachments', {\n+            err: expect.any(Error),\n+          });\n+          success = true;\n+        } catch (err) {\n+          await sleep(100);\n+          if (Date.now() - startTime >= 5000) {\n+            throw err;\n+          }\n+        }\n+      }\n \n       // Restore original implementations\n       rewriteAttachmentsSpy.mockRestore();\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6503",
    "pr_id": 6503,
    "issue_id": 6384,
    "repo": "medplum/medplum",
    "problem_statement": "Handle FhirPathError inside QuestionnaireForm\nCatch FhirPathError errors that may occur while evaluating an expression in QuestionnaireForm. \n\n\n![Image](https://github.com/user-attachments/assets/9543794e-10d6-478d-bdb4-6a4dc6c4a5ae)\n\n",
    "issue_word_count": 28,
    "test_files_count": 2,
    "non_test_files_count": 2,
    "pr_changed_files": [
      "packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx",
      "packages/react/src/QuestionnaireForm/QuestionnaireFormItem/QuestionnaireFormItem.tsx",
      "packages/react/src/utils/questionnaire.test.ts",
      "packages/react/src/utils/questionnaire.ts"
    ],
    "pr_changed_test_files": [
      "packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx",
      "packages/react/src/utils/questionnaire.test.ts"
    ],
    "base_commit": "4ad9e782a1e6d5d9ba78437a9de773039122ed03",
    "head_commit": "b1ef867180c286c821ad3fb6f72b3650c82179a9",
    "repo_url": "https://github.com/medplum/medplum/pull/6503",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6503",
    "dockerfile": "",
    "pr_merged_at": "2025-05-04T17:37:22.000Z",
    "patch": "diff --git a/packages/react/src/QuestionnaireForm/QuestionnaireFormItem/QuestionnaireFormItem.tsx b/packages/react/src/QuestionnaireForm/QuestionnaireFormItem/QuestionnaireFormItem.tsx\nindex 48e1eb4138..2c26a33801 100644\n--- a/packages/react/src/QuestionnaireForm/QuestionnaireFormItem/QuestionnaireFormItem.tsx\n+++ b/packages/react/src/QuestionnaireForm/QuestionnaireFormItem/QuestionnaireFormItem.tsx\n@@ -1,9 +1,20 @@\n-import { Checkbox, ComboboxItem, Group, MultiSelect, NativeSelect, Radio, Textarea, TextInput } from '@mantine/core';\n+import {\n+  Checkbox,\n+  ComboboxItem,\n+  Group,\n+  MultiSelect,\n+  NativeSelect,\n+  Radio,\n+  Text,\n+  Textarea,\n+  TextInput,\n+} from '@mantine/core';\n import {\n   capitalize,\n   deepEquals,\n   formatCoding,\n   getElementDefinition,\n+  getExtension,\n   HTTP_HL7_ORG,\n   stringify,\n   TypedValue,\n@@ -84,12 +95,19 @@ export function QuestionnaireFormItem(props: QuestionnaireFormItemProps): JSX.El\n \n   const initial = item.initial && item.initial.length > 0 ? item.initial[0] : undefined;\n   const defaultValue = getCurrentAnswer(response, props.index) ?? getItemInitialValue(initial);\n+  const validationError = getExtension(\n+    response,\n+    `${HTTP_HL7_ORG}/fhir/StructureDefinition/questionnaire-validationError`\n+  );\n+\n+  let formComponent: JSX.Element | null = null;\n \n   switch (type) {\n     case QuestionnaireItemType.display:\n-      return <p key={props.item.linkId}>{props.item.text}</p>;\n+      formComponent = <p key={props.item.linkId}>{props.item.text}</p>;\n+      break;\n     case QuestionnaireItemType.boolean:\n-      return (\n+      formComponent = (\n         <CheckboxFormSection key={props.item.linkId} title={props.item.text} htmlFor={props.item.linkId}>\n           <Checkbox\n             id={props.item.linkId}\n@@ -99,8 +117,9 @@ export function QuestionnaireFormItem(props: QuestionnaireFormItemProps): JSX.El\n           />\n         </CheckboxFormSection>\n       );\n+      break;\n     case QuestionnaireItemType.decimal:\n-      return (\n+      formComponent = (\n         <TextInput\n           type=\"number\"\n           step=\"any\"\n@@ -108,11 +127,14 @@ export function QuestionnaireFormItem(props: QuestionnaireFormItemProps): JSX.El\n           name={name}\n           required={props.required ?? item.required}\n           defaultValue={defaultValue?.value}\n-          onChange={(e) => onChangeAnswer({ valueDecimal: e.currentTarget.valueAsNumber })}\n+          onChange={(e) =>\n+            onChangeAnswer({ valueDecimal: e.currentTarget.value === '' ? undefined : e.currentTarget.valueAsNumber })\n+          }\n         />\n       );\n+      break;\n     case QuestionnaireItemType.integer:\n-      return (\n+      formComponent = (\n         <TextInput\n           type=\"number\"\n           step={1}\n@@ -120,11 +142,14 @@ export function QuestionnaireFormItem(props: QuestionnaireFormItemProps): JSX.El\n           name={name}\n           required={props.required ?? item.required}\n           defaultValue={defaultValue?.value}\n-          onChange={(e) => onChangeAnswer({ valueInteger: e.currentTarget.valueAsNumber })}\n+          onChange={(e) =>\n+            onChangeAnswer({ valueInteger: e.currentTarget.value === '' ? undefined : e.currentTarget.valueAsNumber })\n+          }\n         />\n       );\n+      break;\n     case QuestionnaireItemType.date:\n-      return (\n+      formComponent = (\n         <TextInput\n           type=\"date\"\n           id={name}\n@@ -134,8 +159,9 @@ export function QuestionnaireFormItem(props: QuestionnaireFormItemProps): JSX.El\n           onChange={(e) => onChangeAnswer({ valueDate: e.currentTarget.value })}\n         />\n       );\n+      break;\n     case QuestionnaireItemType.dateTime:\n-      return (\n+      formComponent = (\n         <DateTimeInput\n           name={name}\n           required={props.required ?? item.required}\n@@ -143,8 +169,9 @@ export function QuestionnaireFormItem(props: QuestionnaireFormItemProps): JSX.El\n           onChange={(newValue: string) => onChangeAnswer({ valueDateTime: newValue })}\n         />\n       );\n+      break;\n     case QuestionnaireItemType.time:\n-      return (\n+      formComponent = (\n         <TextInput\n           type=\"time\"\n           id={name}\n@@ -154,9 +181,10 @@ export function QuestionnaireFormItem(props: QuestionnaireFormItemProps): JSX.El\n           onChange={(e) => onChangeAnswer({ valueTime: e.currentTarget.value })}\n         />\n       );\n+      break;\n     case QuestionnaireItemType.string:\n     case QuestionnaireItemType.url:\n-      return (\n+      formComponent = (\n         <TextInput\n           id={name}\n           name={name}\n@@ -168,8 +196,9 @@ export function QuestionnaireFormItem(props: QuestionnaireFormItemProps): JSX.El\n           }}\n         />\n       );\n+      break;\n     case QuestionnaireItemType.text:\n-      return (\n+      formComponent = (\n         <Textarea\n           id={name}\n           name={name}\n@@ -181,8 +210,9 @@ export function QuestionnaireFormItem(props: QuestionnaireFormItemProps): JSX.El\n           }}\n         />\n       );\n+      break;\n     case QuestionnaireItemType.attachment:\n-      return (\n+      formComponent = (\n         <Group py={4}>\n           <AttachmentInput\n             path=\"\"\n@@ -192,8 +222,9 @@ export function QuestionnaireFormItem(props: QuestionnaireFormItemProps): JSX.El\n           />\n         </Group>\n       );\n+      break;\n     case QuestionnaireItemType.reference:\n-      return (\n+      formComponent = (\n         <ReferenceInput\n           name={name}\n           required={props.required ?? item.required}\n@@ -203,8 +234,9 @@ export function QuestionnaireFormItem(props: QuestionnaireFormItemProps): JSX.El\n           onChange={(newValue) => onChangeAnswer({ valueReference: newValue })}\n         />\n       );\n+      break;\n     case QuestionnaireItemType.quantity:\n-      return (\n+      formComponent = (\n         <QuantityInput\n           path=\"\"\n           name={name}\n@@ -214,10 +246,11 @@ export function QuestionnaireFormItem(props: QuestionnaireFormItemProps): JSX.El\n           disableWheel\n         />\n       );\n+      break;\n     case QuestionnaireItemType.choice:\n     case QuestionnaireItemType.openChoice:\n       if (isDropDownChoice(item) && !item.answerValueSet) {\n-        return (\n+        formComponent = (\n           <QuestionnaireChoiceDropDownInput\n             name={name}\n             item={item}\n@@ -227,7 +260,7 @@ export function QuestionnaireFormItem(props: QuestionnaireFormItemProps): JSX.El\n           />\n         );\n       } else if (isMultiSelectChoice(item) && !item.answerValueSet) {\n-        return (\n+        formComponent = (\n           <QuestionnaireMultiSelectInput\n             name={name}\n             item={item}\n@@ -237,7 +270,7 @@ export function QuestionnaireFormItem(props: QuestionnaireFormItemProps): JSX.El\n           />\n         );\n       } else {\n-        return (\n+        formComponent = (\n           <QuestionnaireChoiceSetInput\n             name={name}\n             item={item}\n@@ -247,9 +280,21 @@ export function QuestionnaireFormItem(props: QuestionnaireFormItemProps): JSX.El\n           />\n         );\n       }\n+      break;\n     default:\n       return null;\n   }\n+\n+  return (\n+    <>\n+      {formComponent}\n+      {validationError?.valueString && (\n+        <Text c=\"red\" size=\"lg\" mt={4}>\n+          {validationError.valueString}\n+        </Text>\n+      )}\n+    </>\n+  );\n }\n \n interface QuestionnaireChoiceInputProps {\n\ndiff --git a/packages/react/src/utils/questionnaire.ts b/packages/react/src/utils/questionnaire.ts\nindex e05e7ec70e..9f5dab3cff 100644\n--- a/packages/react/src/utils/questionnaire.ts\n+++ b/packages/react/src/utils/questionnaire.ts\n@@ -7,6 +7,7 @@ import {\n   getExtension,\n   getReferenceString,\n   getTypedPropertyValueWithoutSchema,\n+  normalizeErrorString,\n   splitN,\n   toJsBoolean,\n   toTypedValue,\n@@ -108,23 +109,35 @@ export function evaluateCalculatedExpressionsInQuestionnaire(\n           item: evaluateCalculatedExpressionsInQuestionnaire(item.item, response),\n         };\n       } else {\n-        const calculatedValue = evaluateCalculatedExpression(item, response);\n-        if (!calculatedValue) {\n-          return null;\n+        try {\n+          const calculatedValue = evaluateCalculatedExpression(item, response);\n+          if (!calculatedValue) {\n+            return null;\n+          }\n+          const answer = typedValueToResponseItem(item, calculatedValue);\n+          if (!answer) {\n+            return null;\n+          }\n+          return {\n+            id: item?.id,\n+            linkId: item?.linkId,\n+            text: item.text,\n+            answer: [answer],\n+          };\n+        } catch (error) {\n+          return {\n+            id: item?.id,\n+            linkId: item?.linkId,\n+            text: item.text,\n+            answer: [],\n+            extension: [\n+              {\n+                url: `${HTTP_HL7_ORG}/fhir/StructureDefinition/questionnaire-validationError`,\n+                valueString: `Expression evaluation failed: ${normalizeErrorString(error)}`,\n+              },\n+            ],\n+          };\n         }\n-\n-        const answer = typedValueToResponseItem(item, calculatedValue);\n-\n-        if (!answer) {\n-          return null;\n-        }\n-\n-        return {\n-          id: item?.id,\n-          linkId: item?.linkId,\n-          text: item.text,\n-          answer: [answer],\n-        };\n       }\n     })\n     .filter((item): item is QuestionnaireResponseItem => item !== null);\n@@ -206,6 +219,7 @@ export function mergeUpdatedItems(\n         ...mergedItem,\n         item: updatedItem.item ? mergeUpdatedItems(mergedItem.item || [], updatedItem.item) : mergedItem.item,\n         answer: updatedItem.answer || mergedItem.answer,\n+        extension: updatedItem.extension || mergedItem.extension,\n       };\n     }\n     return mergedItem;\n",
    "test_patch": "diff --git a/packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx b/packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx\nindex c7b81731a9..0bdffd5e4e 100644\n--- a/packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx\n+++ b/packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx\n@@ -2010,6 +2010,51 @@ describe('QuestionnaireForm', () => {\n     expect(answers3['q2']).toMatchObject({ valueBoolean: false });\n   });\n \n+  test('Questionnaire CalculatedExpression failed to evaluate expression', async () => {\n+    const onSubmit = jest.fn();\n+\n+    await setup({\n+      questionnaire: {\n+        resourceType: 'Questionnaire',\n+        status: 'active',\n+        id: 'temperature-threshold',\n+        title: 'Temperature Threshold Check',\n+        item: [\n+          {\n+            id: 'id-1',\n+            linkId: 'q1',\n+            type: 'string',\n+            text: 'Fahrenheit',\n+          },\n+          {\n+            id: 'id-2',\n+            linkId: 'q2',\n+            type: 'boolean',\n+            text: 'Is temperature over 120?',\n+            extension: [\n+              {\n+                url: 'http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression',\n+                valueExpression: {\n+                  language: 'text/fhirpath',\n+                  expression: '%fail',\n+                },\n+              },\n+            ],\n+          },\n+        ],\n+      },\n+      onSubmit,\n+    });\n+\n+    await act(async () => {\n+      fireEvent.change(screen.getByLabelText('Fahrenheit'), { target: { value: '125' } });\n+    });\n+\n+    expect(\n+      screen.getByText('Expression evaluation failed: FhirPathError on \"%fail\": Error: Undefined variable %fail')\n+    ).toBeInTheDocument();\n+  });\n+\n   test('Questionnaire CalculatedExpression with nested groups', async () => {\n     const onSubmit = jest.fn();\n \n\ndiff --git a/packages/react/src/utils/questionnaire.test.ts b/packages/react/src/utils/questionnaire.test.ts\nindex 531b3e7056..da794fc7b6 100644\n--- a/packages/react/src/utils/questionnaire.test.ts\n+++ b/packages/react/src/utils/questionnaire.test.ts\n@@ -1501,5 +1501,42 @@ describe('isQuestionEnabled', () => {\n         },\n       ]);\n     });\n+\n+    test('Failed to evaluate expression', () => {\n+      const items: QuestionnaireItem[] = [\n+        {\n+          id: 'q5',\n+          linkId: 'q5',\n+          type: 'string',\n+          text: 'Full Name',\n+          extension: [\n+            {\n+              url: 'http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression',\n+              valueExpression: {\n+                expression: '%fail',\n+                language: 'text/fhirpath',\n+              },\n+            },\n+          ],\n+        },\n+      ];\n+\n+      const response: QuestionnaireResponse = { resourceType: 'QuestionnaireResponse', status: 'in-progress' };\n+      const result = evaluateCalculatedExpressionsInQuestionnaire(items, response);\n+      expect(result).toEqual([\n+        {\n+          id: 'q5',\n+          linkId: 'q5',\n+          text: 'Full Name',\n+          answer: [],\n+          extension: [\n+            {\n+              url: 'http://hl7.org/fhir/StructureDefinition/questionnaire-validationError',\n+              valueString: 'Expression evaluation failed: FhirPathError on \"%fail\": Error: Undefined variable %fail',\n+            },\n+          ],\n+        },\n+      ]);\n+    });\n   });\n });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6483",
    "pr_id": 6483,
    "issue_id": 6335,
    "repo": "medplum/medplum",
    "problem_statement": "Unauthenticated bots for webhooks\nCan be restricted to HTTP requests with HMAC signatures\n\nSome examples that we want to support:\n* https://cal.com/docs/developing/guides/automation/webhooks\n* https://consensus.stoplight.io/docs/fax-services/1c4979f1d8ca0-fax-inbound-notification\n\nSome considerations:\n* For authenticated requests, you can use `/fhir/R4/Bot/{id}/$execute`, because the project is implicit in the access token\n* For unauthenticated requests, that will not work, because bots can live in multiple projects via project linking\n* So, we need another URL element to choose the project\n    * This could be something simple such as a `_project` query param\n    * Or it could be a totally new path `/webhook/{ProjectMembership.id}`",
    "issue_word_count": 110,
    "test_files_count": 1,
    "non_test_files_count": 7,
    "pr_changed_files": [
      "packages/core/src/client.ts",
      "packages/server/src/app.ts",
      "packages/server/src/cloud/aws/deploy.ts",
      "packages/server/src/cloud/aws/execute.ts",
      "packages/server/src/fhir/operations/execute.ts",
      "packages/server/src/webhook/README.md",
      "packages/server/src/webhook/routes.test.ts",
      "packages/server/src/webhook/routes.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/webhook/routes.test.ts"
    ],
    "base_commit": "816b0ea8e3b7c9521be93d651162e996758b39c3",
    "head_commit": "90d13aee6a156d3c072bbc4a832bd08648d0769e",
    "repo_url": "https://github.com/medplum/medplum/pull/6483",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6483",
    "dockerfile": "",
    "pr_merged_at": "2025-04-29T00:53:32.000Z",
    "patch": "diff --git a/packages/core/src/client.ts b/packages/core/src/client.ts\nindex 0b689aed72..456cfc0e70 100644\n--- a/packages/core/src/client.ts\n+++ b/packages/core/src/client.ts\n@@ -490,6 +490,8 @@ export interface BotEvent<T = Resource | Hl7Message | string | Record<string, an\n   readonly input: T;\n   readonly secrets: Record<string, ProjectSetting>;\n   readonly traceId?: string;\n+  /** Headers from the original request, when invoked by HTTP request */\n+  readonly headers?: Record<string, string | string[] | undefined>;\n }\n \n export interface InviteRequest {\n\ndiff --git a/packages/server/src/app.ts b/packages/server/src/app.ts\nindex adc0eb67b5..c3c86d7385 100644\n--- a/packages/server/src/app.ts\n+++ b/packages/server/src/app.ts\n@@ -40,6 +40,7 @@ import { scimRouter } from './scim/routes';\n import { seedDatabase } from './seed';\n import { initBinaryStorage } from './storage/loader';\n import { storageRouter } from './storage/routes';\n+import { webhookRouter } from './webhook/routes';\n import { closeWebSockets, initWebSockets } from './websockets';\n import { wellKnownRouter } from './wellknown';\n import { closeWorkers, initWorkers } from './workers';\n@@ -195,6 +196,7 @@ export async function initApp(app: Express, config: MedplumServerConfig): Promis\n   apiRouter.use('/oauth2/', oauthRouter);\n   apiRouter.use('/scim/v2/', scimRouter);\n   apiRouter.use('/storage/', storageRouter);\n+  apiRouter.use('/webhook/', webhookRouter);\n \n   app.use('/api/', apiRouter);\n   app.use('/', apiRouter);\n\ndiff --git a/packages/server/src/cloud/aws/deploy.ts b/packages/server/src/cloud/aws/deploy.ts\nindex 29620a15bb..0d63a2497d 100644\n--- a/packages/server/src/cloud/aws/deploy.ts\n+++ b/packages/server/src/cloud/aws/deploy.ts\n@@ -30,7 +30,7 @@ const PdfPrinter = require(\"pdfmake\");\n const userCode = require(\"./user.js\");\n \n exports.handler = async (event, context) => {\n-  const { bot, baseUrl, accessToken, contentType, secrets, traceId } = event;\n+  const { bot, baseUrl, accessToken, contentType, secrets, traceId, headers } = event;\n   const medplum = new MedplumClient({\n     baseUrl,\n     fetch: function(url, options = {}) {\n@@ -47,7 +47,7 @@ exports.handler = async (event, context) => {\n     if (contentType === ContentType.HL7_V2 && input) {\n       input = Hl7Message.parse(input);\n     }\n-    let result = await userCode.handler(medplum, { bot, input, contentType, secrets, traceId });\n+    let result = await userCode.handler(medplum, { bot, input, contentType, secrets, traceId, headers });\n     if (contentType === ContentType.HL7_V2 && result) {\n       result = result.toString();\n     }\n\ndiff --git a/packages/server/src/cloud/aws/execute.ts b/packages/server/src/cloud/aws/execute.ts\nindex 02f13a1c99..c749c8faaa 100644\n--- a/packages/server/src/cloud/aws/execute.ts\n+++ b/packages/server/src/cloud/aws/execute.ts\n@@ -11,7 +11,7 @@ import { BotExecutionContext, BotExecutionResult } from '../../fhir/operations/e\n  * @returns The bot execution result.\n  */\n export async function runInLambda(request: BotExecutionContext): Promise<BotExecutionResult> {\n-  const { bot, accessToken, secrets, input, contentType, traceId } = request;\n+  const { bot, accessToken, secrets, input, contentType, traceId, headers } = request;\n   const config = getConfig();\n   const client = new LambdaClient({ region: config.awsRegion });\n   const name = getLambdaFunctionName(bot);\n@@ -23,6 +23,7 @@ export async function runInLambda(request: BotExecutionContext): Promise<BotExec\n     contentType,\n     secrets,\n     traceId,\n+    headers,\n   };\n \n   // Build the command\n\ndiff --git a/packages/server/src/fhir/operations/execute.ts b/packages/server/src/fhir/operations/execute.ts\nindex 03d048a93b..7ee924b414 100644\n--- a/packages/server/src/fhir/operations/execute.ts\n+++ b/packages/server/src/fhir/operations/execute.ts\n@@ -67,6 +67,9 @@ export interface BotExecutionRequest {\n   readonly forwardedFor?: string;\n   readonly requestTime?: string;\n   readonly traceId?: string;\n+  /** Headers from the original request, when invoked by HTTP request */\n+  readonly headers?: Record<string, string | string[] | undefined>;\n+  /** Default headers to add to MedplumClient, such as HTTP cookies */\n   readonly defaultHeaders?: Record<string, string>;\n }\n \n@@ -153,6 +156,7 @@ async function executeOperation(req: Request): Promise<OperationOutcome | BotExe\n     runAs,\n     input: req.method === 'POST' ? req.body : req.query,\n     contentType: req.header('content-type') as string,\n+    headers: req.headers,\n     defaultHeaders,\n   });\n \n@@ -365,7 +369,7 @@ async function writeBotInputToStorage(request: BotExecutionRequest): Promise<voi\n  * @returns The bot execution result.\n  */\n async function runInVmContext(request: BotExecutionContext): Promise<BotExecutionResult> {\n-  const { bot, input, contentType, traceId } = request;\n+  const { bot, input, contentType, traceId, headers } = request;\n \n   const config = getConfig();\n   if (!config.vmContextBotsEnabled) {\n@@ -404,6 +408,7 @@ async function runInVmContext(request: BotExecutionContext): Promise<BotExecutio\n       contentType,\n       secrets: request.secrets,\n       traceId,\n+      headers,\n       defaultHeaders: request.defaultHeaders,\n     },\n   };\n@@ -422,7 +427,7 @@ async function runInVmContext(request: BotExecutionContext): Promise<BotExecutio\n   // End user code\n \n   (async () => {\n-    const { bot, baseUrl, accessToken, contentType, secrets, traceId, defaultHeaders } = event;\n+    const { bot, baseUrl, accessToken, contentType, secrets, traceId, headers, defaultHeaders } = event;\n     const medplum = new MedplumClient({\n       baseUrl,\n       defaultHeaders,\n@@ -439,7 +444,7 @@ async function runInVmContext(request: BotExecutionContext): Promise<BotExecutio\n       if (contentType === ContentType.HL7_V2 && input) {\n         input = Hl7Message.parse(input);\n       }\n-      let result = await exports.handler(medplum, { bot, input, contentType, secrets, traceId });\n+      let result = await exports.handler(medplum, { bot, input, contentType, secrets, traceId, headers });\n       if (contentType === ContentType.HL7_V2 && result) {\n         result = result.toString();\n       }\n\ndiff --git a/packages/server/src/webhook/README.md b/packages/server/src/webhook/README.md\nnew file mode 100644\nindex 0000000000..a24ee12460\n--- /dev/null\n+++ b/packages/server/src/webhook/README.md\n@@ -0,0 +1,42 @@\n+## Webhook API\n+\n+Medplum supports unauthenticated webhooks for integrating with third-party services like Cal.com, eFax, Twilio, and SendGrid.\n+\n+### Endpoint\n+\n+```\n+GET/POST /webhook/{ProjectMembership.id}\n+```\n+\n+Where `{ProjectMembership.id}` is the ID of a ProjectMembership resource that references a Bot.\n+\n+### Requirements\n+\n+1. Request must include one of the supported signature headers (see below)\n+2. The ProjectMembership must belong to a Bot resource\n+3. The Bot must be deployed and active\n+\n+### Signature Headers\n+\n+For security, all webhook requests must include one of the following signature headers:\n+\n+- `X-Signature` - standard generic signature header\n+- `X-HMAC-Signature` - standard HMAC signature header\n+- `X-Cal-Signature-256` - Cal.com specific signature header\n+- `X-Twilio-Email-Event-Webhook-Signature` - Twilio specific signature header\n+\n+### Response\n+\n+Webhook endpoints return HTTP status codes only:\n+\n+- 200 OK: The webhook was successfully processed\n+- 400 Bad Request: Missing signature header or invalid ProjectMembership\n+- 404 Not Found: ProjectMembership not found\n+\n+### Setup Guide\n+\n+1. Create a Bot in your Medplum project\n+2. Deploy the Bot with your webhook handling code\n+3. Find the Bot's ProjectMembership ID: `GET /fhir/R4/ProjectMembership?profile=Bot/{botId}`\n+4. Configure your third-party service to send webhooks to: `https://api.medplum.com/webhook/{projectMembershipId}`\n+5. Ensure your service is sending one of the required signature headers\n\ndiff --git a/packages/server/src/webhook/routes.ts b/packages/server/src/webhook/routes.ts\nnew file mode 100644\nindex 0000000000..ead6674d43\n--- /dev/null\n+++ b/packages/server/src/webhook/routes.ts\n@@ -0,0 +1,75 @@\n+import { allOk, badRequest, getStatus, isOperationOutcome } from '@medplum/core';\n+import { Bot, OperationOutcome, ProjectMembership, Reference } from '@medplum/fhirtypes';\n+import { Request, Response, Router } from 'express';\n+import { asyncWrap } from '../async';\n+import { executeBot } from '../fhir/operations/execute';\n+import { getSystemRepo } from '../fhir/repo';\n+\n+/**\n+ * Allowed signature headers are:\n+ *\n+ *   - `X-Signature` - standard generic signature header\n+ *   - `X-HMAC-Signature` - standard HMAC signature header\n+ *      - See: https://consensus.stoplight.io/docs/fax-services/1c4979f1d8ca0-fax-inbound-notification\n+ *   - `X-Cal-Signature-256` - Cal.com specific signature header\n+ *      - See: https://cal.com/docs/developing/guides/automation/webhooks\n+ *   - `X-Twilio-Email-Event-Webhook-Signature` - Twilio specific signature header\n+ *     - See: https://www.twilio.com/docs/sendgrid/for-developers/tracking-events/getting-started-event-webhook-security-features\n+ */\n+const SIGNATURE_HEADERS = [\n+  'x-signature',\n+  'x-hmac-signature',\n+  'x-cal-signature-256',\n+  'x-twilio-email-event-webhook-signature',\n+];\n+\n+/**\n+ * Handles HTTP requests for anonymous webhooks.\n+ */\n+export const webhookHandler = asyncWrap(async (req: Request, res: Response) => {\n+  // At least one of the allowed signature headers must be present\n+  const hasSignatureHeader = SIGNATURE_HEADERS.some((header) => req.header(header));\n+  if (!hasSignatureHeader) {\n+    res.status(400).send('Missing required signature header');\n+    return;\n+  }\n+\n+  const systemRepo = getSystemRepo();\n+  const id = req.params.id;\n+  const runAs = await systemRepo.readResource<ProjectMembership>('ProjectMembership', id);\n+\n+  // The ProjectMembership must be for a Bot resource\n+  if (!runAs.profile.reference?.startsWith('Bot/')) {\n+    res.status(400).send('ProjectMembership must be for a Bot resource');\n+    return;\n+  }\n+\n+  const bot = await systemRepo.readReference<Bot>(runAs.profile as Reference<Bot>);\n+  const headers = req.headers as Record<string, string>;\n+\n+  // Execute the bot\n+  // If the request is HTTP POST, then the body is the input\n+  // If the request is HTTP GET, then the query string is the input\n+  const result = await executeBot({\n+    bot,\n+    runAs,\n+    input: req.method === 'POST' ? req.body : req.query,\n+    contentType: req.header('content-type') as string,\n+    headers,\n+  });\n+\n+  // Unlike normal Bot $execute operations, we don't want to return the result\n+  // This is an unauthenticated webhook, so we just return a 200 OK response\n+  let outcome: OperationOutcome;\n+  if (isOperationOutcome(result)) {\n+    outcome = result;\n+  } else if (result.success) {\n+    outcome = allOk;\n+  } else {\n+    outcome = badRequest(result.logResult);\n+  }\n+  res.sendStatus(getStatus(outcome));\n+});\n+\n+export const webhookRouter = Router();\n+webhookRouter.post('/:id', webhookHandler);\n",
    "test_patch": "diff --git a/packages/server/src/webhook/routes.test.ts b/packages/server/src/webhook/routes.test.ts\nnew file mode 100644\nindex 0000000000..de2209db71\n--- /dev/null\n+++ b/packages/server/src/webhook/routes.test.ts\n@@ -0,0 +1,121 @@\n+import { allOk, ContentType, WithId } from '@medplum/core';\n+import { Bot, ProjectMembership } from '@medplum/fhirtypes';\n+import { randomUUID } from 'crypto';\n+import express from 'express';\n+import request from 'supertest';\n+import { initApp, shutdownApp } from '../app';\n+import { loadTestConfig } from '../config/loader';\n+import { createTestProject } from '../test.setup';\n+\n+const cjsCode = `\n+exports.handler = async function (medplum, event) {\n+  console.log(JSON.stringify(event));\n+  return event.input;\n+};\n+`;\n+\n+describe('Anonymous webhooks', () => {\n+  let app: express.Express;\n+  let adminMembership: WithId<ProjectMembership>;\n+  let accessToken: string;\n+  let bot: WithId<Bot>;\n+  let botMembership: WithId<ProjectMembership>;\n+\n+  beforeAll(async () => {\n+    app = express();\n+    const config = await loadTestConfig();\n+    config.vmContextBotsEnabled = true;\n+    await initApp(app, config);\n+\n+    const testSetup = await createTestProject({\n+      withAccessToken: true,\n+      withClient: true,\n+      membership: { admin: true },\n+    });\n+    adminMembership = testSetup.membership;\n+    accessToken = testSetup.accessToken;\n+\n+    // Create the bot\n+    const res1 = await request(app)\n+      .post('/admin/projects/' + testSetup.project.id + '/bot')\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .type('json')\n+      .send({\n+        name: 'Alice personal bot',\n+        description: 'Alice bot description',\n+      });\n+    expect(res1.status).toBe(201);\n+    expect(res1.body.resourceType).toBe('Bot');\n+    expect(res1.body.id).toBeDefined();\n+    bot = res1.body as WithId<Bot>;\n+\n+    // Deploy the bot\n+    const res2 = await request(app)\n+      .post(`/fhir/R4/Bot/${bot.id}/$deploy`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        code: cjsCode,\n+      });\n+    expect(res2.status).toBe(200);\n+\n+    // Get the bot ProjectMembership\n+    const res3 = await request(app)\n+      .get(`/fhir/R4/ProjectMembership?profile=Bot/${bot.id}`)\n+      .set('Authorization', 'Bearer ' + accessToken);\n+    expect(res3.status).toBe(200);\n+    expect(res3.body.entry).toBeDefined();\n+    expect(res3.body.entry.length).toBe(1);\n+    botMembership = res3.body.entry[0].resource as WithId<ProjectMembership>;\n+  });\n+\n+  afterAll(async () => {\n+    await shutdownApp();\n+  });\n+\n+  test('Missing signature header', async () => {\n+    const res = await request(app)\n+      .post(`/webhook/${botMembership.id}`)\n+      .set('Content-Type', ContentType.TEXT)\n+      .send('input');\n+    expect(res.status).toBe(400);\n+    expect(res.text).toStrictEqual('Missing required signature header');\n+  });\n+\n+  test('Missing invalid ID', async () => {\n+    const res = await request(app)\n+      .post(`/webhook/${randomUUID()}`)\n+      .set('Content-Type', ContentType.TEXT)\n+      .set('x-signature', 'signature')\n+      .send('input');\n+    expect(res.status).toBe(404);\n+  });\n+\n+  test('Non-bot project membership', async () => {\n+    const res = await request(app)\n+      .post(`/webhook/${adminMembership.id}`)\n+      .set('Content-Type', ContentType.TEXT)\n+      .set('x-signature', 'signature')\n+      .send('input');\n+    expect(res.status).toBe(400);\n+    expect(res.text).toStrictEqual('ProjectMembership must be for a Bot resource');\n+  });\n+\n+  test('Success with default result', async () => {\n+    const res = await request(app)\n+      .post(`/webhook/${botMembership.id}`)\n+      .set('Content-Type', ContentType.TEXT)\n+      .set('x-signature', 'signature')\n+      .send('input');\n+    expect(res.status).toBe(200);\n+  });\n+\n+  test('Success with OperationOutcome', async () => {\n+    const res = await request(app)\n+      .post(`/webhook/${botMembership.id}`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('x-signature', 'signature')\n+      .send(allOk);\n+    expect(res.status).toBe(200);\n+  });\n+});\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6403",
    "pr_id": 6403,
    "issue_id": 6394,
    "repo": "medplum/medplum",
    "problem_statement": "Writing resources should be resilient to nullish array element items\nFor example, resources of the following should not throw errors when being written to the database. This includes inline search parameter columns, lookup tables, etc.\n\n```json\n[\n  { \"resourceType\": \"Patient\", \"address\":[{\"use\":\"home\"}, {}] },\n  { \"resourceType\": \"Patient\", \"address\":[{\"use\":\"home\"}, null] },\n  { \"resourceType\": \"Patient\", \"address\":[{\"use\":\"home\"}, undefined] }\n]\n```",
    "issue_word_count": 53,
    "test_files_count": 3,
    "non_test_files_count": 3,
    "pr_changed_files": [
      "packages/server/src/fhir/lookups/address.test.ts",
      "packages/server/src/fhir/lookups/address.ts",
      "packages/server/src/fhir/lookups/humanname.test.ts",
      "packages/server/src/fhir/lookups/humanname.ts",
      "packages/server/src/fhir/tokens.test.ts",
      "packages/server/src/fhir/tokens.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/lookups/address.test.ts",
      "packages/server/src/fhir/lookups/humanname.test.ts",
      "packages/server/src/fhir/tokens.test.ts"
    ],
    "base_commit": "e50f1eb9534a2064b9f192370d9d4b141bf90186",
    "head_commit": "4c020a7593f0344f0e91f4305d1133a9abd319b6",
    "repo_url": "https://github.com/medplum/medplum/pull/6403",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6403",
    "dockerfile": "",
    "pr_merged_at": "2025-04-18T18:02:00.000Z",
    "patch": "diff --git a/packages/server/src/fhir/lookups/address.ts b/packages/server/src/fhir/lookups/address.ts\nindex 7c1d7af219..bef08dbcc0 100644\n--- a/packages/server/src/fhir/lookups/address.ts\n+++ b/packages/server/src/fhir/lookups/address.ts\n@@ -5,7 +5,7 @@ import { Column, DeleteQuery } from '../sql';\n import { LookupTable, LookupTableRow } from './lookuptable';\n \n interface AddressTableRow extends LookupTableRow {\n-  address: string;\n+  address: string | undefined;\n   city: string | undefined;\n   country: string | undefined;\n   postalCode: string | undefined;\n@@ -109,15 +109,35 @@ export class AddressTable extends LookupTable {\n     }\n \n     for (const address of addresses) {\n-      result.push({\n+      const extracted = {\n         resourceId: resource.id,\n-        address: formatAddress(address),\n-        city: address.city?.trim(),\n-        country: address.country?.trim(),\n-        postalCode: address.postalCode?.trim(),\n-        state: address.state?.trim(),\n-        use: address.use?.trim(),\n-      });\n+        // logical OR coalesce to ensure that empty strings are inserted as NULL\n+        address: formatAddress(address) || undefined, // formatAddress can return the empty string\n+        city: address.city?.trim() || undefined,\n+        country: address.country?.trim() || undefined,\n+        postalCode: address.postalCode?.trim() || undefined,\n+        state: address.state?.trim() || undefined,\n+        use: address.use?.trim() || undefined,\n+      };\n+      if (\n+        (extracted.address ||\n+          extracted.city ||\n+          extracted.country ||\n+          extracted.postalCode ||\n+          extracted.state ||\n+          extracted.use) &&\n+        !result.some(\n+          (a) =>\n+            a.address === extracted.address &&\n+            a.city === extracted.city &&\n+            a.country === extracted.country &&\n+            a.postalCode === extracted.postalCode &&\n+            a.state === extracted.state &&\n+            a.use === extracted.use\n+        )\n+      ) {\n+        result.push(extracted);\n+      }\n     }\n   }\n \n@@ -138,21 +158,28 @@ export class AddressTable extends LookupTable {\n       return undefined;\n     }\n \n+    let addresses: (Address | undefined | null)[] | undefined;\n+\n     switch (resource.resourceType) {\n       case 'Patient':\n       case 'Person':\n       case 'Practitioner':\n       case 'RelatedPerson':\n       case 'Organization':\n-        return resource.address;\n+        addresses = resource.address;\n+        break;\n       case 'InsurancePlan':\n-        return resource.contact?.map((contact) => contact.address).filter((address) => !!address);\n+        addresses = resource.contact?.map((contact) => contact.address);\n+        break;\n       case 'Location':\n-        return resource.address ? [resource.address] : undefined;\n+        addresses = resource.address ? [resource.address] : undefined;\n+        break;\n       default:\n         resource.resourceType satisfies never;\n         return undefined;\n     }\n+\n+    return addresses?.filter((a) => !!a);\n   }\n \n   /**\n\ndiff --git a/packages/server/src/fhir/lookups/humanname.ts b/packages/server/src/fhir/lookups/humanname.ts\nindex 2e4f26839a..84f1d8e286 100644\n--- a/packages/server/src/fhir/lookups/humanname.ts\n+++ b/packages/server/src/fhir/lookups/humanname.ts\n@@ -19,9 +19,9 @@ type HumanNameResourceType = (typeof resourceTypes)[number];\n type HumanNameResource = Patient | Person | Practitioner | RelatedPerson;\n \n interface HumanNameTableRow extends LookupTableRow {\n-  name: string;\n-  given: string;\n-  family: string;\n+  name: string | undefined;\n+  given: string | undefined;\n+  family: string | undefined;\n }\n \n /**\n@@ -73,17 +73,29 @@ export class HumanNameTable extends LookupTable {\n       return;\n     }\n \n-    const names = (resource as HumanNameResource).name;\n+    const names: (HumanName | undefined | null)[] | undefined = (resource as HumanNameResource).name;\n     if (!Array.isArray(names)) {\n       return;\n     }\n     for (const name of names) {\n-      result.push({\n+      if (!name) {\n+        continue;\n+      }\n+\n+      const extracted = {\n         resourceId: resource.id,\n-        name: getNameString(name),\n-        given: formatGivenName(name),\n-        family: formatFamilyName(name),\n-      });\n+        // logical OR coalesce to ensure that empty strings are inserted as NULL\n+        name: getNameString(name) || undefined,\n+        given: formatGivenName(name) || undefined,\n+        family: formatFamilyName(name) || undefined,\n+      };\n+\n+      if (\n+        (extracted.name || extracted.given || extracted.family) &&\n+        !result.some((n) => n.name === extracted.name && n.given === extracted.given && n.family === extracted.family)\n+      ) {\n+        result.push(extracted);\n+      }\n     }\n   }\n \n\ndiff --git a/packages/server/src/fhir/tokens.ts b/packages/server/src/fhir/tokens.ts\nindex 161282bcd7..937caad85d 100644\n--- a/packages/server/src/fhir/tokens.ts\n+++ b/packages/server/src/fhir/tokens.ts\n@@ -193,12 +193,9 @@ function buildCodingToken(result: Token[], context: TokensContext, coding: Codin\n  * @param contactPoint - The ContactPoint object to be indexed.\n  */\n function buildContactPointToken(result: Token[], context: TokensContext, contactPoint: ContactPoint | undefined): void {\n-  buildSimpleToken(\n-    result,\n-    context,\n-    contactPoint?.system,\n-    contactPoint?.value ? contactPoint.value.toLocaleLowerCase() : contactPoint?.value\n-  );\n+  if (contactPoint) {\n+    buildSimpleToken(result, context, contactPoint.system, contactPoint.value?.toLocaleLowerCase());\n+  }\n }\n \n /**\n",
    "test_patch": "diff --git a/packages/server/src/fhir/lookups/address.test.ts b/packages/server/src/fhir/lookups/address.test.ts\nindex 0619f873fb..bf8c269993 100644\n--- a/packages/server/src/fhir/lookups/address.test.ts\n+++ b/packages/server/src/fhir/lookups/address.test.ts\n@@ -1,5 +1,5 @@\n-import { Operator } from '@medplum/core';\n-import { InsurancePlan, Patient, Location, ResourceType, Resource } from '@medplum/fhirtypes';\n+import { Operator, WithId } from '@medplum/core';\n+import { InsurancePlan, Patient, Location, ResourceType, Resource, Address } from '@medplum/fhirtypes';\n import { randomUUID } from 'crypto';\n import { initAppServices, shutdownApp } from '../../app';\n import { loadTestConfig } from '../../config/loader';\n@@ -227,4 +227,110 @@ describe('Address Lookup Table', () => {\n \n     expect(db.query).not.toHaveBeenCalled();\n   });\n+\n+  test('extractValues defensive against nullish and empty string values', () => {\n+    const table = new AddressTable();\n+    const r1: WithId<Patient> = {\n+      resourceType: 'Patient',\n+      id: '1',\n+      address: undefined,\n+    };\n+    const result1: any[] = [];\n+    table.extractValues(result1, r1);\n+    expect(result1).toStrictEqual([]);\n+\n+    const r2: WithId<Patient> = {\n+      resourceType: 'Patient',\n+      id: '2',\n+      address: [\n+        {},\n+        null,\n+        undefined,\n+        {\n+          use: 'work',\n+          line: ['Line 1'],\n+          city: 'City 1',\n+          country: 'Country 1',\n+          postalCode: 'Postal 1',\n+          state: 'State 1',\n+        },\n+        { line: ['Line 1', 'Line 2'], city: '' }, // empty city should be ignored\n+        { line: ['Line 1', 'Line 2'] },\n+        { use: 'home' },\n+      ] as unknown as Address[],\n+    };\n+\n+    const result2: any[] = [];\n+    table.extractValues(result2, r2);\n+    expect(result2).toStrictEqual([\n+      {\n+        resourceId: '2',\n+        address: 'Line 1, City 1, State 1, Postal 1',\n+        city: 'City 1',\n+        country: 'Country 1',\n+        postalCode: 'Postal 1',\n+        state: 'State 1',\n+        use: 'work',\n+      },\n+      {\n+        address: 'Line 1, Line 2',\n+        city: undefined,\n+        country: undefined,\n+        postalCode: undefined,\n+        resourceId: '2',\n+        state: undefined,\n+        use: undefined,\n+      },\n+      {\n+        address: undefined,\n+        city: undefined,\n+        country: undefined,\n+        postalCode: undefined,\n+        resourceId: '2',\n+        state: undefined,\n+        use: 'home',\n+      },\n+    ]);\n+\n+    const r3: WithId<InsurancePlan> = {\n+      resourceType: 'InsurancePlan',\n+      id: '3',\n+      contact: [\n+        {\n+          address: {\n+            use: 'work',\n+            line: ['Line 1'],\n+            city: 'City 1',\n+            country: 'Country 1',\n+            postalCode: 'Postal 1',\n+            state: 'State 1',\n+          },\n+        },\n+        {\n+          address: {\n+            use: 'work',\n+            line: ['Line 1'],\n+            city: 'City 1',\n+            country: 'Country 1',\n+            postalCode: 'Postal 1',\n+            state: 'State 1',\n+          },\n+        },\n+      ],\n+    };\n+\n+    const result3: any[] = [];\n+    table.extractValues(result3, r3);\n+    expect(result3).toStrictEqual([\n+      {\n+        resourceId: '3',\n+        address: 'Line 1, City 1, State 1, Postal 1',\n+        city: 'City 1',\n+        country: 'Country 1',\n+        postalCode: 'Postal 1',\n+        state: 'State 1',\n+        use: 'work',\n+      },\n+    ]);\n+  });\n });\n\ndiff --git a/packages/server/src/fhir/lookups/humanname.test.ts b/packages/server/src/fhir/lookups/humanname.test.ts\nindex 040d05d2b4..2e67dc13da 100644\n--- a/packages/server/src/fhir/lookups/humanname.test.ts\n+++ b/packages/server/src/fhir/lookups/humanname.test.ts\n@@ -1,5 +1,5 @@\n-import { Operator } from '@medplum/core';\n-import { Patient } from '@medplum/fhirtypes';\n+import { Operator, WithId } from '@medplum/core';\n+import { HumanName, Patient } from '@medplum/fhirtypes';\n import { randomUUID } from 'crypto';\n import { initAppServices, shutdownApp } from '../../app';\n import { loadTestConfig } from '../../config/loader';\n@@ -258,4 +258,33 @@ describe('HumanName Lookup Table', () => {\n \n     expect(db.query).not.toHaveBeenCalled();\n   });\n+\n+  test('extractValues defensive against nullish values', () => {\n+    const table = new HumanNameTable();\n+    const r1: WithId<Patient> = {\n+      resourceType: 'Patient',\n+      id: '1',\n+      name: undefined,\n+    };\n+    let result: any[] = [];\n+    table.extractValues(result, r1);\n+    expect(result).toStrictEqual([]);\n+\n+    const r2: WithId<Patient> = {\n+      resourceType: 'Patient',\n+      id: '2',\n+      name: [{}, null, undefined, { family: 'Family' }, { family: 'Family' }] as unknown as HumanName[],\n+    };\n+\n+    result = [];\n+    table.extractValues(result, r2);\n+    expect(result).toStrictEqual([\n+      {\n+        resourceId: '2',\n+        name: 'Family',\n+        given: undefined,\n+        family: 'Family',\n+      },\n+    ]);\n+  });\n });\n\ndiff --git a/packages/server/src/fhir/tokens.test.ts b/packages/server/src/fhir/tokens.test.ts\nindex 8712be7dd7..e8de19d2c0 100644\n--- a/packages/server/src/fhir/tokens.test.ts\n+++ b/packages/server/src/fhir/tokens.test.ts\n@@ -2,6 +2,7 @@ import { createReference, getReferenceString, getSearchParameter, Operator, SNOM\n import {\n   Bundle,\n   Condition,\n+  Identifier,\n   MedicationRequest,\n   Patient,\n   Reference,\n@@ -14,8 +15,14 @@ import { loadTestConfig } from '../config/loader';\n import { bundleContains, createTestProject, withTestContext } from '../test.setup';\n import { getSystemRepo, Repository } from './repo';\n import { getSearchParameterImplementation } from './searchparameter';\n+import { loadStructureDefinitions } from './structure';\n import { TokenQueryOperators } from './token-column';\n-import { isLegacyTokenColumnSearchParameter, TokenColumnsFeature } from './tokens';\n+import {\n+  buildTokensForSearchParameter,\n+  isLegacyTokenColumnSearchParameter,\n+  Token,\n+  TokenColumnsFeature,\n+} from './tokens';\n \n describe.each<'token columns' | 'lookup table'>(['token columns', 'lookup table'])(\n   'Token searching using %s',\n@@ -1455,6 +1462,46 @@ describe.each<'token columns' | 'lookup table'>(['token columns', 'lookup table'\n   }\n );\n \n+describe('buildTokens', () => {\n+  beforeAll(() => {\n+    loadStructureDefinitions();\n+  });\n+\n+  test('empty resource', () => {\n+    const identifierSearchParam = getSearchParameter('Patient', 'identifier');\n+    if (!identifierSearchParam) {\n+      throw new Error('Could not find identifier search parameter');\n+    }\n+    const r1: WithId<Patient> = {\n+      resourceType: 'Patient',\n+      id: '1',\n+      identifier: undefined,\n+    };\n+    const result1: Token[] = [];\n+    buildTokensForSearchParameter(result1, r1, identifierSearchParam);\n+    expect(result1).toStrictEqual([]);\n+\n+    const validIdentifiers: Identifier[] = [\n+      {},\n+      { system: 'http://example.com', value: '123' },\n+      { system: 'http://example.com', value: '123' },\n+      { system: 'http://example.com', value: '456' },\n+      { use: 'official' },\n+    ];\n+    const r2: WithId<Patient> = {\n+      resourceType: 'Patient',\n+      id: '2',\n+      identifier: [null, undefined, ...validIdentifiers] as unknown as Identifier[],\n+    };\n+    const result2: Token[] = [];\n+    buildTokensForSearchParameter(result2, r2, identifierSearchParam);\n+    expect(result2).toStrictEqual([\n+      { code: 'identifier', system: 'http://example.com', value: '123' },\n+      { code: 'identifier', system: 'http://example.com', value: '456' },\n+    ]);\n+  });\n+});\n+\n function toIdentifierValues(bundle: Bundle<Condition | Patient>): string[] {\n   return bundle.entry?.map((e) => e.resource?.identifier?.[0].value as string) ?? [];\n }\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6399",
    "pr_id": 6399,
    "issue_id": 6388,
    "repo": "medplum/medplum",
    "problem_statement": "Agent crashes at startup if network is down before agent calls `MedplumClient.startClientLogin`\n",
    "issue_word_count": 13,
    "test_files_count": 2,
    "non_test_files_count": 3,
    "pr_changed_files": [
      "packages/agent/src/agent-main.test.ts",
      "packages/agent/src/agent-main.ts",
      "packages/agent/src/app.test.ts",
      "packages/agent/src/app.ts",
      "packages/agent/src/constants.ts"
    ],
    "pr_changed_test_files": [
      "packages/agent/src/agent-main.test.ts",
      "packages/agent/src/app.test.ts"
    ],
    "base_commit": "430d7ae573e7ab64088fba46eaeea77342c5ae52",
    "head_commit": "da9aa3b0a5bd7683e672ed48b978b6e1acd58820",
    "repo_url": "https://github.com/medplum/medplum/pull/6399",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6399",
    "dockerfile": "",
    "pr_merged_at": "2025-04-28T22:45:01.000Z",
    "patch": "diff --git a/packages/agent/src/agent-main.ts b/packages/agent/src/agent-main.ts\nindex c7c8254123..1990680a21 100644\n--- a/packages/agent/src/agent-main.ts\n+++ b/packages/agent/src/agent-main.ts\n@@ -1,6 +1,7 @@\n-import { MedplumClient, parseLogLevel } from '@medplum/core';\n+import { MedplumClient, normalizeErrorString, parseLogLevel, sleep } from '@medplum/core';\n import { existsSync, readFileSync } from 'node:fs';\n import { App } from './app';\n+import { RETRY_WAIT_DURATION_MS } from './constants';\n \n interface Args {\n   baseUrl: string;\n@@ -46,7 +47,18 @@ export async function agentMain(argv: string[]): Promise<App> {\n   const { baseUrl, clientId, clientSecret, agentId } = args;\n \n   const medplum = new MedplumClient({ baseUrl, clientId });\n-  await medplum.startClientLogin(clientId, clientSecret);\n+\n+  let loggedIn = false;\n+  while (!loggedIn) {\n+    try {\n+      await medplum.startClientLogin(clientId, clientSecret);\n+      loggedIn = true;\n+    } catch (err) {\n+      console.error('Failed to login', { err: normalizeErrorString(err) });\n+      console.log('Retrying login in 10 seconds...');\n+      await sleep(RETRY_WAIT_DURATION_MS);\n+    }\n+  }\n \n   const app = new App(medplum, agentId, parseLogLevel(args.logLevel ?? 'INFO'));\n   await app.start();\n\ndiff --git a/packages/agent/src/app.ts b/packages/agent/src/app.ts\nindex 9319acf556..ed29f3d7f7 100644\n--- a/packages/agent/src/app.ts\n+++ b/packages/agent/src/app.ts\n@@ -27,6 +27,7 @@ import { platform } from 'node:os';\n import process from 'node:process';\n import WebSocket from 'ws';\n import { Channel, ChannelType, getChannelType, getChannelTypeShortName } from './channel';\n+import { DEFAULT_PING_TIMEOUT, MAX_MISSED_HEARTBEATS, RETRY_WAIT_DURATION_MS } from './constants';\n import { AgentDicomChannel } from './dicom';\n import { AgentHl7Channel } from './hl7';\n import { UPGRADER_LOG_PATH, UPGRADE_MANIFEST_PATH } from './upgrader-utils';\n@@ -44,9 +45,6 @@ async function execAsync(command: string, options: ExecOptions): Promise<{ stdou\n   });\n }\n \n-export const DEFAULT_PING_TIMEOUT = 3600;\n-export const MAX_MISSED_HEARTBEATS = 1;\n-\n export class App {\n   static instance: App;\n   readonly medplum: MedplumClient;\n@@ -269,13 +267,10 @@ export class App {\n       }\n     });\n \n-    return new Promise<void>((resolve, reject) => {\n-      const connectTimeout = setTimeout(\n-        () => reject(new Error('Timeout when attempting to connect to server WebSocket')),\n-        10000\n-      );\n+    return new Promise<void>((resolve) => {\n+      const connectInterval = setInterval(() => this.webSocket?.reconnect(), RETRY_WAIT_DURATION_MS);\n       this.webSocket?.addEventListener('open', () => {\n-        clearTimeout(connectTimeout);\n+        clearInterval(connectInterval);\n         resolve();\n       });\n     });\n\ndiff --git a/packages/agent/src/constants.ts b/packages/agent/src/constants.ts\nnew file mode 100644\nindex 0000000000..e288905f11\n--- /dev/null\n+++ b/packages/agent/src/constants.ts\n@@ -0,0 +1,3 @@\n+export const RETRY_WAIT_DURATION_MS = 10_000;\n+export const DEFAULT_PING_TIMEOUT = 3_600;\n+export const MAX_MISSED_HEARTBEATS = 1;\n",
    "test_patch": "diff --git a/packages/agent/src/agent-main.test.ts b/packages/agent/src/agent-main.test.ts\nindex c55e4826cb..658afd4a35 100644\n--- a/packages/agent/src/agent-main.test.ts\n+++ b/packages/agent/src/agent-main.test.ts\n@@ -1,8 +1,12 @@\n-import { LogLevel } from '@medplum/core';\n+import { LogLevel, sleep } from '@medplum/core';\n import fs from 'node:fs';\n import { agentMain } from './agent-main';\n import { App } from './app';\n \n+jest.mock('./constants', () => ({\n+  RETRY_WAIT_DURATION_MS: 150,\n+}));\n+\n describe('Main', () => {\n   beforeEach(() => {\n     console.log = jest.fn();\n@@ -95,4 +99,75 @@ describe('Main', () => {\n     await app.stop();\n     expect(process.exit).not.toHaveBeenCalled();\n   });\n+\n+  test('Agent should retry client login when network is down', async () => {\n+    const fetchSpy = jest.spyOn(globalThis, 'fetch').mockImplementation(async () => {\n+      throw new Error('Fetch failed');\n+    });\n+    const consoleErrorSpy = jest.spyOn(console, 'error').mockImplementation(jest.fn());\n+\n+    const appPromise = agentMain(['node', 'index.js', 'http://example.com', 'clientId', 'clientSecret', 'agentId']);\n+\n+    while (fetchSpy.mock.calls.length !== 3) {\n+      await sleep(100);\n+    }\n+\n+    // fetchWithRetry tries to fetch 3 times per attempt before throwing\n+    expect(fetchSpy).toHaveBeenCalledWith('http://example.com/oauth2/token', {\n+      body: 'grant_type=client_credentials&client_id=clientId&client_secret=clientSecret',\n+      credentials: 'include',\n+      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\n+      method: 'POST',\n+    });\n+\n+    expect(consoleErrorSpy).toHaveBeenCalledWith(\n+      'Failed to login',\n+      expect.objectContaining({ err: expect.any(String) })\n+    );\n+    expect(console.log).toHaveBeenCalledWith(expect.stringContaining('Retrying login'));\n+\n+    fetchSpy.mockClear();\n+    consoleErrorSpy.mockClear();\n+    (console.log as jest.Mock).mockClear();\n+\n+    while (fetchSpy.mock.calls.length !== 3) {\n+      await sleep(100);\n+    }\n+\n+    // Let it try and fail again\n+    expect(fetchSpy).toHaveBeenCalledTimes(3);\n+    expect(consoleErrorSpy).toHaveBeenCalledWith(\n+      'Failed to login',\n+      expect.objectContaining({ err: expect.any(String) })\n+    );\n+    expect(console.log).toHaveBeenCalledWith(expect.stringContaining('Retrying login'));\n+\n+    fetchSpy.mockClear();\n+    consoleErrorSpy.mockClear();\n+    (console.log as jest.Mock).mockClear();\n+\n+    // Finally restore original fetch implementation and allow it to succeed\n+    fetchSpy.mockImplementation(async () => {\n+      return {\n+        ok: true,\n+        json: async () => ({\n+          access_token: 'foo',\n+        }),\n+      } as Response;\n+    });\n+\n+    while (!fetchSpy.mock.calls.length) {\n+      await sleep(100);\n+    }\n+\n+    expect(fetchSpy).toHaveBeenCalledTimes(1);\n+    expect(consoleErrorSpy).not.toHaveBeenCalled();\n+    expect(console.log).not.toHaveBeenCalledWith('Retrying login');\n+\n+    const app = await appPromise;\n+    await app.stop();\n+\n+    consoleErrorSpy.mockRestore();\n+    fetchSpy.mockRestore();\n+  });\n });\n\ndiff --git a/packages/agent/src/app.test.ts b/packages/agent/src/app.test.ts\nindex 1822a01b0b..f026c73cf5 100644\n--- a/packages/agent/src/app.test.ts\n+++ b/packages/agent/src/app.test.ts\n@@ -9,6 +9,7 @@ import {\n   Hl7Message,\n   LogLevel,\n   MEDPLUM_VERSION,\n+  ReconnectingWebSocket,\n   allOk,\n   createReference,\n   getReferenceString,\n@@ -28,6 +29,11 @@ import { App } from './app';\n import { AgentHl7Channel } from './hl7';\n import { mockFetchForUpgrader } from './upgrader-test-utils';\n \n+jest.mock('./constants', () => ({\n+  ...jest.requireActual('./constants'),\n+  RETRY_WAIT_DURATION_MS: 200,\n+}));\n+\n jest.mock('node:process', () => {\n   // eslint-disable-next-line @typescript-eslint/no-require-imports\n   return new (class MockProcess extends require('node:events') {\n@@ -121,6 +127,67 @@ describe('App', () => {\n     console.log = originalConsoleLog;\n   });\n \n+  test('Keeps trying to connect on startup', async () => {\n+    const originalConsoleLog = console.log;\n+    console.log = jest.fn();\n+    const state = {\n+      maxReconnectAttempts: 2,\n+      shouldConnect: false,\n+    };\n+\n+    const originalDispatchEvent = ReconnectingWebSocket.prototype.dispatchEvent;\n+    const reconnectSpy = jest.spyOn(ReconnectingWebSocket.prototype, 'reconnect');\n+    const mockDispatchEvent = jest.spyOn(ReconnectingWebSocket.prototype, 'dispatchEvent').mockImplementation(function (\n+      this: ReconnectingWebSocket,\n+      event: Event\n+    ) {\n+      state.shouldConnect = reconnectSpy.mock.calls.length >= state.maxReconnectAttempts;\n+      // Only allow open events through when we should connect\n+      if (event.type === 'open' && !state.shouldConnect) {\n+        return;\n+      }\n+      // eslint-disable-next-line no-invalid-this\n+      originalDispatchEvent.call(this, event);\n+    });\n+\n+    const mockServer = new Server('wss://example.com/ws/agent');\n+    mockServer.on('connection', (socket) => {\n+      socket.on('message', (data) => {\n+        const command = JSON.parse((data as Buffer).toString('utf8'));\n+        if (command.type === 'agent:connect:request') {\n+          socket.send(Buffer.from(JSON.stringify({ type: 'agent:connect:response' })));\n+        }\n+      });\n+    });\n+\n+    const agent = await medplum.createResource<Agent>({\n+      resourceType: 'Agent',\n+      name: 'Test Agent',\n+      status: 'active',\n+    });\n+\n+    const app = new App(medplum, agent.id, LogLevel.INFO);\n+    app.heartbeatPeriod = 5000;\n+    await app.start();\n+\n+    while (reconnectSpy.mock.calls.length < state.maxReconnectAttempts) {\n+      await sleep(100);\n+    }\n+\n+    // Verify the number of reconnect attempts\n+    expect(reconnectSpy).toHaveBeenCalledTimes(state.maxReconnectAttempts);\n+\n+    await app.stop();\n+    await new Promise<void>((resolve) => {\n+      mockServer.stop(resolve);\n+    });\n+\n+    // Restore the original ReconnectingWebSocket\n+    mockDispatchEvent.mockRestore();\n+    reconnectSpy.mockRestore();\n+    console.log = originalConsoleLog;\n+  });\n+\n   test('Reconnect after connection closed', async () => {\n     const state = {\n       mySocket: undefined as Client | undefined,\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6397",
    "pr_id": 6397,
    "issue_id": 6395,
    "repo": "medplum/medplum",
    "problem_statement": "Resource validation for array elements containing empty objects\nThis resource should fail validation: `{ \"resourceType\": \"Patient\", \"address\":[{\"use\":\"home\"}, {}] }`",
    "issue_word_count": 18,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/core/src/typeschema/validation.test.ts",
      "packages/core/src/typeschema/validation.ts"
    ],
    "pr_changed_test_files": [
      "packages/core/src/typeschema/validation.test.ts"
    ],
    "base_commit": "430d7ae573e7ab64088fba46eaeea77342c5ae52",
    "head_commit": "14191e75b5ab179f8fa6e2c563e981fb68dbffb7",
    "repo_url": "https://github.com/medplum/medplum/pull/6397",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6397",
    "dockerfile": "",
    "pr_merged_at": "2025-06-03T20:48:13.000Z",
    "patch": "diff --git a/packages/core/src/typeschema/validation.ts b/packages/core/src/typeschema/validation.ts\nindex 4064ed944d..ce7e0820ef 100644\n--- a/packages/core/src/typeschema/validation.ts\n+++ b/packages/core/src/typeschema/validation.ts\n@@ -268,6 +268,8 @@ class ResourceValidator implements CrawlerVisitor {\n   private checkPropertyValue(value: TypedValueWithPath): void {\n     if (isPrimitiveType(value.type)) {\n       this.validatePrimitiveType(value);\n+    } else if (isEmpty(value.value)) {\n+      this.issues.push(createStructureIssue(value.path, `Invalid empty non-primitive value`));\n     }\n   }\n \n",
    "test_patch": "diff --git a/packages/core/src/typeschema/validation.test.ts b/packages/core/src/typeschema/validation.test.ts\nindex e69208d473..0b9569e450 100644\n--- a/packages/core/src/typeschema/validation.test.ts\n+++ b/packages/core/src/typeschema/validation.test.ts\n@@ -870,6 +870,44 @@ describe('FHIR resource validation', () => {\n     }\n   });\n \n+  test('Empty object', () => {\n+    const p1: Patient = { resourceType: 'Patient', maritalStatus: { text: 'Single' } };\n+    const p2: Patient = { resourceType: 'Patient', maritalStatus: {} };\n+\n+    expect(() => validateResource(p1)).not.toThrow();\n+    expect(() => validateResource(p2)).not.toThrow();\n+  });\n+\n+  test('Empty object in array element', () => {\n+    const p1: Patient = { resourceType: 'Patient', address: [] };\n+    const p3: Patient = { resourceType: 'Patient', address: [{}, { use: 'home' }, {}] };\n+    const p2: Patient = { resourceType: 'Patient', address: [{}] };\n+\n+    expect(() => validateResource(p1)).not.toThrow();\n+\n+    try {\n+      validateResource(p2);\n+      fail('Expected error');\n+    } catch (err) {\n+      const outcome = (err as OperationOutcomeError).outcome;\n+      expect(outcome.issue?.length).toBe(1);\n+      expect(outcome.issue?.[0]?.severity).toStrictEqual('error');\n+      expect(outcome.issue?.[0]?.expression?.[0]).toStrictEqual('Patient.address[0]');\n+    }\n+\n+    try {\n+      validateResource(p3);\n+      fail('Expected error');\n+    } catch (err) {\n+      const outcome = (err as OperationOutcomeError).outcome;\n+      expect(outcome.issue?.length).toBe(2);\n+      expect(outcome.issue?.[0]?.severity).toStrictEqual('error');\n+      expect(outcome.issue?.[0]?.expression?.[0]).toStrictEqual('Patient.address[0]');\n+      expect(outcome.issue?.[1]?.severity).toStrictEqual('error');\n+      expect(outcome.issue?.[1]?.expression?.[0]).toStrictEqual('Patient.address[2]');\n+    }\n+  });\n+\n   test('Deep nested null array element', () => {\n     try {\n       validateResource({\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6375",
    "pr_id": 6375,
    "issue_id": 6323,
    "repo": "medplum/medplum",
    "problem_statement": "[Epic Demo Bot] Sync Patient Profile\n## Description\n\n- Extend the functionality to also sync resources from the patient profile (e.g., demographics, medications, allergies).\n  - For reference: https://storybook.medplum.com/?path=/story/medplum-patientsummary--patient \n- Update the README with details on how to obtain the API key and sign up for their sandbox environment.",
    "issue_word_count": 53,
    "test_files_count": 2,
    "non_test_files_count": 3,
    "pr_changed_files": [
      "examples/medplum-demo-bots/medplum.config.json",
      "examples/medplum-demo-bots/src/epic/README.md",
      "examples/medplum-demo-bots/src/epic/epic-query-patient-test-data.ts",
      "examples/medplum-demo-bots/src/epic/epic-query-patient.test.ts",
      "examples/medplum-demo-bots/src/epic/epic-query-patient.ts"
    ],
    "pr_changed_test_files": [
      "examples/medplum-demo-bots/src/epic/epic-query-patient-test-data.ts",
      "examples/medplum-demo-bots/src/epic/epic-query-patient.test.ts"
    ],
    "base_commit": "7d60d788ae1375b6eb57604baedfe37da0ffadf4",
    "head_commit": "44e6824fdd9fcfd550f0ce643b06fc1535c993bd",
    "repo_url": "https://github.com/medplum/medplum/pull/6375",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6375",
    "dockerfile": "",
    "pr_merged_at": "2025-04-28T16:42:00.000Z",
    "patch": "diff --git a/examples/medplum-demo-bots/medplum.config.json b/examples/medplum-demo-bots/medplum.config.json\nindex 1247c67bfd..332cc545a0 100644\n--- a/examples/medplum-demo-bots/medplum.config.json\n+++ b/examples/medplum-demo-bots/medplum.config.json\n@@ -95,6 +95,12 @@\n       \"id\": \"\",\n       \"source\": \"src/billing-bots/cms-1500-pdf.ts\",\n       \"dist\": \"dist/billing-bots/cms-1500-pdf.js\"\n+    },\n+    {\n+      \"name\": \"epic-query-patient\",\n+      \"id\": \"\",\n+      \"source\": \"src/epic/epic-query-patient.ts\",\n+      \"dist\": \"dist/epic/epic-query-patient.js\"\n     }\n   ]\n }\n\ndiff --git a/examples/medplum-demo-bots/src/epic/README.md b/examples/medplum-demo-bots/src/epic/README.md\nindex 02d13444c6..61cf35707f 100644\n--- a/examples/medplum-demo-bots/src/epic/README.md\n+++ b/examples/medplum-demo-bots/src/epic/README.md\n@@ -1,13 +1,60 @@\n-# Epic Connection Demo\n+# Epic Connection Demo Bot\n \n-The `epic-query-patient.ts` bot is a simple introductory bot that demonstrates how authenticate and connect to an [Epic FHIR](https://fhir.epic.com/) server and read a single resource by id. You can [sign up online](https://fhir.epic.com/Developer/Apps) for credentials to the EPIC developer environment.\n+The `epic-query-patient.ts` bot demonstrates how a Medplum Bot can authenticate and connect to an [Epic FHIR](https://fhir.epic.com/) server using backend JWT authentication. It showcases a common integration pattern: synchronizing Patient data between Medplum and Epic.\n+\n+## Bot Behavior\n+\n+This bot is designed to run with a Medplum `Patient` resource as its input. Its primary function is to ensure that the Patient exists in Epic and to synchronize key information between the two systems.\n+\n+The bot determines its action based on whether the Medplum `Patient` resource already has an identifier linking it to an Epic patient record:\n+\n+1.  **If no Epic identifier exists:** The bot creates a new `Patient` record in Epic using the Medplum patient's data. It then updates the Medplum `Patient` resource to include the identifier for the newly created Epic record.\n+\n+2.  **If an Epic identifier exists:** The bot uses the identifier to fetch the latest patient data and related clinical information (such as allergies and medications) from Epic. It then updates the corresponding Medplum `Patient` resource and its associated data to reflect the information retrieved from Epic.\n \n ## Application Audience\n \n-Epic supports patient facing applications, clinician facing applications and backend system applications. This bot is an **example of a backend system application** which is where the Medplum bot connects directly to the FHIR server with no user facing authentication flow. To get your application to behave as intended it will require the right level of access to the Epic FHIR server. We recommend reading the [Epic FHIR documentation](https://fhir.epic.com/Documentation?docId=developerguidelines) to understand which FHIR APIs will be needed to function correctly. The Epic FHIR API has many configuration parameter and correct configuration will be required for a successful implementation.\n+Epic supports patient-facing applications, clinician-facing applications, and backend system applications. This bot is an **example of a backend system application**, where the Medplum bot connects directly to the FHIR server with no user-facing authentication flow. This requires appropriate configuration and access rights on the Epic FHIR server.\n+\n+## Setting up the Epic FHIR Sandbox\n+\n+To test this bot or develop your own Epic integration, you'll need access to Epic's developer sandbox environment. Here's how to set it up:\n+\n+1.  **Register/Login:** Go to [https://fhir.epic.com/](https://fhir.epic.com/) and sign up for or log in to an Epic On FHIR developer account.\n+2.  **Create an App:** Navigate to the \"Build Apps\" section (or similar) and choose to create a new application.\n+3.  **Configure App Details:**\n+    - **App Name:** Choose a descriptive name (e.g., \"Medplum Backend Integration\").\n+    - **Application Audience:** Select **Backend Service**. This is crucial for server-to-server integrations like this bot, which use JWT client assertion and do not involve direct user interaction for authentication.\n+    - **Incoming APIs:** Select the FHIR resource types and interactions your application will need. For this bot, you would need at least `Patient` (read, create, search), `Organization` (read, search), `Practitioner` (read, search), `AllergyIntolerance` (read, search), `MedicationRequest` (read, search), and `Medication` (read, search). Ensure you select the **FHIR R4** versions of these APIs.\n+    - **Public Key:** You will need to generate an RSA key pair (e.g., using `openssl`). Upload the **public key** to the Epic application configuration. The corresponding **private key** will be used by the Medplum bot to sign the JWT assertion for authentication.\n+4.  **Save and Get Credentials:**\n+    - Copy the **Non-Production Client ID**. This is required by the bot.\n+    - Choose your SMART on FHIR version (Medplum uses R4).\n+    - Provide a brief summary for your app.\n+    - Accept the terms of use.\n+    - Save the application configuration (e.g., click **Save & Ready for Sandbox**).\n+\n+## Bot Configuration Requirements\n+\n+To run this bot within Medplum, you need to configure the following [Bot Secrets](https://www.medplum.com/docs/bots/bot-secrets):\n+\n+- `EPIC_CLIENT_ID`: The **Non-Production Client ID** obtained from the Epic developer portal when setting up your application.\n+- `EPIC_PRIVATE_KEY`: The **private key** (in PEM format) corresponding to the public key you uploaded to the Epic application configuration.\n+\n+The bot currently uses the following hardcoded URLs for the Epic sandbox environment:\n+\n+- `baseUrl`: `https://fhir.epic.com/interconnect-fhir-oauth/`\n+- `tokenUrl`: `https://fhir.epic.com/interconnect-fhir-oauth/oauth2/token`\n+- `fhirUrlPath`: `api/FHIR/R4/`\n+\n+These URLs might differ for specific hospital system production environments. A list of [EPIC FHIR endpoints](https://open.epic.com/MyApps/Endpoints) is available online, but you will typically get the correct URLs from the institution you are connecting to.\n+\n+> [!IMPORTANT]\n+> Medplum examples use FHIR R4. Ensure your Epic application is configured for R4 APIs, and do not select STU3 or DSTU2 options.\n \n-## Requirements\n+## Tips and Known Issues\n \n-The code in the sample `epic-query-patient.ts` requires `privateKey`, `clientId`, `baseUrl`, `tokenUrl`, and `fhirUrlPath` to successfully connect. The example demonstrates connection to the developer environment, but the exact production environment will depend on the institution you are connecting to. A list of [EPIC FHIR endpoints](https://open.epic.com/MyApps/Endpoints) is available online.\n+- **Private Key Formatting:** When adding the `EPIC_PRIVATE_KEY` secret in Medplum Project Secrets, ensure it is formatted correctly, including the header and footer, with newline characters represented as `\\n`. For example: `-----BEGIN PRIVATE KEY-----\\n<your-private-key-string>\\n-----END PRIVATE KEY-----`. Incorrect formatting can lead to authentication failures.\n+- **Epic API Change Propagation:** If you modify the **Incoming APIs** settings for your application in the Epic developer portal (e.g., adding access to new FHIR resources), these changes might take some time (potentially up to an hour) to propagate through Epic's systems. During this period, requests involving the newly added APIs might fail. If you encounter unexpected errors after changing API permissions, wait a while and try again.\n \n-Medplum examples use FHIR R4, so take care not to select STU3 or DSTU in your configuration settings.\n+We recommend reading the official [Epic FHIR documentation](https://fhir.epic.com/Documentation?docId=developerguidelines) to fully understand the available FHIR APIs, configuration parameters, and specific requirements for a successful implementation.\n\ndiff --git a/examples/medplum-demo-bots/src/epic/epic-query-patient.ts b/examples/medplum-demo-bots/src/epic/epic-query-patient.ts\nindex 2e9fdba04a..252aff55ea 100644\n--- a/examples/medplum-demo-bots/src/epic/epic-query-patient.ts\n+++ b/examples/medplum-demo-bots/src/epic/epic-query-patient.ts\n@@ -1,23 +1,37 @@\n-import { BotEvent, MedplumClient } from '@medplum/core';\n+import { BotEvent, createReference, getIdentifier, getReferenceString, MedplumClient, resolveId } from '@medplum/core';\n import { Patient } from '@medplum/fhirtypes';\n import { createPrivateKey, randomBytes } from 'crypto';\n import { SignJWT } from 'jose';\n import fetch from 'node-fetch';\n \n-export async function handler(medplum: MedplumClient, event: BotEvent): Promise<Patient | undefined> {\n-  const privateKeyString = event.secrets['EPIC_PRIVATE_KEY'].valueString;\n-  const clientId = event.secrets['EPIC_CLIENT_ID'].valueString;\n-  if (!privateKeyString || !clientId) {\n-    return undefined;\n+/**\n+ * Handles the logic for the Epic FHIR integration bot.\n+ *\n+ * @param medplum - The Medplum client\n+ * @param event - The BotEvent object\n+ *\n+ * @returns The Patient resource in Medplum\n+ */\n+export async function handler(medplum: MedplumClient, event: BotEvent<Patient>): Promise<Patient> {\n+  const clientId = event.secrets['EPIC_CLIENT_ID']?.valueString;\n+  if (!clientId) {\n+    throw new Error('Missing EPIC_CLIENT_ID');\n   }\n \n+  // Handles unknown issue with newlines in private key\n+  const privateKeyString = event.secrets['EPIC_PRIVATE_KEY']?.valueString?.replace(/\\\\n/g, '\\n');\n+  if (!privateKeyString) {\n+    throw new Error('Missing EPIC_PRIVATE_KEY');\n+  }\n+\n+  // TODO: Add a try/catch block\n   const privateKey = createPrivateKey(privateKeyString);\n   const baseUrl = 'https://fhir.epic.com/interconnect-fhir-oauth/';\n   const tokenUrl = 'https://fhir.epic.com/interconnect-fhir-oauth/oauth2/token';\n   const fhirUrlPath = 'api/FHIR/R4/';\n \n   // Construct Epic MedplumClient base\n-  const epicClient = new MedplumClient({\n+  const epic = new MedplumClient({\n     fetch,\n     baseUrl,\n     tokenUrl,\n@@ -37,19 +51,202 @@ export async function handler(medplum: MedplumClient, event: BotEvent): Promise<\n     .sign(privateKey);\n \n   // Start the JWT assertion login\n-  await epicClient.startJwtAssertionLogin(jwt);\n+  await epic.startJwtAssertionLogin(jwt);\n+\n+  const medplumPatient = event.input;\n+  const epicPatientId = getIdentifier(medplumPatient, 'http://open.epic.com/FHIR/StructureDefinition/patient-fhir-id');\n+\n+  if (!epicPatientId) {\n+    console.log('No Epic Patient ID found, creating patient in Epic');\n+    // If no Epic patient ID exists, create the patient in Epic\n+    return createEpicPatient(medplum, epic, medplumPatient);\n+  } else {\n+    console.log('Epic Patient ID found, syncing data from Epic to Medplum');\n+    // If an Epic patient ID exists, sync data from Epic to Medplum\n+    return syncEpicPatient(medplum, epic, medplumPatient, epicPatientId);\n+  }\n+}\n+\n+/**\n+ * Creates a patient in Epic\n+ *\n+ * @param medplum - The Medplum client\n+ * @param epic - The Epic client\n+ * @param medplumPatient - The Patient resource in Medplum\n+ *\n+ * @returns The Patient resource in Medplum\n+ */\n+async function createEpicPatient(\n+  medplum: MedplumClient,\n+  epic: MedplumClient,\n+  medplumPatient: Patient\n+): Promise<Patient> {\n+  const ssnIdentifier = getIdentifier(medplumPatient, 'http://hl7.org/fhir/sid/us-ssn');\n+  if (!ssnIdentifier) {\n+    throw new Error('SSN identifier is required to create a patient in Epic');\n+  }\n+\n+  // Destructure to omit id and meta before creating the resource in Epic\n+  const { id: _id, meta: _meta, ...patientToCreate } = medplumPatient;\n+\n+  // Epic requires the SSN identifier to be in the OID system\n+  patientToCreate.identifier = patientToCreate.identifier?.map((id) => {\n+    if (id.system === 'http://hl7.org/fhir/sid/us-ssn') {\n+      return {\n+        use: 'usual',\n+        system: 'urn:oid:2.16.840.1.113883.4.1',\n+        value: id.value,\n+      };\n+    }\n+\n+    return id;\n+  });\n+\n+  await epic.createResource<Patient>(patientToCreate);\n+  const epicPatient = await epic.searchOne('Patient', { identifier: ssnIdentifier });\n+\n+  if (!epicPatient) {\n+    throw new Error('Failed to create patient in Epic');\n+  }\n+\n+  medplumPatient.identifier ??= [];\n+  medplumPatient.identifier.push({\n+    system: 'http://open.epic.com/FHIR/StructureDefinition/patient-fhir-id',\n+    value: epicPatient.id,\n+  });\n+\n+  const updatedMedplumPatient = await medplum.updateResource(medplumPatient);\n+  return updatedMedplumPatient;\n+}\n+\n+/**\n+ * Syncs data from an existing Epic patient to Medplum\n+ *\n+ * @param medplum - The Medplum client\n+ * @param epic - The Epic client\n+ * @param medplumPatient - The Patient resource in Medplum\n+ * @param epicPatientId - The ID of the patient in Epic\n+ *\n+ * @returns The Patient resource in Medplum\n+ */\n+async function syncEpicPatient(\n+  medplum: MedplumClient,\n+  epic: MedplumClient,\n+  medplumPatient: Patient,\n+  epicPatientId: string\n+): Promise<Patient> {\n+  // Note that Epic ID and Medplum ID are different so that is why id is being removed\n+  // when performing the upsert below.\n+\n+  // Read the patient resource from Epic\n+  const epicPatient = await epic.readResource('Patient', epicPatientId);\n \n-  console.log('Logged in');\n+  // Upsert referenced resources first to ensure they exist in Medplum.\n+  if (epicPatient.managingOrganization?.reference) {\n+    const [orgResourceType, orgId] = epicPatient.managingOrganization.reference.split('/');\n+    if (orgResourceType === 'Organization' && orgId) {\n+      const epicOrganization = await epic.readResource('Organization', orgId);\n+      const npiIdentifier = getIdentifier(epicOrganization, 'http://hl7.org/fhir/sid/us-npi');\n+      const medplumOrganization = await medplum.upsertResource(\n+        { ...epicOrganization, id: undefined },\n+        {\n+          identifier: npiIdentifier,\n+        }\n+      );\n+      epicPatient.managingOrganization = createReference(medplumOrganization);\n+    }\n+  }\n \n-  // Read resource for Camila\n-  const camila = await epicClient.readResource('Patient', 'erXuFYUfucBZaryVksYEcMg3');\n+  if (epicPatient.generalPractitioner) {\n+    await Promise.all(\n+      epicPatient.generalPractitioner.map(async (gp) => {\n+        if (!gp?.reference) {\n+          return;\n+        }\n \n-  if (!camila) {\n-    throw new Error(`Failed to find any patients`);\n+        const epicPractitioner = await epic.readResource('Practitioner', resolveId(gp) as string);\n+        const npiIdentifier = getIdentifier(epicPractitioner, 'http://hl7.org/fhir/sid/us-npi');\n+        const medplumPractitioner = await medplum.upsertResource(\n+          { ...epicPractitioner, id: undefined },\n+          { identifier: npiIdentifier }\n+        );\n+        gp.reference = getReferenceString(medplumPractitioner);\n+      })\n+    );\n   }\n \n-  // Create resource for Camila in your Local Medplum repository\n-  await medplum.createResourceIfNoneExist(camila, 'identifier=erXuFYUfucBZaryVksYEcMg3');\n+  // Update the patient resource in Medplum with the Epic patient data\n+  const updatedMedplumPatient = await medplum.updateResource({ ...epicPatient, ...medplumPatient });\n+\n+  // Create resources that relate to the Patient Profile (e.g. allergies, medications)\n+  const epicAllergies = await epic.searchResources('AllergyIntolerance', { patient: epicPatientId });\n+  await Promise.all(\n+    epicAllergies.map(async (allergyIntolerance) => {\n+      const code = allergyIntolerance.code?.coding?.[0];\n+      if (!code) {\n+        return;\n+      }\n+      await medplum.upsertResource(\n+        { ...allergyIntolerance, id: undefined, patient: createReference(updatedMedplumPatient) },\n+        {\n+          patient: getReferenceString(updatedMedplumPatient),\n+          code: `${code.system}|${code.code}`,\n+        }\n+      );\n+    })\n+  );\n+\n+  const epicMedicationRequests = await epic.searchResources('MedicationRequest', { patient: epicPatientId });\n+  await Promise.all(\n+    epicMedicationRequests.map(async (medicationRequest) => {\n+      if (!medicationRequest.medicationReference?.reference) {\n+        return;\n+      }\n+\n+      const epicMedication = await epic.readResource(\n+        'Medication',\n+        resolveId(medicationRequest.medicationReference) as string\n+      );\n+\n+      const medplumMedication = await medplum.upsertResource(\n+        { ...epicMedication, id: undefined },\n+        { identifier: epicMedication.identifier?.[0].value }\n+      );\n+      medicationRequest.medicationReference = createReference(medplumMedication);\n+\n+      if (medicationRequest.requester) {\n+        const epicRequester = await epic.readResource('Practitioner', resolveId(medicationRequest.requester) as string);\n+        const npiIdentifier = getIdentifier(epicRequester, 'http://hl7.org/fhir/sid/us-npi');\n+        const medplumRequester = await medplum.upsertResource(\n+          { ...epicRequester, id: undefined },\n+          { identifier: npiIdentifier }\n+        );\n+        medicationRequest.requester = createReference(medplumRequester);\n+      }\n+\n+      if (medicationRequest.recorder) {\n+        const epicRecorder = await epic.readResource('Practitioner', resolveId(medicationRequest.recorder) as string);\n+        const npiIdentifier = getIdentifier(epicRecorder, 'http://hl7.org/fhir/sid/us-npi');\n+        const medplumRecorder = await medplum.upsertResource(\n+          { ...epicRecorder, id: undefined },\n+          { identifier: npiIdentifier }\n+        );\n+        medicationRequest.recorder = createReference(medplumRecorder);\n+      }\n \n-  return camila;\n+      await medplum.upsertResource(\n+        {\n+          ...medicationRequest,\n+          id: undefined,\n+          encounter: undefined, // To simplify the demo\n+          subject: createReference(updatedMedplumPatient),\n+        },\n+        {\n+          patient: getReferenceString(updatedMedplumPatient),\n+          identifier: medicationRequest.identifier?.[0].value,\n+        }\n+      );\n+    })\n+  );\n+  return updatedMedplumPatient;\n }\n",
    "test_patch": "diff --git a/examples/medplum-demo-bots/src/epic/epic-query-patient-test-data.ts b/examples/medplum-demo-bots/src/epic/epic-query-patient-test-data.ts\nnew file mode 100644\nindex 0000000000..c1554cfafc\n--- /dev/null\n+++ b/examples/medplum-demo-bots/src/epic/epic-query-patient-test-data.ts\n@@ -0,0 +1,777 @@\n+import {\n+  AllergyIntolerance,\n+  Medication,\n+  MedicationRequest,\n+  Organization,\n+  Patient,\n+  Practitioner,\n+} from '@medplum/fhirtypes';\n+\n+export const medplumPatientWithoutEpicIdentifier: Patient = {\n+  resourceType: 'Patient',\n+  identifier: [\n+    {\n+      system: 'http://hl7.org/fhir/sid/us-ssn',\n+      value: '444222222',\n+    },\n+  ],\n+  name: [\n+    {\n+      given: ['Jane'],\n+      family: 'California',\n+    },\n+  ],\n+  gender: 'female',\n+  birthDate: '1970-01-01',\n+  address: [\n+    {\n+      use: 'home',\n+      line: ['123 Main St.'],\n+      city: 'San Francisco',\n+      state: 'CA',\n+      postalCode: '98732',\n+    },\n+  ],\n+  telecom: [\n+    {\n+      system: 'phone',\n+      use: 'mobile',\n+      value: '555-325-6392',\n+    },\n+  ],\n+};\n+\n+export const epicOrganization: Organization = {\n+  resourceType: 'Organization',\n+  id: 'enRyWnSP963FYDpoks4NHOA3',\n+  identifier: [\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'EPIC',\n+      },\n+      system: 'urn:oid:1.2.840.114350.1.13.0.1.7.5.737384.61',\n+      value: '1627363736',\n+    },\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'NPI',\n+      },\n+      system: 'http://hl7.org/fhir/sid/us-npi',\n+      value: '1627363736',\n+    },\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'TAX',\n+      },\n+      system: 'urn:oid:2.16.840.1.113883.4.4',\n+      value: '112233445',\n+    },\n+    {\n+      use: 'usual',\n+      system: 'urn:oid:1.2.840.114350.1.13.0.1.7.2.696570',\n+      value: '10',\n+    },\n+  ],\n+  active: true,\n+  name: 'Epic Hospital System',\n+  address: [\n+    {\n+      line: ['123 Anywhere St.'],\n+      city: 'VERONA',\n+      state: 'Wisconsin',\n+      postalCode: '53593',\n+    },\n+  ],\n+};\n+\n+export const epicPractitioner: Practitioner = {\n+  resourceType: 'Practitioner',\n+  id: 'eM5CWtq15N0WJeuCet5bJlQ3',\n+  identifier: [\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'NPI',\n+      },\n+      system: 'http://hl7.org/fhir/sid/us-npi',\n+      value: '1627363736',\n+    },\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'INTERNAL',\n+      },\n+      system: 'urn:oid:1.2.840.114350.1.13.0.1.7.2.697780',\n+      value: '  FAMMD',\n+    },\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'EXTERNAL',\n+      },\n+      system: 'urn:oid:1.2.840.114350.1.13.0.1.7.2.697780',\n+      value: 'FAMMD',\n+    },\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'PROVID',\n+      },\n+      system: 'urn:oid:1.2.840.114350.1.13.0.1.7.5.737384.6',\n+      value: '1000',\n+    },\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'EPIC',\n+      },\n+      system: 'urn:oid:1.2.840.114350.1.13.0.1.7.5.737384.7',\n+      value: '207Q00000X',\n+    },\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'NPI',\n+      },\n+      system: 'urn:oid:1.2.840.114350.1.13.0.1.7.5.737384.60',\n+      value: '1627363736',\n+    },\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'Epic',\n+      },\n+      system: 'urn:oid:1.2.840.114350.1.13.0.1.7.5.737384.63',\n+      value: '6011',\n+    },\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'INTERNAL',\n+      },\n+      system: 'urn:oid:1.2.840.114350.1.13.0.1.7.2.836982',\n+      value: '   E1000',\n+    },\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'EXTERNAL',\n+      },\n+      system: 'urn:oid:1.2.840.114350.1.13.0.1.7.2.836982',\n+      value: 'E1000',\n+    },\n+  ],\n+  active: true,\n+  name: [\n+    {\n+      use: 'usual',\n+      text: 'Family Medicine Physician, MD',\n+      family: 'Family Medicine',\n+      given: ['Physician'],\n+    },\n+  ],\n+  gender: 'male',\n+  qualification: [\n+    {\n+      code: {\n+        coding: [\n+          {\n+            system: 'urn:oid:1.2.840.114350.1.13.0.1.7.4.836982.6000',\n+            code: '11',\n+            display: 'MD',\n+          },\n+        ],\n+        text: 'MD',\n+      },\n+    },\n+  ],\n+};\n+\n+export const epicPatient: Patient = {\n+  resourceType: 'Patient',\n+  id: 'erXuFYUfucBZaryVksYEcMg3',\n+  extension: [\n+    {\n+      valueCodeableConcept: {\n+        coding: [\n+          {\n+            system: 'urn:oid:1.2.840.114350.1.13.0.1.7.10.698084.130.657370.19999000',\n+            code: 'female',\n+            display: 'female',\n+          },\n+        ],\n+      },\n+      url: 'http://open.epic.com/FHIR/StructureDefinition/extension/legal-sex',\n+    },\n+    {\n+      valueCodeableConcept: {\n+        coding: [\n+          {\n+            system: 'urn:oid:1.2.840.114350.1.13.0.1.7.10.698084.130.657370.19999000',\n+            code: 'female',\n+            display: 'female',\n+          },\n+        ],\n+      },\n+      url: 'http://open.epic.com/FHIR/StructureDefinition/extension/sex-for-clinical-use',\n+    },\n+    {\n+      extension: [\n+        {\n+          valueCoding: {\n+            system: 'urn:oid:2.16.840.1.113883.6.238',\n+            code: '2131-1',\n+            display: 'Other Race',\n+          },\n+          url: 'ombCategory',\n+        },\n+        {\n+          valueString: 'Other',\n+          url: 'text',\n+        },\n+      ],\n+      url: 'http://hl7.org/fhir/us/core/StructureDefinition/us-core-race',\n+    },\n+    {\n+      extension: [\n+        {\n+          valueString: 'Unknown',\n+          url: 'text',\n+        },\n+      ],\n+      url: 'http://hl7.org/fhir/us/core/StructureDefinition/us-core-ethnicity',\n+    },\n+    {\n+      valueCode: '248152002',\n+      url: 'http://hl7.org/fhir/us/core/StructureDefinition/us-core-sex',\n+    },\n+    {\n+      valueCodeableConcept: {\n+        coding: [\n+          {\n+            system: 'http://loinc.org',\n+            code: 'LA29519-8',\n+            display: 'she/her/her/hers/herself',\n+          },\n+        ],\n+      },\n+      url: 'http://open.epic.com/FHIR/StructureDefinition/extension/calculated-pronouns-to-use-for-text',\n+    },\n+  ],\n+  identifier: [\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'CEID',\n+      },\n+      system: 'urn:oid:1.2.840.114350.1.13.0.1.7.3.688884.100',\n+      value: 'FHR5GKH2C4H5HWP',\n+    },\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'EPIC',\n+      },\n+      system: 'urn:oid:1.2.840.114350.1.13.0.1.7.5.737384.0',\n+      value: 'E4007',\n+    },\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'EXTERNAL',\n+      },\n+      system: 'urn:oid:1.2.840.114350.1.13.0.1.7.2.698084',\n+      value: 'Z6129',\n+    },\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'FHIR',\n+      },\n+      system: 'http://open.epic.com/FHIR/StructureDefinition/patient-dstu2-fhir-id',\n+      value: 'TnOZ.elPXC6zcBNFMcFA7A5KZbYxo2.4T-LylRk4GoW4B',\n+    },\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'FHIR STU3',\n+      },\n+      system: 'http://open.epic.com/FHIR/StructureDefinition/patient-fhir-id',\n+      value: 'erXuFYUfucBZaryVksYEcMg3',\n+    },\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'INTERNAL',\n+      },\n+      system: 'urn:oid:1.2.840.114350.1.13.0.1.7.2.698084',\n+      value: '     Z6129',\n+    },\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'EPI',\n+      },\n+      system: 'urn:oid:1.2.840.114350.1.13.0.1.7.5.737384.14',\n+      value: '203713',\n+    },\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'MYCHARTLOGIN',\n+      },\n+      system: 'urn:oid:1.2.840.114350.1.13.0.1.7.3.878082.110',\n+      value: 'FHIRCAMILA',\n+    },\n+    {\n+      use: 'usual',\n+      type: {\n+        text: 'WPRINTERNAL',\n+      },\n+      system: 'urn:oid:1.2.840.114350.1.13.0.1.7.2.878082',\n+      value: '736',\n+    },\n+  ],\n+  active: true,\n+  name: [\n+    {\n+      use: 'official',\n+      text: 'Camila Maria Lopez',\n+      family: 'Lopez',\n+      given: ['Camila', 'Maria'],\n+    },\n+    {\n+      use: 'usual',\n+      text: 'Camila Maria Lopez',\n+      family: 'Lopez',\n+      given: ['Camila', 'Maria'],\n+    },\n+  ],\n+  telecom: [\n+    {\n+      system: 'phone',\n+      value: '469-555-5555',\n+      use: 'home',\n+      rank: 1,\n+    },\n+    {\n+      system: 'phone',\n+      value: '469-888-8888',\n+      use: 'work',\n+      rank: 2,\n+    },\n+    {\n+      system: 'phone',\n+      value: '469-469-4321',\n+      use: 'mobile',\n+      rank: 3,\n+    },\n+    {\n+      system: 'email',\n+      value: 'jmurugasamy@siddhaai.com',\n+      rank: 1,\n+    },\n+    {\n+      system: 'email',\n+      value: 'knixontestemail@epic.com',\n+    },\n+  ],\n+  gender: 'female',\n+  birthDate: '1987-09-12',\n+  deceasedBoolean: false,\n+  address: [\n+    {\n+      use: 'home',\n+      line: ['3268 West Johnson St.', 'Apt 117'],\n+      city: 'GARLAND',\n+      district: 'DALLAS',\n+      state: 'TX',\n+      postalCode: '75043',\n+      country: 'US',\n+      period: {\n+        start: '2019-05-24',\n+      },\n+    },\n+    {\n+      use: 'old',\n+      line: ['3268 West Johnson St.', 'Apt 117'],\n+      city: 'GARLAND',\n+      district: 'DALLAS',\n+      state: 'TX',\n+      postalCode: '75043',\n+      country: 'US',\n+    },\n+  ],\n+  maritalStatus: {\n+    text: 'Married',\n+  },\n+  communication: [\n+    {\n+      language: {\n+        coding: [\n+          {\n+            system: 'urn:ietf:bcp:47',\n+            code: 'en',\n+            display: 'English',\n+          },\n+        ],\n+        text: 'English',\n+      },\n+      preferred: true,\n+    },\n+  ],\n+  generalPractitioner: [\n+    {\n+      reference: 'Practitioner/eM5CWtq15N0WJeuCet5bJlQ3',\n+      type: 'Practitioner',\n+      display: 'Physician Family Medicine, MD',\n+    },\n+  ],\n+  managingOrganization: {\n+    reference: 'Organization/enRyWnSP963FYDpoks4NHOA3',\n+    display: 'Epic Hospital System',\n+  },\n+};\n+\n+export const epicAllergyIntolerance: AllergyIntolerance = {\n+  resourceType: 'AllergyIntolerance',\n+  id: 'eARZpey6BWRZxRZkRpc8OFJ46j3QOFrduk77hYQKWRQnp6GRlpYc2I3BfUN6pz4Anz77ow8.GJh54fUVfm3O8Vw3',\n+  clinicalStatus: {\n+    coding: [\n+      {\n+        system: 'http://terminology.hl7.org/CodeSystem/allergyintolerance-clinical',\n+        version: '4.0.0',\n+        code: 'active',\n+        display: 'Active',\n+      },\n+    ],\n+  },\n+  verificationStatus: {\n+    coding: [\n+      {\n+        system: 'http://terminology.hl7.org/CodeSystem/allergyintolerance-verification',\n+        version: '4.0.0',\n+        code: 'unconfirmed',\n+        display: 'Unconfirmed',\n+      },\n+    ],\n+  },\n+  code: {\n+    coding: [\n+      {\n+        system: 'http://snomed.info/sct',\n+        code: '1631000175102',\n+        display: 'Patient not asked',\n+      },\n+    ],\n+    text: 'Not on File',\n+  },\n+  patient: {\n+    reference: 'Patient/erXuFYUfucBZaryVksYEcMg3',\n+    display: 'Lopez, Camila Maria',\n+  },\n+};\n+\n+export const epicMedication: Medication = {\n+  resourceType: 'Medication',\n+  id: 'ej-bgums0x4N6E0.QqIjJb3kGhOQBVK3lIYjcil9mb9j-ukNrz6P2y90AiDm3R20Y3',\n+  identifier: [\n+    {\n+      use: 'usual',\n+      system: 'urn:oid:1.2.840.114350.1.13.0.1.7.2.698288',\n+      value: '70784',\n+    },\n+  ],\n+  code: {\n+    coding: [\n+      {\n+        system: 'urn:oid:2.16.840.1.113883.6.253',\n+        code: '100899',\n+      },\n+      {\n+        system: 'urn:oid:2.16.840.1.113883.6.68',\n+        code: '25990002150316',\n+      },\n+      {\n+        system: 'urn:oid:2.16.840.1.113883.6.162',\n+        code: '49431',\n+      },\n+      {\n+        system: 'http://www.nlm.nih.gov/research/umls/rxnorm',\n+        code: '4124',\n+      },\n+      {\n+        system: 'http://www.nlm.nih.gov/research/umls/rxnorm',\n+        code: '11636',\n+      },\n+      {\n+        system: 'http://www.nlm.nih.gov/research/umls/rxnorm',\n+        code: '630734',\n+      },\n+      {\n+        system: 'http://www.nlm.nih.gov/research/umls/rxnorm',\n+        code: '748794',\n+      },\n+      {\n+        system: 'http://www.nlm.nih.gov/research/umls/rxnorm',\n+        code: '748798',\n+      },\n+      {\n+        system: 'http://www.nlm.nih.gov/research/umls/rxnorm',\n+        code: '840781',\n+      },\n+    ],\n+    text: 'drospirenone-ethinyl estradiol (YAZ,GIANVI) tablet 3-0.02 mg',\n+  },\n+  form: {\n+    coding: [\n+      {\n+        system: 'urn:oid:1.2.840.114350.1.13.0.1.7.4.698288.310',\n+        code: 'TABS',\n+        display: 'tablet',\n+      },\n+    ],\n+    text: 'tablet',\n+  },\n+  ingredient: [\n+    {\n+      itemCodeableConcept: {\n+        coding: [\n+          {\n+            system: 'urn:oid:2.16.840.1.113883.6.253',\n+            code: '100899',\n+          },\n+          {\n+            system: 'urn:oid:2.16.840.1.113883.6.68',\n+            code: '25990002150316',\n+          },\n+          {\n+            system: 'urn:oid:2.16.840.1.113883.6.162',\n+            code: '49431',\n+          },\n+          {\n+            system: 'http://www.nlm.nih.gov/research/umls/rxnorm',\n+            code: '4124',\n+          },\n+          {\n+            system: 'http://www.nlm.nih.gov/research/umls/rxnorm',\n+            code: '11636',\n+          },\n+          {\n+            system: 'http://www.nlm.nih.gov/research/umls/rxnorm',\n+            code: '630734',\n+          },\n+          {\n+            system: 'http://www.nlm.nih.gov/research/umls/rxnorm',\n+            code: '748794',\n+          },\n+          {\n+            system: 'http://www.nlm.nih.gov/research/umls/rxnorm',\n+            code: '748798',\n+          },\n+          {\n+            system: 'http://www.nlm.nih.gov/research/umls/rxnorm',\n+            code: '840781',\n+          },\n+        ],\n+        text: 'drospirenone-ethinyl estradiol (YAZ,GIANVI) tablet 3-0.02 mg',\n+      },\n+    },\n+  ],\n+};\n+\n+export const epicMedicationRequest: MedicationRequest = {\n+  resourceType: 'MedicationRequest',\n+  id: 'ePDJ.zsf3Jfg2.MKkAMgW9EcIbsaiB.y-OTrPS5v2h8Q3',\n+  identifier: [\n+    {\n+      use: 'usual',\n+      system: 'urn:oid:1.2.840.114350.1.13.0.1.7.2.798268',\n+      value: '1066899',\n+    },\n+  ],\n+  status: 'active',\n+  intent: 'order',\n+  category: [\n+    {\n+      coding: [\n+        {\n+          system: 'http://terminology.hl7.org/CodeSystem/medicationrequest-category',\n+          code: 'community',\n+          display: 'Community',\n+        },\n+      ],\n+      text: 'Community',\n+    },\n+  ],\n+  medicationReference: {\n+    reference: 'Medication/ej-bgums0x4N6E0.QqIjJb3kGhOQBVK3lIYjcil9mb9j-ukNrz6P2y90AiDm3R20Y3',\n+    display: 'drospirenone-ethinyl estradiol (YAZ,GIANVI) tablet 3-0.02 mg',\n+  },\n+  subject: {\n+    reference: 'Patient/erXuFYUfucBZaryVksYEcMg3',\n+    display: 'Lopez, Camila Maria',\n+  },\n+  authoredOn: '2019-05-28',\n+  requester: {\n+    reference: 'Practitioner/eM5CWtq15N0WJeuCet5bJlQ3',\n+    type: 'Practitioner',\n+    display: 'Physician Family Medicine, MD',\n+  },\n+  recorder: {\n+    reference: 'Practitioner/eM5CWtq15N0WJeuCet5bJlQ3',\n+    type: 'Practitioner',\n+    display: 'Physician Family Medicine, MD',\n+  },\n+  reasonCode: [\n+    {\n+      coding: [\n+        {\n+          system: 'http://snomed.info/sct',\n+          code: '69878008',\n+          display: 'Polycystic ovaries (disorder)',\n+        },\n+        {\n+          system: 'http://hl7.org/fhir/sid/icd-9-cm',\n+          code: '256.4',\n+          display: 'Polycystic ovaries',\n+        },\n+        {\n+          system: 'http://hl7.org/fhir/sid/icd-10-cm',\n+          code: 'E28.2',\n+          display: 'Polycystic ovarian syndrome',\n+        },\n+      ],\n+      text: 'PCOS (polycystic ovarian syndrome)',\n+    },\n+  ],\n+  courseOfTherapyType: {\n+    coding: [\n+      {\n+        system: 'http://terminology.hl7.org/CodeSystem/medicationrequest-course-of-therapy',\n+        code: 'continuous',\n+        display: 'Continuous long term therapy',\n+      },\n+    ],\n+    text: 'Continuous long term therapy',\n+  },\n+  dosageInstruction: [\n+    {\n+      text: 'Take 1 tablet by mouth 1 (one) time each day., Starting Tue 5/28/2019, Until Wed 5/27/2020, Normal',\n+      patientInstruction: 'Take 1 tablet by mouth 1 (one) time each day.',\n+      timing: {\n+        repeat: {\n+          boundsPeriod: {\n+            start: '2019-05-28',\n+          },\n+          count: 365,\n+          timeOfDay: ['09:00:00'],\n+        },\n+        code: {\n+          text: '0900',\n+        },\n+      },\n+      asNeededBoolean: false,\n+      route: {\n+        coding: [\n+          {\n+            system: 'http://snomed.info/sct',\n+            code: '260548002',\n+            display: 'Oral (qualifier value)',\n+          },\n+          {\n+            system: 'urn:oid:1.2.840.114350.1.13.0.1.7.4.798268.7025',\n+            code: '15',\n+            display: 'Oral',\n+          },\n+        ],\n+        text: 'Oral',\n+      },\n+      method: {\n+        coding: [\n+          {\n+            system: 'http://snomed.info/sct',\n+            code: '419652001',\n+            display: 'Take',\n+          },\n+        ],\n+        text: 'Take',\n+      },\n+      doseAndRate: [\n+        {\n+          type: {\n+            coding: [\n+              {\n+                system: 'http://epic.com/CodeSystem/dose-rate-type',\n+                code: 'calculated',\n+                display: 'calculated',\n+              },\n+            ],\n+            text: 'calculated',\n+          },\n+          doseQuantity: {\n+            value: 1,\n+            unit: 'tablet',\n+            system: 'http://unitsofmeasure.org',\n+            code: '{tbl}',\n+          },\n+        },\n+        {\n+          type: {\n+            coding: [\n+              {\n+                system: 'http://epic.com/CodeSystem/dose-rate-type',\n+                code: 'admin-amount',\n+                display: 'admin-amount',\n+              },\n+            ],\n+            text: 'admin-amount',\n+          },\n+          doseQuantity: {\n+            value: 1,\n+            unit: 'tablet',\n+            system: 'http://unitsofmeasure.org',\n+            code: '{tbl}',\n+          },\n+        },\n+        {\n+          type: {\n+            coding: [\n+              {\n+                system: 'http://epic.com/CodeSystem/dose-rate-type',\n+                code: 'ordered',\n+                display: 'ordered',\n+              },\n+            ],\n+            text: 'ordered',\n+          },\n+          doseQuantity: {\n+            value: 1,\n+            unit: 'tablet',\n+            system: 'http://unitsofmeasure.org',\n+            code: '{tbl}',\n+          },\n+        },\n+      ],\n+    },\n+  ],\n+  dispenseRequest: {\n+    validityPeriod: {\n+      start: '2019-05-28',\n+    },\n+    numberOfRepeatsAllowed: 12,\n+    quantity: {\n+      value: 28,\n+      unit: 'tablet',\n+    },\n+    expectedSupplyDuration: {\n+      value: 28,\n+      unit: 'Day',\n+      system: 'http://unitsofmeasure.org',\n+      code: 'd',\n+    },\n+  },\n+};\n\ndiff --git a/examples/medplum-demo-bots/src/epic/epic-query-patient.test.ts b/examples/medplum-demo-bots/src/epic/epic-query-patient.test.ts\nnew file mode 100644\nindex 0000000000..4d64cb8053\n--- /dev/null\n+++ b/examples/medplum-demo-bots/src/epic/epic-query-patient.test.ts\n@@ -0,0 +1,301 @@\n+import {\n+  getIdentifier,\n+  getReferenceString,\n+  indexSearchParameterBundle,\n+  indexStructureDefinitionBundle,\n+  resolveId,\n+} from '@medplum/core';\n+import { readJson, SEARCH_PARAMETER_BUNDLE_FILES } from '@medplum/definitions';\n+import { MockClient } from '@medplum/mock';\n+import { Patient, Bundle, SearchParameter, Resource, AllergyIntolerance, MedicationRequest } from '@medplum/fhirtypes';\n+import { generateKeyPairSync } from 'crypto';\n+import { Mock } from 'vitest';\n+import fetch from 'node-fetch';\n+import { handler } from './epic-query-patient';\n+import {\n+  medplumPatientWithoutEpicIdentifier,\n+  epicAllergyIntolerance,\n+  epicMedication,\n+  epicMedicationRequest,\n+  epicOrganization,\n+  epicPatient,\n+  epicPractitioner,\n+} from './epic-query-patient-test-data';\n+\n+vi.mock('node-fetch');\n+\n+describe('Epic Query Patient Bot', () => {\n+  let medplum: MockClient;\n+  let input: Patient;\n+\n+  const bot = { reference: 'Bot/123' };\n+  const contentType = 'application/fhir+json';\n+  const { privateKey } = generateKeyPairSync('rsa', {\n+    modulusLength: 2048,\n+    publicKeyEncoding: { type: 'spki', format: 'pem' },\n+    privateKeyEncoding: { type: 'pkcs8', format: 'pem' },\n+  });\n+  const secrets = {\n+    EPIC_PRIVATE_KEY: { name: 'EPIC_PRIVATE_KEY', valueString: privateKey },\n+    EPIC_CLIENT_ID: { name: 'EPIC_CLIENT_ID', valueString: 'test-client-id' },\n+  };\n+\n+  beforeAll(() => {\n+    indexStructureDefinitionBundle(readJson('fhir/r4/profiles-types.json') as Bundle);\n+    indexStructureDefinitionBundle(readJson('fhir/r4/profiles-resources.json') as Bundle);\n+    indexStructureDefinitionBundle(readJson('fhir/r4/profiles-medplum.json') as Bundle);\n+    for (const filename of SEARCH_PARAMETER_BUNDLE_FILES) {\n+      indexSearchParameterBundle(readJson(filename) as Bundle<SearchParameter>);\n+    }\n+  });\n+\n+  beforeEach(async () => {\n+    vi.resetAllMocks();\n+    (fetch as unknown as Mock).mockClear();\n+    medplum = new MockClient();\n+    input = await medplum.createResource({\n+      ...medplumPatientWithoutEpicIdentifier,\n+    });\n+  });\n+\n+  function createSearchSetBundle<T extends Resource>(...resources: T[]): Bundle<T> {\n+    return {\n+      resourceType: 'Bundle',\n+      type: 'searchset',\n+      total: resources.length,\n+      entry: resources.map((resource) => ({ resource })),\n+    };\n+  }\n+\n+  test('throws error when missing EPIC_CLIENT_ID', async () => {\n+    await expect(\n+      handler(medplum, {\n+        bot,\n+        input,\n+        secrets: { EPIC_PRIVATE_KEY: secrets.EPIC_PRIVATE_KEY },\n+        contentType,\n+      })\n+    ).rejects.toThrow('Missing EPIC_CLIENT_ID');\n+  });\n+\n+  test('throws error when missing EPIC_PRIVATE_KEY', async () => {\n+    await expect(\n+      handler(medplum, {\n+        bot,\n+        input,\n+        secrets: { EPIC_CLIENT_ID: secrets.EPIC_CLIENT_ID },\n+        contentType,\n+      })\n+    ).rejects.toThrow('Missing EPIC_PRIVATE_KEY');\n+  });\n+\n+  test('successfully syncs an existing Epic patient and related resources to Medplum', async () => {\n+    input = await medplum.createResource({\n+      ...medplumPatientWithoutEpicIdentifier,\n+      identifier: [\n+        {\n+          system: 'http://open.epic.com/FHIR/StructureDefinition/patient-fhir-id',\n+          value: 'epic-patient-123',\n+        },\n+      ],\n+    });\n+\n+    (fetch as unknown as Mock).mockImplementation(async (url: string, options?: any): Promise<any> => {\n+      const { Response } = await vi.importActual<{ Response: any }>('node-fetch');\n+      const urlString = url.toString();\n+      console.log(`Mock Fetch: API request to ${urlString} with options: ${JSON.stringify(options)}`);\n+\n+      if (urlString.includes('/oauth2/token')) {\n+        return new Response(JSON.stringify({ access_token: 'mock-epic-access-token', expires_in: 300 }), {\n+          status: 200,\n+          headers: { 'Content-Type': 'application/json' },\n+        });\n+      }\n+\n+      if (!options?.headers?.Authorization?.startsWith('Bearer ')) {\n+        return new Response(JSON.stringify({ message: 'Unauthorized' }), { status: 401 });\n+      }\n+\n+      if (urlString.endsWith('/api/FHIR/R4/Patient/epic-patient-123')) {\n+        return new Response(JSON.stringify(epicPatient), {\n+          status: 200,\n+          headers: { 'Content-Type': 'application/fhir+json' },\n+        });\n+      }\n+      if (urlString.includes('/api/FHIR/R4/Organization/') && urlString.endsWith(epicOrganization.id ?? '')) {\n+        return new Response(JSON.stringify(epicOrganization), {\n+          status: 200,\n+          headers: { 'Content-Type': 'application/fhir+json' },\n+        });\n+      }\n+      if (urlString.includes('/api/FHIR/R4/Practitioner/') && urlString.endsWith(epicPractitioner.id ?? '')) {\n+        return new Response(JSON.stringify(epicPractitioner), {\n+          status: 200,\n+          headers: { 'Content-Type': 'application/fhir+json' },\n+        });\n+      }\n+      if (urlString.includes('/api/FHIR/R4/AllergyIntolerance?patient=epic-patient-123')) {\n+        const bundle = createSearchSetBundle<AllergyIntolerance>(epicAllergyIntolerance);\n+        return new Response(JSON.stringify(bundle), {\n+          status: 200,\n+          headers: { 'Content-Type': 'application/fhir+json' },\n+        });\n+      }\n+      if (urlString.includes('/api/FHIR/R4/MedicationRequest?patient=epic-patient-123')) {\n+        const bundle = createSearchSetBundle<MedicationRequest>(epicMedicationRequest);\n+        return new Response(JSON.stringify(bundle), {\n+          status: 200,\n+          headers: { 'Content-Type': 'application/fhir+json' },\n+        });\n+      }\n+      if (urlString.includes('/api/FHIR/R4/Medication/') && urlString.endsWith(epicMedication.id ?? '')) {\n+        return new Response(JSON.stringify(epicMedication), {\n+          status: 200,\n+          headers: { 'Content-Type': 'application/fhir+json' },\n+        });\n+      }\n+\n+      console.error(`Mock Fetch: Unhandled URL: ${urlString}`);\n+      return new Response(JSON.stringify({ message: 'Not Found in Mock' }), { status: 404 });\n+    });\n+\n+    const patient = await handler(medplum, {\n+      bot,\n+      input,\n+      secrets,\n+      contentType,\n+    });\n+\n+    expect(patient).toBeDefined();\n+    expect(patient?.resourceType).toStrictEqual('Patient');\n+    expect(\n+      getIdentifier(patient as Patient, 'http://open.epic.com/FHIR/StructureDefinition/patient-fhir-id')\n+    ).toStrictEqual('epic-patient-123');\n+\n+    // managingOrganization\n+    expect(patient?.managingOrganization).toBeDefined();\n+    const managingOrganization = await medplum.readResource(\n+      'Organization',\n+      resolveId(patient?.managingOrganization) as string\n+    );\n+    expect(managingOrganization).toBeDefined();\n+    expect(getIdentifier(managingOrganization, 'http://hl7.org/fhir/sid/us-npi')).toStrictEqual(\n+      getIdentifier(epicOrganization, 'http://hl7.org/fhir/sid/us-npi')\n+    );\n+\n+    // generalPractitioner\n+    expect(patient?.generalPractitioner).toHaveLength(1);\n+    const generalPractitioner = await medplum.readResource(\n+      'Practitioner',\n+      resolveId(patient?.generalPractitioner?.[0]) as string\n+    );\n+    expect(generalPractitioner).toBeDefined();\n+    expect(getIdentifier(generalPractitioner, 'http://hl7.org/fhir/sid/us-npi')).toStrictEqual(\n+      getIdentifier(epicPractitioner, 'http://hl7.org/fhir/sid/us-npi')\n+    );\n+\n+    // allergies\n+    const allergies = await medplum.searchResources('AllergyIntolerance', {\n+      patient: getReferenceString(patient),\n+    });\n+    expect(allergies).toHaveLength(1);\n+    expect(allergies[0].code?.coding?.[0].code).toStrictEqual(epicAllergyIntolerance.code?.coding?.[0].code);\n+\n+    // medicationRequests\n+    const medRequests = await medplum.searchResources('MedicationRequest', {\n+      patient: getReferenceString(patient),\n+    });\n+    expect(medRequests).toHaveLength(1);\n+    expect(medRequests[0].medicationReference).toBeDefined();\n+\n+    const medication = await medplum.readResource(\n+      'Medication',\n+      resolveId(medRequests[0].medicationReference) as string\n+    );\n+    expect(medication.code?.coding?.[0].code).toStrictEqual(epicMedication.code?.coding?.[0].code);\n+  });\n+\n+  test('successfully creates a new Epic patient when one does not exist', async () => {\n+    const ssn = getIdentifier(medplumPatientWithoutEpicIdentifier, 'http://hl7.org/fhir/sid/us-ssn');\n+    const newEpicPatientId = 'new-epic-patient-456';\n+\n+    (fetch as unknown as Mock).mockImplementation(async (url: string, options?: any): Promise<any> => {\n+      const { Response } = await vi.importActual<{ Response: any }>('node-fetch');\n+      const urlString = url.toString();\n+      const parsedUrl = new URL(urlString);\n+      console.log(`Mock Fetch: API request to ${urlString} with options: ${JSON.stringify(options)}`);\n+\n+      if (urlString.includes('/oauth2/token')) {\n+        return new Response(JSON.stringify({ access_token: 'mock-epic-access-token', expires_in: 300 }), {\n+          status: 200,\n+          headers: { 'Content-Type': 'application/json' },\n+        });\n+      }\n+\n+      if (!options?.headers?.Authorization?.startsWith('Bearer ')) {\n+        return new Response(JSON.stringify({ message: 'Unauthorized' }), { status: 401 });\n+      }\n+\n+      // Mock POST to create patient\n+      if (parsedUrl.pathname.endsWith('/api/FHIR/R4/Patient') && options?.method === 'POST') {\n+        // Check if the SSN identifier system was correctly changed to OID\n+        const body = JSON.parse(options.body);\n+        const ssnIdentifier = body.identifier?.find((id: any) => id.value === ssn);\n+        expect(ssnIdentifier?.system).toBe('urn:oid:2.16.840.1.113883.4.1');\n+\n+        return new Response(null, {\n+          status: 201, // Created\n+          headers: { Location: `/api/FHIR/R4/Patient/${newEpicPatientId}` },\n+        });\n+      }\n+\n+      // Mock GET search for patient by SSN value only (as generated by searchOne)\n+      if (\n+        parsedUrl.pathname.endsWith('/api/FHIR/R4/Patient') &&\n+        options?.method === 'GET' &&\n+        parsedUrl.searchParams.get('identifier') === ssn &&\n+        parsedUrl.searchParams.get('_count') === '1'\n+      ) {\n+        // Return the patient, assigning the new Epic ID\n+        const bundle = createSearchSetBundle<Patient>({\n+          ...epicPatient, // Use the base epic patient data\n+          id: newEpicPatientId, // Assign the ID expected after creation\n+          identifier: [\n+            // Ensure identifiers match what Epic might return (including OID SSN)\n+            ...(epicPatient.identifier?.filter((id) => id.system !== 'http://hl7.org/fhir/sid/us-ssn') ?? []),\n+            { system: 'urn:oid:2.16.840.1.113883.4.1', value: ssn },\n+            { system: 'http://open.epic.com/FHIR/StructureDefinition/patient-fhir-id', value: newEpicPatientId },\n+          ],\n+        });\n+        return new Response(JSON.stringify(bundle), {\n+          status: 200,\n+          headers: { 'Content-Type': 'application/fhir+json' },\n+        });\n+      }\n+\n+      console.error(`Mock Fetch: Unhandled URL: ${urlString}`);\n+      return new Response(JSON.stringify({ message: 'Not Found in Mock' }), { status: 404 });\n+    });\n+\n+    // Input patient does not have an Epic identifier, but has SSN\n+    expect(getIdentifier(medplumPatientWithoutEpicIdentifier, 'http://hl7.org/fhir/sid/us-ssn')).toBeDefined();\n+    expect(getIdentifier(input, 'http://open.epic.com/FHIR/StructureDefinition/patient-fhir-id')).toBeUndefined();\n+\n+    const patient = await handler(medplum, {\n+      bot,\n+      input,\n+      secrets,\n+      contentType,\n+    });\n+\n+    expect(patient).toBeDefined();\n+    expect(patient?.resourceType).toStrictEqual('Patient');\n+\n+    // Verify the new Epic identifier was added to the Medplum patient\n+    expect(patient.identifier).toHaveLength(2);\n+    expect(getIdentifier(patient, 'http://hl7.org/fhir/sid/us-ssn')).toStrictEqual(ssn);\n+    expect(getIdentifier(patient, 'http://open.epic.com/FHIR/StructureDefinition/patient-fhir-id')).toStrictEqual(\n+      newEpicPatientId\n+    );\n+  });\n+});\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6357",
    "pr_id": 6357,
    "issue_id": 6356,
    "repo": "medplum/medplum",
    "problem_statement": "Prevent upgrading agent when already on specified version\nThe agent should no-op whenever it's already on the version that has been requested, unless the operation has been called with the `force` argument",
    "issue_word_count": 34,
    "test_files_count": 3,
    "non_test_files_count": 4,
    "pr_changed_files": [
      "packages/agent/src/app.test.ts",
      "packages/agent/src/app.ts",
      "packages/core/src/agent.ts",
      "packages/server/src/fhir/operations/agentupgrade.test.ts",
      "packages/server/src/fhir/operations/agentupgrade.ts",
      "packages/server/src/fhir/operations/utils/parameters.test.ts",
      "packages/server/src/fhir/operations/utils/parameters.ts"
    ],
    "pr_changed_test_files": [
      "packages/agent/src/app.test.ts",
      "packages/server/src/fhir/operations/agentupgrade.test.ts",
      "packages/server/src/fhir/operations/utils/parameters.test.ts"
    ],
    "base_commit": "9d79f97424fd62842e3942682357278f12ca9ac6",
    "head_commit": "990b6cf0f34c22125a35817e6dfeaca8e3ac4cef",
    "repo_url": "https://github.com/medplum/medplum/pull/6357",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6357",
    "dockerfile": "",
    "pr_merged_at": "2025-04-13T04:55:05.000Z",
    "patch": "diff --git a/packages/agent/src/app.ts b/packages/agent/src/app.ts\nindex 022034d580..9319acf556 100644\n--- a/packages/agent/src/app.ts\n+++ b/packages/agent/src/app.ts\n@@ -612,6 +612,26 @@ export class App {\n       return;\n     }\n \n+    const targetVersion = message.version ?? (await fetchLatestVersionString('agent-upgrader'));\n+\n+    // MEDPLUM_VERSION contains major.minor.patch-commit_hash\n+    if (MEDPLUM_VERSION.startsWith(targetVersion)) {\n+      // If we are forcing an upgrade, we can still upgrade to a version that we're already on\n+      // This is mostly if you somehow installed a version that was not released but installed manually\n+      // This will get you on the official release version for the given semver\n+      if (!message?.force) {\n+        this.log.info(`Attempted to upgrade to version ${targetVersion}, but agent is already on that version`);\n+        await this.sendToWebSocket({\n+          type: 'agent:upgrade:response',\n+          statusCode: 200,\n+          callback: message.callback,\n+        } satisfies AgentUpgradeResponse);\n+        return;\n+      }\n+\n+      this.log.info(`Forcing upgrade from ${MEDPLUM_VERSION} to ${targetVersion}`);\n+    }\n+\n     try {\n       const command = __filename;\n       const logFile = openSync(UPGRADER_LOG_PATH, 'w+');\n@@ -655,8 +675,6 @@ export class App {\n       this.log.info('Successfully stopped agent network services');\n \n       // Write a manifest file\n-      const targetVersion = message.version ?? (await fetchLatestVersionString('agent-upgrader'));\n-\n       this.log.info('Writing upgrade manifest...', { previousVersion: MEDPLUM_VERSION, targetVersion });\n       writeFileSync(\n         UPGRADE_MANIFEST_PATH,\n\ndiff --git a/packages/core/src/agent.ts b/packages/core/src/agent.ts\nindex 4d9a09c59b..566f2d8e7e 100644\n--- a/packages/core/src/agent.ts\n+++ b/packages/core/src/agent.ts\n@@ -59,6 +59,7 @@ export interface AgentReloadConfigResponse extends BaseAgentMessage {\n export interface AgentUpgradeRequest extends BaseAgentRequestMessage {\n   type: 'agent:upgrade:request';\n   version?: string;\n+  force?: boolean;\n }\n \n export interface AgentUpgradeResponse extends BaseAgentMessage {\n\ndiff --git a/packages/server/src/fhir/operations/agentupgrade.ts b/packages/server/src/fhir/operations/agentupgrade.ts\nindex 9f18ce54fa..7fc6eae33b 100644\n--- a/packages/server/src/fhir/operations/agentupgrade.ts\n+++ b/packages/server/src/fhir/operations/agentupgrade.ts\n@@ -1,14 +1,8 @@\n-import {\n-  AgentUpgradeResponse,\n-  OperationOutcomeError,\n-  WithId,\n-  badRequest,\n-  serverError,\n-  singularize,\n-} from '@medplum/core';\n+import { AgentUpgradeResponse, OperationOutcomeError, WithId, badRequest, serverError } from '@medplum/core';\n import { FhirRequest, FhirResponse } from '@medplum/fhir-router';\n import { Agent, OperationDefinition } from '@medplum/fhirtypes';\n import { handleBulkAgentOperation, publishAgentRequest } from './utils/agentutils';\n+import { parseInputParameters } from './utils/parameters';\n \n const DEFAULT_UPGRADE_TIMEOUT = 45000;\n const MAX_UPGRADE_TIMEOUT = 56000;\n@@ -27,6 +21,7 @@ export const operation: OperationDefinition = {\n   parameter: [\n     { use: 'in', name: 'version', type: 'string', min: 0, max: '1' },\n     { use: 'in', name: 'timeout', type: 'integer', min: 0, max: '1' },\n+    { use: 'in', name: 'force', type: 'boolean', min: 0, max: '1' },\n     { use: 'out', name: 'return', type: 'Bundle', min: 1, max: '1' },\n   ],\n };\n@@ -42,27 +37,17 @@ export const operation: OperationDefinition = {\n  * @returns The FHIR response.\n  */\n export async function agentUpgradeHandler(req: FhirRequest): Promise<FhirResponse> {\n-  const { version, timeout: _timeout, ...rest } = req.query;\n+  const { version: _version, timeout: _timeout, force: _force, ...rest } = req.query;\n+  const params = parseInputParameters<AgentUpgradeOptions>(operation, req);\n   req.query = rest;\n \n-  let timeout: number | undefined;\n-  if (_timeout) {\n-    timeout = Number.parseInt(singularize(_timeout) as string, 10);\n-    if (Number.isNaN(timeout)) {\n-      throw new OperationOutcomeError(\n-        badRequest(\"'timeout' must be an integer representing a duration in milliseconds, if defined\")\n-      );\n-    }\n-  }\n-\n-  return handleBulkAgentOperation(req, async (agent) =>\n-    upgradeAgent(agent, { version: singularize(version), timeout })\n-  );\n+  return handleBulkAgentOperation(req, async (agent) => upgradeAgent(agent, params));\n }\n \n export type AgentUpgradeOptions = {\n   version?: string;\n   timeout?: number;\n+  force?: boolean;\n };\n \n async function upgradeAgent(agent: WithId<Agent>, options?: AgentUpgradeOptions): Promise<FhirResponse> {\n@@ -74,7 +59,11 @@ async function upgradeAgent(agent: WithId<Agent>, options?: AgentUpgradeOptions)\n   // Send agent message\n   const [outcome, result] = await publishAgentRequest<AgentUpgradeResponse>(\n     agent,\n-    { type: 'agent:upgrade:request', ...(options?.version ? { version: options.version } : undefined) },\n+    {\n+      type: 'agent:upgrade:request',\n+      ...(options?.version ? { version: options.version } : undefined),\n+      ...(options?.force ? { force: true } : undefined),\n+    },\n     { waitForResponse: true, timeout }\n   );\n \n\ndiff --git a/packages/server/src/fhir/operations/utils/parameters.ts b/packages/server/src/fhir/operations/utils/parameters.ts\nindex d608630914..fc4739581e 100644\n--- a/packages/server/src/fhir/operations/utils/parameters.ts\n+++ b/packages/server/src/fhir/operations/utils/parameters.ts\n@@ -124,7 +124,9 @@ function parseStringifiedParameter(\n       return value;\n   }\n \n-  throw new OperationOutcomeError(badRequest(`Invalid value '${value}' provided for ${param.type} parameter`));\n+  throw new OperationOutcomeError(\n+    badRequest(`Invalid value '${value}' provided for ${param.type} parameter '${param.name}'`)\n+  );\n }\n \n function validateInputParam(param: OperationDefinitionParameter, value: unknown): unknown {\n",
    "test_patch": "diff --git a/packages/agent/src/app.test.ts b/packages/agent/src/app.test.ts\nindex 608c2d5a0a..1822a01b0b 100644\n--- a/packages/agent/src/app.test.ts\n+++ b/packages/agent/src/app.test.ts\n@@ -1711,6 +1711,247 @@ describe('App', () => {\n       console.log = originalConsoleLog;\n     });\n \n+    test('Upgrade -- Already on specified version', async () => {\n+      const originalConsoleLog = console.log;\n+      console.log = jest.fn();\n+\n+      const state = {\n+        mySocket: undefined as Client | undefined,\n+        gotAgentUpgradeResponse: false,\n+        agentError: undefined as AgentError | undefined,\n+      };\n+\n+      const platformSpy = jest.spyOn(os, 'platform').mockImplementation(jest.fn(() => 'win32'));\n+      const fetchSpy = mockFetchForUpgrader();\n+\n+      function mockConnectionHandler(socket: Client): void {\n+        state.mySocket = socket;\n+        socket.on('message', (data) => {\n+          const command = JSON.parse((data as Buffer).toString('utf8')) as AgentMessage;\n+          switch (command.type) {\n+            case 'agent:connect:request':\n+              socket.send(Buffer.from(JSON.stringify({ type: 'agent:connect:response' })));\n+              break;\n+\n+            case 'agent:heartbeat:request':\n+              socket.send(Buffer.from(JSON.stringify({ type: 'agent:heartbeat:response' })));\n+              break;\n+\n+            case 'agent:upgrade:response':\n+              if (command.statusCode !== 200) {\n+                throw new Error('Invalid status code. Expected 200');\n+              }\n+              state.gotAgentUpgradeResponse = true;\n+              break;\n+\n+            case 'agent:error':\n+              state.agentError = command;\n+              break;\n+\n+            default:\n+              throw new Error('Unhandled message type');\n+          }\n+        });\n+      }\n+\n+      const mockServer = new Server('wss://example.com/ws/agent');\n+      mockServer.on('connection', mockConnectionHandler);\n+\n+      const agent = await medplum.createResource<Agent>({\n+        resourceType: 'Agent',\n+        name: 'Test Agent',\n+        status: 'active',\n+      });\n+\n+      const app = new App(medplum, agent.id, LogLevel.INFO);\n+      await app.start();\n+\n+      // Wait for the WebSocket to reconnect\n+      while (!state.mySocket) {\n+        await sleep(100);\n+      }\n+\n+      const targetVersion = MEDPLUM_VERSION.split('-')[0];\n+\n+      state.mySocket.send(\n+        JSON.stringify({\n+          type: 'agent:upgrade:request',\n+          callback: getReferenceString(agent) + '-' + randomUUID(),\n+          version: targetVersion,\n+        } satisfies AgentUpgradeRequest)\n+      );\n+\n+      let shouldThrow = false;\n+      const timeout = setTimeout(() => {\n+        shouldThrow = true;\n+      }, 2500);\n+\n+      while (!state.gotAgentUpgradeResponse) {\n+        if (shouldThrow) {\n+          throw new Error('Timeout while waiting for error');\n+        }\n+        await sleep(100);\n+      }\n+      clearTimeout(timeout);\n+\n+      expect(state.gotAgentUpgradeResponse).toStrictEqual(true);\n+      expect(console.log).toHaveBeenCalledWith(\n+        expect.stringContaining(\n+          `Attempted to upgrade to version ${targetVersion}, but agent is already on that version`\n+        )\n+      );\n+\n+      await app.stop();\n+      await new Promise<void>((resolve) => {\n+        mockServer.stop(resolve);\n+      });\n+\n+      platformSpy.mockRestore();\n+      fetchSpy.mockRestore();\n+      console.log = originalConsoleLog;\n+    });\n+\n+    test('Upgrade -- Already on specified version (force upgrade)', async () => {\n+      const originalConsoleLog = console.log;\n+      console.log = jest.fn();\n+\n+      const state = {\n+        mySocket: undefined as Client | undefined,\n+        gotAgentUpgradeResponse: false,\n+        disconnectCalled: false,\n+        agentError: undefined as AgentError | undefined,\n+      };\n+\n+      let child!: MockChildProcess;\n+\n+      const platformSpy = jest.spyOn(os, 'platform').mockImplementation(jest.fn(() => 'win32'));\n+      const fetchSpy = mockFetchForUpgrader();\n+      const openSyncSpy = jest.spyOn(fs, 'openSync').mockImplementation(jest.fn(() => 42));\n+      const writeFileSyncSpy = jest.spyOn(fs, 'writeFileSync').mockImplementation(jest.fn());\n+      const rmSyncSpy = jest.spyOn(fs, 'rmSync').mockImplementation(jest.fn());\n+      const spawnSpy = jest.spyOn(child_process, 'spawn').mockImplementation(\n+        jest.fn(() => {\n+          child = new MockChildProcess();\n+          child.onDisconnect = () => {\n+            state.disconnectCalled = true;\n+          };\n+          return child;\n+        })\n+      );\n+\n+      function mockConnectionHandler(socket: Client): void {\n+        state.mySocket = socket;\n+        socket.on('message', (data) => {\n+          const command = JSON.parse((data as Buffer).toString('utf8')) as AgentMessage;\n+          switch (command.type) {\n+            case 'agent:connect:request':\n+              socket.send(Buffer.from(JSON.stringify({ type: 'agent:connect:response' })));\n+              break;\n+\n+            case 'agent:heartbeat:request':\n+              socket.send(Buffer.from(JSON.stringify({ type: 'agent:heartbeat:response' })));\n+              break;\n+\n+            case 'agent:upgrade:response':\n+              if (command.statusCode !== 200) {\n+                throw new Error('Invalid status code. Expected 200');\n+              }\n+              state.gotAgentUpgradeResponse = true;\n+              break;\n+\n+            case 'agent:error':\n+              state.agentError = command;\n+              break;\n+\n+            default:\n+              throw new Error('Unhandled message type');\n+          }\n+        });\n+      }\n+\n+      const mockServer = new Server('wss://example.com/ws/agent');\n+      mockServer.on('connection', mockConnectionHandler);\n+\n+      const agent = await medplum.createResource<Agent>({\n+        resourceType: 'Agent',\n+        name: 'Test Agent',\n+        status: 'active',\n+      });\n+\n+      const app = new App(medplum, agent.id, LogLevel.INFO);\n+      await app.start();\n+\n+      // Wait for the WebSocket to reconnect\n+      while (!state.mySocket) {\n+        await sleep(100);\n+      }\n+\n+      const targetVersion = MEDPLUM_VERSION.split('-')[0];\n+      const callback = getReferenceString(agent) + '-' + randomUUID();\n+\n+      state.mySocket.send(\n+        JSON.stringify({\n+          type: 'agent:upgrade:request',\n+          callback,\n+          version: targetVersion,\n+          force: true,\n+        } satisfies AgentUpgradeRequest)\n+      );\n+\n+      let shouldThrow = false;\n+      const timeout = setTimeout(() => {\n+        shouldThrow = true;\n+      }, 2500);\n+\n+      // eslint-disable-next-line no-unmodified-loop-condition\n+      while (!child) {\n+        if (shouldThrow) {\n+          throw new Error('Timeout while waiting for child to spawn');\n+        }\n+        await sleep(100);\n+      }\n+\n+      child.emit('message', { type: 'STARTED' });\n+      while (!state.disconnectCalled) {\n+        if (shouldThrow) {\n+          throw new Error('Timeout while waiting for disconnect');\n+        }\n+        await sleep(100);\n+      }\n+      clearTimeout(timeout);\n+\n+      expect(spawnSpy).toHaveBeenLastCalledWith(resolve(__dirname, 'app.ts'), ['--upgrade'], {\n+        detached: true,\n+        stdio: ['ignore', 42, 42, 'ipc'],\n+      });\n+      expect(openSyncSpy).toHaveBeenCalled();\n+      expect(child.unref).toHaveBeenCalled();\n+      expect(child.disconnect).toHaveBeenCalled();\n+\n+      expect(writeFileSyncSpy).toHaveBeenLastCalledWith(\n+        resolve(__dirname, 'upgrade.json'),\n+        JSON.stringify({\n+          previousVersion: MEDPLUM_VERSION,\n+          targetVersion,\n+          callback,\n+        }),\n+        { encoding: 'utf8', flag: 'w+' }\n+      );\n+      expect(console.log).toHaveBeenLastCalledWith(expect.stringContaining('Closing IPC...'));\n+\n+      expect(state.agentError).toBeUndefined();\n+\n+      await app.stop();\n+      await new Promise<void>((resolve) => {\n+        mockServer.stop(resolve);\n+      });\n+\n+      for (const spy of [platformSpy, fetchSpy, openSyncSpy, writeFileSyncSpy, rmSyncSpy, spawnSpy]) {\n+        spy.mockRestore();\n+      }\n+      console.log = originalConsoleLog;\n+    });\n+\n     test('Upgrade -- Error while starting upgrader', async () => {\n       const originalConsoleLog = console.log;\n       console.log = jest.fn();\n\ndiff --git a/packages/server/src/fhir/operations/agentupgrade.test.ts b/packages/server/src/fhir/operations/agentupgrade.test.ts\nindex 43a73457f2..19bb6904cf 100644\n--- a/packages/server/src/fhir/operations/agentupgrade.test.ts\n+++ b/packages/server/src/fhir/operations/agentupgrade.test.ts\n@@ -201,7 +201,7 @@ describe('Agent/$upgrade', () => {\n         {\n           severity: 'error',\n           code: 'invalid',\n-          details: { text: \"'timeout' must be an integer representing a duration in milliseconds, if defined\" },\n+          details: { text: `Invalid value 'INVALID' provided for integer parameter 'timeout'` },\n         },\n       ]),\n     });\n@@ -300,4 +300,45 @@ describe('Agent/$upgrade', () => {\n       handle.cleanup();\n     }\n   });\n+\n+  test('Agent force upgrade', async () => {\n+    // Multi agent example\n+    const handlePromises = [] as Promise<MockAgentResponseHandle>[];\n+    for (let i = 0; i < agents.length; i++) {\n+      handlePromises[i] = mockAgentResponse<AgentUpgradeRequest, AgentUpgradeResponse | AgentError>(\n+        agents[i],\n+        accessToken,\n+        'agent:upgrade:request',\n+        { type: 'agent:upgrade:response', statusCode: 200 }\n+      );\n+    }\n+    const handles = await Promise.all(handlePromises);\n+\n+    let res = await request(app)\n+      .get('/fhir/R4/Agent/$upgrade')\n+      .query({ force: true })\n+      .set('Authorization', 'Bearer ' + accessToken);\n+\n+    expect(res.status).toBe(200);\n+    const bundle = res.body as Bundle<Parameters>;\n+\n+    for (const agent of agents) {\n+      expectBundleToContainOutcome(bundle, agent, allOk);\n+    }\n+\n+    // Agent by ID\n+    res = await request(app)\n+      .get(`/fhir/R4/Agent/${agents[0].id}/$upgrade`)\n+      .query({ force: true })\n+      .set('Authorization', 'Bearer ' + accessToken);\n+\n+    expect(res.status).toBe(200);\n+\n+    const outcome = res.body as OperationOutcome;\n+    expect(outcome).toMatchObject(allOk);\n+\n+    for (const handle of handles) {\n+      handle.cleanup();\n+    }\n+  });\n });\n\ndiff --git a/packages/server/src/fhir/operations/utils/parameters.test.ts b/packages/server/src/fhir/operations/utils/parameters.test.ts\nindex b18bef88d3..8f7d3083c4 100644\n--- a/packages/server/src/fhir/operations/utils/parameters.test.ts\n+++ b/packages/server/src/fhir/operations/utils/parameters.test.ts\n@@ -259,9 +259,9 @@ describe('Operation Input Parameters parsing', () => {\n       'requiredIn=true&complexIn={\"reference\":\"Patient/foo\"}',\n       'Complex parameter complexIn (Reference) cannot be passed via query string',\n     ],\n-    ['requiredIn=false&numeric=wrong', `Invalid value 'wrong' provided for integer parameter`],\n-    ['requiredIn=false&fractional=wrong', `Invalid value 'wrong' provided for decimal parameter`],\n-    ['requiredIn=1', `Invalid value '1' provided for boolean parameter`],\n+    ['requiredIn=false&numeric=wrong', `Invalid value 'wrong' provided for integer parameter 'numeric'`],\n+    ['requiredIn=false&fractional=wrong', `Invalid value 'wrong' provided for decimal parameter 'fractional'`],\n+    ['requiredIn=1', `Invalid value '1' provided for boolean parameter 'requiredIn'`],\n   ])('Throws on invalid query string parameters: %s', (query, errorMsg) => {\n     const req: Request = { method: 'GET', query: parse(query) } as unknown as Request;\n     expect(() => parseInputParameters(opDef, req)).toThrow(new Error(errorMsg));\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6325",
    "pr_id": 6325,
    "issue_id": 6236,
    "repo": "medplum/medplum",
    "problem_statement": "Add project scoping to ...{projectId}/invite\n[Invite Request](https://www.medplum.com/docs/sdk/core.inviterequest) should allow you to specify whether the User should be _Server_ vs _Project scoped_\n\nAt the moment, the way to invite a User as _project scoped_ is adding the externalId. This tends to be confusing for people.\n\n\nSee the logic [here](https://github.com/medplum/medplum/blob/f4e48a8b6e477b052f1e106233c018f2a34180ab/packages/server/src/admin/invite.ts#L148C3-L154C4)",
    "issue_word_count": 72,
    "test_files_count": 2,
    "non_test_files_count": 12,
    "pr_changed_files": [
      "packages/app/src/admin/InvitePage.test.tsx",
      "packages/app/src/admin/InvitePage.tsx",
      "packages/core/src/client.ts",
      "packages/docs/docs/access/admin.md",
      "packages/docs/docs/access/projects.md",
      "packages/docs/docs/api/auth/resetpassword.md",
      "packages/docs/docs/api/project-admin/invite.md",
      "packages/docs/docs/app/admin-page/admin-page.md",
      "packages/docs/docs/auth/project-vs-server-scoped-users.mdx",
      "packages/docs/docs/auth/user-management-guide/user-management-guide.md",
      "packages/docs/docs/self-hosting/project-settings.md",
      "packages/examples/src/auth/user-management-guide.ts",
      "packages/server/src/admin/invite.test.ts",
      "packages/server/src/admin/invite.ts"
    ],
    "pr_changed_test_files": [
      "packages/app/src/admin/InvitePage.test.tsx",
      "packages/server/src/admin/invite.test.ts"
    ],
    "base_commit": "f4e48a8b6e477b052f1e106233c018f2a34180ab",
    "head_commit": "b8c7859a139583eed623dc5d3a0361790d0800df",
    "repo_url": "https://github.com/medplum/medplum/pull/6325",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6325",
    "dockerfile": "",
    "pr_merged_at": "2025-04-18T21:04:42.000Z",
    "patch": "diff --git a/packages/app/src/admin/InvitePage.tsx b/packages/app/src/admin/InvitePage.tsx\nindex 8c4c676637..e3988465e9 100644\n--- a/packages/app/src/admin/InvitePage.tsx\n+++ b/packages/app/src/admin/InvitePage.tsx\n@@ -24,6 +24,7 @@ export function InvitePage(): JSX.Element {\n         sendEmail: formData.sendEmail === 'on',\n         accessPolicy,\n         admin: formData.isAdmin === 'on',\n+        scope: formData.isProjectScoped === 'on' ? 'project' : 'server',\n       };\n       medplum\n         .invite(project?.id as string, body as InviteRequest)\n@@ -89,6 +90,7 @@ export function InvitePage(): JSX.Element {\n           </FormSection>\n           <Checkbox name=\"sendEmail\" label=\"Send email\" defaultChecked={true} />\n           <Checkbox name=\"isAdmin\" label=\"Admin\" />\n+          <Checkbox name=\"isProjectScoped\" label=\"Project scoped\" />\n           <Group justify=\"flex-end\">\n             <Button type=\"submit\">Invite</Button>\n           </Group>\n\ndiff --git a/packages/core/src/client.ts b/packages/core/src/client.ts\nindex c4d67ba8e1..0b689aed72 100644\n--- a/packages/core/src/client.ts\n+++ b/packages/core/src/client.ts\n@@ -498,6 +498,7 @@ export interface InviteRequest {\n   lastName: string;\n   email?: string;\n   externalId?: string;\n+  scope?: 'project' | 'server';\n   password?: string;\n   sendEmail?: boolean;\n   membership?: Partial<ProjectMembership>;\n\ndiff --git a/packages/docs/docs/access/admin.md b/packages/docs/docs/access/admin.md\nindex 6808000f98..7408da6b92 100644\n--- a/packages/docs/docs/access/admin.md\n+++ b/packages/docs/docs/access/admin.md\n@@ -19,7 +19,7 @@ Project Admins have the following privileges:\n   - [`Project`](/docs/api/fhir/medplum/project) - used to adjust [Project settings](/docs/access/projects#settings)\n   - [`ProjectMembership`](/docs/api/fhir/medplum/projectmembership) - used to manage user registration and privileges (see: [User Management Guide](/docs/auth/user-management-guide))\n   - [`UserSecurityRequest`](/docs/api/fhir/medplum/usersecurityrequest) - used to [send custom emails](/docs/auth/custom-emails#password-change-request-bot)\n-  - [`User`](/docs/api/fhir/medplum/user) - only for [project scoped users](/docs/auth/user-management-guide#project-scoped-users)\n+  - [`User`](/docs/api/fhir/medplum/user) - only for [project scoped users](/docs/auth/project-vs-server-scoped-users#project-scoped-users)\n - **Impersonate users** - Project Admins are allowed to make API calls [on behalf of other users](/docs/auth/methods/on-behalf-of)\n \n :::note Applying Access Policies to Admins\n\ndiff --git a/packages/docs/docs/access/projects.md b/packages/docs/docs/access/projects.md\nindex d34e351ddd..c5a161c5d4 100644\n--- a/packages/docs/docs/access/projects.md\n+++ b/packages/docs/docs/access/projects.md\n@@ -94,7 +94,7 @@ documentation for more information.\n | ---------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------- |\n | `superAdmin`                 | Whether this project is the super administrator project ([see above](#superadmin)).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `false` |\n | `features`                   | A list of optional features that are enabled for the project. Values related to access control include: <ul><li>`bots`: This [`Project`](/docs/api/fhir/medplum/project) is allowed to create and run [Bots](/docs/bots/bot-basics).</li><li>`email`: Bots in this project can [send emails](/docs/sdk/core.medplumclient.sendemail). </li><li>`cron`: This [`Project`](/docs/api/fhir/medplum/project) can run Bots on [CRON timers](https://www.medplum.com/docs/bots/bot-cron-job)</li><li>`google-auth-required`: [Google authentication](/docs/auth/methods/google-auth) is the only method allowed for this [`Project`](/docs/api/fhir/medplum/project)</li></ul> |         |\n-| `defaultPatientAccessPolicy` | The default [`AccessPolicy`](/docs/access/access-policies) applied to all [Patient Users](/docs/auth/user-management-guide#project-scoped-users) invited to this [`Project`](/docs/api/fhir/medplum/project). This is required to enable [open patient registration](/docs/auth/open-patient-registration).                                                                                                                                                                                                                                                                                                                                                             |         |\n+| `defaultPatientAccessPolicy` | The default [`AccessPolicy`](/docs/access/access-policies) applied to all [Patient Users](/docs/auth/project-vs-server-scoped-users#project-scoped-users) invited to this [`Project`](/docs/api/fhir/medplum/project). This is required to enable [open patient registration](/docs/auth/open-patient-registration).                                                                                                                                                                                                                                                                                                                                                             |         |\n \n ## Project Secrets\n \n\ndiff --git a/packages/docs/docs/api/auth/resetpassword.md b/packages/docs/docs/api/auth/resetpassword.md\nindex 1161f9d082..881342dde7 100644\n--- a/packages/docs/docs/api/auth/resetpassword.md\n+++ b/packages/docs/docs/api/auth/resetpassword.md\n@@ -22,7 +22,7 @@ Please note that you may need to specify _projectId_ if your User is project sco\n | Field | Type | Required | Description |\n |-------|------|----------|-------------|\n | email | string | Yes | User's email address (3-72 characters) |\n-| projectId | string | No | Project ID for project-scoped users. See [project scoped users](/docs/auth/user-management-guide#project-scoped-users) Omit for system-level users |\n+| projectId | string | No | Project ID for project-scoped users. See [project scoped users](/docs/auth/project-vs-server-scoped-users#project-scoped-users) Omit for system-level users |\n | sendEmail | boolean | No | Whether to send Medplum labeled reset email (defaults to true) |\n | redirectUri | string | No | URI to redirect after password reset |\n | recaptchaSiteKey | string | No | reCAPTCHA site key for verification |\n\ndiff --git a/packages/docs/docs/api/project-admin/invite.md b/packages/docs/docs/api/project-admin/invite.md\nindex 3c5c117c8d..aeab514469 100644\n--- a/packages/docs/docs/api/project-admin/invite.md\n+++ b/packages/docs/docs/api/project-admin/invite.md\n@@ -25,6 +25,7 @@ Invite a new user to the project. This will perform the following actions:\n   lastName: string;\n   email?: string;\n   externalId?: string;\n+  scope?: 'project' | 'server';\n   password?: string;\n   sendEmail?: boolean;\n   membership?: Partial<ProjectMembership>;\n@@ -38,6 +39,7 @@ Invite a new user to the project. This will perform the following actions:\n | `email`                 | The email address assigned to the [User](/docs/api/fhir/medplum/user). Used to identify users within each project                                                                                                                                                                                  |\n | `externalId`            | The unique id provided by external identity provider (if applicable). See [Using External Ids](/docs/auth/methods/external-ids)                                                                                                                                                                    |\n | `password`              | The [User's](/docs/api/fhir/medplum/user) password                                                                                                                                                                                                                                                 |\n+| `scope`                 | The scope of the user. If `project`, the user will be scoped to the project. If `server`, the user will be a server scoped user. Defaults to `server` for Practitioners and `project` for Patients. See [server vs project scoped user guide](/docs/auth/project-vs-server-scoped-users)                                                                                                                               |\n | `sendEmail`             | If `true`, send an invite email to the user. If self-hosting, see our [guide on setting up SES](/docs/self-hosting/install-on-aws#setup-ses)                                                                                                                                                       |\n | `membership`            | Used to override any fields of the resulting [`ProjectMembership`](/docs/api/fhir/medplum/projectmembership) resource. Common use cases include: <ul><li>Setting [Access Policies](/docs/access/access-policies) upon invite </li><li>Overriding the default `ProjectMembership.profile`</li></ul> |\n \n\ndiff --git a/packages/docs/docs/app/admin-page/admin-page.md b/packages/docs/docs/app/admin-page/admin-page.md\nindex aa3cd60cf8..a82ff28b89 100644\n--- a/packages/docs/docs/app/admin-page/admin-page.md\n+++ b/packages/docs/docs/app/admin-page/admin-page.md\n@@ -16,7 +16,7 @@ The Users tab displays all of the [`Practitioner`](/docs/api/fhir/resources/prac\n \n ## Patients\n \n-The Patients tab displays all of the [`Patient`](/docs/api/fhir/resources/patient) resources that are also a [`User`](/docs/api/fhir/medplum/user) in your project. It also allows you to invite new patients. For more details on the [`User`](/docs/api/fhir/medplum/user) and [`Patient`](/docs/api/fhir/resources/patient) resources see the [User Management Guide](/docs/auth/user-management-guide#project-scoped-users).\n+The Patients tab displays all of the [`Patient`](/docs/api/fhir/resources/patient) resources that are also a [`User`](/docs/api/fhir/medplum/user) in your project. It also allows you to invite new patients. For more details on the [`User`](/docs/api/fhir/medplum/user) and [`Patient`](/docs/api/fhir/resources/patient) resources see the [User Management Guide](/docs/auth/user-management-guide).\n \n ## Clients\n \n\ndiff --git a/packages/docs/docs/auth/project-vs-server-scoped-users.mdx b/packages/docs/docs/auth/project-vs-server-scoped-users.mdx\nnew file mode 100644\nindex 0000000000..5f117a3091\n--- /dev/null\n+++ b/packages/docs/docs/auth/project-vs-server-scoped-users.mdx\n@@ -0,0 +1,74 @@\n+---\n+sidebar_position: 11\n+tags: [auth]\n+---\n+\n+# Project vs Server Scoped Users\n+\n+\n+### Server Scoped Users\n+\n+Server scoped [`Users`](/docs/api/fhir/medplum/user) can be used across multiple projects across the Medplum Server. Server scoped Users should be used for **developers and administrators** that need to interact with multiple projects (e.g. staging and production). By default, Practitioners are scoped to `server`.\n+\n+### Project Scoped Users\n+\n+Project scoped [`Users`](/docs/api/fhir/medplum/user) exist inside a single [`Project`](/docs/api/fhir/medplum/project). Project scoped Users should be used for **real practicing clinicians and patients** that will primarily interact with a single production project. By default, Patients are scoped to `project`. If you want to include a project scoped User in multiple projects, you will need to invite them to each [`Project`](/docs/api/fhir/medplum/project) separately. \n+\n+You can specify the scope of a [User](/docs/api/fhir/medplum/user) by adding the `scope` parameter to the [Invite User](/docs/api/project-admin/invite) endpoint.\n+\n+```ts\n+const response = await medplum.post('/admin/projects/:projectId/invite', {\n+  resourceType: 'Practitioner',\n+  firstName: 'Test',\n+  lastName: 'User',\n+  email: 'test@example.com',\n+  scope: 'project' // or 'server'\n+})\n+```\n+```mermaid  \n+flowchart TD\n+    subgraph MedplumServer[\"<div style='font-size:25px; font-weight:bold;'>Medplum Server</div>\"]\n+        %% Server‑Scoped User\n+        SS1[<div style=\"text-align: center;\">User<br><strong>Company Dev/Admin</strong><br><small><em style='color:gray;'>Server Scoped</em></small></div>]\n+        SS1 --> PM1_SS1\n+        SS1 --> PM2_SS1\n+\n+        %% Staging Project subgraph\n+        subgraph StagingProject[\"<div style='font-size:20px; font-weight:bold;'>Staging Project</div>\"]\n+            SD1[<div style=\"text-align: center;\">User<br><strong>Test Doctor 1</strong><br><small><em style='color:gray;'>Project Scoped</em></small></div>]\n+            PM1[<div style=\"text-align: center;\">ProjectMembership<br><small style='color:gray;'>Project: Staging Project<br>Profile: &lt;Practitioner&gt;</small></div>]\n+            SD1 --> PM1\n+\n+            PAT1[<div style=\"text-align: center;\">User<br><strong>Example Patient 1</strong><br><small><em style='color:gray;'>Project Scoped</em></small></div>]\n+            PM_PAT1[<div style=\"text-align: center;\">ProjectMembership<br><small style='color:gray;'>Project: Staging Project<br>Profile: &lt;Patient&gt;</small></div>]\n+            PAT1 --> PM_PAT1\n+\n+            PM1_SS1[<div style=\"text-align: center;\">ProjectMembership<br><small style='color:gray;'>Project: Staging Project<br>Profile: &lt;Practitioner&gt;</small></div>]\n+        end\n+\n+        %% Production Project subgraph\n+        subgraph ProdProject[\"<div style='font-size:20px; font-weight:bold;'>Production Project</div>\"]\n+            PAT2[<div style=\"text-align: center;\">User<br><strong>John Doe</strong><br><small><em style='color:gray;'>Project Scoped</em></small></div>]\n+            PM_PAT2[<div style=\"text-align: center;\">ProjectMembership<br><small style='color:gray;'>Project: Production Project<br>Profile: &lt;Patient&gt;</small></div>]\n+            PAT2 --> PM_PAT2\n+\n+            DR_SMITH[<div style=\"text-align: center;\">User<br><strong>Dr. Alice Smith</strong><br><small><em style='color:gray;'>Project Scoped</em></small></div>]\n+            DR_SMITH_PM[<div style=\"text-align: center;\">ProjectMembership<br><small style='color:gray;'>Project: Production Project<br>Profile: &lt;Practitioner&gt;</small></div>]\n+            DR_SMITH --> DR_SMITH_PM\n+\n+            PM2_SS1[<div style=\"text-align: center;\">ProjectMembership<br><small style='color:gray;'>Project: Production Project<br>Profile: &lt;Practitioner&gt;</small></div>]\n+        end\n+    end\n+\n+    style MedplumServer fill:#f5f5f5,stroke:#888888,stroke-width:2px;\n+\n+```\n+\n+\n+:::info\n+For **hosted customers**, you will only have control over the User resources for your project scoped users, but hosted customers can access **server scoped users** from their [super admin project](/docs/self-hosting/super-admin-guide).\n+:::\n+\n+:::note\n+If you want to create a [custom email flow](/docs/auth/custom-emails) for your Practitioners, they will need to be invited as a Project Scoped Users so that the UserSecurityRequest resources are also scoped to the project.\n+:::\n\ndiff --git a/packages/docs/docs/auth/user-management-guide/user-management-guide.md b/packages/docs/docs/auth/user-management-guide/user-management-guide.md\nindex 8f2eab7079..841f010768 100644\n--- a/packages/docs/docs/auth/user-management-guide/user-management-guide.md\n+++ b/packages/docs/docs/auth/user-management-guide/user-management-guide.md\n@@ -19,7 +19,7 @@ Medplum has several resources that represent user identities. The following reso\n ```mermaid\n \n graph TD\n-\tUser1[\"<strong>User</strong><br/>email: foo@example.com\"]\n+\tUser1[\"<strong>User</strong><br/>email: foo＠example.com<br/><span style='color:grey'><em>Server Scoped</em></span>\"]\n \tPM1_1(\"<strong>ProjectMembership</strong><br/>admin: true\")\n \tPM1_2(\"<strong>ProjectMembership</strong><br/>admin: false\")\n \tPM2_2(\"<strong>ProjectMembership</strong><br/>accessPolicy: ['AccessPolicy/123']\")\n@@ -36,7 +36,7 @@ graph TD\n     Bot[\"<strong>Bot</strong>\"] --> PM2_3(\"<strong>ProjectMembership</strong><br/>accessPolicy: ['AccessPolicy/456']\")\n \tend\n \tsubgraph Project1\n-    User2[\"<strong>User</strong><br/>email: bar@example.com\"]\n+    User2[\"<strong>User</strong><br/>email: bar＠example.com<br/><span style='color:grey'><em>Project Scoped</em></span>\"]\n     PM1_2 --> p4\n \t\tp4[[Practitioner]]\n \t  p5[[DiagnosticReport]]\n@@ -57,22 +57,13 @@ graph TD\n \n The [User](/docs/api/fhir/medplum/user) resource is the main resource that represents digital identity during authentication.\n \n-[Users](/docs/api/fhir/medplum/user) can have two different scopes:\n+[Users](/docs/api/fhir/medplum/user) can have two different scopes, `server` or `project`:\n \n-- Server scoped users\n-- Project scoped users\n+- [Server scoped users](/docs/auth/project-vs-server-scoped-users#server-scoped-users) tend to be administrators and developers that need to access multiple projects.\n+- [Project scoped users](/docs/auth/project-vs-server-scoped-users#project-scoped-users) tend to be clinicians and patients that only need access to a single project.\n \n-#### Server Scoped Users\n+See our guide on [Project vs Server Scoped Users](/docs/auth/project-vs-server-scoped-users) for more details.\n \n-Server scoped [`Users`](/docs/api/fhir/medplum/user) are typically used for `Practitioners`. Practitioners can be members of multiple projects (e.g. \"staging\" and \"prod\"), and having their `Users` at the server level allows them to easily sign into multiple projects.\n-\n-#### Project Scoped Users\n-\n-Project scoped [`Users`](/docs/api/fhir/medplum/user) only exist inside a project level, and cannot sign into server-level tools such as the [Medplum App](/docs/app). The most common use case is for [`Patient`](/docs/api/fhir/resources/patient) users. These users will have to be invited and enrolled separately to each[ `Project` ](/docs/api/fhir/medplum/project) they are a part of, and there will be no link between their identities across projects.\n-\n-This is desirable in multi-tenant use cases, where patients enrolled with one tenant should not be aware of other tenants.\n-\n-By default, the server scopes all users [`Users`](/docs/api/fhir/medplum/user) enrolled as with a [`Patient`](/docs/api/fhir/resources/patient) profile ([see below](#profiles)) as project-scoped users.\n \n ### Profiles\n \n\ndiff --git a/packages/docs/docs/self-hosting/project-settings.md b/packages/docs/docs/self-hosting/project-settings.md\nindex b88e504d17..1fb5f70aa7 100644\n--- a/packages/docs/docs/self-hosting/project-settings.md\n+++ b/packages/docs/docs/self-hosting/project-settings.md\n@@ -14,7 +14,7 @@ Additional details are available in the full [`Project` resource schema](/docs/a\n | `superAdmin`                 | Users belonging to a Project with this flag are granted [Super Admin](/docs/access/projects#superadmin) access to the server. Multiple Projects can have this set.                                                                                                                                          | `false` |\n | `checkReferencesOnWrite`     | If `true`, the the server will reject any create or write operations to FHIR resources with a reference to a resource that does not exist.                                                                                                                                                                  | `false` |\n | `features`                   | A list of optional features that are enabled for the project. Possible values are listed [below](#project-feature-flags).                                                                                                                                                                                   |         |\n-| `defaultPatientAccessPolicy` | The default [`AccessPolicy`](/docs/access/access-policies) applied to all [Patient Users](/docs/auth/user-management-guide#project-scoped-users) invited to this [`Project`](/docs/api/fhir/medplum/project). This is required to enable [open patient registration](/docs/auth/open-patient-registration). |         |\n+| `defaultPatientAccessPolicy` | The default [`AccessPolicy`](/docs/access/access-policies) applied to all [Patient Users](/docs/auth/project-vs-server-scoped-users#project-scoped-users) invited to this [`Project`](/docs/api/fhir/medplum/project). This is required to enable [open patient registration](/docs/auth/open-patient-registration). |         |\n | `link`                       | Additional Projects whose [contents should be accessible](/docs/access/projects#project-linking) to users in the current Project.                                                                                                                                                                           |         |\n | `defaultProfile`             | [Resource profiles](http://hl7.org/fhir/R4/profiling.html#resources) that will be added to resources written in the Project that do not specify a profile directly. This enables automatic custom resource validation.                                                                                      |         |\n | `setting`                    | Arbitrary key-value pairs available to anyone in the Project, can be set by Project Admins.                                                                                                                                                                                                                 |         |\n\ndiff --git a/packages/examples/src/auth/user-management-guide.ts b/packages/examples/src/auth/user-management-guide.ts\nindex 1b932cac15..17a045714f 100644\n--- a/packages/examples/src/auth/user-management-guide.ts\n+++ b/packages/examples/src/auth/user-management-guide.ts\n@@ -97,6 +97,7 @@ await medplum.post('admin/projects/example-project-id/invite', {\n   lastName: 'Smith',\n   email: 'alicesmith@example.com',\n   admin: true,\n+  scope: 'server',\n });\n // end-block inviteNewAdminTs\n \n\ndiff --git a/packages/server/src/admin/invite.ts b/packages/server/src/admin/invite.ts\nindex 3ce77c1d9d..182ebe1d61 100644\n--- a/packages/server/src/admin/invite.ts\n+++ b/packages/server/src/admin/invite.ts\n@@ -139,13 +139,13 @@ export async function inviteUser(request: ServerInviteRequest): Promise<ServerIn\n }\n \n async function createUser(request: ServerInviteRequest): Promise<WithId<User>> {\n-  const { firstName, lastName, externalId } = request;\n+  const { firstName, lastName, externalId, scope } = request;\n   const email = request.email?.toLowerCase();\n   const password = request.password ?? generateSecret(16);\n   const passwordHash = await bcryptHashPassword(password);\n \n   let project: Reference<Project> | undefined = undefined;\n-  if (request.resourceType === 'Patient' || externalId) {\n+  if (request.resourceType === 'Patient' || externalId || scope === 'project') {\n     // Users can optionally be scoped to a project.\n     // We force users to be scoped to a project if:\n     // 1) They are a patient\n",
    "test_patch": "diff --git a/packages/app/src/admin/InvitePage.test.tsx b/packages/app/src/admin/InvitePage.test.tsx\nindex 16325d716b..13b32f751b 100644\n--- a/packages/app/src/admin/InvitePage.test.tsx\n+++ b/packages/app/src/admin/InvitePage.test.tsx\n@@ -173,6 +173,36 @@ describe('InvitePage', () => {\n     expect(screen.getByTestId('success')).toBeInTheDocument();\n   });\n \n+  test('Invite project scoped user', async () => {\n+    await setup('/admin/invite');\n+    expect(await screen.findByText('Invite')).toBeInTheDocument();\n+\n+    await act(async () => {\n+      fireEvent.change(screen.getByLabelText('Role'), {\n+        target: { value: 'Practitioner' },\n+      });\n+      fireEvent.change(screen.getByLabelText('First Name *'), {\n+        target: { value: 'Patty' },\n+      });\n+      fireEvent.change(screen.getByLabelText('Last Name *'), {\n+        target: { value: 'Practitioner' },\n+      });\n+      fireEvent.change(screen.getByLabelText('Email *'), {\n+        target: { value: 'pattypractitioner@example.com' },\n+      });\n+    });\n+\n+    await act(async () => {\n+      fireEvent.click(screen.getByLabelText('Project scoped'));\n+    });\n+\n+    await act(async () => {\n+      fireEvent.click(screen.getByText('Invite'));\n+    });\n+\n+    expect(screen.getByTestId('success')).toBeInTheDocument();\n+  });\n+\n   test('Do not send email', async () => {\n     await setup('/admin/invite');\n     expect(await screen.findByText('Invite')).toBeInTheDocument();\n\ndiff --git a/packages/server/src/admin/invite.test.ts b/packages/server/src/admin/invite.test.ts\nindex 725dcf0c05..2e017a359f 100644\n--- a/packages/server/src/admin/invite.test.ts\n+++ b/packages/server/src/admin/invite.test.ts\n@@ -760,4 +760,71 @@ describe('Admin Invite', () => {\n       'User is already a member of this project with a different profile'\n     );\n   });\n+\n+  test('Invite project scoped user', async () => {\n+    const { project, accessToken } = await withTestContext(() =>\n+      registerNew({\n+        firstName: 'Alice',\n+        lastName: 'Smith',\n+        projectName: 'Alice Project',\n+        email: `alice${randomUUID()}@example.com`,\n+        password: 'password!@#',\n+      })\n+    );\n+\n+    // Second, Alice invites Bob to the project\n+    const bobEmail = `bob${randomUUID()}@example.com`;\n+    const res = await request(app)\n+      .post('/admin/projects/' + project.id + '/invite')\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        resourceType: 'Practitioner',\n+        firstName: 'Bob',\n+        lastName: 'Jones',\n+        email: bobEmail,\n+        scope: 'project',\n+      });\n+\n+    expect(res.status).toBe(200);\n+    const res2 = await request(app)\n+      .get('/fhir/R4/User?email=' + bobEmail)\n+      .set('Authorization', 'Bearer ' + accessToken);\n+    expect(res2.status).toBe(200);\n+    const user = res2.body.entry[0].resource;\n+    expect(user.resourceType).toBe('User');\n+    expect(user.project.reference).toBe(getReferenceString(project));\n+  });\n+\n+  test('Invite server scoped User, and check that the User is not accessible from the project', async () => {\n+    const { project, accessToken } = await withTestContext(() =>\n+      registerNew({\n+        firstName: 'Alice',\n+        lastName: 'Smith',\n+        projectName: 'Alice Project',\n+        email: `alice${randomUUID()}@example.com`,\n+        password: 'password!@#',\n+      })\n+    );\n+\n+    // Second, Alice invites Bob to the project\n+    const bobEmail = `bob${randomUUID()}@example.com`;\n+    const res = await request(app)\n+      .post('/admin/projects/' + project.id + '/invite')\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        resourceType: 'Practitioner',\n+        firstName: 'Bob',\n+        lastName: 'Jones',\n+        email: bobEmail,\n+        scope: 'server',\n+      });\n+\n+    expect(res.status).toBe(200);\n+    const res2 = await request(app)\n+      .get('/fhir/R4/User?email=' + bobEmail)\n+      .set('Authorization', 'Bearer ' + accessToken);\n+    expect(res2.status).toBe(200);\n+    expect(res2.body.resourceType).toBe('Bundle');\n+    expect(res2.body.entry).toBeUndefined();\n+  });\n });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6318",
    "pr_id": 6318,
    "issue_id": 6164,
    "repo": "medplum/medplum",
    "problem_statement": "Support token search :text modifier for Identifier\n\nFrom [Fhir Search Docs] (https://hl7.org/fhir/R4/search.html#token) -\n\n\":text – The search parameter is processed as a string that searches text associated with the code/value - either _CodeableConcept.text, Coding.display, or Identifier.type.text_. In this case, the search functions as a normal string search \"\n\nWe currently support all of these except for _Identifier.type.text_. We should allow :text modifier to search matches on an Identifier.",
    "issue_word_count": 78,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/server/src/fhir/lookups/token.test.ts",
      "packages/server/src/fhir/lookups/token.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/lookups/token.test.ts"
    ],
    "base_commit": "a2ef259581b864c477f5cc8bc238fb1ef41ed609",
    "head_commit": "898e0df5ead4ec09ddb57a5ee2f8b78e7133b577",
    "repo_url": "https://github.com/medplum/medplum/pull/6318",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6318",
    "dockerfile": "",
    "pr_merged_at": "2025-04-07T20:40:59.000Z",
    "patch": "diff --git a/packages/server/src/fhir/lookups/token.ts b/packages/server/src/fhir/lookups/token.ts\nindex 342a75643e..6db6186763 100644\n--- a/packages/server/src/fhir/lookups/token.ts\n+++ b/packages/server/src/fhir/lookups/token.ts\n@@ -388,6 +388,9 @@ function buildIdentifierToken(\n   caseSensitive: boolean,\n   identifier: Identifier | undefined\n ): void {\n+  if (identifier?.type?.text) {\n+    buildSimpleToken(result, searchParam, caseSensitive, 'text', identifier.type.text);\n+  }\n   buildSimpleToken(result, searchParam, caseSensitive, identifier?.system, identifier?.value);\n }\n \n",
    "test_patch": "diff --git a/packages/server/src/fhir/lookups/token.test.ts b/packages/server/src/fhir/lookups/token.test.ts\nindex bc0fa33df8..ee36d5526d 100644\n--- a/packages/server/src/fhir/lookups/token.test.ts\n+++ b/packages/server/src/fhir/lookups/token.test.ts\n@@ -21,11 +21,12 @@ describe('Identifier Lookup Table', () => {\n   test('Identifier', () =>\n     withTestContext(async () => {\n       const identifier = randomUUID();\n+      const text = 'this is some text';\n \n       const patient = await systemRepo.createResource<Patient>({\n         resourceType: 'Patient',\n         name: [{ given: ['Alice'], family: 'Smith' }],\n-        identifier: [{ system: 'https://www.example.com', value: identifier }],\n+        identifier: [{ system: 'https://www.example.com', value: identifier, type: { text } }],\n       });\n \n       const searchResult = await systemRepo.search({\n@@ -40,6 +41,37 @@ describe('Identifier Lookup Table', () => {\n       });\n       expect(searchResult.entry?.length).toStrictEqual(1);\n       expect(searchResult.entry?.[0]?.resource?.id).toStrictEqual(patient.id);\n+\n+      const goodTextResult = await systemRepo.search({\n+        resourceType: 'Patient',\n+        filters: [\n+          {\n+            code: 'identifier',\n+            operator: Operator.EQUALS,\n+            value: identifier,\n+          },\n+          {\n+            code: 'identifier',\n+            operator: Operator.TEXT,\n+            value: text,\n+          },\n+        ],\n+      });\n+      expect(goodTextResult.entry?.length).toStrictEqual(1);\n+      expect(goodTextResult.entry?.[0]?.resource?.id).toStrictEqual(patient.id);\n+\n+      const badTextResult = await systemRepo.search({\n+        resourceType: 'Patient',\n+        filters: [\n+          {\n+            code: 'identifier',\n+            operator: Operator.TEXT,\n+            // :text on the identifier value itself should not match\n+            value: identifier,\n+          },\n+        ],\n+      });\n+      expect(badTextResult.entry?.length).toStrictEqual(0);\n     }));\n \n   test('Multiple identifiers', () =>\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6313",
    "pr_id": 6313,
    "issue_id": 6239,
    "repo": "medplum/medplum",
    "problem_statement": "Create a sample Bot for Metriport API\n## Description\n\nWe need to create a sample bot that integrates with the [Metriport Medical API](https://docs.metriport.com/medical-api/getting-started/quickstart) to demonstrate the following workflow:\n\n1. Create a Patient – The bot should create a new patient on the Medplum side.\n2. Request Patient Records – After successfully creating a patient, the bot should request medical records for that patient using the Metriport Medical API. If the patient doesn't already exist there, we should create the patient in Metriport.\n3. Listen for Updates – The bot should listen for updates on the requested patient records and handle them accordingly.\n\nThe sample bot should be placed under `medplum-demo-bots` and follow the established patterns and conventions used in that repository.\n\n## Resources\n\n- Metriport API Documentation: [Metriport Quickstart Guide](https://docs.metriport.com/medical-api/getting-started/quickstart)\n- https://github.com/metriport/metriport\n",
    "issue_word_count": 150,
    "test_files_count": 3,
    "non_test_files_count": 7,
    "pr_changed_files": [
      "examples/medplum-demo-bots/esbuild-script.mjs",
      "examples/medplum-demo-bots/medplum.config.json",
      "examples/medplum-demo-bots/package.json",
      "examples/medplum-demo-bots/src/metriport-bots/README.md",
      "examples/medplum-demo-bots/src/metriport-bots/metriport-consolidated-data-webhook.test.ts",
      "examples/medplum-demo-bots/src/metriport-bots/metriport-consolidated-data-webhook.ts",
      "examples/medplum-demo-bots/src/metriport-bots/metriport-patient-bot.test.ts",
      "examples/medplum-demo-bots/src/metriport-bots/metriport-patient-bot.ts",
      "examples/medplum-demo-bots/src/metriport-bots/metriport-test-data.ts",
      "package-lock.json"
    ],
    "pr_changed_test_files": [
      "examples/medplum-demo-bots/src/metriport-bots/metriport-consolidated-data-webhook.test.ts",
      "examples/medplum-demo-bots/src/metriport-bots/metriport-patient-bot.test.ts",
      "examples/medplum-demo-bots/src/metriport-bots/metriport-test-data.ts"
    ],
    "base_commit": "a8072500417e0161aa147ad48f3b4ef3ddacbb1a",
    "head_commit": "cabdd6445d659fc9c96a8564e03ecaefc3b2cfbf",
    "repo_url": "https://github.com/medplum/medplum/pull/6313",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6313",
    "dockerfile": "",
    "pr_merged_at": "2025-05-04T21:36:53.000Z",
    "patch": "diff --git a/examples/medplum-demo-bots/esbuild-script.mjs b/examples/medplum-demo-bots/esbuild-script.mjs\nindex eb553d3c9f..eab549fe0e 100644\n--- a/examples/medplum-demo-bots/esbuild-script.mjs\n+++ b/examples/medplum-demo-bots/esbuild-script.mjs\n@@ -21,7 +21,7 @@ const esbuildOptions = {\n   loader: {\n     '.ts': 'ts', // Load TypeScript files\n   },\n-  resolveExtensions: ['.ts'],\n+  resolveExtensions: ['.ts', '.js'],\n   external: botLayerDeps,\n   format: 'cjs', // Set output format as ECMAScript modules\n   target: 'es2020', // Set the target ECMAScript version\n\ndiff --git a/examples/medplum-demo-bots/medplum.config.json b/examples/medplum-demo-bots/medplum.config.json\nindex 332cc545a0..25f35a2401 100644\n--- a/examples/medplum-demo-bots/medplum.config.json\n+++ b/examples/medplum-demo-bots/medplum.config.json\n@@ -101,6 +101,18 @@\n       \"id\": \"\",\n       \"source\": \"src/epic/epic-query-patient.ts\",\n       \"dist\": \"dist/epic/epic-query-patient.js\"\n+    },\n+    {\n+      \"name\": \"metriport-patient-bot\",\n+      \"id\": \"\",\n+      \"source\": \"src/metriport-bots/metriport-patient-bot.ts\",\n+      \"dist\": \"dist/metriport-bots/metriport-patient-bot.js\"\n+    },\n+    {\n+      \"name\": \"metriport-consolidated-data-webhook\",\n+      \"id\": \"\",\n+      \"source\": \"src/metriport-bots/metriport-consolidated-data-webhook.ts\",\n+      \"dist\": \"dist/metriport-bots/metriport-consolidated-data-webhook.js\"\n     }\n   ]\n }\n\ndiff --git a/examples/medplum-demo-bots/package.json b/examples/medplum-demo-bots/package.json\nindex ce6dd15800..f4390db8c3 100644\n--- a/examples/medplum-demo-bots/package.json\n+++ b/examples/medplum-demo-bots/package.json\n@@ -36,6 +36,7 @@\n     \"@medplum/eslint-config\": \"4.1.3\",\n     \"@medplum/fhirtypes\": \"4.1.3\",\n     \"@medplum/mock\": \"4.1.3\",\n+    \"@metriport/api-sdk\": \"14.12.0\",\n     \"@types/node\": \"20.17.30\",\n     \"@types/node-fetch\": \"2.6.12\",\n     \"@types/ssh2-sftp-client\": \"9.0.4\",\n\ndiff --git a/examples/medplum-demo-bots/src/metriport-bots/README.md b/examples/medplum-demo-bots/src/metriport-bots/README.md\nnew file mode 100644\nindex 0000000000..5222b2b4da\n--- /dev/null\n+++ b/examples/medplum-demo-bots/src/metriport-bots/README.md\n@@ -0,0 +1,96 @@\n+# Metriport and Medplum\n+\n+This folder contains a set of bots that integrate Medplum with Metriport. The integration consists of two bots that work together:\n+\n+- **Patient Bot** (`metriport-patient-bot.ts`): This bot is triggered when a Medplum `Patient` resource is created or updated. It checks for specific configuration on the `Patient` and its related `Organization` (see \"Enabling Metriport Interaction per Patient\" below). If configured, it attempts to find/create the patient in Metriport and initiates a consolidated data query. If not configured, it logs a warning and skips Metriport interaction for that patient.\n+- **Consolidated Data Webhook** (`metriport-consolidated-data-webhook.ts`): This bot receives consolidated data webhooks from Metriport, processes the FHIR Bundle, and upserts the resources into Medplum.\n+\n+## Prerequisites\n+\n+- A Medplum account with bot creation permissions.\n+- A Metriport developer account where you have permissions to the API keys and can configure webhooks.\n+\n+## Medplum Setup\n+\n+1. Create your [Medplum Access Policy](https://www.medplum.com/docs/access/access-policies#resource-type). An Access Policy is important because you want to make sure that the system sending webhooks only has the minimal set of permissions needed to function. Example below.\n+\n+    > [!NOTE]\n+    > The following example grants access to create all resources using `\\*`. For production environments, you might want to specify only a subset of resources (e.g., \"Patient\", \"Observation\") relevant to the data received from Metriport.\n+\n+    ```json\n+    {\n+      \"resourceType\": \"AccessPolicy\",\n+      \"name\": \"Metriport Webhook Access Policy\",\n+      \"resource\": [\n+        {\n+          \"resourceType\": \"*\"\n+        }\n+      ]\n+    }\n+    ```\n+\n+2. Create a [ClientApplication](https://www.medplum.com/docs/auth/methods/client-credentials) in the [Admin Panel](https://app.medplum.com/admin/project) and apply the access policy created above. This ClientApplication will be used by Metriport to authenticate when sending webhooks.\n+\n+3. Create, build, and [deploy](https://www.medplum.com/docs/bots/bots-in-production#deploying-your-bot) the code of both [Bots](https://www.medplum.com/docs/bots/bot-basics) using the samples in this repository as a base.\n+\n+### Enabling Patient Creation in Metriport (Optional, Not mandatory)\n+\n+The Patient Bot (`metriport-patient-bot.ts`) always attempts to match patients in Metriport based on the Medplum `Patient` resource's demographics when triggered. However, to enable the bot to _create_ a patient in Metriport if no match is found, the following conditions must be met for the specific Medplum `Patient` resource:\n+\n+1.  **Patient Linked to Organization:** The `Patient` resource must have its `managingOrganization` field set to reference a Medplum `Organization` resource.\n+    ```json\n+    {\n+      \"resourceType\": \"Patient\",\n+      // ... other Patient properties\n+      \"managingOrganization\": {\n+        \"reference\": \"Organization/<medplum-organization-id>\"\n+      }\n+      // ...\n+    }\n+    ```\n+2.  **Organization Contains Metriport Facility ID:** The referenced `Organization` resource must contain an `identifier` with the Metriport Facility ID using the correct system. This Facility ID is required by Metriport when creating a new patient. See the [Metriport API documentation](https://docs.metriport.com/medical-api/api-reference/patient/create-patient) for more information.\n+    - **Identifier System:** `https://metriport.com/fhir/identifiers/organization-id`\n+    - **Identifier Value:** The actual Metriport Facility ID (e.g., `0195d964-d166-7226-8912-76934c23c140`)\n+    ```json\n+    {\n+      \"resourceType\": \"Organization\",\n+      // ... other Organization properties\n+      \"identifier\": [\n+        {\n+          \"system\": \"https://metriport.com/fhir/identifiers/organization-id\",\n+          \"value\": \"<metriport-facility-id>\"\n+        }\n+        // ... other identifiers if any\n+      ]\n+      // ...\n+    }\n+    ```\n+\n+> **Behavior:** When the Patient Bot is triggered, it first attempts to match the patient in Metriport using demographics.\n+>\n+> - If a match is found, the bot proceeds to request consolidated data using the existing Metriport patient ID.\n+> - If no match is found, the bot checks for the `managingOrganization` reference and the Metriport Facility ID on the referenced `Organization`.\n+>   - If both are present, the bot creates the patient in Metriport and then requests consolidated data.\n+>   - If either the reference or the identifier is missing, the bot cannot create the patient, logs a warning detailing the missing information, and stops further Metriport processing for this patient update. Check the bot execution logs for these warnings.\n+\n+## Metriport Setup\n+\n+1.  Go to [Metriport Developer Dashboard](https://dash.metriport.com/sandbox/developers) (or the production equivalent).\n+\n+2.  Copy the `API Key` and the `Webhook Key`. Add both as secrets to your [Medplum Project Secrets](https://app.medplum.com/admin/secrets) with the keys `METRIPORT_API_KEY` and `METRIPORT_WEBHOOK_KEY` respectively. These secrets will be accessible by both bots.\n+\n+3.  Configure the `Webhook URL` in Metriport to point to your deployed `metriport-consolidated-data-webhook` bot endpoint, using the ClientApplication credentials and Bot ID from the Medplum Setup (Steps 2 & 3):\n+\n+    ```url\n+    https://<client-application-id>:<client-secret>@api.medplum.com/fhir/R4/Bot/<webhook-bot-id>/$execute\n+    ```\n+\n+4.  Click `Save and Test` in the Metriport dashboard to ensure the webhook endpoint is reachable and the `ping` message is handled correctly by the bot.\n+\n+Once this setup is complete, the bots are deployed. Changes to Medplum `Patient` resources will trigger the patient bot. If a patient meets the criteria described in \"Enabling Metriport Interaction per Patient\", the bot will interact with Metriport. Otherwise, it will log a warning. Results from successful Metriport queries will be sent via webhook to the consolidated data bot for processing into Medplum.\n+\n+## Support\n+\n+For issues related to Medplum, please refer to the [Medplum documentation](https://www.medplum.com/docs) or contact Medplum support in [Discord](https://discord.gg/medplum).\n+\n+For Metriport-related issues, consult the [Metriport API documentation](https://docs.metriport.com/medical-api).\n\ndiff --git a/examples/medplum-demo-bots/src/metriport-bots/metriport-consolidated-data-webhook.ts b/examples/medplum-demo-bots/src/metriport-bots/metriport-consolidated-data-webhook.ts\nnew file mode 100644\nindex 0000000000..cda2d12f95\n--- /dev/null\n+++ b/examples/medplum-demo-bots/src/metriport-bots/metriport-consolidated-data-webhook.ts\n@@ -0,0 +1,224 @@\n+import { BotEvent, ContentType, MedplumClient } from '@medplum/core';\n+import { Bundle, DocumentReference, Identifier } from '@medplum/fhirtypes';\n+\n+/**\n+ * This bot is used to handle the consolidated data webhook from Metriport.\n+ * It will process the bundle using Medplum's batch capability.\n+ *\n+ * References:\n+ * - Medplum Consuming Webhook: https://www.medplum.com/docs/bots/consuming-webhooks\n+ * - Metriport Implementing Webhooks: https://docs.metriport.com/medical-api/getting-started/webhooks\n+ * - Metriport Receiving Webhooks: https://docs.metriport.com/medical-api/handling-data/webhooks\n+ * - Metriport Message Types: https://docs.metriport.com/medical-api/handling-data/webhooks#types-of-messages\n+ *\n+ * @param medplum - The Medplum client\n+ * @param event - The BotEvent object containing the Metriport Webhook Message\n+ *\n+ * @returns A promise that resolves depending on the webhook message type\n+ */\n+export async function handler(medplum: MedplumClient, event: BotEvent<Record<string, any>>): Promise<any> {\n+  const metriportApiKey = event.secrets['METRIPORT_API_KEY']?.valueString;\n+  if (!metriportApiKey) {\n+    throw new Error('Missing METRIPORT_API_KEY');\n+  }\n+\n+  const metriportWebhookKey = event.secrets['METRIPORT_WEBHOOK_KEY']?.valueString;\n+  if (!metriportWebhookKey) {\n+    throw new Error('Missing METRIPORT_WEBHOOK_KEY');\n+  }\n+\n+  const input = event.input;\n+  const messageType = input.meta?.type;\n+  if (!messageType) {\n+    throw new Error('Missing message type');\n+  }\n+\n+  // Handle different webhook message types\n+  // See https://docs.metriport.com/medical-api/handling-data/webhooks#types-of-messages\n+  switch (messageType) {\n+    case 'ping':\n+      return { pong: input.ping };\n+\n+    case 'medical.consolidated-data':\n+      {\n+        const medplumPatientId = input.meta?.data?.medplumPatientId;\n+        if (!medplumPatientId) {\n+          throw new Error(\n+            'Missing medplumPatientId. The startConsolidatedQuery call must include the medplumPatientId metadata.'\n+          );\n+        }\n+\n+        if (input.patients[0]?.bundle?.entry) {\n+          const docRef = input.patients[0].bundle.entry[0]?.resource as DocumentReference;\n+          if (!docRef?.content?.[0]?.attachment?.url) {\n+            throw new Error('Missing document URL');\n+          }\n+\n+          try {\n+            const metriportPatientId = input.patients[0].patientId;\n+            console.log('Processing consolidated data for patient:', metriportPatientId);\n+            // Fetch the actual data from the URL\n+            const response = await fetch(docRef.content[0].attachment.url);\n+            // This is a searchset bundle\n+            const consolidatedData = (await response.json()) as Bundle;\n+\n+            // NOTE: We are not filtering out any Resources from the consolidated data bundle.\n+            // This means that we will process all resources in the bundle, so the AccessPolicy needs\n+            // to be set to allow all resources to be processed. If you are using this bot in a production\n+            // environment, you should filter out the resources that you do not want to process.\n+            // See: https://www.medplum.com/docs/bots/consuming-webhooks#creating-access-policies\n+            const transactionBundle = convertToTransactionBundle(consolidatedData, medplumPatientId);\n+            const responseBundle = await medplum.executeBatch(transactionBundle);\n+\n+            // Log only error responses\n+            const errors = responseBundle.entry\n+              ?.filter((entry) => {\n+                const outcome = entry.response?.outcome;\n+                return (\n+                  outcome?.resourceType === 'OperationOutcome' &&\n+                  outcome.issue?.some((issue) => issue.severity === 'error')\n+                );\n+              })\n+              .map((entry) => ({\n+                resource: entry.resource?.resourceType,\n+                error: entry.response?.outcome?.issue?.[0]?.details?.text,\n+                expression: entry.response?.outcome?.issue?.[0]?.expression,\n+              }));\n+\n+            if (errors && errors.length > 0) {\n+              throw new Error(`Error executing the transaction bundle: ${JSON.stringify(errors, null, 2)}`);\n+            }\n+            return true;\n+          } catch (error) {\n+            throw new Error(`Error processing consolidated data: ${error}`, { cause: error });\n+          }\n+        }\n+      }\n+      break;\n+\n+    default:\n+      throw new Error(`Not implemented webhook message type: ${messageType}`);\n+  }\n+\n+  return true;\n+}\n+\n+/**\n+ * Converts a searchset bundle to a transaction bundle.\n+ *\n+ * @param bundle - The searchset bundle\n+ * @param medplumPatientId - The Medplum patient ID\n+ * @param metriportPatientId - The Metriport patient ID\n+ *\n+ * @returns The transaction bundle\n+ */\n+\n+export function convertToTransactionBundle(bundle: Bundle, medplumPatientId: string): Bundle {\n+  const idToFullUrlMap: Record<string, string> = {};\n+  bundle.entry?.forEach((entry) => {\n+    if (entry.resource?.id && entry.fullUrl) {\n+      idToFullUrlMap[entry.resource.id] = entry.fullUrl;\n+    }\n+  });\n+\n+  const transactionBundle: Bundle = {\n+    resourceType: 'Bundle',\n+    type: 'transaction',\n+    entry:\n+      bundle.entry?.map((entry) => {\n+        const resource = entry.resource;\n+        if (!resource) {\n+          return entry;\n+        }\n+\n+        const originalId = resource.id;\n+\n+        // Create a deep clone and process the resource\n+        const processedResource = JSON.parse(\n+          JSON.stringify(resource, (key, value) => referenceReplacer(key, value, idToFullUrlMap))\n+        );\n+\n+        // The id needs to be removed for the Upsert operation\n+        delete processedResource.id;\n+\n+        const resourceType = processedResource.resourceType;\n+        const metriportIdentifierSystem = `https://metriport.com/fhir/identifiers/${resourceType.toLowerCase()}-id`;\n+\n+        // Add Metriport identifier\n+        const metriportIdentifier = {\n+          system: metriportIdentifierSystem,\n+          value: originalId,\n+        };\n+        processedResource.identifier = processedResource.identifier\n+          ? [\n+              ...processedResource.identifier.filter(\n+                (id: Identifier) =>\n+                  !(id.system === metriportIdentifier.system && id.value === metriportIdentifier.value)\n+              ),\n+              metriportIdentifier,\n+            ]\n+          : [metriportIdentifier];\n+\n+        // Handle DocumentReference dates\n+        if (resourceType === 'DocumentReference' && processedResource.date) {\n+          try {\n+            processedResource.date = new Date(processedResource.date).toISOString();\n+          } catch {\n+            delete processedResource.date;\n+          }\n+        }\n+\n+        // Use PATCH for the Patient resource to add the Metriport identifier without overwriting\n+        // existing patient data. A PUT operation would replace the entire resource.\n+        if (resourceType === 'Patient') {\n+          return {\n+            fullUrl: entry.fullUrl,\n+            request: {\n+              method: 'PATCH',\n+              url: `Patient/${medplumPatientId}`,\n+            },\n+            resource: {\n+              resourceType: 'Binary',\n+              contentType: ContentType.JSON_PATCH,\n+              data: Buffer.from(\n+                JSON.stringify([{ op: 'add', path: '/identifier', value: [metriportIdentifier] }]),\n+                'utf8'\n+              ).toString('base64'),\n+            },\n+          };\n+        }\n+\n+        return {\n+          fullUrl: entry.fullUrl,\n+          request: {\n+            method: 'PUT',\n+            url: `${resourceType}?identifier=${originalId}`,\n+          },\n+          resource: processedResource,\n+        };\n+      }) || [],\n+  };\n+\n+  return transactionBundle;\n+}\n+\n+function referenceReplacer(key: string, value: string, idToFullUrl: Record<string, string>): string {\n+  if (key === 'reference' && typeof value === 'string') {\n+    let id;\n+    if (value.includes('/')) {\n+      id = value.split('/')[1];\n+    } else if (value.startsWith('urn:uuid:')) {\n+      id = value.slice(9);\n+    } else if (value.startsWith('#')) {\n+      id = value.slice(1);\n+    }\n+    if (id) {\n+      const fullUrl = idToFullUrl[id];\n+      if (fullUrl) {\n+        return fullUrl;\n+      }\n+    }\n+    return value;\n+  }\n+  return value;\n+}\n\ndiff --git a/examples/medplum-demo-bots/src/metriport-bots/metriport-patient-bot.ts b/examples/medplum-demo-bots/src/metriport-bots/metriport-patient-bot.ts\nnew file mode 100644\nindex 0000000000..8a61435b63\n--- /dev/null\n+++ b/examples/medplum-demo-bots/src/metriport-bots/metriport-patient-bot.ts\n@@ -0,0 +1,234 @@\n+import { BotEvent, MedplumClient, normalizeErrorString } from '@medplum/core';\n+import { Organization, Patient } from '@medplum/fhirtypes';\n+import { MetriportMedicalApi, PatientDTO, USState, Demographics, PatientCreate } from '@metriport/api-sdk';\n+\n+/**\n+ * This bot is used to request medical records from the Metriport Medical API for a given Medplum\n+ * Patient resource. It will then trigger an asynchronous query to retrieve the patient's\n+ * consolidated data in FHIR JSON format. The results are sent through Webhook.\n+ * See the consolidated-data-webhook.ts file for the webhook bot handler.\n+ *\n+ * References:\n+ * - Medplum Consuming Webhook: https://www.medplum.com/docs/bots/consuming-webhooks\n+ * - Metriport Medical API: https://docs.metriport.com/medical-api\n+ *\n+ * @param medplum - The Medplum client\n+ * @param event - The BotEvent object containing the Medplum Patient resource\n+ *\n+ * @returns A promise that resolves to void\n+ */\n+export async function handler(medplum: MedplumClient, event: BotEvent<Patient>): Promise<void> {\n+  const metriportApiKey = event.secrets['METRIPORT_API_KEY']?.valueString;\n+  if (!metriportApiKey) {\n+    throw new Error('Missing METRIPORT_API_KEY');\n+  }\n+  const metriport = new MetriportMedicalApi(\n+    metriportApiKey,\n+    // Comment the sandbox line for production\n+    { sandbox: true }\n+  );\n+\n+  const medplumPatient = event.input;\n+\n+  const validatedData = validatePatientResource(medplumPatient);\n+\n+  // Find a matching patient on Metriport\n+  let metriportPatient = await findMatchingMetriportPatient(metriport, validatedData);\n+\n+  // Create a new patient in Metriport, if they don't exist\n+  if (!metriportPatient) {\n+    const facilityId = await getMetriportFacilityIdFromMedplumPatient(medplum, medplumPatient);\n+    if (!facilityId) {\n+      console.warn(`Skipping patient creation in Metriport because facility ID is missing.`);\n+      return;\n+    }\n+    metriportPatient = await createMetriportPatient(metriport, validatedData, facilityId, medplumPatient.id as string);\n+  }\n+\n+  // Trigger an asynchronous query to retrieve the patient's consolidated data in FHIR JSON format.\n+  // The results are sent through Webhook (see https://docs.metriport.com/medical-api/more-info/webhooks).\n+  // See the consolidated-data-webhook.ts file for the webhook handler.\n+  const consolidatedData = await metriport.startConsolidatedQuery(\n+    metriportPatient.id,\n+    undefined, // A comma separated, case sensitive list of resources to be returned. If none are provided all resources will be included\n+    undefined, // No start date\n+    undefined, // No end date\n+    'json', // FHIR JSON format\n+    undefined, // No fromDashboard\n+    {\n+      medplumPatientId: medplumPatient.id as string,\n+    }\n+  );\n+  console.log('Consolidated data:', JSON.stringify(consolidatedData, null, 2));\n+}\n+\n+export interface ValidatedPatientData {\n+  firstName: string;\n+  lastName: string;\n+  dob: string;\n+  genderAtBirth: string;\n+  addressLine1: string;\n+  city: string;\n+  state: string;\n+  zip: string;\n+  phone?: string;\n+  email?: string;\n+}\n+\n+export function validatePatientResource(patient: Patient): ValidatedPatientData {\n+  // Required fields\n+  const firstName = patient.name?.[0]?.given?.[0];\n+  if (!firstName) {\n+    throw new Error('Missing first name');\n+  }\n+\n+  const lastName = patient.name?.[0]?.family;\n+  if (!lastName) {\n+    throw new Error('Missing last name');\n+  }\n+\n+  const dob = patient.birthDate;\n+  if (!dob) {\n+    throw new Error('Missing date of birth');\n+  }\n+\n+  const genderAtBirth = patient.gender;\n+  if (!genderAtBirth) {\n+    throw new Error('Missing gender');\n+  }\n+\n+  const address = patient.address?.[0];\n+  const addressLine1 = address?.line?.[0];\n+  const city = address?.city;\n+  const state = address?.state;\n+  const zip = address?.postalCode;\n+  if (!addressLine1 || !city || !state || !zip) {\n+    throw new Error('Missing address information');\n+  }\n+\n+  // Optional fields\n+  const phone = patient.telecom?.find((t) => t.system === 'phone')?.value;\n+  const email = patient.telecom?.find((t) => t.system === 'email')?.value;\n+\n+  return {\n+    firstName,\n+    lastName,\n+    dob,\n+    genderAtBirth,\n+    addressLine1,\n+    city,\n+    state,\n+    zip,\n+    phone,\n+    email,\n+  };\n+}\n+\n+/**\n+ * Retrieves the Metriport Facility ID from the Patient's managingOrganization.\n+ * Assumes the Organization resource contains an identifier with the system\n+ * 'https://metriport.com/fhir/identifiers/organization-id'.\n+ *\n+ * @param medplum - The Medplum client.\n+ * @param patient - The Medplum Patient resource.\n+ * @returns The Metriport Facility ID.\n+ */\n+export async function getMetriportFacilityIdFromMedplumPatient(\n+  medplum: MedplumClient,\n+  patient: Patient\n+): Promise<string | undefined> {\n+  const METRIPORT_ORGANIZATION_ID_SYSTEM = 'https://metriport.com/fhir/identifiers/organization-id';\n+\n+  if (!patient.managingOrganization?.reference) {\n+    console.warn(`Patient ${patient.id} is missing the managingOrganization reference.`);\n+    return undefined;\n+  }\n+\n+  let organization: Organization;\n+  try {\n+    organization = await medplum.readReference(patient.managingOrganization);\n+  } catch (error) {\n+    console.warn(\n+      `Error reading Organization reference ${patient.managingOrganization.reference}: ${normalizeErrorString(error)}`\n+    );\n+    return undefined;\n+  }\n+\n+  const facilityIdentifier = organization.identifier?.find((id) => id.system === METRIPORT_ORGANIZATION_ID_SYSTEM);\n+\n+  if (!facilityIdentifier?.value) {\n+    console.warn(\n+      `Organization ${organization.id} is missing the required Metriport facility identifier (system: ${METRIPORT_ORGANIZATION_ID_SYSTEM}).`\n+    );\n+    return undefined;\n+  }\n+\n+  return facilityIdentifier.value;\n+}\n+\n+// Function overloads to ensure type safety\n+export function buildMetriportPatientPayload(patient: ValidatedPatientData): Demographics;\n+export function buildMetriportPatientPayload(patient: ValidatedPatientData, medplumPatientId: string): PatientCreate;\n+export function buildMetriportPatientPayload(\n+  patient: ValidatedPatientData,\n+  medplumPatientId?: string\n+): Demographics | PatientCreate {\n+  const medplumGenderToMetriportGenderMap: Record<string, 'M' | 'F' | 'O' | 'U'> = {\n+    male: 'M',\n+    female: 'F',\n+    other: 'O',\n+    unknown: 'U',\n+  };\n+\n+  const { firstName, lastName, dob, genderAtBirth, addressLine1, city, state, zip, phone, email } = patient;\n+\n+  const payload = {\n+    firstName,\n+    lastName,\n+    dob,\n+    genderAtBirth: medplumGenderToMetriportGenderMap[genderAtBirth],\n+    address: [{ addressLine1, city, state: USState[state as keyof typeof USState], zip, country: 'USA' }],\n+    contact: [{ phone, email }],\n+  };\n+\n+  if (medplumPatientId) {\n+    return { ...payload, externalId: medplumPatientId } as PatientCreate;\n+  }\n+\n+  return payload as Demographics;\n+}\n+\n+export async function findMatchingMetriportPatient(\n+  metriport: MetriportMedicalApi,\n+  patient: ValidatedPatientData\n+): Promise<PatientDTO | undefined> {\n+  try {\n+    const matchedPatient = await metriport.matchPatient(buildMetriportPatientPayload(patient));\n+    console.log('Found matching patient in Metriport:', JSON.stringify(matchedPatient, null, 2));\n+    return matchedPatient;\n+  } catch (error) {\n+    throw new Error(`Error matching patient in Metriport: ${normalizeErrorString(error)}`, {\n+      cause: error,\n+    });\n+  }\n+}\n+\n+export async function createMetriportPatient(\n+  metriport: MetriportMedicalApi,\n+  patient: ValidatedPatientData,\n+  facilityId: string,\n+  medplumPatientId: string\n+): Promise<PatientDTO> {\n+  try {\n+    const createdPatient = await metriport.createPatient(\n+      buildMetriportPatientPayload(patient, medplumPatientId),\n+      facilityId\n+    );\n+    console.log('Created patient in Metriport:', JSON.stringify(createdPatient, null, 2));\n+    return createdPatient;\n+  } catch (error) {\n+    throw new Error(`Error creating patient in Metriport: ${normalizeErrorString(error)}`, {\n+      cause: error,\n+    });\n+  }\n+}\n\ndiff --git a/package-lock.json b/package-lock.json\nindex c24a2680b9..d34fa784ad 100644\n--- a/package-lock.json\n+++ b/package-lock.json\n@@ -179,6 +179,7 @@\n         \"@medplum/eslint-config\": \"4.1.3\",\n         \"@medplum/fhirtypes\": \"4.1.3\",\n         \"@medplum/mock\": \"4.1.3\",\n+        \"@metriport/api-sdk\": \"14.12.0\",\n         \"@types/node\": \"20.17.30\",\n         \"@types/node-fetch\": \"2.6.12\",\n         \"@types/ssh2-sftp-client\": \"9.0.4\",\n@@ -11230,6 +11231,114 @@\n         \"langium\": \"3.3.1\"\n       }\n     },\n+    \"node_modules/@metriport/api-sdk\": {\n+      \"version\": \"14.12.0\",\n+      \"resolved\": \"https://registry.npmjs.org/@metriport/api-sdk/-/api-sdk-14.12.0.tgz\",\n+      \"integrity\": \"sha512-8t/LzEjkSw6LqSg6JD7z8/dVDCIkC85149ywmg2avajwTa0ZE3AVwbaJHk3GtNnxe93J/G4CIAfVAzeqRAE6Xw==\",\n+      \"dev\": true,\n+      \"license\": \"MIT\",\n+      \"dependencies\": {\n+        \"@medplum/fhirtypes\": \"^2.0.32\",\n+        \"@metriport/commonwell-sdk\": \"^5.6.0\",\n+        \"@metriport/shared\": \"^0.20.0\",\n+        \"axios\": \"^1.4.0\",\n+        \"dayjs\": \"^1.11.7\",\n+        \"dotenv\": \"^16.3.1\",\n+        \"zod\": \"^3.22.1\"\n+      }\n+    },\n+    \"node_modules/@metriport/api-sdk/node_modules/@medplum/fhirtypes\": {\n+      \"version\": \"2.2.10\",\n+      \"resolved\": \"https://registry.npmjs.org/@medplum/fhirtypes/-/fhirtypes-2.2.10.tgz\",\n+      \"integrity\": \"sha512-e2+Ic9DU0VfUaRtvIH4S7cQXTSzokrP6n9gO3L+Yg24lobQ08ESosUmM5QNJvtXXNNbcfGOB19ljweKiXvXNhw==\",\n+      \"dev\": true,\n+      \"license\": \"Apache-2.0\",\n+      \"engines\": {\n+        \"node\": \">=18.0.0\"\n+      }\n+    },\n+    \"node_modules/@metriport/commonwell-sdk\": {\n+      \"version\": \"5.8.1\",\n+      \"resolved\": \"https://registry.npmjs.org/@metriport/commonwell-sdk/-/commonwell-sdk-5.8.1.tgz\",\n+      \"integrity\": \"sha512-RTlA0ZhdGLt5jzVw3kY8wkW4WKD/kSmpoze140nL5MCg7eU5e8Mi0gLUAm9s3cCUNIZMDVBSfIBzxBJ95ehlXA==\",\n+      \"dev\": true,\n+      \"license\": \"MIT\",\n+      \"dependencies\": {\n+        \"@metriport/shared\": \"^0.23.1\",\n+        \"axios\": \"^1.4.0\",\n+        \"http-status\": \"~1.7.0\",\n+        \"jsonwebtoken\": \"^9.0.0\",\n+        \"zod\": \"^3.22.1\"\n+      }\n+    },\n+    \"node_modules/@metriport/commonwell-sdk/node_modules/@medplum/core\": {\n+      \"version\": \"2.2.10\",\n+      \"resolved\": \"https://registry.npmjs.org/@medplum/core/-/core-2.2.10.tgz\",\n+      \"integrity\": \"sha512-03JhETSAtOOlMOG6U9DkgqiSWGfY2b63MlYGWwR8sxft66hblY5tIxuLt2FmW8zRwlABC93xEzyoVpU8CHeYzw==\",\n+      \"dev\": true,\n+      \"license\": \"Apache-2.0\",\n+      \"engines\": {\n+        \"node\": \">=18.0.0\"\n+      },\n+      \"peerDependencies\": {\n+        \"pdfmake\": \"^0.2.5\"\n+      },\n+      \"peerDependenciesMeta\": {\n+        \"pdfmake\": {\n+          \"optional\": true\n+        }\n+      }\n+    },\n+    \"node_modules/@metriport/commonwell-sdk/node_modules/@metriport/shared\": {\n+      \"version\": \"0.23.1\",\n+      \"resolved\": \"https://registry.npmjs.org/@metriport/shared/-/shared-0.23.1.tgz\",\n+      \"integrity\": \"sha512-ZMkxOPbj4usrg8fP/freDRrnMS5DsW7vhwSmaIPz5KZshdzZ2AJDuLozEIf/JGHzLV8Xw+GcFJ1tz10120DxpQ==\",\n+      \"dev\": true,\n+      \"license\": \"MIT\",\n+      \"dependencies\": {\n+        \"@medplum/core\": \"^2.2.10\",\n+        \"axios\": \"^1.4.0\",\n+        \"dayjs\": \"^1.11.9\",\n+        \"fast-xml-parser\": \"^4.4.1\",\n+        \"http-status\": \"~1.7.0\",\n+        \"lodash\": \"^4.17.21\",\n+        \"zod\": \"^3.22.1\"\n+      }\n+    },\n+    \"node_modules/@metriport/shared\": {\n+      \"version\": \"0.20.3\",\n+      \"resolved\": \"https://registry.npmjs.org/@metriport/shared/-/shared-0.20.3.tgz\",\n+      \"integrity\": \"sha512-qb2bXmRSkV31R89DcyFOpy4hxlWgOMqgqyuafS/J8txXG7y6OBh0xT+CCE5EnWdEkZBhwzRqfy5eav/V5HRkPw==\",\n+      \"dev\": true,\n+      \"license\": \"MIT\",\n+      \"dependencies\": {\n+        \"@medplum/core\": \"^2.2.10\",\n+        \"axios\": \"^1.4.0\",\n+        \"dayjs\": \"^1.11.9\",\n+        \"fast-xml-parser\": \"^4.4.1\",\n+        \"http-status\": \"~1.7.0\",\n+        \"lodash\": \"^4.17.21\",\n+        \"zod\": \"^3.22.1\"\n+      }\n+    },\n+    \"node_modules/@metriport/shared/node_modules/@medplum/core\": {\n+      \"version\": \"2.2.10\",\n+      \"resolved\": \"https://registry.npmjs.org/@medplum/core/-/core-2.2.10.tgz\",\n+      \"integrity\": \"sha512-03JhETSAtOOlMOG6U9DkgqiSWGfY2b63MlYGWwR8sxft66hblY5tIxuLt2FmW8zRwlABC93xEzyoVpU8CHeYzw==\",\n+      \"dev\": true,\n+      \"license\": \"Apache-2.0\",\n+      \"engines\": {\n+        \"node\": \">=18.0.0\"\n+      },\n+      \"peerDependencies\": {\n+        \"pdfmake\": \"^0.2.5\"\n+      },\n+      \"peerDependenciesMeta\": {\n+        \"pdfmake\": {\n+          \"optional\": true\n+        }\n+      }\n+    },\n     \"node_modules/@microsoft/api-documenter\": {\n       \"version\": \"7.26.20\",\n       \"resolved\": \"https://registry.npmjs.org/@microsoft/api-documenter/-/api-documenter-7.26.20.tgz\",\n@@ -31060,6 +31169,16 @@\n         \"url\": \"https://github.com/sponsors/sindresorhus\"\n       }\n     },\n+    \"node_modules/http-status\": {\n+      \"version\": \"1.7.4\",\n+      \"resolved\": \"https://registry.npmjs.org/http-status/-/http-status-1.7.4.tgz\",\n+      \"integrity\": \"sha512-c2qSwNtTlHVYAhMj9JpGdyo0No/+DiKXCJ9pHtZ2Yf3QmPnBIytKSRT7BuyIiQ7icXLynavGmxUqkOjSrAuMuA==\",\n+      \"dev\": true,\n+      \"license\": \"BSD-3-Clause\",\n+      \"engines\": {\n+        \"node\": \">= 0.4.0\"\n+      }\n+    },\n     \"node_modules/http2-wrapper\": {\n       \"version\": \"1.0.3\",\n       \"resolved\": \"https://registry.npmjs.org/http2-wrapper/-/http2-wrapper-1.0.3.tgz\",\n@@ -52929,6 +53048,16 @@\n         \"zen-observable\": \"0.8.15\"\n       }\n     },\n+    \"node_modules/zod\": {\n+      \"version\": \"3.24.3\",\n+      \"resolved\": \"https://registry.npmjs.org/zod/-/zod-3.24.3.tgz\",\n+      \"integrity\": \"sha512-HhY1oqzWCQWuUqvBFnsyrtZRhyPeR7SUGv+C4+MsisMuVfSPx8HpwWqH8tRahSlt6M3PiFAcoeFhZAqIXTxoSg==\",\n+      \"dev\": true,\n+      \"license\": \"MIT\",\n+      \"funding\": {\n+        \"url\": \"https://github.com/sponsors/colinhacks\"\n+      }\n+    },\n     \"node_modules/zwitch\": {\n       \"version\": \"2.0.4\",\n       \"resolved\": \"https://registry.npmjs.org/zwitch/-/zwitch-2.0.4.tgz\",\n",
    "test_patch": "diff --git a/examples/medplum-demo-bots/src/metriport-bots/metriport-consolidated-data-webhook.test.ts b/examples/medplum-demo-bots/src/metriport-bots/metriport-consolidated-data-webhook.test.ts\nnew file mode 100644\nindex 0000000000..9c25047919\n--- /dev/null\n+++ b/examples/medplum-demo-bots/src/metriport-bots/metriport-consolidated-data-webhook.test.ts\n@@ -0,0 +1,342 @@\n+import {\n+  indexSearchParameterBundle,\n+  indexStructureDefinitionBundle,\n+  ContentType,\n+  getReferenceString,\n+} from '@medplum/core';\n+import { readJson, SEARCH_PARAMETER_BUNDLE_FILES } from '@medplum/definitions';\n+import { Bundle, Encounter, Patient, SearchParameter } from '@medplum/fhirtypes';\n+import { MockClient } from '@medplum/mock';\n+import { randomUUID } from 'crypto';\n+\n+import { convertToTransactionBundle, handler } from './metriport-consolidated-data-webhook';\n+import {\n+  MetriportConsolidatedDataBundle,\n+  JaneSmithMedplumPatient,\n+  JaneSmithMetriportPatient,\n+} from './metriport-test-data';\n+\n+describe('Metriport Consolidated Data Webhook', () => {\n+  const bot = { reference: 'Bot/123' };\n+  const contentType = 'application/fhir+json';\n+  const secrets = {\n+    METRIPORT_API_KEY: { name: 'METRIPORT_API_KEY', valueString: 'test-metriport-api-key' },\n+    METRIPORT_WEBHOOK_KEY: { name: 'METRIPORT_WEBHOOK_KEY', valueString: 'test-metriport-webhook-key' },\n+  };\n+\n+  let medplum: MockClient;\n+\n+  beforeAll(() => {\n+    indexStructureDefinitionBundle(readJson('fhir/r4/profiles-types.json') as Bundle);\n+    indexStructureDefinitionBundle(readJson('fhir/r4/profiles-resources.json') as Bundle);\n+    indexStructureDefinitionBundle(readJson('fhir/r4/profiles-medplum.json') as Bundle);\n+    for (const filename of SEARCH_PARAMETER_BUNDLE_FILES) {\n+      indexSearchParameterBundle(readJson(filename) as Bundle<SearchParameter>);\n+    }\n+  });\n+\n+  beforeEach(async () => {\n+    medplum = new MockClient();\n+  });\n+\n+  test('throws error when missing METRIPORT_API_KEY', async () => {\n+    await expect(\n+      handler(medplum, {\n+        bot,\n+        input: {},\n+        contentType,\n+        secrets: { METRIPORT_WEBHOOK_KEY: secrets.METRIPORT_WEBHOOK_KEY },\n+      })\n+    ).rejects.toThrow('Missing METRIPORT_API_KEY');\n+  });\n+\n+  test('throws error when missing METRIPORT_WEBHOOK_KEY', async () => {\n+    await expect(\n+      handler(medplum, { bot, input: {}, contentType, secrets: { METRIPORT_API_KEY: secrets.METRIPORT_API_KEY } })\n+    ).rejects.toThrow('Missing METRIPORT_WEBHOOK_KEY');\n+  });\n+\n+  test('throws error when missing message type', async () => {\n+    await expect(handler(medplum, { bot, input: {}, contentType, secrets })).rejects.toThrow('Missing message type');\n+  });\n+\n+  test('throws error when missing medplumPatientId', async () => {\n+    const input = {\n+      meta: {\n+        type: 'medical.consolidated-data',\n+      },\n+    };\n+\n+    await expect(handler(medplum, { bot, input, contentType, secrets })).rejects.toThrow(\n+      'Missing medplumPatientId. The startConsolidatedQuery call must include the medplumPatientId metadata.'\n+    );\n+  });\n+\n+  test(\"successfully handles 'ping' message\", async () => {\n+    const pingSequence = 'test-ping-value';\n+    const input = {\n+      meta: {\n+        type: 'ping',\n+      },\n+      ping: pingSequence,\n+    };\n+\n+    await expect(handler(medplum, { bot, input, contentType, secrets })).resolves.toEqual({ pong: pingSequence });\n+  });\n+\n+  test(\"successfully handles 'medical.consolidated-data' message\", async () => {\n+    let medplumPatient: Patient = await medplum.createResource(JaneSmithMedplumPatient);\n+    const medplumPatientReference = getReferenceString(medplumPatient);\n+    const medplumPatientId = medplumPatient.id as string;\n+    const metriportPatientId = JaneSmithMetriportPatient.id;\n+\n+    const input = {\n+      meta: {\n+        messageId: randomUUID(),\n+        when: new Date().toISOString(),\n+        type: 'medical.consolidated-data',\n+        data: {\n+          medplumPatientId: medplumPatientId,\n+        },\n+      },\n+      patients: [\n+        {\n+          patientId: metriportPatientId,\n+          bundle: {\n+            entry: [\n+              {\n+                resource: {\n+                  resourceType: 'DocumentReference',\n+                  content: [\n+                    {\n+                      attachment: {\n+                        url: 'https://api.metriport.com/medical/v1/documents/test-document',\n+                        contentType: 'application/json',\n+                      },\n+                    },\n+                  ],\n+                },\n+              },\n+            ],\n+          },\n+        },\n+      ],\n+    };\n+\n+    global.fetch = vi.fn().mockResolvedValueOnce({\n+      json: vi.fn().mockResolvedValueOnce(MetriportConsolidatedDataBundle),\n+    });\n+\n+    expect(medplumPatient.identifier).toBeUndefined();\n+\n+    await expect(handler(medplum, { bot, input, contentType, secrets })).resolves.toEqual(true);\n+\n+    expect(fetch).toHaveBeenCalledWith('https://api.metriport.com/medical/v1/documents/test-document');\n+\n+    medplumPatient = await medplum.readResource('Patient', medplumPatientId);\n+    expect(medplumPatient.identifier).toStrictEqual([\n+      { system: 'https://metriport.com/fhir/identifiers/patient-id', value: metriportPatientId },\n+    ]);\n+\n+    const practitioners = await medplum.searchResources(\n+      'Practitioner',\n+      'identifier=73fbeae4-f7e6-425b-b9c7-2ff7c258e24d'\n+    );\n+    expect(practitioners).toHaveLength(1);\n+    expect(practitioners[0].name?.[0].family).toBe('Smith');\n+    expect(practitioners[0].name?.[0].given).toEqual(['David', 'K']);\n+\n+    // Verify DocumentReference was created\n+    const docRefs = await medplum.searchResources(\n+      'DocumentReference',\n+      'identifier=52c3523e-4912-4d48-97a8-7e531e0682cb'\n+    );\n+    expect(docRefs).toHaveLength(1);\n+    expect(docRefs[0].description).toStrictEqual('Progress Notes');\n+    expect(docRefs[0].subject?.reference).toStrictEqual(medplumPatientReference);\n+\n+    const locations = await medplum.searchResources('Location', 'identifier=40a528af-5c42-4c05-ae03-f2527137f994');\n+    expect(locations).toHaveLength(1);\n+    expect(locations[0].name).toStrictEqual('MARY FREE BED AT SPARROW');\n+\n+    const encounters = await medplum.searchResources('Encounter', 'identifier=9617b8a1-efd0-4d37-bc0c-ae8b5a5a00a5');\n+    expect(encounters).toHaveLength(1);\n+    expect(encounters[0].status).toStrictEqual('finished');\n+    expect(encounters[0].subject?.reference).toStrictEqual(medplumPatientReference);\n+\n+    const allergies = await medplum.searchResources(\n+      'AllergyIntolerance',\n+      'identifier=51893137-becb-4f5b-963b-7741d1cb8de2'\n+    );\n+    expect(allergies).toHaveLength(1);\n+    expect(allergies[0].reaction?.[0].substance?.text).toStrictEqual('Dust');\n+    expect(allergies[0].patient?.reference).toStrictEqual(medplumPatientReference);\n+\n+    const medications = await medplum.searchResources('Medication', 'identifier=7e6747bd-fc1a-418a-a178-8518db7f95f5');\n+    expect(medications).toHaveLength(1);\n+    expect(medications[0].code?.text).toStrictEqual('oxyCODONE-acetaminophen (PERCOCET) 5-325 mg tablet');\n+\n+    const medicationRequests = await medplum.searchResources(\n+      'MedicationRequest',\n+      'identifier=46806a66-3b4c-43dd-ac0d-7d0b10042ee5'\n+    );\n+    expect(medicationRequests).toHaveLength(1);\n+    expect(medicationRequests[0].medicationReference?.reference).toStrictEqual(getReferenceString(medications[0]));\n+    expect(medicationRequests[0].subject?.reference).toStrictEqual(medplumPatientReference);\n+  });\n+});\n+\n+describe('convertToTransactionBundle', () => {\n+  let medplum: MockClient;\n+  let patient: Patient;\n+  let medplumPatientId: string;\n+\n+  beforeEach(async () => {\n+    medplum = new MockClient();\n+    patient = await medplum.createResource(JaneSmithMedplumPatient);\n+    medplumPatientId = patient.id as string;\n+  });\n+\n+  test('converts a searchset bundle to a transaction bundle', () => {\n+    const transactionBundle = convertToTransactionBundle(MetriportConsolidatedDataBundle, medplumPatientId);\n+\n+    expect(transactionBundle.type).toBe('transaction');\n+    expect(transactionBundle.resourceType).toBe('Bundle');\n+    expect(transactionBundle.entry).toBeDefined();\n+\n+    transactionBundle.entry?.forEach((entry) => {\n+      expect(entry.request).toBeDefined();\n+\n+      if (entry.resource?.resourceType === 'Binary' && entry.request?.url?.startsWith('Patient/')) {\n+        expect(entry.request?.method).toBe('PATCH');\n+        expect(entry.request?.url).toBe(`Patient/${medplumPatientId}`);\n+        expect(entry.resource.contentType).toBe(ContentType.JSON_PATCH);\n+        expect(entry.resource.data).toBeDefined();\n+      } else if (entry.resource) {\n+        expect(entry.request?.method).toBe('PUT');\n+        expect(entry.resource?.id).toBeUndefined();\n+        expect(entry.request?.url).toMatch(new RegExp(`^${entry.resource.resourceType}\\\\?identifier=.+$`));\n+      }\n+    });\n+  });\n+\n+  test('replaces references with fullUrls', () => {\n+    const transactionBundle = convertToTransactionBundle(MetriportConsolidatedDataBundle, medplumPatientId);\n+\n+    const encounter = transactionBundle.entry?.find((entry) => entry.resource?.resourceType === 'Encounter')\n+      ?.resource as Encounter;\n+\n+    expect(encounter?.subject?.reference).toStrictEqual('urn:uuid:0195d965-bfbc-7825-8a8a-b48baf403559');\n+    expect(encounter?.participant?.[0]?.individual?.reference).toStrictEqual(\n+      'urn:uuid:73fbeae4-f7e6-425b-b9c7-2ff7c258e24d'\n+    );\n+    expect(encounter?.location?.[0]?.location?.reference).toStrictEqual(\n+      'urn:uuid:40a528af-5c42-4c05-ae03-f2527137f994'\n+    );\n+  });\n+\n+  test('adds metriport identifier to resource without existing identifiers', () => {\n+    const id = randomUUID();\n+    const bundle: Bundle = {\n+      resourceType: 'Bundle',\n+      type: 'searchset',\n+      entry: [\n+        {\n+          fullUrl: `urn:uuid:${id}`,\n+          resource: {\n+            resourceType: 'Practitioner',\n+            id,\n+            name: [{ given: ['Anne'], family: 'Doe' }],\n+          },\n+        },\n+      ],\n+    };\n+\n+    const transactionBundle = convertToTransactionBundle(bundle, medplumPatientId);\n+\n+    expect((transactionBundle.entry?.[0].resource as any).identifier).toStrictEqual([\n+      {\n+        system: 'https://metriport.com/fhir/identifiers/practitioner-id',\n+        value: id,\n+      },\n+    ]);\n+  });\n+\n+  test('adds metriport identifier to resource with existing identifiers', () => {\n+    const id = randomUUID();\n+    const bundle: Bundle = {\n+      resourceType: 'Bundle',\n+      type: 'searchset',\n+      entry: [\n+        {\n+          fullUrl: `urn:uuid:${id}`,\n+          resource: {\n+            resourceType: 'Practitioner',\n+            id,\n+            name: [{ given: ['Anne'], family: 'Doe' }],\n+            gender: 'female',\n+            birthDate: '1996-02-10',\n+            identifier: [{ system: 'other-system', value: 'other-value' }],\n+          },\n+        },\n+      ],\n+    };\n+\n+    const transactionBundle = convertToTransactionBundle(bundle, medplumPatientId);\n+\n+    expect((transactionBundle.entry?.[0].resource as any).identifier).toStrictEqual([\n+      { system: 'other-system', value: 'other-value' },\n+      { system: 'https://metriport.com/fhir/identifiers/practitioner-id', value: id },\n+    ]);\n+  });\n+\n+  test('formats valid date property in DocumentReference', () => {\n+    const id = randomUUID();\n+    const bundle: Bundle = {\n+      resourceType: 'Bundle',\n+      type: 'searchset',\n+      entry: [\n+        {\n+          fullUrl: `urn:uuid:${id}`,\n+          resource: {\n+            resourceType: 'DocumentReference',\n+            id,\n+            status: 'current',\n+            content: [{ attachment: { contentType: 'text/plain; charset=UTF-8' } }],\n+            date: '2024-01-01',\n+          },\n+        },\n+      ],\n+    };\n+\n+    const transactionBundle = convertToTransactionBundle(bundle, medplumPatientId);\n+\n+    expect((transactionBundle.entry?.[0].resource as any).date).toMatch(\n+      /^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{3}Z$/\n+    );\n+  });\n+\n+  test('removes invalid date property from DocumentReference', () => {\n+    const id = randomUUID();\n+    const bundle: Bundle = {\n+      resourceType: 'Bundle',\n+      type: 'searchset',\n+      entry: [\n+        {\n+          fullUrl: `urn:uuid:${id}`,\n+          resource: {\n+            resourceType: 'DocumentReference',\n+            id,\n+            status: 'current',\n+            content: [{ attachment: { contentType: 'text/plain; charset=UTF-8' } }],\n+            date: 'invalid-date',\n+          },\n+        },\n+      ],\n+    };\n+\n+    const transactionBundle = convertToTransactionBundle(bundle, medplumPatientId);\n+\n+    expect((transactionBundle.entry?.[0].resource as any).date).toBeUndefined();\n+  });\n+});\n\ndiff --git a/examples/medplum-demo-bots/src/metriport-bots/metriport-patient-bot.test.ts b/examples/medplum-demo-bots/src/metriport-bots/metriport-patient-bot.test.ts\nnew file mode 100644\nindex 0000000000..1397641e83\n--- /dev/null\n+++ b/examples/medplum-demo-bots/src/metriport-bots/metriport-patient-bot.test.ts\n@@ -0,0 +1,428 @@\n+import { createReference, indexSearchParameterBundle, indexStructureDefinitionBundle } from '@medplum/core';\n+import { readJson, SEARCH_PARAMETER_BUNDLE_FILES } from '@medplum/definitions';\n+import { Bundle, SearchParameter } from '@medplum/fhirtypes';\n+import { MockClient } from '@medplum/mock';\n+import { MetriportMedicalApi } from '@metriport/api-sdk';\n+import {\n+  buildMetriportPatientPayload,\n+  createMetriportPatient,\n+  findMatchingMetriportPatient,\n+  getMetriportFacilityIdFromMedplumPatient,\n+  handler,\n+  ValidatedPatientData,\n+  validatePatientResource,\n+} from './metriport-patient-bot';\n+import {\n+  CareFacilityMedplumOrganization,\n+  JaneSmithMedplumPatient,\n+  JaneSmithMetriportPatient,\n+} from './metriport-test-data';\n+\n+vi.mock('@metriport/api-sdk', () => ({\n+  MetriportMedicalApi: vi.fn(),\n+  USState: {\n+    AZ: 'AZ',\n+    CA: 'CA',\n+  },\n+}));\n+\n+describe('Metriport Patient Bot', () => {\n+  const bot = { reference: 'Bot/123' };\n+  const contentType = 'application/fhir+json';\n+  const secrets = { METRIPORT_API_KEY: { name: 'METRIPORT_API_KEY', valueString: 'test-metriport-api-key' } };\n+\n+  let medplum: MockClient;\n+\n+  beforeAll(() => {\n+    indexStructureDefinitionBundle(readJson('fhir/r4/profiles-types.json') as Bundle);\n+    indexStructureDefinitionBundle(readJson('fhir/r4/profiles-resources.json') as Bundle);\n+    indexStructureDefinitionBundle(readJson('fhir/r4/profiles-medplum.json') as Bundle);\n+    for (const filename of SEARCH_PARAMETER_BUNDLE_FILES) {\n+      indexSearchParameterBundle(readJson(filename) as Bundle<SearchParameter>);\n+    }\n+  });\n+\n+  beforeEach(async () => {\n+    vi.clearAllMocks();\n+    medplum = new MockClient();\n+  });\n+\n+  test('throws error when missing METRIPORT_API_KEY', async () => {\n+    await expect(handler(medplum, { bot, input: JaneSmithMedplumPatient, contentType, secrets: {} })).rejects.toThrow(\n+      'Missing METRIPORT_API_KEY'\n+    );\n+  });\n+\n+  test('throws error if Metriport.matchPatient fails', async () => {\n+    const error = new Error('Network Error');\n+\n+    vi.mocked(MetriportMedicalApi).mockImplementation(\n+      () =>\n+        ({\n+          matchPatient: vi.fn().mockRejectedValue(error),\n+        }) as Partial<MetriportMedicalApi> as MetriportMedicalApi\n+    );\n+\n+    await expect(handler(medplum, { bot, input: JaneSmithMedplumPatient, contentType, secrets })).rejects.toThrow(\n+      new Error(`Error matching patient in Metriport: Network Error`, {\n+        cause: error,\n+      })\n+    );\n+  });\n+});\n+\n+describe('validatePatientResource', () => {\n+  const requiredFields = [\n+    { field: 'name', test: () => ({ ...JaneSmithMedplumPatient, name: undefined }), message: 'Missing first name' },\n+    {\n+      field: 'name.given',\n+      test: () => ({ ...JaneSmithMedplumPatient, name: [{ family: 'Smith' }] }),\n+      message: 'Missing first name',\n+    },\n+    {\n+      field: 'name.family',\n+      test: () => ({ ...JaneSmithMedplumPatient, name: [{ given: ['Jane'] }] }),\n+      message: 'Missing last name',\n+    },\n+    {\n+      field: 'birthDate',\n+      test: () => ({ ...JaneSmithMedplumPatient, birthDate: undefined }),\n+      message: 'Missing date of birth',\n+    },\n+    { field: 'gender', test: () => ({ ...JaneSmithMedplumPatient, gender: undefined }), message: 'Missing gender' },\n+    {\n+      field: 'address',\n+      test: () => ({ ...JaneSmithMedplumPatient, address: undefined }),\n+      message: 'Missing address information',\n+    },\n+    {\n+      field: 'address.line',\n+      test: () => ({\n+        ...JaneSmithMedplumPatient,\n+        address: [{ city: 'Phoenix', state: 'AZ', postalCode: '85300' }],\n+      }),\n+      message: 'Missing address information',\n+    },\n+    {\n+      field: 'address.city',\n+      test: () => ({\n+        ...JaneSmithMedplumPatient,\n+        address: [{ line: ['123 Arsenal St'], state: 'AZ', postalCode: '85300' }],\n+      }),\n+      message: 'Missing address information',\n+    },\n+    {\n+      field: 'address.state',\n+      test: () => ({\n+        ...JaneSmithMedplumPatient,\n+        address: [{ line: ['123 Arsenal St'], city: 'Phoenix', postalCode: '85300' }],\n+      }),\n+      message: 'Missing address information',\n+    },\n+    {\n+      field: 'address.postalCode',\n+      test: () => ({\n+        ...JaneSmithMedplumPatient,\n+        address: [{ line: ['123 Arsenal St'], city: 'Phoenix', state: 'AZ' }],\n+      }),\n+      message: 'Missing address information',\n+    },\n+  ];\n+\n+  requiredFields.forEach(({ field, test, message }) => {\n+    it(`should throw error when ${field} is missing`, () => {\n+      expect(() => validatePatientResource(test())).toThrow(message);\n+    });\n+  });\n+\n+  test('validates patient with all fields present', () => {\n+    const answers = validatePatientResource(JaneSmithMedplumPatient);\n+\n+    expect(answers).toStrictEqual({\n+      firstName: 'Jane',\n+      lastName: 'Smith',\n+      dob: '1996-02-10',\n+      genderAtBirth: 'female',\n+      addressLine1: '123 Arsenal St',\n+      city: 'Phoenix',\n+      state: 'AZ',\n+      zip: '85300',\n+      phone: '555-555-5555',\n+      email: 'jane.smith@example.com',\n+    });\n+  });\n+\n+  test('validates patient with only required fields', () => {\n+    const minimalPatient = { ...JaneSmithMedplumPatient, telecom: undefined };\n+\n+    const answers = validatePatientResource(minimalPatient);\n+\n+    expect(answers).toStrictEqual({\n+      firstName: 'Jane',\n+      lastName: 'Smith',\n+      dob: '1996-02-10',\n+      genderAtBirth: 'female',\n+      addressLine1: '123 Arsenal St',\n+      city: 'Phoenix',\n+      state: 'AZ',\n+      zip: '85300',\n+      phone: undefined,\n+      email: undefined,\n+    });\n+  });\n+});\n+\n+describe('getMetriportFacilityIdFromMedplumPatient', () => {\n+  let medplum: MockClient;\n+\n+  beforeEach(async () => {\n+    vi.clearAllMocks();\n+    medplum = new MockClient();\n+  });\n+\n+  test('successfully retrieves facility ID', async () => {\n+    const organization = await medplum.createResource(CareFacilityMedplumOrganization);\n+    const patient = await medplum.createResource({\n+      ...JaneSmithMedplumPatient,\n+      managingOrganization: createReference(organization),\n+    });\n+\n+    const facilityId = await getMetriportFacilityIdFromMedplumPatient(medplum, patient);\n+\n+    expect(facilityId).toBe(CareFacilityMedplumOrganization.identifier?.[1].value);\n+  });\n+\n+  test('returns undefined when patient is missing managingOrganization', async () => {\n+    const patient = await medplum.createResource(JaneSmithMedplumPatient);\n+    const facilityId = await getMetriportFacilityIdFromMedplumPatient(medplum, patient);\n+    expect(facilityId).toBeUndefined();\n+  });\n+\n+  test('returns undefined when managingOrganization is missing identifier', async () => {\n+    const organization = await medplum.createResource({\n+      ...CareFacilityMedplumOrganization,\n+      identifier: undefined,\n+    });\n+    const patient = await medplum.createResource({\n+      ...JaneSmithMedplumPatient,\n+      managingOrganization: createReference(organization),\n+    });\n+    const facilityId = await getMetriportFacilityIdFromMedplumPatient(medplum, patient);\n+    expect(facilityId).toBeUndefined();\n+  });\n+});\n+\n+describe('buildMetriportPatientPayload', () => {\n+  const patientData: ValidatedPatientData = {\n+    firstName: 'Jane',\n+    lastName: 'Smith',\n+    dob: '1996-02-10',\n+    genderAtBirth: 'female',\n+    addressLine1: '123 Arsenal St',\n+    city: 'Phoenix',\n+    state: 'AZ',\n+    zip: '85300',\n+    phone: '555-555-5555',\n+    email: 'jane.smith@example.com',\n+  };\n+\n+  const expectedBasePayload = {\n+    firstName: 'Jane',\n+    lastName: 'Smith',\n+    dob: '1996-02-10',\n+    genderAtBirth: 'F',\n+    address: [{ addressLine1: '123 Arsenal St', city: 'Phoenix', state: 'AZ', zip: '85300', country: 'USA' }],\n+    contact: [{ phone: '555-555-5555', email: 'jane.smith@example.com' }],\n+  };\n+\n+  test('returns Demographics when called without medplumPatientId', () => {\n+    const result = buildMetriportPatientPayload(patientData);\n+    expect(result).toStrictEqual(expectedBasePayload);\n+  });\n+\n+  test('returns PatientCreate when called with medplumPatientId', () => {\n+    const medplumPatientId = '123';\n+    const result = buildMetriportPatientPayload(patientData, medplumPatientId);\n+    expect(result).toStrictEqual({ ...expectedBasePayload, externalId: medplumPatientId });\n+  });\n+\n+  test('handles missing optional fields', () => {\n+    const minimalPatientData: ValidatedPatientData = {\n+      firstName: 'Jane',\n+      lastName: 'Smith',\n+      dob: '1996-02-10',\n+      genderAtBirth: 'female',\n+      addressLine1: '123 Arsenal St',\n+      city: 'Phoenix',\n+      state: 'AZ',\n+      zip: '85300',\n+    };\n+\n+    const result = buildMetriportPatientPayload(minimalPatientData);\n+    expect(result).toStrictEqual({\n+      ...expectedBasePayload,\n+      contact: [{ phone: undefined, email: undefined }],\n+    });\n+  });\n+\n+  test('maps gender correctly', () => {\n+    const genderMappings = [\n+      { input: 'male', expected: 'M' },\n+      { input: 'female', expected: 'F' },\n+      { input: 'other', expected: 'O' },\n+      { input: 'unknown', expected: 'U' },\n+    ];\n+\n+    genderMappings.forEach(({ input, expected }) => {\n+      const testData = { ...patientData, genderAtBirth: input };\n+      const result = buildMetriportPatientPayload(testData);\n+      expect(result.genderAtBirth).toStrictEqual(expected);\n+    });\n+  });\n+});\n+\n+describe('findMatchingMetriportPatient', () => {\n+  let mockMetriport: MetriportMedicalApi;\n+\n+  const patientData: ValidatedPatientData = {\n+    firstName: 'Jane',\n+    lastName: 'Smith',\n+    dob: '1996-02-10',\n+    genderAtBirth: 'female',\n+    addressLine1: '123 Arsenal St',\n+    city: 'Phoenix',\n+    state: 'AZ',\n+    zip: '85300',\n+    phone: '555-555-5555',\n+    email: 'jane.smith@example.com',\n+  };\n+  const matchPatientCalledWith = {\n+    firstName: 'Jane',\n+    lastName: 'Smith',\n+    dob: '1996-02-10',\n+    genderAtBirth: 'F',\n+    address: [{ addressLine1: '123 Arsenal St', city: 'Phoenix', state: 'AZ', zip: '85300', country: 'USA' }],\n+    contact: [{ phone: '555-555-5555', email: 'jane.smith@example.com' }],\n+  };\n+\n+  beforeEach(() => {\n+    vi.clearAllMocks();\n+    mockMetriport = {\n+      matchPatient: vi.fn().mockImplementation(() => Promise.resolve()),\n+    } as unknown as MetriportMedicalApi;\n+  });\n+\n+  test('successfully matches patient', async () => {\n+    mockMetriport.matchPatient = vi.fn().mockResolvedValueOnce(JaneSmithMetriportPatient);\n+\n+    const result = await findMatchingMetriportPatient(mockMetriport, patientData);\n+\n+    expect(result).toEqual(JaneSmithMetriportPatient);\n+    expect(mockMetriport.matchPatient).toHaveBeenCalledWith(matchPatientCalledWith);\n+  });\n+\n+  test('handles no match', async () => {\n+    mockMetriport.matchPatient = vi.fn().mockResolvedValueOnce(undefined);\n+\n+    const result = await findMatchingMetriportPatient(mockMetriport, patientData);\n+\n+    expect(result).toBeUndefined();\n+    expect(mockMetriport.matchPatient).toHaveBeenCalledWith(matchPatientCalledWith);\n+  });\n+\n+  test('handles Metriport API error', async () => {\n+    const error = new Error('API Error');\n+    mockMetriport.matchPatient = vi.fn().mockRejectedValueOnce(error);\n+\n+    await expect(findMatchingMetriportPatient(mockMetriport, patientData)).rejects.toThrow(\n+      'Error matching patient in Metriport: API Error'\n+    );\n+  });\n+});\n+\n+describe('createMetriportPatient', () => {\n+  let mockMetriport: MetriportMedicalApi;\n+\n+  const patientData: ValidatedPatientData = {\n+    firstName: 'Jane',\n+    lastName: 'Smith',\n+    dob: '1996-02-10',\n+    genderAtBirth: 'female',\n+    addressLine1: '123 Arsenal St',\n+    city: 'Phoenix',\n+    state: 'AZ',\n+    zip: '85300',\n+    phone: '555-555-5555',\n+    email: 'jane.smith@example.com',\n+  };\n+\n+  const facilityId = '0195d964-d166-7226-8912-76934c23c140';\n+  const medplumPatientId = 'Patient/123';\n+\n+  const expectedCreatePayload = {\n+    firstName: 'Jane',\n+    lastName: 'Smith',\n+    dob: '1996-02-10',\n+    genderAtBirth: 'F',\n+    address: [{ addressLine1: '123 Arsenal St', city: 'Phoenix', state: 'AZ', zip: '85300', country: 'USA' }],\n+    contact: [{ phone: '555-555-5555', email: 'jane.smith@example.com' }],\n+    externalId: medplumPatientId,\n+  };\n+\n+  beforeEach(() => {\n+    vi.clearAllMocks();\n+    mockMetriport = {\n+      createPatient: vi.fn().mockImplementation(() => Promise.resolve()),\n+    } as unknown as MetriportMedicalApi;\n+  });\n+\n+  test('successfully creates patient', async () => {\n+    mockMetriport.createPatient = vi.fn().mockResolvedValueOnce(JaneSmithMetriportPatient);\n+\n+    const result = await createMetriportPatient(mockMetriport, patientData, facilityId, medplumPatientId);\n+\n+    expect(result).toStrictEqual(JaneSmithMetriportPatient);\n+    expect(mockMetriport.createPatient).toHaveBeenCalledWith(expectedCreatePayload, facilityId);\n+  });\n+\n+  test('handles Metriport API error', async () => {\n+    const error = new Error('API Error');\n+    mockMetriport.createPatient = vi.fn().mockRejectedValueOnce(error);\n+\n+    await expect(createMetriportPatient(mockMetriport, patientData, facilityId, medplumPatientId)).rejects.toThrow(\n+      'Error creating patient in Metriport: API Error'\n+    );\n+\n+    expect(mockMetriport.createPatient).toHaveBeenCalledWith(expectedCreatePayload, facilityId);\n+  });\n+\n+  test('creates patient with minimal data', async () => {\n+    const minimalPatientData: ValidatedPatientData = {\n+      firstName: 'Jane',\n+      lastName: 'Smith',\n+      dob: '1996-02-10',\n+      genderAtBirth: 'female',\n+      addressLine1: '123 Arsenal St',\n+      city: 'Phoenix',\n+      state: 'AZ',\n+      zip: '85300',\n+    };\n+\n+    const expectedMinimalPayload = {\n+      firstName: 'Jane',\n+      lastName: 'Smith',\n+      dob: '1996-02-10',\n+      genderAtBirth: 'F',\n+      address: [{ addressLine1: '123 Arsenal St', city: 'Phoenix', state: 'AZ', zip: '85300', country: 'USA' }],\n+      contact: [{ phone: undefined, email: undefined }],\n+      externalId: medplumPatientId,\n+    };\n+\n+    mockMetriport.createPatient = vi.fn().mockResolvedValueOnce(JaneSmithMetriportPatient);\n+\n+    const result = await createMetriportPatient(mockMetriport, minimalPatientData, facilityId, medplumPatientId);\n+\n+    expect(result).toStrictEqual(JaneSmithMetriportPatient);\n+    expect(mockMetriport.createPatient).toHaveBeenCalledWith(expectedMinimalPayload, facilityId);\n+  });\n+});\n\ndiff --git a/examples/medplum-demo-bots/src/metriport-bots/metriport-test-data.ts b/examples/medplum-demo-bots/src/metriport-bots/metriport-test-data.ts\nnew file mode 100644\nindex 0000000000..3e4f2fc8fb\n--- /dev/null\n+++ b/examples/medplum-demo-bots/src/metriport-bots/metriport-test-data.ts\n@@ -0,0 +1,366 @@\n+import { Bundle, Organization, Patient } from '@medplum/fhirtypes';\n+import { PatientDTO } from '@metriport/api-sdk';\n+\n+/* Medplum resources */\n+\n+export const CareFacilityMedplumOrganization: Organization = {\n+  resourceType: 'Organization',\n+  identifier: [\n+    { system: 'http://hl7.org/fhir/sid/us-npi', value: '1234567891' },\n+    { system: 'https://metriport.com/fhir/identifiers/organization-id', value: '0195d964-d166-7226-8912-76934c23c140' },\n+  ],\n+  name: 'Care Facility, LLC',\n+};\n+\n+export const JaneSmithMedplumPatient: Patient = {\n+  resourceType: 'Patient',\n+  name: [{ given: ['Jane'], family: 'Smith' }],\n+  birthDate: '1996-02-10',\n+  gender: 'female',\n+  address: [\n+    {\n+      line: ['123 Arsenal St'],\n+      city: 'Phoenix',\n+      state: 'AZ',\n+      postalCode: '85300',\n+    },\n+  ],\n+  telecom: [\n+    { system: 'phone', value: '555-555-5555' },\n+    { system: 'email', value: 'jane.smith@example.com' },\n+  ],\n+};\n+\n+/* Metriport resources */\n+\n+export const JaneSmithMetriportPatient: PatientDTO = {\n+  id: '0195d965-bfbc-7825-8a8a-b48baf403559',\n+  facilityIds: ['0195d964-d166-7226-8912-76934c23c140'],\n+  externalId: '',\n+  dateCreated: new Date('2025-03-27T20:57:58.974Z'),\n+  firstName: 'Jane',\n+  lastName: 'Smith',\n+  dob: '1996-02-10',\n+  genderAtBirth: 'F',\n+  personalIdentifiers: [],\n+  address: [\n+    {\n+      zip: '85300',\n+      city: 'Phoenix',\n+      state: 'AZ',\n+      country: 'USA',\n+      addressLine1: '123 Arsenal St',\n+    },\n+  ],\n+  contact: [],\n+};\n+\n+export const MetriportConsolidatedDataBundle: Bundle = {\n+  resourceType: 'Bundle',\n+  total: 8,\n+  type: 'searchset',\n+  entry: [\n+    {\n+      fullUrl: 'urn:uuid:0195d965-bfbc-7825-8a8a-b48baf403559',\n+      resource: {\n+        resourceType: 'Patient',\n+        id: '0195d965-bfbc-7825-8a8a-b48baf403559',\n+        text: {\n+          status: 'generated',\n+          div: '<div xmlns=\"http://www.w3.org/1999/xhtml\">Jane Smith</div>',\n+        },\n+        name: [{ family: 'Smith', given: ['Jane'] }],\n+        gender: 'female',\n+        birthDate: '1996-02-10',\n+        address: [{ line: ['123 Arsenal St'], city: 'Phoenix', state: 'AZ', postalCode: '85300', country: 'USA' }],\n+      },\n+    },\n+    {\n+      fullUrl: 'urn:uuid:73fbeae4-f7e6-425b-b9c7-2ff7c258e24d',\n+      resource: {\n+        resourceType: 'Practitioner',\n+        id: '73fbeae4-f7e6-425b-b9c7-2ff7c258e24d',\n+        identifier: [\n+          {\n+            use: 'usual',\n+            system:\n+              'https://public.metriport.com/identifiers//CaregiverIdentifier//1.3.6.1.4.1.37608.1.3.6.1.4.1.37608/ISO',\n+            value: 'P/0KJ2NOQx0H1BySKKZKvw==',\n+          },\n+          {\n+            system: 'https://public.metriport.com/identifiers/Proprietary/1.3.6.1.4.1.37608_',\n+            value: '7v1bjE+iv1TpK7xwyhaXbw==',\n+          },\n+          {\n+            system: 'https://public.metriport.com/identifiers/Proprietary/1.3.6.1.4.1.37608',\n+            value: 'c68394cb-57ad-e411-8260-0050b664cec5',\n+          },\n+        ],\n+        name: [{ use: 'official', family: 'Smith', given: ['David', 'K'], suffix: ['MD'] }],\n+        qualification: [\n+          {\n+            code: {\n+              text: 'Internal Medicine',\n+              coding: [\n+                {\n+                  code: '207R00000X',\n+                  display: 'INTERNAL MEDICINE PHYSICIAN',\n+                  system: 'http://nucc.org/provider-taxonomy',\n+                },\n+              ],\n+            },\n+          },\n+        ],\n+        telecom: [{ system: 'phone', value: 'tel:212-555-7351', use: 'home' }],\n+        address: [{ line: ['543 Doctor Avenue'], city: 'New York', state: 'NY', postalCode: '10001', use: 'home' }],\n+      },\n+    },\n+    {\n+      fullUrl: 'urn:uuid:52c3523e-4912-4d48-97a8-7e531e0682cb',\n+      resource: {\n+        resourceType: 'DocumentReference',\n+        id: '52c3523e-4912-4d48-97a8-7e531e0682cb',\n+        identifier: [\n+          {\n+            use: 'usual',\n+            value: '1490066281_20231002103338_HXRuUxbOQlKwMya5aDUWdw==_1+Fsp7QaCzgtXoIkGo252w==',\n+          },\n+        ],\n+        status: 'current',\n+        type: {\n+          coding: [\n+            { system: 'urn:oid:2.16.840.1.113883.6.1', code: '11506-3', display: 'Progress note' },\n+            { system: 'http://loinc.org', code: '11506-3', display: 'Prog note', userSelected: false },\n+          ],\n+        },\n+        subject: { reference: 'Patient/0195d965-bfbc-7825-8a8a-b48baf403559' },\n+        date: '2023-10-02T10:33:38-04:00',\n+        author: [{ reference: 'Practitioner/73fbeae4-f7e6-425b-b9c7-2ff7c258e24d' }],\n+        description: 'Progress Notes',\n+        content: [\n+          {\n+            attachment: {\n+              contentType: 'text/plain; charset=UTF-8',\n+              data: 'Tm90ZSBwZXJzaXN0ZW50IGh5cGVydGVuc2l2ZSB0cmVuZCBvdmVyIHRoZSBsYXN0IGZldyBkYXlzLiAgSGF2ZSBhZGRlZCBhbWxvZGlwaW5lIDUgbWcgb25jZSBkYWlseS4=',\n+            },\n+          },\n+        ],\n+        context: {\n+          encounter: [{ reference: 'Encounter/9617b8a1-efd0-4d37-bc0c-ae8b5a5a00a5' }],\n+          period: { start: '2023-10-02T10:33:38-04:00' },\n+        },\n+      },\n+    },\n+    {\n+      fullUrl: 'urn:uuid:40a528af-5c42-4c05-ae03-f2527137f994',\n+      resource: {\n+        resourceType: 'Location',\n+        id: '40a528af-5c42-4c05-ae03-f2527137f994',\n+        name: 'MARY FREE BED AT SPARROW',\n+        description: 'MARY FREE BED AT SPARROW',\n+        type: [\n+          {\n+            coding: [\n+              {\n+                system: 'https://public.metriport.com/codes/Proprietary/LocationType',\n+                code: 'SDLOC',\n+                display: 'Service Delivery Location',\n+                userSelected: true,\n+              },\n+            ],\n+          },\n+        ],\n+        address: {\n+          line: ['1215 E MICHIGAN AVE'],\n+          city: 'LANSING',\n+          district: 'INGHAM',\n+          state: 'MI',\n+          postalCode: '48912',\n+          country: 'USA',\n+        },\n+      },\n+    },\n+    {\n+      fullUrl: 'urn:uuid:9617b8a1-efd0-4d37-bc0c-ae8b5a5a00a5',\n+      resource: {\n+        resourceType: 'Encounter',\n+        id: '9617b8a1-efd0-4d37-bc0c-ae8b5a5a00a5',\n+        identifier: [\n+          { use: 'usual', system: 'https://public.metriport.com/encounteridentifiers', value: '1490066281' },\n+        ],\n+        status: 'finished',\n+        class: {\n+          system: 'http://terminology.hl7.org/CodeSystem/v3-ActCode',\n+          code: 'IMP',\n+          display: 'Inpatient Encounter',\n+        },\n+        type: [\n+          {\n+            coding: [\n+              {\n+                system: 'https://public.metriport.com/codes/Proprietary/PatientType',\n+                code: 'Hospital Encounter',\n+                display: 'Hospital Encounter',\n+                userSelected: true,\n+              },\n+              {\n+                system: 'https://www.cms.gov/Medicare/Coding/place-of-service-codes/Place_of_Service_Code_Set',\n+                code: '21',\n+                display: 'Inpatient Hospital',\n+                userSelected: false,\n+              },\n+              {\n+                system: 'http://terminology.hl7.org/CodeSystem/v3-ActCode',\n+                code: 'IMP',\n+                display: 'IMP',\n+                userSelected: false,\n+              },\n+            ],\n+          },\n+        ],\n+        subject: { reference: 'Patient/0195d965-bfbc-7825-8a8a-b48baf403559' },\n+        participant: [\n+          {\n+            type: [\n+              {\n+                coding: [\n+                  {\n+                    system: 'https://public.metriport.com/fhircodes#CaregiverRelationshipType',\n+                    code: 'AttendingPhysician',\n+                    display: 'Attending Physician',\n+                    userSelected: true,\n+                  },\n+                ],\n+              },\n+            ],\n+            period: { start: '2023-09-20T16:51:00-04:00' },\n+            individual: { reference: 'Practitioner/73fbeae4-f7e6-425b-b9c7-2ff7c258e24d' },\n+          },\n+        ],\n+        period: {\n+          start: '2023-09-20T16:51:00-04:00',\n+          end: '2023-10-03T11:00:00-04:00',\n+        },\n+        hospitalization: {\n+          dischargeDisposition: {\n+            coding: [\n+              {\n+                system: 'https://public.metriport.com/codes/Proprietary.2.16.840.1.113883.12.112/DischargeType',\n+                code: '1',\n+                display: 'Discharged to home care or self care (routine discharge)',\n+                userSelected: true,\n+              },\n+              {\n+                system: 'https://www.nubc.org/CodeSystem/PatDischargeStatus',\n+                code: '01',\n+                display: 'DISCHARGED TO HOME OR SELF CARE (ROUTINE DISCHARGE)',\n+                userSelected: false,\n+              },\n+            ],\n+          },\n+        },\n+        location: [\n+          {\n+            location: {\n+              reference: 'Location/40a528af-5c42-4c05-ae03-f2527137f994',\n+              display: 'MARY FREE BED AT SPARROW',\n+            },\n+            period: {\n+              start: '2023-09-20T16:51:00-04:00',\n+              end: '2023-10-03T11:00:00-04:00',\n+            },\n+          },\n+        ],\n+      },\n+    },\n+    {\n+      fullUrl: 'urn:uuid:51893137-becb-4f5b-963b-7741d1cb8de2',\n+      resource: {\n+        resourceType: 'AllergyIntolerance',\n+        id: '51893137-becb-4f5b-963b-7741d1cb8de2',\n+        clinicalStatus: {\n+          coding: [\n+            {\n+              system: 'http://terminology.hl7.org/CodeSystem/allergyintolerance-clinical',\n+              code: 'active',\n+            },\n+          ],\n+        },\n+        patient: { reference: 'Patient/0195d965-bfbc-7825-8a8a-b48baf403559' },\n+        onsetDateTime: '2021-06-28T00:00:00.000Z',\n+        recorder: { reference: 'Practitioner/73fbeae4-f7e6-425b-b9c7-2ff7c258e24d' },\n+        reaction: [\n+          {\n+            substance: {\n+              text: 'Dust',\n+              coding: [\n+                {\n+                  system: 'http://www.nlm.nih.gov/research/umls/rxnorm',\n+                  code: '235618',\n+                },\n+              ],\n+            },\n+            manifestation: [\n+              {\n+                text: 'Hives',\n+                coding: [\n+                  {\n+                    system: 'http://snomed.info/sct',\n+                    code: '247472004',\n+                    display: 'Hives',\n+                  },\n+                ],\n+              },\n+            ],\n+            onset: '2021-06-28T00:00:00.000Z',\n+          },\n+        ],\n+      },\n+    },\n+    {\n+      fullUrl: 'urn:uuid:7e6747bd-fc1a-418a-a178-8518db7f95f5',\n+      resource: {\n+        resourceType: 'Medication',\n+        id: '7e6747bd-fc1a-418a-a178-8518db7f95f5',\n+        code: {\n+          text: 'oxyCODONE-acetaminophen (PERCOCET) 5-325 mg tablet',\n+          coding: [\n+            {\n+              code: '1049221',\n+              system: 'http://www.nlm.nih.gov/research/umls/rxnorm',\n+            },\n+            {\n+              code: '0406-0512-01',\n+              system: 'http://hl7.org/fhir/sid/ndc',\n+            },\n+          ],\n+        },\n+      },\n+    },\n+    {\n+      fullUrl: 'urn:uuid:46806a66-3b4c-43dd-ac0d-7d0b10042ee5',\n+      resource: {\n+        resourceType: 'MedicationRequest',\n+        id: '46806a66-3b4c-43dd-ac0d-7d0b10042ee5',\n+        status: 'active',\n+        intent: 'order',\n+        medicationCodeableConcept: {\n+          coding: [\n+            {\n+              system: 'http://www.nlm.nih.gov/research/umls/rxnorm',\n+              code: '997488',\n+              display: 'oxyCODONE-acetaminophen (PERCOCET) 5-325 mg tablet',\n+            },\n+          ],\n+          text: 'oxyCODONE-acetaminophen (PERCOCET) 5-325 mg tablet',\n+        },\n+        subject: { reference: 'Patient/0195d965-bfbc-7825-8a8a-b48baf403559' },\n+        encounter: { reference: 'Encounter/9617b8a1-efd0-4d37-bc0c-ae8b5a5a00a5' },\n+        medicationReference: { reference: 'Medication/7e6747bd-fc1a-418a-a178-8518db7f95f5' },\n+        authoredOn: '2003-04-05T10:13:00-05:00',\n+        requester: { reference: 'Practitioner/73fbeae4-f7e6-425b-b9c7-2ff7c258e24d' },\n+        dosageInstruction: [{ sequence: 1, asNeededBoolean: true }],\n+      },\n+    },\n+  ],\n+};\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6304",
    "pr_id": 6304,
    "issue_id": 6302,
    "repo": "medplum/medplum",
    "problem_statement": "Add tests for legacy UUIDs\nYesterday we reverted `validator` because it started more strictly validating UUID string, especially the \"version\" byte.\n\nIt turns out some customers migrated legacy data from systems that used UUID strings that did not follow the exact technical specifications, and did not correctly use the \"version\" byte, and then started failing the validator.\n\nWe reverted `validator`: https://github.com/medplum/medplum/pull/6289\n\nWe should also add a test somewhere in `server` to avoid this from happening again.  At this point, I think we want to validate that UUIDs are UUID-ish.\n\nThe FHIR spec uses this regex: https://hl7.org/FHIR/datatypes.html#uuid\n\n```\nurn:uuid:[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}\n```",
    "issue_word_count": 131,
    "test_files_count": 1,
    "non_test_files_count": 0,
    "pr_changed_files": [
      "packages/server/src/fhir/repo.test.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/repo.test.ts"
    ],
    "base_commit": "f1ce551246c753af267abd19f3a6548ec9e75b66",
    "head_commit": "da3fb7428d48bc540ae0077988b82cf790c3f7da",
    "repo_url": "https://github.com/medplum/medplum/pull/6304",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6304",
    "dockerfile": "",
    "pr_merged_at": "2025-04-04T03:01:09.000Z",
    "patch": "",
    "test_patch": "diff --git a/packages/server/src/fhir/repo.test.ts b/packages/server/src/fhir/repo.test.ts\nindex 8c57c25102..8f628478c4 100644\n--- a/packages/server/src/fhir/repo.test.ts\n+++ b/packages/server/src/fhir/repo.test.ts\n@@ -1351,6 +1351,26 @@ describe('FHIR Repo', () => {\n       expect((await versionQuery.execute(client))[0].__version).toStrictEqual(Repository.VERSION);\n     });\n   });\n+\n+  test('Legacy UUID support -- non-conformant IDs that match UUID form are accepted', () =>\n+    withTestContext(async () => {\n+      const { repo } = await createTestProject({ withRepo: true });\n+      // Random invalid UUID that is invalid based on RFC9562 for the following reasons:\n+      // 1. The version field (the first digit in the third group) should be 4 to indicate UUID version 4, but here it's e\n+      // 2. The variant field (the first digit in the fourth group) should be 8, 9, a, or b, but here it's c\n+      // This is invalid in a similar way to some of the legacy UUIDs imported from other systems which we must continue to support\n+      // This test fails using the version of the validator.js isUUID (13.15.0) that caused the regression this PR fixed: https://github.com/medplum/medplum/pull/6289\n+      const nonconformantUuid = '03a8d57b-91c2-e45f-c312-a7fe09c2d8e4';\n+      const patient = await repo.createResource<Patient>(\n+        {\n+          id: nonconformantUuid,\n+          resourceType: 'Patient',\n+          name: [{ given: ['Alice'], family: 'Smith' }],\n+        },\n+        { assignedId: true }\n+      );\n+      expect(patient.id).toStrictEqual(nonconformantUuid);\n+    }));\n });\n \n function shuffleString(s: string): string {\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6280",
    "pr_id": 6280,
    "issue_id": 6277,
    "repo": "medplum/medplum",
    "problem_statement": "Practitioner custom search param: qualification-code\nAdd `qualification-code` as a custom search parameter for Practitioner. It searches on `Practitioner.qualification.code`\n\nSee [FHIR R6 Practitioner](https://build.fhir.org/practitioner.html#search) for reference",
    "issue_word_count": 35,
    "test_files_count": 1,
    "non_test_files_count": 3,
    "pr_changed_files": [
      "packages/definitions/dist/fhir/r4/search-parameters-medplum.json",
      "packages/docs/static/data/resourceDefinitions/practitioner.json",
      "packages/server/src/fhir/repo.ts",
      "packages/server/src/fhir/search-params.test.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/search-params.test.ts"
    ],
    "base_commit": "bf08a4873eb17c5833919a0a986a3e99ddd20523",
    "head_commit": "73c24b7e1cacfda2249c3d884b72db38aae14e5d",
    "repo_url": "https://github.com/medplum/medplum/pull/6280",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6280",
    "dockerfile": "",
    "pr_merged_at": "2025-04-09T19:06:01.000Z",
    "patch": "diff --git a/packages/definitions/dist/fhir/r4/search-parameters-medplum.json b/packages/definitions/dist/fhir/r4/search-parameters-medplum.json\nindex 3303046bd3..628b73b016 100644\n--- a/packages/definitions/dist/fhir/r4/search-parameters-medplum.json\n+++ b/packages/definitions/dist/fhir/r4/search-parameters-medplum.json\n@@ -1318,6 +1318,23 @@\n         \"type\": \"token\",\n         \"expression\": \"AsyncJob.status\"\n       }\n+    },\n+    {\n+      \"fullUrl\": \"https://medplum.com/fhir/SearchParameter/Practitioner-qualification-code\",\n+      \"resource\": {\n+        \"resourceType\": \"SearchParameter\",\n+        \"id\": \"Practitioner-qualification-code\",\n+        \"url\": \"https://medplum.com/fhir/SearchParameter/Practitioner-qualification-code\",\n+        \"version\": \"4.0.1\",\n+        \"name\": \"qualification-code\",\n+        \"status\": \"draft\",\n+        \"publisher\": \"Medplum\",\n+        \"description\": \"The type of qualification\",\n+        \"code\": \"qualification-code\",\n+        \"base\": [\"Practitioner\"],\n+        \"type\": \"token\",\n+        \"expression\": \"Practitioner.qualification.code\"\n+      }\n     }\n   ]\n }\n\ndiff --git a/packages/docs/static/data/resourceDefinitions/practitioner.json b/packages/docs/static/data/resourceDefinitions/practitioner.json\nindex a9e1a8401d..31281d4102 100644\n--- a/packages/docs/static/data/resourceDefinitions/practitioner.json\n+++ b/packages/docs/static/data/resourceDefinitions/practitioner.json\n@@ -555,6 +555,12 @@\n       \"type\": \"string\",\n       \"description\": \"A server defined search that may match any of the string fields in the HumanName, including family, give, prefix, suffix, suffix, and/or text\",\n       \"expression\": \"Practitioner.name\"\n+    },\n+    {\n+      \"name\": \"topic\",\n+      \"type\": \"token\",\n+      \"description\": \"The type of qualification\",\n+      \"expression\": \"Practitioner.qualification.code\"\n     }\n   ]\n }\n\ndiff --git a/packages/server/src/fhir/repo.ts b/packages/server/src/fhir/repo.ts\nindex dea43a855a..c4bee0127a 100644\n--- a/packages/server/src/fhir/repo.ts\n+++ b/packages/server/src/fhir/repo.ts\n@@ -1338,7 +1338,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n    * The value should be incremented each time there is a change in the schema (really just columns)\n    * of the resource tables or when there are code changes to `buildResourceRow`.\n    */\n-  static readonly VERSION: number = 1;\n+  static readonly VERSION: number = 2;\n \n   private buildResourceRow(resource: Resource): Record<string, any> {\n     const resourceType = resource.resourceType;\n",
    "test_patch": "diff --git a/packages/server/src/fhir/search-params.test.ts b/packages/server/src/fhir/search-params.test.ts\nindex 00514f35d4..fe57e88cd7 100644\n--- a/packages/server/src/fhir/search-params.test.ts\n+++ b/packages/server/src/fhir/search-params.test.ts\n@@ -327,4 +327,45 @@ describe('Medplum Custom Search Parameters', () => {\n \n       expect(result.entry).toHaveLength(1);\n     }));\n+\n+  test('Search for Practitioner by qualification-code', () =>\n+    withTestContext(async () => {\n+      const practitioner1 = await repo.createResource<Practitioner>({\n+        resourceType: 'Practitioner',\n+        name: [{ given: ['Alice'], family: 'A' }],\n+        qualification: [\n+          {\n+            code: {\n+              coding: [\n+                { code: 'MD', system: 'http://terminology.hl7.org/CodeSystem/v2-0360', display: 'Doctor of Medicine' },\n+              ],\n+            },\n+          },\n+        ],\n+      });\n+      expect(practitioner1).toBeDefined();\n+\n+      const practitioner2 = await repo.createResource<Practitioner>({\n+        resourceType: 'Practitioner',\n+        name: [{ given: ['Bob'], family: 'B' }],\n+        qualification: [\n+          {\n+            code: {\n+              coding: [\n+                { code: 'RN', system: 'http://terminology.hl7.org/CodeSystem/v2-0360', display: 'Registered Nurse' },\n+              ],\n+            },\n+          },\n+        ],\n+      });\n+      expect(practitioner2).toBeDefined();\n+\n+      const result = await repo.search({\n+        resourceType: 'Practitioner',\n+        filters: [{ code: 'qualification-code', operator: Operator.EQUALS, value: 'MD' }],\n+      });\n+\n+      expect(result.entry).toHaveLength(1);\n+      expect(result.entry?.[0]?.resource).toMatchObject(practitioner1);\n+    }));\n });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6276",
    "pr_id": 6276,
    "issue_id": 6272,
    "repo": "medplum/medplum",
    "problem_statement": "Regression in 4.0.4 on use of _include with display references: reference missing reference property\nThis example test will succeed in 4.0.3 but fail in 4.0.4 (see below).\n\nBasically, we are creating a FHIR Resource containing `display` only references and then executing a query with `_include` options on those fields.\n\nIn 4.0.3 this correctly (to my understanding), resolves 1 resource. In 4.0.4 this throws and returns an OperationOutcome with `Reference missing reference property`\n\n```\n      const eobId = randomUUID();\n      const batch = await medplum.executeBatch({\n        resourceType: 'Bundle',\n        type: 'batch',\n        entry: [\n          {\n            fullUrl: `ExplanationOfBenefit/${eobId}`,\n            request: {\n              method: 'PUT',\n              url: `ExplanationOfBenefit/${eobId}`,\n            },\n            resource: {\n              resourceType: 'ExplanationOfBenefit',\n              id: eobId,\n              status: 'active',\n              type: {\n                coding: [{ code: 'claim' }],\n              },\n\n              use: 'claim',\n              created: '2021-01-01',\n              insurer: {\n                display: 'Test Insurer',\n              },\n              patient: {\n                display: 'Test Patient',\n              },\n              provider: {\n                display: 'Test Provider',\n              },\n              outcome: 'complete',\n              insurance: [\n                {\n                  focal: true,\n                  coverage: {\n                    display: 'Test Insurance',\n                  },\n                },\n              ],\n            },\n          },\n        ],\n      });\n\n\n      expect(batch.entry[0].response?.status).toBe('200');\n\n      const response = await medplum.get(\n        '/fhir/R4/ExplanationOfBenefit?_include=ExplanationOfBenefit:encounter&_include=ExplanationOfBenefit:facility&_include=ExplanationOfBenefit:claim&_include=ExplanationOfBenefit:care-team&_include=ExplanationOfBenefit:coverage',\n      );\n\n      expect(response.entry.length).toBe(1);\n```",
    "issue_word_count": 180,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/server/src/fhir/batch.test.ts",
      "packages/server/src/fhir/repo.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/batch.test.ts"
    ],
    "base_commit": "ade2cb1352297e532abf61d5a8fd593279b02bc7",
    "head_commit": "6143ed999c1b131df60199d0f094762b8bfb60e4",
    "repo_url": "https://github.com/medplum/medplum/pull/6276",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6276",
    "dockerfile": "",
    "pr_merged_at": "2025-04-01T18:19:59.000Z",
    "patch": "diff --git a/packages/server/src/fhir/repo.ts b/packages/server/src/fhir/repo.ts\nindex dea43a855a..5ca6194ed9 100644\n--- a/packages/server/src/fhir/repo.ts\n+++ b/packages/server/src/fhir/repo.ts\n@@ -415,6 +415,11 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     reference: Reference,\n     cacheEntry: CacheEntry | undefined\n   ): Promise<Resource | Error> {\n+    if (!reference.reference?.match(/^[A-Z][a-zA-Z]+\\//)) {\n+      // Non-local references cannot be resolved\n+      return new OperationOutcomeError(notFound);\n+    }\n+\n     try {\n       const [resourceType, id] = parseReference(reference);\n       validateResourceType(resourceType);\n",
    "test_patch": "diff --git a/packages/server/src/fhir/batch.test.ts b/packages/server/src/fhir/batch.test.ts\nindex 66b13a623a..6188cb3052 100644\n--- a/packages/server/src/fhir/batch.test.ts\n+++ b/packages/server/src/fhir/batch.test.ts\n@@ -1155,4 +1155,45 @@ describe('Batch and Transaction processing', () => {\n       reference: 'Organization/4640af05-8f7b-4abb-905d-ee56b0aef229',\n     });\n   });\n+\n+  test('_include regression test', async () => {\n+    const transaction: Bundle = {\n+      resourceType: 'Bundle',\n+      type: 'transaction',\n+      entry: [\n+        {\n+          request: {\n+            method: 'POST',\n+            url: 'Observation',\n+          },\n+          resource: {\n+            resourceType: 'Observation',\n+            status: 'final',\n+            subject: { display: 'Mr. Patient' },\n+            code: { coding: [{ system: 'http://snomed.info/sct', code: '1234567890' }] },\n+          },\n+        },\n+      ],\n+    };\n+    const res = await request(app)\n+      .post(`/fhir/R4/`)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .send(transaction);\n+    expect(res.status).toBe(200);\n+    expect(res.body.resourceType).toStrictEqual('Bundle');\n+\n+    const results = res.body as Bundle;\n+    expect(results.entry).toHaveLength(1);\n+    expect(results.type).toStrictEqual('transaction-response');\n+\n+    const query = await request(app)\n+      .get(`/fhir/R4/Observation?_id=${results.entry?.[0].resource?.id}&_include=Observation:subject`)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .send();\n+\n+    expect(query.status).toBe(200);\n+    expect(query.body.entry).toHaveLength(1);\n+  });\n });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6229",
    "pr_id": 6229,
    "issue_id": 4177,
    "repo": "medplum/medplum",
    "problem_statement": "Should FHIRPath support non-standard properties\nA long time ago, we explicitly enabled reading non-standard properties via FHIRPath.  IIRC, the motivating use case was using FHIRPath to read GraphQL properties.\r\n\r\nOriginal PR: https://github.com/medplum/medplum/pull/708\r\n\r\nExample:\r\n\r\n```ts\r\n  test('GraphQL embedded queries', () => {\r\n    const observations: Observation[] = [\r\n      {\r\n        resourceType: 'Observation',\r\n        code: { coding: [{ code: 'ALB' }] },\r\n        valueQuantity: { value: 120, unit: 'ng/dL' },\r\n      },\r\n      {\r\n        resourceType: 'Observation',\r\n        code: { coding: [{ code: 'HBA1C' }] },\r\n        valueQuantity: { value: 5, unit: '%' },\r\n      },\r\n    ];\r\n\r\n    // This is an example of how FHIR GraphQL returns embedded searches.\r\n    // The \"ObservationList\" is not a real property, but a search result.\r\n    const serviceRequest: ServiceRequest = {\r\n      resourceType: 'ServiceRequest',\r\n      ObservationList: observations,\r\n    } as ServiceRequest;\r\n\r\n    const query = \"ObservationList.where(code.coding[0].code='HBA1C').value\";\r\n    const result = evalFhirPathTyped(query, [toTypedValue(serviceRequest)]);\r\n    expect(result).toEqual([\r\n      {\r\n        type: PropertyType.Quantity,\r\n        value: { value: 5, unit: '%' },\r\n      },\r\n    ]);\r\n  });\r\n```\r\n\r\nThat works today.\r\n\r\nThe reason I ask this question is that I recently ran a server profiling exercise, and noticed one of the highest CPU uses is `getTypedPropertyValueWithoutSchema`.  The thing is, `getTypedPropertyValueWithoutSchema` isn't supposed to be called from the server at all, because the server will always have the schema loaded.  `getTypedPropertyValueWithoutSchema` is an escape hatch for client-side code which may not have all `StructureDefinition` resources loaded.\r\n\r\nIt turns out that we're hitting the `getTypedPropertyValueWithoutSchema` due to the `individual-birthdate` `SearchParameter`.\r\n\r\nConsider the input: `{ \"resourceType\": \"Patient\", \"birthDate\": \"1990-01-01\" }`\r\n\r\nConsider the FHIRPath expression: `Patient.birthDate | Person.birthDate | RelatedPerson.birthDate`\r\n\r\nOur FHIRPath engine evaluates each branch of the union:\r\n\r\n1. `Patient.birthDate`\r\n    1. Evaluates `Patient` - matches the current `resourceType`, and carries on\r\n    2. Evaluates `birthDate` - reads the value\r\n2. `Person.birthDate`\r\n    1. Evaluates `Person` - does not match `resourceType`, so tries to read `Person` as a property (this could be skipped)\r\n3. `RelatedPerson.birthDate`\r\n    1. Evaluates `RelatedPerson` - does not match `resourceType`, so tries to read `RelatedPerson` as a property (this could be skipped)\r\n\r\nReading unrecognized properties is particularly expensive in `getTypedPropertyValueWithoutSchema` because it needs to try a bunch of choice-of-type `[x]` permutations.  Ultimately, this ends up being a bunch of wasted effort.\r\n\r\nSo... We are ultimately burning a lot of CPU to support non-standard FHIRPath properties.\r\n\r\nIf we need to preserve this behavior, there are probably some other potential solutions:\r\n\r\n* Make non-standard properties an option input to the FHIRPath engine\r\n* Only evaluate choice-of-type `[x]` code path when the token is lower case (which does have semantic meaning in FHIR)\r\n* Manually optimize the `SearchParameter` expressions - the FHIR spec likes to use the `|` union operator, but that's suboptimal for runtime performance.  We could flatten those out.",
    "issue_word_count": 421,
    "test_files_count": 1,
    "non_test_files_count": 5,
    "pr_changed_files": [
      "packages/core/src/fhirpath/parse.ts",
      "packages/core/src/search/details.test.ts",
      "packages/core/src/search/details.ts",
      "packages/server/src/fhir/repo.ts",
      "packages/server/src/fhir/search.ts",
      "packages/server/src/fhir/tokens.ts"
    ],
    "pr_changed_test_files": [
      "packages/core/src/search/details.test.ts"
    ],
    "base_commit": "cebbbfeb7df818bcc3080389d563cec7e675aed9",
    "head_commit": "005c3d4eee622d7128bf62e0e6511ab382e35361",
    "repo_url": "https://github.com/medplum/medplum/pull/6229",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6229",
    "dockerfile": "",
    "pr_merged_at": "2025-04-10T18:10:56.000Z",
    "patch": "diff --git a/packages/core/src/fhirpath/parse.ts b/packages/core/src/fhirpath/parse.ts\nindex 8be30df57c..95a34ca5cd 100644\n--- a/packages/core/src/fhirpath/parse.ts\n+++ b/packages/core/src/fhirpath/parse.ts\n@@ -234,11 +234,11 @@ export function parseFhirPath(input: string): FhirPathAtom {\n \n /**\n  * Evaluates a FHIRPath expression against a resource or other object.\n- * @param expression - The FHIRPath expression to parse.\n+ * @param expression - The FHIRPath expression to evaluate.\n  * @param input - The resource or object to evaluate the expression against.\n  * @returns The result of the FHIRPath expression against the resource or object.\n  */\n-export function evalFhirPath(expression: string, input: unknown): unknown[] {\n+export function evalFhirPath(expression: string | FhirPathAtom, input: unknown): unknown[] {\n   // eval requires a TypedValue array\n   // As a convenience, we can accept array or non-array, and TypedValue or unknown value\n   const array = Array.isArray(input) ? input : [input];\n@@ -253,22 +253,27 @@ export function evalFhirPath(expression: string, input: unknown): unknown[] {\n \n /**\n  * Evaluates a FHIRPath expression against a resource or other object.\n- * @param expression - The FHIRPath expression to parse.\n+ * @param expression - The FHIRPath expression to evaluate.\n  * @param input - The resource or object to evaluate the expression against.\n  * @param variables - A map of variables for eval input.\n  * @param cache - Cache for parsed ASTs.\n  * @returns The result of the FHIRPath expression against the resource or object.\n  */\n export function evalFhirPathTyped(\n-  expression: string,\n+  expression: string | FhirPathAtom,\n   input: TypedValue[],\n   variables: Record<string, TypedValue> = {},\n   cache: LRUCache<FhirPathAtom> | undefined = undefined\n ): TypedValue[] {\n-  const cachedAst = cache?.get(expression);\n-  const ast = cachedAst ?? parseFhirPath(expression);\n-  if (cache && !cachedAst) {\n-    cache.set(expression, ast);\n+  let ast: FhirPathAtom;\n+  if (typeof expression === 'string') {\n+    const cachedAst = cache?.get(expression);\n+    ast = cachedAst ?? parseFhirPath(expression);\n+    if (cache && !cachedAst) {\n+      cache.set(expression, ast);\n+    }\n+  } else {\n+    ast = expression;\n   }\n   return ast.eval({ variables }, input).map((v) => ({\n     type: v.type,\n\ndiff --git a/packages/core/src/search/details.ts b/packages/core/src/search/details.ts\nindex 5a1f40a919..a3990800c2 100644\n--- a/packages/core/src/search/details.ts\n+++ b/packages/core/src/search/details.ts\n@@ -4,6 +4,7 @@ import {\n   AsAtom,\n   BooleanInfixOperatorAtom,\n   DotAtom,\n+  FhirPathAtom,\n   FunctionAtom,\n   IndexerAtom,\n   IsAtom,\n@@ -31,6 +32,7 @@ export type SearchParameterType = (typeof SearchParameterType)[keyof typeof Sear\n export interface SearchParameterDetails {\n   readonly type: SearchParameterType;\n   readonly elementDefinitions?: InternalSchemaElement[];\n+  readonly parsedExpression: FhirPathAtom;\n   readonly array?: boolean;\n }\n \n@@ -121,6 +123,7 @@ function buildSearchParameterDetails(resourceType: string, searchParam: SearchPa\n   const result: SearchParameterDetails = {\n     type: getSearchParameterType(searchParam, builder.propertyTypes),\n     elementDefinitions: builder.elementDefinitions,\n+    parsedExpression: getParsedExpressionForResourceType(resourceType, searchParam.expression as string),\n     array: builder.array,\n   };\n   setSearchParameterDetails(resourceType, code, result);\n@@ -269,6 +272,22 @@ export function getExpressionForResourceType(resourceType: string, expression: s\n   return atoms.map((atom) => atom.toString()).join(' | ');\n }\n \n+export function getParsedExpressionForResourceType(resourceType: string, expression: string): FhirPathAtom {\n+  const atoms: Atom[] = [];\n+  const fhirPathExpression = parseFhirPath(expression);\n+  buildExpressionsForResourceType(resourceType, fhirPathExpression.child, atoms);\n+\n+  if (atoms.length === 0) {\n+    return fhirPathExpression;\n+  }\n+\n+  let result: Atom = atoms[0];\n+  for (let i = 1; i < atoms.length; i++) {\n+    result = new UnionAtom(result, atoms[i]);\n+  }\n+  return new FhirPathAtom('<original-not-available>', result);\n+}\n+\n function buildExpressionsForResourceType(resourceType: string, atom: Atom, result: Atom[]): void {\n   if (atom instanceof UnionAtom) {\n     buildExpressionsForResourceType(resourceType, atom.left, result);\n\ndiff --git a/packages/server/src/fhir/repo.ts b/packages/server/src/fhir/repo.ts\nindex 2fe46a2bf1..5884691df4 100644\n--- a/packages/server/src/fhir/repo.ts\n+++ b/packages/server/src/fhir/repo.ts\n@@ -1508,7 +1508,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n       return;\n     }\n \n-    const values = evalFhirPath(searchParam.expression as string, resource);\n+    const values = evalFhirPath(impl.parsedExpression, resource);\n \n     let columnImpl: ColumnSearchParameterImplementation | undefined;\n     if (impl.searchStrategy === 'token-column') {\n\ndiff --git a/packages/server/src/fhir/search.ts b/packages/server/src/fhir/search.ts\nindex 3ccd8a6cd5..894e24e60c 100644\n--- a/packages/server/src/fhir/search.ts\n+++ b/packages/server/src/fhir/search.ts\n@@ -19,6 +19,7 @@ import {\n   isUUID,\n   OperationOutcomeError,\n   Operator,\n+  parseFhirPath,\n   parseFilterParameter,\n   parseParameter,\n   PropertyType,\n@@ -1052,14 +1053,24 @@ function trySpecialSearchParameter(\n     case '_id':\n       return buildIdSearchFilter(\n         table,\n-        { columnName: 'id', type: SearchParameterType.UUID, searchStrategy: 'column' },\n+        {\n+          columnName: 'id',\n+          type: SearchParameterType.UUID,\n+          searchStrategy: 'column',\n+          parsedExpression: parseFhirPath('id'),\n+        },\n         filter.operator,\n         splitSearchOnComma(filter.value)\n       );\n     case '_lastUpdated':\n       return buildDateSearchFilter(\n         table,\n-        { type: SearchParameterType.DATETIME, columnName: 'lastUpdated', searchStrategy: 'column' },\n+        {\n+          type: SearchParameterType.DATETIME,\n+          columnName: 'lastUpdated',\n+          searchStrategy: 'column',\n+          parsedExpression: parseFhirPath('lastUpdated'),\n+        },\n         filter\n       );\n     case '_compartment':\n@@ -1074,7 +1085,13 @@ function trySpecialSearchParameter(\n \n       return buildIdSearchFilter(\n         table,\n-        { columnName: 'compartments', type: SearchParameterType.UUID, array: true, searchStrategy: 'column' },\n+        {\n+          columnName: 'compartments',\n+          type: SearchParameterType.UUID,\n+          array: true,\n+          searchStrategy: 'column',\n+          parsedExpression: parseFhirPath('compartments'),\n+        },\n         filter.operator,\n         splitSearchOnComma(filter.value)\n       );\n\ndiff --git a/packages/server/src/fhir/tokens.ts b/packages/server/src/fhir/tokens.ts\nindex c6575726e4..161282bcd7 100644\n--- a/packages/server/src/fhir/tokens.ts\n+++ b/packages/server/src/fhir/tokens.ts\n@@ -92,7 +92,8 @@ export function getTokenIndexType(searchParam: SearchParameter, resourceType: st\n  * @param searchParam - The search parameter.\n  */\n export function buildTokensForSearchParameter(result: Token[], resource: Resource, searchParam: SearchParameter): void {\n-  const typedValues = evalFhirPathTyped(searchParam.expression as string, [toTypedValue(resource)]);\n+  const details = getSearchParameterDetails(resource.resourceType, searchParam);\n+  const typedValues = evalFhirPathTyped(details.parsedExpression, [toTypedValue(resource)]);\n   for (const typedValue of typedValues) {\n     buildTokens(result, searchParam, resource, typedValue);\n   }\n",
    "test_patch": "diff --git a/packages/core/src/search/details.test.ts b/packages/core/src/search/details.test.ts\nindex f10dd088c2..443424dab0 100644\n--- a/packages/core/src/search/details.test.ts\n+++ b/packages/core/src/search/details.test.ts\n@@ -113,13 +113,60 @@ describe('SearchParameterDetails', () => {\n     expect(() => getSearchParameterDetails('Patient', missingExpressionParam)).toThrow();\n   });\n \n+  describe('clinical-code', () => {\n+    // \"AllergyIntolerance.code | AllergyIntolerance.reaction.substance | Condition.code | (DeviceRequest.code as CodeableConcept) | DiagnosticReport.code | FamilyMemberHistory.condition.code | List.code | Medication.code | (MedicationAdministration.medication as CodeableConcept) | (MedicationDispense.medication as CodeableConcept) | (MedicationRequest.medication as CodeableConcept) | (MedicationStatement.medication as CodeableConcept) | Observation.code | Procedure.code | ServiceRequest.code\"\n+    const clinicalCodeParam = searchParams.find((e) => e.id === 'clinical-code') as SearchParameter;\n+\n+    test('AllergyIntolerance', () => {\n+      const details = getSearchParameterDetails('AllergyIntolerance', clinicalCodeParam);\n+      expect(details).toBeDefined();\n+      expect(details.type).toStrictEqual(SearchParameterType.TEXT);\n+      expect(details.elementDefinitions).toBeDefined();\n+      expect(details.parsedExpression.toString()).toStrictEqual(\n+        '(AllergyIntolerance.code | AllergyIntolerance.reaction.substance)'\n+      );\n+    });\n+\n+    test('Observation', () => {\n+      const details = getSearchParameterDetails('Observation', clinicalCodeParam);\n+      expect(details).toBeDefined();\n+      expect(details.type).toStrictEqual(SearchParameterType.TEXT);\n+      expect(details.elementDefinitions).toBeDefined();\n+      expect(details.parsedExpression.toString()).toStrictEqual('Observation.code');\n+    });\n+  });\n+\n+  describe('individual-phone', () => {\n+    // \"Patient.telecom.where(system='phone') | Person.telecom.where(system='phone') | Practitioner.telecom.where(system='phone') | PractitionerRole.telecom.where(system='phone') | RelatedPerson.telecom.where(system='phone')\"\n+    const individualPhoneParam = searchParams.find((e) => e.id === 'individual-phone') as SearchParameter;\n+\n+    test('Patient', () => {\n+      const details = getSearchParameterDetails('Patient', individualPhoneParam);\n+      expect(details).toBeDefined();\n+      expect(details.type).toStrictEqual(SearchParameterType.TEXT);\n+      expect(details.elementDefinitions).toBeDefined();\n+      expect(details.parsedExpression.toString()).toStrictEqual(\"Patient.telecom.where((system = 'phone'))\");\n+    });\n+\n+    test('RelatedPerson', () => {\n+      const details = getSearchParameterDetails('RelatedPerson', individualPhoneParam);\n+      expect(details).toBeDefined();\n+      expect(details.type).toStrictEqual(SearchParameterType.TEXT);\n+      expect(details.elementDefinitions).toBeDefined();\n+      expect(details.parsedExpression.toString()).toStrictEqual(\"RelatedPerson.telecom.where((system = 'phone'))\");\n+    });\n+  });\n+\n   test('Observation-value-date', () => {\n-    // expression: '(Observation.value as dateTime) | (Observation.value as Period)',\n+    // \"(Observation.value as dateTime) | (Observation.value as Period)\"\n     const valueDateParam = searchParams.find((e) => e.id === 'Observation-value-date') as SearchParameter;\n     const details = getSearchParameterDetails('Observation', valueDateParam);\n     expect(details).toBeDefined();\n     expect(details.type).toStrictEqual(SearchParameterType.DATETIME);\n     expect(details.elementDefinitions).toBeDefined();\n+    expect(details.parsedExpression.toString()).toStrictEqual(\n+      '((Observation.value as dateTime) | (Observation.value as Period))'\n+    );\n   });\n \n   test('Observation-value-quantity', () => {\n@@ -129,6 +176,9 @@ describe('SearchParameterDetails', () => {\n     expect(details).toBeDefined();\n     expect(details.type).toStrictEqual(SearchParameterType.QUANTITY);\n     expect(details.elementDefinitions).toBeDefined();\n+    expect(details.parsedExpression.toString()).toStrictEqual(\n+      '((Observation.value as Quantity) | (Observation.value as SampledData))'\n+    );\n   });\n \n   test('Encounter-date', () => {\n@@ -138,6 +188,7 @@ describe('SearchParameterDetails', () => {\n     expect(details).toBeDefined();\n     expect(details.type).toStrictEqual(SearchParameterType.DATETIME);\n     expect(details.elementDefinitions).toBeDefined();\n+    expect(details.parsedExpression.toString()).toStrictEqual('Encounter.period');\n   });\n \n   test('Bundle-composition', () => {\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6226",
    "pr_id": 6226,
    "issue_id": 6020,
    "repo": "medplum/medplum",
    "problem_statement": "Create an alternative version of the demo bot cms-1500 that outputs a PDF\n## Description\nWe'd like to have a version of the current demo billing bot for the Health Insurance Claim Form **cms-1500** ([source here](https://github.com/medplum/medplum/blob/main/examples/medplum-demo-bots/src/billing-bots/cms-1500.ts)) that outputs a PDF instead of a CSV. The new bot should be created in the same folder as the existing one.\n\n\n## Resources\n- [Medplum bots - Creating a PDF](https://www.medplum.com/docs/bots/creating-a-pdf)\n- [CMS-1500 template](https://www.cigna.com/static/www-cigna-com/docs/form-cms1500.pdf) - correct version, as pointed out in the comments [here](https://github.com/medplum/medplum/issues/6020#issuecomment-2676964817)\n- https://www.medplum.com/docs/billing/patient-insurance\n",
    "issue_word_count": 133,
    "test_files_count": 3,
    "non_test_files_count": 4,
    "pr_changed_files": [
      "examples/medplum-demo-bots/medplum.config.json",
      "examples/medplum-demo-bots/package.json",
      "examples/medplum-demo-bots/src/billing-bots/README.md",
      "examples/medplum-demo-bots/src/billing-bots/cms-1500-pdf.test.ts",
      "examples/medplum-demo-bots/src/billing-bots/cms-1500-pdf.ts",
      "examples/medplum-demo-bots/src/billing-bots/cms-1500-test-data.ts",
      "examples/medplum-demo-bots/src/billing-bots/cms-1500.test.ts"
    ],
    "pr_changed_test_files": [
      "examples/medplum-demo-bots/src/billing-bots/cms-1500-pdf.test.ts",
      "examples/medplum-demo-bots/src/billing-bots/cms-1500-test-data.ts",
      "examples/medplum-demo-bots/src/billing-bots/cms-1500.test.ts"
    ],
    "base_commit": "8ec2332182c735be3e2b29a75cf4683e19a0c729",
    "head_commit": "6588328d8515b8b69a5b9fd40374f472ebf33508",
    "repo_url": "https://github.com/medplum/medplum/pull/6226",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6226",
    "dockerfile": "",
    "pr_merged_at": "2025-03-28T21:28:42.000Z",
    "patch": "diff --git a/examples/medplum-demo-bots/medplum.config.json b/examples/medplum-demo-bots/medplum.config.json\nindex 0d36e8ad33..1247c67bfd 100644\n--- a/examples/medplum-demo-bots/medplum.config.json\n+++ b/examples/medplum-demo-bots/medplum.config.json\n@@ -89,6 +89,12 @@\n       \"id\": \"\",\n       \"source\": \"./src/slack-bots/demo-slack-bot.ts\",\n       \"dist\": \"./dist/slack-bots/demo-slack-bot.js\"\n+    },\n+    {\n+      \"name\": \"cms-1500-pdf\",\n+      \"id\": \"\",\n+      \"source\": \"src/billing-bots/cms-1500-pdf.ts\",\n+      \"dist\": \"dist/billing-bots/cms-1500-pdf.js\"\n     }\n   ]\n }\n\ndiff --git a/examples/medplum-demo-bots/package.json b/examples/medplum-demo-bots/package.json\nindex 14c3e55c06..9bd9dfcf06 100644\n--- a/examples/medplum-demo-bots/package.json\n+++ b/examples/medplum-demo-bots/package.json\n@@ -12,7 +12,8 @@\n     \"prettier\": \"prettier --write .\",\n     \"test\": \"vitest run\",\n     \"test:coverage\": \"vitest run --coverage\",\n-    \"test:ui\": \"vitest --ui\"\n+    \"test:ui\": \"vitest --ui\",\n+    \"test:watch\": \"vitest watch\"\n   },\n   \"prettier\": {\n     \"printWidth\": 120,\n\ndiff --git a/examples/medplum-demo-bots/src/billing-bots/README.md b/examples/medplum-demo-bots/src/billing-bots/README.md\nindex cdc561a2e8..5d5c64d01a 100644\n--- a/examples/medplum-demo-bots/src/billing-bots/README.md\n+++ b/examples/medplum-demo-bots/src/billing-bots/README.md\n@@ -9,7 +9,11 @@ The implementation consists of two bots:\n \n ## CMS 1500\n \n-The CMS 1500 is a common form for medical claims used to bill Medicare and Medicaid carriers. The CMS 1500 bot takes a [`Claim`](../../../../packages/docs/docs/api/fhir/resources/claim.mdx) resource and maps it to the answers of each item on the CMS 1500 form. It then creates and returns a CSV text representation of these answers.\n+The CMS 1500 is a common form for medical claims used to bill Medicare and Medicaid carriers. There are two CMS 1500 bots available:\n+\n+1. A CSV bot that takes a [`Claim`](../../../../packages/docs/docs/api/fhir/resources/claim.mdx) resource and maps it to the answers of each item on the CMS 1500 form, returning a CSV text representation of these answers.\n+\n+2. A PDF bot that takes a [`Claim`](../../../../packages/docs/docs/api/fhir/resources/claim.mdx) resource and generates a PDF document following the official CMS 1500 form template, with all fields properly positioned according to the form specifications.\n \n ## Superbill\n \n\ndiff --git a/examples/medplum-demo-bots/src/billing-bots/cms-1500-pdf.ts b/examples/medplum-demo-bots/src/billing-bots/cms-1500-pdf.ts\nnew file mode 100644\nindex 0000000000..bc34b1fa6e\n--- /dev/null\n+++ b/examples/medplum-demo-bots/src/billing-bots/cms-1500-pdf.ts\n@@ -0,0 +1,757 @@\n+import {\n+  BotEvent,\n+  formatAddress,\n+  formatCodeableConcept,\n+  formatDate,\n+  formatMoney,\n+  formatQuantity,\n+  getDateProperty,\n+  MedplumClient,\n+} from '@medplum/core';\n+import {\n+  Address,\n+  Claim,\n+  ClaimItem,\n+  Coverage,\n+  Device,\n+  HumanName,\n+  Media,\n+  Organization,\n+  Patient,\n+  Practitioner,\n+  PractitionerRole,\n+  RelatedPerson,\n+} from '@medplum/fhirtypes';\n+import { Content, TDocumentDefinitions } from 'pdfmake/interfaces';\n+\n+export async function handler(medplum: MedplumClient, _event: BotEvent<Claim>): Promise<Media> {\n+  const docDefinition = await getClaimPDFDocDefinition(medplum, _event.input);\n+\n+  const binary = await medplum.createPdf({\n+    docDefinition,\n+  });\n+\n+  const media = await medplum.createResource({\n+    resourceType: 'Media',\n+    status: 'completed',\n+    content: {\n+      contentType: 'application/pdf',\n+      url: 'Binary/' + binary.id,\n+      title: 'cms-1500.pdf',\n+    },\n+  });\n+\n+  return media;\n+}\n+\n+export async function getClaimPDFDocDefinition(medplum: MedplumClient, claim: Claim): Promise<TDocumentDefinitions> {\n+  const patient = await medplum.readReference(claim.patient);\n+  const coverage = await medplum.readReference(claim.insurance[0].coverage);\n+  const insured = coverage.subscriber ? await medplum.readReference(coverage.subscriber) : undefined;\n+  const insurer = await medplum.readReference(coverage.payor[0]);\n+  const provider = await medplum.readReference(claim.provider);\n+  const otherCoverage =\n+    claim.insurance.length > 1 ? await medplum.readReference(claim.insurance[1].coverage) : undefined;\n+  const otherInsured = otherCoverage?.subscriber ? await medplum.readReference(otherCoverage.subscriber) : undefined;\n+  const referralRequest = claim.referral ? await medplum.readReference(claim.referral) : undefined;\n+  const referrer = referralRequest?.requester ? await medplum.readReference(referralRequest.requester) : undefined;\n+\n+  const { personName: patientName, personGender: patientGender, personPhone: patientPhone } = getPersonInfo(patient);\n+  const patientDOB = getDateProperty(patient.birthDate);\n+  const { insuranceType, insuredIdNumber, relationship, coverageName, coveragePolicyName } = getCoverageInfo(coverage);\n+  const {\n+    personName: insuredName,\n+    personPhone: insuredPhone,\n+    personDob: insuredDob,\n+    personGender: insuredGender,\n+  } = getPersonInfo(insured);\n+  const insuredDOB = getDateProperty(insuredDob);\n+\n+  const { coverageName: otherCoverageName, coveragePolicyName: otherCoveragePolicyName } =\n+    getCoverageInfo(otherCoverage);\n+  const { personName: otherInsuredName } = getPersonInfo(otherInsured);\n+\n+  const { referrerName, referrerNpi } = getReferralInfo(referrer);\n+\n+  const docDefinition = {\n+    content: [\n+      {\n+        image: CSM_1500_PDF_BASE_64_BG,\n+        absolutePosition: { x: 0, y: 0 },\n+        width: 612,\n+        height: 792,\n+      },\n+      createPositionedText(patientName, 22, 131),\n+      createPositionedText(insuredIdNumber, 374, 108),\n+      createPositionedText(insuredName, 374, 131),\n+      createPositionedText(otherInsuredName, 22, 228),\n+      createPositionedText(coveragePolicyName, 375, 228),\n+      createPositionedText(otherCoveragePolicyName, 22, 251),\n+      createPositionedText(coverageName, 375, 298),\n+      createPositionedText(otherCoverageName, 22, 324),\n+      createPositionedText(referrerName, 42, 420),\n+      createPositionedText(referrerNpi, 247, 420),\n+      ...getInsuranceProgramContent(insuranceType),\n+      ...getDateContent(patientDOB),\n+      ...getSexContent(patientGender),\n+      ...getAddressContent(patient.address?.[0]),\n+      ...getPhoneContent(patientPhone),\n+      ...getPatientRelationshipToInsuredContent(relationship),\n+      ...getAddressContent(insured?.address?.[0], 374),\n+      ...getPhoneContent(insuredPhone, 482),\n+      ...getClaimContent(claim),\n+      ...getSexContent(insuredGender, 504, 51, 253),\n+      ...getDateContent(insuredDOB, 395, 253),\n+      ...getInsurerContent(insurer),\n+      ...getProviderContent(provider),\n+      ...getReservedNUCCContent(),\n+      ...getSignatureContent(),\n+    ],\n+  };\n+  return docDefinition;\n+}\n+\n+/* PDF content helpers */\n+\n+export function createPositionedText(text: string, x: number, y: number, fontSize: number = 9): Content {\n+  return {\n+    text,\n+    absolutePosition: { x, y },\n+    fontSize,\n+  };\n+}\n+\n+export function getClaimContent(claim: Claim): Content[] {\n+  const {\n+    relatedToEmployment,\n+    relatedToAutoAccident,\n+    accidentLocationState,\n+    relatedToOtherAccident,\n+    dateOfCurrentIllness,\n+    employmentImpactedStart,\n+    employmentImpactedEnd,\n+    hospitalizationStart,\n+    hospitalizationEnd,\n+    priorAuthRefNumber,\n+    outsideLab,\n+    outsideLabCharges,\n+    resubmissionCode,\n+    originalReference,\n+    patientAccountNumber,\n+    patientPaid,\n+    totalCharge,\n+    items,\n+    diagnosis,\n+  } = getClaimInfo(claim);\n+\n+  const dateOfCurrentIllnessAsDate = dateOfCurrentIllness ? getDateProperty(dateOfCurrentIllness) : undefined;\n+  const employmentImpactedStartAsDate = employmentImpactedStart ? getDateProperty(employmentImpactedStart) : undefined;\n+  const employmentImpactedEndAsDate = employmentImpactedEnd ? getDateProperty(employmentImpactedEnd) : undefined;\n+  const hospitalizationStartAsDate = hospitalizationStart ? getDateProperty(hospitalizationStart) : undefined;\n+  const hospitalizationEndAsDate = hospitalizationEnd ? getDateProperty(hospitalizationEnd) : undefined;\n+\n+  return [\n+    createPositionedText(relatedToEmployment ? 'X' : '', 267, 253),\n+    createPositionedText(!relatedToEmployment ? 'X' : '', 310, 253),\n+    createPositionedText(relatedToAutoAccident ? 'X' : '', 267, 277),\n+    createPositionedText(!relatedToAutoAccident ? 'X' : '', 310, 277),\n+    createPositionedText(accidentLocationState, 343, 277),\n+    createPositionedText(relatedToOtherAccident ? 'X' : '', 267, 300),\n+    createPositionedText(!relatedToOtherAccident ? 'X' : '', 310, 300),\n+    ...getDateContent(dateOfCurrentIllnessAsDate, 26, 396),\n+    // Date of current illness' qualifier (specific code to indicate the type of date, such as the onset of illness, date of accident, initial treatment date, etc.)\n+    createPositionedText('', 130, 396),\n+    ...getDateContent(employmentImpactedStartAsDate, 402, 396),\n+    ...getDateContent(employmentImpactedEndAsDate, 503, 396),\n+    ...getDateContent(hospitalizationStartAsDate, 402, 420),\n+    ...getDateContent(hospitalizationEndAsDate, 503, 420),\n+    // Other date\n+    createPositionedText('', 234, 396),\n+    createPositionedText('', 279, 396),\n+    createPositionedText('', 300, 396),\n+    createPositionedText('', 322, 396),\n+    createPositionedText(priorAuthRefNumber, 374, 490),\n+    createPositionedText(outsideLab ? 'X' : '', 388, 444),\n+    createPositionedText(!outsideLab ? 'X' : '', 423, 444),\n+    createPositionedText(outsideLabCharges, 465, 444),\n+    createPositionedText(resubmissionCode, 374, 469),\n+    createPositionedText(originalReference, 456, 469),\n+    createPositionedText(patientAccountNumber, 178, 684),\n+    createPositionedText(totalCharge.replace('$', ''), 381, 684),\n+    createPositionedText(patientPaid.replace('USD', ''), 463, 684),\n+    ...getDiagnosisContent(diagnosis),\n+    ...getClaimItemContent(items),\n+    // Accept assignment\n+    createPositionedText('', 287, 684),\n+    createPositionedText('', 322, 684),\n+  ];\n+}\n+\n+export function getClaimItemContent(items: ClaimItemInfo[]): Content[] {\n+  const content: Content[] = [];\n+\n+  // Base coordinates for each row\n+  const rowBaseCoordinates = [\n+    { y: 540 }, // Row 1\n+    { y: 565 }, // Row 2\n+    { y: 588 }, // Row 3\n+    { y: 613 }, // Row 4\n+    { y: 637 }, // Row 5\n+    { y: 661 }, // Row 6\n+  ];\n+\n+  items.forEach((item, index) => {\n+    // Only process up to 6 items\n+    if (index >= 6) {\n+      return;\n+    }\n+\n+    const yPos = rowBaseCoordinates[index].y;\n+    const rowContent = [\n+      ...getDateContent(getDateProperty(item.dateOfService), 21, yPos),\n+      createPositionedText(item.placeOfServiceState, 149, yPos),\n+      createPositionedText(item.emergency ? 'X' : '', 172, yPos),\n+      createPositionedText(item.procedureCode, 194, yPos),\n+      createPositionedText(item.modifiers, 246, yPos),\n+      createPositionedText(item.diagnosisPointer, 335, yPos),\n+      createPositionedText(item.charges, 373, yPos),\n+      createPositionedText(item.daysOrUnits, 437, yPos),\n+      createPositionedText(item.familyPlanIndicator, 466, yPos),\n+    ];\n+    content.push(...rowContent);\n+  });\n+\n+  return content;\n+}\n+\n+export function getInsuranceProgramContent(insuranceType: string): Content[] {\n+  const optionsMap: Record<string, number> = {\n+    MEDICARE: 23,\n+    MEDICAID: 71,\n+    TRICARE: 122,\n+    CHAMPVA: 187,\n+    'GROUP HEALTH PLAN': 237,\n+    'FECA BLK LUNG': 295,\n+    OTHER: 338,\n+  };\n+\n+  return [createPositionedText('X', optionsMap[insuranceType] ?? 338, 108)];\n+}\n+\n+export function getDateContent(\n+  patientDOB: Date | undefined,\n+  xAxisOffset: number = 236,\n+  yAxisOffset: number = 131\n+): Content[] {\n+  if (!patientDOB) {\n+    return [];\n+  }\n+\n+  const day = String(patientDOB.getUTCDate()).padStart(2, '0');\n+  const month = String(patientDOB.getUTCMonth() + 1).padStart(2, '0');\n+  const year = String(patientDOB.getUTCFullYear()).substring(2);\n+\n+  return [\n+    createPositionedText(day, xAxisOffset, yAxisOffset),\n+    createPositionedText(month, xAxisOffset + 21, yAxisOffset),\n+    createPositionedText(year, xAxisOffset + 42, yAxisOffset),\n+  ];\n+}\n+\n+export function getSexContent(\n+  personGender: string,\n+  xAxisOffset: number = 316,\n+  xAxisDifference: number = 36,\n+  yAxisOffset: number = 131\n+): Content[] {\n+  const optionsMap: Record<string, number> = {\n+    male: xAxisOffset,\n+    female: xAxisOffset + xAxisDifference,\n+  };\n+\n+  if (!(personGender.toLocaleLowerCase() in optionsMap)) {\n+    return [];\n+  }\n+\n+  return [createPositionedText('X', optionsMap[personGender], yAxisOffset)];\n+}\n+\n+export function getPhoneContent(phone: string, xAxisOffset: number = 123, yAxisOffset: number = 204): Content[] {\n+  if (!phone) {\n+    return [];\n+  }\n+\n+  // Validate phone format XXX-XXX-XXXX, (XXX) XXX-XXXX, or XXXXXXXXXX\n+  const phoneRegex = /^(\\(\\d{3}\\)|\\d{3}-|\\d{3})\\s*\\d{3}[-\\s]?\\d{4}$/;\n+  if (!phoneRegex.test(phone)) {\n+    return [];\n+  }\n+\n+  // Extract digits only from the phone number\n+  const digits = phone.replace(/\\D/g, '');\n+  const areaCode = digits.substring(0, 3);\n+  const middle = digits.substring(3, 6);\n+  const last = digits.substring(6);\n+\n+  return [\n+    createPositionedText(areaCode, xAxisOffset, yAxisOffset),\n+    createPositionedText(`${middle}-${last}`, xAxisOffset + 27, yAxisOffset),\n+  ];\n+}\n+\n+export function getAddressContent(address: Address | undefined, xAxisOffset: number = 22): Content[] {\n+  if (!address) {\n+    return [];\n+  }\n+\n+  const { line, city, postalCode, state } = address;\n+\n+  return [\n+    createPositionedText(line?.[0] ?? '', xAxisOffset, 156),\n+    createPositionedText(city ?? '', xAxisOffset, 179),\n+    createPositionedText(state ?? '', xAxisOffset + 181, 179),\n+    createPositionedText(postalCode ?? '', xAxisOffset, 204),\n+  ];\n+}\n+\n+export function getPatientRelationshipToInsuredContent(relationship: string): Content[] {\n+  // Map of relationship codes to x-coordinates\n+  const relationshipMap: Record<string, number> = {\n+    self: 252,\n+    spouse: 289,\n+    child: 317,\n+    other: 353,\n+  };\n+\n+  const xCoord = relationshipMap[relationship.toLowerCase()] ?? relationshipMap['other'];\n+\n+  return [createPositionedText('X', xCoord, 156)];\n+}\n+\n+function getReservedNUCCContent(): Content[] {\n+  return [\n+    createPositionedText('', 229, 179),\n+    createPositionedText('', 22, 275),\n+    createPositionedText('', 375, 277),\n+    createPositionedText('', 393, 277),\n+    createPositionedText('', 22, 298),\n+    createPositionedText('', 386, 324),\n+    createPositionedText('', 22, 324),\n+    createPositionedText('', 422, 324),\n+    createPositionedText('', 21, 440),\n+  ];\n+}\n+\n+function getSignatureContent(): Content[] {\n+  return [\n+    createPositionedText('', 59, 370),\n+    createPositionedText('', 274, 370),\n+    createPositionedText('', 415, 370),\n+    createPositionedText('', 19, 726),\n+    createPositionedText('', 113, 738),\n+  ];\n+}\n+\n+export function getInsurerContent(insurer: Organization | Patient | RelatedPerson): Content[] {\n+  const { serviceNPI, serviceName, serviceLocation, fedTaxNumber } = getInsurerInfo(insurer);\n+\n+  return [\n+    createPositionedText(fedTaxNumber, 20, 684),\n+    // SSN (Social Security Number)\n+    createPositionedText('', 136, 683),\n+    // EIN (Employer Identification Number)\n+    createPositionedText('X', 152, 684),\n+    createPositionedText(serviceNPI, 187, 743),\n+    createPositionedText(serviceName, 177, 705),\n+    createPositionedText(serviceLocation, 177, 716),\n+  ];\n+}\n+\n+export function getProviderContent(provider: Practitioner | Organization | PractitionerRole): Content[] {\n+  const { billingName, billingLocation, billingPhoneNumber, providerNpi } = getProviderInfo(provider);\n+\n+  return [\n+    ...getPhoneContent(billingPhoneNumber, 489, 698),\n+    createPositionedText(billingName, 372, 706),\n+    createPositionedText(billingLocation, 372, 716),\n+    createPositionedText(providerNpi, 380, 743),\n+  ];\n+}\n+\n+export function getDiagnosisContent(diagnosis: string[]): Content[] {\n+  // Up to 12 diagnosis codes\n+  const diagnosisPositions = [\n+    // Row 1\n+    { x: 35, y: 470, index: 0 },\n+    { x: 128, y: 470, index: 1 },\n+    { x: 222, y: 470, index: 2 },\n+    { x: 317, y: 470, index: 3 },\n+    // Row 2\n+    { x: 35, y: 482, index: 4 },\n+    { x: 128, y: 482, index: 5 },\n+    { x: 222, y: 482, index: 6 },\n+    { x: 317, y: 482, index: 7 },\n+    // Row 3\n+    { x: 35, y: 493, index: 8 },\n+    { x: 128, y: 493, index: 9 },\n+    { x: 222, y: 493, index: 10 },\n+    { x: 317, y: 493, index: 11 },\n+  ];\n+\n+  return diagnosisPositions.map(({ x, y, index }) => createPositionedText(diagnosis?.[index] ?? '', x, y));\n+}\n+\n+/* Data retrieval helpers */\n+\n+export function getPersonInfo(\n+  person: Patient | RelatedPerson | undefined\n+): Record<'personName' | 'personDob' | 'personGender' | 'personAddress' | 'personPhone', string> {\n+  if (!person) {\n+    return {\n+      personName: '',\n+      personDob: '',\n+      personGender: '',\n+      personAddress: '',\n+      personPhone: '',\n+    };\n+  }\n+\n+  const personName = person.name?.[0] ? formatHumanName(person.name?.[0]) : '';\n+  const personDob = formatDate(person.birthDate);\n+  const personGender = person.gender ?? '';\n+  const personAddress = person.address ? formatAddress(person.address?.[0]) : '';\n+  const personPhone = person.telecom?.find((telecom) => telecom.system === 'phone')?.value ?? '';\n+\n+  return {\n+    personName,\n+    personDob,\n+    personGender,\n+    personAddress,\n+    personPhone,\n+  };\n+}\n+\n+export function getCoverageInfo(\n+  coverage: Coverage | undefined\n+): Record<\n+  'insuranceType' | 'insuredIdNumber' | 'relationship' | 'coverageName' | 'coveragePolicy' | 'coveragePolicyName',\n+  string\n+> {\n+  if (!coverage) {\n+    return {\n+      insuranceType: '',\n+      insuredIdNumber: '',\n+      relationship: '',\n+      coverageName: '',\n+      coveragePolicy: '',\n+      coveragePolicyName: '',\n+    };\n+  }\n+\n+  const insuranceType = coverage.type?.coding?.[0].display ?? coverage.type?.coding?.[0].code ?? '';\n+  const insuredIdNumber = coverage.identifier?.find((id) => id.use === 'official')?.value ?? '';\n+  const relationship = coverage.relationship?.coding?.[0].display ?? coverage.relationship?.coding?.[0].code ?? '';\n+  const coverageName = coverage.payor[0].display ?? '';\n+  const coveragePlan = coverage.class?.find(\n+    (classification) =>\n+      classification.type.coding?.[0].code === 'plan' || classification.type.coding?.[0].code === 'group'\n+  );\n+  const coveragePolicy = formatCodeableConcept(coveragePlan?.type);\n+  const coveragePolicyName = coveragePlan?.name ?? '';\n+\n+  return {\n+    insuranceType,\n+    insuredIdNumber,\n+    relationship,\n+    coverageName,\n+    coveragePolicy,\n+    coveragePolicyName,\n+  };\n+}\n+\n+export function getClaimInfo(claim: Claim): {\n+  relatedToEmployment: boolean;\n+  relatedToAutoAccident: boolean;\n+  accidentLocation: string;\n+  accidentLocationState: string;\n+  relatedToOtherAccident: boolean;\n+  dateOfCurrentIllness: string;\n+  employmentImpactedStart: string;\n+  employmentImpactedEnd: string;\n+  hospitalizationStart: string;\n+  hospitalizationEnd: string;\n+  priorAuthRefNumber: string;\n+  outsideLab: boolean;\n+  outsideLabCharges: string;\n+  diagnosis: string[];\n+  resubmissionCode: string;\n+  originalReference: string;\n+  patientAccountNumber: string;\n+  patientPaid: string;\n+  totalCharge: string;\n+  items: ClaimItemInfo[];\n+} {\n+  const relatedToEmployment =\n+    claim.supportingInfo?.some((info) => info.category.coding?.[0].code === 'employmentimpacted') ?? false;\n+  const relatedToAutoAccident = claim.accident?.type?.coding?.some((code) => code.code === 'MVA') ?? false;\n+  const accidentLocation = claim.accident?.locationAddress ? formatAddress(claim.accident.locationAddress) : '';\n+  const accidentLocationState = claim.accident?.locationAddress?.state ?? '';\n+  const relatedToOtherAccident = !relatedToAutoAccident && !!claim.accident;\n+\n+  const dateOfCurrentIllness = formatDate(\n+    claim.supportingInfo?.find((info) => info.category.coding?.[0].code === 'onset')?.timingDate\n+  );\n+\n+  const employmentImpacted = claim.supportingInfo?.find(\n+    (info) => info.category.coding?.[0].code === 'employmentimpacted'\n+  );\n+  const employmentImpactedStart = employmentImpacted?.timingPeriod?.start ?? '';\n+  const employmentImpactedEnd = employmentImpacted?.timingPeriod?.end ?? '';\n+\n+  const hospitalization = claim.supportingInfo?.find((info) => info.category.coding?.[0].code === 'hospitalized');\n+  const hospitalizationStart = hospitalization?.timingPeriod?.start\n+    ? formatDate(hospitalization.timingPeriod.start)\n+    : '';\n+  const hospitalizationEnd = hospitalization?.timingPeriod?.end ? formatDate(hospitalization.timingPeriod.end) : '';\n+\n+  const priorAuthRefNumber = claim.insurance[0]?.preAuthRef?.[0] ?? '';\n+\n+  const outsideLab = claim.supportingInfo?.find((info) => info.category.coding?.[0].code === 'outsidelab');\n+  const outsideLabCharges = outsideLab ? formatQuantity(outsideLab.valueQuantity) : '';\n+\n+  const diagnosis = (claim.diagnosis || [])\n+    .map(\n+      (d) =>\n+        d.diagnosisCodeableConcept?.coding?.find((code) => code.system === 'http://hl7.org/fhir/sid/icd-10')?.code ?? ''\n+    )\n+    .filter((code) => code !== '');\n+  const resubmissionCode =\n+    claim.related?.[0].relationship?.coding?.find((code) => code.code === 'prior')?.display ?? '';\n+  const originalReference = claim.related?.[0].claim?.display ?? '';\n+\n+  const patientAccountNumber =\n+    claim.supportingInfo?.find(\n+      (info) =>\n+        info.category?.coding?.find((code) => code.code === 'info') &&\n+        info.code?.coding?.find((code) => code.code === 'patientaccount')\n+    )?.valueString ?? '';\n+  const patientPaid = formatQuantity(\n+    claim.supportingInfo?.find(\n+      (info) =>\n+        info.category?.coding?.find((code) => code.code === 'info') &&\n+        info.code?.coding?.find((code) => code.code === 'patientpaid')\n+    )?.valueQuantity\n+  );\n+  const totalCharge = formatMoney(claim.total);\n+\n+  // Handle multiple service items (up to 6)\n+  const claimItems = claim.item || [];\n+  const items = [];\n+  for (let i = 0; i < Math.min(6, claimItems.length); i++) {\n+    const item = claimItems[i];\n+    const itemInfo = getClaimItemInfo(item);\n+    items.push(itemInfo);\n+  }\n+\n+  return {\n+    relatedToEmployment,\n+    relatedToAutoAccident,\n+    accidentLocation,\n+    accidentLocationState,\n+    relatedToOtherAccident,\n+    dateOfCurrentIllness,\n+    employmentImpactedStart,\n+    employmentImpactedEnd,\n+    hospitalizationStart,\n+    hospitalizationEnd,\n+    priorAuthRefNumber,\n+    outsideLab: !!outsideLab,\n+    outsideLabCharges,\n+    diagnosis,\n+    resubmissionCode,\n+    originalReference,\n+    patientAccountNumber,\n+    patientPaid,\n+    totalCharge,\n+    items,\n+  };\n+}\n+\n+type ClaimItemInfo = ReturnType<typeof getClaimItemInfo>;\n+\n+export function getClaimItemInfo(item: ClaimItem): {\n+  dateOfService: string;\n+  placeOfService: string;\n+  placeOfServiceState: string;\n+  emergency: boolean;\n+  procedureCode: string;\n+  modifiers: string;\n+  diagnosisPointer: string;\n+  charges: string;\n+  daysOrUnits: string;\n+  familyPlanIndicator: string;\n+} {\n+  const dateOfService = formatDate(item.servicedDate);\n+  const placeOfService = item.locationAddress ? formatAddress(item.locationAddress) : '';\n+  const placeOfServiceState = item.locationAddress?.state ?? '';\n+  const emergency = item.category?.coding?.[0].code === 'EMG';\n+  const procedureCode = formatCodeableConcept(item.productOrService);\n+  const modifiers = formatCodeableConcept(item.modifier?.[0]);\n+  const diagnosisPointer = (item.diagnosisSequence || [])\n+    .map((num) => {\n+      // Convert numbers 1-12 to letters A-L\n+      if (num >= 1 && num <= 12) {\n+        return String.fromCharCode(64 + num); // 65 is ASCII for 'A'\n+      }\n+      return '';\n+    })\n+    .filter((letter) => letter)\n+    .join('');\n+  const charges = formatMoney(item.net);\n+  const daysOrUnits = formatQuantity(item.quantity);\n+  const familyPlanIndicator =\n+    item.programCode?.[0].coding?.[0].code === 'none' ? '' : formatCodeableConcept(item.programCode?.[0]);\n+\n+  return {\n+    dateOfService,\n+    placeOfService,\n+    placeOfServiceState,\n+    emergency,\n+    procedureCode,\n+    modifiers,\n+    diagnosisPointer,\n+    charges,\n+    daysOrUnits,\n+    familyPlanIndicator,\n+  };\n+}\n+\n+export function getInsurerInfo(insurer: Organization | Patient | RelatedPerson): {\n+  serviceNPI: string;\n+  serviceName: string;\n+  serviceLocation: string;\n+  fedTaxNumber: string;\n+  fedTaxType: string;\n+} {\n+  if (insurer.resourceType === 'Patient' || insurer.resourceType === 'RelatedPerson') {\n+    return {\n+      serviceNPI: '',\n+      serviceName: '',\n+      serviceLocation: '',\n+      fedTaxNumber: '',\n+      fedTaxType: '',\n+    };\n+  }\n+\n+  const serviceNPI = insurer.identifier?.find((id) => id.system === 'http://hl7.org/fhir/sid/us-npi')?.value ?? '';\n+  const serviceName = insurer.name ?? '';\n+  const serviceLocation = insurer.address ? formatAddress(insurer.address[0]) : '';\n+\n+  const taxIdentifier = insurer.identifier?.find((id) => id.type?.coding?.find((code) => code.code === 'TAX'));\n+  const fedTaxNumber = taxIdentifier?.value ?? '';\n+  const fedTaxType = taxIdentifier?.system ?? '';\n+\n+  return {\n+    serviceNPI,\n+    serviceName,\n+    serviceLocation,\n+    fedTaxNumber,\n+    fedTaxType,\n+  };\n+}\n+\n+export function getProviderInfo(provider: Practitioner | Organization | PractitionerRole): {\n+  billingName: string;\n+  billingLocation: string;\n+  billingPhoneNumber: string;\n+  providerNpi: string;\n+} {\n+  if (provider.resourceType === 'PractitionerRole') {\n+    return {\n+      billingName: '',\n+      billingLocation: '',\n+      billingPhoneNumber: '',\n+      providerNpi: '',\n+    };\n+  }\n+\n+  let billingName = '';\n+  if (provider.resourceType === 'Practitioner' && provider.name?.[0]) {\n+    billingName = formatHumanName(provider.name[0]);\n+  } else if (provider.resourceType === 'Organization' && provider.name) {\n+    billingName = provider.name;\n+  }\n+  const billingLocation = provider?.address?.[0] ? formatAddress(provider.address?.[0]) : '';\n+  const phoneNumber = provider.telecom?.find((comm) => comm.system === 'phone');\n+  const providerNpi = provider.identifier?.find((id) => id.system === 'http://hl7.org/fhir/sid/us-npi')?.value ?? '';\n+\n+  return {\n+    billingName,\n+    billingLocation,\n+    billingPhoneNumber: phoneNumber?.value ?? '',\n+    providerNpi,\n+  };\n+}\n+\n+export function getReferralInfo(\n+  referrer?: Practitioner | Organization | Device | Patient | RelatedPerson | PractitionerRole\n+): Record<string, string> {\n+  if (\n+    !referrer ||\n+    referrer.resourceType === 'Device' ||\n+    referrer.resourceType === 'Patient' ||\n+    referrer.resourceType === 'RelatedPerson' ||\n+    referrer.resourceType === 'PractitionerRole'\n+  ) {\n+    return {\n+      referrerName: '',\n+      referrerNpi: '',\n+    };\n+  }\n+\n+  let referrerName = '';\n+  if (referrer.resourceType === 'Organization') {\n+    referrerName = referrer.name ?? '';\n+  } else {\n+    referrerName = referrer.name?.[0] ? formatHumanName(referrer.name[0]) : '';\n+  }\n+  const referrerNpi = referrer?.identifier?.find((id) => id.system === 'http://hl7.org/fhir/sid/us-npi')?.value ?? '';\n+\n+  return {\n+    referrerName,\n+    referrerNpi,\n+  };\n+}\n+\n+/* General helpers */\n+\n+export function formatHumanName(name: HumanName): string {\n+  const family = name.family ?? '';\n+  const given = name.given ?? [];\n+\n+  if (!family && given.length === 0) {\n+    return '';\n+  }\n+\n+  const [firstName, ...rest] = given;\n+  const middleName = rest.join(' ');\n+\n+  const parts = [];\n+\n+  if (family) {\n+    parts.push(family);\n+  }\n+  if (firstName) {\n+    parts.push(firstName);\n+  }\n+  if (middleName) {\n+    parts.push(middleName);\n+  }\n+\n+  return parts.join(', ');\n+}\n+\n+/* Constants */\n+\n+export const CSM_1500_PDF_BASE_64_BG =\n+  'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA1IAAARMCAMAAACkg1JQAAAC+lBMVEX//////v735Or25Or+/f3++/z+//7//f3//Pz9+/r25On++fn63d386uvoIyv87u798fH74OD99PTymJr0trf74eLxkJL97/D9+Pj0u7z74+T2v8D4zc799vX89vj4yMn50tPylZf14efviIzoJi3zra7739/ykpXzoaL0sbL1uLn79Pb1ubryj5H51tfyk5X2wMH619j2vb7zr7D87O386en85eb75OX24ujzqqz3xMX51dX3y8z85+b629zzp6n3wsP9/PzynaD+9vfudXn50dHzqav88/P1urvym5774uP73t7yo6T98vLwio787OvztLXykZT3xsfqQ0j3x8j85+joLzT57fH4ysv3w8T36e7vl53zn6H23eP509T4zs/++Pj62Nn62tv1rrD62drxl5nympz1r7H0o6X5z9D0oqT56u/xjZD1s7TypKb2u7z0srP1rK70pqjrWFvsa2710Nb1tLbvhIj1q63ypqfrXWH2tbfzmZvwhon0paf1sbP3t7nwgoXxsbbucnXub3LvfH/sZ2rwgIPwkpT0ytDzm53ua2/23+XzkJPvfoHven30nZ/wlZf68fP7+/vxiIv3v8DwjZD4wMLxjI7nLDLoNDrd3d30ztT12d/13OPvoqfk4+Pvd3sjHyD3ubvvm6HpR0vw7+/oOT70i4//+/rwpqzrVFdbWVroKjDwoKX0x830xcr5ycr87u3q6ur49/jsYGTpQUXxio3pPULnMTbzlZjvj5RDQUHsZGc7Ojr1qatTUVHys7nxqrDqUFTqTFE2MzTzlJfQ0NBlZGT5xsfqSk786ej1p6l5eHgwLS4rKCn11Nr09PT5y8xubW1LSUrCwcLX1tbvlJmIMzPtHSXzwcaEHh4FBQXJycmCgIHyvMHyt7zs4OCzs7Pz6urezs6qqqrm19e8u7uMi4vWwcEbGxvtKS/+8/O4lZWfX1+WTU3GqamgcXHQt7evhITken20UlOUlJSunJzLsrK8nJwgHx/Ap6fDoqLSc3UuhyZgAAJDmUlEQVR42uzBgQAAAACAoP2pF6kCAAAAAAAAAAAAAAAAAACYHTtGkRuGwjieB1rDkiYnSZva5EiBkDtsKQIhal5cPFK8JsilcdQMo2YYjM1AirlLJNu78ezs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';\n",
    "test_patch": "diff --git a/examples/medplum-demo-bots/src/billing-bots/cms-1500-pdf.test.ts b/examples/medplum-demo-bots/src/billing-bots/cms-1500-pdf.test.ts\nnew file mode 100644\nindex 0000000000..7c4a217871\n--- /dev/null\n+++ b/examples/medplum-demo-bots/src/billing-bots/cms-1500-pdf.test.ts\n@@ -0,0 +1,1466 @@\n+import { indexSearchParameterBundle, indexStructureDefinitionBundle } from '@medplum/core';\n+import { readJson, SEARCH_PARAMETER_BUNDLE_FILES } from '@medplum/definitions';\n+import {\n+  Address,\n+  Bundle,\n+  Claim,\n+  ClaimItem,\n+  Coverage,\n+  Device,\n+  HumanName,\n+  Organization,\n+  Patient,\n+  Practitioner,\n+  PractitionerRole,\n+  RelatedPerson,\n+  SearchParameter,\n+} from '@medplum/fhirtypes';\n+import { MockClient } from '@medplum/mock';\n+import {\n+  createPositionedText,\n+  formatHumanName,\n+  getAddressContent,\n+  getClaimInfo,\n+  getClaimItemContent,\n+  getClaimItemInfo,\n+  getCoverageInfo,\n+  getDateContent,\n+  getDiagnosisContent,\n+  getInsurerInfo,\n+  getPatientRelationshipToInsuredContent,\n+  getPersonInfo,\n+  getPhoneContent,\n+  getProviderInfo,\n+  getReferralInfo,\n+  getSexContent,\n+  handler,\n+} from './cms-1500-pdf';\n+import { fullAnswer } from './cms-1500-test-data';\n+\n+describe('CMS 1500 PDF Bot', async () => {\n+  let medplum: MockClient;\n+\n+  beforeAll(() => {\n+    indexStructureDefinitionBundle(readJson('fhir/r4/profiles-types.json') as Bundle);\n+    indexStructureDefinitionBundle(readJson('fhir/r4/profiles-resources.json') as Bundle);\n+    for (const filename of SEARCH_PARAMETER_BUNDLE_FILES) {\n+      indexSearchParameterBundle(readJson(filename) as Bundle<SearchParameter>);\n+    }\n+  });\n+\n+  beforeEach(async () => {\n+    medplum = new MockClient();\n+  });\n+\n+  test('Fully answered CMS1500 pdf', async () => {\n+    await medplum.executeBatch(fullAnswer);\n+\n+    const claim = (await medplum.searchOne('Claim', {\n+      identifier: 'example-claim-cms1500',\n+    })) as Claim;\n+\n+    const response = await handler(medplum, {\n+      bot: { reference: 'Bot/123' },\n+      input: claim,\n+      secrets: {},\n+      contentType: 'application/fhir+json',\n+    });\n+\n+    expect(response).toBeDefined();\n+    expect(response.resourceType).toStrictEqual('Media');\n+    expect(response.content.contentType).toStrictEqual('application/pdf');\n+  });\n+});\n+\n+describe('formatHumanName', () => {\n+  test('formats full name with middle name', () => {\n+    const name: HumanName = {\n+      family: 'Smith',\n+      given: ['John', 'Michael'],\n+    };\n+    expect(formatHumanName(name)).toBe('Smith, John, Michael');\n+  });\n+\n+  test('formats name without middle name', () => {\n+    const name: HumanName = {\n+      family: 'Smith',\n+      given: ['John'],\n+    };\n+    expect(formatHumanName(name)).toBe('Smith, John');\n+  });\n+\n+  test('formats multiple middle names', () => {\n+    const name: HumanName = {\n+      family: 'Smith',\n+      given: ['John', 'Michael', 'Robert'],\n+    };\n+    expect(formatHumanName(name)).toBe('Smith, John, Michael Robert');\n+  });\n+\n+  test('formats family name only', () => {\n+    const name: HumanName = {\n+      family: 'Smith',\n+    };\n+    expect(formatHumanName(name)).toBe('Smith');\n+  });\n+\n+  test('formats given names only', () => {\n+    const name: HumanName = {\n+      given: ['John', 'Michael'],\n+    };\n+    expect(formatHumanName(name)).toBe('John, Michael');\n+  });\n+\n+  test('handles empty name', () => {\n+    const name: HumanName = {};\n+    expect(formatHumanName(name)).toBe('');\n+  });\n+\n+  test('handles undefined fields', () => {\n+    const name: HumanName = {\n+      family: undefined,\n+      given: undefined,\n+    };\n+    expect(formatHumanName(name)).toBe('');\n+  });\n+});\n+\n+describe('getPersonInfo', () => {\n+  test('returns complete person info when all Patient fields are present', () => {\n+    const patient = fullAnswer.entry?.[0]?.resource as Patient;\n+\n+    const patientInfo = getPersonInfo(patient);\n+\n+    expect(patientInfo).toStrictEqual({\n+      personName: 'Simpson, Homer',\n+      personGender: 'male',\n+      personDob: '5/12/1956',\n+      personAddress: '742 Evergreen Terrace, Springfield, IL, 62704',\n+      personPhone: '555-555-6392',\n+    });\n+  });\n+\n+  test('returns complete person info when all RelatedPerson fields are present', () => {\n+    const relatedPerson = fullAnswer.entry?.[1]?.resource as RelatedPerson;\n+\n+    const relatedPersonInfo = getPersonInfo(relatedPerson);\n+\n+    expect(relatedPersonInfo).toStrictEqual({\n+      personName: 'Simpson, Marge',\n+      personGender: 'female',\n+      personDob: '8/12/1960',\n+      personAddress: '742 Evergreen Terrace, Springfield, IL, 62704',\n+      personPhone: '555-555-6393',\n+    });\n+  });\n+\n+  test('returns empty strings when person is undefined', () => {\n+    const patientInfo = getPersonInfo(undefined);\n+\n+    expect(patientInfo).toStrictEqual({\n+      personName: '',\n+      personDob: '',\n+      personGender: '',\n+      personAddress: '',\n+      personPhone: '',\n+    });\n+  });\n+\n+  test('handles missing optional fields', () => {\n+    const partialPatient: Patient = {\n+      resourceType: 'Patient',\n+      name: [\n+        {\n+          given: ['Homer'],\n+          family: 'Simpson',\n+        },\n+      ],\n+      gender: 'male',\n+    };\n+\n+    const patientInfo = getPersonInfo(partialPatient);\n+\n+    expect(patientInfo).toStrictEqual({\n+      personName: 'Simpson, Homer',\n+      personDob: '',\n+      personGender: 'male',\n+      personAddress: '',\n+      personPhone: '',\n+    });\n+  });\n+});\n+\n+describe('getCoverageInfo', () => {\n+  test('returns complete coverage info when all Coverage fields are present', () => {\n+    const coverage = fullAnswer.entry?.[6]?.resource as Coverage;\n+\n+    const result = getCoverageInfo(coverage);\n+\n+    expect(result).toStrictEqual({\n+      insuranceType: 'health insurance plan policy',\n+      insuredIdNumber: '89442808',\n+      relationship: 'Spouse',\n+      coverageName: 'Independence Blue Cross Blue Shield',\n+      coveragePolicy: 'plan',\n+      coveragePolicyName: 'Independence Blue Full Coverage',\n+    });\n+  });\n+\n+  test('handles missing optional fields', () => {\n+    const partialCoverage: Coverage = {\n+      resourceType: 'Coverage',\n+      status: 'active',\n+      payor: [{ reference: 'Organization/123' }],\n+      beneficiary: { reference: 'Patient/123' },\n+    };\n+\n+    const result = getCoverageInfo(partialCoverage);\n+\n+    expect(result).toStrictEqual({\n+      insuranceType: '',\n+      insuredIdNumber: '',\n+      relationship: '',\n+      coverageName: '',\n+      coveragePolicy: '',\n+      coveragePolicyName: '',\n+    });\n+  });\n+\n+  test('returns empty strings when coverage is undefined', () => {\n+    const result = getCoverageInfo(undefined);\n+\n+    expect(result).toStrictEqual({\n+      insuranceType: '',\n+      insuredIdNumber: '',\n+      relationship: '',\n+      coverageName: '',\n+      coveragePolicy: '',\n+      coveragePolicyName: '',\n+    });\n+  });\n+});\n+\n+describe('getClaimInfo', () => {\n+  const claim: Claim = {\n+    resourceType: 'Claim',\n+    status: 'active',\n+    use: 'claim',\n+    type: {\n+      coding: [\n+        {\n+          system: 'http://terminology.hl7.org/CodeSystem/claim-type',\n+          code: 'professional',\n+        },\n+      ],\n+    },\n+    created: '2024-03-30',\n+    provider: { reference: 'Practitioner/123' },\n+    priority: {\n+      coding: [\n+        {\n+          system: 'http://terminology.hl7.org/CodeSystem/processpriority',\n+          code: 'normal',\n+        },\n+      ],\n+    },\n+    insurance: [],\n+    patient: { reference: 'Patient/123' },\n+  };\n+\n+  test('returns complete claim info from full answer data', () => {\n+    const claim = fullAnswer.entry?.[9]?.resource as Claim;\n+    const result = getClaimInfo(claim);\n+\n+    expect(result).toEqual({\n+      relatedToEmployment: true,\n+      relatedToAutoAccident: true,\n+      accidentLocation: '39 Green Lane, Wichita, KS',\n+      accidentLocationState: 'KS',\n+      relatedToOtherAccident: false,\n+      dateOfCurrentIllness: '2/2/2024',\n+      employmentImpactedEnd: '2024-04-20',\n+      employmentImpactedStart: '2024-04-02',\n+      hospitalizationEnd: '5/21/2024',\n+      hospitalizationStart: '3/30/2024',\n+      priorAuthRefNumber: '0923092390',\n+      outsideLab: true,\n+      outsideLabCharges: '125 USD',\n+      diagnosis: ['J20', 'G89.4'],\n+      resubmissionCode: 'Prior Claim',\n+      originalReference: '',\n+      patientAccountNumber: '429802409',\n+      patientPaid: '320 USD',\n+      totalCharge: '$1,000.00',\n+      items: [\n+        {\n+          charges: '$1,000.00',\n+          dateOfService: '4/14/2024',\n+          daysOrUnits: '20 days',\n+          diagnosisPointer: 'AB',\n+          emergency: true,\n+          familyPlanIndicator: '',\n+          modifiers: 'None',\n+          placeOfService: '289 Johnson Street, Ames, IA',\n+          placeOfServiceState: 'IA',\n+          procedureCode: 'Exam, recall',\n+        },\n+      ],\n+    });\n+  });\n+\n+  test('handles claim with no accident or employment info', () => {\n+    const result = getClaimInfo(claim);\n+\n+    expect(result).toEqual({\n+      relatedToEmployment: false,\n+      relatedToAutoAccident: false,\n+      accidentLocation: '',\n+      accidentLocationState: '',\n+      relatedToOtherAccident: false,\n+      dateOfCurrentIllness: '',\n+      employmentImpactedEnd: '',\n+      employmentImpactedStart: '',\n+      hospitalizationEnd: '',\n+      hospitalizationStart: '',\n+      priorAuthRefNumber: '',\n+      outsideLab: false,\n+      outsideLabCharges: '',\n+      diagnosis: [],\n+      resubmissionCode: '',\n+      originalReference: '',\n+      patientAccountNumber: '',\n+      patientPaid: '',\n+      totalCharge: '',\n+      items: [],\n+    });\n+  });\n+\n+  test('identifies other accident when accident exists but is not MVA', () => {\n+    const result = getClaimInfo({\n+      ...claim,\n+      accident: {\n+        date: '2024-03-30',\n+        type: {\n+          coding: [\n+            {\n+              code: 'WORK',\n+              system: 'http://terminology.hl7.org/CodeSystem/v3-ActCode',\n+              display: 'Work accident',\n+            },\n+          ],\n+        },\n+      },\n+    });\n+\n+    expect(result).toEqual({\n+      relatedToEmployment: false,\n+      relatedToAutoAccident: false,\n+      accidentLocation: '',\n+      accidentLocationState: '',\n+      relatedToOtherAccident: true,\n+      dateOfCurrentIllness: '',\n+      employmentImpactedEnd: '',\n+      employmentImpactedStart: '',\n+      hospitalizationEnd: '',\n+      hospitalizationStart: '',\n+      priorAuthRefNumber: '',\n+      outsideLab: false,\n+      outsideLabCharges: '',\n+      diagnosis: [],\n+      resubmissionCode: '',\n+      originalReference: '',\n+      patientAccountNumber: '',\n+      patientPaid: '',\n+      totalCharge: '',\n+      items: [],\n+    });\n+  });\n+\n+  test('identifies employment-related claim', () => {\n+    const result = getClaimInfo({\n+      ...claim,\n+      supportingInfo: [\n+        {\n+          category: {\n+            coding: [\n+              {\n+                code: 'employmentimpacted',\n+                system: 'http://terminology.hl7.org/CodeSystem/claiminformationcategory',\n+              },\n+            ],\n+          },\n+          sequence: 1,\n+        },\n+      ],\n+    });\n+\n+    expect(result).toEqual({\n+      relatedToEmployment: true,\n+      relatedToAutoAccident: false,\n+      accidentLocation: '',\n+      accidentLocationState: '',\n+      relatedToOtherAccident: false,\n+      dateOfCurrentIllness: '',\n+      employmentImpactedEnd: '',\n+      employmentImpactedStart: '',\n+      hospitalizationEnd: '',\n+      hospitalizationStart: '',\n+      priorAuthRefNumber: '',\n+      outsideLab: false,\n+      outsideLabCharges: '',\n+      diagnosis: [],\n+      resubmissionCode: '',\n+      originalReference: '',\n+      patientAccountNumber: '',\n+      patientPaid: '',\n+      totalCharge: '',\n+      items: [],\n+    });\n+  });\n+\n+  test('handles partial accident location information', () => {\n+    const result = getClaimInfo({\n+      ...claim,\n+      accident: {\n+        date: '2024-03-30',\n+        locationAddress: {\n+          city: 'Wichita',\n+          state: 'KS',\n+        },\n+        type: {\n+          coding: [\n+            {\n+              code: 'MVA',\n+              system: 'http://terminology.hl7.org/CodeSystem/v3-ActCode',\n+            },\n+          ],\n+        },\n+      },\n+    });\n+\n+    expect(result).toEqual({\n+      relatedToEmployment: false,\n+      relatedToAutoAccident: true,\n+      accidentLocation: 'Wichita, KS',\n+      accidentLocationState: 'KS',\n+      relatedToOtherAccident: false,\n+      dateOfCurrentIllness: '',\n+      employmentImpactedEnd: '',\n+      employmentImpactedStart: '',\n+      hospitalizationEnd: '',\n+      hospitalizationStart: '',\n+      priorAuthRefNumber: '',\n+      outsideLab: false,\n+      outsideLabCharges: '',\n+      diagnosis: [],\n+      resubmissionCode: '',\n+      originalReference: '',\n+      patientAccountNumber: '',\n+      patientPaid: '',\n+      totalCharge: '',\n+      items: [],\n+    });\n+  });\n+});\n+\n+describe('getClaimItemInfo', () => {\n+  test('returns complete claim item info when all fields are present', () => {\n+    const item: ClaimItem = {\n+      sequence: 1,\n+      servicedDate: '2024-04-14',\n+      locationAddress: {\n+        line: ['289 Johnson Street'],\n+        city: 'Ames',\n+        state: 'IA',\n+      },\n+      category: {\n+        coding: [\n+          {\n+            code: 'EMG',\n+          },\n+        ],\n+      },\n+      productOrService: {\n+        text: 'Exam, recall',\n+      },\n+      modifier: [\n+        {\n+          text: 'None',\n+        },\n+      ],\n+      diagnosisSequence: [1],\n+      net: {\n+        value: 1000,\n+        currency: 'USD',\n+      },\n+      quantity: {\n+        value: 20,\n+        unit: 'days',\n+      },\n+      programCode: [\n+        {\n+          coding: [\n+            {\n+              code: 'none',\n+            },\n+          ],\n+        },\n+      ],\n+    };\n+\n+    const result = getClaimItemInfo(item);\n+\n+    expect(result).toEqual({\n+      dateOfService: '4/14/2024',\n+      placeOfService: '289 Johnson Street, Ames, IA',\n+      placeOfServiceState: 'IA',\n+      emergency: true,\n+      procedureCode: 'Exam, recall',\n+      modifiers: 'None',\n+      diagnosisPointer: 'A',\n+      charges: '$1,000.00',\n+      daysOrUnits: '20 days',\n+      familyPlanIndicator: '',\n+    });\n+  });\n+\n+  test('handles missing optional fields', () => {\n+    const item: ClaimItem = {\n+      sequence: 1,\n+      servicedDate: '2024-04-14',\n+      productOrService: {\n+        text: 'Basic exam',\n+      },\n+    };\n+\n+    const result = getClaimItemInfo(item);\n+\n+    expect(result).toEqual({\n+      dateOfService: '4/14/2024',\n+      placeOfService: '',\n+      placeOfServiceState: '',\n+      emergency: false,\n+      procedureCode: 'Basic exam',\n+      modifiers: '',\n+      diagnosisPointer: '',\n+      charges: '',\n+      daysOrUnits: '',\n+      familyPlanIndicator: '',\n+    });\n+  });\n+\n+  test('handles family planning indicator', () => {\n+    const item: ClaimItem = {\n+      sequence: 1,\n+      servicedDate: '2024-04-14',\n+      productOrService: {\n+        text: 'Family planning',\n+      },\n+      programCode: [\n+        {\n+          coding: [\n+            {\n+              code: 'fp',\n+            },\n+          ],\n+          text: 'Family Planning',\n+        },\n+      ],\n+    };\n+\n+    const result = getClaimItemInfo(item);\n+\n+    expect(result).toEqual({\n+      dateOfService: '4/14/2024',\n+      placeOfService: '',\n+      placeOfServiceState: '',\n+      emergency: false,\n+      procedureCode: 'Family planning',\n+      modifiers: '',\n+      diagnosisPointer: '',\n+      charges: '',\n+      daysOrUnits: '',\n+      familyPlanIndicator: 'Family Planning',\n+    });\n+  });\n+});\n+\n+describe('getInsurerInfo', () => {\n+  test('returns complete Organization info when all fields are present', () => {\n+    const organization = fullAnswer.entry?.[4]?.resource as Organization;\n+\n+    const result = getInsurerInfo(organization);\n+\n+    expect(result).toEqual({\n+      fedTaxNumber: '5551844680',\n+      fedTaxType: 'http://example-systemt.org/tax',\n+      serviceLocation: '1901 Market Street, Philadelphia, PA, 19103',\n+      serviceNPI: '7911621876',\n+      serviceName: 'Independence Blue Cross Blue Shield',\n+    });\n+  });\n+\n+  test('handles Organization with missing optional fields', () => {\n+    const organization: Organization = {\n+      resourceType: 'Organization',\n+      name: 'Test Insurance Co',\n+    };\n+\n+    const result = getInsurerInfo(organization);\n+\n+    expect(result).toEqual({\n+      serviceNPI: '',\n+      serviceName: 'Test Insurance Co',\n+      serviceLocation: '',\n+      fedTaxNumber: '',\n+      fedTaxType: '',\n+    });\n+  });\n+\n+  test('handles Organization with multiple identifiers but no matching types', () => {\n+    const organization: Organization = {\n+      resourceType: 'Organization',\n+      name: 'Test Insurance Co',\n+      identifier: [\n+        {\n+          type: {\n+            coding: [\n+              {\n+                code: 'OTHER',\n+              },\n+            ],\n+          },\n+          value: 'OTHER-ID',\n+        },\n+      ],\n+    };\n+\n+    const result = getInsurerInfo(organization);\n+\n+    expect(result).toEqual({\n+      serviceNPI: '',\n+      serviceName: 'Test Insurance Co',\n+      serviceLocation: '',\n+      fedTaxNumber: '',\n+      fedTaxType: '',\n+    });\n+  });\n+\n+  test('returns empty fields for Patient resource', () => {\n+    const patient: Patient = {\n+      resourceType: 'Patient',\n+      name: [\n+        {\n+          given: ['John'],\n+          family: 'Doe',\n+        },\n+      ],\n+    };\n+\n+    const result = getInsurerInfo(patient);\n+\n+    expect(result).toEqual({\n+      serviceNPI: '',\n+      serviceName: '',\n+      serviceLocation: '',\n+      fedTaxNumber: '',\n+      fedTaxType: '',\n+    });\n+  });\n+\n+  test('returns empty fields for RelatedPerson resource', () => {\n+    const relatedPerson: RelatedPerson = {\n+      resourceType: 'RelatedPerson',\n+      name: [\n+        {\n+          given: ['Jane'],\n+          family: 'Doe',\n+        },\n+      ],\n+      patient: { reference: 'Patient/123' },\n+    };\n+\n+    const result = getInsurerInfo(relatedPerson);\n+\n+    expect(result).toEqual({\n+      serviceNPI: '',\n+      serviceName: '',\n+      serviceLocation: '',\n+      fedTaxNumber: '',\n+      fedTaxType: '',\n+    });\n+  });\n+});\n+\n+describe('getProviderInfo', () => {\n+  test('returns complete practitioner info', () => {\n+    const practitioner = fullAnswer.entry?.[3]?.resource as Practitioner;\n+\n+    const result = getProviderInfo(practitioner);\n+\n+    expect(result).toEqual({\n+      billingLocation: '2904 Main Street, Elizabeth, MD, 21219',\n+      billingName: 'Smith, Kevin',\n+      billingPhoneNumber: '555-555-9391',\n+      providerNpi: '2490433892',\n+    });\n+  });\n+\n+  test('returns complete organization info', () => {\n+    const organization = fullAnswer.entry?.[4]?.resource as Organization;\n+\n+    const result = getProviderInfo(organization);\n+\n+    expect(result).toEqual({\n+      billingLocation: '1901 Market Street, Philadelphia, PA, 19103',\n+      billingName: 'Independence Blue Cross Blue Shield',\n+      billingPhoneNumber: '555-555-4321',\n+      providerNpi: '7911621876',\n+    });\n+  });\n+\n+  test('returns empty fields for PractitionerRole', () => {\n+    const practitionerRole: PractitionerRole = {\n+      resourceType: 'PractitionerRole',\n+      practitioner: {\n+        reference: 'Practitioner/123',\n+      },\n+      organization: {\n+        reference: 'Organization/456',\n+      },\n+    };\n+\n+    const result = getProviderInfo(practitionerRole);\n+\n+    expect(result).toEqual({\n+      billingName: '',\n+      billingLocation: '',\n+      billingPhoneNumber: '',\n+      providerNpi: '',\n+    });\n+  });\n+\n+  test('handles practitioner with missing optional fields', () => {\n+    const practitioner: Practitioner = {\n+      resourceType: 'Practitioner',\n+      name: [\n+        {\n+          family: 'Smith',\n+        },\n+      ],\n+    };\n+\n+    const result = getProviderInfo(practitioner);\n+\n+    expect(result).toEqual({\n+      billingName: 'Smith',\n+      billingLocation: '',\n+      billingPhoneNumber: '',\n+      providerNpi: '',\n+    });\n+  });\n+\n+  test('handles organization with missing optional fields', () => {\n+    const organization: Organization = {\n+      resourceType: 'Organization',\n+      name: 'Medical Group',\n+    };\n+\n+    const result = getProviderInfo(organization);\n+\n+    expect(result).toEqual({\n+      billingName: 'Medical Group',\n+      billingLocation: '',\n+      billingPhoneNumber: '',\n+      providerNpi: '',\n+    });\n+  });\n+\n+  test('handles multiple phone numbers and selects the correct one', () => {\n+    const practitioner: Practitioner = {\n+      resourceType: 'Practitioner',\n+      name: [\n+        {\n+          family: 'Smith',\n+        },\n+      ],\n+      telecom: [\n+        {\n+          system: 'email',\n+          value: 'smith@example.com',\n+        },\n+        {\n+          system: 'phone',\n+          value: '555-123-4567',\n+        },\n+        {\n+          system: 'fax',\n+          value: '555-999-8888',\n+        },\n+      ],\n+    };\n+\n+    const result = getProviderInfo(practitioner);\n+\n+    expect(result.billingPhoneNumber).toBe('555-123-4567');\n+  });\n+\n+  test('handles empty arrays', () => {\n+    const practitioner: Practitioner = {\n+      resourceType: 'Practitioner',\n+      name: [],\n+      address: [],\n+      telecom: [],\n+      identifier: [],\n+    };\n+\n+    const result = getProviderInfo(practitioner);\n+\n+    expect(result).toEqual({\n+      billingName: '',\n+      billingLocation: '',\n+      billingPhoneNumber: '',\n+      providerNpi: '',\n+    });\n+  });\n+});\n+\n+describe('getReferralInfo', () => {\n+  test('returns complete practitioner referral info', () => {\n+    const practitioner = fullAnswer.entry?.[3]?.resource as Practitioner;\n+\n+    const result = getReferralInfo(practitioner);\n+\n+    expect(result).toEqual({\n+      referrerName: 'Smith, Kevin',\n+      referrerNpi: '2490433892',\n+    });\n+  });\n+\n+  test('returns complete organization referral info', () => {\n+    const organization = fullAnswer.entry?.[4]?.resource as Organization;\n+\n+    const result = getReferralInfo(organization);\n+\n+    expect(result).toEqual({\n+      referrerName: 'Independence Blue Cross Blue Shield',\n+      referrerNpi: '7911621876',\n+    });\n+  });\n+\n+  test('handles undefined referrer', () => {\n+    const result = getReferralInfo(undefined);\n+\n+    expect(result).toEqual({\n+      referrerName: '',\n+      referrerNpi: '',\n+    });\n+  });\n+\n+  test('handles unsupported resource types', () => {\n+    const device: Device = {\n+      resourceType: 'Device',\n+      identifier: [\n+        {\n+          system: 'http://hl7.org/fhir/sid/us-npi',\n+          value: '1111111111',\n+        },\n+      ],\n+    };\n+\n+    const result = getReferralInfo(device);\n+\n+    expect(result).toEqual({\n+      referrerName: '',\n+      referrerNpi: '',\n+    });\n+  });\n+\n+  test('handles practitioner with missing name', () => {\n+    const practitioner: Practitioner = {\n+      resourceType: 'Practitioner',\n+      identifier: [\n+        {\n+          system: 'http://hl7.org/fhir/sid/us-npi',\n+          value: '1234567890',\n+        },\n+      ],\n+    };\n+\n+    const result = getReferralInfo(practitioner);\n+\n+    expect(result).toEqual({\n+      referrerName: '',\n+      referrerNpi: '1234567890',\n+    });\n+  });\n+\n+  test('handles organization with missing name', () => {\n+    const organization: Organization = {\n+      resourceType: 'Organization',\n+      identifier: [\n+        {\n+          system: 'http://hl7.org/fhir/sid/us-npi',\n+          value: '9876543210',\n+        },\n+      ],\n+    };\n+\n+    const result = getReferralInfo(organization);\n+\n+    expect(result).toEqual({\n+      referrerName: '',\n+      referrerNpi: '9876543210',\n+    });\n+  });\n+\n+  test('handles missing NPI identifier', () => {\n+    const practitioner: Practitioner = {\n+      resourceType: 'Practitioner',\n+      name: [\n+        {\n+          family: 'Smith',\n+          given: ['John'],\n+        },\n+      ],\n+      identifier: [\n+        {\n+          system: 'other-system',\n+          value: 'other-value',\n+        },\n+      ],\n+    };\n+\n+    const result = getReferralInfo(practitioner);\n+\n+    expect(result).toEqual({\n+      referrerName: 'Smith, John',\n+      referrerNpi: '',\n+    });\n+  });\n+\n+  test('handles empty identifier array', () => {\n+    const practitioner: Practitioner = {\n+      resourceType: 'Practitioner',\n+      name: [\n+        {\n+          family: 'Smith',\n+          given: ['John'],\n+        },\n+      ],\n+      identifier: [],\n+    };\n+\n+    const result = getReferralInfo(practitioner);\n+\n+    expect(result).toEqual({\n+      referrerName: 'Smith, John',\n+      referrerNpi: '',\n+    });\n+  });\n+});\n+\n+describe('createPositionedText', () => {\n+  test('returns a positioned text object', () => {\n+    const result = createPositionedText('test', 100, 200);\n+    expect(result).toEqual({\n+      text: 'test',\n+      absolutePosition: { x: 100, y: 200 },\n+      fontSize: 9,\n+    });\n+  });\n+\n+  test('returns a positioned text object with a custom font size', () => {\n+    const result = createPositionedText('test', 100, 200, 12);\n+    expect(result).toEqual({\n+      text: 'test',\n+      absolutePosition: { x: 100, y: 200 },\n+      fontSize: 12,\n+    });\n+  });\n+});\n+\n+describe('getPhoneContent', () => {\n+  const expectedPosition = { x: 123, y: 204 };\n+  const expectedSecondPosition = { x: 150, y: 204 };\n+  const expectedFontSize = 9;\n+\n+  test('handles hyphenated phone number format XXX-XXX-XXXX', () => {\n+    const result = getPhoneContent('555-325-1111');\n+    expect(result).toStrictEqual([\n+      { text: '555', absolutePosition: expectedPosition, fontSize: expectedFontSize },\n+      { text: '325-1111', absolutePosition: expectedSecondPosition, fontSize: expectedFontSize },\n+    ]);\n+  });\n+\n+  test('handles parentheses phone number format (XXX) XXX-XXXX', () => {\n+    const result = getPhoneContent('(555) 325-2222');\n+    expect(result).toStrictEqual([\n+      { text: '555', absolutePosition: expectedPosition, fontSize: expectedFontSize },\n+      { text: '325-2222', absolutePosition: expectedSecondPosition, fontSize: expectedFontSize },\n+    ]);\n+  });\n+\n+  test('handles plain number format XXXXXXXXXX', () => {\n+    const result = getPhoneContent('5553253333');\n+    expect(result).toStrictEqual([\n+      { text: '555', absolutePosition: expectedPosition, fontSize: expectedFontSize },\n+      { text: '325-3333', absolutePosition: expectedSecondPosition, fontSize: expectedFontSize },\n+    ]);\n+  });\n+\n+  test('uses custom xAxisOffset and yAxisOffset', () => {\n+    const result = getPhoneContent('5553253333', 100, 230);\n+    expect(result).toStrictEqual([\n+      { text: '555', absolutePosition: { x: 100, y: 230 }, fontSize: expectedFontSize },\n+      { text: '325-3333', absolutePosition: { x: 127, y: 230 }, fontSize: expectedFontSize },\n+    ]);\n+  });\n+});\n+\n+describe('getAddressContent', () => {\n+  const sampleAddress: Address = {\n+    line: ['742 Evergreen Terrace'],\n+    city: 'Springfield',\n+    state: 'IL',\n+    postalCode: '62704',\n+  };\n+\n+  const defaultXOffset = 22;\n+  const stateXOffset = 203;\n+  const expectedFontSize = 9;\n+\n+  test('returns complete address content', () => {\n+    const result = getAddressContent(sampleAddress);\n+    expect(result).toStrictEqual([\n+      {\n+        text: '742 Evergreen Terrace',\n+        absolutePosition: { x: defaultXOffset, y: 156 },\n+        fontSize: expectedFontSize,\n+      },\n+      {\n+        text: 'Springfield',\n+        absolutePosition: { x: defaultXOffset, y: 179 },\n+        fontSize: expectedFontSize,\n+      },\n+      {\n+        text: 'IL',\n+        absolutePosition: { x: stateXOffset, y: 179 },\n+        fontSize: expectedFontSize,\n+      },\n+      {\n+        text: '62704',\n+        absolutePosition: { x: defaultXOffset, y: 204 },\n+        fontSize: expectedFontSize,\n+      },\n+    ]);\n+  });\n+\n+  test('handles missing optional fields', () => {\n+    const partialAddress: Address = {};\n+\n+    const result = getAddressContent(partialAddress);\n+    expect(result).toStrictEqual([\n+      {\n+        text: '',\n+        absolutePosition: { x: defaultXOffset, y: 156 },\n+        fontSize: expectedFontSize,\n+      },\n+      {\n+        text: '',\n+        absolutePosition: { x: defaultXOffset, y: 179 },\n+        fontSize: expectedFontSize,\n+      },\n+      {\n+        text: '',\n+        absolutePosition: { x: stateXOffset, y: 179 },\n+        fontSize: expectedFontSize,\n+      },\n+      {\n+        text: '',\n+        absolutePosition: { x: defaultXOffset, y: 204 },\n+        fontSize: expectedFontSize,\n+      },\n+    ]);\n+  });\n+\n+  test('uses custom xAxisOffset', () => {\n+    const customXOffset = 100;\n+    const customStateXOffset = 281;\n+\n+    const result = getAddressContent(sampleAddress, customXOffset);\n+    expect(result).toStrictEqual([\n+      {\n+        text: '742 Evergreen Terrace',\n+        absolutePosition: { x: customXOffset, y: 156 },\n+        fontSize: expectedFontSize,\n+      },\n+      {\n+        text: 'Springfield',\n+        absolutePosition: { x: customXOffset, y: 179 },\n+        fontSize: expectedFontSize,\n+      },\n+      {\n+        text: 'IL',\n+        absolutePosition: { x: customStateXOffset, y: 179 },\n+        fontSize: expectedFontSize,\n+      },\n+      {\n+        text: '62704',\n+        absolutePosition: { x: customXOffset, y: 204 },\n+        fontSize: expectedFontSize,\n+      },\n+    ]);\n+  });\n+});\n+\n+describe('getDateContent', () => {\n+  const expectedFontSize = 9;\n+\n+  test('handles date with custom offsets', () => {\n+    const dob = new Date('1956-05-12');\n+    const xOffset = 395;\n+    const yOffset = 253;\n+\n+    const result = getDateContent(dob, xOffset, yOffset);\n+\n+    expect(result).toStrictEqual([\n+      {\n+        text: '12',\n+        absolutePosition: { x: xOffset, y: yOffset },\n+        fontSize: expectedFontSize,\n+      },\n+      {\n+        text: '05',\n+        absolutePosition: { x: xOffset + 21, y: yOffset },\n+        fontSize: expectedFontSize,\n+      },\n+      {\n+        text: '56',\n+        absolutePosition: { x: xOffset + 42, y: yOffset },\n+        fontSize: expectedFontSize,\n+      },\n+    ]);\n+  });\n+\n+  test('handles date with default offsets', () => {\n+    const dob = new Date('1956-05-12');\n+    const defaultXOffset = 236;\n+    const defaultYOffset = 131;\n+\n+    const result = getDateContent(dob);\n+\n+    expect(result).toStrictEqual([\n+      {\n+        text: '12',\n+        absolutePosition: { x: defaultXOffset, y: defaultYOffset },\n+        fontSize: expectedFontSize,\n+      },\n+      {\n+        text: '05',\n+        absolutePosition: { x: defaultXOffset + 21, y: defaultYOffset },\n+        fontSize: expectedFontSize,\n+      },\n+      {\n+        text: '56',\n+        absolutePosition: { x: defaultXOffset + 42, y: defaultYOffset },\n+        fontSize: expectedFontSize,\n+      },\n+    ]);\n+  });\n+\n+  test('returns empty array for undefined date', () => {\n+    const result = getDateContent(undefined);\n+    expect(result).toStrictEqual([]);\n+  });\n+});\n+\n+describe('getSexContent', () => {\n+  const expectedMark = { text: 'X', fontSize: 9 };\n+\n+  test('marks male checkbox', () => {\n+    const result = getSexContent('male');\n+    expect(result).toStrictEqual([\n+      {\n+        ...expectedMark,\n+        absolutePosition: { x: 316, y: 131 },\n+      },\n+    ]);\n+  });\n+\n+  test('marks female checkbox', () => {\n+    const result = getSexContent('female');\n+    expect(result).toStrictEqual([\n+      {\n+        ...expectedMark,\n+        absolutePosition: { x: 352, y: 131 },\n+      },\n+    ]);\n+  });\n+\n+  test('handles custom offsets', () => {\n+    const result = getSexContent('female', 500, 51, 205);\n+    expect(result).toStrictEqual([\n+      {\n+        ...expectedMark,\n+        absolutePosition: { x: 551, y: 205 },\n+      },\n+    ]);\n+  });\n+\n+  test('returns empty array for unknown sex', () => {\n+    expect(getSexContent('unknown')).toStrictEqual([]);\n+  });\n+});\n+\n+describe('getPatientRelationshipToInsuredContent', () => {\n+  const expectedFontSize = 9;\n+  const expectedY = 156;\n+  const expectedMark = 'X';\n+\n+  test('marks self checkbox', () => {\n+    const result = getPatientRelationshipToInsuredContent('self');\n+    expect(result).toStrictEqual([\n+      {\n+        text: expectedMark,\n+        absolutePosition: { x: 252, y: expectedY },\n+        fontSize: expectedFontSize,\n+      },\n+    ]);\n+  });\n+\n+  test('marks spouse checkbox', () => {\n+    const result = getPatientRelationshipToInsuredContent('spouse');\n+    expect(result).toStrictEqual([\n+      {\n+        text: expectedMark,\n+        absolutePosition: { x: 289, y: expectedY },\n+        fontSize: expectedFontSize,\n+      },\n+    ]);\n+  });\n+\n+  test('marks child checkbox', () => {\n+    const result = getPatientRelationshipToInsuredContent('child');\n+    expect(result).toStrictEqual([\n+      {\n+        text: expectedMark,\n+        absolutePosition: { x: 317, y: expectedY },\n+        fontSize: expectedFontSize,\n+      },\n+    ]);\n+  });\n+\n+  test('marks other checkbox when relationship is other', () => {\n+    const result = getPatientRelationshipToInsuredContent('other');\n+    expect(result).toStrictEqual([\n+      {\n+        text: expectedMark,\n+        absolutePosition: { x: 353, y: expectedY },\n+        fontSize: expectedFontSize,\n+      },\n+    ]);\n+  });\n+\n+  test('marks other checkbox when relationship is not recognized', () => {\n+    const result = getPatientRelationshipToInsuredContent('something');\n+    expect(result).toStrictEqual([\n+      {\n+        text: expectedMark,\n+        absolutePosition: { x: 353, y: expectedY },\n+        fontSize: expectedFontSize,\n+      },\n+    ]);\n+  });\n+});\n+\n+describe('getClaimItemContent', () => {\n+  test('formats multiple claim items correctly', () => {\n+    const items = [\n+      {\n+        dateOfService: '2024-01-15',\n+        placeOfService: '289 Hamilton Drive, Los Angeles, CA',\n+        placeOfServiceState: 'CA',\n+        emergency: true,\n+        procedureCode: '99213',\n+        modifiers: 'GP',\n+        diagnosisPointer: '1',\n+        charges: '75.00',\n+        daysOrUnits: '1',\n+        familyPlanIndicator: 'Y',\n+      },\n+      {\n+        dateOfService: '2024-01-16',\n+        placeOfService: '289 Madison Avenue, Albany, NY',\n+        placeOfServiceState: 'NY',\n+        emergency: false,\n+        procedureCode: '97110',\n+        modifiers: '59',\n+        diagnosisPointer: '2',\n+        charges: '50.00',\n+        daysOrUnits: '2',\n+        familyPlanIndicator: 'N',\n+      },\n+    ];\n+\n+    const result = getClaimItemContent(items);\n+\n+    expect(result).toStrictEqual([\n+      // First item\n+      {\n+        text: '15',\n+        absolutePosition: { x: 21, y: 540 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: '01',\n+        absolutePosition: { x: 42, y: 540 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: '24',\n+        absolutePosition: { x: 63, y: 540 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'CA',\n+        absolutePosition: { x: 149, y: 540 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X',\n+        absolutePosition: { x: 172, y: 540 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: '99213',\n+        absolutePosition: { x: 194, y: 540 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'GP',\n+        absolutePosition: { x: 246, y: 540 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: '1',\n+        absolutePosition: { x: 335, y: 540 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: '75.00',\n+        absolutePosition: { x: 373, y: 540 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: '1',\n+        absolutePosition: { x: 437, y: 540 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'Y',\n+        absolutePosition: { x: 466, y: 540 },\n+        fontSize: 9,\n+      },\n+\n+      // Second item\n+      {\n+        text: '16',\n+        absolutePosition: { x: 21, y: 565 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: '01',\n+        absolutePosition: { x: 42, y: 565 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: '24',\n+        absolutePosition: { x: 63, y: 565 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'NY',\n+        absolutePosition: { x: 149, y: 565 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: '',\n+        absolutePosition: { x: 172, y: 565 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: '97110',\n+        absolutePosition: { x: 194, y: 565 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: '59',\n+        absolutePosition: { x: 246, y: 565 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: '2',\n+        absolutePosition: { x: 335, y: 565 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: '50.00',\n+        absolutePosition: { x: 373, y: 565 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: '2',\n+        absolutePosition: { x: 437, y: 565 },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'N',\n+        absolutePosition: { x: 466, y: 565 },\n+        fontSize: 9,\n+      },\n+    ]);\n+  });\n+});\n+\n+describe('getDiagnosisContent', () => {\n+  test('returns correct diagnosis content', () => {\n+    const diagnosis = [\n+      // Row 1\n+      'J20',\n+      'G89.4',\n+      'M54.5',\n+      'E11.9',\n+      // Row 2\n+      'I10',\n+      'J45.909',\n+      'K21.9',\n+      'N18.9',\n+      // Row 3\n+      'R51',\n+      'M25.561',\n+      'F41.1',\n+      'Z79.899',\n+    ];\n+\n+    const result = getDiagnosisContent(diagnosis);\n+\n+    expect(result).toStrictEqual([\n+      // Row 1\n+      { text: 'J20', absolutePosition: { x: 35, y: 470 }, fontSize: 9 },\n+      { text: 'G89.4', absolutePosition: { x: 128, y: 470 }, fontSize: 9 },\n+      { text: 'M54.5', absolutePosition: { x: 222, y: 470 }, fontSize: 9 },\n+      { text: 'E11.9', absolutePosition: { x: 317, y: 470 }, fontSize: 9 },\n+      // Row 2\n+      { text: 'I10', absolutePosition: { x: 35, y: 482 }, fontSize: 9 },\n+      { text: 'J45.909', absolutePosition: { x: 128, y: 482 }, fontSize: 9 },\n+      { text: 'K21.9', absolutePosition: { x: 222, y: 482 }, fontSize: 9 },\n+      { text: 'N18.9', absolutePosition: { x: 317, y: 482 }, fontSize: 9 },\n+      // Row 3\n+      { text: 'R51', absolutePosition: { x: 35, y: 493 }, fontSize: 9 },\n+      { text: 'M25.561', absolutePosition: { x: 128, y: 493 }, fontSize: 9 },\n+      { text: 'F41.1', absolutePosition: { x: 222, y: 493 }, fontSize: 9 },\n+      { text: 'Z79.899', absolutePosition: { x: 317, y: 493 }, fontSize: 9 },\n+    ]);\n+  });\n+});\n\ndiff --git a/examples/medplum-demo-bots/src/billing-bots/cms-1500-test-data.ts b/examples/medplum-demo-bots/src/billing-bots/cms-1500-test-data.ts\nindex 89ca020cde..639eee24a9 100644\n--- a/examples/medplum-demo-bots/src/billing-bots/cms-1500-test-data.ts\n+++ b/examples/medplum-demo-bots/src/billing-bots/cms-1500-test-data.ts\n@@ -6,7 +6,7 @@ export const fullAnswer: Bundle = {\n   entry: [\n     {\n       fullUrl: 'urn:uuid:8796eac7-4ee2-4b9a-84f7-68691173e945',\n-      request: { method: 'POST', url: 'Patient' },\n+      request: { method: 'PUT', url: 'Patient?name=Homer%20Simpson' },\n       resource: {\n         resourceType: 'Patient',\n         name: [\n@@ -22,45 +22,152 @@ export const fullAnswer: Bundle = {\n             line: ['742 Evergreen Terrace'],\n             city: 'Springfield',\n             state: 'IL',\n+            postalCode: '62704',\n+          },\n+        ],\n+        telecom: [\n+          {\n+            system: 'phone',\n+            use: 'mobile',\n+            value: '555-555-6392',\n           },\n         ],\n       },\n     },\n     {\n       fullUrl: 'urn:uuid:7914fb49-05e1-45cc-bffc-a3fdff1b72e1',\n-      request: { method: 'POST', url: 'RelatedPerson' },\n+      request: { method: 'PUT', url: 'RelatedPerson?name=Marge%20Simpson' },\n       resource: {\n         resourceType: 'RelatedPerson',\n         patient: { reference: 'urn:uuid:8796eac7-4ee2-4b9a-84f7-68691173e945' },\n         name: [{ given: ['Marge'], family: 'Simpson' }],\n+        birthDate: '1960-08-12',\n+        gender: 'female',\n         address: [\n           {\n             line: ['742 Evergreen Terrace'],\n             city: 'Springfield',\n             state: 'IL',\n+            postalCode: '62704',\n+          },\n+        ],\n+        telecom: [\n+          {\n+            system: 'phone',\n+            use: 'mobile',\n+            value: '555-555-6393',\n+          },\n+        ],\n+      },\n+    },\n+    {\n+      fullUrl: 'urn:uuid:e2523da4-9d6e-442c-99aa-fcfe3353c9e3',\n+      request: { method: 'PUT', url: 'RelatedPerson?name=Abraham%20Simpson' },\n+      resource: {\n+        resourceType: 'RelatedPerson',\n+        patient: { reference: 'urn:uuid:8796eac7-4ee2-4b9a-84f7-68691173e945' },\n+        name: [{ given: ['Abraham'], family: 'Simpson' }],\n+        birthDate: '1927-06-04',\n+        gender: 'male',\n+        address: [\n+          {\n+            line: ['Springfield Retirement Castle'],\n+            city: 'Springfield',\n+            state: 'IL',\n+            postalCode: '62704',\n+          },\n+        ],\n+      },\n+    },\n+    {\n+      fullUrl: 'urn:uuid:706245c5-5f9d-45eb-bf90-cee2fac3f52c',\n+      request: { method: 'PUT', url: 'Practitioner?identifier=2490433892' },\n+      resource: {\n+        resourceType: 'Practitioner',\n+        identifier: [\n+          {\n+            system: 'http://hl7.org/fhir/sid/us-npi',\n+            value: '2490433892',\n+          },\n+        ],\n+        name: [\n+          {\n+            given: ['Kevin'],\n+            family: 'Smith',\n+          },\n+        ],\n+        address: [\n+          {\n+            line: ['2904 Main Street'],\n+            city: 'Elizabeth',\n+            state: 'MD',\n+            country: 'US',\n+            postalCode: '21219',\n+          },\n+        ],\n+        telecom: [\n+          {\n+            use: 'work',\n+            system: 'phone',\n+            value: '555-555-9391',\n           },\n         ],\n-        birthDate: '1960-08-12',\n-        gender: 'female',\n       },\n     },\n     {\n       fullUrl: 'urn:uuid:f1ed24bf-7efa-44a1-b5ea-cc46414a282d',\n-      request: { method: 'POST', url: 'Organization' },\n+      request: { method: 'PUT', url: 'Organization?identifier=7911621876' },\n       resource: {\n         resourceType: 'Organization',\n         identifier: [\n+          {\n+            use: 'official',\n+            system: 'http://hl7.org/fhir/sid/us-npi',\n+            value: '7911621876',\n+          },\n           {\n             use: 'official',\n             type: {\n               coding: [\n                 {\n                   system: 'http://example.org/org-id',\n-                  code: 'NPI',\n+                  code: 'TAX',\n                 },\n               ],\n             },\n-            value: 'example-npi-number',\n+            value: '5551844680',\n+            system: 'http://example-systemt.org/tax',\n+          },\n+        ],\n+        name: 'Independence Blue Cross Blue Shield',\n+        address: [\n+          {\n+            line: ['1901 Market Street'],\n+            city: 'Philadelphia',\n+            state: 'PA',\n+            postalCode: '19103',\n+            type: 'both',\n+          },\n+        ],\n+        telecom: [\n+          {\n+            system: 'phone',\n+            use: 'work',\n+            value: '555-555-4321',\n+          },\n+        ],\n+      },\n+    },\n+    {\n+      fullUrl: 'urn:uuid:4bc72375-425d-4fb0-be6e-38bc6144d1e5',\n+      request: { method: 'PUT', url: 'Organization?identifier=5746217289' },\n+      resource: {\n+        resourceType: 'Organization',\n+        identifier: [\n+          {\n+            use: 'official',\n+            system: 'http://hl7.org/fhir/sid/us-npi',\n+            value: '5746217289',\n           },\n           {\n             use: 'official',\n@@ -72,17 +179,17 @@ export const fullAnswer: Bundle = {\n                 },\n               ],\n             },\n-            value: 'example-tax-id',\n+            value: '5554404734',\n             system: 'http://example-systemt.org/tax',\n           },\n         ],\n-        name: 'Independence Blue Cross Blue Shield',\n+        name: 'Medicare Insurance',\n         address: [\n           {\n-            line: ['1901 Market Street'],\n-            city: 'Philadelphia',\n-            state: 'PA',\n-            postalCode: '19103',\n+            line: ['2578 Elmwood Avenue'],\n+            city: 'Chicago',\n+            state: 'IL',\n+            postalCode: '60610',\n             type: 'both',\n           },\n         ],\n@@ -90,7 +197,7 @@ export const fullAnswer: Bundle = {\n     },\n     {\n       fullUrl: 'urn:uuid:72ec6c80-6dab-41e0-adff-a8670a5b4363',\n-      request: { method: 'POST', url: 'Coverage' },\n+      request: { method: 'PUT', url: 'Coverage?identifier=89442808' },\n       resource: {\n         resourceType: 'Coverage',\n         identifier: [\n@@ -100,7 +207,10 @@ export const fullAnswer: Bundle = {\n           },\n         ],\n         status: 'active',\n-        beneficiary: { reference: 'urn:uuid:8796eac7-4ee2-4b9a-84f7-68691173e945', display: 'Homer Simpson' },\n+        beneficiary: {\n+          reference: 'urn:uuid:8796eac7-4ee2-4b9a-84f7-68691173e945',\n+          display: 'Homer Simpson',\n+        },\n         payor: [\n           {\n             reference: 'urn:uuid:f1ed24bf-7efa-44a1-b5ea-cc46414a282d',\n@@ -127,53 +237,117 @@ export const fullAnswer: Bundle = {\n         },\n         subscriber: {\n           reference: 'urn:uuid:7914fb49-05e1-45cc-bffc-a3fdff1b72e1',\n+          display: 'Marge Simpson',\n         },\n+        class: [\n+          {\n+            type: {\n+              coding: [\n+                {\n+                  system: 'http://terminology.hl7.org/CodeSystem/coverage-class',\n+                  code: 'plan',\n+                },\n+              ],\n+            },\n+            value: 'B37FC',\n+            name: 'Independence Blue Full Coverage',\n+          },\n+        ],\n       },\n     },\n     {\n-      fullUrl: 'urn:uuid:706245c5-5f9d-45eb-bf90-cee2fac3f52c',\n-      request: { method: 'POST', url: 'Practitioner' },\n+      fullUrl: 'urn:uuid:10e49ae1-acf1-4288-93d3-5bbb504957aa',\n+      request: { method: 'PUT', url: 'Coverage?identifier=21173018' },\n       resource: {\n-        resourceType: 'Practitioner',\n+        resourceType: 'Coverage',\n         identifier: [\n           {\n-            system: 'http://example.org/practitioner-npi',\n-            id: 'NPI',\n-            value: '2490433892',\n+            use: 'official',\n+            value: '21173018',\n           },\n         ],\n-        name: [\n+        status: 'active',\n+        beneficiary: {\n+          reference: 'urn:uuid:8796eac7-4ee2-4b9a-84f7-68691173e945',\n+          display: 'Homer Simpson',\n+        },\n+        payor: [\n           {\n-            given: ['Kevin'],\n-            family: 'Smith',\n+            reference: 'urn:uuid:4bc72375-425d-4fb0-be6e-38bc6144d1e5',\n+            display: 'Medicare Insurance',\n           },\n         ],\n-        address: [\n+        type: {\n+          coding: [\n+            {\n+              system: 'http://terminology.hl7.org/CodeSystem/v3-ActCode',\n+              code: 'EHCPOL',\n+              display: 'extended healthcare',\n+            },\n+          ],\n+        },\n+        relationship: {\n+          coding: [\n+            {\n+              system: 'http://hl7.org/fhir/ValueSet/subscriber-relationship',\n+              code: 'child',\n+              display: 'Child',\n+            },\n+          ],\n+        },\n+        subscriber: {\n+          reference: 'urn:uuid:e2523da4-9d6e-442c-99aa-fcfe3353c9e3',\n+          display: 'Abraham Simpson',\n+        },\n+        class: [\n           {\n-            line: ['2904 Main Street'],\n-            city: 'Elizabeth',\n-            state: 'MD',\n-            country: 'US  ',\n+            type: {\n+              coding: [\n+                {\n+                  system: 'http://terminology.hl7.org/CodeSystem/coverage-class',\n+                  code: 'plan',\n+                },\n+              ],\n+            },\n+            value: '11461128',\n+            name: 'Medicare Gold Plus',\n           },\n         ],\n-        telecom: [\n+      },\n+    },\n+    {\n+      fullUrl: 'urn:uuid:30192746-113d-4c78-af02-3090ce22996f',\n+      request: { method: 'PUT', url: 'ServiceRequest?identifier=4839201756' },\n+      resource: {\n+        resourceType: 'ServiceRequest',\n+        identifier: [\n           {\n-            use: 'work',\n-            system: 'phone',\n-            value: '3915559391',\n+            system: 'http://hl7.org/fhir/sid/us-npi',\n+            value: '4839201756',\n+          },\n+        ],\n+        status: 'active',\n+        intent: 'order',\n+        category: [\n+          {\n+            coding: [\n+              { system: 'http://snomed.info/sct', code: '103696004', display: 'Patient referral to specialist' },\n+            ],\n           },\n         ],\n+        subject: { reference: 'urn:uuid:8796eac7-4ee2-4b9a-84f7-68691173e945', display: 'Homer Simpson' },\n+        requester: { reference: 'urn:uuid:706245c5-5f9d-45eb-bf90-cee2fac3f52c', display: 'Kevin Smith' },\n       },\n     },\n     {\n       fullUrl: 'urn:uuid:6a86eda3-ce9e-472c-ba6b-1855e518d779',\n-      request: { method: 'POST', url: 'Claim' },\n+      request: { method: 'PUT', url: 'Claim?identifier=example-claim-cms1500' },\n       resource: {\n         resourceType: 'Claim',\n         identifier: [\n           {\n             system: 'http://example.org/claims',\n-            value: 'example-claim',\n+            value: 'example-claim-cms1500',\n           },\n         ],\n         status: 'active',\n@@ -197,6 +371,7 @@ export const fullAnswer: Bundle = {\n             },\n           ],\n         },\n+        referral: { reference: 'urn:uuid:30192746-113d-4c78-af02-3090ce22996f' },\n         insurance: [\n           {\n             coverage: {\n@@ -207,8 +382,16 @@ export const fullAnswer: Bundle = {\n             focal: true,\n             preAuthRef: ['0923092390'],\n           },\n+          {\n+            coverage: {\n+              reference: 'urn:uuid:10e49ae1-acf1-4288-93d3-5bbb504957aa',\n+              display: 'Abraham Simpson Extended Healthcare Plan',\n+            },\n+            sequence: 2,\n+            focal: false,\n+          },\n         ],\n-        provider: { reference: 'urn:uuid:706245c5-5f9d-45eb-bf90-cee2fac3f52c' },\n+        provider: { reference: 'urn:uuid:706245c5-5f9d-45eb-bf90-cee2fac3f52c', display: 'Kevin Smith' },\n         supportingInfo: [\n           {\n             category: {\n@@ -254,15 +437,28 @@ export const fullAnswer: Bundle = {\n               end: '2024-05-21',\n             },\n           },\n+          {\n+            category: {\n+              coding: [{ code: 'info', system: 'http://terminology.hl7.org/CodeSystem/claiminformationcategory' }],\n+            },\n+            code: {\n+              coding: [{ system: 'http://example.org/info-codes', code: 'patientpaid' }],\n+            },\n+            sequence: 5,\n+            valueQuantity: {\n+              value: 320,\n+              unit: 'USD',\n+            },\n+          },\n           {\n             category: {\n               coding: [\n-                { system: 'http://terminology.hl7.org/CodeSystem/claiminformationcategory', code: 'patientpaid' },\n+                { system: 'http://terminology.hl7.org/CodeSystem/claiminformationcategory', code: 'outsidelab' },\n               ],\n             },\n-            sequence: 5,\n+            sequence: 6,\n             valueQuantity: {\n-              value: 100,\n+              value: 125,\n               unit: 'USD',\n             },\n           },\n@@ -278,6 +474,12 @@ export const fullAnswer: Bundle = {\n               coding: [{ system: 'http://hl7.org/fhir/sid/icd-10', code: 'J20', display: 'Acute bronchitis' }],\n             },\n           },\n+          {\n+            sequence: 2,\n+            diagnosisCodeableConcept: {\n+              coding: [{ system: 'http://hl7.org/fhir/sid/icd-10', code: 'G89.4', display: 'Chronic pain syndrome' }],\n+            },\n+          },\n         ],\n         related: [\n           {\n@@ -328,7 +530,7 @@ export const fullAnswer: Bundle = {\n             modifier: [\n               { coding: [{ system: 'http://terminology.hl7.org/CodeSystem/modifiers', code: 'x', display: 'None' }] },\n             ],\n-            diagnosisSequence: [1],\n+            diagnosisSequence: [1, 2],\n             net: {\n               currency: 'USD',\n               value: 1000,\n\ndiff --git a/examples/medplum-demo-bots/src/billing-bots/cms-1500.test.ts b/examples/medplum-demo-bots/src/billing-bots/cms-1500.test.ts\nindex a73b5d51e9..ad26263fe9 100644\n--- a/examples/medplum-demo-bots/src/billing-bots/cms-1500.test.ts\n+++ b/examples/medplum-demo-bots/src/billing-bots/cms-1500.test.ts\n@@ -20,7 +20,7 @@ describe('CMS 1500 tests', async () => {\n     const result = await medplum.executeBatch(fullAnswer);\n     console.log(result);\n     const claim = (await medplum.searchOne('Claim', {\n-      identifier: 'example-claim',\n+      identifier: 'example-claim-cms1500',\n     })) as Claim;\n \n     const response = await handler(medplum, {\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6187",
    "pr_id": 6187,
    "issue_id": 6161,
    "repo": "medplum/medplum",
    "problem_statement": "PlanDefinition $apply for ServiceRequest and Procedure\nSample ActivityDefinition for ServiceRequest:\n\n```json\n{\n  \"resourceType\": \"ActivityDefinition\",\n  \"id\": \"example-lab-order\",\n  \"status\": \"active\",\n  \"kind\": \"ServiceRequest\",\n  \"name\": \"CompleteBloodCountOrder\",\n  \"title\": \"Complete Blood Count Order\",\n  \"description\": \"Order for a complete blood count\",\n  \"code\": {\n    \"coding\": [\n      {\n        \"system\": \"http://snomed.info/sct\",\n        \"code\": \"26604007\",\n        \"display\": \"Complete blood count\"\n      },\n      {\n        \"system\": \"http://www.ama-assn.org/go/cpt\",\n        \"code\": \"85025\",\n        \"display\": \"Complete CBC with automated differential WBC\"\n      }\n    ]\n  },\n  \"intent\": \"order\",\n  \"priority\": \"routine\",\n  \"participant\": [\n    {\n      \"type\": \"practitioner\",\n      \"role\": {\n        \"coding\": [\n          {\n            \"system\": \"http://terminology.hl7.org/CodeSystem/practitioner-role\",\n            \"code\": \"doctor\",\n            \"display\": \"Doctor\"\n          }\n        ]\n      }\n    }\n  ]\n}\n```\n\nSample output ServiceRequest:\n\n```json\n{\n  \"resourceType\": \"ServiceRequest\",\n  \"id\": \"generated-from-activity-definition\",\n  \"status\": \"draft\",\n  \"intent\": \"order\",\n  \"priority\": \"routine\",\n  \"code\": {\n    \"coding\": [\n      {\n        \"system\": \"http://snomed.info/sct\",\n        \"code\": \"26604007\",\n        \"display\": \"Complete blood count\"\n      },\n      {\n        \"system\": \"http://www.ama-assn.org/go/cpt\",\n        \"code\": \"85025\",\n        \"display\": \"Complete CBC with automated differential WBC\"\n      }\n    ]\n  },\n  \"subject\": {\n    \"reference\": \"Patient/example\",\n    \"display\": \"John Smith\"\n  },\n  \"requester\": {\n    \"reference\": \"Practitioner/example\",\n    \"display\": \"Dr. Jane Doe\"\n  },\n  \"performer\": [\n    {\n      \"reference\": \"Organization/lab\",\n      \"display\": \"Clinical Laboratory\"\n    }\n  ],\n  \"authoredOn\": \"2025-03-12T14:30:00Z\",\n  \"occurrenceDateTime\": \"2025-03-12T14:30:00Z\",\n  \"reasonCode\": [\n    {\n      \"coding\": [\n        {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"386661006\",\n          \"display\": \"Fever\"\n        }\n      ]\n    }\n  ],\n  \"definitionUri\": \"ActivityDefinition/example-lab-order\"\n}\n```\n\nSample ActivityDefinition for Procedure:\n\n```json\n{\n  \"resourceType\": \"ActivityDefinition\",\n  \"id\": \"example-procedure-appendectomy\",\n  \"status\": \"active\",\n  \"kind\": \"Procedure\",\n  \"name\": \"AppendectomyProcedure\",\n  \"title\": \"Laparoscopic Appendectomy Procedure\",\n  \"description\": \"Definition for a laparoscopic appendectomy procedure\",\n  \"code\": {\n    \"coding\": [\n      {\n        \"system\": \"http://snomed.info/sct\",\n        \"code\": \"80146002\",\n        \"display\": \"Appendectomy (procedure)\"\n      },\n      {\n        \"system\": \"http://www.ama-assn.org/go/cpt\", \n        \"code\": \"44970\",\n        \"display\": \"Laparoscopy, surgical, appendectomy\"\n      }\n    ]\n  },\n  \"intent\": \"order\",\n  \"priority\": \"urgent\",\n  \"participant\": [\n    {\n      \"type\": \"practitioner\",\n      \"role\": {\n        \"coding\": [\n          {\n            \"system\": \"http://terminology.hl7.org/CodeSystem/practitioner-role\",\n            \"code\": \"surgeon\",\n            \"display\": \"Surgeon\"\n          }\n        ]\n      }\n    }\n  ],\n  \"bodySite\": [\n    {\n      \"coding\": [\n        {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"181255000\",\n          \"display\": \"Entire appendix\"\n        }\n      ]\n    }\n  ]\n}\n```\n\nSample output Procedure:\n\n```json\n{\n  \"resourceType\": \"Procedure\",\n  \"id\": \"generated-from-activity-definition\",\n  \"status\": \"in-progress\",\n  \"code\": {\n    \"coding\": [\n      {\n        \"system\": \"http://snomed.info/sct\",\n        \"code\": \"80146002\",\n        \"display\": \"Appendectomy (procedure)\"\n      },\n      {\n        \"system\": \"http://www.ama-assn.org/go/cpt\", \n        \"code\": \"44970\",\n        \"display\": \"Laparoscopy, surgical, appendectomy\"\n      }\n    ]\n  },\n  \"subject\": {\n    \"reference\": \"Patient/example\",\n    \"display\": \"Jane Smith\"\n  },\n  \"performedDateTime\": \"2025-03-12T09:30:00Z\",\n  \"performer\": [\n    {\n      \"function\": {\n        \"coding\": [\n          {\n            \"system\": \"http://terminology.hl7.org/CodeSystem/v2-0443\",\n            \"code\": \"PP\",\n            \"display\": \"Primary Performer\"\n          }\n        ]\n      },\n      \"actor\": {\n        \"reference\": \"Practitioner/example-surgeon\",\n        \"display\": \"Dr. Michael Chen\"\n      }\n    },\n    {\n      \"function\": {\n        \"coding\": [\n          {\n            \"system\": \"http://terminology.hl7.org/CodeSystem/v2-0443\",\n            \"code\": \"AP\",\n            \"display\": \"Assistant Performer\"\n          }\n        ]\n      },\n      \"actor\": {\n        \"reference\": \"Practitioner/example-assistant\",\n        \"display\": \"Dr. Sarah Johnson\"\n      }\n    }\n  ],\n  \"location\": {\n    \"reference\": \"Location/example-or\",\n    \"display\": \"OR Suite 3\"\n  },\n  \"reasonCode\": [\n    {\n      \"coding\": [\n        {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"74400008\",\n          \"display\": \"Appendicitis\"\n        }\n      ]\n    }\n  ],\n  \"bodySite\": [\n    {\n      \"coding\": [\n        {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"181255000\",\n          \"display\": \"Entire appendix\"\n        }\n      ]\n    }\n  ],\n  \"outcome\": {\n    \"coding\": [\n      {\n        \"system\": \"http://snomed.info/sct\",\n        \"code\": \"385669000\",\n        \"display\": \"Successful\"\n      }\n    ]\n  },\n  \"followUp\": [\n    {\n      \"coding\": [\n        {\n          \"system\": \"http://snomed.info/sct\",\n          \"code\": \"390906007\",\n          \"display\": \"Follow-up visit\"\n        }\n      ]\n    }\n  ],\n  \"definitionUri\": \"ActivityDefinition/example-procedure-appendectomy\"\n}\n```",
    "issue_word_count": 433,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/server/src/fhir/operations/plandefinitionapply.test.ts",
      "packages/server/src/fhir/operations/plandefinitionapply.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/operations/plandefinitionapply.test.ts"
    ],
    "base_commit": "5be955d40acb5d594661f72bdca54fdb3cf08d41",
    "head_commit": "ef882b6fa90904f406e7c128f8a9526ca6087ca2",
    "repo_url": "https://github.com/medplum/medplum/pull/6187",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6187",
    "dockerfile": "",
    "pr_merged_at": "2025-03-18T18:35:11.000Z",
    "patch": "diff --git a/packages/server/src/fhir/operations/plandefinitionapply.ts b/packages/server/src/fhir/operations/plandefinitionapply.ts\nindex fa36cd5c40..bd78a57971 100644\n--- a/packages/server/src/fhir/operations/plandefinitionapply.ts\n+++ b/packages/server/src/fhir/operations/plandefinitionapply.ts\n@@ -1,6 +1,7 @@\n import { allOk, createReference, getReferenceString, ProfileResource } from '@medplum/core';\n import { FhirRequest, FhirResponse } from '@medplum/fhir-router';\n import {\n+  ActivityDefinition,\n   Bot,\n   ClientApplication,\n   Encounter,\n@@ -10,6 +11,7 @@ import {\n   Reference,\n   RequestGroup,\n   RequestGroupAction,\n+  ServiceRequest,\n   Task,\n   TaskInput,\n } from '@medplum/fhirtypes';\n@@ -86,6 +88,8 @@ async function createAction(\n ): Promise<RequestGroupAction> {\n   if (action.definitionCanonical?.startsWith('Questionnaire/')) {\n     return createQuestionnaireTask(repo, requester, subject, action, encounter);\n+  } else if (action.definitionCanonical?.startsWith('ActivityDefinition/')) {\n+    return createActivityDefinitionTask(repo, requester, subject, action, encounter);\n   }\n   return createTask(repo, requester, subject, action, encounter);\n }\n@@ -119,6 +123,53 @@ async function createQuestionnaireTask(\n   ]);\n }\n \n+/**\n+ * Creates a Task and RequestGroup action to request a resource.\n+ * @param repo - The repository configured for the current user.\n+ * @param requester - The user who requested the plan definition.\n+ * @param subject - The subject of the plan definition.\n+ * @param action - The PlanDefinition action.\n+ * @param encounter - Optional encounter reference.\n+ * @returns The RequestGroup action.\n+ */\n+async function createActivityDefinitionTask(\n+  repo: Repository,\n+  requester: Reference<Bot | ClientApplication | ProfileResource>,\n+  subject: Reference<Patient>,\n+  action: PlanDefinitionAction,\n+  encounter: Reference<Encounter> | undefined\n+): Promise<RequestGroupAction> {\n+  const activityDefinition = await repo.readReference<ActivityDefinition>({ reference: action.definitionCanonical });\n+  switch (activityDefinition.kind) {\n+    case 'ServiceRequest': {\n+      const serviceRequest = await repo.createResource({\n+        resourceType: 'ServiceRequest',\n+        status: 'draft',\n+        intent: activityDefinition.intent as ServiceRequest['intent'],\n+        subject: subject,\n+        requester: requester as ServiceRequest['requester'],\n+        encounter: encounter,\n+        code: activityDefinition.code,\n+      });\n+\n+      return createTask(repo, requester, subject, action, encounter, [\n+        {\n+          type: {\n+            text: 'ServiceRequest',\n+          },\n+          valueReference: {\n+            display: action.title,\n+            reference: getReferenceString(serviceRequest),\n+          },\n+        },\n+      ]);\n+    }\n+\n+    default:\n+      return createTask(repo, requester, subject, action, encounter);\n+  }\n+}\n+\n /**\n  * Creates a Task and RequestGroup action for a PlanDefinition action.\n  * @param repo - The repository configured for the current user.\n",
    "test_patch": "diff --git a/packages/server/src/fhir/operations/plandefinitionapply.test.ts b/packages/server/src/fhir/operations/plandefinitionapply.test.ts\nindex 23ee608a58..51e2376b98 100644\n--- a/packages/server/src/fhir/operations/plandefinitionapply.test.ts\n+++ b/packages/server/src/fhir/operations/plandefinitionapply.test.ts\n@@ -348,4 +348,115 @@ describe('PlanDefinition apply', () => {\n       });\n     expect(res4.status).toBe(200);\n   });\n+\n+  test('ActivityDefinition ServiceRequest', async () => {\n+    const res1 = await request(app)\n+      .post(`/fhir/R4/ActivityDefinition`)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .send({\n+        resourceType: 'ActivityDefinition',\n+        status: 'active',\n+        kind: 'ServiceRequest',\n+        name: 'CompleteBloodCountOrder',\n+        title: 'Complete Blood Count Order',\n+        description: 'Order for a complete blood count',\n+        code: {\n+          coding: [\n+            {\n+              system: 'http://snomed.info/sct',\n+              code: '26604007',\n+              display: 'Complete blood count',\n+            },\n+            {\n+              system: 'http://www.ama-assn.org/go/cpt',\n+              code: '85025',\n+              display: 'Complete CBC with automated differential WBC',\n+            },\n+          ],\n+        },\n+        intent: 'order',\n+        priority: 'routine',\n+        participant: [\n+          {\n+            type: 'practitioner',\n+            role: {\n+              coding: [\n+                {\n+                  system: 'http://terminology.hl7.org/CodeSystem/practitioner-role',\n+                  code: 'doctor',\n+                  display: 'Doctor',\n+                },\n+              ],\n+            },\n+          },\n+        ],\n+      });\n+    expect(res1.status).toBe(201);\n+    expect(res1.body.resourceType).toBe('ActivityDefinition');\n+\n+    const res2 = await request(app)\n+      .post(`/fhir/R4/PlanDefinition`)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .send({\n+        resourceType: 'PlanDefinition',\n+        title: 'Example Plan Definition',\n+        status: 'active',\n+        action: [\n+          {\n+            title: 'Order a CBC',\n+            definitionCanonical: getReferenceString(res1.body),\n+          },\n+        ],\n+      });\n+\n+    expect(res2.status).toBe(201);\n+    expect(res2.body.resourceType).toBe('PlanDefinition');\n+    expect(res2.body.id).toBeDefined();\n+\n+    const res3 = await request(app)\n+      .post(`/fhir/R4/Patient`)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .send({\n+        resourceType: 'Patient',\n+        name: [{ given: ['Workflow'], family: 'Demo' }],\n+      });\n+    expect(res3.status).toBe(201);\n+\n+    const res4 = await request(app)\n+      .post(`/fhir/R4/PlanDefinition/${res2.body.id}/$apply`)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .send({\n+        resourceType: 'Parameters',\n+        parameter: [\n+          {\n+            name: 'subject',\n+            valueString: getReferenceString(res3.body as Patient),\n+          },\n+        ],\n+      });\n+\n+    expect(res4.status).toBe(200);\n+\n+    const res5 = await request(app)\n+      .get(`/fhir/R4/RequestGroup/${res4.body.id}`)\n+      .set('Authorization', 'Bearer ' + accessToken);\n+    expect(res5.status).toBe(200);\n+    expect(res5.body.resourceType).toBe('RequestGroup');\n+\n+    const res6 = await request(app)\n+      .get(`/fhir/R4/${(res5.body as RequestGroup).action?.[0]?.resource?.reference}`)\n+      .set('Authorization', 'Bearer ' + accessToken);\n+    expect(res6.status).toBe(200);\n+\n+    const resultTask = res6.body as Task;\n+    const res7 = await request(app)\n+      .get(`/fhir/R4/${resultTask.focus?.reference}`)\n+      .set('Authorization', 'Bearer ' + accessToken);\n+    expect(res7.status).toBe(200);\n+    expect(res7.body.resourceType).toBe('ServiceRequest');\n+  });\n });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6176",
    "pr_id": 6176,
    "issue_id": 6015,
    "repo": "medplum/medplum",
    "problem_statement": "Bulk Agent status does not include all resources as part of the collection\nRelated to [4194](https://github.com/medplum/medplum/issues/4194) the response from the bulk-status operation is set to a `type: collection` but it is not returning all results. To get more than 20 results, the `_count=` query param must be used. The Bundle.type with `collection` does not need to support a `_count` as that would entail some pagination. Could the collection type return all results or move to a different Bundle type?\n\nURL example: `Agent/$bulk-status?status=active` only returns a subset\nTo get additional resources: `Agent/$bulk-status?status=active&_count=50`\n\n```\n{\n\t\"resourceType\": \"Bundle\",\n\t\"type\": \"collection\",\n\t\"entry\": [\n\t\t{\n\t\t\t\"resource\": {\n\t\t\t\t\"resourceType\": \"Parameters\",\n\t\t\t\t\"parameter\": [\n\t\t\t\t\t{\n\t\t\t\t\t\t\"name\": \"agent\",\n\t\t\t\t\t\t\"resource\": {\n\t\t\t\t\t\t\t\"resourceType\": \"Agent\",\n```",
    "issue_word_count": 124,
    "test_files_count": 2,
    "non_test_files_count": 3,
    "pr_changed_files": [
      "packages/server/src/fhir/operations/agentbulkstatus.test.ts",
      "packages/server/src/fhir/operations/agentbulkstatus.ts",
      "packages/server/src/fhir/operations/agentstatus.test.ts",
      "packages/server/src/fhir/operations/agentstatus.ts",
      "packages/server/src/fhir/routes.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/operations/agentbulkstatus.test.ts",
      "packages/server/src/fhir/operations/agentstatus.test.ts"
    ],
    "base_commit": "801074a1ee01289c71d336274ab698f3e4c9958a",
    "head_commit": "7c78fa7fc95ec7eed0376a4768643f45235f9682",
    "repo_url": "https://github.com/medplum/medplum/pull/6176",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6176",
    "dockerfile": "",
    "pr_merged_at": "2025-03-18T00:54:39.000Z",
    "patch": "diff --git a/packages/server/src/fhir/operations/agentbulkstatus.ts b/packages/server/src/fhir/operations/agentbulkstatus.ts\nindex 382acd4bf5..870175281f 100644\n--- a/packages/server/src/fhir/operations/agentbulkstatus.ts\n+++ b/packages/server/src/fhir/operations/agentbulkstatus.ts\n@@ -1,7 +1,9 @@\n+import { allOk, badRequest } from '@medplum/core';\n import { FhirRequest, FhirResponse } from '@medplum/fhir-router';\n-import { OperationDefinition } from '@medplum/fhirtypes';\n-import { agentStatusHandler } from './agentstatus';\n-import { handleBulkAgentOperation } from './utils/agentutils';\n+import { Bundle, OperationDefinition } from '@medplum/fhirtypes';\n+import { getAuthenticatedContext } from '../../context';\n+import { getStatusForAgents } from './agentstatus';\n+import { getAgentsForRequest, makeResultWrapperEntry } from './utils/agentutils';\n \n export const operation: OperationDefinition = {\n   resourceType: 'OperationDefinition',\n@@ -30,5 +32,20 @@ export const operation: OperationDefinition = {\n  * @returns The FHIR response.\n  */\n export async function agentBulkStatusHandler(req: FhirRequest): Promise<FhirResponse> {\n-  return handleBulkAgentOperation(req, (agent) => agentStatusHandler({ ...req, params: { id: agent.id } }));\n+  const { repo } = getAuthenticatedContext();\n+\n+  const agents = await getAgentsForRequest(req, repo);\n+  if (!agents?.length) {\n+    return [badRequest('No agent(s) for given query')];\n+  }\n+\n+  const statuses = await getStatusForAgents(agents);\n+\n+  const outBundle = {\n+    resourceType: 'Bundle',\n+    type: 'collection',\n+    entry: statuses.map((statusOrOutcome, i) => makeResultWrapperEntry(statusOrOutcome, agents[i])),\n+  } satisfies Bundle;\n+\n+  return [allOk, outBundle];\n }\n\ndiff --git a/packages/server/src/fhir/operations/agentstatus.ts b/packages/server/src/fhir/operations/agentstatus.ts\nindex 6a7065eabf..143245cd9b 100644\n--- a/packages/server/src/fhir/operations/agentstatus.ts\n+++ b/packages/server/src/fhir/operations/agentstatus.ts\n@@ -1,13 +1,13 @@\n-import { allOk, badRequest } from '@medplum/core';\n+import { allOk, badRequest, isOperationOutcome, normalizeErrorString, WithId } from '@medplum/core';\n import { FhirRequest, FhirResponse } from '@medplum/fhir-router';\n-import { OperationDefinition } from '@medplum/fhirtypes';\n+import { Agent, OperationDefinition, OperationOutcome, Parameters } from '@medplum/fhirtypes';\n import { AgentConnectionState, AgentInfo } from '../../agent/utils';\n import { getAuthenticatedContext } from '../../context';\n import { getRedis } from '../../redis';\n import { getAgentForRequest } from './utils/agentutils';\n import { buildOutputParameters } from './utils/parameters';\n \n-const operation: OperationDefinition = {\n+export const operation: OperationDefinition = {\n   resourceType: 'OperationDefinition',\n   name: 'agent-status',\n   status: 'active',\n@@ -43,17 +43,49 @@ export async function agentStatusHandler(req: FhirRequest): Promise<FhirResponse\n     return [badRequest('Must specify agent ID or identifier')];\n   }\n \n-  let output: AgentInfo;\n+  const [statusOrOutcome] = await getStatusForAgents([agent]);\n \n+  if (isOperationOutcome(statusOrOutcome)) {\n+    return [statusOrOutcome];\n+  }\n+\n+  return [allOk, statusOrOutcome];\n+}\n+\n+/**\n+ * Gets the status for a given list of Agents.\n+ * @param agents - The agents to get the status of.\n+ * @returns A Bundle containing Parameters containing agents with their corresponding status response.\n+ */\n+export async function getStatusForAgents(agents: WithId<Agent>[]): Promise<(Parameters | OperationOutcome)[]> {\n   // Get the agent status details from Redis\n   // This is set by the agent websocket connection\n   // See: packages/server/src/agent/websockets.ts\n-  const statusStr = await getRedis().get(`medplum:agent:${agent.id}:info`);\n-  if (statusStr) {\n-    output = JSON.parse(statusStr);\n-  } else {\n-    output = { status: AgentConnectionState.UNKNOWN, version: 'unknown' };\n+  // Here we use MGET to get all the keys at once, which reduces this from O(n) Redis commands to O(1)\n+  const statusStrs = await getRedis().mget(agents.map((agent) => `medplum:agent:${agent.id}:info`));\n+\n+  const statuses: (Parameters | OperationOutcome)[] = [];\n+\n+  for (let i = 0; i < agents.length; i++) {\n+    const statusStr = statusStrs[i];\n+    let output: Parameters | OperationOutcome | undefined;\n+\n+    if (statusStr) {\n+      const info: AgentInfo = JSON.parse(statusStr);\n+      try {\n+        output = buildOutputParameters(operation, info);\n+      } catch (err) {\n+        // If we catch an error here, that means we have an invalid agent info entry\n+        output = badRequest(`Invalid agent info: ${normalizeErrorString(err)}`);\n+      }\n+    }\n+\n+    if (output) {\n+      statuses.push(output);\n+    } else {\n+      statuses.push(buildOutputParameters(operation, { status: AgentConnectionState.UNKNOWN, version: 'unknown' }));\n+    }\n   }\n \n-  return [allOk, buildOutputParameters(operation, output)];\n+  return statuses;\n }\n\ndiff --git a/packages/server/src/fhir/routes.ts b/packages/server/src/fhir/routes.ts\nindex f7de140da1..063f2b5f93 100644\n--- a/packages/server/src/fhir/routes.ts\n+++ b/packages/server/src/fhir/routes.ts\n@@ -35,6 +35,7 @@ import { getWsBindingTokenHandler } from './operations/getwsbindingtoken';\n import { groupExportHandler } from './operations/groupexport';\n import { appLaunchHandler } from './operations/launch';\n import { patientEverythingHandler } from './operations/patienteverything';\n+import { patientSetAccountsHandler } from './operations/patientsetaccounts';\n import { patientSummaryHandler } from './operations/patientsummary';\n import { planDefinitionApplyHandler } from './operations/plandefinitionapply';\n import { projectCloneHandler } from './operations/projectclone';\n@@ -48,7 +49,6 @@ import { sendOutcome } from './outcomes';\n import { ResendSubscriptionsOptions } from './repo';\n import { sendFhirResponse } from './response';\n import { smartConfigurationHandler, smartStylingHandler } from './smart';\n-import { patientSetAccountsHandler } from './operations/patientsetaccounts';\n \n export const fhirRouter = Router();\n \n",
    "test_patch": "diff --git a/packages/server/src/fhir/operations/agentbulkstatus.test.ts b/packages/server/src/fhir/operations/agentbulkstatus.test.ts\nindex 9ee52bef63..bb3ad532d6 100644\n--- a/packages/server/src/fhir/operations/agentbulkstatus.test.ts\n+++ b/packages/server/src/fhir/operations/agentbulkstatus.test.ts\n@@ -240,7 +240,13 @@ describe('Agent/$bulk-status', () => {\n     expect(bundle.entry).toHaveLength(1);\n \n     expectBundleToContainOutcome(bundle, agents[1], {\n-      issue: [expect.objectContaining({ severity: 'error', code: 'exception' })],\n+      issue: [\n+        expect.objectContaining({\n+          severity: 'error',\n+          code: 'invalid',\n+          details: { text: expect.stringContaining('Invalid agent info: ') },\n+        }),\n+      ],\n     });\n \n     await getRedis().set(\n@@ -260,13 +266,12 @@ describe('Agent/$bulk-status', () => {\n       .get('/fhir/R4/Agent/$bulk-status')\n       .query({ 'name:contains': 'Medplum', _count: MAX_AGENTS_PER_PAGE + 1 })\n       .set('Authorization', 'Bearer ' + accessToken);\n-    expect(res.status).toBe(400);\n+    expect(res.status).toBe(200);\n \n-    expect(res.body).toMatchObject<OperationOutcome>({\n-      resourceType: 'OperationOutcome',\n-      issue: expect.arrayContaining<OperationOutcomeIssue>([\n-        expect.objectContaining<OperationOutcomeIssue>({ severity: 'error', code: 'invalid' }),\n-      ]),\n+    expectBundleToContainStatusEntry(res.body, connectedAgent, {\n+      status: AgentConnectionState.CONNECTED,\n+      version: '3.1.4',\n+      lastUpdated: expect.any(String),\n     });\n   });\n });\n\ndiff --git a/packages/server/src/fhir/operations/agentstatus.test.ts b/packages/server/src/fhir/operations/agentstatus.test.ts\nindex e77b67f740..2dd2796d7a 100644\n--- a/packages/server/src/fhir/operations/agentstatus.test.ts\n+++ b/packages/server/src/fhir/operations/agentstatus.test.ts\n@@ -1,9 +1,9 @@\n import { ContentType } from '@medplum/core';\n-import { Agent, Parameters } from '@medplum/fhirtypes';\n+import { Agent, OperationOutcome, OperationOutcomeIssue, Parameters } from '@medplum/fhirtypes';\n import { randomUUID } from 'crypto';\n import express from 'express';\n import request from 'supertest';\n-import { AgentConnectionState } from '../../agent/utils';\n+import { AgentConnectionState, AgentInfo } from '../../agent/utils';\n import { initApp, shutdownApp } from '../../app';\n import { loadTestConfig } from '../../config/loader';\n import { getRedis } from '../../redis';\n@@ -73,4 +73,62 @@ describe('Agent Status', () => {\n     expect(parameters2.parameter?.find((p) => p.name === 'version')?.valueString).toBe('3.1.4');\n     expect(parameters2.parameter?.find((p) => p.name === 'lastUpdated')?.valueInstant).toBeTruthy();\n   });\n+\n+  test('Get agent status by ID -- invalid AgentInfo from Redis', async () => {\n+    await getRedis().set(\n+      `medplum:agent:${agent.id}:info`,\n+      JSON.stringify({\n+        version: '3.1.4',\n+        lastUpdated: new Date().toISOString(),\n+      }),\n+      'EX',\n+      60\n+    );\n+\n+    const res = await request(app)\n+      .get(`/fhir/R4/Agent/${agent.id}/$status`)\n+      .set('Authorization', 'Bearer ' + accessToken);\n+    expect(res.status).toBe(400);\n+\n+    expect(res.body).toMatchObject<OperationOutcome>({\n+      resourceType: 'OperationOutcome',\n+      issue: [\n+        expect.objectContaining({\n+          severity: 'error',\n+          code: 'invalid',\n+          details: { text: expect.stringContaining('Invalid agent info: ') },\n+        }),\n+      ],\n+    });\n+\n+    await getRedis().set(\n+      `medplum:agent:${agent.id}:info`,\n+      JSON.stringify({\n+        status: AgentConnectionState.UNKNOWN,\n+        version: 'unknown',\n+        lastUpdated: new Date().toISOString(),\n+      } satisfies AgentInfo),\n+      'EX',\n+      60\n+    );\n+  });\n+\n+  test('Get agent statuses -- no ID or identifier', async () => {\n+    const res = await request(app)\n+      .get('/fhir/R4/Agent/$status')\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken);\n+    expect(res.status).toBe(400);\n+\n+    expect(res.body).toMatchObject<OperationOutcome>({\n+      resourceType: 'OperationOutcome',\n+      issue: expect.arrayContaining<OperationOutcomeIssue>([\n+        expect.objectContaining<OperationOutcomeIssue>({\n+          severity: 'error',\n+          code: 'invalid',\n+          details: { text: 'Must specify agent ID or identifier' },\n+        }),\n+      ]),\n+    });\n+  });\n });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6136",
    "pr_id": 6136,
    "issue_id": 6084,
    "repo": "medplum/medplum",
    "problem_statement": "Gracefully Handle two agents running on the same machine\n## Background\nexample situation: \n\n- Agent is already running as a Windows service\n- User _also_ clicks on the agent.exe file, not knowing that the service s running\n- Now you have two agents, with the same config. \n\n\n## Observed Behavior\n- Each agent \"steals\" the connection from the other, causing the agent connectivity status to continually \"bounce\"\n- intermittent failures on `Agent/$push`\n\n## Desired Behavior\n- The 2nd agent fails to start and exits, as there is already an active agent running",
    "issue_word_count": 85,
    "test_files_count": 2,
    "non_test_files_count": 2,
    "pr_changed_files": [
      "packages/agent/src/main.test.ts",
      "packages/agent/src/main.ts",
      "packages/agent/src/pid.test.ts",
      "packages/agent/src/pid.ts"
    ],
    "pr_changed_test_files": [
      "packages/agent/src/main.test.ts",
      "packages/agent/src/pid.test.ts"
    ],
    "base_commit": "a2ef259581b864c477f5cc8bc238fb1ef41ed609",
    "head_commit": "83dbc0de465ca43f3316b1546a37fd1e88c4a682",
    "repo_url": "https://github.com/medplum/medplum/pull/6136",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6136",
    "dockerfile": "",
    "pr_merged_at": "2025-04-14T21:01:56.000Z",
    "patch": "diff --git a/packages/agent/src/main.ts b/packages/agent/src/main.ts\nindex 6d285f3bc4..92707767b9 100644\n--- a/packages/agent/src/main.ts\n+++ b/packages/agent/src/main.ts\n@@ -1,14 +1,21 @@\n import { agentMain } from './agent-main';\n+import { createPidFile, registerAgentCleanup } from './pid';\n import { upgraderMain } from './upgrader';\n \n export async function main(argv: string[]): Promise<void> {\n+  registerAgentCleanup();\n   if (argv[2] === '--upgrade') {\n+    createPidFile('medplum-agent-upgrader');\n     await upgraderMain(argv);\n   } else {\n+    createPidFile('medplum-agent');\n     await agentMain(argv);\n   }\n }\n \n if (typeof require !== 'undefined' && require.main === module) {\n-  main(process.argv).catch(console.error);\n+  main(process.argv).catch((err) => {\n+    console.log(err);\n+    process.exit(1);\n+  });\n }\n\ndiff --git a/packages/agent/src/pid.ts b/packages/agent/src/pid.ts\nnew file mode 100644\nindex 0000000000..bf99bd3148\n--- /dev/null\n+++ b/packages/agent/src/pid.ts\n@@ -0,0 +1,175 @@\n+import { Logger } from '@medplum/core';\n+import fs from 'node:fs';\n+import { platform, tmpdir } from 'node:os';\n+import path from 'node:path';\n+import process from 'node:process';\n+\n+const EXIT_SIGNALS = ['SIGINT', 'SIGTERM', 'SIGHUP'] as const;\n+\n+export const pidLogger = new Logger((msg) => `[PID]: ${msg}`);\n+const pidFilePaths = new Set<string>();\n+const processExitListener = (): void => {\n+  removeAllPidFiles();\n+};\n+const signalListener = (): void => {\n+  removeAllPidFiles();\n+  process.exit(0);\n+};\n+const uncaughtExceptionListener = (err: Error): void => {\n+  pidLogger.error('Uncaught exception:', err);\n+  removeAllPidFiles();\n+  process.exit(1);\n+};\n+let agentCleanupSetup = false;\n+\n+/**\n+ * Get the appropriate PID file location based on OS\n+ * @param appName - The name of the application\n+ * @returns The path to the PID file\n+ */\n+export function getPidFilePath(appName: string): string {\n+  switch (platform()) {\n+    case 'linux':\n+    case 'darwin':\n+      // We use tmpdir for linux and Mac because /var/run requires root access\n+      // The benefit of using the convention is outweighed by the required permission level to create files/directories inside\n+      return path.join(tmpdir(), 'medplum-agent', `${appName}.pid`);\n+    case 'win32':\n+      return path.join('C:', 'ProgramData', 'MedplumAgent', 'pids', `${appName}.pid`);\n+    default:\n+      throw new Error('Invalid OS');\n+  }\n+}\n+\n+/**\n+ * Remove the PID file\n+ * @param pidFilePath - Path to the PID file\n+ */\n+export function removePidFile(pidFilePath: string): void {\n+  if (fs.existsSync(pidFilePath)) {\n+    try {\n+      fs.unlinkSync(pidFilePath);\n+      pidLogger.info(`PID file removed: ${pidFilePath}`);\n+    } catch (err) {\n+      pidLogger.error(`Error removing PID file: ${pidFilePath}`, err as Error);\n+    }\n+  }\n+  pidFilePaths.delete(pidFilePath);\n+}\n+\n+/**\n+ * Returns true if a PID points to an existing process, else returns false.\n+ * @param pid - The PID to check if it exists.\n+ * @returns Boolean indicating if a process with the given PID exists.\n+ */\n+export function checkProcessExists(pid: number): boolean {\n+  try {\n+    // Sending signal 0 doesn't actually send a signal but checks if process exists\n+    process.kill(pid, 0);\n+    // If we didn't throw an error above, the process is still running, and PID is not stale\n+    return true;\n+  } catch (err) {\n+    // If the error is \"ESRCH\", the process doesn't exist\n+    if ((err as Error & { code: string }).code === 'ESRCH') {\n+      return false;\n+    }\n+    // If the error is \"EPERM\", the process exists but we don't have permission\n+    if ((err as Error & { code: string }).code === 'EPERM') {\n+      return true;\n+    }\n+    // For any other errors, throw them\n+    throw err;\n+  }\n+}\n+\n+/**\n+ * Create a PID file for the current process\n+ * @param appName - Optional application name, defaults to script filename\n+ * @returns Object containing success status and pidFilePath\n+ */\n+export function createPidFile(appName: string): string {\n+  const pid = process.pid;\n+  const pidFilePath = getPidFilePath(appName);\n+\n+  // Check if PID file already exists\n+  if (fs.existsSync(pidFilePath)) {\n+    const existingPid = fs.readFileSync(pidFilePath, 'utf8').trim();\n+\n+    // Check if the process with this PID is still running\n+    pidLogger.info('Checking if process is running');\n+    if (checkProcessExists(Number.parseInt(existingPid, 10))) {\n+      throw new Error(`${appName} already running`);\n+    }\n+\n+    // If we make it here, PID file exists but it's stale\n+    pidLogger.info('Stale PID file found. Overwriting...');\n+    fs.unlinkSync(pidFilePath);\n+  }\n+\n+  // We need to make sure the directory exists first since we aren't just using a system-created dir like /var/run\n+  ensureDirectoryExists(path.dirname(pidFilePath));\n+\n+  // Write the PID file atomically using the wx flag\n+  // This makes writeFileSync throw when another process tries to create the same file at the same time\n+  // We do this in order to make sure only one agent process can start up at a given time\n+  fs.writeFileSync(pidFilePath, pid.toString(), { flag: 'wx' });\n+\n+  pidLogger.info(`PID file created at: ${pidFilePath}`);\n+\n+  pidFilePaths.add(pidFilePath);\n+\n+  return pidFilePath;\n+}\n+\n+/**\n+ * Ensures PID directory exists.\n+ * @param directoryPath - The path to the directory.\n+ */\n+export function ensureDirectoryExists(directoryPath: string): void {\n+  if (!fs.existsSync(directoryPath)) {\n+    fs.mkdirSync(directoryPath, { recursive: true });\n+    pidLogger.info(`Directory created: ${directoryPath}`);\n+  } else {\n+    pidLogger.info(`Directory already exists: ${directoryPath}`);\n+  }\n+}\n+\n+/**\n+ * Cleans up all PID files and removes them from the list of PID files to cleanup when the process ends.\n+ */\n+export function removeAllPidFiles(): void {\n+  for (const pidFilePath of pidFilePaths) {\n+    removePidFile(pidFilePath);\n+  }\n+}\n+\n+/**\n+ * Cleans up the PID file in the event of any process exit scenario.\n+ */\n+export function registerAgentCleanup(): void {\n+  if (!agentCleanupSetup) {\n+    // Handle normal exit\n+    process.on('exit', processExitListener);\n+    // Handle various signals\n+    for (const signal of EXIT_SIGNALS) {\n+      process.on(signal, signalListener);\n+    }\n+    // Handle uncaught exceptions\n+    process.on('uncaughtException', uncaughtExceptionListener);\n+    agentCleanupSetup = true;\n+  }\n+}\n+\n+/**\n+ * Deregisters agent cleanup listeners.\n+ */\n+export function deregisterAgentCleanup(): void {\n+  if (agentCleanupSetup) {\n+    process.off('exit', processExitListener);\n+    for (const signal of EXIT_SIGNALS) {\n+      process.off(signal, signalListener);\n+    }\n+    process.off('uncaughtException', uncaughtExceptionListener);\n+    agentCleanupSetup = false;\n+  }\n+}\n",
    "test_patch": "diff --git a/packages/agent/src/main.test.ts b/packages/agent/src/main.test.ts\nindex 612b07c1b3..1e450331c2 100644\n--- a/packages/agent/src/main.test.ts\n+++ b/packages/agent/src/main.test.ts\n@@ -3,6 +3,7 @@ import os from 'node:os';\n import * as agentMainFile from './agent-main';\n import { App } from './app';\n import { main } from './main';\n+import * as pidFile from './pid';\n import * as upgraderFile from './upgrader';\n \n describe('Main', () => {\n@@ -16,12 +17,7 @@ describe('Main', () => {\n     jest.spyOn(App.prototype, 'start').mockImplementation(() => Promise.resolve());\n \n     jest.spyOn(globalThis, 'fetch').mockImplementation(async () => {\n-      return {\n-        ok: true,\n-        json: async () => ({\n-          access_token: 'foo',\n-        }),\n-      } as Response;\n+      return new Response(JSON.stringify({ access_token: 'foo' }));\n     });\n   });\n \n@@ -32,9 +28,14 @@ describe('Main', () => {\n   test('Calling main without --upgrade', async () => {\n     const agentMainSpy = jest.spyOn(agentMainFile, 'agentMain');\n     const upgradeMainSpy = jest.spyOn(upgraderFile, 'upgraderMain');\n+    const createPidSpy = jest.spyOn(pidFile, 'createPidFile').mockReturnValue('/tmp/test.pid');\n+    const registerCleanupSpy = jest.spyOn(pidFile, 'registerAgentCleanup');\n \n     // Invalid number of args\n     await expect(main(['node', 'main.ts', 'https://example.com/', randomUUID()])).rejects.toThrow('process.exit');\n+\n+    expect(createPidSpy).toHaveBeenCalledWith('medplum-agent');\n+    expect(registerCleanupSpy).toHaveBeenCalledWith();\n     expect(upgradeMainSpy).not.toHaveBeenCalled();\n     expect(agentMainSpy).toHaveBeenCalledWith(['node', 'main.ts', 'https://example.com/', expect.any(String)]);\n \n@@ -46,10 +47,15 @@ describe('Main', () => {\n     const platformSpy = jest.spyOn(os, 'platform').mockImplementation(() => 'linux');\n     const agentMainSpy = jest.spyOn(agentMainFile, 'agentMain');\n     const upgradeMainSpy = jest.spyOn(upgraderFile, 'upgraderMain');\n+    const createPidSpy = jest.spyOn(pidFile, 'createPidFile').mockReturnValue('/tmp/test.pid');\n+    const registerCleanupSpy = jest.spyOn(pidFile, 'registerAgentCleanup');\n \n     await expect(main(['node', 'main.ts', '--upgrade'])).rejects.toThrow(\n       'Unsupported platform: linux. Agent upgrader currently only supports Windows'\n     );\n+\n+    expect(createPidSpy).toHaveBeenCalledWith('medplum-agent-upgrader');\n+    expect(registerCleanupSpy).toHaveBeenCalledWith();\n     expect(agentMainSpy).not.toHaveBeenCalled();\n     expect(upgradeMainSpy).toHaveBeenCalledWith(['node', 'main.ts', '--upgrade']);\n \n\ndiff --git a/packages/agent/src/pid.test.ts b/packages/agent/src/pid.test.ts\nnew file mode 100644\nindex 0000000000..ed77bf528d\n--- /dev/null\n+++ b/packages/agent/src/pid.test.ts\n@@ -0,0 +1,368 @@\n+import fs, { PathOrFileDescriptor } from 'node:fs';\n+import os from 'node:os';\n+import { dirname } from 'node:path';\n+import {\n+  createPidFile,\n+  deregisterAgentCleanup,\n+  ensureDirectoryExists,\n+  getPidFilePath,\n+  pidLogger,\n+  registerAgentCleanup,\n+  removePidFile,\n+} from './pid';\n+\n+jest.mock('node:fs');\n+jest.mock('node:os', () => ({\n+  ...jest.requireActual('node:os'),\n+  platform: jest.fn(() => 'darwin'),\n+  tmpdir: jest.fn(() => '/tmp'),\n+}));\n+\n+const mockedFs = jest.mocked(fs);\n+const mockedOs = jest.mocked(os);\n+const APP_NAME = 'test-pid-app';\n+const PID_DIR = dirname(getPidFilePath(APP_NAME));\n+const TEST_PID_PATH = '/tmp/medplum-agent/test-pid-app.pid';\n+const createdPidFiles = new Set<string>();\n+\n+describe('PID File Manager', () => {\n+  beforeEach(() => {\n+    jest.resetAllMocks();\n+    mockedFs.existsSync.mockImplementation((filePath: PathOrFileDescriptor) => {\n+      // This is for the `ensureDirectoryExists` check\n+      if (filePath.toString() === PID_DIR) {\n+        return true;\n+      }\n+      if (createdPidFiles.has(filePath.toString())) {\n+        return true;\n+      }\n+      return false;\n+    });\n+    mockedFs.mkdirSync.mockImplementation(() => undefined);\n+    mockedFs.readFileSync.mockImplementation((filePath: PathOrFileDescriptor) => {\n+      if (createdPidFiles.has(filePath.toString())) {\n+        return process.pid.toString();\n+      }\n+      const err = new Error('ENOENT');\n+      (err as Error & { code: string }).code = 'ENOENT';\n+      throw err;\n+    });\n+    mockedFs.writeFileSync.mockImplementation((filePath: PathOrFileDescriptor) => {\n+      if (createdPidFiles.has(filePath.toString())) {\n+        throw new Error('File already exists');\n+      }\n+      createdPidFiles.add(filePath.toString());\n+      return undefined;\n+    });\n+    mockedFs.unlinkSync.mockImplementation((filePath: PathOrFileDescriptor) => {\n+      createdPidFiles.delete(filePath.toString());\n+      return undefined;\n+    });\n+    mockedOs.platform.mockImplementation(() => 'darwin');\n+    mockedOs.tmpdir.mockImplementation(() => '/tmp');\n+  });\n+\n+  afterEach(() => {\n+    // Clean up any listeners we may have added\n+    process.removeAllListeners('SIGTERM');\n+    process.removeAllListeners('SIGINT');\n+    process.removeAllListeners('uncaughtException');\n+    createdPidFiles.clear();\n+  });\n+\n+  test('creates and removes PID file on normal process lifecycle', () => {\n+    // Create PID file\n+    const pidFilePath = createPidFile(APP_NAME);\n+    expect(pidFilePath).toBe(TEST_PID_PATH);\n+\n+    // Verify write was called with correct arguments\n+    expect(mockedFs.writeFileSync).toHaveBeenCalledWith(\n+      expect.stringContaining('.pid'),\n+      process.pid.toString(),\n+      expect.objectContaining({\n+        flag: 'wx',\n+      })\n+    );\n+\n+    // Remove PID file\n+    removePidFile(pidFilePath);\n+\n+    // Verify unlink was called\n+    expect(mockedFs.unlinkSync).toHaveBeenCalledWith(TEST_PID_PATH);\n+  });\n+\n+  test('prevents running multiple instances of the same app', () => {\n+    createPidFile(APP_NAME);\n+\n+    // Mock process.kill to simulate existing process\n+    const originalKill = process.kill;\n+    process.kill = jest.fn();\n+\n+    try {\n+      // Attempt to create PID file should throw\n+      expect(() => createPidFile(APP_NAME)).toThrow('test-pid-app already running');\n+      expect(process.kill).toHaveBeenCalledWith(process.pid, 0);\n+    } finally {\n+      process.kill = originalKill;\n+    }\n+  });\n+\n+  test('handles stale PID files correctly', () => {\n+    createPidFile(APP_NAME);\n+\n+    // Mock process.kill to simulate non-existent process\n+    const originalKill = process.kill;\n+    process.kill = jest.fn().mockImplementation(() => {\n+      // This is the Error thrown from Node when a process does not exist\n+      const esrchError = new Error();\n+      (esrchError as Error & { code: string }).code = 'ESRCH';\n+      throw esrchError;\n+    });\n+\n+    try {\n+      // Should succeed and overwrite stale PID file\n+      const pidFilePath = createPidFile(APP_NAME);\n+      expect(pidFilePath).toBe(TEST_PID_PATH);\n+\n+      // Make sure stale PID file was deleted\n+      expect(mockedFs.unlinkSync).toHaveBeenCalledWith(TEST_PID_PATH);\n+\n+      // Verify write operations\n+      expect(mockedFs.writeFileSync).toHaveBeenCalledWith(\n+        expect.stringContaining('.pid'),\n+        process.pid.toString(),\n+        expect.objectContaining({\n+          flag: 'wx',\n+        })\n+      );\n+    } finally {\n+      process.kill = originalKill;\n+    }\n+  });\n+\n+  test('handles EPERM errors correctly', () => {\n+    createPidFile(APP_NAME);\n+    mockedFs.writeFileSync.mockClear();\n+\n+    // Mock process.kill to simulate non-existent process\n+    const originalKill = process.kill;\n+    process.kill = jest.fn().mockImplementation(() => {\n+      const epermError = new Error();\n+      (epermError as Error & { code: string }).code = 'EPERM';\n+      throw epermError;\n+    });\n+\n+    try {\n+      // Should fail\n+      expect(() => createPidFile(APP_NAME)).toThrow(`${APP_NAME} already running`);\n+\n+      // Verify write operations didn't occur\n+      expect(mockedFs.writeFileSync).not.toHaveBeenCalled();\n+    } finally {\n+      process.kill = originalKill;\n+    }\n+  });\n+\n+  test('handles other errors', () => {\n+    createPidFile(APP_NAME);\n+    mockedFs.writeFileSync.mockClear();\n+\n+    // Mock process.kill to simulate non-existent process\n+    const originalKill = process.kill;\n+    process.kill = jest.fn().mockImplementation(() => {\n+      throw new Error('Unknown error');\n+    });\n+\n+    try {\n+      // Should fail\n+      expect(() => createPidFile(APP_NAME)).toThrow(new Error('Unknown error'));\n+\n+      // Verify write operations didn't occur\n+      expect(mockedFs.writeFileSync).not.toHaveBeenCalled();\n+    } finally {\n+      process.kill = originalKill;\n+    }\n+  });\n+\n+  test.each(['darwin', 'linux'] as const)('returns appropriate file path for the current OS -- %s', (os) => {\n+    mockedOs.platform.mockImplementationOnce(() => os);\n+    const pidFilePath = getPidFilePath(APP_NAME);\n+    expect(pidFilePath).toEqual(TEST_PID_PATH);\n+  });\n+\n+  test('returns appropriate file path for the current OS -- win32', () => {\n+    mockedOs.platform.mockImplementationOnce(() => 'win32');\n+    const pidFilePath = getPidFilePath(APP_NAME);\n+    expect(pidFilePath).toEqual(`C:/ProgramData/MedplumAgent/pids/${APP_NAME}.pid`);\n+  });\n+\n+  test('throws on unsupported or invalid OS', () => {\n+    mockedOs.platform.mockImplementationOnce(() => 'freebsd');\n+    expect(() => getPidFilePath(APP_NAME)).toThrow(new Error('Invalid OS'));\n+  });\n+\n+  test('safely handles non-existent PID file during removal', () => {\n+    // Should not throw\n+    removePidFile(TEST_PID_PATH);\n+\n+    // Verify unlink was not called\n+    expect(mockedFs.unlinkSync).not.toHaveBeenCalled();\n+  });\n+\n+  test('handles file system errors during PID file creation', () => {\n+    // Mock write failure\n+    mockedFs.writeFileSync.mockImplementation(() => {\n+      throw new Error('Permission denied');\n+    });\n+\n+    // Should throw\n+    expect(() => createPidFile(APP_NAME)).toThrow('Permission denied');\n+  });\n+\n+  test('handles file system errors during PID file removal', () => {\n+    // Mock file existing but unlink failing\n+    mockedFs.existsSync.mockReturnValue(true);\n+    mockedFs.unlinkSync.mockImplementation(() => {\n+      throw new Error('Permission denied');\n+    });\n+\n+    // Should not throw\n+    expect(() => removePidFile(TEST_PID_PATH)).not.toThrow('Permission denied');\n+\n+    // Verify unlink was attempted\n+    expect(mockedFs.unlinkSync).toHaveBeenCalledWith(TEST_PID_PATH);\n+  });\n+\n+  describe('registerAgentCleanup', () => {\n+    let originalExit: typeof process.exit;\n+    let processOnMock: jest.SpyInstance;\n+    let processEvents: Record<string, (err?: Error) => void> = {};\n+\n+    beforeEach(() => {\n+      originalExit = process.exit;\n+      process.exit = jest.fn() as unknown as typeof process.exit;\n+      processOnMock = jest.spyOn(process, 'on').mockImplementation((event, cb) => {\n+        processEvents[event.toString()] = cb;\n+        return process; // For chaining\n+      });\n+    });\n+\n+    afterEach(() => {\n+      process.exit = originalExit;\n+      processOnMock.mockClear();\n+      processEvents = {};\n+      deregisterAgentCleanup();\n+    });\n+\n+    test('registers handlers for SIGTERM, SIGINT, SIGHUP, and uncaughtException', () => {\n+      const addListenerSpy = jest.spyOn(process, 'on');\n+      registerAgentCleanup();\n+\n+      expect(addListenerSpy).toHaveBeenCalledWith('SIGTERM', expect.any(Function));\n+      expect(addListenerSpy).toHaveBeenCalledWith('SIGINT', expect.any(Function));\n+      expect(addListenerSpy).toHaveBeenCalledWith('SIGHUP', expect.any(Function));\n+      expect(addListenerSpy).toHaveBeenCalledWith('uncaughtException', expect.any(Function));\n+\n+      addListenerSpy.mockClear();\n+    });\n+\n+    test('removes PID file and exits on process.exit', async () => {\n+      registerAgentCleanup();\n+      createPidFile(APP_NAME);\n+\n+      processEvents.exit?.();\n+\n+      expect(mockedFs.unlinkSync).toHaveBeenCalledWith(TEST_PID_PATH);\n+      expect(mockedFs.existsSync).toHaveBeenCalledWith(TEST_PID_PATH);\n+    });\n+\n+    test('removes PID file and exits on SIGTERM', async () => {\n+      registerAgentCleanup();\n+      createPidFile(APP_NAME);\n+\n+      processEvents.SIGTERM?.();\n+\n+      expect(mockedFs.unlinkSync).toHaveBeenCalledWith(TEST_PID_PATH);\n+      expect(mockedFs.existsSync).toHaveBeenCalledWith(TEST_PID_PATH);\n+      expect(process.exit).toHaveBeenCalledWith(0);\n+    });\n+\n+    test('removes PID file and exits on SIGINT', () => {\n+      registerAgentCleanup();\n+      createPidFile(APP_NAME);\n+\n+      processEvents.SIGINT?.();\n+\n+      expect(mockedFs.unlinkSync).toHaveBeenCalledWith(TEST_PID_PATH);\n+      expect(mockedFs.existsSync).toHaveBeenCalledWith(TEST_PID_PATH);\n+      expect(process.exit).toHaveBeenCalledWith(0);\n+    });\n+\n+    test('removes PID file and exits on SIGHUP', () => {\n+      registerAgentCleanup();\n+      createPidFile(APP_NAME);\n+\n+      processEvents.SIGHUP?.();\n+\n+      expect(mockedFs.unlinkSync).toHaveBeenCalledWith(TEST_PID_PATH);\n+      expect(mockedFs.existsSync).toHaveBeenCalledWith(TEST_PID_PATH);\n+      expect(process.exit).toHaveBeenCalledWith(0);\n+    });\n+\n+    test('removes PID file and exits on uncaughtException', () => {\n+      registerAgentCleanup();\n+      createPidFile(APP_NAME);\n+\n+      processEvents.uncaughtException?.(new Error('Test error'));\n+\n+      expect(mockedFs.unlinkSync).toHaveBeenCalledWith(TEST_PID_PATH);\n+      expect(mockedFs.existsSync).toHaveBeenCalledWith(TEST_PID_PATH);\n+      expect(process.exit).toHaveBeenCalledWith(1);\n+    });\n+\n+    test('handles non-existent PID file during cleanup and still exits', () => {\n+      registerAgentCleanup();\n+      const pidFilePath = createPidFile(APP_NAME);\n+      mockedFs.unlinkSync(pidFilePath);\n+      mockedFs.unlinkSync.mockReset();\n+\n+      processEvents.SIGTERM?.();\n+\n+      expect(mockedFs.existsSync).toHaveBeenCalledWith(TEST_PID_PATH);\n+      expect(mockedFs.unlinkSync).not.toHaveBeenCalled();\n+      expect(process.exit).toHaveBeenCalledWith(0);\n+    });\n+\n+    test('handles file system errors during cleanup and still exits', () => {\n+      const pidLoggerErrorSpy = jest.spyOn(pidLogger, 'error').mockImplementation();\n+      mockedFs.unlinkSync.mockImplementation(() => {\n+        throw new Error('Permission denied');\n+      });\n+\n+      registerAgentCleanup();\n+      createPidFile(APP_NAME);\n+      processEvents.SIGTERM?.();\n+\n+      expect(pidLoggerErrorSpy).toHaveBeenCalledWith(\n+        expect.stringContaining('Error removing PID file: /tmp/medplum-agent/test-pid-app.pid'),\n+        new Error('Permission denied')\n+      );\n+      expect(process.exit).toHaveBeenCalledWith(0);\n+      pidLoggerErrorSpy.mockRestore();\n+    });\n+  });\n+\n+  describe('ensureDirectoryExists', () => {\n+    test('Path already exists', () => {\n+      mockedFs.existsSync.mockImplementation(() => true);\n+      ensureDirectoryExists('test/path/to/file');\n+      expect(mockedFs.mkdirSync).not.toHaveBeenCalled();\n+    });\n+\n+    test('Path does NOT exist already', () => {\n+      mockedFs.existsSync.mockImplementation(() => false);\n+      ensureDirectoryExists('test/path/to/file');\n+      expect(mockedFs.mkdirSync).toHaveBeenCalledWith('test/path/to/file', { recursive: true });\n+    });\n+  });\n+});\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6123",
    "pr_id": 6123,
    "issue_id": 6122,
    "repo": "medplum/medplum",
    "problem_statement": "QuestionnaireForm returns invalid answer valueString.\nWhen a user clears a field that is supposed to return a QuestionnaireResponseItemAnswer.valueString, the QuestionnaireForm returns valueString: \"\" (an empty string) rather than undefined. This response is rejected by server when trying to save the resource.\n\n**Steps to Reproduce:**  \n- Create a questionnaire form with a text input field mapped to a QuestionnaireResponseItemAnswer.valueString.\n- Enter a value into the field, then clear it (delete the input).\n- Submit the form and inspect the resulting response object.",
    "issue_word_count": 79,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx",
      "packages/react/src/QuestionnaireForm/QuestionnaireFormItem/QuestionnaireFormItem.tsx"
    ],
    "pr_changed_test_files": [
      "packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx"
    ],
    "base_commit": "85287399a23dd5ba831d7c34279ef9681de0de80",
    "head_commit": "1f288bc90594fe3b9c7f157d3d7527a236e54683",
    "repo_url": "https://github.com/medplum/medplum/pull/6123",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6123",
    "dockerfile": "",
    "pr_merged_at": "2025-03-05T23:37:07.000Z",
    "patch": "diff --git a/packages/react/src/QuestionnaireForm/QuestionnaireFormItem/QuestionnaireFormItem.tsx b/packages/react/src/QuestionnaireForm/QuestionnaireFormItem/QuestionnaireFormItem.tsx\nindex 616cbb438e..48e1eb4138 100644\n--- a/packages/react/src/QuestionnaireForm/QuestionnaireFormItem/QuestionnaireFormItem.tsx\n+++ b/packages/react/src/QuestionnaireForm/QuestionnaireFormItem/QuestionnaireFormItem.tsx\n@@ -162,7 +162,10 @@ export function QuestionnaireFormItem(props: QuestionnaireFormItemProps): JSX.El\n           name={name}\n           required={props.required ?? item.required}\n           defaultValue={defaultValue?.value}\n-          onChange={(e) => onChangeAnswer({ valueString: e.currentTarget.value })}\n+          onChange={(e) => {\n+            const value = e.currentTarget.value;\n+            onChangeAnswer({ valueString: value === '' ? undefined : value });\n+          }}\n         />\n       );\n     case QuestionnaireItemType.text:\n@@ -172,7 +175,10 @@ export function QuestionnaireFormItem(props: QuestionnaireFormItemProps): JSX.El\n           name={name}\n           required={props.required ?? item.required}\n           defaultValue={defaultValue?.value}\n-          onChange={(e) => onChangeAnswer({ valueString: e.currentTarget.value })}\n+          onChange={(e) => {\n+            const value = e.currentTarget.value;\n+            onChangeAnswer({ valueString: value === '' ? undefined : value });\n+          }}\n         />\n       );\n     case QuestionnaireItemType.attachment:\n",
    "test_patch": "diff --git a/packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx b/packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx\nindex 41297a85a0..62f9f6e838 100644\n--- a/packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx\n+++ b/packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx\n@@ -2006,7 +2006,7 @@ describe('QuestionnaireForm', () => {\n     const response3 = onSubmit.mock.calls[2][0];\n     const answers3 = getQuestionnaireAnswers(response3);\n \n-    expect(answers3['q1']).toMatchObject({ valueString: '' });\n+    expect(answers3['q1']).toMatchObject({ valueString: undefined });\n     expect(answers3['q2']).toMatchObject({ valueBoolean: false });\n   });\n \n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6104",
    "pr_id": 6104,
    "issue_id": 6098,
    "repo": "medplum/medplum",
    "problem_statement": "[ChooseScopeForm] Warning: Each child in a list should have a unique \"key\" prop\n![Image](https://github.com/user-attachments/assets/85b8d78c-8a01-4a34-a42b-4efb16a830cb)",
    "issue_word_count": 25,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/react/src/auth/ChooseScopeForm.tsx",
      "packages/react/src/auth/SignInForm.test.tsx"
    ],
    "pr_changed_test_files": [
      "packages/react/src/auth/SignInForm.test.tsx"
    ],
    "base_commit": "1c144d7bcd4d477d556576c382c689570edecef7",
    "head_commit": "e1ddc4fb44918dbbabc1a61661ed1533b9bc4f43",
    "repo_url": "https://github.com/medplum/medplum/pull/6104",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6104",
    "dockerfile": "",
    "pr_merged_at": "2025-03-03T23:20:55.000Z",
    "patch": "diff --git a/packages/react/src/auth/ChooseScopeForm.tsx b/packages/react/src/auth/ChooseScopeForm.tsx\nindex 1697dbaa7d..fc8349979f 100644\n--- a/packages/react/src/auth/ChooseScopeForm.tsx\n+++ b/packages/react/src/auth/ChooseScopeForm.tsx\n@@ -3,6 +3,7 @@ import { LoginAuthenticationResponse } from '@medplum/core';\n import { useMedplum } from '@medplum/react-hooks';\n import { Form } from '../Form/Form';\n import { Logo } from '../Logo/Logo';\n+import { Fragment } from 'react/jsx-runtime';\n \n export interface ChooseScopeFormProps {\n   readonly login: string;\n@@ -62,10 +63,10 @@ export function ChooseScopeForm(props: ChooseScopeFormProps): JSX.Element {\n               ];\n             }\n             return (\n-              <>\n+              <Fragment key={scopeName + '_group'}>\n                 <Checkbox key={scopeName} id={scopeName} name={scopeName} label={scopeName} defaultChecked />\n                 {additionalScopes?.map((scope) => <Checkbox key={scope} id={scope} name={scope} label={scope} />)}\n-              </>\n+              </Fragment>\n             );\n           })}\n         </Stack>\n",
    "test_patch": "diff --git a/packages/react/src/auth/SignInForm.test.tsx b/packages/react/src/auth/SignInForm.test.tsx\nindex 59d47dec69..d0c1a8fcfe 100644\n--- a/packages/react/src/auth/SignInForm.test.tsx\n+++ b/packages/react/src/auth/SignInForm.test.tsx\n@@ -394,12 +394,12 @@ describe('SignInForm', () => {\n   });\n \n   test('Choose scope', async () => {\n-    let success = false;\n+    const successFn = jest.fn();\n \n     await setup({\n       chooseScopes: true,\n       scope: 'openid profile',\n-      onSuccess: () => (success = true),\n+      onSuccess: successFn,\n     });\n \n     await act(async () => {\n@@ -430,7 +430,7 @@ describe('SignInForm', () => {\n       fireEvent.click(screen.getByText('Set scope'));\n     });\n \n-    expect(success).toBe(true);\n+    expect(successFn).toHaveBeenCalled();\n   });\n \n   test('Submit success new project', async () => {\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6100",
    "pr_id": 6100,
    "issue_id": 2637,
    "repo": "medplum/medplum",
    "problem_statement": "Migrate from `fireEvent` to `user-events`\nWhile trying to write tests for `<CopyButton>` (https://github.com/medplum/medplum/pull/2634), I found it quite difficult to properly test the hover events and delayed effects.  I looked into how Mantine tests those things, and it turns out internally they use `user-event`:\r\n\r\nhttps://testing-library.com/docs/user-event/intro/#difference-to-fireevent\r\n\r\n[When to use userEvent.click and when to use fireEvent](https://stackoverflow.com/questions/64006345/react-testing-library-when-to-use-userevent-click-and-when-to-use-fireevent)\r\n\r\n> Behind the scenes, userEvent uses the fireEvent. You can consider fireEvent being the low-level api, while userEvent sets a flow of actions.\r\n> \r\n> [Here is the code for userEvent.click](https://github.com/testing-library/user-event/blob/5feaa942f46bb37d96c2f2fbeb4b33e8beff75ad/src/click.js#L87-L103)\r\n> \r\n> You can see that depending of which element you are trying to click, userEvent will do a set of different actions (e.g. if it's a label or a checkbox).\r\n\r\nThere are probably many cases in `react` and `app` that could benefit from this.",
    "issue_word_count": 179,
    "test_files_count": 9,
    "non_test_files_count": 0,
    "pr_changed_files": [
      "packages/app/src/App.test.tsx",
      "packages/app/src/BatchPage.test.tsx",
      "packages/app/src/ChangePasswordPage.test.tsx",
      "packages/app/src/CreateResourcePage.test.tsx",
      "packages/app/src/MfaPage.test.tsx",
      "packages/app/src/OAuthPage.test.tsx",
      "packages/app/src/RegisterPage.test.tsx",
      "packages/app/src/ResetPasswordPage.test.tsx",
      "packages/app/src/test-utils/render.tsx"
    ],
    "pr_changed_test_files": [
      "packages/app/src/App.test.tsx",
      "packages/app/src/BatchPage.test.tsx",
      "packages/app/src/ChangePasswordPage.test.tsx",
      "packages/app/src/CreateResourcePage.test.tsx",
      "packages/app/src/MfaPage.test.tsx",
      "packages/app/src/OAuthPage.test.tsx",
      "packages/app/src/RegisterPage.test.tsx",
      "packages/app/src/ResetPasswordPage.test.tsx",
      "packages/app/src/test-utils/render.tsx"
    ],
    "base_commit": "ec566aedb49fd74d4998d70e7faf064eca3e1130",
    "head_commit": "214fa9637f53157f3786895773140f98870be1a6",
    "repo_url": "https://github.com/medplum/medplum/pull/6100",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6100",
    "dockerfile": "",
    "pr_merged_at": "2025-03-12T00:21:55.000Z",
    "patch": "",
    "test_patch": "diff --git a/packages/app/src/App.test.tsx b/packages/app/src/App.test.tsx\nindex dc6f0e7d69..cba4497bab 100644\n--- a/packages/app/src/App.test.tsx\n+++ b/packages/app/src/App.test.tsx\n@@ -3,11 +3,12 @@ import { MockClient } from '@medplum/mock';\n import { MedplumProvider } from '@medplum/react';\n import { MemoryRouter } from 'react-router';\n import { App } from './App';\n-import { act, fireEvent, render, screen } from './test-utils/render';\n+import { act, userEvent, UserEvent, render, screen } from './test-utils/render';\n \n const navigateMock = jest.fn();\n \n-async function setup(url = '/'): Promise<void> {\n+async function setup(url = '/'): Promise<UserEvent> {\n+  const user = userEvent.setup({ advanceTimers: jest.advanceTimersByTime });\n   await act(async () => {\n     render(\n       <MemoryRouter initialEntries={[url]} initialIndex={0}>\n@@ -19,6 +20,8 @@ async function setup(url = '/'): Promise<void> {\n       </MemoryRouter>\n     );\n   });\n+\n+  return user;\n }\n \n describe('App', () => {\n@@ -34,8 +37,8 @@ describe('App', () => {\n   });\n \n   test('Click logo', async () => {\n-    await setup();\n-    await openNav();\n+    const user = await setup();\n+    await openNav(user);\n \n     expect(screen.getByText('Patients')).toBeInTheDocument();\n     expect(screen.getByText('Settings')).toBeInTheDocument();\n@@ -43,35 +46,29 @@ describe('App', () => {\n   });\n \n   test('Click profile', async () => {\n-    await setup();\n-    await openMenu();\n+    const user = await setup();\n+    await openMenu(user);\n \n-    await act(async () => {\n-      fireEvent.click(screen.getByText('Account settings'));\n-    });\n+    await user.click(screen.getByText('Account settings'));\n   });\n \n   test('Change profile', async () => {\n-    await setup();\n-    await openMenu();\n+    const user = await setup();\n+    await openMenu(user);\n \n-    await act(async () => {\n-      fireEvent.click(screen.getByText('Add another account'));\n-    });\n+    await user.click(screen.getByText('Add another account'));\n   });\n \n   test('Click sign out', async () => {\n-    await setup();\n-    await openMenu();\n+    const user = await setup();\n+    await openMenu(user);\n \n-    await act(async () => {\n-      fireEvent.click(screen.getByText('Sign out'));\n-    });\n+    await user.click(screen.getByText('Sign out'));\n   });\n \n   test('Active link', async () => {\n-    await setup('/ServiceRequest?status=active');\n-    await openNav();\n+    const user = await setup('/ServiceRequest?status=active');\n+    await openNav(user);\n \n     const activeLink = screen.getByText('Active Orders');\n     const completedLink = screen.getByText('Completed Orders');\n@@ -79,19 +76,15 @@ describe('App', () => {\n   });\n \n   test('Resource Type Search', async () => {\n-    await setup();\n-    await openNav();\n+    const user = await setup();\n+    await openNav(user);\n \n     const input = (await screen.findByPlaceholderText('Resource Type')) as HTMLInputElement;\n \n     // Enter random text\n-    await act(async () => {\n-      fireEvent.change(input, { target: { value: 'Different' } });\n-    });\n+    await user.type(input, 'Different');\n \n-    await act(async () => {\n-      fireEvent.change(input, { target: { value: 'Test' } });\n-    });\n+    await user.type(input, 'Test');\n \n     // Wait for the drop down\n     await act(async () => {\n@@ -99,14 +92,10 @@ describe('App', () => {\n     });\n \n     // Press the down arrow\n-    await act(async () => {\n-      fireEvent.keyDown(input, { key: 'ArrowDown', code: 'ArrowDown' });\n-    });\n+    await user.keyboard('{ArrowDown}');\n \n     // Press \"Enter\"\n-    await act(async () => {\n-      fireEvent.keyDown(input, { key: 'Enter', code: 'Enter' });\n-    });\n+    await user.keyboard('{Enter}');\n \n     expect(navigateMock).toHaveBeenCalledWith('/test-code');\n   });\n@@ -116,11 +105,9 @@ function isNavOpen(): boolean {\n   return !!screen.queryByRole('navigation');\n }\n \n-async function openNav(): Promise<void> {\n+async function openNav(user: UserEvent): Promise<void> {\n   if (!isNavOpen()) {\n-    await act(async () => {\n-      fireEvent.click(screen.getByTitle('Medplum Logo'));\n-    });\n+    await user.click(screen.getByTitle('Medplum Logo'));\n   }\n }\n \n@@ -128,11 +115,9 @@ function isMenuOpen(): boolean {\n   return !!screen.queryByText('Sign out');\n }\n \n-async function openMenu(): Promise<void> {\n+async function openMenu(user: UserEvent): Promise<void> {\n   if (!isMenuOpen()) {\n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button', { name: 'Alice Smith Alice Smith' }));\n-    });\n+    await user.click(screen.getByRole('button', { name: 'Alice Smith Alice Smith' }));\n \n     await screen.findByText('Sign out');\n   }\n\ndiff --git a/packages/app/src/BatchPage.test.tsx b/packages/app/src/BatchPage.test.tsx\nindex 1face6c87c..42a58ec5da 100644\n--- a/packages/app/src/BatchPage.test.tsx\n+++ b/packages/app/src/BatchPage.test.tsx\n@@ -2,7 +2,7 @@ import { MockClient } from '@medplum/mock';\n import { MedplumProvider } from '@medplum/react';\n import { MemoryRouter } from 'react-router';\n import { BatchPage } from './BatchPage';\n-import { act, fireEvent, render, RenderResult, screen } from './test-utils/render';\n+import { act, fireEvent, render, RenderResult, screen, UserEvent, userEvent } from './test-utils/render';\n \n const exampleBundle = `{\n   \"resourceType\": \"Bundle\",\n@@ -27,14 +27,18 @@ const exampleBundle = `{\n const medplum = new MockClient();\n \n describe('BatchPage', () => {\n-  function setup(): RenderResult {\n-    return render(\n-      <MemoryRouter>\n-        <MedplumProvider medplum={medplum}>\n-          <BatchPage />\n-        </MedplumProvider>\n-      </MemoryRouter>\n-    );\n+  function setup(): { user: UserEvent; renderResult: RenderResult } {\n+    const user = userEvent.setup();\n+    return {\n+      user: user,\n+      renderResult: render(\n+        <MemoryRouter>\n+          <MedplumProvider medplum={medplum}>\n+            <BatchPage />\n+          </MedplumProvider>\n+        </MemoryRouter>\n+      ),\n+    };\n   }\n \n   test('Renders', async () => {\n@@ -43,30 +47,24 @@ describe('BatchPage', () => {\n   });\n \n   test('Submit file', async () => {\n-    const renderResult = setup();\n+    const { user, renderResult } = setup();\n \n     // Upload file\n-    await act(async () => {\n-      const fileInput = renderResult.container.querySelector('input[type=\"file\"]') as HTMLInputElement;\n-      const files = [new File([exampleBundle], 'patient.json', { type: 'application/json' })];\n-      fireEvent.change(fileInput, { target: { files } });\n-    });\n+    const fileInput = renderResult.container.querySelector('input[type=\"file\"]') as HTMLInputElement;\n+    const files = [new File([exampleBundle], 'patient.json', { type: 'application/json' })];\n+    await user.upload(fileInput, files);\n \n     expect(await screen.findByText('Output')).toBeInTheDocument();\n     expect(screen.getByRole('button', { name: 'Start over' })).toBeInTheDocument();\n \n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button', { name: 'Start over' }));\n-    });\n+    await user.click(screen.getByRole('button', { name: 'Start over' }));\n   });\n \n   test('Submit JSON', async () => {\n-    setup();\n+    const { user } = setup();\n \n     // Click on the JSON tab\n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('tab', { name: 'JSON' }));\n-    });\n+    await user.click(screen.getByRole('tab', { name: 'JSON' }));\n \n     // Enter JSON\n     await act(async () => {\n@@ -77,15 +75,11 @@ describe('BatchPage', () => {\n       });\n     });\n \n-    await act(async () => {\n-      fireEvent.click(screen.getByText('Submit'));\n-    });\n+    await user.click(screen.getByText('Submit'));\n \n     expect(await screen.findByText('Output')).toBeInTheDocument();\n     expect(screen.getByRole('button', { name: 'Start over' })).toBeInTheDocument();\n \n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button', { name: 'Start over' }));\n-    });\n+    await user.click(screen.getByRole('button', { name: 'Start over' }));\n   });\n });\n\ndiff --git a/packages/app/src/ChangePasswordPage.test.tsx b/packages/app/src/ChangePasswordPage.test.tsx\nindex 4207f16132..4fa80de4ab 100644\n--- a/packages/app/src/ChangePasswordPage.test.tsx\n+++ b/packages/app/src/ChangePasswordPage.test.tsx\n@@ -1,73 +1,51 @@\n import { MockClient } from '@medplum/mock';\n import { MedplumProvider } from '@medplum/react';\n import { ChangePasswordPage } from './ChangePasswordPage';\n-import { act, fireEvent, render, screen } from './test-utils/render';\n+import { render, screen, UserEvent, userEvent, waitFor } from './test-utils/render';\n \n const medplum = new MockClient();\n \n-function setup(): void {\n+function setup(): UserEvent {\n+  const user = userEvent.setup();\n   render(\n     <MedplumProvider medplum={medplum}>\n       <ChangePasswordPage />\n     </MedplumProvider>\n   );\n+  return user;\n }\n \n describe('ChangePasswordPage', () => {\n-  beforeEach(() => {\n-    jest.useFakeTimers();\n-  });\n-\n   test('Renders', () => {\n     setup();\n     expect(screen.getByRole('button', { name: 'Change password' })).toBeInTheDocument();\n   });\n \n   test('Submit success', async () => {\n-    setup();\n+    const user = setup();\n \n-    await act(async () => {\n-      fireEvent.change(screen.getByLabelText('Old password *'), {\n-        target: { value: 'orange' },\n-      });\n-      fireEvent.change(screen.getByLabelText('New password *'), {\n-        target: { value: 'purple' },\n-      });\n-      fireEvent.change(screen.getByLabelText('Confirm new password *'), {\n-        target: { value: 'purple' },\n-      });\n-    });\n+    await user.type(screen.getByLabelText('Old password *'), 'orange');\n+    await user.type(screen.getByLabelText('New password *'), 'purple');\n+    await user.type(screen.getByLabelText('Confirm new password *'), 'purple');\n \n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button'));\n-    });\n+    await user.click(screen.getByRole('button'));\n \n-    expect(screen.getByTestId('success')).toBeInTheDocument();\n+    await waitFor(async () => {\n+      expect(screen.getByTestId('success')).toBeInTheDocument();\n+    });\n   });\n \n   test('Wrong old password', async () => {\n-    setup();\n+    const user = setup();\n \n-    await act(async () => {\n-      fireEvent.change(screen.getByLabelText('Old password *'), {\n-        target: { value: 'watermelon' },\n-      });\n-      fireEvent.change(screen.getByLabelText('New password *'), {\n-        target: { value: 'purple' },\n-      });\n-      fireEvent.change(screen.getByLabelText('Confirm new password *'), {\n-        target: { value: 'purple' },\n-      });\n-    });\n+    await user.type(screen.getByLabelText('Old password *'), 'watermelon');\n+    await user.type(screen.getByLabelText('New password *'), 'purple');\n+    await user.type(screen.getByLabelText('Confirm new password *'), 'purple');\n \n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button'));\n-    });\n+    await user.click(screen.getByRole('button'));\n \n-    await act(async () => {\n-      await jest.runAllTimersAsync();\n+    await waitFor(async () => {\n+      expect(screen.getByText('Incorrect password')).toBeInTheDocument();\n     });\n-\n-    expect(screen.getByText('Incorrect password')).toBeInTheDocument();\n   });\n });\n\ndiff --git a/packages/app/src/CreateResourcePage.test.tsx b/packages/app/src/CreateResourcePage.test.tsx\nindex de4294bc30..8a9888e75b 100644\n--- a/packages/app/src/CreateResourcePage.test.tsx\n+++ b/packages/app/src/CreateResourcePage.test.tsx\n@@ -2,12 +2,14 @@ import { MockClient } from '@medplum/mock';\n import { MedplumProvider } from '@medplum/react';\n import { MemoryRouter } from 'react-router';\n import { AppRoutes } from './AppRoutes';\n-import { act, fireEvent, render, screen } from './test-utils/render';\n+import { act, userEvent, UserEvent, render, screen, fireEvent } from './test-utils/render';\n \n const medplum = new MockClient();\n \n describe('CreateResourcePage', () => {\n-  async function setup(url: string): Promise<void> {\n+  async function setup(url: string): Promise<UserEvent> {\n+    const user = userEvent.setup();\n+\n     await act(async () => {\n       render(\n         <MedplumProvider medplum={medplum}>\n@@ -17,6 +19,8 @@ describe('CreateResourcePage', () => {\n         </MedplumProvider>\n       );\n     });\n+\n+    return user;\n   }\n \n   function formViewTests(url: string): undefined {\n@@ -28,13 +32,11 @@ describe('CreateResourcePage', () => {\n     });\n \n     test('Form submit new Practitioner', async () => {\n-      await setup(url);\n+      const user = await setup(url);\n \n       const createButton = await screen.findByText('Create');\n       expect(createButton).toBeInTheDocument();\n-      await act(async () => {\n-        fireEvent.click(createButton);\n-      });\n+      await user.click(createButton);\n     });\n   }\n \n@@ -56,7 +58,7 @@ describe('CreateResourcePage', () => {\n     });\n \n     test('JSON submit new Practitioner', async () => {\n-      await setup('/Practitioner/new/json');\n+      const user = await setup('/Practitioner/new/json');\n       expect(await screen.findByTestId(JSON_INPUT_TEST_ID)).toBeInTheDocument();\n \n       await act(async () => {\n@@ -65,9 +67,7 @@ describe('CreateResourcePage', () => {\n         });\n       });\n \n-      await act(async () => {\n-        fireEvent.click(screen.getByText('OK'));\n-      });\n+      await user.click(screen.getByText('OK'));\n     });\n   });\n });\n\ndiff --git a/packages/app/src/MfaPage.test.tsx b/packages/app/src/MfaPage.test.tsx\nindex 9245d7635c..86c1b44023 100644\n--- a/packages/app/src/MfaPage.test.tsx\n+++ b/packages/app/src/MfaPage.test.tsx\n@@ -4,11 +4,12 @@ import { MockClient } from '@medplum/mock';\n import { MedplumProvider } from '@medplum/react';\n import { MemoryRouter } from 'react-router';\n import { AppRoutes } from './AppRoutes';\n-import { act, fireEvent, render, screen } from './test-utils/render';\n+import { act, userEvent, UserEvent, render, screen } from './test-utils/render';\n \n const medplum = new MockClient();\n \n-async function setup(): Promise<void> {\n+async function setup(): Promise<UserEvent> {\n+  const user = userEvent.setup();\n   await act(async () => {\n     render(\n       <MemoryRouter initialEntries={['/mfa']} initialIndex={0}>\n@@ -21,6 +22,8 @@ async function setup(): Promise<void> {\n       </MemoryRouter>\n     );\n   });\n+\n+  return user;\n }\n \n describe('MfaPage', () => {\n@@ -34,21 +37,18 @@ describe('MfaPage', () => {\n   });\n \n   test('Enroll', async () => {\n-    await setup();\n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button', { name: 'Enroll' }));\n-    });\n+    const user = await setup();\n+    await user.click(screen.getByRole('button', { name: 'Enroll' }));\n     expect(screen.getByText('MFA is enabled')).toBeInTheDocument();\n   });\n \n   test('Disable -- success', async () => {\n     const getSpy = jest.spyOn(medplum, 'get');\n-    await setup();\n+    const user = await setup();\n \n     // Enroll into MFA\n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button', { name: 'Enroll' }));\n-    });\n+    await user.click(screen.getByRole('button', { name: 'Enroll' }));\n+\n     expect(screen.getByText('MFA is enabled')).toBeInTheDocument();\n \n     // Clean notifications\n@@ -57,22 +57,16 @@ describe('MfaPage', () => {\n     });\n \n     // Open disable MFA modal\n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button', { name: 'Disable MFA' }));\n-    });\n+    await user.click(screen.getByRole('button', { name: 'Disable MFA' }));\n \n     // Wait for MFA code input to appear\n     await expect(screen.findByLabelText(/mfa code*/i)).resolves.toBeInTheDocument();\n \n     // Enter in a token value\n-    await act(async () => {\n-      fireEvent.change(screen.getByLabelText(/mfa code*/i), { target: { value: '1234567890' } });\n-    });\n+    await user.type(screen.getByLabelText(/mfa code*/i), '1234567890');\n \n     // Submit disable request\n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button', { name: 'Submit code' }));\n-    });\n+    await user.click(screen.getByRole('button', { name: 'Submit code' }));\n \n     // Check that the toast confirms that MFA was disabled\n     await expect(screen.findByText('MFA disabled')).resolves.toBeInTheDocument();\n@@ -84,12 +78,10 @@ describe('MfaPage', () => {\n \n   test('Disable -- failed', async () => {\n     const getSpy = jest.spyOn(medplum, 'get');\n-    await setup();\n+    const user = await setup();\n \n     // Enroll into MFA\n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button', { name: 'Enroll' }));\n-    });\n+    await user.click(screen.getByRole('button', { name: 'Enroll' }));\n     expect(screen.getByText('MFA is enabled')).toBeInTheDocument();\n \n     // Clean notifications\n@@ -98,25 +90,19 @@ describe('MfaPage', () => {\n     });\n \n     // Open disable MFA modal\n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button', { name: 'Disable MFA' }));\n-    });\n+    await user.click(screen.getByRole('button', { name: 'Disable MFA' }));\n \n     // Wait for MFA code input to appear\n     await expect(screen.findByLabelText(/mfa code*/i)).resolves.toBeInTheDocument();\n \n     // Enter in an INVALID_TOKEN value\n-    await act(async () => {\n-      fireEvent.change(screen.getByLabelText(/mfa code*/i), { target: { value: 'INVALID_TOKEN' } });\n-    });\n+    await user.type(screen.getByLabelText(/mfa code*/i), 'INVALID_TOKEN');\n \n     // Reset the mock before submitting code\n     getSpy.mockReset();\n \n     // Attempt to submit code without entering\n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button', { name: 'Submit code' }));\n-    });\n+    await user.click(screen.getByRole('button', { name: 'Submit code' }));\n \n     // Make sure invalid token came back\n     await expect(screen.findByText('Invalid token')).resolves.toBeInTheDocument();\n\ndiff --git a/packages/app/src/OAuthPage.test.tsx b/packages/app/src/OAuthPage.test.tsx\nindex d880da245f..919e75390a 100644\n--- a/packages/app/src/OAuthPage.test.tsx\n+++ b/packages/app/src/OAuthPage.test.tsx\n@@ -4,12 +4,13 @@ import crypto from 'crypto';\n import { MemoryRouter } from 'react-router';\n import { TextEncoder } from 'util';\n import { AppRoutes } from './AppRoutes';\n-import { act, fireEvent, render, screen, waitFor } from './test-utils/render';\n+import { act, userEvent, UserEvent, render, screen, waitFor } from './test-utils/render';\n \n const medplum = new MockClient();\n \n describe('OAuthPage', () => {\n-  async function setup(url: string): Promise<void> {\n+  async function setup(url: string): Promise<UserEvent> {\n+    const user = userEvent.setup();\n     await act(async () => {\n       render(\n         <MedplumProvider medplum={medplum}>\n@@ -19,6 +20,8 @@ describe('OAuthPage', () => {\n         </MedplumProvider>\n       );\n     });\n+\n+    return user;\n   }\n \n   beforeAll(() => {\n@@ -42,64 +45,40 @@ describe('OAuthPage', () => {\n       value: { assign: jest.fn() },\n     });\n \n-    await setup(\n+    const user = await setup(\n       '/oauth?client_id=123&redirect_uri=https://example.com/callback&scope=openid+profile&state=abc&nonce=xyz'\n     );\n \n-    await act(async () => {\n-      fireEvent.change(screen.getByLabelText('Email *'), {\n-        target: { value: 'admin@example.com' },\n-      });\n-    });\n+    await user.type(screen.getByLabelText('Email *'), 'admin@example.com');\n \n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button', { name: 'Next' }));\n-    });\n+    await user.click(screen.getByRole('button', { name: 'Next' }));\n \n-    await act(async () => {\n-      fireEvent.change(screen.getByLabelText('Password *'), {\n-        target: { value: 'password' },\n-      });\n-    });\n+    await user.type(screen.getByLabelText('Password *'), 'password');\n \n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button', { name: 'Sign in' }));\n-    });\n+    await user.click(screen.getByRole('button', { name: 'Sign in' }));\n \n     expect(await screen.findByText('Choose scope')).toBeInTheDocument();\n \n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button', { name: 'Set scope' }));\n-    });\n+    await user.click(screen.getByRole('button', { name: 'Set scope' }));\n \n     await waitFor(() => expect(window.location.assign).toHaveBeenCalled());\n     expect(window.location.assign).toHaveBeenCalled();\n   });\n \n   test('Forgot password', async () => {\n-    await setup('/oauth?client_id=123');\n+    const user = await setup('/oauth?client_id=123');\n \n-    await act(async () => {\n-      fireEvent.change(screen.getByLabelText('Email *'), {\n-        target: { value: 'admin@example.com' },\n-      });\n-    });\n+    await user.type(screen.getByLabelText('Email *'), 'admin@example.com');\n \n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button', { name: 'Next' }));\n-    });\n+    await user.click(screen.getByRole('button', { name: 'Next' }));\n \n-    await act(async () => {\n-      fireEvent.click(screen.getByText('Forgot password'));\n-    });\n+    await user.click(screen.getByText('Forgot password'));\n   });\n \n   test('Register', async () => {\n-    await setup('/oauth?client_id=123');\n+    const user = await setup('/oauth?client_id=123');\n \n-    await act(async () => {\n-      fireEvent.click(screen.getByText('Register'));\n-    });\n+    await user.click(screen.getByText('Register'));\n   });\n \n   test('Fetch and render client info', async () => {\n\ndiff --git a/packages/app/src/RegisterPage.test.tsx b/packages/app/src/RegisterPage.test.tsx\nindex 4773e84586..57c35f4a6c 100644\n--- a/packages/app/src/RegisterPage.test.tsx\n+++ b/packages/app/src/RegisterPage.test.tsx\n@@ -6,9 +6,10 @@ import { MemoryRouter } from 'react-router';\n import { TextEncoder } from 'util';\n import { AppRoutes } from './AppRoutes';\n import { getConfig } from './config';\n-import { act, fireEvent, render, screen } from './test-utils/render';\n+import { act, userEvent, UserEvent, render, screen } from './test-utils/render';\n \n-async function setup(medplum: MedplumClient): Promise<void> {\n+async function setup(medplum: MedplumClient): Promise<UserEvent> {\n+  const user = userEvent.setup();\n   await act(async () => {\n     render(\n       <MemoryRouter initialEntries={['/register']} initialIndex={0}>\n@@ -18,6 +19,8 @@ async function setup(medplum: MedplumClient): Promise<void> {\n       </MemoryRouter>\n     );\n   });\n+\n+  return user;\n }\n \n describe('RegisterPage', () => {\n@@ -52,7 +55,7 @@ describe('RegisterPage', () => {\n     const medplum = new MockClient();\n     medplum.getProfile = jest.fn(() => undefined) as any;\n     medplum.startNewUser = jest.fn(() => Promise.resolve({ login: '1' }));\n-    await setup(medplum);\n+    const user = await setup(medplum);\n \n     Object.defineProperty(global, 'grecaptcha', {\n       value: {\n@@ -65,32 +68,16 @@ describe('RegisterPage', () => {\n       },\n     });\n \n-    await act(async () => {\n-      fireEvent.change(screen.getByLabelText('First name *'), {\n-        target: { value: 'George' },\n-      });\n-      fireEvent.change(screen.getByLabelText('Last name *'), {\n-        target: { value: 'Washington' },\n-      });\n-      fireEvent.change(screen.getByLabelText('Email *'), {\n-        target: { value: 'george@example.com' },\n-      });\n-      fireEvent.change(screen.getByLabelText('Password *'), {\n-        target: { value: 'password' },\n-      });\n-    });\n+    await user.type(screen.getByLabelText('First name *'), 'George');\n+    await user.type(screen.getByLabelText('Last name *'), 'Washington');\n+    await user.type(screen.getByLabelText('Email *'), 'george@example.com');\n+    await user.type(screen.getByLabelText('Password *'), 'password');\n \n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button'));\n-    });\n+    await user.click(screen.getByRole('button'));\n \n-    fireEvent.change(screen.getByLabelText('Project Name *'), {\n-      target: { value: 'Test Project' },\n-    });\n+    await user.type(screen.getByLabelText('Project Name *'), 'Test Project');\n \n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button'));\n-    });\n+    await user.click(screen.getByRole('button'));\n   });\n \n   test('Register disabled', async () => {\n\ndiff --git a/packages/app/src/ResetPasswordPage.test.tsx b/packages/app/src/ResetPasswordPage.test.tsx\nindex cfcd281709..10eb6c7e43 100644\n--- a/packages/app/src/ResetPasswordPage.test.tsx\n+++ b/packages/app/src/ResetPasswordPage.test.tsx\n@@ -3,11 +3,12 @@ import { MedplumProvider } from '@medplum/react';\n import { MemoryRouter } from 'react-router';\n import { ResetPasswordPage } from './ResetPasswordPage';\n import { getConfig } from './config';\n-import { act, fireEvent, render, screen } from './test-utils/render';\n+import { userEvent, UserEvent, render, screen } from './test-utils/render';\n \n const medplum = new MockClient();\n \n-function setup(): void {\n+function setup(): UserEvent {\n+  const user = userEvent.setup();\n   render(\n     <MemoryRouter>\n       <MedplumProvider medplum={medplum}>\n@@ -15,6 +16,8 @@ function setup(): void {\n       </MedplumProvider>\n     </MemoryRouter>\n   );\n+\n+  return user;\n }\n \n describe('ResetPasswordPage', () => {\n@@ -49,34 +52,21 @@ describe('ResetPasswordPage', () => {\n \n   test('Submit success with recaptcha site key', async () => {\n     getConfig().recaptchaSiteKey = 'recaptchasitekey';\n-    setup();\n+    const user = setup();\n \n-    await act(async () => {\n-      fireEvent.change(screen.getByLabelText('Email *'), {\n-        target: { value: 'admin@example.com' },\n-      });\n-    });\n+    await user.type(screen.getByLabelText('Email *'), 'admin@example.com');\n+    await user.click(screen.getByRole('button', { name: 'Reset password' }));\n \n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button', { name: 'Reset password' }));\n-    });\n     expect(grecaptchaResolved).toHaveBeenCalled();\n     expect(screen.getByText('password reset email will be sent', { exact: false })).toBeInTheDocument();\n   });\n \n   test('Submit success without recaptcha site key', async () => {\n     getConfig().recaptchaSiteKey = '';\n-    setup();\n-\n-    await act(async () => {\n-      fireEvent.change(screen.getByLabelText('Email *'), {\n-        target: { value: 'admin@example.com' },\n-      });\n-    });\n+    const user = setup();\n \n-    await act(async () => {\n-      fireEvent.click(screen.getByRole('button', { name: 'Reset password' }));\n-    });\n+    await user.type(screen.getByLabelText('Email *'), 'admin@example.com');\n+    await user.click(screen.getByRole('button', { name: 'Reset password' }));\n     expect(grecaptchaResolved).not.toHaveBeenCalled();\n     expect(screen.getByText('password reset email will be sent', { exact: false })).toBeInTheDocument();\n   });\n\ndiff --git a/packages/app/src/test-utils/render.tsx b/packages/app/src/test-utils/render.tsx\nindex ef7ff9c3f4..0c684a81cc 100644\n--- a/packages/app/src/test-utils/render.tsx\n+++ b/packages/app/src/test-utils/render.tsx\n@@ -6,12 +6,12 @@ import { MantineProvider } from '@mantine/core';\n import { MedplumClient } from '@medplum/core';\n import { MedplumProvider } from '@medplum/react';\n import { act, fireEvent, RenderResult, screen, render as testingLibraryRender, waitFor } from '@testing-library/react';\n-import userEvent from '@testing-library/user-event';\n+import userEvent, { UserEvent } from '@testing-library/user-event';\n import { ReactNode } from 'react';\n import { createMemoryRouter, RouterProvider } from 'react-router';\n import { AppRoutes } from '../AppRoutes';\n \n-export { act, fireEvent, RenderResult, screen, userEvent, waitFor };\n+export { RenderResult, act, fireEvent, screen, userEvent, UserEvent, waitFor };\n \n const theme = {};\n \n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6095",
    "pr_id": 6095,
    "issue_id": 6048,
    "repo": "medplum/medplum",
    "problem_statement": "The header on the `PatientPage.tsx` of the Hello World tutorial doesn’t have dark mode.\n![Image](https://github.com/user-attachments/assets/d4c57b0f-835a-49c0-96ad-0af84a63e34a)",
    "issue_word_count": 28,
    "test_files_count": 1,
    "non_test_files_count": 21,
    "pr_changed_files": [
      "examples/medplum-chat-demo/src/components/PatientDetails.tsx",
      "examples/medplum-chat-demo/src/pages/PatientHeader.module.css",
      "examples/medplum-chat-demo/src/pages/PatientHeader.tsx",
      "examples/medplum-eligibility-demo/src/pages/PatientHeader.module.css",
      "examples/medplum-eligibility-demo/src/pages/PatientHeader.tsx",
      "examples/medplum-hello-world/src/pages/PatientHeader.module.css",
      "examples/medplum-hello-world/src/pages/PatientHeader.tsx",
      "examples/medplum-hello-world/src/pages/PatientPage.tsx",
      "examples/medplum-photon-integration/src/pages/PatientHeader.module.css",
      "examples/medplum-photon-integration/src/pages/PatientHeader.tsx",
      "examples/medplum-photon-integration/src/pages/PatientPage.tsx",
      "packages/app/src/FormPage.tsx",
      "packages/app/src/admin/ProjectPage.tsx",
      "packages/app/src/components/ResourceHeader.tsx",
      "packages/app/src/components/SpecimenHeader.tsx",
      "packages/app/src/resource/ResourcePage.tsx",
      "packages/react/src/InfoBar/InfoBar.module.css",
      "packages/react/src/InfoBar/InfoBar.tsx",
      "packages/react/src/PatientHeader/PatientHeader.test.tsx",
      "packages/react/src/PatientHeader/PatientHeader.tsx",
      "packages/react/src/PatientHeader/PatientHeader.utils.ts",
      "packages/react/src/index.ts"
    ],
    "pr_changed_test_files": [
      "packages/react/src/PatientHeader/PatientHeader.test.tsx"
    ],
    "base_commit": "a7b3364bc217740aefdd6793751eef18fe6545a3",
    "head_commit": "545c8317d36bffbb3ce80fb8155aa916286ef658",
    "repo_url": "https://github.com/medplum/medplum/pull/6095",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6095",
    "dockerfile": "",
    "pr_merged_at": "2025-03-03T01:38:34.000Z",
    "patch": "diff --git a/examples/medplum-chat-demo/src/components/PatientDetails.tsx b/examples/medplum-chat-demo/src/components/PatientDetails.tsx\nindex 72b9863f87..f29fbb5505 100644\n--- a/examples/medplum-chat-demo/src/components/PatientDetails.tsx\n+++ b/examples/medplum-chat-demo/src/components/PatientDetails.tsx\n@@ -4,6 +4,7 @@ import { getReferenceString, normalizeErrorString, Operator, SearchRequest, With\n import { Patient, Practitioner, Resource } from '@medplum/fhirtypes';\n import {\n   Document,\n+  PatientHeader,\n   ResourceForm,\n   ResourceHistoryTable,\n   ResourceTable,\n@@ -14,7 +15,6 @@ import {\n } from '@medplum/react';\n import { IconCircleCheck, IconCircleOff } from '@tabler/icons-react';\n import { useNavigate, useParams } from 'react-router-dom';\n-import { PatientHeader } from '../pages/PatientHeader';\n import { cleanResource } from '../utils';\n \n interface PatientDetailsProps {\n\ndiff --git a/examples/medplum-chat-demo/src/pages/PatientHeader.module.css b/examples/medplum-chat-demo/src/pages/PatientHeader.module.css\ndeleted file mode 100644\nindex 71fbb95a41..0000000000\n--- a/examples/medplum-chat-demo/src/pages/PatientHeader.module.css\n+++ /dev/null\n@@ -1,26 +0,0 @@\n-.root {\n-  display: flex;\n-  flex-direction: row;\n-  align-items: center;\n-  padding: 8px 10px;\n-  background: var(--mantine-color-white);\n-\n-  & dl {\n-    display: inline-block;\n-    margin: 5px 20px 5px 5px;\n-  }\n-\n-  & dt {\n-    color: var(--mantine-color-gray-6);\n-    text-transform: uppercase;\n-    font-size: var(--mantine-font-size-xs);\n-    white-space: nowrap;\n-  }\n-\n-  & dd {\n-    font-size: var(--mantine-font-size-md);\n-    font-weight: 600;\n-    margin-left: 0;\n-    white-space: nowrap;\n-  }\n-}\n\ndiff --git a/examples/medplum-chat-demo/src/pages/PatientHeader.tsx b/examples/medplum-chat-demo/src/pages/PatientHeader.tsx\ndeleted file mode 100644\nindex c576995a97..0000000000\n--- a/examples/medplum-chat-demo/src/pages/PatientHeader.tsx\n+++ /dev/null\n@@ -1,60 +0,0 @@\n-import { calculateAgeString } from '@medplum/core';\n-import { Patient, Reference } from '@medplum/fhirtypes';\n-import { HumanNameDisplay, MedplumLink, ResourceAvatar, useResource } from '@medplum/react';\n-import classes from './PatientHeader.module.css';\n-\n-export interface PatientHeaderProps {\n-  readonly patient: Patient | Reference<Patient>;\n-}\n-\n-export function PatientHeader(props: PatientHeaderProps): JSX.Element | null {\n-  const patient = useResource(props.patient);\n-  if (!patient) {\n-    return null;\n-  }\n-  return (\n-    <div className={classes.root}>\n-      <ResourceAvatar value={patient} size=\"lg\" radius=\"xl\" mr=\"lg\" />\n-      <dl>\n-        <dt>Name</dt>\n-        <dd>\n-          <MedplumLink to={patient}>\n-            {patient.name ? <HumanNameDisplay value={patient.name?.[0]} options={{ use: false }} /> : '[blank]'}\n-          </MedplumLink>\n-        </dd>\n-      </dl>\n-      {patient.birthDate && (\n-        <>\n-          <dl>\n-            <dt>DoB</dt>\n-            <dd>{patient.birthDate}</dd>\n-          </dl>\n-          <dl>\n-            <dt>Age</dt>\n-            <dd>{calculateAgeString(patient.birthDate)}</dd>\n-          </dl>\n-        </>\n-      )}\n-      {patient.gender && (\n-        <dl>\n-          <dt>Gender</dt>\n-          <dd>{patient.gender}</dd>\n-        </dl>\n-      )}\n-      {patient.address && (\n-        <>\n-          <dl>\n-            <dt>State</dt>\n-            <dd>{patient.address?.[0]?.state}</dd>\n-          </dl>\n-        </>\n-      )}\n-      {patient.identifier?.map((identifier, index) => (\n-        <dl key={`${index}-${patient.identifier?.length}`}>\n-          <dt>{identifier?.system}</dt>\n-          <dd>{identifier?.value}</dd>\n-        </dl>\n-      ))}\n-    </div>\n-  );\n-}\n\ndiff --git a/examples/medplum-eligibility-demo/src/pages/PatientHeader.module.css b/examples/medplum-eligibility-demo/src/pages/PatientHeader.module.css\ndeleted file mode 100644\nindex 71fbb95a41..0000000000\n--- a/examples/medplum-eligibility-demo/src/pages/PatientHeader.module.css\n+++ /dev/null\n@@ -1,26 +0,0 @@\n-.root {\n-  display: flex;\n-  flex-direction: row;\n-  align-items: center;\n-  padding: 8px 10px;\n-  background: var(--mantine-color-white);\n-\n-  & dl {\n-    display: inline-block;\n-    margin: 5px 20px 5px 5px;\n-  }\n-\n-  & dt {\n-    color: var(--mantine-color-gray-6);\n-    text-transform: uppercase;\n-    font-size: var(--mantine-font-size-xs);\n-    white-space: nowrap;\n-  }\n-\n-  & dd {\n-    font-size: var(--mantine-font-size-md);\n-    font-weight: 600;\n-    margin-left: 0;\n-    white-space: nowrap;\n-  }\n-}\n\ndiff --git a/examples/medplum-eligibility-demo/src/pages/PatientHeader.tsx b/examples/medplum-eligibility-demo/src/pages/PatientHeader.tsx\ndeleted file mode 100644\nindex c576995a97..0000000000\n--- a/examples/medplum-eligibility-demo/src/pages/PatientHeader.tsx\n+++ /dev/null\n@@ -1,60 +0,0 @@\n-import { calculateAgeString } from '@medplum/core';\n-import { Patient, Reference } from '@medplum/fhirtypes';\n-import { HumanNameDisplay, MedplumLink, ResourceAvatar, useResource } from '@medplum/react';\n-import classes from './PatientHeader.module.css';\n-\n-export interface PatientHeaderProps {\n-  readonly patient: Patient | Reference<Patient>;\n-}\n-\n-export function PatientHeader(props: PatientHeaderProps): JSX.Element | null {\n-  const patient = useResource(props.patient);\n-  if (!patient) {\n-    return null;\n-  }\n-  return (\n-    <div className={classes.root}>\n-      <ResourceAvatar value={patient} size=\"lg\" radius=\"xl\" mr=\"lg\" />\n-      <dl>\n-        <dt>Name</dt>\n-        <dd>\n-          <MedplumLink to={patient}>\n-            {patient.name ? <HumanNameDisplay value={patient.name?.[0]} options={{ use: false }} /> : '[blank]'}\n-          </MedplumLink>\n-        </dd>\n-      </dl>\n-      {patient.birthDate && (\n-        <>\n-          <dl>\n-            <dt>DoB</dt>\n-            <dd>{patient.birthDate}</dd>\n-          </dl>\n-          <dl>\n-            <dt>Age</dt>\n-            <dd>{calculateAgeString(patient.birthDate)}</dd>\n-          </dl>\n-        </>\n-      )}\n-      {patient.gender && (\n-        <dl>\n-          <dt>Gender</dt>\n-          <dd>{patient.gender}</dd>\n-        </dl>\n-      )}\n-      {patient.address && (\n-        <>\n-          <dl>\n-            <dt>State</dt>\n-            <dd>{patient.address?.[0]?.state}</dd>\n-          </dl>\n-        </>\n-      )}\n-      {patient.identifier?.map((identifier, index) => (\n-        <dl key={`${index}-${patient.identifier?.length}`}>\n-          <dt>{identifier?.system}</dt>\n-          <dd>{identifier?.value}</dd>\n-        </dl>\n-      ))}\n-    </div>\n-  );\n-}\n\ndiff --git a/examples/medplum-hello-world/src/pages/PatientHeader.module.css b/examples/medplum-hello-world/src/pages/PatientHeader.module.css\ndeleted file mode 100644\nindex 71fbb95a41..0000000000\n--- a/examples/medplum-hello-world/src/pages/PatientHeader.module.css\n+++ /dev/null\n@@ -1,26 +0,0 @@\n-.root {\n-  display: flex;\n-  flex-direction: row;\n-  align-items: center;\n-  padding: 8px 10px;\n-  background: var(--mantine-color-white);\n-\n-  & dl {\n-    display: inline-block;\n-    margin: 5px 20px 5px 5px;\n-  }\n-\n-  & dt {\n-    color: var(--mantine-color-gray-6);\n-    text-transform: uppercase;\n-    font-size: var(--mantine-font-size-xs);\n-    white-space: nowrap;\n-  }\n-\n-  & dd {\n-    font-size: var(--mantine-font-size-md);\n-    font-weight: 600;\n-    margin-left: 0;\n-    white-space: nowrap;\n-  }\n-}\n\ndiff --git a/examples/medplum-hello-world/src/pages/PatientHeader.tsx b/examples/medplum-hello-world/src/pages/PatientHeader.tsx\ndeleted file mode 100644\nindex c576995a97..0000000000\n--- a/examples/medplum-hello-world/src/pages/PatientHeader.tsx\n+++ /dev/null\n@@ -1,60 +0,0 @@\n-import { calculateAgeString } from '@medplum/core';\n-import { Patient, Reference } from '@medplum/fhirtypes';\n-import { HumanNameDisplay, MedplumLink, ResourceAvatar, useResource } from '@medplum/react';\n-import classes from './PatientHeader.module.css';\n-\n-export interface PatientHeaderProps {\n-  readonly patient: Patient | Reference<Patient>;\n-}\n-\n-export function PatientHeader(props: PatientHeaderProps): JSX.Element | null {\n-  const patient = useResource(props.patient);\n-  if (!patient) {\n-    return null;\n-  }\n-  return (\n-    <div className={classes.root}>\n-      <ResourceAvatar value={patient} size=\"lg\" radius=\"xl\" mr=\"lg\" />\n-      <dl>\n-        <dt>Name</dt>\n-        <dd>\n-          <MedplumLink to={patient}>\n-            {patient.name ? <HumanNameDisplay value={patient.name?.[0]} options={{ use: false }} /> : '[blank]'}\n-          </MedplumLink>\n-        </dd>\n-      </dl>\n-      {patient.birthDate && (\n-        <>\n-          <dl>\n-            <dt>DoB</dt>\n-            <dd>{patient.birthDate}</dd>\n-          </dl>\n-          <dl>\n-            <dt>Age</dt>\n-            <dd>{calculateAgeString(patient.birthDate)}</dd>\n-          </dl>\n-        </>\n-      )}\n-      {patient.gender && (\n-        <dl>\n-          <dt>Gender</dt>\n-          <dd>{patient.gender}</dd>\n-        </dl>\n-      )}\n-      {patient.address && (\n-        <>\n-          <dl>\n-            <dt>State</dt>\n-            <dd>{patient.address?.[0]?.state}</dd>\n-          </dl>\n-        </>\n-      )}\n-      {patient.identifier?.map((identifier, index) => (\n-        <dl key={`${index}-${patient.identifier?.length}`}>\n-          <dt>{identifier?.system}</dt>\n-          <dd>{identifier?.value}</dd>\n-        </dl>\n-      ))}\n-    </div>\n-  );\n-}\n\ndiff --git a/examples/medplum-hello-world/src/pages/PatientPage.tsx b/examples/medplum-hello-world/src/pages/PatientPage.tsx\nindex 307434c6cc..18dcb9fcfa 100644\n--- a/examples/medplum-hello-world/src/pages/PatientPage.tsx\n+++ b/examples/medplum-hello-world/src/pages/PatientPage.tsx\n@@ -1,10 +1,9 @@\n-import { Loader, Tabs } from '@mantine/core';\n+import { Loader, Paper, Tabs } from '@mantine/core';\n import { getReferenceString } from '@medplum/core';\n import { Patient } from '@medplum/fhirtypes';\n-import { useResource } from '@medplum/react';\n+import { PatientHeader, useResource } from '@medplum/react';\n import { Fragment } from 'react';\n import { Outlet, useNavigate, useParams } from 'react-router-dom';\n-import { PatientHeader } from './PatientHeader';\n \n export function PatientPage(): JSX.Element {\n   const navigate = useNavigate();\n@@ -16,14 +15,16 @@ export function PatientPage(): JSX.Element {\n \n   return (\n     <Fragment key={getReferenceString(patient)}>\n-      <PatientHeader patient={patient} />\n-      <Tabs onChange={(t) => navigate(`./${t}`)}>\n-        <Tabs.List bg=\"white\">\n-          <Tabs.Tab value=\"overview\">Overview</Tabs.Tab>\n-          <Tabs.Tab value=\"timeline\">Timeline</Tabs.Tab>\n-          <Tabs.Tab value=\"history\">History</Tabs.Tab>\n-        </Tabs.List>\n-      </Tabs>\n+      <Paper>\n+        <PatientHeader patient={patient} />\n+        <Tabs onChange={(t) => navigate(`./${t}`)}>\n+          <Tabs.List>\n+            <Tabs.Tab value=\"overview\">Overview</Tabs.Tab>\n+            <Tabs.Tab value=\"timeline\">Timeline</Tabs.Tab>\n+            <Tabs.Tab value=\"history\">History</Tabs.Tab>\n+          </Tabs.List>\n+        </Tabs>\n+      </Paper>\n       <Outlet />\n     </Fragment>\n   );\n\ndiff --git a/examples/medplum-photon-integration/src/pages/PatientHeader.module.css b/examples/medplum-photon-integration/src/pages/PatientHeader.module.css\ndeleted file mode 100644\nindex 71fbb95a41..0000000000\n--- a/examples/medplum-photon-integration/src/pages/PatientHeader.module.css\n+++ /dev/null\n@@ -1,26 +0,0 @@\n-.root {\n-  display: flex;\n-  flex-direction: row;\n-  align-items: center;\n-  padding: 8px 10px;\n-  background: var(--mantine-color-white);\n-\n-  & dl {\n-    display: inline-block;\n-    margin: 5px 20px 5px 5px;\n-  }\n-\n-  & dt {\n-    color: var(--mantine-color-gray-6);\n-    text-transform: uppercase;\n-    font-size: var(--mantine-font-size-xs);\n-    white-space: nowrap;\n-  }\n-\n-  & dd {\n-    font-size: var(--mantine-font-size-md);\n-    font-weight: 600;\n-    margin-left: 0;\n-    white-space: nowrap;\n-  }\n-}\n\ndiff --git a/examples/medplum-photon-integration/src/pages/PatientHeader.tsx b/examples/medplum-photon-integration/src/pages/PatientHeader.tsx\ndeleted file mode 100644\nindex c576995a97..0000000000\n--- a/examples/medplum-photon-integration/src/pages/PatientHeader.tsx\n+++ /dev/null\n@@ -1,60 +0,0 @@\n-import { calculateAgeString } from '@medplum/core';\n-import { Patient, Reference } from '@medplum/fhirtypes';\n-import { HumanNameDisplay, MedplumLink, ResourceAvatar, useResource } from '@medplum/react';\n-import classes from './PatientHeader.module.css';\n-\n-export interface PatientHeaderProps {\n-  readonly patient: Patient | Reference<Patient>;\n-}\n-\n-export function PatientHeader(props: PatientHeaderProps): JSX.Element | null {\n-  const patient = useResource(props.patient);\n-  if (!patient) {\n-    return null;\n-  }\n-  return (\n-    <div className={classes.root}>\n-      <ResourceAvatar value={patient} size=\"lg\" radius=\"xl\" mr=\"lg\" />\n-      <dl>\n-        <dt>Name</dt>\n-        <dd>\n-          <MedplumLink to={patient}>\n-            {patient.name ? <HumanNameDisplay value={patient.name?.[0]} options={{ use: false }} /> : '[blank]'}\n-          </MedplumLink>\n-        </dd>\n-      </dl>\n-      {patient.birthDate && (\n-        <>\n-          <dl>\n-            <dt>DoB</dt>\n-            <dd>{patient.birthDate}</dd>\n-          </dl>\n-          <dl>\n-            <dt>Age</dt>\n-            <dd>{calculateAgeString(patient.birthDate)}</dd>\n-          </dl>\n-        </>\n-      )}\n-      {patient.gender && (\n-        <dl>\n-          <dt>Gender</dt>\n-          <dd>{patient.gender}</dd>\n-        </dl>\n-      )}\n-      {patient.address && (\n-        <>\n-          <dl>\n-            <dt>State</dt>\n-            <dd>{patient.address?.[0]?.state}</dd>\n-          </dl>\n-        </>\n-      )}\n-      {patient.identifier?.map((identifier, index) => (\n-        <dl key={`${index}-${patient.identifier?.length}`}>\n-          <dt>{identifier?.system}</dt>\n-          <dd>{identifier?.value}</dd>\n-        </dl>\n-      ))}\n-    </div>\n-  );\n-}\n\ndiff --git a/examples/medplum-photon-integration/src/pages/PatientPage.tsx b/examples/medplum-photon-integration/src/pages/PatientPage.tsx\nindex 9a365bf64e..226134bcda 100644\n--- a/examples/medplum-photon-integration/src/pages/PatientPage.tsx\n+++ b/examples/medplum-photon-integration/src/pages/PatientPage.tsx\n@@ -1,7 +1,7 @@\n import { Loader, Tabs } from '@mantine/core';\n import { capitalize, getReferenceString } from '@medplum/core';\n import { Patient } from '@medplum/fhirtypes';\n-import { Document, useMedplum } from '@medplum/react';\n+import { Document, PatientHeader, useMedplum } from '@medplum/react';\n import { useEffect, useState } from 'react';\n import { useNavigate, useParams } from 'react-router-dom';\n import { HeadlessPrescription } from '../components/headless-prescription/HeadlessPrescription';\n@@ -9,7 +9,6 @@ import { PatientHistory } from '../components/PatientHistory';\n import { PatientOverview } from '../components/PatientOverview';\n import { PatientPrescription } from '../components/PatientPrescription';\n import { Timeline } from '../components/Timeline';\n-import { PatientHeader } from './PatientHeader';\n \n export function PatientPage(): JSX.Element {\n   const navigate = useNavigate();\n\ndiff --git a/packages/app/src/FormPage.tsx b/packages/app/src/FormPage.tsx\nindex dfee79315e..32f4e98e0e 100644\n--- a/packages/app/src/FormPage.tsx\n+++ b/packages/app/src/FormPage.tsx\n@@ -1,10 +1,9 @@\n import { Box, Paper, Text, Title } from '@mantine/core';\n import { createReference, getDisplayString, getReferenceString } from '@medplum/core';\n import { Bundle, OperationOutcome, Questionnaire, QuestionnaireResponse, Resource } from '@medplum/fhirtypes';\n-import { Document, Loading, MedplumLink, QuestionnaireForm, useMedplum } from '@medplum/react';\n+import { Document, Loading, MedplumLink, PatientHeader, QuestionnaireForm, useMedplum } from '@medplum/react';\n import { useEffect, useState } from 'react';\n import { useLocation, useParams } from 'react-router-dom';\n-import { PatientHeader } from './components/PatientHeader';\n import { ResourceHeader } from './components/ResourceHeader';\n import { getPatient } from './utils';\n \n\ndiff --git a/packages/app/src/admin/ProjectPage.tsx b/packages/app/src/admin/ProjectPage.tsx\nindex ca8162df8a..41dc0c3a25 100644\n--- a/packages/app/src/admin/ProjectPage.tsx\n+++ b/packages/app/src/admin/ProjectPage.tsx\n@@ -1,8 +1,7 @@\n import { Paper, ScrollArea, Tabs } from '@mantine/core';\n-import { Document, useMedplum } from '@medplum/react';\n+import { Document, InfoBar, useMedplum } from '@medplum/react';\n import { useMemo } from 'react';\n import { Outlet, useLocation, useNavigate } from 'react-router-dom';\n-import { InfoBar } from '../components/InfoBar';\n import { getProjectId } from '../utils';\n \n const tabs = ['Details', 'Users', 'Patients', 'Clients', 'Bots', 'Secrets', 'Sites'];\n\ndiff --git a/packages/app/src/components/ResourceHeader.tsx b/packages/app/src/components/ResourceHeader.tsx\nindex c8465495ed..92199fb59a 100644\n--- a/packages/app/src/components/ResourceHeader.tsx\n+++ b/packages/app/src/components/ResourceHeader.tsx\n@@ -1,8 +1,7 @@\n import { getDisplayString, getReferenceString } from '@medplum/core';\n import { CodeableConcept, Identifier, Reference, Resource } from '@medplum/fhirtypes';\n-import { MedplumLink, useResource } from '@medplum/react';\n+import { InfoBar, MedplumLink, useResource } from '@medplum/react';\n import { ReactNode } from 'react';\n-import { InfoBar } from './InfoBar';\n \n export interface ResourceHeaderProps {\n   readonly resource: Resource | Reference;\n\ndiff --git a/packages/app/src/components/SpecimenHeader.tsx b/packages/app/src/components/SpecimenHeader.tsx\nindex 8c7c3f7b94..3988c4f827 100644\n--- a/packages/app/src/components/SpecimenHeader.tsx\n+++ b/packages/app/src/components/SpecimenHeader.tsx\n@@ -1,7 +1,6 @@\n import { formatDateTime } from '@medplum/core';\n import { Reference, Specimen } from '@medplum/fhirtypes';\n-import { useResource } from '@medplum/react';\n-import { InfoBar } from './InfoBar';\n+import { InfoBar, useResource } from '@medplum/react';\n \n export interface SpecimenHeaderProps {\n   readonly specimen: Specimen | Reference<Specimen>;\n\ndiff --git a/packages/app/src/resource/ResourcePage.tsx b/packages/app/src/resource/ResourcePage.tsx\nindex 4f57ef5113..841bdcd1ef 100644\n--- a/packages/app/src/resource/ResourcePage.tsx\n+++ b/packages/app/src/resource/ResourcePage.tsx\n@@ -2,10 +2,9 @@ import { Button, Paper, ScrollArea, Tabs, Title } from '@mantine/core';\n import { showNotification } from '@mantine/notifications';\n import { getReferenceString, isGone, normalizeErrorString } from '@medplum/core';\n import { OperationOutcome, Resource, ResourceType, ServiceRequest } from '@medplum/fhirtypes';\n-import { Document, OperationOutcomeAlert, useMedplum, useResource } from '@medplum/react';\n+import { Document, OperationOutcomeAlert, PatientHeader, useMedplum, useResource } from '@medplum/react';\n import { useState } from 'react';\n import { Outlet, useNavigate, useParams } from 'react-router-dom';\n-import { PatientHeader } from '../components/PatientHeader';\n import { QuickServiceRequests } from '../components/QuickServiceRequests';\n import { QuickStatus } from '../components/QuickStatus';\n import { ResourceHeader } from '../components/ResourceHeader';\n\ndiff --git a/packages/app/src/components/InfoBar.module.css b/packages/react/src/InfoBar/InfoBar.module.css\nsimilarity index 100%\nrename from packages/app/src/components/InfoBar.module.css\nrename to packages/react/src/InfoBar/InfoBar.module.css\n\ndiff --git a/packages/app/src/components/InfoBar.tsx b/packages/react/src/InfoBar/InfoBar.tsx\nsimilarity index 100%\nrename from packages/app/src/components/InfoBar.tsx\nrename to packages/react/src/InfoBar/InfoBar.tsx\n\ndiff --git a/packages/app/src/components/PatientHeader.tsx b/packages/react/src/PatientHeader/PatientHeader.tsx\nsimilarity index 86%\nrename from packages/app/src/components/PatientHeader.tsx\nrename to packages/react/src/PatientHeader/PatientHeader.tsx\nindex de0ff8dbe1..3bcbb7d71e 100644\n--- a/packages/app/src/components/PatientHeader.tsx\n+++ b/packages/react/src/PatientHeader/PatientHeader.tsx\n@@ -1,7 +1,10 @@\n import { calculateAgeString } from '@medplum/core';\n import { Patient, Reference } from '@medplum/fhirtypes';\n-import { HumanNameDisplay, MedplumLink, ResourceAvatar, useResource } from '@medplum/react';\n-import { InfoBar } from './InfoBar';\n+import { useResource } from '@medplum/react-hooks';\n+import { HumanNameDisplay } from '../HumanNameDisplay/HumanNameDisplay';\n+import { InfoBar } from '../InfoBar/InfoBar';\n+import { MedplumLink } from '../MedplumLink/MedplumLink';\n+import { ResourceAvatar } from '../ResourceAvatar/ResourceAvatar';\n import { getDefaultColor } from './PatientHeader.utils';\n \n export interface PatientHeaderProps {\n\ndiff --git a/packages/app/src/components/PatientHeader.utils.ts b/packages/react/src/PatientHeader/PatientHeader.utils.ts\nsimilarity index 100%\nrename from packages/app/src/components/PatientHeader.utils.ts\nrename to packages/react/src/PatientHeader/PatientHeader.utils.ts\n\ndiff --git a/packages/react/src/index.ts b/packages/react/src/index.ts\nindex 5a3536d980..8e5e97197d 100644\n--- a/packages/react/src/index.ts\n+++ b/packages/react/src/index.ts\n@@ -49,6 +49,7 @@ export * from './HumanNameDisplay/HumanNameDisplay';\n export * from './HumanNameInput/HumanNameInput';\n export * from './IdentifierDisplay/IdentifierDisplay';\n export * from './IdentifierInput/IdentifierInput';\n+export * from './InfoBar/InfoBar';\n export * from './Loading/Loading';\n export * from './Logo/Logo';\n export * from './MeasureReportDisplay/MeasureReportDisplay';\n@@ -60,6 +61,7 @@ export * from './NotificationIcon/NotificationIcon';\n export * from './OperationOutcomeAlert/OperationOutcomeAlert';\n export * from './Panel/Panel';\n export * from './PatientExportForm/PatientExportForm';\n+export * from './PatientHeader/PatientHeader';\n export * from './PatientSummary/PatientSummary';\n export * from './PatientTimeline/PatientTimeline';\n export * from './PlanDefinitionBuilder/PlanDefinitionBuilder';\n",
    "test_patch": "diff --git a/packages/app/src/components/PatientHeader.test.tsx b/packages/react/src/PatientHeader/PatientHeader.test.tsx\nsimilarity index 98%\nrename from packages/app/src/components/PatientHeader.test.tsx\nrename to packages/react/src/PatientHeader/PatientHeader.test.tsx\nindex fc0e00b46f..b53aaec485 100644\n--- a/packages/app/src/components/PatientHeader.test.tsx\n+++ b/packages/react/src/PatientHeader/PatientHeader.test.tsx\n@@ -1,6 +1,6 @@\n import { Identifier, Patient } from '@medplum/fhirtypes';\n import { MockClient } from '@medplum/mock';\n-import { MedplumProvider } from '@medplum/react';\n+import { MedplumProvider } from '@medplum/react-hooks';\n import { MemoryRouter } from 'react-router-dom';\n import { render, screen } from '../test-utils/render';\n import { PatientHeader } from './PatientHeader';\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6086",
    "pr_id": 6086,
    "issue_id": 6020,
    "repo": "medplum/medplum",
    "problem_statement": "Create an alternative version of the demo bot cms-1500 that outputs a PDF\n## Description\nWe'd like to have a version of the current demo billing bot for the Health Insurance Claim Form **cms-1500** ([source here](https://github.com/medplum/medplum/blob/main/examples/medplum-demo-bots/src/billing-bots/cms-1500.ts)) that outputs a PDF instead of a CSV. The new bot should be created in the same folder as the existing one.\n\n\n## Resources\n- [Medplum bots - Creating a PDF](https://www.medplum.com/docs/bots/creating-a-pdf)\n- [CMS-1500 template](https://www.cigna.com/static/www-cigna-com/docs/form-cms1500.pdf) - correct version, as pointed out in the comments [here](https://github.com/medplum/medplum/issues/6020#issuecomment-2676964817)\n- https://www.medplum.com/docs/billing/patient-insurance\n",
    "issue_word_count": 133,
    "test_files_count": 1,
    "non_test_files_count": 2,
    "pr_changed_files": [
      "examples/medplum-demo-bots/medplum.config.json",
      "examples/medplum-demo-bots/src/billing-bots/cms-1500-pdf.test.ts",
      "examples/medplum-demo-bots/src/billing-bots/cms-1500-pdf.ts"
    ],
    "pr_changed_test_files": [
      "examples/medplum-demo-bots/src/billing-bots/cms-1500-pdf.test.ts"
    ],
    "base_commit": "605bc980de22ce38f757b2a66ee703a58eec2d34",
    "head_commit": "da033299bd49145cb57dfdf94c93d2186ec27ecc",
    "repo_url": "https://github.com/medplum/medplum/pull/6086",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6086",
    "dockerfile": "",
    "pr_merged_at": "2025-03-12T19:53:49.000Z",
    "patch": "diff --git a/examples/medplum-demo-bots/medplum.config.json b/examples/medplum-demo-bots/medplum.config.json\nindex 0d36e8ad33..ca8fec3866 100644\n--- a/examples/medplum-demo-bots/medplum.config.json\n+++ b/examples/medplum-demo-bots/medplum.config.json\n@@ -89,6 +89,12 @@\n       \"id\": \"\",\n       \"source\": \"./src/slack-bots/demo-slack-bot.ts\",\n       \"dist\": \"./dist/slack-bots/demo-slack-bot.js\"\n+    },\n+    {\n+      \"name\": \"cms-1500-pdf\",\n+      \"id\": \"01952918-8019-770a-8cb4-3c50fad9eb62\",\n+      \"source\": \"src/billing-bots/cms-1500-pdf.ts\",\n+      \"dist\": \"dist/billing-bots/cms-1500-pdf.js\"\n     }\n   ]\n }\n\ndiff --git a/examples/medplum-demo-bots/src/billing-bots/cms-1500-pdf.ts b/examples/medplum-demo-bots/src/billing-bots/cms-1500-pdf.ts\nnew file mode 100644\nindex 0000000000..578f7167f5\n--- /dev/null\n+++ b/examples/medplum-demo-bots/src/billing-bots/cms-1500-pdf.ts\n@@ -0,0 +1,2252 @@\n+import { BotEvent, formatAddress, formatDate, formatHumanName, getDateProperty, MedplumClient } from '@medplum/core';\n+import { Claim, Coverage, Media, Patient, RelatedPerson } from '@medplum/fhirtypes';\n+import { Content, TDocumentDefinitions } from 'pdfmake/interfaces';\n+\n+// Move this to a separate file and use it as a param to the bot\n+export const CSM_1500_PDF_BASE_64_BG =\n+  'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA1IAAARMCAMAAACkg1JQAAAC+lBMVEX//////v735Or25Or+/f3++/z+//7//f3//Pz9+/r25On++fn63d386uvoIyv87u798fH74OD99PTymJr0trf74eLxkJL97/D9+Pj0u7z74+T2v8D4zc799vX89vj4yMn50tPylZf14efviIzoJi3zra7739/ykpXzoaL0sbL1uLn79Pb1ubryj5H51tfyk5X2wMH619j2vb7zr7D87O386en85eb75OX24ujzqqz3xMX51dX3y8z85+b629zzp6n3wsP9/PzynaD+9vfudXn50dHzqav88/P1urvym5774uP73t7yo6T98vLwio787OvztLXykZT3xsfqQ0j3x8j85+joLzT57fH4ysv3w8T36e7vl53zn6H23eP509T4zs/++Pj62Nn62tv1rrD62drxl5nympz1r7H0o6X5z9D0oqT56u/xjZD1s7TypKb2u7z0srP1rK70pqjrWFvsa2710Nb1tLbvhIj1q63ypqfrXWH2tbfzmZvwhon0paf1sbP3t7nwgoXxsbbucnXub3LvfH/sZ2rwgIPwkpT0ytDzm53ua2/23+XzkJPvfoHven30nZ/wlZf68fP7+/vxiIv3v8DwjZD4wMLxjI7nLDLoNDrd3d30ztT12d/13OPvoqfk4+Pvd3sjHyD3ubvvm6HpR0vw7+/oOT70i4//+/rwpqzrVFdbWVroKjDwoKX0x830xcr5ycr87u3q6ur49/jsYGTpQUXxio3pPULnMTbzlZjvj5RDQUHsZGc7Ojr1qatTUVHys7nxqrDqUFTqTFE2MzTzlJfQ0NBlZGT5xsfqSk786ej1p6l5eHgwLS4rKCn11Nr09PT5y8xubW1LSUrCwcLX1tbvlJmIMzPtHSXzwcaEHh4FBQXJycmCgIHyvMHyt7zs4OCzs7Pz6urezs6qqqrm19e8u7uMi4vWwcEbGxvtKS/+8/O4lZWfX1+WTU3GqamgcXHQt7evhITken20UlOUlJSunJzLsrK8nJwgHx/Ap6fDoqLSc3UuhyZgAAJDmUlEQVR42uzBgQAAAACAoP2pF6kCAAAAAAAAAAAAAAAAAACYHTtGkRuGwjieB1rDkiYnSZva5EiBkDtsKQIhal5cPFK8JsilcdQMo2YYjM1AirlLJNu78ezs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';\n+\n+export async function handler(medplum: MedplumClient, _event: BotEvent<Claim>): Promise<Media> {\n+  const docDefinition = await getClaimPDFDocDefinition(medplum, _event.input);\n+\n+  const binary = await medplum.createPdf({\n+    docDefinition,\n+  });\n+\n+  const media = await medplum.createResource({\n+    resourceType: 'Media',\n+    status: 'completed',\n+    content: {\n+      contentType: 'application/pdf',\n+      url: 'Binary/' + binary.id,\n+      title: 'cms-1500.pdf',\n+    },\n+  });\n+\n+  return media;\n+}\n+\n+export async function getClaimPDFDocDefinition(medplum: MedplumClient, claim: Claim): Promise<TDocumentDefinitions> {\n+  const patient = await medplum.readReference(claim.patient);\n+  const coverage = await medplum.readReference(claim.insurance[0].coverage);\n+  const insured = coverage.subscriber ? await medplum.readReference(coverage.subscriber) : undefined;\n+\n+  const { patientName, patientSex } = getPatientInfo(patient);\n+  const patientDOB = getDateProperty(patient.birthDate);\n+  const { insuranceType, insuredIdNumber } = getCoverageInfo(coverage);\n+  const { insuredName } = getInsuredInfo(insured);\n+\n+  // Think of a way to parametrize each field coordinates in the PDF so we can use it with other templates\n+  const docDefinition = {\n+    // pageSize: 'LETTER',\n+    // pageMargins: [0, 0, 0, 0],\n+    content: [\n+      {\n+        image: CSM_1500_PDF_BASE_64_BG,\n+        absolutePosition: { x: 0, y: 0 },\n+        width: 612,\n+        height: 792,\n+      },\n+      ...getInsuranceProgramContent(insuranceType),\n+      {\n+        text: insuredIdNumber,\n+        absolutePosition: {\n+          x: 374,\n+          y: 108,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: patientName,\n+        absolutePosition: {\n+          x: 22,\n+          y: 131,\n+        },\n+        fontSize: 9,\n+      },\n+      ...getPatientDOBContent(patientDOB),\n+      ...getPatientSexContent(patientSex),\n+      {\n+        text: insuredName,\n+        absolutePosition: {\n+          x: 374,\n+          y: 131,\n+        },\n+        fontSize: 9,\n+      },\n+      ...getPatientAddressContent(patient),\n+      ...getPatientPhoneContent(patient),\n+      {\n+        text: 'X1',\n+        absolutePosition: {\n+          x: 317,\n+          y: 156,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X2',\n+        absolutePosition: {\n+          x: 252,\n+          y: 156,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X3',\n+        absolutePosition: {\n+          x: 289,\n+          y: 156,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X4',\n+        absolutePosition: {\n+          x: 353,\n+          y: 156,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X5',\n+        absolutePosition: {\n+          x: 374,\n+          y: 156,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X6',\n+        absolutePosition: {\n+          x: 229,\n+          y: 179,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X7',\n+        absolutePosition: {\n+          x: 375,\n+          y: 179,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X8',\n+        absolutePosition: {\n+          x: 545,\n+          y: 179,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X9',\n+        absolutePosition: {\n+          x: 375,\n+          y: 204,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X10',\n+        absolutePosition: {\n+          x: 482,\n+          y: 204,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X11',\n+        absolutePosition: {\n+          x: 511,\n+          y: 204,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X12',\n+        absolutePosition: {\n+          x: 22,\n+          y: 228,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X13',\n+        absolutePosition: {\n+          x: 375,\n+          y: 228,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X14',\n+        absolutePosition: {\n+          x: 22,\n+          y: 251,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X15',\n+        absolutePosition: {\n+          x: 267,\n+          y: 253,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X16',\n+        absolutePosition: {\n+          x: 310,\n+          y: 253,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X17',\n+        absolutePosition: {\n+          x: 504,\n+          y: 253,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X18',\n+        absolutePosition: {\n+          x: 555,\n+          y: 253,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X19',\n+        absolutePosition: {\n+          x: 395,\n+          y: 253,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X20',\n+        absolutePosition: {\n+          x: 418,\n+          y: 253,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X21',\n+        absolutePosition: {\n+          x: 439,\n+          y: 253,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X22',\n+        absolutePosition: {\n+          x: 22,\n+          y: 275,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X23',\n+        absolutePosition: {\n+          x: 267,\n+          y: 277,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X24',\n+        absolutePosition: {\n+          x: 267,\n+          y: 300,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X25',\n+        absolutePosition: {\n+          x: 310,\n+          y: 277,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X26',\n+        absolutePosition: {\n+          x: 310,\n+          y: 300,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X27',\n+        absolutePosition: {\n+          x: 343,\n+          y: 277,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X28',\n+        absolutePosition: {\n+          x: 375,\n+          y: 277,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X29',\n+        absolutePosition: {\n+          x: 393,\n+          y: 277,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X30',\n+        absolutePosition: {\n+          x: 22,\n+          y: 298,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X31',\n+        absolutePosition: {\n+          x: 375,\n+          y: 298,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X32',\n+        absolutePosition: {\n+          x: 22,\n+          y: 324,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X33',\n+        absolutePosition: {\n+          x: 229,\n+          y: 324,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X34',\n+        absolutePosition: {\n+          x: 59,\n+          y: 370,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X35',\n+        absolutePosition: {\n+          x: 274,\n+          y: 370,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X36',\n+        absolutePosition: {\n+          x: 415,\n+          y: 370,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X37',\n+        absolutePosition: {\n+          x: 26,\n+          y: 396,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X38',\n+        absolutePosition: {\n+          x: 47,\n+          y: 396,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X39',\n+        absolutePosition: {\n+          x: 68,\n+          y: 396,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X40',\n+        absolutePosition: {\n+          x: 130,\n+          y: 396,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X41',\n+        absolutePosition: {\n+          x: 234,\n+          y: 396,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X42',\n+        absolutePosition: {\n+          x: 279,\n+          y: 396,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X43',\n+        absolutePosition: {\n+          x: 300,\n+          y: 396,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X44',\n+        absolutePosition: {\n+          x: 322,\n+          y: 396,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X45',\n+        absolutePosition: {\n+          x: 398,\n+          y: 396,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X46',\n+        absolutePosition: {\n+          x: 420,\n+          y: 396,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X47',\n+        absolutePosition: {\n+          x: 444,\n+          y: 396,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X48',\n+        absolutePosition: {\n+          x: 501,\n+          y: 396,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X49',\n+        absolutePosition: {\n+          x: 523,\n+          y: 396,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X50',\n+        absolutePosition: {\n+          x: 543,\n+          y: 396,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X51',\n+        absolutePosition: {\n+          x: 225,\n+          y: 409,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X52',\n+        absolutePosition: {\n+          x: 246,\n+          y: 408,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X53',\n+        absolutePosition: {\n+          x: 21,\n+          y: 417,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X54',\n+        absolutePosition: {\n+          x: 42,\n+          y: 417,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X55',\n+        absolutePosition: {\n+          x: 247,\n+          y: 420,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X56',\n+        absolutePosition: {\n+          x: 398,\n+          y: 420,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X57',\n+        absolutePosition: {\n+          x: 420,\n+          y: 420,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X58',\n+        absolutePosition: {\n+          x: 444,\n+          y: 420,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X59',\n+        absolutePosition: {\n+          x: 501,\n+          y: 420,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X60',\n+        absolutePosition: {\n+          x: 523,\n+          y: 420,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X61',\n+        absolutePosition: {\n+          x: 543,\n+          y: 420,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X62',\n+        absolutePosition: {\n+          x: 21,\n+          y: 440,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X63',\n+        absolutePosition: {\n+          x: 386,\n+          y: 324,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X64',\n+        absolutePosition: {\n+          x: 387,\n+          y: 444,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X65',\n+        absolutePosition: {\n+          x: 422,\n+          y: 324,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X66',\n+        absolutePosition: {\n+          x: 423,\n+          y: 444,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X67',\n+        absolutePosition: {\n+          x: 472,\n+          y: 440,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X68',\n+        absolutePosition: {\n+          x: 315,\n+          y: 457,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X69',\n+        absolutePosition: {\n+          x: 33,\n+          y: 467,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X70',\n+        absolutePosition: {\n+          x: 126,\n+          y: 468,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X71',\n+        absolutePosition: {\n+          x: 221,\n+          y: 467,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X72',\n+        absolutePosition: {\n+          x: 315,\n+          y: 469,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X73',\n+        absolutePosition: {\n+          x: 401,\n+          y: 469,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X74',\n+        absolutePosition: {\n+          x: 457,\n+          y: 469,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X75',\n+        absolutePosition: {\n+          x: 33,\n+          y: 479,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X76',\n+        absolutePosition: {\n+          x: 127,\n+          y: 480,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X77',\n+        absolutePosition: {\n+          x: 221,\n+          y: 479,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X78',\n+        absolutePosition: {\n+          x: 315,\n+          y: 480,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X79',\n+        absolutePosition: {\n+          x: 33,\n+          y: 491,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X80',\n+        absolutePosition: {\n+          x: 127,\n+          y: 491,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X81',\n+        absolutePosition: {\n+          x: 221,\n+          y: 491,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X82',\n+        absolutePosition: {\n+          x: 315,\n+          y: 491,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X83',\n+        absolutePosition: {\n+          x: 374,\n+          y: 490,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X84',\n+        absolutePosition: {\n+          x: 20,\n+          y: 528,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X85',\n+        absolutePosition: {\n+          x: 478,\n+          y: 529,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X86',\n+        absolutePosition: {\n+          x: 504,\n+          y: 528,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X87',\n+        absolutePosition: {\n+          x: 20,\n+          y: 540,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X88',\n+        absolutePosition: {\n+          x: 39,\n+          y: 540,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X89',\n+        absolutePosition: {\n+          x: 61,\n+          y: 540,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X90',\n+        absolutePosition: {\n+          x: 83,\n+          y: 540,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X91',\n+        absolutePosition: {\n+          x: 104,\n+          y: 540,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X92',\n+        absolutePosition: {\n+          x: 127,\n+          y: 540,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X93',\n+        absolutePosition: {\n+          x: 148,\n+          y: 540,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X94',\n+        absolutePosition: {\n+          x: 172,\n+          y: 540,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X95',\n+        absolutePosition: {\n+          x: 194,\n+          y: 540,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X96',\n+        absolutePosition: {\n+          x: 246,\n+          y: 540,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X97',\n+        absolutePosition: {\n+          x: 271,\n+          y: 540,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X98',\n+        absolutePosition: {\n+          x: 291,\n+          y: 540,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X99',\n+        absolutePosition: {\n+          x: 313,\n+          y: 540,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X100',\n+        absolutePosition: {\n+          x: 335,\n+          y: 540,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X101',\n+        absolutePosition: {\n+          x: 373,\n+          y: 540,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X102',\n+        absolutePosition: {\n+          x: 415,\n+          y: 548,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X103',\n+        absolutePosition: {\n+          x: 437,\n+          y: 540,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X104',\n+        absolutePosition: {\n+          x: 466,\n+          y: 529,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X105',\n+        absolutePosition: {\n+          x: 504,\n+          y: 540,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X106',\n+        absolutePosition: {\n+          x: 20,\n+          y: 552,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X107',\n+        absolutePosition: {\n+          x: 478,\n+          y: 552,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X108',\n+        absolutePosition: {\n+          x: 504,\n+          y: 552,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X109',\n+        absolutePosition: {\n+          x: 20,\n+          y: 565,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X110',\n+        absolutePosition: {\n+          x: 39,\n+          y: 565,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X111',\n+        absolutePosition: {\n+          x: 61,\n+          y: 565,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X112',\n+        absolutePosition: {\n+          x: 83,\n+          y: 565,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X113',\n+        absolutePosition: {\n+          x: 104,\n+          y: 565,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X114',\n+        absolutePosition: {\n+          x: 127,\n+          y: 565,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X115',\n+        absolutePosition: {\n+          x: 148,\n+          y: 565,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X116',\n+        absolutePosition: {\n+          x: 172,\n+          y: 565,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X117',\n+        absolutePosition: {\n+          x: 194,\n+          y: 565,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X118',\n+        absolutePosition: {\n+          x: 246,\n+          y: 565,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X119',\n+        absolutePosition: {\n+          x: 271,\n+          y: 565,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X120',\n+        absolutePosition: {\n+          x: 291,\n+          y: 565,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X121',\n+        absolutePosition: {\n+          x: 313,\n+          y: 565,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X122',\n+        absolutePosition: {\n+          x: 335,\n+          y: 566,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X123',\n+        absolutePosition: {\n+          x: 373,\n+          y: 565,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X124',\n+        absolutePosition: {\n+          x: 415,\n+          y: 572,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X125',\n+        absolutePosition: {\n+          x: 437,\n+          y: 565,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X126',\n+        absolutePosition: {\n+          x: 466,\n+          y: 565,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X127',\n+        absolutePosition: {\n+          x: 504,\n+          y: 565,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X128',\n+        absolutePosition: {\n+          x: 20,\n+          y: 577,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X129',\n+        absolutePosition: {\n+          x: 478,\n+          y: 577,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X130',\n+        absolutePosition: {\n+          x: 504,\n+          y: 577,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X131',\n+        absolutePosition: {\n+          x: 20,\n+          y: 588,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X132',\n+        absolutePosition: {\n+          x: 39,\n+          y: 588,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X133',\n+        absolutePosition: {\n+          x: 61,\n+          y: 588,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X134',\n+        absolutePosition: {\n+          x: 83,\n+          y: 588,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X135',\n+        absolutePosition: {\n+          x: 104,\n+          y: 588,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X136',\n+        absolutePosition: {\n+          x: 127,\n+          y: 588,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X137',\n+        absolutePosition: {\n+          x: 148,\n+          y: 588,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X138',\n+        absolutePosition: {\n+          x: 172,\n+          y: 588,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X139',\n+        absolutePosition: {\n+          x: 194,\n+          y: 588,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X140',\n+        absolutePosition: {\n+          x: 246,\n+          y: 588,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X141',\n+        absolutePosition: {\n+          x: 271,\n+          y: 588,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X142',\n+        absolutePosition: {\n+          x: 291,\n+          y: 588,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X143',\n+        absolutePosition: {\n+          x: 313,\n+          y: 588,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X144',\n+        absolutePosition: {\n+          x: 335,\n+          y: 588,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X145',\n+        absolutePosition: {\n+          x: 373,\n+          y: 588,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X146',\n+        absolutePosition: {\n+          x: 415,\n+          y: 596,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X147',\n+        absolutePosition: {\n+          x: 437,\n+          y: 588,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X148',\n+        absolutePosition: {\n+          x: 466,\n+          y: 588,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X149',\n+        absolutePosition: {\n+          x: 504,\n+          y: 588,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X150',\n+        absolutePosition: {\n+          x: 20,\n+          y: 601,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X151',\n+        absolutePosition: {\n+          x: 478,\n+          y: 601,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X152',\n+        absolutePosition: {\n+          x: 504,\n+          y: 601,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X153',\n+        absolutePosition: {\n+          x: 20,\n+          y: 613,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X154',\n+        absolutePosition: {\n+          x: 39,\n+          y: 613,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X155',\n+        absolutePosition: {\n+          x: 61,\n+          y: 613,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X156',\n+        absolutePosition: {\n+          x: 83,\n+          y: 613,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X157',\n+        absolutePosition: {\n+          x: 104,\n+          y: 613,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X158',\n+        absolutePosition: {\n+          x: 127,\n+          y: 613,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X159',\n+        absolutePosition: {\n+          x: 148,\n+          y: 613,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X160',\n+        absolutePosition: {\n+          x: 172,\n+          y: 613,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X161',\n+        absolutePosition: {\n+          x: 194,\n+          y: 613,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X162',\n+        absolutePosition: {\n+          x: 246,\n+          y: 613,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X163',\n+        absolutePosition: {\n+          x: 271,\n+          y: 613,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X164',\n+        absolutePosition: {\n+          x: 291,\n+          y: 613,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X165',\n+        absolutePosition: {\n+          x: 313,\n+          y: 613,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X166',\n+        absolutePosition: {\n+          x: 335,\n+          y: 613,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X167',\n+        absolutePosition: {\n+          x: 373,\n+          y: 613,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X168',\n+        absolutePosition: {\n+          x: 415,\n+          y: 620,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X169',\n+        absolutePosition: {\n+          x: 437,\n+          y: 613,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X170',\n+        absolutePosition: {\n+          x: 466,\n+          y: 613,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X171',\n+        absolutePosition: {\n+          x: 504,\n+          y: 613,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X172',\n+        absolutePosition: {\n+          x: 20,\n+          y: 624,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X173',\n+        absolutePosition: {\n+          x: 478,\n+          y: 625,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X174',\n+        absolutePosition: {\n+          x: 504,\n+          y: 625,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X175',\n+        absolutePosition: {\n+          x: 20,\n+          y: 637,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X176',\n+        absolutePosition: {\n+          x: 39,\n+          y: 637,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X177',\n+        absolutePosition: {\n+          x: 61,\n+          y: 637,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X178',\n+        absolutePosition: {\n+          x: 83,\n+          y: 637,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X179',\n+        absolutePosition: {\n+          x: 104,\n+          y: 637,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X180',\n+        absolutePosition: {\n+          x: 127,\n+          y: 637,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X181',\n+        absolutePosition: {\n+          x: 148,\n+          y: 637,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X182',\n+        absolutePosition: {\n+          x: 172,\n+          y: 637,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X183',\n+        absolutePosition: {\n+          x: 194,\n+          y: 637,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X184',\n+        absolutePosition: {\n+          x: 246,\n+          y: 637,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X185',\n+        absolutePosition: {\n+          x: 271,\n+          y: 637,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X186',\n+        absolutePosition: {\n+          x: 291,\n+          y: 637,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X187',\n+        absolutePosition: {\n+          x: 313,\n+          y: 637,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X188',\n+        absolutePosition: {\n+          x: 335,\n+          y: 637,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X189',\n+        absolutePosition: {\n+          x: 373,\n+          y: 637,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X190',\n+        absolutePosition: {\n+          x: 415,\n+          y: 644,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X191',\n+        absolutePosition: {\n+          x: 437,\n+          y: 637,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X192',\n+        absolutePosition: {\n+          x: 466,\n+          y: 637,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X193',\n+        absolutePosition: {\n+          x: 504,\n+          y: 637,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X194',\n+        absolutePosition: {\n+          x: 20,\n+          y: 648,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X195',\n+        absolutePosition: {\n+          x: 478,\n+          y: 648,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X196',\n+        absolutePosition: {\n+          x: 504,\n+          y: 648,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X197',\n+        absolutePosition: {\n+          x: 20,\n+          y: 661,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X198',\n+        absolutePosition: {\n+          x: 39,\n+          y: 661,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X199',\n+        absolutePosition: {\n+          x: 61,\n+          y: 661,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X200',\n+        absolutePosition: {\n+          x: 83,\n+          y: 661,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X201',\n+        absolutePosition: {\n+          x: 104,\n+          y: 661,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X202',\n+        absolutePosition: {\n+          x: 127,\n+          y: 661,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X203',\n+        absolutePosition: {\n+          x: 148,\n+          y: 661,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X204',\n+        absolutePosition: {\n+          x: 172,\n+          y: 661,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X205',\n+        absolutePosition: {\n+          x: 194,\n+          y: 661,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X206',\n+        absolutePosition: {\n+          x: 246,\n+          y: 661,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X207',\n+        absolutePosition: {\n+          x: 271,\n+          y: 661,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X208',\n+        absolutePosition: {\n+          x: 291,\n+          y: 661,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X209',\n+        absolutePosition: {\n+          x: 313,\n+          y: 661,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X210',\n+        absolutePosition: {\n+          x: 335,\n+          y: 661,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X211',\n+        absolutePosition: {\n+          x: 373,\n+          y: 661,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X212',\n+        absolutePosition: {\n+          x: 416,\n+          y: 668,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X213',\n+        absolutePosition: {\n+          x: 437,\n+          y: 661,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X214',\n+        absolutePosition: {\n+          x: 466,\n+          y: 661,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X215',\n+        absolutePosition: {\n+          x: 504,\n+          y: 661,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X216',\n+        absolutePosition: {\n+          x: 441,\n+          y: 671,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X217',\n+        absolutePosition: {\n+          x: 20,\n+          y: 680,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X218',\n+        absolutePosition: {\n+          x: 178,\n+          y: 680,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X219',\n+        absolutePosition: {\n+          x: 136,\n+          y: 683,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X220',\n+        absolutePosition: {\n+          x: 150,\n+          y: 684,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X221',\n+        absolutePosition: {\n+          x: 287,\n+          y: 684,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X222',\n+        absolutePosition: {\n+          x: 322,\n+          y: 684,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X223',\n+        absolutePosition: {\n+          x: 380,\n+          y: 681,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X224',\n+        absolutePosition: {\n+          x: 463,\n+          y: 681,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X225',\n+        absolutePosition: {\n+          x: 488,\n+          y: 697,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X226',\n+        absolutePosition: {\n+          x: 516,\n+          y: 696,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X227',\n+        absolutePosition: {\n+          x: 177,\n+          y: 705,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X228',\n+        absolutePosition: {\n+          x: 372,\n+          y: 706,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X229',\n+        absolutePosition: {\n+          x: 177,\n+          y: 716,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X230',\n+        absolutePosition: {\n+          x: 372,\n+          y: 716,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X231',\n+        absolutePosition: {\n+          x: 19,\n+          y: 726,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X232',\n+        absolutePosition: {\n+          x: 178,\n+          y: 728,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X233',\n+        absolutePosition: {\n+          x: 372,\n+          y: 728,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X234',\n+        absolutePosition: {\n+          x: 113,\n+          y: 738,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X235',\n+        absolutePosition: {\n+          x: 187,\n+          y: 743,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X236',\n+        absolutePosition: {\n+          x: 272,\n+          y: 743,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X237',\n+        absolutePosition: {\n+          x: 380,\n+          y: 743,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X238',\n+        absolutePosition: {\n+          x: 464,\n+          y: 743,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X239',\n+        absolutePosition: {\n+          x: 516,\n+          y: 765,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X240',\n+        absolutePosition: {\n+          x: 466,\n+          y: 541,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X241',\n+        absolutePosition: {\n+          x: 466,\n+          y: 553,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X242',\n+        absolutePosition: {\n+          x: 466,\n+          y: 576,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X243',\n+        absolutePosition: {\n+          x: 465,\n+          y: 601,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X244',\n+        absolutePosition: {\n+          x: 466,\n+          y: 648,\n+        },\n+        fontSize: 9,\n+      },\n+      {\n+        text: 'X245',\n+        absolutePosition: {\n+          x: 466,\n+          y: 624,\n+        },\n+        fontSize: 9,\n+      },\n+    ],\n+  };\n+  return docDefinition;\n+}\n+\n+/* PDF content helpers */\n+\n+export function getInsuranceProgramContent(insuranceType: string): Content[] {\n+  const optionsMap: Record<string, number> = {\n+    MEDICARE: 23,\n+    MEDICAID: 71,\n+    TRICARE: 122,\n+    CHAMPVA: 187,\n+    'GROUP HEALTH PLAN': 237,\n+    'FECA BLK LUNG': 295,\n+    OTHER: 338,\n+  };\n+\n+  return [\n+    {\n+      text: 'X',\n+      absolutePosition: {\n+        x: optionsMap[insuranceType] ?? 338,\n+        y: 108,\n+      },\n+      fontSize: 9,\n+    },\n+  ];\n+}\n+\n+// This may have reusable logic for other Date fields\n+export function getPatientDOBContent(patientDOB: Date | undefined): Content[] {\n+  if (!patientDOB) {\n+    return [];\n+  }\n+\n+  const optionsMap: Record<string, number> = {\n+    day: 236,\n+    month: 257,\n+    year: 278,\n+  };\n+\n+  return [\n+    {\n+      text: String(patientDOB.getUTCDate()).padStart(2, '0'),\n+      absolutePosition: {\n+        x: optionsMap['day'],\n+        y: 131,\n+      },\n+      fontSize: 9,\n+    },\n+    {\n+      text: String(patientDOB.getUTCMonth() + 1).padStart(2, '0'),\n+      absolutePosition: {\n+        x: optionsMap['month'],\n+        y: 131,\n+      },\n+      fontSize: 9,\n+    },\n+    {\n+      text: String(patientDOB.getUTCFullYear()).substring(2),\n+      absolutePosition: {\n+        x: optionsMap['year'],\n+        y: 131,\n+      },\n+      fontSize: 9,\n+    },\n+  ];\n+}\n+\n+export function getPatientSexContent(patientSex: string): Content[] {\n+  const optionsMap: Record<string, number> = {\n+    male: 316,\n+    female: 352,\n+  };\n+\n+  if (!(patientSex in optionsMap)) {\n+    return [];\n+  }\n+\n+  return [\n+    {\n+      text: 'X',\n+      absolutePosition: {\n+        x: optionsMap[patientSex] ?? 338,\n+        y: 131,\n+      },\n+      fontSize: 9,\n+    },\n+  ];\n+}\n+\n+export function getPatientPhoneContent(patient: Patient): Content[] {\n+  const phone = patient.telecom?.find((telecom) => telecom.system === 'phone');\n+\n+  if (!phone) {\n+    return [];\n+  }\n+\n+  return [\n+    {\n+      text: phone.value || '',\n+      absolutePosition: {\n+        x: 123,\n+        y: 204,\n+      },\n+      fontSize: 9,\n+    },\n+    {\n+      text: 'X',\n+      absolutePosition: {\n+        x: 150,\n+        y: 204,\n+      },\n+      fontSize: 9,\n+    },\n+  ];\n+}\n+\n+export function getPatientAddressContent(patient: Patient, xAxisOffset: number = 22): Content[] {\n+  if (!patient.address?.length) {\n+    return [];\n+  }\n+\n+  const { line, city, postalCode, state } = patient.address[0];\n+\n+  return [\n+    {\n+      text: line || '',\n+      absolutePosition: {\n+        x: xAxisOffset,\n+        y: 156,\n+      },\n+      fontSize: 9,\n+    },\n+    {\n+      text: city || '',\n+      absolutePosition: {\n+        x: xAxisOffset,\n+        y: 179,\n+      },\n+      fontSize: 9,\n+    },\n+    {\n+      text: state || '',\n+      absolutePosition: {\n+        x: xAxisOffset + 181,\n+        y: 179,\n+      },\n+      fontSize: 9,\n+    },\n+    {\n+      text: postalCode || '',\n+      absolutePosition: {\n+        x: xAxisOffset,\n+        y: 204,\n+      },\n+      fontSize: 9,\n+    },\n+  ];\n+}\n+\n+/* Data retrieval helpers */\n+\n+export function getPatientInfo(patient: Patient): Record<string, string> {\n+  const patientName = patient.name?.[0] ? formatHumanName(patient.name?.[0]) : ''; //  needs to be formatted to First M. Last\n+  const patientDob = formatDate(patient.birthDate);\n+  const patientSex = patient.gender ?? '';\n+  const patientAddress = patient.address ? formatAddress(patient.address?.[0]) : '';\n+\n+  return {\n+    patientName,\n+    patientDob,\n+    patientSex,\n+    patientAddress,\n+  };\n+}\n+\n+function getCoverageInfo(coverage: Coverage): Record<string, string> {\n+  const insuranceType = coverage.type?.coding?.[0].display ?? '';\n+  const insuredIdNumber = coverage.identifier?.find((id) => id.use === 'official')?.value ?? '';\n+  const relation = coverage.relationship?.coding?.[0].display ?? '';\n+  const coverageName = coverage.payor[0].display ?? '';\n+\n+  return {\n+    insuranceType,\n+    insuredIdNumber,\n+    relation,\n+    coverageName,\n+  };\n+}\n+\n+function getInsuredInfo(insured: Patient | RelatedPerson | undefined): Record<string, string> {\n+  if (!insured) {\n+    return {\n+      insuredName: '',\n+      insuredAddress: '',\n+      insuredDob: '',\n+      insuredSex: '',\n+    };\n+  }\n+\n+  const insuredName = insured.name ? formatHumanName(insured.name[0]) : '';\n+  const insuredAddress = insured.address ? formatAddress(insured.address?.[0]) : '';\n+  const insuredDob = formatDate(insured.birthDate);\n+  const insuredSex = insured.gender ?? '';\n+\n+  return {\n+    insuredName,\n+    insuredAddress,\n+    insuredDob,\n+    insuredSex,\n+  };\n+}\n",
    "test_patch": "diff --git a/examples/medplum-demo-bots/src/billing-bots/cms-1500-pdf.test.ts b/examples/medplum-demo-bots/src/billing-bots/cms-1500-pdf.test.ts\nnew file mode 100644\nindex 0000000000..29143105c7\n--- /dev/null\n+++ b/examples/medplum-demo-bots/src/billing-bots/cms-1500-pdf.test.ts\n@@ -0,0 +1,108 @@\n+import { indexSearchParameterBundle, indexStructureDefinitionBundle } from '@medplum/core';\n+import { readJson, SEARCH_PARAMETER_BUNDLE_FILES } from '@medplum/definitions';\n+import { Bundle, Claim, SearchParameter } from '@medplum/fhirtypes';\n+import { MockClient } from '@medplum/mock';\n+import { getInsurerInfo, getPatientInfo, getProviderInfo, getReferralInfo, handler } from './cms-1500-pdf';\n+import { fullAnswer } from './cms-1500-test-data';\n+\n+const medplum = new MockClient();\n+\n+describe('CMS 1500 tests', async () => {\n+  beforeAll(() => {\n+    indexStructureDefinitionBundle(readJson('fhir/r4/profiles-types.json') as Bundle);\n+    indexStructureDefinitionBundle(readJson('fhir/r4/profiles-resources.json') as Bundle);\n+    for (const filename of SEARCH_PARAMETER_BUNDLE_FILES) {\n+      indexSearchParameterBundle(readJson(filename) as Bundle<SearchParameter>);\n+    }\n+  });\n+\n+  test('Fully answered CMS1500 pdf', async () => {\n+    const result = await medplum.executeBatch(fullAnswer);\n+    console.log(result);\n+    const claim = (await medplum.searchOne('Claim', {\n+      identifier: 'example-claim',\n+    })) as Claim;\n+\n+    const response = await handler(medplum, {\n+      bot: { reference: 'Bot/123' },\n+      input: claim,\n+      secrets: {},\n+      contentType: 'application/fhir+json',\n+    });\n+\n+    expect(response).toBeDefined();\n+    expect(response.resourceType).toBe('Media');\n+    expect(response.content.contentType).toBe('application/pdf');\n+  });\n+\n+  test('Get patient info', async () => {\n+    const patientInfo = getPatientInfo({\n+      resourceType: 'Patient',\n+      name: [{ given: ['Homer'], family: 'Simpson' }],\n+      gender: 'male',\n+    });\n+\n+    expect(patientInfo.patientName).toBe('Homer Simpson');\n+    expect(patientInfo.patientSex).toBe('male');\n+    expect(patientInfo.patientDob).toBe('');\n+    expect(patientInfo.patientAddress).toBe('');\n+  });\n+\n+  test('Insurer is not an organization', async () => {\n+    const insurerInfo = getInsurerInfo({\n+      resourceType: 'Patient',\n+    });\n+\n+    expect(insurerInfo.serviceNPI).toBe('');\n+    expect(insurerInfo.serviceLocation).toBe('');\n+    expect(insurerInfo.fedTaxNumber).toBe('');\n+    expect(insurerInfo.fedTaxType).toBe('');\n+  });\n+\n+  test('Referrer is not a practitioner or organization', async () => {\n+    const patientReferralInfo = getReferralInfo({\n+      resourceType: 'Patient',\n+    });\n+    const organizationReferralInfo = getReferralInfo({\n+      resourceType: 'Organization',\n+      name: 'Referrer',\n+      identifier: [\n+        {\n+          type: {\n+            coding: [{ code: 'NPI' }],\n+          },\n+          value: 'org-npi-code',\n+        },\n+      ],\n+    });\n+    const practitionerReferralInfo = getReferralInfo({\n+      resourceType: 'Practitioner',\n+      name: [{ given: ['Kevin'], family: 'Smith' }],\n+      identifier: [\n+        {\n+          type: {\n+            coding: [{ code: 'NPI' }],\n+          },\n+          value: 'practitioner-npi-code',\n+        },\n+      ],\n+    });\n+\n+    expect(patientReferralInfo.referrerName).toBe('');\n+    expect(patientReferralInfo.referrerNpi).toBe('');\n+    expect(organizationReferralInfo.referrerName).toBe('Referrer');\n+    expect(organizationReferralInfo.referrerNpi).toBe('org-npi-code');\n+    expect(practitionerReferralInfo.referrerName).toBe('Kevin Smith');\n+    expect(practitionerReferralInfo.referrerNpi).toBe('practitioner-npi-code');\n+  });\n+\n+  test('Practitioner Role for provider', async () => {\n+    const providerInfo = getProviderInfo({\n+      resourceType: 'PractitionerRole',\n+    });\n+\n+    expect(providerInfo.billingLocation).toBe('');\n+    expect(providerInfo.billingPhoneNumber).toBe('');\n+    expect(providerInfo.providerNpi).toBe('');\n+  });\n+});\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6077",
    "pr_id": 6077,
    "issue_id": 6067,
    "repo": "medplum/medplum",
    "problem_statement": "Flaky test in SearchPopupMenu\nFlaky test:\n\n![Image](https://github.com/user-attachments/assets/ecfb4b94-7ebf-4de0-8c34-ff7a54ced609)",
    "issue_word_count": 18,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/react/src/SearchPopupMenu/SearchPopupMenu.test.tsx",
      "packages/react/src/SearchPopupMenu/SearchPopupMenu.tsx"
    ],
    "pr_changed_test_files": [
      "packages/react/src/SearchPopupMenu/SearchPopupMenu.test.tsx"
    ],
    "base_commit": "594c1dbb5dd6b1cfc9d31cc3cb25bd288b888cfa",
    "head_commit": "c8c1325efdd937e955cf258408e3a450f52a7b07",
    "repo_url": "https://github.com/medplum/medplum/pull/6077",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6077",
    "dockerfile": "",
    "pr_merged_at": "2025-02-27T01:02:52.000Z",
    "patch": "diff --git a/packages/react/src/SearchPopupMenu/SearchPopupMenu.tsx b/packages/react/src/SearchPopupMenu/SearchPopupMenu.tsx\nindex 438dd1ea59..266274fff6 100644\n--- a/packages/react/src/SearchPopupMenu/SearchPopupMenu.tsx\n+++ b/packages/react/src/SearchPopupMenu/SearchPopupMenu.tsx\n@@ -44,15 +44,15 @@ export function SearchPopupMenu(props: SearchPopupMenuProps): JSX.Element | null\n   }\n \n   function onSort(searchParam: SearchParameter, desc: boolean): void {\n-    onChange(setSort(props.search, searchParam.code as string, desc));\n+    onChange(setSort(props.search, searchParam.code, desc));\n   }\n \n   function onClear(searchParam: SearchParameter): void {\n-    onChange(clearFiltersOnField(props.search, searchParam.code as string));\n+    onChange(clearFiltersOnField(props.search, searchParam.code));\n   }\n \n   function onPrompt(searchParam: SearchParameter, operator: Operator): void {\n-    props.onPrompt(searchParam, { code: searchParam.code as string, operator, value: '' });\n+    props.onPrompt(searchParam, { code: searchParam.code, operator, value: '' });\n   }\n \n   function onChange(definition: SearchRequest): void {\n@@ -77,7 +77,7 @@ export function SearchPopupMenu(props: SearchPopupMenuProps): JSX.Element | null\n   return (\n     <Menu.Dropdown>\n       {props.searchParams.map((searchParam) => (\n-        <Menu.Item key={searchParam.code}>{buildFieldNameString(searchParam.code as string)}</Menu.Item>\n+        <Menu.Item key={searchParam.code}>{buildFieldNameString(searchParam.code)}</Menu.Item>\n       ))}\n     </Menu.Dropdown>\n   );\n@@ -113,7 +113,7 @@ function SearchParameterSubMenu(props: SearchPopupSubMenuProps): JSX.Element {\n \n function DateFilterSubMenu(props: SearchPopupSubMenuProps): JSX.Element {\n   const { searchParam } = props;\n-  const code = searchParam.code as string;\n+  const code = searchParam.code;\n   return (\n     <Menu.Dropdown>\n       <Menu.Item leftSection={<IconSortAscending size={14} />} onClick={() => props.onSort(searchParam, false)}>\n@@ -312,7 +312,7 @@ function TokenFilterSubMenu(props: SearchPopupSubMenuProps): JSX.Element {\n \n function CommonMenuItems(props: SearchPopupSubMenuProps): JSX.Element {\n   const { searchParam } = props;\n-  const code = searchParam.code as string;\n+  const code = searchParam.code;\n   return (\n     <>\n       <Menu.Divider />\n",
    "test_patch": "diff --git a/packages/react/src/SearchPopupMenu/SearchPopupMenu.test.tsx b/packages/react/src/SearchPopupMenu/SearchPopupMenu.test.tsx\nindex 8de7a45859..3d24014a37 100644\n--- a/packages/react/src/SearchPopupMenu/SearchPopupMenu.test.tsx\n+++ b/packages/react/src/SearchPopupMenu/SearchPopupMenu.test.tsx\n@@ -5,13 +5,13 @@ import { MockClient } from '@medplum/mock';\n import { MedplumProvider } from '@medplum/react-hooks';\n import { MemoryRouter } from 'react-router-dom';\n import { getFieldDefinitions } from '../SearchControl/SearchControlField';\n-import { act, fireEvent, render, screen } from '../test-utils/render';\n+import { act, fireEvent, render, screen, userEvent } from '../test-utils/render';\n import { SearchPopupMenu, SearchPopupMenuProps } from './SearchPopupMenu';\n \n const medplum = new MockClient();\n \n describe('SearchPopupMenu', () => {\n-  function setup(partialProps: Partial<SearchPopupMenuProps>): void {\n+  async function setup(partialProps: Partial<SearchPopupMenuProps>): Promise<void> {\n     const props = {\n       visible: true,\n       x: 0,\n@@ -25,7 +25,7 @@ describe('SearchPopupMenu', () => {\n     render(\n       <MemoryRouter>\n         <MedplumProvider medplum={medplum}>\n-          <Menu>\n+          <Menu closeOnItemClick={false}>\n             <Menu.Target>\n               <Button>Toggle menu</Button>\n             </Menu.Target>\n@@ -34,16 +34,18 @@ describe('SearchPopupMenu', () => {\n         </MedplumProvider>\n       </MemoryRouter>\n     );\n+\n+    await toggleMenu();\n   }\n \n-  test('Invalid resource', () => {\n-    setup({\n+  test('Invalid resource', async () => {\n+    await setup({\n       search: { resourceType: 'xyz' as ResourceType },\n     });\n   });\n \n-  test('Invalid property', () => {\n-    setup({\n+  test('Invalid property', async () => {\n+    await setup({\n       search: { resourceType: 'Patient' },\n     });\n   });\n@@ -53,14 +55,12 @@ describe('SearchPopupMenu', () => {\n       resourceType: 'Patient',\n     };\n \n-    setup({\n+    await setup({\n       search: currSearch,\n       searchParams: [globalSchema.types['Patient'].searchParams?.['birthdate'] as SearchParameter],\n       onChange: (e) => (currSearch = e),\n     });\n \n-    await toggleMenu();\n-\n     const sortOldest = await screen.findByText('Sort Oldest to Newest');\n     await act(async () => {\n       fireEvent.click(sortOldest);\n@@ -71,8 +71,6 @@ describe('SearchPopupMenu', () => {\n     expect(currSearch.sortRules?.[0].code).toEqual('birthdate');\n     expect(currSearch.sortRules?.[0].descending).toEqual(false);\n \n-    await toggleMenu();\n-\n     const sortNewest = await screen.findByText('Sort Newest to Oldest');\n     await act(async () => {\n       fireEvent.click(sortNewest);\n@@ -88,7 +86,7 @@ describe('SearchPopupMenu', () => {\n     const searchParam = globalSchema.types['Patient'].searchParams?.['birthdate'] as SearchParameter;\n     const onPrompt = jest.fn();\n \n-    setup({\n+    await setup({\n       search: {\n         resourceType: 'Patient',\n       },\n@@ -107,8 +105,6 @@ describe('SearchPopupMenu', () => {\n     for (const option of options) {\n       onPrompt.mockClear();\n \n-      await toggleMenu();\n-\n       const optionButton = await screen.findByText(option.text);\n       await act(async () => {\n         fireEvent.click(optionButton);\n@@ -129,14 +125,12 @@ describe('SearchPopupMenu', () => {\n         resourceType: 'Patient',\n       };\n \n-      setup({\n+      await setup({\n         search: currSearch,\n         searchParams: [globalSchema.types['Patient'].searchParams?.['birthdate'] as SearchParameter],\n         onChange: (e) => (currSearch = e),\n       });\n \n-      await toggleMenu();\n-\n       const optionButton = await screen.findByText(option);\n       await act(async () => {\n         fireEvent.click(optionButton);\n@@ -162,7 +156,7 @@ describe('SearchPopupMenu', () => {\n       resourceType: 'Patient',\n     };\n \n-    setup({\n+    await setup({\n       search: currSearch,\n       searchParams: [globalSchema.types['Patient'].searchParams?.['birthdate'] as SearchParameter],\n       onChange: (e) => (currSearch = e),\n@@ -170,8 +164,6 @@ describe('SearchPopupMenu', () => {\n \n     const options = ['Missing', 'Not missing'];\n     for (const option of options) {\n-      await toggleMenu();\n-\n       const optionButton = await screen.findByText(option);\n       await act(async () => {\n         fireEvent.click(optionButton);\n@@ -200,14 +192,12 @@ describe('SearchPopupMenu', () => {\n       ],\n     };\n \n-    setup({\n+    await setup({\n       search: currSearch,\n       searchParams: [globalSchema.types['Patient'].searchParams?.['birthdate'] as SearchParameter],\n       onChange: (e) => (currSearch = e),\n     });\n \n-    await toggleMenu();\n-\n     const clearButton = await screen.findByText('Clear filters');\n     await act(async () => {\n       fireEvent.click(clearButton);\n@@ -223,14 +213,12 @@ describe('SearchPopupMenu', () => {\n       resourceType: 'Patient',\n     };\n \n-    setup({\n+    await setup({\n       search: currSearch,\n       searchParams: [searchParam],\n       onChange: (e) => (currSearch = e),\n     });\n \n-    await toggleMenu();\n-\n     const sortSmallest = await screen.findByText('Sort Smallest to Largest');\n     await act(async () => {\n       fireEvent.click(sortSmallest);\n@@ -241,8 +229,6 @@ describe('SearchPopupMenu', () => {\n     expect(currSearch.sortRules?.[0].code).toEqual('value-quantity');\n     expect(currSearch.sortRules?.[0].descending).toEqual(false);\n \n-    await toggleMenu();\n-\n     const sortLargest = await screen.findByText('Sort Largest to Smallest');\n     await act(async () => {\n       fireEvent.click(sortLargest);\n@@ -258,7 +244,7 @@ describe('SearchPopupMenu', () => {\n     const searchParam = globalSchema.types['Observation'].searchParams?.['value-quantity'] as SearchParameter;\n     const onPrompt = jest.fn();\n \n-    setup({\n+    await setup({\n       search: {\n         resourceType: 'Observation',\n       },\n@@ -278,8 +264,6 @@ describe('SearchPopupMenu', () => {\n     for (const option of options) {\n       onPrompt.mockClear();\n \n-      await toggleMenu();\n-\n       const optionButton = await screen.findByText(option.text);\n       await act(async () => {\n         fireEvent.click(optionButton);\n@@ -300,7 +284,7 @@ describe('SearchPopupMenu', () => {\n       resourceType: 'Observation',\n     };\n \n-    setup({\n+    await setup({\n       search: currSearch,\n       searchParams: [searchParam],\n       onChange: (e) => (currSearch = e),\n@@ -308,8 +292,6 @@ describe('SearchPopupMenu', () => {\n \n     const options = ['Missing', 'Not missing'];\n     for (const option of options) {\n-      await toggleMenu();\n-\n       const optionButton = await screen.findByText(option);\n       await act(async () => {\n         fireEvent.click(optionButton);\n@@ -340,14 +322,12 @@ describe('SearchPopupMenu', () => {\n       ],\n     };\n \n-    setup({\n+    await setup({\n       search: currSearch,\n       searchParams: [searchParam],\n       onChange: (e) => (currSearch = e),\n     });\n \n-    await toggleMenu();\n-\n     const clearButton = await screen.findByText('Clear filters');\n     await act(async () => {\n       fireEvent.click(clearButton);\n@@ -368,14 +348,12 @@ describe('SearchPopupMenu', () => {\n       ],\n     };\n \n-    setup({\n+    await setup({\n       search: currSearch,\n       searchParams: [globalSchema.types['Patient'].searchParams?.['organization'] as SearchParameter],\n       onChange: (e) => (currSearch = e),\n     });\n \n-    await toggleMenu();\n-\n     const clearButton = await screen.findByText('Clear filters');\n     await act(async () => {\n       fireEvent.click(clearButton);\n@@ -388,7 +366,7 @@ describe('SearchPopupMenu', () => {\n     const searchParam = globalSchema.types['Patient'].searchParams?.['organization'] as SearchParameter;\n     const onPrompt = jest.fn();\n \n-    setup({\n+    await setup({\n       search: {\n         resourceType: 'Patient',\n       },\n@@ -404,8 +382,6 @@ describe('SearchPopupMenu', () => {\n     for (const option of options) {\n       onPrompt.mockClear();\n \n-      await toggleMenu();\n-\n       const optionButton = await screen.findByText(option.text);\n       await act(async () => {\n         fireEvent.click(optionButton);\n@@ -426,7 +402,7 @@ describe('SearchPopupMenu', () => {\n       resourceType: 'Patient',\n     };\n \n-    setup({\n+    await setup({\n       search: currSearch,\n       searchParams: [searchParam],\n       onChange: (e) => (currSearch = e),\n@@ -434,8 +410,6 @@ describe('SearchPopupMenu', () => {\n \n     const options = ['Missing', 'Not missing'];\n     for (const option of options) {\n-      await toggleMenu();\n-\n       const optionButton = await screen.findByText(option);\n       await act(async () => {\n         fireEvent.click(optionButton);\n@@ -457,14 +431,12 @@ describe('SearchPopupMenu', () => {\n       resourceType: 'Patient',\n     };\n \n-    setup({\n+    await setup({\n       search: currSearch,\n       searchParams: [globalSchema.types['Patient'].searchParams?.['name'] as SearchParameter],\n       onChange: (e) => (currSearch = e),\n     });\n \n-    await toggleMenu();\n-\n     const sortAtoZ = await screen.findByText('Sort A to Z');\n     await act(async () => {\n       fireEvent.click(sortAtoZ);\n@@ -475,8 +447,6 @@ describe('SearchPopupMenu', () => {\n     expect(currSearch.sortRules?.[0].code).toEqual('name');\n     expect(currSearch.sortRules?.[0].descending).toEqual(false);\n \n-    await toggleMenu();\n-\n     const sortZtoA = await screen.findByText('Sort Z to A');\n     await act(async () => {\n       fireEvent.click(sortZtoA);\n@@ -500,14 +470,12 @@ describe('SearchPopupMenu', () => {\n       ],\n     };\n \n-    setup({\n+    await setup({\n       search: currSearch,\n       searchParams: [globalSchema.types['Patient'].searchParams?.['name'] as SearchParameter],\n       onChange: (e) => (currSearch = e),\n     });\n \n-    await toggleMenu();\n-\n     const clearButton = await screen.findByText('Clear filters');\n     await act(async () => {\n       fireEvent.click(clearButton);\n@@ -520,7 +488,7 @@ describe('SearchPopupMenu', () => {\n     const searchParam = globalSchema.types['Patient'].searchParams?.['name'] as SearchParameter;\n     const onPrompt = jest.fn();\n \n-    setup({\n+    await setup({\n       search: {\n         resourceType: 'Patient',\n       },\n@@ -538,8 +506,6 @@ describe('SearchPopupMenu', () => {\n     for (const option of options) {\n       onPrompt.mockClear();\n \n-      await toggleMenu();\n-\n       const optionButton = await screen.findByText(option.text);\n       await act(async () => {\n         fireEvent.click(optionButton);\n@@ -560,7 +526,7 @@ describe('SearchPopupMenu', () => {\n       resourceType: 'Patient',\n     };\n \n-    setup({\n+    await setup({\n       search: currSearch,\n       searchParams: [searchParam],\n       onChange: (e) => (currSearch = e),\n@@ -568,8 +534,6 @@ describe('SearchPopupMenu', () => {\n \n     const options = ['Missing', 'Not missing'];\n     for (const option of options) {\n-      await toggleMenu();\n-\n       const optionButton = await screen.findByText(option);\n       await act(async () => {\n         fireEvent.click(optionButton);\n@@ -594,13 +558,11 @@ describe('SearchPopupMenu', () => {\n \n     const fields = getFieldDefinitions(search);\n \n-    setup({\n+    await setup({\n       search,\n       searchParams: fields[0].searchParams,\n     });\n \n-    await toggleMenu();\n-\n     expect(await screen.findByText('Equals...')).toBeDefined();\n   });\n \n@@ -612,15 +574,13 @@ describe('SearchPopupMenu', () => {\n \n     const fields = getFieldDefinitions(search);\n \n-    setup({\n+    await setup({\n       search: {\n         resourceType: 'Patient',\n       },\n       searchParams: fields[0].searchParams,\n     });\n \n-    await toggleMenu();\n-\n     expect(await screen.findByText('Before...')).toBeDefined();\n     expect(await screen.findByText('After...')).toBeDefined();\n   });\n@@ -633,15 +593,13 @@ describe('SearchPopupMenu', () => {\n \n     const fields = getFieldDefinitions(search);\n \n-    setup({\n+    await setup({\n       search: {\n         resourceType: 'Observation',\n       },\n       searchParams: fields[0].searchParams,\n     });\n \n-    await toggleMenu();\n-\n     expect(await screen.findByText('Value Quantity')).toBeDefined();\n     expect(await screen.findByText('Value String')).toBeDefined();\n   });\n@@ -663,15 +621,13 @@ describe('SearchPopupMenu', () => {\n \n     const fields = getFieldDefinitions(search);\n \n-    setup({\n+    await setup({\n       search: {\n         resourceType: 'Observation',\n       },\n       searchParams: fields[0].searchParams,\n     });\n \n-    await toggleMenu();\n-\n     expect(await screen.findByText('Equals...')).toBeDefined();\n     expect(screen.queryByText('Patient')).toBeNull();\n   });\n@@ -680,6 +636,6 @@ describe('SearchPopupMenu', () => {\n async function toggleMenu(): Promise<void> {\n   const toggleMenuButton = await screen.findByText('Toggle menu');\n   await act(async () => {\n-    fireEvent.click(toggleMenuButton);\n+    await userEvent.click(toggleMenuButton);\n   });\n }\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6033",
    "pr_id": 6033,
    "issue_id": 6002,
    "repo": "medplum/medplum",
    "problem_statement": "Adding a version column to resources\n## Background\n\nTo fully take advantage of almost all data migrations, certain schema migrations, and various other server logic changes (e.g. a new SearchParameter), it is necessary to \"reindex\" all resources on a Medplum server deployment. Reindexing is the process of iterating over all non-deleted resources to recompute search parameter related columns, replacing lookup table entries, etc. to ensure they have the most up to date representation in the database based on the latest Medplum code version, defined SearchParameters, etc.\n\nReindexing all resource types on a large Medplum deployment can take a very long time. In some scenarios, the server change that a super admin wants to ensure all resources reflect could have been already been live for quite a while (e.g. populating the `projectId` column) meaning that a decent percentage of resources already reflect the change. In these cases, it is wasteful and needlessly time consuming to reindex all resources when only a small fraction of them really needed to be reindexed.\n\nResource rows do not currently include a definitive way to determine the state of the server when they were written. The closest analog is the `lastUpdated` column with the big caveat that `lastUpdated` has FHIR semantics and can be manually set to any timestamp by a super admin. In other words, it is not a reliable, server-controlled \"when was this record saved to the database?\" timestamp.\n\n## Adding a version column\n\nTo more reliably know which rows reflect which state of the server, a new `_version` column (actual column name TBD) is added to all resource tables. During all resource creates and updates, it is set to a constant integer value `RESOURCE_VERSION` (this is just a placeholder name) included in Medplum server code. This constant value will be incremented as necessary when code changes include changes in how a resource is represented in the database; generally all schema migrations as well as bug fixes or improvements in search parameter implementations/representations.\n\nWith the `_version` column, Medplum could support a few variants of reindexing:\n\n- **minimum version reindex**: Reindex resources with `_version` older than a `minimumVersion` parameter specified when a reindex job is created. The most selective variant; used when some specific feature/functionality is desired ASAP.\n- **current version reindex**: Reindex resources with `_version` less than `RESOURCE_VERSION`. The standard variant of reindexing to get all resources shored up with the latest available functionality.\n- **full reindex**: Reindex all resources; ignores current value of `_version`. Equivalent to how reindexing works today. This becomes the \"break glass\" variant of reindexing when something is suspected to have gone wrong that should only be needed sparingly.\n\n\n### Potential extension\n\nDistilling the version of a resource down to a single integer as described above is a huge improvement over having nothing, but perhaps that is too simplistic. An alternative idea discussed by the team is introducing the concept of a \"server deployment\". Each time a server starts, an entry is added to the new server deployment table that captures more information about the state of the server:\n\n- `RESOURCE_VERSION` as described above\n- A timestamp of when the server started\n- The Medplum server version, e.g. `3.2.32`\n- Additional server metadata TBD?\n\nNow, instead of (or in addition to since denormalizing the resource version would likely be desirable) each resource having a `_version` column, it has a `_deployment` column referencing the server deployment that wrote the resource. This additional information would be a boon to the debugability of Medplum and allow for more fine grained operations in the future.\n\n",
    "issue_word_count": 590,
    "test_files_count": 5,
    "non_test_files_count": 8,
    "pr_changed_files": [
      "packages/app/src/admin/SuperAdminPage.tsx",
      "packages/server/src/admin/super.test.ts",
      "packages/server/src/admin/super.ts",
      "packages/server/src/fhir/repo.test.ts",
      "packages/server/src/fhir/repo.ts",
      "packages/server/src/fhir/search.test.ts",
      "packages/server/src/fhir/search.ts",
      "packages/server/src/migrations/migrate.test.ts",
      "packages/server/src/migrations/migrate.ts",
      "packages/server/src/migrations/schema/index.ts",
      "packages/server/src/migrations/schema/v86.ts",
      "packages/server/src/workers/reindex.test.ts",
      "packages/server/src/workers/reindex.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/admin/super.test.ts",
      "packages/server/src/fhir/repo.test.ts",
      "packages/server/src/fhir/search.test.ts",
      "packages/server/src/migrations/migrate.test.ts",
      "packages/server/src/workers/reindex.test.ts"
    ],
    "base_commit": "1123a39a9cd49217eed4ad5c0768700ca715be0d",
    "head_commit": "3660c0b4ebda7a0fb1598615443aa829a27a96e1",
    "repo_url": "https://github.com/medplum/medplum/pull/6033",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6033",
    "dockerfile": "",
    "pr_merged_at": "2025-02-27T18:03:36.000Z",
    "patch": "diff --git a/packages/app/src/admin/SuperAdminPage.tsx b/packages/app/src/admin/SuperAdminPage.tsx\nindex 15a96b3d8d..4b7008c441 100644\n--- a/packages/app/src/admin/SuperAdminPage.tsx\n+++ b/packages/app/src/admin/SuperAdminPage.tsx\n@@ -1,4 +1,14 @@\n-import { Button, Divider, Modal, NativeSelect, PasswordInput, Stack, TextInput, Title } from '@mantine/core';\n+import {\n+  Button,\n+  Divider,\n+  Modal,\n+  NativeSelect,\n+  NumberInput,\n+  PasswordInput,\n+  Stack,\n+  TextInput,\n+  Title,\n+} from '@mantine/core';\n import { useDisclosure } from '@mantine/hooks';\n import { notifications, showNotification } from '@mantine/notifications';\n import { MedplumClient, MedplumRequestOptions, forbidden, normalizeErrorString } from '@medplum/core';\n@@ -157,6 +167,9 @@ export function SuperAdminPage(): JSX.Element {\n           <FormSection title=\"Search Filter\" htmlFor=\"filter\">\n             <TextInput id=\"filter\" name=\"filter\" placeholder=\"e.g. name=Sam&birthdate=lt2000-01-01\" />\n           </FormSection>\n+          <FormSection title=\"Max Resource Version\" htmlFor=\"maxResourceVersion\">\n+            <MaxResourceVersionInput />\n+          </FormSection>\n           <Button type=\"submit\">Reindex</Button>\n         </Stack>\n       </Form>\n@@ -234,6 +247,28 @@ export function SuperAdminPage(): JSX.Element {\n   );\n }\n \n+function MaxResourceVersionInput(): JSX.Element {\n+  const [value, setValue] = useState<'outdated' | 'all' | 'specific'>('outdated');\n+  return (\n+    <>\n+      <NativeSelect\n+        id=\"reindexType\"\n+        name=\"reindexType\"\n+        value={value}\n+        onChange={(e) => setValue(e.target.value as 'outdated' | 'all' | 'specific')}\n+        data={[\n+          { label: 'Outdated resources', value: 'outdated' },\n+          { label: 'All resources', value: 'all' },\n+          { label: 'Less than or equal to a specific version', value: 'specific' },\n+        ]}\n+      />\n+      {value === 'specific' && (\n+        <NumberInput required name=\"maxResourceVersion\" placeholder=\"Max Resource Version\" min={0} />\n+      )}\n+    </>\n+  );\n+}\n+\n function startAsyncJob(medplum: MedplumClient, title: string, url: string, body?: Record<string, string>): void {\n   notifications.show({\n     id: url,\n\ndiff --git a/packages/server/src/admin/super.ts b/packages/server/src/admin/super.ts\nindex 47c4376b40..707065d53b 100644\n--- a/packages/server/src/admin/super.ts\n+++ b/packages/server/src/admin/super.ts\n@@ -20,7 +20,7 @@ import { AuthenticatedRequestContext, getAuthenticatedContext } from '../context\n import { DatabaseMode, getDatabasePool, maybeStartDataMigration } from '../database';\n import { AsyncJobExecutor, sendAsyncResponse } from '../fhir/operations/utils/asyncjobexecutor';\n import { invalidRequest, sendOutcome } from '../fhir/outcomes';\n-import { getSystemRepo } from '../fhir/repo';\n+import { getSystemRepo, Repository } from '../fhir/repo';\n import { globalLogger } from '../logger';\n import { authenticateRequest } from '../oauth/middleware';\n import { getUserByEmail } from '../oauth/utils';\n@@ -90,10 +90,30 @@ superAdminRouter.post(\n // Run this after major changes to how search columns are constructed.\n superAdminRouter.post(\n   '/reindex',\n+\n+  [\n+    body('reindexType')\n+      .isIn(['outdated', 'all', 'specific'])\n+      .withMessage('reindexType must be \"outdated\", \"all\", or \"specific\"'),\n+    body('maxResourceVersion')\n+      .if(body('reindexType').equals('specific'))\n+      .isInt({ min: 0, max: Repository.VERSION - 1 })\n+      .withMessage(`maxResourceVersion must be an integer from 0 to ${Repository.VERSION - 1}`),\n+    body('maxResourceVersion')\n+      .if(body('reindexType').not().equals('specific'))\n+      .isEmpty()\n+      .withMessage('maxResourceVersion should only be specified when reindexType is \"specific\"'),\n+  ],\n   asyncWrap(async (req: Request, res: Response) => {\n     requireSuperAdmin();\n     requireAsync(req);\n \n+    const errors = validationResult(req);\n+    if (!errors.isEmpty()) {\n+      sendOutcome(res, invalidRequest(errors));\n+      return;\n+    }\n+\n     let resourceTypes: string[];\n     if (req.body.resourceType === '*') {\n       resourceTypes = getResourceTypes().filter((rt) => rt !== 'Binary');\n@@ -111,10 +131,29 @@ superAdminRouter.post(\n     }\n \n     const systemRepo = getSystemRepo();\n+\n+    const reindexType = req.body.reindexType as 'outdated' | 'all' | 'specific';\n+    let maxResourceVersion: number | undefined;\n+    switch (reindexType) {\n+      case 'all':\n+        maxResourceVersion = undefined;\n+        break;\n+      case 'specific':\n+        maxResourceVersion = Number(req.body.maxResourceVersion);\n+        break;\n+      case 'outdated':\n+        maxResourceVersion = Repository.VERSION - 1;\n+        break;\n+      default:\n+        reindexType satisfies never;\n+        sendOutcome(res, badRequest(`Invalid reindex type: ${reindexType}`));\n+        return;\n+    }\n+\n     const exec = new AsyncJobExecutor(systemRepo);\n     await exec.init(`${req.protocol}://${req.get('host') + req.originalUrl}`);\n     await exec.run(async (asyncJob) => {\n-      await addReindexJob(resourceTypes as ResourceType[], asyncJob, searchFilter);\n+      await addReindexJob(resourceTypes as ResourceType[], asyncJob, searchFilter, maxResourceVersion);\n     });\n \n     const { baseUrl } = getConfig();\n\ndiff --git a/packages/server/src/fhir/repo.ts b/packages/server/src/fhir/repo.ts\nindex 2f5cf5c464..fe44f3834f 100644\n--- a/packages/server/src/fhir/repo.ts\n+++ b/packages/server/src/fhir/repo.ts\n@@ -98,7 +98,7 @@ import { getPatients } from './patient';\n import { replaceConditionalReferences, validateResourceReferences } from './references';\n import { getFullUrl } from './response';\n import { RewriteMode, rewriteAttachments } from './rewrite';\n-import { buildSearchExpression, searchByReferenceImpl, searchImpl } from './search';\n+import { buildSearchExpression, searchByReferenceImpl, searchImpl, SearchOptions } from './search';\n import { getSearchParameterImplementation, lookupTables } from './searchparameter';\n import {\n   Condition,\n@@ -1173,11 +1173,14 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     await new DeleteQuery(resourceType + '_History').where('lastUpdated', '<=', before).execute(client);\n   }\n \n-  async search<T extends Resource>(searchRequest: SearchRequest<T>): Promise<Bundle<WithId<T>>> {\n+  async search<T extends Resource>(\n+    searchRequest: SearchRequest<T>,\n+    options?: SearchOptions\n+  ): Promise<Bundle<WithId<T>>> {\n     const startTime = Date.now();\n     try {\n       // Resource type validation is performed in the searchImpl function\n-      const result = await searchImpl(this, searchRequest);\n+      const result = await searchImpl(this, searchRequest, options);\n       const durationMs = Date.now() - startTime;\n       this.logEvent(SearchInteraction, AuditEventOutcome.Success, undefined, { searchRequest, durationMs });\n       return result;\n@@ -1325,6 +1328,13 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     }\n   }\n \n+  /**\n+   * The version to be set on resources when they are inserted/updated into the database.\n+   * The value should be incremented each time there is a change in the schema (really just columns)\n+   * of the resource tables or when there are code changes to `buildResourceRow`.\n+   */\n+  static readonly VERSION: number = 1;\n+\n   private buildResourceRow(resource: Resource): Record<string, any> {\n     const resourceType = resource.resourceType;\n     const meta = resource.meta as Meta;\n@@ -1338,6 +1348,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n       projectId: meta.project,\n       compartments,\n       content,\n+      __version: Repository.VERSION,\n     };\n \n     const searchParams = getSearchParameters(resourceType);\n\ndiff --git a/packages/server/src/fhir/search.ts b/packages/server/src/fhir/search.ts\nindex c7b7bb1d38..ec6770bb9b 100644\n--- a/packages/server/src/fhir/search.ts\n+++ b/packages/server/src/fhir/search.ts\n@@ -105,9 +105,12 @@ interface ChainedSearchParameter {\n   filter: Filter;\n }\n \n+export interface SearchOptions extends Pick<GetBaseSelectQueryOptions, 'maxResourceVersion'> {}\n+\n export async function searchImpl<T extends Resource>(\n   repo: Repository,\n-  searchRequest: SearchRequest<T>\n+  searchRequest: SearchRequest<T>,\n+  options?: SearchOptions\n ): Promise<Bundle<WithId<T>>> {\n   validateSearchResourceTypes(repo, searchRequest);\n   applyCountAndOffsetLimits(searchRequest);\n@@ -116,7 +119,7 @@ export async function searchImpl<T extends Resource>(\n   let rowCount = undefined;\n   let nextResource: T | undefined;\n   if (searchRequest.count > 0) {\n-    const builder = getSelectQueryForSearch(repo, searchRequest);\n+    const builder = getSelectQueryForSearch(repo, searchRequest, options);\n     ({ entry, rowCount, nextResource } = await getSearchEntries<T>(repo, searchRequest, builder));\n   }\n \n@@ -330,6 +333,8 @@ interface GetBaseSelectQueryOptions {\n   addColumns?: boolean;\n   /** Callback invoked for each resource type and  its `SelectQuery` after all filters are applied. */\n   resourceTypeQueryCallback?: (resourceType: SearchRequest['resourceType'], builder: SelectQuery) => void;\n+  /** The maximum resource version to include in the search. */\n+  maxResourceVersion?: number;\n }\n function getBaseSelectQuery(\n   repo: Repository,\n@@ -365,6 +370,12 @@ function getBaseSelectQueryForResourceType(\n   if (addColumns) {\n     builder.column(idColumn).column(new Column(resourceType, 'content'));\n   }\n+  if (opts?.maxResourceVersion !== undefined) {\n+    const col = new Column(resourceType, '__version');\n+    builder.whereExpr(\n+      new Disjunction([new Condition(col, '<=', opts.maxResourceVersion), new Condition(col, '=', null)])\n+    );\n+  }\n   repo.addDeletedFilter(builder);\n   repo.addSecurityFilters(builder, resourceType);\n   addSearchFilters(repo, builder, resourceType, searchRequest);\n\ndiff --git a/packages/server/src/migrations/migrate.ts b/packages/server/src/migrations/migrate.ts\nindex 44dee2e7f2..121cad39c4 100644\n--- a/packages/server/src/migrations/migrate.ts\n+++ b/packages/server/src/migrations/migrate.ts\n@@ -325,6 +325,7 @@ export function buildCreateTables(result: SchemaDefinition, resourceType: string\n       { name: 'deleted', type: 'BOOLEAN', notNull: true, defaultValue: 'false' },\n       { name: 'compartments', type: 'UUID[]', notNull: true },\n       { name: 'projectId', type: 'UUID' },\n+      { name: '__version', type: 'INTEGER' },\n       { name: '_source', type: 'TEXT' },\n       { name: '_profile', type: 'TEXT[]' },\n     ],\n\ndiff --git a/packages/server/src/migrations/schema/index.ts b/packages/server/src/migrations/schema/index.ts\nindex 57a9018af6..fc319ad6fa 100644\n--- a/packages/server/src/migrations/schema/index.ts\n+++ b/packages/server/src/migrations/schema/index.ts\n@@ -91,3 +91,4 @@ export * as v82 from './v82';\n export * as v83 from './v83';\n export * as v84 from './v84';\n export * as v85 from './v85';\n+export * as v86 from './v86';\n\ndiff --git a/packages/server/src/migrations/schema/v86.ts b/packages/server/src/migrations/schema/v86.ts\nnew file mode 100644\nindex 0000000000..76987d7ff4\n--- /dev/null\n+++ b/packages/server/src/migrations/schema/v86.ts\n@@ -0,0 +1,188 @@\n+/*\n+ * This is a generated file\n+ * Do not edit manually.\n+ */\n+\n+import { PoolClient } from 'pg';\n+\n+export async function run(client: PoolClient): Promise<void> {\n+  await client.query('ALTER TABLE IF EXISTS \"Account\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ActivityDefinition\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"AdverseEvent\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"AllergyIntolerance\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Appointment\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"AppointmentResponse\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"AuditEvent\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Basic\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Binary\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"BiologicallyDerivedProduct\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"BodyStructure\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Bundle\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"CapabilityStatement\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"CarePlan\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"CareTeam\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"CatalogEntry\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ChargeItem\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ChargeItemDefinition\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Claim\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ClaimResponse\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ClinicalImpression\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"CodeSystem\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Communication\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"CommunicationRequest\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"CompartmentDefinition\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Composition\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ConceptMap\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Condition\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Consent\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Contract\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Coverage\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"CoverageEligibilityRequest\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query(\n+    'ALTER TABLE IF EXISTS \"CoverageEligibilityResponse\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER'\n+  );\n+  await client.query('ALTER TABLE IF EXISTS \"DetectedIssue\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Device\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"DeviceDefinition\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"DeviceMetric\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"DeviceRequest\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"DeviceUseStatement\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"DiagnosticReport\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"DocumentManifest\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"DocumentReference\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"EffectEvidenceSynthesis\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Encounter\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Endpoint\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"EnrollmentRequest\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"EnrollmentResponse\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"EpisodeOfCare\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"EventDefinition\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Evidence\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"EvidenceVariable\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ExampleScenario\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ExplanationOfBenefit\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"FamilyMemberHistory\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Flag\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Goal\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"GraphDefinition\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Group\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"GuidanceResponse\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"HealthcareService\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ImagingStudy\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Immunization\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ImmunizationEvaluation\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ImmunizationRecommendation\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ImplementationGuide\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"InsurancePlan\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Invoice\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Library\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Linkage\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"List\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Location\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Measure\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"MeasureReport\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Media\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Medication\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"MedicationAdministration\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"MedicationDispense\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"MedicationKnowledge\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"MedicationRequest\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"MedicationStatement\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"MedicinalProduct\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query(\n+    'ALTER TABLE IF EXISTS \"MedicinalProductAuthorization\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER'\n+  );\n+  await client.query(\n+    'ALTER TABLE IF EXISTS \"MedicinalProductContraindication\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER'\n+  );\n+  await client.query('ALTER TABLE IF EXISTS \"MedicinalProductIndication\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"MedicinalProductIngredient\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query(\n+    'ALTER TABLE IF EXISTS \"MedicinalProductInteraction\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER'\n+  );\n+  await client.query(\n+    'ALTER TABLE IF EXISTS \"MedicinalProductManufactured\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER'\n+  );\n+  await client.query('ALTER TABLE IF EXISTS \"MedicinalProductPackaged\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query(\n+    'ALTER TABLE IF EXISTS \"MedicinalProductPharmaceutical\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER'\n+  );\n+  await client.query(\n+    'ALTER TABLE IF EXISTS \"MedicinalProductUndesirableEffect\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER'\n+  );\n+  await client.query('ALTER TABLE IF EXISTS \"MessageDefinition\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"MessageHeader\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"MolecularSequence\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"NamingSystem\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"NutritionOrder\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Observation\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ObservationDefinition\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"OperationDefinition\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"OperationOutcome\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Organization\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"OrganizationAffiliation\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Parameters\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Patient\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"PaymentNotice\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"PaymentReconciliation\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Person\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"PlanDefinition\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Practitioner\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"PractitionerRole\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Procedure\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Provenance\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Questionnaire\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"QuestionnaireResponse\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"RelatedPerson\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"RequestGroup\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ResearchDefinition\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ResearchElementDefinition\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ResearchStudy\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ResearchSubject\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"RiskAssessment\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"RiskEvidenceSynthesis\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Schedule\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"SearchParameter\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ServiceRequest\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Slot\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Specimen\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"SpecimenDefinition\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"StructureDefinition\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"StructureMap\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Subscription\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"SubscriptionStatus\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Substance\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"SubstanceNucleicAcid\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"SubstancePolymer\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"SubstanceProtein\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query(\n+    'ALTER TABLE IF EXISTS \"SubstanceReferenceInformation\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER'\n+  );\n+  await client.query('ALTER TABLE IF EXISTS \"SubstanceSourceMaterial\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"SubstanceSpecification\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"SupplyDelivery\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"SupplyRequest\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Task\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"TerminologyCapabilities\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"TestReport\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"TestScript\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ValueSet\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"VerificationResult\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"VisionPrescription\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Project\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ClientApplication\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"User\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"ProjectMembership\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Bot\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Login\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"PasswordChangeRequest\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"UserSecurityRequest\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"JsonWebKey\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"AccessPolicy\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"UserConfiguration\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"BulkDataExport\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"SmartAppLaunch\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"DomainConfiguration\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"AsyncJob\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+  await client.query('ALTER TABLE IF EXISTS \"Agent\" ADD COLUMN IF NOT EXISTS \"__version\" INTEGER');\n+}\n\ndiff --git a/packages/server/src/workers/reindex.ts b/packages/server/src/workers/reindex.ts\nindex d0738b794f..2003eaf62e 100644\n--- a/packages/server/src/workers/reindex.ts\n+++ b/packages/server/src/workers/reindex.ts\n@@ -15,6 +15,7 @@ import { LongJob } from './long-job';\n export type ReindexJobData = {\n   readonly asyncJob: AsyncJob;\n   readonly resourceTypes: ResourceType[];\n+  readonly maxResourceVersion?: number;\n   readonly cursor?: string;\n   readonly endTimestamp: string;\n   readonly startTime: number;\n@@ -177,7 +178,7 @@ function shouldLogProgress(result: ReindexResult): boolean {\n  * @returns The result of reindexing the next page of results.\n  */\n async function processPage(job: Job<ReindexJobData>): Promise<ReindexResult> {\n-  const { resourceTypes, count } = job.data;\n+  const { resourceTypes, count, maxResourceVersion } = job.data;\n   const resourceType = resourceTypes[0];\n \n   const searchRequest = searchRequestForNextPage(job);\n@@ -187,7 +188,7 @@ async function processPage(job: Job<ReindexJobData>): Promise<ReindexResult> {\n   try {\n     const systemRepo = getSystemRepo();\n     await systemRepo.withTransaction(async (conn) => {\n-      const bundle = await systemRepo.search(searchRequest);\n+      const bundle = await systemRepo.search(searchRequest, { maxResourceVersion });\n       if (bundle.entry?.length) {\n         const resources = bundle.entry.map((e) => e.resource as WithId<Resource>);\n         await systemRepo.reindexResources(conn, resources);\n@@ -310,7 +311,8 @@ async function addReindexJobData(job: ReindexJobData): Promise<Job<ReindexJobDat\n export async function addReindexJob(\n   resourceTypes: ResourceType[],\n   job: AsyncJob,\n-  searchFilter?: SearchRequest\n+  searchFilter?: SearchRequest,\n+  maxResourceVersion?: number\n ): Promise<Job<ReindexJobData>> {\n   const { requestId, traceId } = getRequestContext();\n   const endTimestamp = new Date(Date.now() + 1000 * 60 * 5).toISOString(); // Five minutes in the future\n@@ -321,6 +323,7 @@ export async function addReindexJob(\n     asyncJob: job,\n     startTime: Date.now(),\n     searchFilter,\n+    maxResourceVersion,\n     results: Object.create(null),\n     requestId,\n     traceId,\n",
    "test_patch": "diff --git a/packages/server/src/admin/super.test.ts b/packages/server/src/admin/super.test.ts\nindex f0d2eb1429..291112bcc5 100644\n--- a/packages/server/src/admin/super.test.ts\n+++ b/packages/server/src/admin/super.test.ts\n@@ -12,7 +12,7 @@ import { MedplumServerConfig } from '../config/types';\n import { AuthenticatedRequestContext } from '../context';\n import * as database from '../database';\n import { AsyncJobExecutor } from '../fhir/operations/utils/asyncjobexecutor';\n-import { getSystemRepo } from '../fhir/repo';\n+import { getSystemRepo, Repository } from '../fhir/repo';\n import { globalLogger } from '../logger';\n import { generateAccessToken } from '../oauth/keys';\n import { requestContextStore } from '../request-context-store';\n@@ -315,7 +315,11 @@ describe('Super Admin routes', () => {\n     expect(res.status).toBe(400);\n   });\n \n-  test('Reindex with respond-async', async () => {\n+  test.each([\n+    ['outdated', undefined, Repository.VERSION - 1],\n+    ['specific', '0', 0],\n+    ['all', undefined, undefined],\n+  ])('Reindex with %s %s', async (reindexType, maxResourceVersion, expectedMaxResourceVersion) => {\n     const queue = getReindexQueue() as any;\n     queue.add.mockClear();\n \n@@ -326,6 +330,8 @@ describe('Super Admin routes', () => {\n       .type('json')\n       .send({\n         resourceType: 'PaymentNotice',\n+        reindexType,\n+        maxResourceVersion,\n       });\n \n     expect(res.status).toStrictEqual(202);\n@@ -336,10 +342,39 @@ describe('Super Admin routes', () => {\n         resourceTypes: ['PaymentNotice'],\n       })\n     );\n+    expect(queue.add.mock.calls[0][1].maxResourceVersion).toStrictEqual(expectedMaxResourceVersion);\n     await withTestContext(() => new ReindexJob().execute({ data: queue.add.mock.calls[0][1] } as Job));\n     await waitForAsyncJob(res.headers['content-location'], app, adminAccessToken);\n   });\n \n+  test.each([\n+    ['foobar', undefined, 'reindexType must be \"outdated\", \"all\", or \"specific\"'],\n+    ['outdated', '0', 'maxResourceVersion should only be specified when reindexType is \"specific\"'],\n+    ['all', '0', 'maxResourceVersion should only be specified when reindexType is \"specific\"'],\n+    ['specific', undefined, `maxResourceVersion must be an integer from 0 to ${Repository.VERSION - 1}`],\n+    ['specific', -1, `maxResourceVersion must be an integer from 0 to ${Repository.VERSION - 1}`],\n+    ['specific', Repository.VERSION, `maxResourceVersion must be an integer from 0 to ${Repository.VERSION - 1}`],\n+    ['specific', '1.1', `maxResourceVersion must be an integer from 0 to ${Repository.VERSION - 1}`],\n+    ['specific', '9999999', `maxResourceVersion must be an integer from 0 to ${Repository.VERSION - 1}`],\n+  ])('Reindex with invalid args %s %s', async (reindexType, maxResourceVersion, expectedError) => {\n+    const queue = getReindexQueue() as any;\n+    queue.add.mockClear();\n+\n+    const res = await request(app)\n+      .post('/admin/super/reindex')\n+      .set('Authorization', 'Bearer ' + adminAccessToken)\n+      .set('Prefer', 'respond-async')\n+      .type('json')\n+      .send({\n+        resourceType: 'PaymentNotice',\n+        reindexType,\n+        maxResourceVersion,\n+      });\n+\n+    expect(res.status).toBe(400);\n+    expect(res.body.issue[0].details.text).toBe(expectedError);\n+  });\n+\n   test('Reindex with multiple resource types', async () => {\n     const queue = getReindexQueue() as any;\n     queue.add.mockClear();\n@@ -351,6 +386,7 @@ describe('Super Admin routes', () => {\n       .type('json')\n       .send({\n         resourceType: 'PaymentNotice,MedicinalProductManufactured,BiologicallyDerivedProduct',\n+        reindexType: 'outdated',\n       });\n \n     expect(res.status).toStrictEqual(202);\n\ndiff --git a/packages/server/src/fhir/repo.test.ts b/packages/server/src/fhir/repo.test.ts\nindex c56c0a2a6b..8a74e6e5c0 100644\n--- a/packages/server/src/fhir/repo.test.ts\n+++ b/packages/server/src/fhir/repo.test.ts\n@@ -41,6 +41,7 @@ import { DatabaseMode, getDatabasePool } from '../database';\n import { bundleContains, createTestProject, withTestContext } from '../test.setup';\n import { getRepoForLogin } from './accesspolicy';\n import { getSystemRepo, Repository, setTypedPropertyValue } from './repo';\n+import { SelectQuery } from './sql';\n \n jest.mock('hibp');\n \n@@ -1329,6 +1330,46 @@ describe('FHIR Repo', () => {\n \n       await expect(repo.createResource<Patient>(patient)).resolves.toBeDefined();\n     }));\n+\n+  test('__version column', async () => {\n+    const { repo } = await createTestProject({ withRepo: true, superAdmin: true });\n+\n+    await withTestContext(async () => {\n+      const patient = await repo.createResource<Patient>({\n+        resourceType: 'Patient',\n+        name: [{ given: ['Alice'], family: 'Smith' }],\n+      });\n+\n+      const versionQuery = new SelectQuery('Patient').column('__version').where('id', '=', patient.id);\n+\n+      const client = repo.getDatabaseClient(DatabaseMode.WRITER);\n+      expect((await versionQuery.execute(client))[0].__version).toStrictEqual(Repository.VERSION);\n+\n+      // Simulate the resource being at an older version\n+      const OLDER_VERSION = Repository.VERSION - 1;\n+      await client.query('UPDATE \"Patient\" SET __version = $1 WHERE id = $2', [OLDER_VERSION, patient.id]);\n+      expect((await versionQuery.execute(client))[0].__version).toStrictEqual(OLDER_VERSION);\n+\n+      // noop update should not change the version\n+      await repo.updateResource<Patient>(patient);\n+      expect((await versionQuery.execute(client))[0].__version).toStrictEqual(OLDER_VERSION);\n+\n+      // meaningful update should change the version\n+      await repo.updateResource<Patient>({\n+        ...patient,\n+        name: [{ given: ['Bob'], family: 'Smith' }],\n+      });\n+      expect((await versionQuery.execute(client))[0].__version).toStrictEqual(Repository.VERSION);\n+\n+      // Simulate the resource being at an older version\n+      await client.query('UPDATE \"Patient\" SET __version = $1 WHERE id = $2', [OLDER_VERSION, patient.id]);\n+      expect((await versionQuery.execute(client))[0].__version).toStrictEqual(OLDER_VERSION);\n+\n+      // reindex SHOULD change the version\n+      await repo.reindexResource('Patient', patient.id);\n+      expect((await versionQuery.execute(client))[0].__version).toStrictEqual(Repository.VERSION);\n+    });\n+  });\n });\n \n function shuffleString(s: string): string {\n\ndiff --git a/packages/server/src/fhir/search.test.ts b/packages/server/src/fhir/search.test.ts\nindex a8c578faa0..e7763713ac 100644\n--- a/packages/server/src/fhir/search.test.ts\n+++ b/packages/server/src/fhir/search.test.ts\n@@ -55,6 +55,8 @@ import { MedplumServerConfig } from '../config/types';\n import { bundleContains, createTestProject, withTestContext } from '../test.setup';\n import { getSystemRepo, Repository } from './repo';\n import { clampEstimateCount } from './search';\n+import { DatabaseMode } from '../database';\n+import { SelectQuery } from './sql';\n \n jest.mock('hibp');\n \n@@ -4877,5 +4879,66 @@ describe('FHIR Search', () => {\n           total: 0,\n         });\n       }));\n+\n+    test('maxResourceVersion', () =>\n+      withTestContext(async () => {\n+        const project: string = (await systemRepo.createResource<Project>({ resourceType: 'Project' })).id;\n+\n+        const patient1 = await systemRepo.createResource<Patient>({\n+          resourceType: 'Patient',\n+          name: [{ given: ['Alice'], family: 'Smith' }],\n+          meta: {\n+            project,\n+          },\n+        });\n+\n+        const patient2 = await systemRepo.createResource<Patient>({\n+          resourceType: 'Patient',\n+          name: [{ given: ['Bob'], family: 'Smith' }],\n+          meta: {\n+            project,\n+          },\n+        });\n+\n+        const getVersionQuery = (id: string): SelectQuery =>\n+          new SelectQuery('Patient').column('__version').where('id', '=', id);\n+\n+        const client = systemRepo.getDatabaseClient(DatabaseMode.WRITER);\n+        const OLDER_VERSION = Repository.VERSION - 1;\n+        await client.query('UPDATE \"Patient\" SET __version = $1 WHERE id = $2', [OLDER_VERSION, patient1.id]);\n+        expect((await getVersionQuery(patient1.id).execute(client))[0].__version).toStrictEqual(OLDER_VERSION);\n+        expect((await getVersionQuery(patient2.id).execute(client))[0].__version).toStrictEqual(Repository.VERSION);\n+\n+        const bundle1 = await systemRepo.search({\n+          resourceType: 'Patient',\n+          filters: [\n+            {\n+              code: '_project',\n+              operator: Operator.EQUALS,\n+              value: project,\n+            },\n+          ],\n+        });\n+        expect(bundle1.entry?.length).toStrictEqual(2);\n+        const ids = bundle1.entry?.map((e) => e.resource?.id);\n+        expect(ids).toContain(patient1.id);\n+        expect(ids).toContain(patient2.id);\n+\n+        const bundle2 = await systemRepo.search(\n+          {\n+            resourceType: 'Patient',\n+            filters: [\n+              {\n+                code: '_project',\n+                operator: Operator.EQUALS,\n+                value: project,\n+              },\n+            ],\n+          },\n+          { maxResourceVersion: OLDER_VERSION }\n+        );\n+        expect(bundle2.entry?.length).toStrictEqual(1);\n+        expect(bundle2.entry?.[0]?.resource?.id).toStrictEqual(patient1.id);\n+      }));\n   });\n });\n\ndiff --git a/packages/server/src/migrations/migrate.test.ts b/packages/server/src/migrations/migrate.test.ts\nindex 91c797c20f..8f879b3b73 100644\n--- a/packages/server/src/migrations/migrate.test.ts\n+++ b/packages/server/src/migrations/migrate.test.ts\n@@ -64,6 +64,10 @@ describe('Generator', () => {\n           name: 'projectId',\n           type: 'UUID',\n         },\n+        {\n+          name: '__version',\n+          type: 'INTEGER',\n+        },\n         {\n           name: '_source',\n           type: 'TEXT',\n\ndiff --git a/packages/server/src/workers/reindex.test.ts b/packages/server/src/workers/reindex.test.ts\nindex 29b27b40e7..b52f8a16e3 100644\n--- a/packages/server/src/workers/reindex.test.ts\n+++ b/packages/server/src/workers/reindex.test.ts\n@@ -514,6 +514,88 @@ describe('Reindex Worker', () => {\n       });\n     }));\n \n+  const CURRENT_VERSION = Repository.VERSION;\n+  const OLDER_VERSION = CURRENT_VERSION - 1;\n+\n+  test.each([\n+    [OLDER_VERSION, 1],\n+    [CURRENT_VERSION, 2],\n+    [undefined, 2],\n+  ])('Reindex with maxResourceVersion %s', (maxResourceVersion, expectedCount) =>\n+    withTestContext(async () => {\n+      const systemRepo = getSystemRepo();\n+\n+      let asyncJob = await systemRepo.createResource<AsyncJob>({\n+        resourceType: 'AsyncJob',\n+        status: 'accepted',\n+        requestTime: new Date().toISOString(),\n+        request: '/admin/super/reindex',\n+      });\n+\n+      const idSystem = 'http://example.com/mrn';\n+      const mrn = randomUUID();\n+\n+      const outdatedPatient = await systemRepo.createResource<Patient>({\n+        resourceType: 'Patient',\n+        identifier: [{ system: idSystem, value: mrn }],\n+      });\n+      const currentPatient = await systemRepo.createResource<Patient>({\n+        resourceType: 'Patient',\n+        identifier: [{ system: idSystem, value: mrn }],\n+      });\n+\n+      const client = repo.getDatabaseClient(DatabaseMode.WRITER);\n+      const getVersionQuery = (id: string[]): SelectQuery =>\n+        new SelectQuery('Patient').column('id').column('__version').where('id', 'IN', id);\n+      await client.query('UPDATE \"Patient\" SET __version = $1 WHERE id = $2', [OLDER_VERSION, outdatedPatient.id]);\n+      const beforeResults = await getVersionQuery([outdatedPatient.id, currentPatient.id]).execute(client);\n+      expect(beforeResults).toHaveLength(2);\n+      expect(beforeResults).toMatchObject([\n+        { id: outdatedPatient.id, __version: OLDER_VERSION },\n+        { id: currentPatient.id, __version: Repository.VERSION },\n+      ]);\n+\n+      const startTime = Date.now();\n+      const endTimestamp = new Date(startTime + 1000 * 60 * 5).toISOString(); // Five minutes in the future\n+      const job: Job<ReindexJobData> = {\n+        id: '1',\n+        data: {\n+          resourceTypes: ['Patient'],\n+          asyncJob,\n+          startTime,\n+          endTimestamp,\n+          maxResourceVersion,\n+          searchFilter: parseSearchRequest(`Patient?identifier=${idSystem}|${mrn}`),\n+          results: {},\n+        },\n+      } as unknown as Job<ReindexJobData>;\n+\n+      await new ReindexJob().execute(job);\n+\n+      const afterResults = await getVersionQuery([outdatedPatient.id, currentPatient.id]).execute(client);\n+      expect(afterResults).toHaveLength(2);\n+      expect(afterResults).toMatchObject([\n+        { id: outdatedPatient.id, __version: CURRENT_VERSION },\n+        { id: currentPatient.id, __version: CURRENT_VERSION },\n+      ]);\n+\n+      asyncJob = await systemRepo.readResource('AsyncJob', asyncJob.id as string);\n+      expect(asyncJob.status).toStrictEqual('completed');\n+      expect(asyncJob.output).toMatchObject<Parameters>({\n+        resourceType: 'Parameters',\n+        parameter: [\n+          {\n+            name: 'result',\n+            part: expect.arrayContaining([\n+              expect.objectContaining({ name: 'resourceType', valueCode: 'Patient' }),\n+              expect.objectContaining({ name: 'count', valueInteger: expectedCount }),\n+            ]),\n+          },\n+        ],\n+      });\n+    })\n+  );\n+\n   test('Populates User.projectId column in database', () =>\n     withTestContext(async () => {\n       const queue = getReindexQueue() as any;\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-6012",
    "pr_id": 6012,
    "issue_id": 1928,
    "repo": "medplum/medplum",
    "problem_statement": "$set-accounts fhir operation\nRight now, if you update `Patient.meta.accounts`, it does not automatically update the `accounts` element for all resources in the compartment. However, any time another resource in the compartment is updated, the `accounts` field is updated at that time. \n\nThis issue proposes a new  operation, `Patient/[id]/$set-accounts`, which would update the `accounts` for _all_ resources within a compartment. Because this could potentially take some time, this should be considered an asynchronous background job. ",
    "issue_word_count": 80,
    "test_files_count": 1,
    "non_test_files_count": 3,
    "pr_changed_files": [
      "packages/docs/docs/api/fhir/operations/patient-set-accounts.md",
      "packages/server/src/fhir/operations/patientsetaccounts.test.ts",
      "packages/server/src/fhir/operations/patientsetaccounts.ts",
      "packages/server/src/fhir/routes.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/operations/patientsetaccounts.test.ts"
    ],
    "base_commit": "25c5743f4ee639b89f2205c66583b1d78bb261f2",
    "head_commit": "5fdeb6a2b51d47d28618566bea7f78bc3bb0afcc",
    "repo_url": "https://github.com/medplum/medplum/pull/6012",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/6012",
    "dockerfile": "",
    "pr_merged_at": "2025-03-03T21:17:03.000Z",
    "patch": "diff --git a/packages/docs/docs/api/fhir/operations/patient-set-accounts.md b/packages/docs/docs/api/fhir/operations/patient-set-accounts.md\nnew file mode 100644\nindex 0000000000..10cb1d08e3\n--- /dev/null\n+++ b/packages/docs/docs/api/fhir/operations/patient-set-accounts.md\n@@ -0,0 +1,72 @@\n+---\n+sidebar_position: 5.1\n+---\n+\n+# Patient $set-accounts Operation\n+\n+Medplum implements a custom `$set-accounts` operation for Patient resources to manage account references. __This is the recommended way to manage account references for patients__.\n+\n+This operation sets the Patient's _meta.accounts_ references and propogates them to the resources in that patient's compartment. This is useful when you need to ensure consistent _meta.accounts_ access across all resources related to a patient.\n+\n+:::warning\n+\n+This operation will only update the first 1,000 resources in the patient's compartment.\n+\n+:::\n+\n+For example, when this operation is used to add a new organization to a patient's _meta.accounts_, it will update both the patient and all resources in the patient's compartment to include that organization in each of their _meta.accounts_ list. Then, by updating the references in _meta.accounts_, each resource's _meta.compartment_ will also be refreshed to include the references in _meta.accounts_.\n+\n+:::note\n+\n+Resources in a patient's compartment are defined by the [FHIR Patient CompartmentDefinition](https://hl7.org/fhir/R4/compartmentdefinition-patient.html). This includes resources where the patient is the _subject_, as well as resources that are directly linked to the patient through specific references (_performer_, _author_, _participant_, etc.).\n+\n+:::\n+\n+## Invoke the `$set-accounts` operation\n+\n+```\n+POST [base]/R4/Patient/<id>/$set-accounts\n+```\n+\n+### Input\n+The input is a [FHIR Parameters](/docs/api/fhir/resources/parameters) resource containing:\n+- `accounts` a reference to set in each resource's _meta.accounts_\n+\n+Example request payload:\n+```json\n+{\n+  \"resourceType\": \"Parameters\",\n+  \"parameter\": [\n+    {\n+      \"name\": \"accounts\",\n+      \"valueReference\": {\n+        \"reference\": \"Organization/<organization-id>\"\n+      }\n+    },\n+    {\n+      \"name\": \"accounts\",\n+      \"valueReference\": {\n+        \"reference\": \"Practitioner/<practitioner-id>\"\n+      }\n+    }\n+  ]\n+}\n+```\n+\n+### Output\n+\n+The output is a [FHIR Parameters](/docs/api/fhir/resources/parameters) resource containing:\n+- `resourcesUpdated` The number of resources that were updated\n+\n+Example response if patient has 3 resources in their compartment:\n+```json\n+{\n+  \"resourceType\": \"Parameters\",\n+  \"parameter\": [\n+    {\n+      \"name\": \"resourcesUpdated\",\n+      \"valueInteger\": 3\n+    }\n+  ]\n+}\n+```\n\\ No newline at end of file\n\ndiff --git a/packages/server/src/fhir/operations/patientsetaccounts.ts b/packages/server/src/fhir/operations/patientsetaccounts.ts\nnew file mode 100644\nindex 0000000000..a7df77a201\n--- /dev/null\n+++ b/packages/server/src/fhir/operations/patientsetaccounts.ts\n@@ -0,0 +1,104 @@\n+import { allOk, badRequest, forbidden } from '@medplum/core';\n+import { FhirRequest, FhirResponse } from '@medplum/fhir-router';\n+import { Patient, Reference, OperationDefinition } from '@medplum/fhirtypes';\n+import { getAuthenticatedContext } from '../../context';\n+import { getPatientEverything } from './patienteverything';\n+import { parseInputParameters, buildOutputParameters } from './utils/parameters';\n+\n+const operation: OperationDefinition = {\n+  resourceType: 'OperationDefinition',\n+  id: 'patient-set-accounts',\n+  name: 'SetAccounts',\n+  status: 'active',\n+  kind: 'operation',\n+  code: 'set-accounts',\n+  description: \"Updates account references for all resources in the patient's compartment\",\n+  resource: ['Patient'],\n+  system: false,\n+  type: false,\n+  instance: true,\n+  parameter: [\n+    {\n+      // Input parameter for the accounts array\n+      use: 'in',\n+      name: 'accounts',\n+      type: 'Reference',\n+      min: 0,\n+      max: '*',\n+      documentation: 'List of account references to set',\n+    },\n+    {\n+      // Output parameter for number of resources updated\n+      use: 'out',\n+      name: 'resourcesUpdated',\n+      type: 'integer',\n+      min: 1,\n+      max: '1',\n+      documentation: 'Number of resources that were updated',\n+    },\n+  ],\n+};\n+\n+export interface PatientSetAccountsParameters {\n+  accounts: Reference[];\n+}\n+\n+/**\n+ * Handles the Patient $set-accounts operation.\n+ * This operation updates the account reference for all resources in the patient compartment.\n+ * The operation only updates resources from the getPatientEverything bundle that are not\n+ * included in the patient's compartment, but are linked to the patient through a reference.\n+ *\n+ * Note: the operation is currently capped at 1000 resources in the patient's compartment.\n+ * @param req - The FHIR request.\n+ * @returns The FHIR response.\n+ */\n+export async function patientSetAccountsHandler(req: FhirRequest): Promise<FhirResponse> {\n+  const { id } = req.params;\n+  if (!id) {\n+    return [badRequest('Must specify Patient ID')];\n+  }\n+\n+  const params = parseInputParameters<PatientSetAccountsParameters>(operation, req);\n+  const ctx = getAuthenticatedContext();\n+\n+  const isSuperAdmin = ctx.repo.isSuperAdmin();\n+  if (!ctx.repo.isProjectAdmin() && !isSuperAdmin) {\n+    return [forbidden];\n+  }\n+\n+  const patient = await ctx.repo.readResource<Patient>('Patient', id);\n+  const bundle = await getPatientEverything(ctx.repo, patient);\n+  const accounts = params.accounts;\n+\n+  // step 1: update the patient resource with the new accounts\n+  patient.meta = {\n+    ...patient.meta,\n+    accounts: accounts,\n+    account: accounts?.[0],\n+  };\n+\n+  await ctx.repo.updateResource(patient);\n+\n+  // step 2: update the resources in the patient compartment to trigger meta.accounts refresh\n+  let count = 1;\n+  for (const entry of bundle.entry ?? []) {\n+    if (entry.search?.mode === 'match') {\n+      const resource = entry.resource;\n+      if (resource && resource.resourceType !== 'Patient') {\n+        delete resource.meta?.accounts;\n+        delete resource.meta?.account;\n+\n+        await ctx.repo.updateResource(resource);\n+        count++;\n+      }\n+    }\n+  }\n+\n+  return [\n+    allOk,\n+    buildOutputParameters(operation, {\n+      resourcesUpdated: count,\n+    }),\n+  ];\n+}\n\ndiff --git a/packages/server/src/fhir/routes.ts b/packages/server/src/fhir/routes.ts\nindex b6a8d77be6..96dba0efc6 100644\n--- a/packages/server/src/fhir/routes.ts\n+++ b/packages/server/src/fhir/routes.ts\n@@ -47,6 +47,7 @@ import { sendOutcome } from './outcomes';\n import { ResendSubscriptionsOptions } from './repo';\n import { sendFhirResponse } from './response';\n import { smartConfigurationHandler, smartStylingHandler } from './smart';\n+import { patientSetAccountsHandler } from './operations/patientsetaccounts';\n \n export const fhirRouter = Router();\n \n@@ -256,6 +257,9 @@ function initInternalFhirRouter(): FhirRouter {\n   router.add('GET', '/Patient/:id/$summary', patientSummaryHandler);\n   router.add('POST', '/Patient/:id/$summary', patientSummaryHandler);\n \n+  // Patient $set-accounts operation\n+  router.add('POST', '/Patient/:id/$set-accounts', patientSetAccountsHandler);\n+\n   // Patient $ccda-export operation\n   router.add('GET', '/Patient/:id/$ccda-export', ccdaExportHandler);\n \n",
    "test_patch": "diff --git a/packages/server/src/fhir/operations/patientsetaccounts.test.ts b/packages/server/src/fhir/operations/patientsetaccounts.test.ts\nnew file mode 100644\nindex 0000000000..5733e4b50d\n--- /dev/null\n+++ b/packages/server/src/fhir/operations/patientsetaccounts.test.ts\n@@ -0,0 +1,220 @@\n+import { createReference } from '@medplum/core';\n+import { Bundle, Observation, Organization, Patient, DiagnosticReport } from '@medplum/fhirtypes';\n+import express from 'express';\n+import request from 'supertest';\n+import { initApp, shutdownApp } from '../../app';\n+import { loadTestConfig } from '../../config/loader';\n+import { initTestAuth } from '../../test.setup';\n+import { patientSetAccountsHandler } from './patientsetaccounts';\n+\n+const app = express();\n+let accessToken: string;\n+let observation: Observation;\n+let diagnosticReport: DiagnosticReport;\n+let patient: Patient;\n+let organization1: Organization;\n+let organization2: Organization;\n+\n+describe('Patient Set Accounts Operation', () => {\n+  beforeAll(async () => {\n+    const config = await loadTestConfig();\n+    await initApp(app, config);\n+    accessToken = await initTestAuth({ superAdmin: true });\n+\n+    // Create organization\n+    const orgRes = await request(app)\n+      .post('/fhir/R4/Organization')\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({ resourceType: 'Organization' });\n+    expect(orgRes.status).toBe(201);\n+    organization1 = orgRes.body as Organization;\n+\n+    const orgRes2 = await request(app)\n+      .post('/fhir/R4/Organization')\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({ resourceType: 'Organization' });\n+    expect(orgRes2.status).toBe(201);\n+    organization2 = orgRes2.body as Organization;\n+\n+    // Create patient\n+    const res1 = await request(app)\n+      .post('/fhir/R4/Patient')\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        resourceType: 'Patient',\n+        name: [{ given: ['Alice'], family: 'Smith' }],\n+      } satisfies Patient);\n+    expect(res1.status).toBe(201);\n+    patient = res1.body as Patient;\n+\n+    // Create observation\n+    const res2 = await request(app)\n+      .post('/fhir/R4/Observation')\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        resourceType: 'Observation',\n+        status: 'final',\n+        code: {\n+          coding: [\n+            {\n+              system: 'http://loinc.org',\n+              code: 'test-code',\n+            },\n+          ],\n+        },\n+        subject: createReference(patient),\n+      } satisfies Observation);\n+    expect(res2.status).toBe(201);\n+    observation = res2.body as Observation;\n+\n+    //Create a diagnostic report\n+    const res3 = await request(app)\n+      .post('/fhir/R4/DiagnosticReport')\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        resourceType: 'DiagnosticReport',\n+        subject: createReference(patient),\n+        status: 'final',\n+        code: {\n+          coding: [\n+            {\n+              system: 'http://loinc.org',\n+              code: 'test-code',\n+            },\n+          ],\n+        },\n+      } satisfies DiagnosticReport);\n+    expect(res3.status).toBe(201);\n+    diagnosticReport = res3.body as DiagnosticReport;\n+  });\n+\n+  afterAll(async () => {\n+    await shutdownApp();\n+  });\n+\n+  test('Happy path', async () => {\n+    // Execute the operation adding the organization to the patient's compartment\n+    const res3 = await request(app)\n+      .post(`/fhir/R4/Patient/${patient.id}/$set-accounts`)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        resourceType: 'Parameters',\n+        parameter: [\n+          {\n+            name: 'accounts',\n+            valueReference: createReference(organization1),\n+          },\n+          {\n+            name: 'accounts',\n+            valueReference: createReference(organization2),\n+          },\n+        ],\n+      });\n+    expect(res3.status).toBe(200);\n+    const result = res3.body;\n+    expect(result.parameter?.[0].name).toBe('resourcesUpdated');\n+    expect(result.parameter?.[0].valueInteger).toBe(3); // Observation and DiagnosticReport\n+\n+    //check if the accounts are updated on the patient\n+    const res4 = await request(app)\n+      .get(`/fhir/R4/Patient/${patient.id}`)\n+      .set('Authorization', 'Bearer ' + accessToken);\n+    expect(res4.status).toBe(200);\n+    const updatedPatient = res4.body as Patient;\n+    expect(updatedPatient.meta?.accounts).toBeDefined();\n+    expect(updatedPatient.meta?.accounts?.[0].reference).toBe(`Organization/${organization1.id}`);\n+    expect(updatedPatient.meta?.accounts?.[1].reference).toBe(`Organization/${organization2.id}`);\n+\n+    // Check if accounts are updated on the observation\n+    const res5 = await request(app)\n+      .get(`/fhir/R4/Observation/${observation.id}`)\n+      .set('Authorization', 'Bearer ' + accessToken);\n+    expect(res5.status).toBe(200);\n+    const updatedObservation = res5.body as Observation;\n+    expect(updatedObservation.meta?.accounts).toBeDefined();\n+    expect(updatedObservation.meta?.accounts?.[0].reference).toBe(`Organization/${organization1.id}`);\n+    expect(updatedObservation.meta?.accounts?.[1].reference).toBe(`Organization/${organization2.id}`);\n+\n+    // Check if accounts are updated on the diagnostic report\n+    const res6 = await request(app)\n+      .get(`/fhir/R4/DiagnosticReport/${diagnosticReport.id}`)\n+      .set('Authorization', 'Bearer ' + accessToken);\n+    expect(res6.status).toBe(200);\n+    const updatedDiagnosticReport = res6.body as DiagnosticReport;\n+    expect(updatedDiagnosticReport.meta?.accounts).toBeDefined();\n+    expect(updatedDiagnosticReport.meta?.accounts?.[0].reference).toBe(`Organization/${organization1.id}`);\n+    expect(updatedDiagnosticReport.meta?.accounts?.[1].reference).toBe(`Organization/${organization2.id}`);\n+  });\n+\n+  test(\"Make sure resources returned in $patient-everything that are NOT in the patient's compartment are not updated\", async () => {\n+    const res7 = await request(app)\n+      .post(`/fhir/R4/Patient/${patient.id}/$set-accounts`)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        resourceType: 'Parameters',\n+        parameter: [\n+          {\n+            name: 'accounts',\n+            valueReference: createReference(organization1),\n+          },\n+          {\n+            name: 'accounts',\n+            valueReference: createReference(organization2),\n+          },\n+        ],\n+      });\n+    expect(res7.status).toBe(200);\n+    const numberResourcesUpdated = res7.body.parameter?.[0].valueInteger;\n+\n+    const res = await request(app)\n+      .get(`/fhir/R4/Patient/${patient.id}/$everything`)\n+      .set('Authorization', 'Bearer ' + accessToken);\n+    expect(res.status).toBe(200);\n+    const everything = res.body as Bundle;\n+    const allResources = everything.entry?.length ?? 0;\n+    const resourcesNotInCompartment = everything.entry?.filter((entry) => entry?.search?.mode !== 'match').length ?? 0;\n+\n+    //Number of resources updated only includes the ones in the compartment, not other resources returned in $patient-everything\n+    expect(numberResourcesUpdated).toBe(allResources - resourcesNotInCompartment);\n+  });\n+\n+  test('Patient not found', async () => {\n+    const res = await request(app)\n+      .post(`/fhir/R4/Patient/not-found/$set-accounts`)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        resourceType: 'Parameters',\n+        parameter: [\n+          {\n+            name: 'accounts',\n+            valueReference: createReference(organization1),\n+          },\n+        ],\n+      });\n+    expect(res.status).toBe(404);\n+  });\n+\n+  test('patientSetAccountsHandler() called without an id', async () => {\n+    const res = await patientSetAccountsHandler({\n+      params: { id: '' },\n+      method: 'POST',\n+      url: '/fhir/R4/Patient/$set-accounts',\n+      pathname: '/fhir/R4/Patient/$set-accounts',\n+      body: {},\n+      query: {},\n+    });\n+    expect(res[0].issue?.[0]?.details?.text).toBe('Must specify Patient ID');\n+  });\n+\n+  test('Non admin user trying to set accounts', async () => {\n+    accessToken = await initTestAuth();\n+    const res = await request(app)\n+      .post(`/fhir/R4/Patient/${patient.id}/$set-accounts`)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        resourceType: 'Parameters',\n+        parameter: [],\n+      });\n+    expect(res.status).toBe(403);\n+  });\n+});\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5977",
    "pr_id": 5977,
    "issue_id": 5967,
    "repo": "medplum/medplum",
    "problem_statement": "Error when trying to edit a MedicationRequest with US Core profile\n![Image](https://github.com/user-attachments/assets/96e6f3f9-f3ca-4549-8482-cef1896de891)\n\n```json\n{\n  \"resourceType\": \"MedicationRequest\",\n  \"status\": \"active\",\n  \"intent\": \"order\",\n  \"medicationCodeableConcept\": {\n    \"coding\": [\n      {\n        \"system\": \"http://www.nlm.nih.gov/research/umls/rxnorm\",\n        \"code\": \"209459\",\n        \"display\": \"acetaminophen 500 MG Oral Tablet [Tylenol]\"\n      }\n    ]\n  },\n  \"subject\": {\n    \"reference\": \"Patient/0194fd4f-fcf3-7728-b0dc-3a696473c96c\",\n    \"display\": \"Alice Jones Newman\"\n  },\n  \"authoredOn\": \"2025-02-13T03:42:00.000Z\",\n  \"requester\": {\n    \"reference\": \"Practitioner/0194fd57-c17f-7388-8cd9-7c604f223908\",\n    \"display\": \"Dr Albert Davis\"\n  },\n  \"recorder\": {\n    \"reference\": \"Practitioner/0194fd57-c17f-7388-8cd9-7c604f223908\",\n    \"display\": \"Dr Albert Davis\"\n  },\n  \"dosageInstruction\": [\n    {\n      \"route\": {\n        \"coding\": [\n          {\n            \"code\": \"Injectable\",\n            \"display\": \"Injectable\"\n          }\n        ]\n      },\n      \"timing\": {\n        \"repeat\": {\n          \"period\": 1,\n          \"periodUnit\": \"d\"\n        }\n      }\n    }\n  ],\n  \"meta\": {\n    \"profile\": [\n      \"http://hl7.org/fhir/us/core/StructureDefinition/us-core-medicationrequest\"\n    ],\n    \"versionId\": \"0194fd69-5f72-74e0-b980-6ac97880ff5c\",\n    \"lastUpdated\": \"2025-02-13T03:45:28.946Z\",\n    \"author\": {\n      \"reference\": \"Practitioner/fd5abf62-a96a-47db-8073-48d819b45e84\",\n      \"display\": \"Cody Ebberson\"\n    },\n    \"project\": \"b7e3e4e3-4a36-4243-955e-9476594a3a03\",\n    \"compartment\": [\n      {\n        \"reference\": \"Project/b7e3e4e3-4a36-4243-955e-9476594a3a03\"\n      },\n      {\n        \"reference\": \"Patient/0194fd4f-fcf3-7728-b0dc-3a696473c96c\"\n      }\n    ]\n  },\n  \"id\": \"0194fd69-5f71-7117-a4d3-5bd8c777779c\"\n}\n```",
    "issue_word_count": 169,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/core/src/default-values.test.ts",
      "packages/core/src/default-values.ts"
    ],
    "pr_changed_test_files": [
      "packages/core/src/default-values.test.ts"
    ],
    "base_commit": "1bb9cf8e8549f6c89c4ad9e5188f18879ab5f689",
    "head_commit": "08b2a5b13d31669784475c12da6816879c46bba4",
    "repo_url": "https://github.com/medplum/medplum/pull/5977",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5977",
    "dockerfile": "",
    "pr_merged_at": "2025-02-14T23:38:29.000Z",
    "patch": "diff --git a/packages/core/src/default-values.ts b/packages/core/src/default-values.ts\nindex 2957a37bb1..dd40dbb6a8 100644\n--- a/packages/core/src/default-values.ts\n+++ b/packages/core/src/default-values.ts\n@@ -57,27 +57,6 @@ export function applyDefaultValuesToElement(\n   return existingValue;\n }\n \n-export function applyDefaultValuesToElementWithVisitor(\n-  existingValue: any,\n-  path: string,\n-  element: InternalSchemaElement,\n-  elements: Record<string, InternalSchemaElement>,\n-  schema: InternalTypeSchema\n-): any {\n-  const inputValue: object = existingValue ?? Object.create(null);\n-\n-  const [parentPath, key] = splitOnceRight(path, '.');\n-  const parent = Object.create(null);\n-  setValueAtKey(parent, inputValue, key, element);\n-\n-  const visitor = new DefaultValueVisitor(parent, parentPath, 'element');\n-  const crawler = new SchemaCrawler(schema, visitor, elements);\n-  crawler.crawlElement(element, key, parentPath);\n-  const modifiedContainer = visitor.getDefaultValue();\n-\n-  return getValueAtKey(modifiedContainer, key, element, elements);\n-}\n-\n export function getDefaultValuesForNewSliceEntry(\n   key: string,\n   slice: SliceDefinition,\n@@ -148,11 +127,12 @@ class DefaultValueVisitor implements SchemaVisitor {\n         continue;\n       }\n \n+      const elementsKeyPrefix = getPathDifference(elementsContext.path, parentPath);\n       const parentArray: any[] = Array.isArray(parentValue) ? parentValue : [parentValue];\n       for (const parent of parentArray) {\n-        applyMinimums(parent, key, element, elementsContext.elements);\n+        applyMinimums(parent, key, element, elementsContext.elements, elementsKeyPrefix);\n         applyFixedOrPatternValue(parent, key, element, elementsContext.elements);\n-        const elementValue = getValueAtKey(parent, key, element, elementsContext.elements);\n+        const elementValue = getValueAtKey(parent, key, elementsContext.elements, elementsKeyPrefix);\n         if (elementValue !== undefined) {\n           elementValues.push(elementValue);\n         }\n@@ -177,8 +157,9 @@ class DefaultValueVisitor implements SchemaVisitor {\n       throw new Error(`Expected ${path} to be prefixed by ${this.value.path}`);\n     }\n \n+    const elementsKeyPrefix = getPathDifference(elementsContext.path, this.value.path);\n     for (const parentValue of this.value.values) {\n-      const elementValue = getValueAtKey(parentValue, key, element, elementsContext.elements);\n+      const elementValue = getValueAtKey(parentValue, key, elementsContext.elements, elementsKeyPrefix);\n \n       // remove empty items from arrays\n       if (Array.isArray(elementValue)) {\n@@ -266,9 +247,11 @@ function applyMinimums(\n   parent: any,\n   key: string,\n   element: InternalSchemaElement,\n-  elements: Record<string, InternalSchemaElement>\n+  elements: Record<string, InternalSchemaElement>,\n+  /** The prefix, if any, that should be added to keys when looking up values in `elements` */\n+  elementsKeyPrefix: string | undefined\n ): void {\n-  const existingValue = getValueAtKey(parent, key, element, elements);\n+  const existingValue = getValueAtKey(parent, key, elements, elementsKeyPrefix);\n \n   if (element.min > 0 && existingValue === undefined) {\n     if (isComplexTypeCode(element.type[0].code)) {\n@@ -303,8 +286,9 @@ function setValueAtKey(parent: any, value: any, key: string, element: InternalSc\n function getValueAtKey(\n   value: object,\n   key: string,\n-  element: InternalSchemaElement,\n-  elements: Record<string, InternalSchemaElement>\n+  elements: Record<string, InternalSchemaElement>,\n+  /** The prefix, if any, that should be added to keys when looking up values in `elements` */\n+  elementsKeyPrefix: string | undefined\n ): any {\n   const keyParts = key.split('.');\n   let last: any = value;\n@@ -312,8 +296,10 @@ function getValueAtKey(\n   for (let i = 0; i < keyParts.length; i++) {\n     let keyPart = keyParts[i];\n     if (keyPart.includes('[x]')) {\n-      const keyPartElem = elements[keyParts.slice(0, i + 1).join('.')];\n-      // should this loop through all possible types instead of using type[0]?\n+      const key = (elementsKeyPrefix ? elementsKeyPrefix + '.' : '') + keyParts.slice(0, i + 1).join('.');\n+      const keyPartElem = elements[key];\n+\n+      // this should loop through all possible types instead of using type[0]\n       const code = keyPartElem.type[0].code;\n       keyPart = keyPart.replace('[x]', capitalize(code));\n     }\n@@ -413,22 +399,3 @@ function applyPattern(existingValue: any, pattern: any): any {\n \n   return existingValue;\n }\n-\n-/**\n- * Splits a string on the last occurrence of the delimiter\n- * @param str - The string to split\n- * @param delim - The delimiter string\n- * @returns An array of two strings; the first consisting of the beginning of the\n- * string up to the last occurrence of the delimiter. the second is the remainder of the\n- * string after the last occurrence of the delimiter. If the delimiter is not present\n- * in the string, the first element is empty and the second is the input string.\n- */\n-function splitOnceRight(str: string, delim: string): [string, string] {\n-  const delimIndex = str.lastIndexOf(delim);\n-  if (delimIndex === -1) {\n-    return ['', str];\n-  }\n-  const beginning = str.substring(0, delimIndex);\n-  const last = str.substring(delimIndex + delim.length);\n-  return [beginning, last];\n-}\n",
    "test_patch": "diff --git a/packages/core/src/default-values.test.ts b/packages/core/src/default-values.test.ts\nindex eade7b8f09..f6877855b0 100644\n--- a/packages/core/src/default-values.test.ts\n+++ b/packages/core/src/default-values.test.ts\n@@ -1,9 +1,8 @@\n import { readJson } from '@medplum/definitions';\n-import { Bundle, Observation, Patient, StructureDefinition } from '@medplum/fhirtypes';\n+import { Bundle, MedicationRequest, Observation, Patient, StructureDefinition } from '@medplum/fhirtypes';\n import { HTTP_HL7_ORG } from './constants';\n import {\n   applyDefaultValuesToElement,\n-  applyDefaultValuesToElementWithVisitor,\n   applyDefaultValuesToResource,\n   applyFixedOrPatternValue,\n   getDefaultValuesForNewSliceEntry,\n@@ -146,18 +145,6 @@ describe('apply default values', () => {\n         const result = applyDefaultValuesToElement(Object.create(null), slice.elements, 'value[x]');\n         expect(result).toEqual({ code: 'mm[Hg]', system: 'http://unitsofmeasure.org' });\n       });\n-\n-      test('value for Observation.component.value[x] in systolic slice with visitor', () => {\n-        const slice = getSlice(schema, 'component', 'systolic');\n-        const result = applyDefaultValuesToElementWithVisitor(\n-          undefined,\n-          'Observation.component.value[x]',\n-          slice.elements['value[x]'],\n-          slice.elements,\n-          schema\n-        );\n-        expect(result).toEqual({ code: 'mm[Hg]', system: 'http://unitsofmeasure.org' });\n-      });\n     });\n   });\n \n@@ -351,6 +338,42 @@ describe('apply default values', () => {\n       expect(withDefaults).toEqual(resource);\n     });\n   });\n+\n+  describe('US Core MedicationRequest', () => {\n+    const profileUrl = `${HTTP_HL7_ORG}/fhir/us/core/StructureDefinition/us-core-medicationrequest`;\n+    let schema: InternalTypeSchema;\n+\n+    beforeAll(() => {\n+      loadProfiles([profileUrl]);\n+      schema = tryGetProfile(profileUrl) as InternalTypeSchema;\n+      if (!schema) {\n+        fail(`Failed to load schema for ${profileUrl}`);\n+      }\n+    });\n+\n+    test('apply defaults to dosageInstruction handled correctly', () => {\n+      const resource: MedicationRequest = {\n+        resourceType: 'MedicationRequest',\n+        status: 'cancelled',\n+        intent: 'proposal',\n+        subject: {\n+          reference: 'Patient/123',\n+        },\n+        dosageInstruction: [\n+          {\n+            timing: {\n+              repeat: {\n+                period: 1,\n+                periodUnit: 'd',\n+              },\n+            },\n+          },\n+        ],\n+      };\n+      const withDefaults = applyDefaultValuesToResource(resource, schema);\n+      expect(withDefaults).toEqual(resource);\n+    });\n+  });\n });\n \n function getComplexUSCorePatient(): Patient {\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5961",
    "pr_id": 5961,
    "issue_id": 5956,
    "repo": "medplum/medplum",
    "problem_statement": "Bot $execute with X-Medplum-On-Behalf-Of header\n### Current Behavior\n\nCurrently, when bots with the _runAsUser_ field set to true are executed, the Bot will run using the credentials specified by the ProjectMembership of the ClientApplication or Practitioner.\nIt does not take into account the `X-Medplum-On-Behalf-Of` header which can be added as a header to any HTTP request from a server side app to Medplum server, authenticated with client credentials (client id and client secret).  This is because the user is technically set to the ClientApplication.\n\n### Desired Behavior\n\nEven when _runAsUser_ is set to true for a bot, if the `X-Medplum-On-Behalf-Of` header is added to HTTP request `/Bot/[id]/$execute` the Bot should use the credentials from the User referenced in the `X-Medplum-On-Behalf-Of` header.",
    "issue_word_count": 137,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/server/src/context.ts",
      "packages/server/src/fhir/operations/execute.test.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/operations/execute.test.ts"
    ],
    "base_commit": "d0475041b2f882d2a7a94eebcac2e234be0dc272",
    "head_commit": "def4ad504c0b8410cd0fabde42ebb6752202fe65",
    "repo_url": "https://github.com/medplum/medplum/pull/5961",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5961",
    "dockerfile": "",
    "pr_merged_at": "2025-02-13T17:14:59.000Z",
    "patch": "diff --git a/packages/server/src/context.ts b/packages/server/src/context.ts\nindex 4cdafed463..5f0e86e68c 100644\n--- a/packages/server/src/context.ts\n+++ b/packages/server/src/context.ts\n@@ -52,7 +52,7 @@ export class AuthenticatedRequestContext extends RequestContext {\n   }\n \n   get membership(): ProjectMembership {\n-    return this.authState.membership;\n+    return this.authState.onBehalfOfMembership ?? this.authState.membership;\n   }\n \n   get login(): Login {\n@@ -60,7 +60,7 @@ export class AuthenticatedRequestContext extends RequestContext {\n   }\n \n   get profile(): Reference<ProfileResource> {\n-    return this.authState.membership.profile as Reference<ProfileResource>;\n+    return this.membership.profile as Reference<ProfileResource>;\n   }\n \n   [Symbol.dispose](): void {\n",
    "test_patch": "diff --git a/packages/server/src/fhir/operations/execute.test.ts b/packages/server/src/fhir/operations/execute.test.ts\nindex fef50074d3..84e313a8f8 100644\n--- a/packages/server/src/fhir/operations/execute.test.ts\n+++ b/packages/server/src/fhir/operations/execute.test.ts\n@@ -1,4 +1,4 @@\n-import { ContentType, Operator, badRequest, createReference, getReferenceString } from '@medplum/core';\n+import { ContentType, Operator, badRequest, createReference, getReferenceString, parseJWTPayload } from '@medplum/core';\n import {\n   AsyncJob,\n   AuditEvent,\n@@ -19,6 +19,7 @@ import { getLoginForAccessToken } from '../../oauth/utils';\n import { createTestProject, waitForAsyncJob, withTestContext } from '../../test.setup';\n import { getSystemRepo } from '../repo';\n import { getBinaryStorage } from '../storage';\n+import { inviteUser } from '../../admin/invite';\n \n const botCodes = [\n   [\n@@ -115,6 +116,7 @@ describe('Execute', () => {\n         ],\n       },\n       withAccessToken: true,\n+      membership: { admin: true },\n     });\n     project1 = testSetup.project;\n     accessToken1 = testSetup.accessToken;\n@@ -491,6 +493,76 @@ describe('Execute', () => {\n     expect(res.text).toStrictEqual('Hello, world!');\n   });\n \n+  test('runAsUser respects onBehalfOf', async () => {\n+    const { membership, profile } = await inviteUser({\n+      resourceType: 'Practitioner',\n+      project: project1,\n+      firstName: 'Test',\n+      lastName: 'User',\n+    });\n+    // Create a bot with empty code\n+    const res1 = await request(app)\n+      .post(`/fhir/R4/Bot`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n+      .send({\n+        resourceType: 'Bot',\n+        name: 'Test Bot',\n+        runtimeVersion: 'vmcontext',\n+        runAsUser: true,\n+      });\n+    expect(res1.status).toBe(201);\n+    const bot = res1.body as Bot;\n+\n+    // Deploy the bot\n+    const res5 = await request(app)\n+      .post(`/fhir/R4/Bot/${bot.id}/$deploy`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n+      .send({\n+        code: `\n+          exports.handler = async function (medplum, event) {\n+            return {\n+              token: medplum.getAccessToken(),\n+            }\n+          };\n+      `,\n+      });\n+    expect(res5.status).toBe(200);\n+\n+    // Execute the bot as self\n+    const res6 = await request(app)\n+      .post(`/fhir/R4/Bot/${bot.id}/$execute`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n+      .send({});\n+    expect(res6.status).toBe(200);\n+    const selfToken = parseJWTPayload(res6.body.token);\n+    expect(selfToken.profile).toMatch(/^ClientApplication\\//);\n+\n+    // Execute the bot with ProjectMembership ID\n+    const res7 = await request(app)\n+      .post(`/fhir/R4/Bot/${bot.id}/$execute`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n+      .set('X-Medplum-On-Behalf-Of', getReferenceString(membership))\n+      .send({});\n+    expect(res7.status).toBe(200);\n+    const membershipToken = parseJWTPayload(res7.body.token);\n+    expect(membershipToken.profile).toEqual(getReferenceString(profile));\n+\n+    // Execute the bot with profile resource ID\n+    const res8 = await request(app)\n+      .post(`/fhir/R4/Bot/${bot.id}/$execute`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n+      .set('X-Medplum-On-Behalf-Of', getReferenceString(membership))\n+      .send({});\n+    expect(res8.status).toBe(200);\n+    const profileToken = parseJWTPayload(res8.body.token);\n+    expect(profileToken.profile).toEqual(getReferenceString(profile));\n+  });\n+\n   describe('linked project', () => {\n     let project2: Project;\n     let accessToken2: string;\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5939",
    "pr_id": 5939,
    "issue_id": 5897,
    "repo": "medplum/medplum",
    "problem_statement": "Authentication issue with OAuth 2.0  servers that do not support request-body token authentication\nWe've been experiencing an authentication issue when using machine-to-machine authentication (although the problem is not limited to this use case) with one of our providers.\nWhen trying to authenticate with the provider, whether by direct use of startClientLogin, or via refresh (which used this function), we would receive a \"Failed to fetch tokens\".\n\nAfter some investigation, we found the root cause to be this:\nYou seem to send the client_id and client_secret in the body of the client credentials request.\nhttps://github.com/medplum/medplum/blob/main/packages/core/src/client.ts#L3647\n\nHowever, this causes an error when we try to authenticate with our provider since they don't support this method, but only support header authentication (since the Auth2 specs specify that header authentication MUST be supported but that request-body MAY be supported).\nhttps://datatracker.ietf.org/doc/html/rfc6749#section-2.3.1\n\n\nI am somewhat weary of offering a PR for that myself since authentication changes could undoubtably impact a variety of things in your framework but I was hoping there could be some resolution to this, perhaps an optional flag to choose between the two if no better way?",
    "issue_word_count": 213,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/core/src/client.test.ts",
      "packages/core/src/client.ts"
    ],
    "pr_changed_test_files": [
      "packages/core/src/client.test.ts"
    ],
    "base_commit": "b678db36211e2b11110215fe64fe38cc4436cc01",
    "head_commit": "2176736197757a716b5c8a5a28dd158c9889eebd",
    "repo_url": "https://github.com/medplum/medplum/pull/5939",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5939",
    "dockerfile": "",
    "pr_merged_at": "2025-02-24T18:52:43.000Z",
    "patch": "diff --git a/packages/core/src/client.ts b/packages/core/src/client.ts\nindex d6648e80b1..1ffc0e7c0e 100644\n--- a/packages/core/src/client.ts\n+++ b/packages/core/src/client.ts\n@@ -200,6 +200,13 @@ export interface MedplumClientOptions {\n    */\n   accessToken?: string;\n \n+  /**\n+   * Specifies through which part of the HTTP request the client credentials should be sent.\n+   *\n+   * Body is the default for backwards compatibility, but header may be more desirable for applications.\n+   */\n+  authCredentialsMethod?: 'body' | 'header';\n+\n   /**\n    * Number of resources to store in the cache.\n    *\n@@ -823,6 +830,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n   private medplumServer?: boolean;\n   private clientId?: string;\n   private clientSecret?: string;\n+  private credentialsInHeader: boolean;\n   private autoBatchTimerId?: any;\n   private accessToken?: string;\n   private accessTokenExpires?: number;\n@@ -856,6 +864,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n     this.fhircastHubUrl = concatUrls(this.baseUrl, options?.fhircastHubUrl ?? 'fhircast/STU3');\n     this.clientId = options?.clientId ?? '';\n     this.clientSecret = options?.clientSecret ?? '';\n+    this.credentialsInHeader = options?.authCredentialsMethod === 'header';\n     this.defaultHeaders = options?.defaultHeaders ?? {};\n     this.onUnauthenticated = options?.onUnauthenticated;\n     this.refreshGracePeriod = options?.refreshGracePeriod ?? DEFAULT_REFRESH_GRACE_PERIOD;\n@@ -1382,12 +1391,12 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n       throw new Error('MedplumClient is missing clientId');\n     }\n \n-    const formBody = new URLSearchParams();\n-    formBody.set('grant_type', OAuthGrantType.TokenExchange);\n-    formBody.set('subject_token_type', OAuthTokenType.AccessToken);\n-    formBody.set('client_id', clientId);\n-    formBody.set('subject_token', token);\n-    return this.fetchTokens(formBody);\n+    return this.fetchTokens({\n+      grant_type: OAuthGrantType.TokenExchange,\n+      subject_token_type: OAuthTokenType.AccessToken,\n+      client_id: clientId,\n+      subject_token: token,\n+    });\n   }\n \n   /**\n@@ -3567,20 +3576,21 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @category Authentication\n    */\n   processCode(code: string, loginParams?: Partial<BaseLoginRequest>): Promise<ProfileResource> {\n-    const formBody = new URLSearchParams();\n-    formBody.set('grant_type', OAuthGrantType.AuthorizationCode);\n-    formBody.set('code', code);\n-    formBody.set('client_id', loginParams?.clientId ?? (this.clientId as string));\n-    formBody.set('redirect_uri', loginParams?.redirectUri ?? getWindowOrigin());\n+    const tokenParams: Record<string, string> = {\n+      grant_type: OAuthGrantType.AuthorizationCode,\n+      code,\n+      client_id: loginParams?.clientId ?? this.clientId ?? '',\n+      redirect_uri: loginParams?.redirectUri ?? getWindowOrigin(),\n+    };\n \n     if (typeof sessionStorage !== 'undefined') {\n       const codeVerifier = sessionStorage.getItem('codeVerifier');\n       if (codeVerifier) {\n-        formBody.set('code_verifier', codeVerifier);\n+        tokenParams.code_verifier = codeVerifier;\n       }\n     }\n \n-    return this.fetchTokens(formBody);\n+    return this.fetchTokens(tokenParams);\n   }\n \n   /**\n@@ -3611,11 +3621,11 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n     }\n \n     if (this.refreshToken) {\n-      const formBody = new URLSearchParams();\n-      formBody.set('grant_type', OAuthGrantType.RefreshToken);\n-      formBody.set('client_id', this.clientId as string);\n-      formBody.set('refresh_token', this.refreshToken);\n-      this.refreshPromise = this.fetchTokens(formBody);\n+      this.refreshPromise = this.fetchTokens({\n+        grant_type: OAuthGrantType.RefreshToken,\n+        client_id: this.clientId ?? '',\n+        refresh_token: this.refreshToken,\n+      });\n       return this.refreshPromise;\n     }\n \n@@ -3648,11 +3658,11 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n     this.clientId = clientId;\n     this.clientSecret = clientSecret;\n \n-    const formBody = new URLSearchParams();\n-    formBody.set('grant_type', OAuthGrantType.ClientCredentials);\n-    formBody.set('client_id', clientId);\n-    formBody.set('client_secret', clientSecret);\n-    return this.fetchTokens(formBody);\n+    return this.fetchTokens({\n+      grant_type: OAuthGrantType.ClientCredentials,\n+      client_id: clientId,\n+      client_secret: clientSecret,\n+    });\n   }\n \n   /**\n@@ -3676,12 +3686,12 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n   async startJwtBearerLogin(clientId: string, assertion: string, scope: string): Promise<ProfileResource> {\n     this.clientId = clientId;\n \n-    const formBody = new URLSearchParams();\n-    formBody.set('grant_type', OAuthGrantType.JwtBearer);\n-    formBody.set('client_id', clientId);\n-    formBody.set('assertion', assertion);\n-    formBody.set('scope', scope);\n-    return this.fetchTokens(formBody);\n+    return this.fetchTokens({\n+      grant_type: OAuthGrantType.JwtBearer,\n+      client_id: clientId,\n+      assertion,\n+      scope,\n+    });\n   }\n \n   /**\n@@ -3694,11 +3704,11 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @returns Promise that resolves to the client profile.\n    */\n   async startJwtAssertionLogin(jwt: string): Promise<ProfileResource> {\n-    const formBody = new URLSearchParams();\n-    formBody.append('grant_type', OAuthGrantType.ClientCredentials);\n-    formBody.append('client_assertion_type', OAuthClientAssertionType.JwtBearer);\n-    formBody.append('client_assertion', jwt);\n-    return this.fetchTokens(formBody);\n+    return this.fetchTokens({\n+      grant_type: OAuthGrantType.ClientCredentials,\n+      client_assertion_type: OAuthClientAssertionType.JwtBearer,\n+      client_assertion: jwt,\n+    });\n   }\n \n   /**\n@@ -3875,22 +3885,30 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n   /**\n    * Makes a POST request to the tokens endpoint.\n    * See: https://openid.net/specs/openid-connect-core-1_0.html#TokenEndpoint\n-   * @param formBody - Token parameters in URL encoded format.\n+   * @param params - Token parameters.\n    * @returns The user profile resource.\n    */\n-  private async fetchTokens(formBody: URLSearchParams): Promise<ProfileResource> {\n+  private async fetchTokens(params: Record<string, string>): Promise<ProfileResource> {\n+    const formBody = new URLSearchParams(params);\n+    const headers: HeadersInit = { ...this.defaultHeaders, 'Content-Type': ContentType.FORM_URL_ENCODED };\n+    if (this.basicAuth) {\n+      headers['Authorization'] = `Basic ${this.basicAuth}`;\n+    }\n+\n+    if (this.credentialsInHeader) {\n+      formBody.delete('client_id');\n+      formBody.delete('client_secret');\n+\n+      if (!this.basicAuth && params.client_id && params.client_secret) {\n+        headers['Authorization'] = `Basic ${encodeBase64(params.client_id + ':' + params.client_secret)}`;\n+      }\n+    }\n     const options: MedplumRequestOptions = {\n       method: 'POST',\n-      headers: { 'Content-Type': ContentType.FORM_URL_ENCODED },\n+      headers,\n       body: formBody.toString(),\n       credentials: 'include',\n     };\n-    const headers = options.headers as Record<string, string>;\n-    Object.assign(headers, this.defaultHeaders);\n-\n-    if (this.basicAuth) {\n-      headers['Authorization'] = `Basic ${this.basicAuth}`;\n-    }\n \n     let response: Response;\n     try {\n",
    "test_patch": "diff --git a/packages/core/src/client.test.ts b/packages/core/src/client.test.ts\nindex 94d182a792..0357cff8ed 100644\n--- a/packages/core/src/client.test.ts\n+++ b/packages/core/src/client.test.ts\n@@ -1031,6 +1031,54 @@ describe('Client', () => {\n     );\n   });\n \n+  test('startClientLogin send credentials in header with valid token.client_id', async () => {\n+    const patientId = randomUUID();\n+    const clientId = 'test-client-id';\n+    const clientSecret = 'test-client-secret';\n+    const accessToken = createFakeJwt({ cid: clientId });\n+    const fetch = mockFetch(200, (url) => {\n+      if (url.includes(`Patient/${patientId}`)) {\n+        return { resourceType: 'Patient', id: patientId };\n+      }\n+\n+      if (url.includes('oauth2/token')) {\n+        return {\n+          access_token: accessToken,\n+        };\n+      }\n+      return {};\n+    });\n+\n+    const client = new MedplumClient({ fetch, authCredentialsMethod: 'header' });\n+    await client.startClientLogin(clientId, clientSecret);\n+\n+    const result2 = await client.readResource('Patient', patientId);\n+    expect(result2).toBeDefined();\n+    expect(fetch).toHaveBeenCalledTimes(2);\n+    expect(fetch).toHaveBeenCalledWith(\n+      `https://api.medplum.com/fhir/R4/Patient/${patientId}`,\n+      expect.objectContaining({\n+        method: 'GET',\n+        headers: {\n+          Accept: DEFAULT_ACCEPT,\n+          Authorization: `Bearer ${accessToken}`,\n+          'X-Medplum': 'extended',\n+        },\n+      })\n+    );\n+    expect(fetch).toHaveBeenCalledWith(\n+      `https://api.medplum.com/oauth2/token`,\n+      expect.objectContaining({\n+        method: 'POST',\n+        headers: {\n+          Authorization: 'Basic ' + encodeBase64(clientId + ':' + clientSecret),\n+          'Content-Type': ContentType.FORM_URL_ENCODED,\n+        },\n+        body: 'grant_type=client_credentials',\n+      })\n+    );\n+  });\n+\n   test('Basic auth and startClientLogin with fetched token mismatched client id ', async () => {\n     const clientId = 'test-client-id';\n     const clientSecret = 'test-client-secret';\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5932",
    "pr_id": 5932,
    "issue_id": 5886,
    "repo": "medplum/medplum",
    "problem_statement": "Add secure secret rotation mechanism for ClientApplication\n## Add secure secret rotation mechanism for ClientApplication\n\n### Description\nCurrently, the `ClientApplication` secret field can be directly modified by admin users to any value. This presents a security risk as it bypasses password strength requirements that are enforced elsewhere in the system. While secret rotation is a legitimate need for ClientApplications, it should be implemented in a secure manner.\n\n### Proposed Solution\nAdd a custom FHIR operation `$reset-secret` to the ClientApplication resource that handles secret rotation in a secure way:\n\n```typescript\nPOST [base]/ClientApplication/[id]/$reset-secret\n```\n\nThe operation should:\n1. Require the current secret for authentication\n2. Generate a new cryptographically secure secret\n3. Update the ClientApplication using the system repository\n4. Return the new secret to the caller\n\nExample request body:\n```json\n{\n  \"resourceType\": \"Parameters\",\n  \"parameter\": [\n    {\n      \"name\": \"current-secret\",\n      \"valueString\": \"[current-secret-value]\"\n    }\n  ]\n}\n```\n\n### Security Considerations\n- The ClientApplication.secret field should be made system-writeable only\n- The new secret should be generated using cryptographically secure methods\n- The operation should require appropriate access control\n- Failed attempts should be rate limited\n- The operation should follow FHIR security best practices\n\n### Implementation Details\n1. Create new custom operation definition\n2. Add server-side validation for current secret\n3. Implement secure secret generation\n4. Update ClientApplication access control\n5. Add appropriate logging\n6. Add documentation\n7. Add tests\n\n\n### Testing Criteria\n- [ ] Verify only system can directly write to secret field\n- [ ] Verify operation requires valid current secret\n- [ ] Verify new secret meets security requirements\n- [ ] Verify appropriate access control\n- [ ] Verify rate limiting\n- [ ] Verify audit logging\n\n### Documentation Updates Needed\n- API documentation for new operation\n- Security considerations\n- Usage examples\n- ClientApplication resource documentation",
    "issue_word_count": 267,
    "test_files_count": 4,
    "non_test_files_count": 12,
    "pr_changed_files": [
      "packages/definitions/dist/fhir/r4/fhir.schema.json",
      "packages/definitions/dist/fhir/r4/profiles-medplum.json",
      "packages/docs/docs/api/fhir/operations/rotate-client-secret.mdx",
      "packages/docs/static/data/medplumDefinitions/clientapplication.json",
      "packages/examples/src/api/fhir/operations/rotate-client-secret.ts",
      "packages/fhirtypes/dist/ClientApplication.d.ts",
      "packages/server/src/admin/client.test.ts",
      "packages/server/src/admin/client.ts",
      "packages/server/src/fhir/accesspolicy.ts",
      "packages/server/src/fhir/operations/codesystemimport.ts",
      "packages/server/src/fhir/operations/csv.test.ts",
      "packages/server/src/fhir/operations/rotatesecret.test.ts",
      "packages/server/src/fhir/operations/rotatesecret.ts",
      "packages/server/src/fhir/routes.ts",
      "packages/server/src/oauth/token.test.ts",
      "packages/server/src/oauth/token.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/admin/client.test.ts",
      "packages/server/src/fhir/operations/csv.test.ts",
      "packages/server/src/fhir/operations/rotatesecret.test.ts",
      "packages/server/src/oauth/token.test.ts"
    ],
    "base_commit": "47b203046061fc1f729b85c91aadb31a65ab1ac3",
    "head_commit": "adaaaa20172615f22dd4733e240e578e540fdba6",
    "repo_url": "https://github.com/medplum/medplum/pull/5932",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5932",
    "dockerfile": "",
    "pr_merged_at": "2025-02-27T00:29:41.000Z",
    "patch": "diff --git a/packages/definitions/dist/fhir/r4/fhir.schema.json b/packages/definitions/dist/fhir/r4/fhir.schema.json\nindex 6dc25b3444..1041284dc7 100644\n--- a/packages/definitions/dist/fhir/r4/fhir.schema.json\n+++ b/packages/definitions/dist/fhir/r4/fhir.schema.json\n@@ -59806,6 +59806,10 @@\n           \"description\": \"Client secret string used to verify the identity of a client.\",\n           \"$ref\": \"#/definitions/string\"\n         },\n+        \"retiringSecret\": {\n+          \"description\": \"Old version of the client secret that is being rotated out.  Instances of the client using this value should update to use the value in ClientApplication.secret\",\n+          \"$ref\": \"#/definitions/string\"\n+        },\n         \"jwksUri\": {\n           \"description\": \"Optional JWKS URI for public key verification of JWTs issued by the authorization server (client_secret_jwt).\",\n           \"$ref\": \"#/definitions/uri\"\n\ndiff --git a/packages/definitions/dist/fhir/r4/profiles-medplum.json b/packages/definitions/dist/fhir/r4/profiles-medplum.json\nindex beda5d491b..f172f72d9c 100644\n--- a/packages/definitions/dist/fhir/r4/profiles-medplum.json\n+++ b/packages/definitions/dist/fhir/r4/profiles-medplum.json\n@@ -840,6 +840,21 @@\n               \"max\" : \"1\"\n             }\n           },\n+          {\n+            \"id\" : \"ClientApplication.retiringSecret\",\n+            \"path\" : \"ClientApplication.retiringSecret\",\n+            \"definition\" : \"Old version of the client secret that is being rotated out.  Instances of the client using this value should update to use the value in ClientApplication.secret\",\n+            \"min\" : 0,\n+            \"max\" : \"1\",\n+            \"type\" : [{\n+              \"code\" : \"string\"\n+            }],\n+            \"base\": {\n+              \"path\" : \"ClientApplication.retiringSecret\",\n+              \"min\" : 0,\n+              \"max\" : \"1\"\n+            }\n+          },\n           {\n             \"id\" : \"ClientApplication.jwksUri\",\n             \"path\" : \"ClientApplication.jwksUri\",\n\ndiff --git a/packages/docs/docs/api/fhir/operations/rotate-client-secret.mdx b/packages/docs/docs/api/fhir/operations/rotate-client-secret.mdx\nnew file mode 100644\nindex 0000000000..9eb44ce5fb\n--- /dev/null\n+++ b/packages/docs/docs/api/fhir/operations/rotate-client-secret.mdx\n@@ -0,0 +1,52 @@\n+import Tabs from '@theme/Tabs';\n+import TabItem from '@theme/TabItem';\n+\n+import ExampleCode from '!!raw-loader!@site/../examples/src/api/fhir/operations/rotate-client-secret.ts';\n+import MedplumCodeBlock from '@site/src/components/MedplumCodeBlock';\n+\n+# Rotate Client Secret\n+\n+To securely rotate the authentication secret value for a `ClientApplication`, a special operation is provided that\n+ensures a secret with sufficient entropy is chosen, and that clients using the old secret do not immediately lose access.\n+\n+```\n+[baseUrl]/ClientApplication/[id]/$rotate-secret\n+```\n+\n+:::warning Privileged Operation\n+\n+This operation is only available to Project Admins and Super Admins.\n+\n+:::\n+\n+## Parameters\n+\n+| Name             | Type     | Description                                                                                   | Required       |\n+| ---------------- | -------- | --------------------------------------------------------------------------------------------- | -------------- |\n+| `secret`         | `string` | Rotate the primary secret, generating a new one and placing the old one into `retiringSecret` | No (see below) |\n+| `retiringSecret` | `string` | Rotate the retiring secret, removing it from use                                              | No             |\n+\n+:::note Mutually Exclusive Parameters\n+\n+One and only one of the `secret` and `retiringSecret` parameters must be provided, and must match the corresponding\n+value in the `ClientApplication`.\n+\n+:::\n+\n+## Output\n+\n+The operation returns the `ClientApplication` resource with the updated secret value.\n+\n+- If the `secret` is provided and matches the current `ClientApplication.secret`, that value is copied into\n+  `ClientApplication.retiringSecret` (overwriting any other value there), and a new secret is securely generated and\n+  placed into `ClientApplication.secret`; both secrets can be used to grant application access\n+- If the `retiringSecret` parameter is provided and matches the current `ClientApplication.retiringSecret` value,\n+  the `retiringSecret` is removed from the resource and can no longer be used to grant application access\n+\n+## Examples\n+\n+**Fully rotate client secret**:\n+\n+<MedplumCodeBlock language=\"ts\" selectBlocks=\"rotate\">\n+  {ExampleCode}\n+</MedplumCodeBlock>\n\ndiff --git a/packages/docs/static/data/medplumDefinitions/clientapplication.json b/packages/docs/static/data/medplumDefinitions/clientapplication.json\nindex 7a11a20749..4e100edf88 100644\n--- a/packages/docs/static/data/medplumDefinitions/clientapplication.json\n+++ b/packages/docs/static/data/medplumDefinitions/clientapplication.json\n@@ -272,6 +272,22 @@\n       \"comment\": \"\",\n       \"inherited\": false\n     },\n+    {\n+      \"name\": \"retiringSecret\",\n+      \"depth\": 1,\n+      \"types\": [\n+        {\n+          \"datatype\": \"string\"\n+        }\n+      ],\n+      \"path\": \"ClientApplication.retiringSecret\",\n+      \"min\": 0,\n+      \"max\": \"1\",\n+      \"short\": \"\",\n+      \"definition\": \"Old version of the client secret that is being rotated out.  Instances of the client using this value should update to use the value in ClientApplication.secret\",\n+      \"comment\": \"\",\n+      \"inherited\": false\n+    },\n     {\n       \"name\": \"jwksUri\",\n       \"depth\": 1,\n\ndiff --git a/packages/examples/src/api/fhir/operations/rotate-client-secret.ts b/packages/examples/src/api/fhir/operations/rotate-client-secret.ts\nnew file mode 100644\nindex 0000000000..4c3e9843ba\n--- /dev/null\n+++ b/packages/examples/src/api/fhir/operations/rotate-client-secret.ts\n@@ -0,0 +1,32 @@\n+import { MedplumClient } from '@medplum/core';\n+import { ClientApplication } from '@medplum/fhirtypes';\n+import { randomUUID } from 'node:crypto';\n+\n+const medplum = new MedplumClient();\n+\n+const clientApplication: ClientApplication & { id: string } = {\n+  resourceType: 'ClientApplication',\n+  id: randomUUID(),\n+  secret: randomUUID(),\n+};\n+\n+// start-block rotate\n+// First, rotate the initial secret\n+const rotatedClient: ClientApplication = await medplum.post(\n+  medplum.fhirUrl('ClientApplication', clientApplication.id, '$rotate-secret'),\n+  {\n+    resourceType: 'Parameters',\n+    parameter: [{ name: 'secret', valueString: clientApplication.secret }],\n+  }\n+);\n+console.log('Client secret rotated; new secret is:', rotatedClient.secret);\n+console.log('Previous secret is still available for use:', rotatedClient.retiringSecret);\n+// At this point, existing application instances should be updated to use the new secret\n+\n+// Once all use of the old (retiring) secret is resolved, rotate it out of service\n+await medplum.post(medplum.fhirUrl('ClientApplication', clientApplication.id, '$rotate-secret'), {\n+  resourceType: 'Parameters',\n+  parameter: [{ name: 'retiringSecret', valueString: rotatedClient.retiringSecret }],\n+});\n+// Now only the newly generated secret value will be valid\n+// end-block rotate\n\ndiff --git a/packages/fhirtypes/dist/ClientApplication.d.ts b/packages/fhirtypes/dist/ClientApplication.d.ts\nindex 2b6660b86b..a397580da2 100644\n--- a/packages/fhirtypes/dist/ClientApplication.d.ts\n+++ b/packages/fhirtypes/dist/ClientApplication.d.ts\n@@ -119,6 +119,13 @@ export interface ClientApplication {\n    */\n   secret?: string;\n \n+  /**\n+   * Old version of the client secret that is being rotated out.  Instances\n+   * of the client using this value should update to use the value in\n+   * ClientApplication.secret\n+   */\n+  retiringSecret?: string;\n+\n   /**\n    * Optional JWKS URI for public key verification of JWTs issued by the\n    * authorization server (client_secret_jwt).\n\ndiff --git a/packages/server/src/admin/client.ts b/packages/server/src/admin/client.ts\nindex 0829241493..b1dc75f39a 100644\n--- a/packages/server/src/admin/client.ts\n+++ b/packages/server/src/admin/client.ts\n@@ -47,9 +47,11 @@ export interface CreateClientRequest {\n }\n \n export async function createClient(repo: Repository, request: CreateClientRequest): Promise<WithId<ClientApplication>> {\n-  const client = await repo.createResource<ClientApplication>({\n+  const systemRepo = getSystemRepo();\n+  const client = await systemRepo.createResource<ClientApplication>({\n     meta: {\n       project: request.project.id,\n+      author: repo.getConfig().author,\n     },\n     resourceType: 'ClientApplication',\n     name: request.name,\n@@ -61,7 +63,6 @@ export async function createClient(repo: Repository, request: CreateClientReques\n     refreshTokenLifetime: request.refreshTokenLifetime,\n   });\n \n-  const systemRepo = getSystemRepo();\n   await systemRepo.createResource<ProjectMembership>({\n     meta: {\n       project: request.project.id,\n\ndiff --git a/packages/server/src/fhir/accesspolicy.ts b/packages/server/src/fhir/accesspolicy.ts\nindex 74295533ed..4d2900f5ed 100644\n--- a/packages/server/src/fhir/accesspolicy.ts\n+++ b/packages/server/src/fhir/accesspolicy.ts\n@@ -229,7 +229,7 @@ function applyProjectAdminAccessPolicy(\n \n     accessPolicy.resource.push({\n       resourceType: 'ProjectMembership',\n-      criteria: `ProjectMembership?project=${membership.project?.reference}`,\n+      criteria: `ProjectMembership?project=${membership.project.reference}`,\n       readonlyFields: ['project', 'user'],\n     });\n \n@@ -245,7 +245,7 @@ function applyProjectAdminAccessPolicy(\n \n     accessPolicy.resource.push({\n       resourceType: 'User',\n-      criteria: `User?project=${membership.project?.reference}`,\n+      criteria: `User?project=${membership.project.reference}`,\n       hiddenFields: ['passwordHash', 'mfaSecret'],\n       readonlyFields: ['email', 'emailVerified', 'mfaEnrolled', 'project'],\n     });\n\ndiff --git a/packages/server/src/fhir/operations/codesystemimport.ts b/packages/server/src/fhir/operations/codesystemimport.ts\nindex b69ad00053..3dc9783d71 100644\n--- a/packages/server/src/fhir/operations/codesystemimport.ts\n+++ b/packages/server/src/fhir/operations/codesystemimport.ts\n@@ -51,7 +51,7 @@ export type CodeSystemImportParameters = {\n /**\n  * Handles a request to import codes and their properties into a CodeSystem.\n  *\n- * Endpoint - Project resource type\n+ * Endpoint - CodeSystem resource type\n  *   [fhir base]/CodeSystem/$import\n  *\n  * @param req - The FHIR request.\n@@ -68,7 +68,7 @@ export async function codeSystemImportHandler(req: FhirRequest): Promise<FhirRes\n \n   let codeSystem: CodeSystem;\n   if (req.params.id) {\n-    codeSystem = await getAuthenticatedContext().repo.readResource<CodeSystem>('CodeSystem', req.params.id);\n+    codeSystem = await repo.readResource<CodeSystem>('CodeSystem', req.params.id);\n   } else if (params.system) {\n     codeSystem = await findTerminologyResource<CodeSystem>('CodeSystem', params.system, {\n       ownProjectOnly: !isSuperAdmin,\n\ndiff --git a/packages/server/src/fhir/operations/rotatesecret.ts b/packages/server/src/fhir/operations/rotatesecret.ts\nnew file mode 100644\nindex 0000000000..f3f96bc4d5\n--- /dev/null\n+++ b/packages/server/src/fhir/operations/rotatesecret.ts\n@@ -0,0 +1,78 @@\n+import { FhirRequest, FhirResponse } from '@medplum/fhir-router';\n+import { ClientApplication, OperationDefinition } from '@medplum/fhirtypes';\n+import { getAuthenticatedContext } from '../../context';\n+import { generateSecret } from '../../oauth/keys';\n+import { allOk, badRequest, forbidden, OperationOutcomeError } from '@medplum/core';\n+import { buildOutputParameters, parseInputParameters } from './utils/parameters';\n+import { getSystemRepo } from '../repo';\n+\n+const operation: OperationDefinition = {\n+  resourceType: 'OperationDefinition',\n+  name: 'clientapplication-rotate-secret',\n+  status: 'active',\n+  kind: 'operation',\n+  code: 'rotate-secret',\n+  experimental: true,\n+  resource: ['ClientApplication'],\n+  system: false,\n+  type: false,\n+  instance: true,\n+  parameter: [\n+    { use: 'in', name: 'secret', type: 'string', min: 0, max: '1' },\n+    { use: 'in', name: 'retiringSecret', type: 'string', min: 0, max: '1' },\n+    { use: 'out', name: 'return', type: 'ClientApplication', min: 1, max: '1' },\n+  ],\n+};\n+\n+type RotateSecretParameters = {\n+  secret?: string;\n+  retiringSecret?: string;\n+};\n+\n+/**\n+ * Handles a request to import codes and their properties into a CodeSystem.\n+ *\n+ * Endpoint - ClientApplication resource type\n+ *   [fhir base]/ClientApplication/:id/$rotate-secret\n+ *\n+ * @param req - The FHIR request.\n+ * @returns The FHIR response.\n+ */\n+export async function rotateSecretHandler(req: FhirRequest): Promise<FhirResponse> {\n+  const repo = getAuthenticatedContext().repo;\n+  if (!repo.isSuperAdmin() && !repo.isProjectAdmin()) {\n+    return [forbidden];\n+  }\n+\n+  const params = parseInputParameters<RotateSecretParameters>(operation, req);\n+  if (!params.secret && !params.retiringSecret) {\n+    return [badRequest('Secret to rotate must be provided')];\n+  }\n+  if (params.secret && params.retiringSecret) {\n+    return [badRequest('Only one secret can be rotated at a time')];\n+  }\n+\n+  // Patch using system repo since the secret fields should not generally be user-writeable\n+  const systemRepo = getSystemRepo();\n+  const clientApp = await systemRepo.withTransaction(async () => {\n+    let clientApp = await systemRepo.readResource<ClientApplication>('ClientApplication', req.params.id);\n+    if (params.secret && params.secret === clientApp.secret) {\n+      clientApp = await systemRepo.updateResource({\n+        ...clientApp,\n+        secret: generateSecret(32), // Generate new secret\n+        retiringSecret: clientApp.secret, // Rotate existing secret to \"retiring\" slot\n+      });\n+    } else if (params.retiringSecret && params.retiringSecret === clientApp.retiringSecret) {\n+      clientApp = await systemRepo.updateResource({\n+        ...clientApp,\n+        retiringSecret: undefined, // Remove rotated secret after it's been retired\n+      });\n+    } else {\n+      throw new OperationOutcomeError(badRequest('Provided secret does not match client'));\n+    }\n+\n+    return clientApp;\n+  });\n+\n+  return [allOk, buildOutputParameters(operation, clientApp)];\n+}\n\ndiff --git a/packages/server/src/fhir/routes.ts b/packages/server/src/fhir/routes.ts\nindex b6a8d77be6..a608814132 100644\n--- a/packages/server/src/fhir/routes.ts\n+++ b/packages/server/src/fhir/routes.ts\n@@ -40,6 +40,7 @@ import { planDefinitionApplyHandler } from './operations/plandefinitionapply';\n import { projectCloneHandler } from './operations/projectclone';\n import { projectInitHandler } from './operations/projectinit';\n import { resourceGraphHandler } from './operations/resourcegraph';\n+import { rotateSecretHandler } from './operations/rotatesecret';\n import { structureDefinitionExpandProfileHandler } from './operations/structuredefinitionexpandprofile';\n import { codeSystemSubsumesOperation } from './operations/subsumes';\n import { valueSetValidateOperation } from './operations/valuesetvalidatecode';\n@@ -270,6 +271,8 @@ function initInternalFhirRouter(): FhirRouter {\n \n   // ClientApplication $launch\n   router.add('GET', '/ClientApplication/:id/$smart-launch', appLaunchHandler);\n+  // Rotate client secret\n+  router.add('POST', '/ClientApplication/:id/$rotate-secret', rotateSecretHandler);\n \n   // AWS operations\n   router.add('POST', '/:resourceType/:id/$aws-textract', awsTextractHandler);\n\ndiff --git a/packages/server/src/oauth/token.ts b/packages/server/src/oauth/token.ts\nindex f68240241e..9a2e738479 100644\n--- a/packages/server/src/oauth/token.ts\n+++ b/packages/server/src/oauth/token.ts\n@@ -551,14 +551,26 @@ async function validateClientIdAndSecret(\n     return false;\n   }\n \n+  let failed = false;\n+\n   // Use a timing-safe-equal here so that we don't expose timing information which could be\n   // used to infer the secret value\n   if (!timingSafeEqualStr(client.secret, clientSecret)) {\n+    failed = true;\n+  }\n+  // Always perform a second comparison, in order to not leak timing information about the presence or absence of\n+  // a retiring secret\n+  const secondarySecret = client.retiringSecret ?? client.secret;\n+  if (timingSafeEqualStr(secondarySecret, clientSecret)) {\n+    failed = false;\n+  }\n+\n+  if (failed) {\n     sendTokenError(res, 'invalid_request', 'Invalid secret');\n     return false;\n+  } else {\n+    return true;\n   }\n-\n-  return true;\n }\n \n /**\n",
    "test_patch": "diff --git a/packages/server/src/admin/client.test.ts b/packages/server/src/admin/client.test.ts\nindex 937c884327..e417c4373e 100644\n--- a/packages/server/src/admin/client.test.ts\n+++ b/packages/server/src/admin/client.test.ts\n@@ -44,7 +44,6 @@ describe('Client admin', () => {\n     expect(res2.status).toBe(201);\n     expect(res2.body.resourceType).toBe('ClientApplication');\n     expect(res2.body.id).toBeDefined();\n-    expect(res2.body.secret).toBeDefined();\n     expect(res2.body.secret).toHaveLength(64);\n \n     // Read the client\n\ndiff --git a/packages/server/src/fhir/operations/csv.test.ts b/packages/server/src/fhir/operations/csv.test.ts\nindex dcb0dbb1cf..be53068ff4 100644\n--- a/packages/server/src/fhir/operations/csv.test.ts\n+++ b/packages/server/src/fhir/operations/csv.test.ts\n@@ -174,9 +174,7 @@ describe('CSV Export', () => {\n \n   test('Invalid query string param', async () => {\n     const res = await request(app)\n-      .get(\n-        `/fhir/R4/ClientApplication/$csv?_count=20&_fields=id,_lastUpdated,=cmd|'/C%20calc'!A0&_offset=0&_sort=-_lastUpdated`\n-      )\n+      .get(`/fhir/R4/Patient/$csv?_count=20&_fields=id,_lastUpdated,=cmd|'/C%20calc'!A0&_offset=0&_sort=-_lastUpdated`)\n       .set('Authorization', 'Bearer ' + accessToken);\n     expect(res.status).toBe(400);\n     expect(res.body.issue[0].details.text).toStrictEqual('Invalid FHIRPath expression');\n\ndiff --git a/packages/server/src/fhir/operations/rotatesecret.test.ts b/packages/server/src/fhir/operations/rotatesecret.test.ts\nnew file mode 100644\nindex 0000000000..3a798b825e\n--- /dev/null\n+++ b/packages/server/src/fhir/operations/rotatesecret.test.ts\n@@ -0,0 +1,180 @@\n+import express from 'express';\n+import { initApp, shutdownApp } from '../../app';\n+import { loadTestConfig } from '../../config/loader';\n+import { createTestProject } from '../../test.setup';\n+import { ContentType } from '@medplum/core';\n+import request from 'supertest';\n+import { ClientApplication, Parameters } from '@medplum/fhirtypes';\n+\n+describe('ClientApplication $rotate-secret', () => {\n+  const app = express();\n+\n+  beforeAll(async () => {\n+    const config = await loadTestConfig();\n+    await initApp(app, config);\n+  });\n+\n+  afterAll(async () => {\n+    await shutdownApp();\n+  });\n+\n+  test('Secret can be changed directly', async () => {\n+    const { client, accessToken } = await createTestProject({\n+      withAccessToken: true,\n+      withClient: true,\n+      membership: { admin: true },\n+    });\n+\n+    const res = await request(app)\n+      .put(`/fhir/R4/ClientApplication/${client.id}`)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('X-Medplum', 'extended')\n+      .send({ ...client, secret: 'foo' } satisfies ClientApplication);\n+    expect(res.status).toBe(200);\n+    const updated = res.body as ClientApplication;\n+    expect(updated.secret).toEqual('foo');\n+  });\n+\n+  test('Secret is changed to new value', async () => {\n+    const { client, accessToken } = await createTestProject({\n+      withAccessToken: true,\n+      withClient: true,\n+      membership: { admin: true },\n+    });\n+\n+    const res = await request(app)\n+      .post(`/fhir/R4/ClientApplication/${client.id}/$rotate-secret`)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('X-Medplum', 'extended')\n+      .send({\n+        resourceType: 'Parameters',\n+        parameter: [{ name: 'secret', valueString: client.secret }],\n+      } satisfies Parameters);\n+    expect(res.status).toBe(200);\n+    const updated = res.body as ClientApplication;\n+    expect(updated.secret).toBeDefined();\n+    expect(updated.secret).not.toStrictEqual(client.secret);\n+    expect(updated.retiringSecret).toStrictEqual(client.secret);\n+  });\n+\n+  test('Secret parameter must match existing', async () => {\n+    const { client, accessToken } = await createTestProject({\n+      withAccessToken: true,\n+      withClient: true,\n+      membership: { admin: true },\n+    });\n+\n+    const res = await request(app)\n+      .post(`/fhir/R4/ClientApplication/${client.id}/$rotate-secret`)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('X-Medplum', 'extended')\n+      .send({\n+        resourceType: 'Parameters',\n+        parameter: [{ name: 'secret', valueString: 'incorrect' }],\n+      } satisfies Parameters);\n+    expect(res.status).toBe(400);\n+    expect(res.body.issue?.[0]?.code).toStrictEqual('invalid');\n+  });\n+\n+  test('Remove retired secret', async () => {\n+    const { client, accessToken } = await createTestProject({\n+      withAccessToken: true,\n+      withClient: true,\n+      membership: { admin: true },\n+    });\n+\n+    const res = await request(app)\n+      .post(`/fhir/R4/ClientApplication/${client.id}/$rotate-secret`)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('X-Medplum', 'extended')\n+      .send({\n+        resourceType: 'Parameters',\n+        parameter: [{ name: 'secret', valueString: client.secret }],\n+      } satisfies Parameters);\n+    expect(res.status).toBe(200);\n+    const updated = res.body as ClientApplication;\n+    expect(updated.secret).toBeDefined();\n+    expect(updated.secret).not.toStrictEqual(client.secret);\n+    expect(updated.retiringSecret).toStrictEqual(client.secret);\n+\n+    const res2 = await request(app)\n+      .post(`/fhir/R4/ClientApplication/${client.id}/$rotate-secret`)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('X-Medplum', 'extended')\n+      .send({\n+        resourceType: 'Parameters',\n+        parameter: [{ name: 'retiringSecret', valueString: updated.retiringSecret }],\n+      } satisfies Parameters);\n+    expect(res2.status).toBe(200);\n+    const retired = res2.body as ClientApplication;\n+    expect(retired.secret).toStrictEqual(updated.secret);\n+    expect(retired.retiringSecret).toBeUndefined();\n+  });\n+\n+  test('Access denied for non-admin user', async () => {\n+    const { client, accessToken } = await createTestProject({\n+      withAccessToken: true,\n+      withClient: true,\n+    });\n+\n+    const res = await request(app)\n+      .post(`/fhir/R4/ClientApplication/${client.id}/$rotate-secret`)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('X-Medplum', 'extended')\n+      .send({\n+        resourceType: 'Parameters',\n+        parameter: [{ name: 'secret', valueString: client.secret }],\n+      } satisfies Parameters);\n+    expect(res.status).toBe(403);\n+    expect(res.body.issue?.[0]?.code).toStrictEqual('forbidden');\n+  });\n+\n+  test('Secret must be provided', async () => {\n+    const { client, accessToken } = await createTestProject({\n+      withAccessToken: true,\n+      withClient: true,\n+      membership: { admin: true },\n+    });\n+\n+    const res = await request(app)\n+      .post(`/fhir/R4/ClientApplication/${client.id}/$rotate-secret`)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('X-Medplum', 'extended')\n+      .send({\n+        resourceType: 'Parameters',\n+        parameter: [],\n+      } satisfies Parameters);\n+    expect(res.status).toBe(400);\n+    expect(res.body.issue?.[0]?.code).toStrictEqual('invalid');\n+  });\n+\n+  test('Only one secret can be provided', async () => {\n+    const { client, accessToken } = await createTestProject({\n+      withAccessToken: true,\n+      withClient: true,\n+      membership: { admin: true },\n+    });\n+\n+    const res = await request(app)\n+      .post(`/fhir/R4/ClientApplication/${client.id}/$rotate-secret`)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('X-Medplum', 'extended')\n+      .send({\n+        resourceType: 'Parameters',\n+        parameter: [\n+          { name: 'secret', valueString: client.secret },\n+          { name: 'retiringSecret', valueString: client.secret },\n+        ],\n+      } satisfies Parameters);\n+    expect(res.status).toBe(400);\n+    expect(res.body.issue?.[0]?.code).toStrictEqual('invalid');\n+  });\n+});\n\ndiff --git a/packages/server/src/oauth/token.test.ts b/packages/server/src/oauth/token.test.ts\nindex b2819ebb2d..1eea53a7bf 100644\n--- a/packages/server/src/oauth/token.test.ts\n+++ b/packages/server/src/oauth/token.test.ts\n@@ -77,6 +77,10 @@ describe('OAuth2 Token', () => {\n     // Create a test project\n     ({ project, client } = await createTestProject({ withClient: true }));\n \n+    // Add secondary secret for testing\n+    client.retiringSecret = generateSecret(32);\n+    client = await systemRepo.updateResource(client);\n+\n     // Create a 2nd client with PKCE optional\n     pkceOptionalClient = await systemRepo.createResource<ClientApplication>({\n       resourceType: 'ClientApplication',\n@@ -217,6 +221,17 @@ describe('OAuth2 Token', () => {\n     expect(res.body.error_description).toBe('Invalid secret');\n   });\n \n+  test('Token for client credentials with secondary client_secret', async () => {\n+    const res = await request(app).post('/oauth2/token').type('form').send({\n+      grant_type: 'client_credentials',\n+      client_id: client.id,\n+      client_secret: client.retiringSecret,\n+    });\n+    expect(res.status).toBe(200);\n+    expect(res.body.error).toBeUndefined();\n+    expect(res.body.access_token).toBeDefined();\n+  });\n+\n   test('Token for client credentials authentication header success', async () => {\n     const res = await request(app)\n       .post('/oauth2/token')\n@@ -496,6 +511,25 @@ describe('OAuth2 Token', () => {\n     expect(res2.body.error_description).toBe('Invalid secret');\n   });\n \n+  test('Authorization code token with secondary client secret', async () => {\n+    const res = await request(app).post('/auth/login').type('json').send({\n+      clientId: client.id,\n+      email,\n+      password,\n+    });\n+    expect(res.status).toBe(200);\n+\n+    const res2 = await request(app).post('/oauth2/token').type('form').send({\n+      grant_type: 'authorization_code',\n+      code: res.body.code,\n+      client_id: client.id,\n+      client_secret: client.retiringSecret,\n+    });\n+    expect(res2.status).toBe(200);\n+    expect(res2.body.error).toBeUndefined();\n+    expect(res2.body.access_token).toBeDefined();\n+  });\n+\n   test('Authorization code token with client secret success', async () => {\n     const res = await request(app).post('/auth/login').type('json').send({\n       clientId: client.id,\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5918",
    "pr_id": 5918,
    "issue_id": 5154,
    "repo": "medplum/medplum",
    "problem_statement": "Config Value for Access Token TTL\nWe have a field on `ClientApplication` that allows admins to set the length of the refreshToken. \n\nWe should a field to shorten the Access token TTL (max 1h), to make it easier to developers to debug token refresh issues",
    "issue_word_count": 45,
    "test_files_count": 1,
    "non_test_files_count": 10,
    "pr_changed_files": [
      "packages/definitions/dist/fhir/r4/fhir.schema.json",
      "packages/definitions/dist/fhir/r4/profiles-medplum.json",
      "packages/docs/static/data/medplumDefinitions/clientapplication.json",
      "packages/fhirtypes/dist/ClientApplication.d.ts",
      "packages/server/src/admin/client.ts",
      "packages/server/src/auth/register.ts",
      "packages/server/src/fhir/operations/getwsbindingtoken.ts",
      "packages/server/src/oauth/keys.ts",
      "packages/server/src/oauth/token.test.ts",
      "packages/server/src/oauth/token.ts",
      "packages/server/src/oauth/utils.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/oauth/token.test.ts"
    ],
    "base_commit": "e483a98b748e32cfbc009e5208b581fb5d5b94ca",
    "head_commit": "1cf392ab9baf5b3d75191d127c3032aefb334d55",
    "repo_url": "https://github.com/medplum/medplum/pull/5918",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5918",
    "dockerfile": "",
    "pr_merged_at": "2025-02-05T20:11:17.000Z",
    "patch": "diff --git a/packages/definitions/dist/fhir/r4/fhir.schema.json b/packages/definitions/dist/fhir/r4/fhir.schema.json\nindex 3cdfafb82a..82862da1ab 100644\n--- a/packages/definitions/dist/fhir/r4/fhir.schema.json\n+++ b/packages/definitions/dist/fhir/r4/fhir.schema.json\n@@ -59828,6 +59828,10 @@\n           \"description\": \"Optional external Identity Provider (IdP) for the client application.\",\n           \"$ref\": \"#/definitions/IdentityProvider\"\n         },\n+        \"accessTokenLifetime\": {\n+          \"description\": \"Optional configuration to set the access token duration\",\n+          \"$ref\": \"#/definitions/string\"\n+        },\n         \"refreshTokenLifetime\": {\n           \"description\": \"Optional configuration to set the refresh token duration\",\n           \"$ref\": \"#/definitions/string\"\n\ndiff --git a/packages/definitions/dist/fhir/r4/profiles-medplum.json b/packages/definitions/dist/fhir/r4/profiles-medplum.json\nindex d39022bb43..41d5d4532a 100644\n--- a/packages/definitions/dist/fhir/r4/profiles-medplum.json\n+++ b/packages/definitions/dist/fhir/r4/profiles-medplum.json\n@@ -915,6 +915,27 @@\n               \"max\" : \"1\"\n             }\n           },\n+          {\n+            \"id\" : \"ClientApplication.accessTokenLifetime\",\n+            \"path\" : \"ClientApplication.accessTokenLifetime\",\n+            \"definition\" : \"Optional configuration to set the access token duration\",\n+            \"min\" : 0,\n+            \"max\" : \"1\",\n+            \"type\" : [{\n+              \"code\" : \"string\"\n+            }],\n+            \"constraint\" : [{\n+              \"key\" : \"clapp-1\",\n+              \"severity\" : \"error\",\n+              \"human\" : \"Token lifetime must be a valid string representing time duration (eg. 2w, 1h)\",\n+              \"expression\" : \"$this.matches('^[0-9]+[smhdwy]$')\"\n+            }],\n+            \"base\": {\n+              \"path\" : \"ClientApplication.accessTokenLifetime\",\n+              \"min\" : 0,\n+              \"max\" : \"1\"\n+            }\n+          },\n           {\n             \"id\" : \"ClientApplication.refreshTokenLifetime\",\n             \"path\" : \"ClientApplication.refreshTokenLifetime\",\n\ndiff --git a/packages/docs/static/data/medplumDefinitions/clientapplication.json b/packages/docs/static/data/medplumDefinitions/clientapplication.json\nindex a87cb7ea59..7a11a20749 100644\n--- a/packages/docs/static/data/medplumDefinitions/clientapplication.json\n+++ b/packages/docs/static/data/medplumDefinitions/clientapplication.json\n@@ -353,6 +353,22 @@\n       \"comment\": \"\",\n       \"inherited\": false\n     },\n+    {\n+      \"name\": \"accessTokenLifetime\",\n+      \"depth\": 1,\n+      \"types\": [\n+        {\n+          \"datatype\": \"string\"\n+        }\n+      ],\n+      \"path\": \"ClientApplication.accessTokenLifetime\",\n+      \"min\": 0,\n+      \"max\": \"1\",\n+      \"short\": \"\",\n+      \"definition\": \"Optional configuration to set the access token duration\",\n+      \"comment\": \"\",\n+      \"inherited\": false\n+    },\n     {\n       \"name\": \"refreshTokenLifetime\",\n       \"depth\": 1,\n\ndiff --git a/packages/fhirtypes/dist/ClientApplication.d.ts b/packages/fhirtypes/dist/ClientApplication.d.ts\nindex 15eca865e0..2b6660b86b 100644\n--- a/packages/fhirtypes/dist/ClientApplication.d.ts\n+++ b/packages/fhirtypes/dist/ClientApplication.d.ts\n@@ -148,6 +148,11 @@ export interface ClientApplication {\n    */\n   identityProvider?: IdentityProvider;\n \n+  /**\n+   * Optional configuration to set the access token duration\n+   */\n+  accessTokenLifetime?: string;\n+\n   /**\n    * Optional configuration to set the refresh token duration\n    */\n\ndiff --git a/packages/server/src/admin/client.ts b/packages/server/src/admin/client.ts\nindex 49fd146f6c..0f0a6c0c0e 100644\n--- a/packages/server/src/admin/client.ts\n+++ b/packages/server/src/admin/client.ts\n@@ -42,6 +42,7 @@ export interface CreateClientRequest {\n   readonly redirectUri?: string;\n   readonly accessPolicy?: Reference<AccessPolicy>;\n   readonly identityProvider?: IdentityProvider;\n+  readonly accessTokenLifetime?: string;\n   readonly refreshTokenLifetime?: string;\n }\n \n@@ -56,6 +57,7 @@ export async function createClient(repo: Repository, request: CreateClientReques\n     description: request.description,\n     redirectUri: request.redirectUri,\n     identityProvider: request.identityProvider,\n+    accessTokenLifetime: request.accessTokenLifetime,\n     refreshTokenLifetime: request.refreshTokenLifetime,\n   });\n \n\ndiff --git a/packages/server/src/auth/register.ts b/packages/server/src/auth/register.ts\nindex acd1a61747..e255a5fb2c 100644\n--- a/packages/server/src/auth/register.ts\n+++ b/packages/server/src/auth/register.ts\n@@ -75,7 +75,7 @@ export async function registerNew(request: RegisterRequest): Promise<RegisterRes\n       membership: createReference(membership as ProjectMembership),\n     },\n     createReference(profile as ProfileResource),\n-    client.refreshTokenLifetime\n+    { accessLifetime: client.accessTokenLifetime, refreshLifetime: client.refreshTokenLifetime }\n   );\n \n   return {\n\ndiff --git a/packages/server/src/fhir/operations/getwsbindingtoken.ts b/packages/server/src/fhir/operations/getwsbindingtoken.ts\nindex 572facdccc..f331a73cd4 100644\n--- a/packages/server/src/fhir/operations/getwsbindingtoken.ts\n+++ b/packages/server/src/fhir/operations/getwsbindingtoken.ts\n@@ -168,8 +168,10 @@ export async function getWsBindingTokenHandler(req: FhirRequest): Promise<FhirRe\n       profile: profile.reference as string,\n     },\n     {\n-      subscription_id: subscriptionId,\n-    } satisfies AdditionalWsBindingClaims\n+      additionalClaims: {\n+        subscription_id: subscriptionId,\n+      } satisfies AdditionalWsBindingClaims,\n+    }\n   );\n \n   const output = {\n\ndiff --git a/packages/server/src/oauth/keys.ts b/packages/server/src/oauth/keys.ts\nindex ce65d85637..82ae082909 100644\n--- a/packages/server/src/oauth/keys.ts\n+++ b/packages/server/src/oauth/keys.ts\n@@ -79,6 +79,7 @@ export interface MedplumRefreshTokenClaims extends MedplumBaseClaims {\n  * This is the algorithm used by AWS Cognito and Auth0.\n  */\n const ALG = 'RS256';\n+const DEFAULT_ACCESS_LIFETIME = '1h';\n const DEFAULT_REFRESH_LIFETIME = '2w';\n \n let issuer: string | undefined;\n@@ -193,24 +194,27 @@ export function generateIdToken(claims: MedplumIdTokenClaims): Promise<string> {\n /**\n  * Generates an access token JWT.\n  * @param claims - The access token claims.\n- * @param additionalClaims - Any additional custom claims. Optional.\n+ * @param options - Optional parameters.\n+ * @param options.additionalClaims - Any additional custom claims.\n+ * @param options.lifetime - Access token duration.\n  * @returns A well-formed JWT that can be used as an access token.\n  */\n export function generateAccessToken(\n   claims: MedplumAccessTokenClaims,\n-  additionalClaims?: Record<string, string | number>\n+  options?: { additionalClaims?: Record<string, string | number>; lifetime?: string }\n ): Promise<string> {\n-  return generateJwt('1h', additionalClaims ? { ...claims, ...additionalClaims } : claims);\n+  const duration = options?.lifetime ?? DEFAULT_ACCESS_LIFETIME;\n+  return generateJwt(duration, options?.additionalClaims ? { ...claims, ...options.additionalClaims } : claims);\n }\n \n /**\n  * Generates a refresh token JWT.\n  * @param claims - The refresh token claims.\n- * @param refreshLifetime - The refresh token duration.\n+ * @param lifetime - The refresh token duration.\n  * @returns A well-formed JWT that can be used as a refresh token.\n  */\n-export function generateRefreshToken(claims: MedplumRefreshTokenClaims, refreshLifetime?: string): Promise<string> {\n-  const duration = refreshLifetime ?? DEFAULT_REFRESH_LIFETIME;\n+export function generateRefreshToken(claims: MedplumRefreshTokenClaims, lifetime?: string): Promise<string> {\n+  const duration = lifetime ?? DEFAULT_REFRESH_LIFETIME;\n \n   return generateJwt(duration, claims);\n }\n\ndiff --git a/packages/server/src/oauth/token.ts b/packages/server/src/oauth/token.ts\nindex f619d08073..fa41b477d1 100644\n--- a/packages/server/src/oauth/token.ts\n+++ b/packages/server/src/oauth/token.ts\n@@ -152,7 +152,7 @@ async function handleClientCredentials(req: Request, res: Response): Promise<voi\n     return;\n   }\n \n-  await sendTokenResponse(res, login, client.refreshTokenLifetime);\n+  await sendTokenResponse(res, login, client);\n }\n \n /**\n@@ -248,7 +248,7 @@ async function handleAuthorizationCode(req: Request, res: Response): Promise<voi\n     }\n   }\n \n-  await sendTokenResponse(res, login, client?.refreshTokenLifetime);\n+  await sendTokenResponse(res, login, client);\n }\n \n /**\n@@ -323,8 +323,6 @@ async function handleRefreshToken(req: Request, res: Response): Promise<void> {\n     }\n   }\n \n-  const refreshTokenLifetime = client?.refreshTokenLifetime;\n-\n   // Refresh token rotation\n   // Generate a new refresh secret and update the login\n   const updatedLogin = await systemRepo.updateResource<Login>({\n@@ -334,7 +332,7 @@ async function handleRefreshToken(req: Request, res: Response): Promise<void> {\n     userAgent: req.get('User-Agent'),\n   });\n \n-  await sendTokenResponse(res, updatedLogin, refreshTokenLifetime);\n+  await sendTokenResponse(res, updatedLogin, client);\n }\n \n /**\n@@ -417,7 +415,7 @@ export async function exchangeExternalAuthToken(\n     userAgent: req.get('User-Agent'),\n   });\n \n-  await sendTokenResponse(res, login, client.refreshTokenLifetime);\n+  await sendTokenResponse(res, login, client);\n }\n \n /**\n@@ -566,9 +564,9 @@ async function validateClientIdAndSecret(\n  * Sends a successful token response.\n  * @param res - The HTTP response.\n  * @param login - The user login.\n- * @param refreshLifetime - The refresh token duration.\n+ * @param client - The client application. Optional.\n  */\n-async function sendTokenResponse(res: Response, login: Login, refreshLifetime?: string): Promise<void> {\n+async function sendTokenResponse(res: Response, login: Login, client?: ClientApplication): Promise<void> {\n   const config = getConfig();\n \n   const systemRepo = getSystemRepo();\n@@ -577,7 +575,10 @@ async function sendTokenResponse(res: Response, login: Login, refreshLifetime?:\n     login.membership as Reference<ProjectMembership>\n   );\n \n-  const tokens = await getAuthTokens(user, login, membership.profile as Reference<ProfileResource>, refreshLifetime);\n+  const tokens = await getAuthTokens(user, login, membership.profile as Reference<ProfileResource>, {\n+    accessLifetime: client?.accessTokenLifetime,\n+    refreshLifetime: client?.refreshTokenLifetime,\n+  });\n   let patient = undefined;\n   let encounter = undefined;\n \n@@ -605,9 +606,12 @@ async function sendTokenResponse(res: Response, login: Login, refreshLifetime?:\n     fhircastProps['hub.topic'] = topic;\n   }\n \n+  const decodedAccessToken = await verifyJwt(tokens.accessToken);\n+  const { exp, iat } = decodedAccessToken.payload;\n+\n   res.status(200).json({\n     token_type: 'Bearer',\n-    expires_in: 3600,\n+    expires_in: (exp ?? 0) - (iat ?? 0),\n     scope: login.scope,\n     id_token: tokens.idToken,\n     access_token: tokens.accessToken,\n\ndiff --git a/packages/server/src/oauth/utils.ts b/packages/server/src/oauth/utils.ts\nindex b19cb1709b..efaaf65a83 100644\n--- a/packages/server/src/oauth/utils.ts\n+++ b/packages/server/src/oauth/utils.ts\n@@ -527,7 +527,10 @@ export async function getAuthTokens(\n   user: User | ClientApplication,\n   login: Login,\n   profile: Reference<ProfileResource>,\n-  refreshLifetime?: string\n+  options?: {\n+    accessLifetime?: string;\n+    refreshLifetime?: string;\n+  }\n ): Promise<TokenResult> {\n   assert.equal(getReferenceString(user), login.user?.reference);\n \n@@ -556,14 +559,17 @@ export async function getAuthTokens(\n     auth_time: (getDateProperty(login.authTime) as Date).getTime() / 1000,\n   });\n \n-  const accessToken = await generateAccessToken({\n-    client_id: clientId,\n-    login_id: login.id as string,\n-    sub: user.id,\n-    username: user.id as string,\n-    scope: login.scope as string,\n-    profile: profile.reference as string,\n-  });\n+  const accessToken = await generateAccessToken(\n+    {\n+      client_id: clientId,\n+      login_id: login.id as string,\n+      sub: user.id,\n+      username: user.id as string,\n+      scope: login.scope as string,\n+      profile: profile.reference as string,\n+    },\n+    { lifetime: options?.accessLifetime }\n+  );\n \n   const refreshToken = login.refreshSecret\n     ? await generateRefreshToken(\n@@ -572,7 +578,7 @@ export async function getAuthTokens(\n           login_id: login.id as string,\n           refresh_secret: login.refreshSecret,\n         },\n-        refreshLifetime\n+        options?.refreshLifetime\n       )\n     : undefined;\n \n",
    "test_patch": "diff --git a/packages/server/src/oauth/token.test.ts b/packages/server/src/oauth/token.test.ts\nindex 7ca13a71fd..312c0b5f32 100644\n--- a/packages/server/src/oauth/token.test.ts\n+++ b/packages/server/src/oauth/token.test.ts\n@@ -1139,6 +1139,76 @@ describe('OAuth2 Token', () => {\n     expect(res5.body).toMatchObject({ error: 'invalid_request', error_description: 'Invalid token' });\n   });\n \n+  test('accessTokenLifetime -- Valid duration', async () => {\n+    // Create a new client application with external auth\n+    const validLifetimeClient = await createClient(systemRepo, {\n+      project,\n+      name: 'accessTokenLifetime - Valid Client',\n+      accessTokenLifetime: '60s',\n+    });\n+\n+    expect(validLifetimeClient?.id).toBeDefined();\n+    expect(validLifetimeClient?.secret).toBeDefined();\n+\n+    const res = await request(app)\n+      .post('/auth/login')\n+      .type('json')\n+      .send({\n+        clientId: validLifetimeClient.id as string,\n+        email,\n+        password,\n+        codeChallenge: 'xyz',\n+        codeChallengeMethod: 'plain',\n+        scope: 'openid offline',\n+      });\n+    expect(res.status).toBe(200);\n+\n+    const res2 = await request(app)\n+      .post('/oauth2/token')\n+      .type('form')\n+      .send({\n+        grant_type: 'authorization_code',\n+        client_id: validLifetimeClient.id as string,\n+        code: res.body.code,\n+        code_verifier: 'xyz',\n+        scope: 'openid offline',\n+      });\n+\n+    expect(res2.status).toBe(200);\n+    expect(res2.body.token_type).toBe('Bearer');\n+    expect(res2.body.scope).toBe('openid offline');\n+    expect(res2.body.expires_in).toBe(60);\n+    expect(res2.body.id_token).toBeDefined();\n+    expect(res2.body.access_token).toBeDefined();\n+    expect(res2.body.refresh_token).toBeDefined();\n+\n+    const claims = (await verifyJwt(res2.body.access_token)).payload;\n+    expect(claims.exp).toStrictEqual((claims.iat as number) + 60);\n+  });\n+\n+  test('accessTokenLifetime -- Invalid duration', async () => {\n+    // Create a new client application with external auth\n+    await expect(\n+      createClient(systemRepo, {\n+        project,\n+        name: 'accessTokenLifetime - Invalid Client',\n+        accessTokenLifetime: 'medplum',\n+      })\n+    ).rejects.toThrow(\n+      /Constraint clapp-1 not met: Token lifetime must be a valid string representing time duration (eg. 2w, 1h)*/\n+    );\n+\n+    await expect(\n+      createClient(systemRepo, {\n+        project,\n+        name: 'accessTokenLifetime - Invalid Client',\n+        accessTokenLifetime: '300',\n+      })\n+    ).rejects.toThrow(\n+      /Constraint clapp-1 not met: Token lifetime must be a valid string representing time duration (eg. 2w, 1h)*/\n+    );\n+  });\n+\n   test('refreshTokenLifetime -- Valid duration', async () => {\n     // Create a new client application with external auth\n     const validLifetimeClient = await createClient(systemRepo, {\n@@ -1472,7 +1542,7 @@ describe('OAuth2 Token', () => {\n       client_assertion: jwt,\n     });\n     expect(res.status).toBe(200);\n-    expect(jwtVerify).toHaveBeenCalledTimes(3);\n+    expect(jwtVerify).toHaveBeenCalledTimes(4);\n   });\n \n   test('Client assertion multiple inner error', async () => {\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5854",
    "pr_id": 5854,
    "issue_id": 5839,
    "repo": "medplum/medplum",
    "problem_statement": "Medplum returns `Invalid format for date search parameter `when using `pr` operator on `dateTime`\n## Description\n\n@filipeximenes is trying to use the `pr` (presence) operator on a `dateTime` attribute in Medplum, specifically with the `Communication` resource type. However, when attempting the query, the following error message is returned: `Invalid format for date search parameter: false`\n\n![Image](https://github.com/user-attachments/assets/58f1275b-b4ee-4d31-8c59-0aeecdc7fc6a)\n\n### Expected Behavior\n\nThe query should successfully return results for `pr=true` or `pr=false` based on the presence of the `sent` `dateTime` field in the `Communication` resource. The `pr` operator should indicate whether the attribute is present or not without returning an invalid format error.\n\n### Actual Behavior\n\nThe query returns an invalid format error: `Invalid format for date search parameter: false`, which prevents any results from being returned.\n\n## Steps to Reproduce\n\n1. Attempt to query a `Communication` resource using the `pr` operator on a `dateTime` attribute\n```ts\nconst query = `{\n  CommunicationList(_filter: \"_has:Task:based-on:due-date pr true\") {\n    id,\n    resourceType\n  }\n}`;\nawait medplum.graphql(query);\n```\n\n2. Notice that the query returns an error: `Invalid format for date search parameter: false`\n\n## Related Resources\n\n- [Comparison Operators](https://www.medplum.com/docs/search/filter-search-parameter#comparison-operators)",
    "issue_word_count": 201,
    "test_files_count": 1,
    "non_test_files_count": 2,
    "pr_changed_files": [
      "packages/core/src/search/search.ts",
      "packages/server/src/fhir/search.test.ts",
      "packages/server/src/fhir/search.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/search.test.ts"
    ],
    "base_commit": "3491fdf2d6c82d31abb923bfe870a861dfab11f0",
    "head_commit": "bf09c1788b43aaac44fd0901b95e48184beb6244",
    "repo_url": "https://github.com/medplum/medplum/pull/5854",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5854",
    "dockerfile": "",
    "pr_merged_at": "2025-01-24T17:48:12.000Z",
    "patch": "diff --git a/packages/core/src/search/search.ts b/packages/core/src/search/search.ts\nindex 9d635bcf52..5593f2b002 100644\n--- a/packages/core/src/search/search.ts\n+++ b/packages/core/src/search/search.ts\n@@ -356,11 +356,12 @@ function parseSortRule(searchRequest: SearchRequest, value: string): void {\n   }\n }\n \n+const presenceOperators: Operator[] = [Operator.MISSING, Operator.PRESENT];\n export function parseParameter(searchParam: SearchParameter, modifier: string, value: string): Filter {\n-  if (modifier === 'missing') {\n+  if (presenceOperators.includes(modifier as Operator)) {\n     return {\n       code: searchParam.code,\n-      operator: Operator.MISSING,\n+      operator: modifier as Operator,\n       value,\n     };\n   }\n\ndiff --git a/packages/server/src/fhir/search.ts b/packages/server/src/fhir/search.ts\nindex 2cde0b49d9..b9d6c8743e 100644\n--- a/packages/server/src/fhir/search.ts\n+++ b/packages/server/src/fhir/search.ts\n@@ -874,7 +874,7 @@ export function buildSearchExpression(\n     for (const filter of searchRequest.filters) {\n       let expr: Expression | undefined;\n       if (filter.code.startsWith('_has:') || filter.code.includes('.')) {\n-        const chain = parseChainedParameter(searchRequest.resourceType, filter.code, filter.value);\n+        const chain = parseChainedParameter(searchRequest.resourceType, filter);\n         expr = buildChainedSearch(repo, selectQuery, searchRequest.resourceType, chain);\n       } else {\n         expr = buildSearchFilterExpression(repo, selectQuery, resourceType, resourceType, filter);\n@@ -915,7 +915,7 @@ function buildSearchFilterExpression(\n   }\n \n   if (filter.code.startsWith('_has:') || filter.code.includes('.')) {\n-    const chain = parseChainedParameter(resourceType, filter.code, filter.value);\n+    const chain = parseChainedParameter(resourceType, filter);\n     return buildChainedSearch(repo, selectQuery, resourceType, chain);\n   }\n \n@@ -1651,9 +1651,9 @@ function buildSearchLinkCondition(\n   }\n }\n \n-function parseChainedParameter(resourceType: string, key: string, value: string): ChainedSearchParameter {\n+function parseChainedParameter(resourceType: string, searchFilter: Filter): ChainedSearchParameter {\n   let currentResourceType = resourceType;\n-  const parts = splitChainedSearch(key);\n+  const parts = splitChainedSearch(searchFilter.code);\n \n   const chain: ChainedSearchLink[] = [];\n   let filter: Filter | undefined;\n@@ -1669,7 +1669,7 @@ function parseChainedParameter(resourceType: string, key: string, value: string)\n       if (!searchParam) {\n         throw new Error(`Invalid search parameter at end of chain: ${currentResourceType}?${code}`);\n       }\n-      filter = parseParameter(searchParam, modifier, value);\n+      filter = parseParameter(searchParam, modifier ?? searchFilter.operator, searchFilter.value);\n     } else {\n       const link = parseChainLink(part, currentResourceType);\n       chain.push(link);\n",
    "test_patch": "diff --git a/packages/server/src/fhir/search.test.ts b/packages/server/src/fhir/search.test.ts\nindex d2d9525694..74f5aa1396 100644\n--- a/packages/server/src/fhir/search.test.ts\n+++ b/packages/server/src/fhir/search.test.ts\n@@ -3337,6 +3337,38 @@ describe('FHIR Search', () => {\n         expect(result.entry?.[0]?.resource?.id).toStrictEqual(patient.id);\n       }));\n \n+    test('_filter chained pr', () =>\n+      withTestContext(async () => {\n+        const patient = await repo.createResource<Patient>({\n+          resourceType: 'Patient',\n+          birthDate: '2000-01-01',\n+          name: [{ given: ['Eve'] }],\n+          managingOrganization: { reference: 'Organization/' + randomUUID() },\n+        });\n+\n+        await repo.createResource<Observation>({\n+          resourceType: 'Observation',\n+          effectiveDateTime: '2000-01-01',\n+          status: 'final',\n+          code: { text: 'Born' },\n+          subject: createReference(patient),\n+        });\n+\n+        const result = await repo.search({\n+          resourceType: 'Patient',\n+          filters: [\n+            {\n+              code: '_filter',\n+              operator: Operator.EQUALS,\n+              value: '_has:Observation:subject:date pr true',\n+            },\n+          ],\n+        });\n+\n+        expect(result.entry).toHaveLength(1);\n+        expect(result.entry?.[0]?.resource?.id).toStrictEqual(patient.id);\n+      }));\n+\n     test('_filter sw', () =>\n       withTestContext(async () => {\n         const patient = await repo.createResource<Patient>({\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5829",
    "pr_id": 5829,
    "issue_id": 5771,
    "repo": "medplum/medplum",
    "problem_statement": "Add metrics for all BullMQ queue lengths\nFollowing up on #4860, we should have metrics for all queues just in case they get backed up.\r\n\r\nPreviously we have seen at least the `download` queue get backed up in very degenerate cases but this seems like it would be uncommon as of now.\r\n\r\nCron seems like another one vulnerable to cascading failures coupled with bots retrying on short cron interval",
    "issue_word_count": 69,
    "test_files_count": 2,
    "non_test_files_count": 3,
    "pr_changed_files": [
      "packages/server/src/app.ts",
      "packages/server/src/healthcheck.test.ts",
      "packages/server/src/healthcheck.ts",
      "packages/server/src/otel/otel.test.ts",
      "packages/server/src/otel/otel.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/healthcheck.test.ts",
      "packages/server/src/otel/otel.test.ts"
    ],
    "base_commit": "e274edd0dfa6703acae9038f46e01d2385e60b32",
    "head_commit": "00d18de4219f649877ff42dbc7d83735d7ab68fe",
    "repo_url": "https://github.com/medplum/medplum/pull/5829",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5829",
    "dockerfile": "",
    "pr_merged_at": "2025-01-23T20:23:08.000Z",
    "patch": "diff --git a/packages/server/src/app.ts b/packages/server/src/app.ts\nindex 77b31fd3b4..d276d57a93 100644\n--- a/packages/server/src/app.ts\n+++ b/packages/server/src/app.ts\n@@ -32,6 +32,7 @@ import { initKeys } from './oauth/keys';\n import { authenticateRequest } from './oauth/middleware';\n import { oauthRouter } from './oauth/routes';\n import { openApiHandler } from './openapi';\n+import { cleanupOtelHeartbeat, initOtelHeartbeat } from './otel/otel';\n import { closeRateLimiter, getRateLimiter } from './ratelimit';\n import { closeRedis, initRedis } from './redis';\n import { requestContextStore } from './request-context-store';\n@@ -218,10 +219,12 @@ export function initAppServices(config: MedplumServerConfig): Promise<void> {\n     initBinaryStorage(config.binaryStorage);\n     initWorkers(config);\n     initHeartbeat(config);\n+    initOtelHeartbeat();\n   });\n }\n \n export async function shutdownApp(): Promise<void> {\n+  cleanupOtelHeartbeat();\n   cleanupHeartbeat();\n   await closeWebSockets();\n   if (server) {\n\ndiff --git a/packages/server/src/healthcheck.ts b/packages/server/src/healthcheck.ts\nindex 477953e86a..1999349d72 100644\n--- a/packages/server/src/healthcheck.ts\n+++ b/packages/server/src/healthcheck.ts\n@@ -1,12 +1,10 @@\n import { MEDPLUM_VERSION } from '@medplum/core';\n import { Request, Response } from 'express';\n import os from 'node:os';\n-import v8 from 'node:v8';\n import { Pool } from 'pg';\n import { DatabaseMode, getDatabasePool } from './database';\n import { RecordMetricOptions, setGauge } from './otel/otel';\n import { getRedis } from './redis';\n-import { getSubscriptionQueue } from './workers/subscription';\n \n const hostname = os.hostname();\n const BASE_METRIC_OPTIONS = { attributes: { hostname } } satisfies RecordMetricOptions;\n@@ -16,26 +14,6 @@ export async function healthcheckHandler(_req: Request, res: Response): Promise<\n   const writerPool = getDatabasePool(DatabaseMode.WRITER);\n   const readerPool = getDatabasePool(DatabaseMode.READER);\n \n-  setGauge('medplum.db.idleConnections', writerPool.idleCount, {\n-    ...BASE_METRIC_OPTIONS,\n-    attributes: { ...BASE_METRIC_OPTIONS.attributes, dbInstanceType: 'writer' },\n-  });\n-  setGauge('medplum.db.queriesAwaitingClient', writerPool.waitingCount, {\n-    ...BASE_METRIC_OPTIONS,\n-    attributes: { ...BASE_METRIC_OPTIONS.attributes, dbInstanceType: 'writer' },\n-  });\n-\n-  if (writerPool !== readerPool) {\n-    setGauge('medplum.db.idleConnections', readerPool.idleCount, {\n-      ...BASE_METRIC_OPTIONS,\n-      attributes: { ...BASE_METRIC_OPTIONS.attributes, dbInstanceType: 'reader' },\n-    });\n-    setGauge('medplum.db.queriesAwaitingClient', readerPool.waitingCount, {\n-      ...BASE_METRIC_OPTIONS,\n-      attributes: { ...BASE_METRIC_OPTIONS.attributes, dbInstanceType: 'reader' },\n-    });\n-  }\n-\n   let startTime = Date.now();\n   const postgresWriterOk = await testPostgres(writerPool);\n   const writerRoundtripMs = Date.now() - startTime;\n@@ -59,27 +37,6 @@ export async function healthcheckHandler(_req: Request, res: Response): Promise<\n   const redisRoundtripMs = Date.now() - startTime;\n   setGauge('medplum.redis.healthcheckRTT', redisRoundtripMs / 1000, METRIC_IN_SECS_OPTIONS);\n \n-  const heapStats = v8.getHeapStatistics();\n-  setGauge('medplum.node.usedHeapSize', heapStats.used_heap_size, BASE_METRIC_OPTIONS);\n-\n-  const heapSpaceStats = v8.getHeapSpaceStatistics();\n-  setGauge(\n-    'medplum.node.oldSpaceUsedSize',\n-    heapSpaceStats.find((entry) => entry.space_name === 'old_space')?.space_used_size ?? -1,\n-    BASE_METRIC_OPTIONS\n-  );\n-  setGauge(\n-    'medplum.node.newSpaceUsedSize',\n-    heapSpaceStats.find((entry) => entry.space_name === 'new_space')?.space_used_size ?? -1,\n-    BASE_METRIC_OPTIONS\n-  );\n-\n-  const subscriptionQueue = getSubscriptionQueue();\n-  if (subscriptionQueue) {\n-    setGauge('medplum.subscription.waitingCount', await subscriptionQueue.getWaitingCount());\n-    setGauge('medplum.subscription.delayedCount', await subscriptionQueue.getDelayedCount());\n-  }\n-\n   res.json({\n     ok: true,\n     version: MEDPLUM_VERSION,\n\ndiff --git a/packages/server/src/otel/otel.ts b/packages/server/src/otel/otel.ts\nindex 715fdfa281..c9bc62bce5 100644\n--- a/packages/server/src/otel/otel.ts\n+++ b/packages/server/src/otel/otel.ts\n@@ -1,10 +1,20 @@\n import opentelemetry, { Attributes, Counter, Gauge, Histogram, Meter, MetricOptions } from '@opentelemetry/api';\n+import os from 'node:os';\n+import v8 from 'node:v8';\n+import { DatabaseMode, getDatabasePool } from '../database';\n+import { heartbeat } from '../heartbeat';\n+import { getCronQueue } from '../workers/cron';\n+import { getSubscriptionQueue } from '../workers/subscription';\n \n // This file includes OpenTelemetry helpers.\n // Note that this file is related but separate from the OpenTelemetry initialization code in instrumentation.ts.\n // The instrumentation.ts code is used to initialize OpenTelemetry.\n // This file is used to record metrics.\n \n+const hostname = os.hostname();\n+const BASE_METRIC_OPTIONS = { attributes: { hostname } } satisfies RecordMetricOptions;\n+let otelHeartbeatListener: (() => Promise<void>) | undefined;\n+\n let meter: Meter | undefined = undefined;\n const counters = new Map<string, Counter>();\n const histograms = new Map<string, Histogram>();\n@@ -76,3 +86,68 @@ export function setGauge(name: string, value: number, options?: RecordMetricOpti\n function isOtelMetricsEnabled(): boolean {\n   return !!process.env.OTLP_METRICS_ENDPOINT;\n }\n+\n+export function initOtelHeartbeat(): void {\n+  if (otelHeartbeatListener) {\n+    return;\n+  }\n+  otelHeartbeatListener = async () => {\n+    const writerPool = getDatabasePool(DatabaseMode.WRITER);\n+    const readerPool = getDatabasePool(DatabaseMode.READER);\n+\n+    setGauge('medplum.db.idleConnections', writerPool.idleCount, {\n+      ...BASE_METRIC_OPTIONS,\n+      attributes: { ...BASE_METRIC_OPTIONS.attributes, dbInstanceType: 'writer' },\n+    });\n+    setGauge('medplum.db.queriesAwaitingClient', writerPool.waitingCount, {\n+      ...BASE_METRIC_OPTIONS,\n+      attributes: { ...BASE_METRIC_OPTIONS.attributes, dbInstanceType: 'writer' },\n+    });\n+\n+    if (writerPool !== readerPool) {\n+      setGauge('medplum.db.idleConnections', readerPool.idleCount, {\n+        ...BASE_METRIC_OPTIONS,\n+        attributes: { ...BASE_METRIC_OPTIONS.attributes, dbInstanceType: 'reader' },\n+      });\n+      setGauge('medplum.db.queriesAwaitingClient', readerPool.waitingCount, {\n+        ...BASE_METRIC_OPTIONS,\n+        attributes: { ...BASE_METRIC_OPTIONS.attributes, dbInstanceType: 'reader' },\n+      });\n+    }\n+\n+    const heapStats = v8.getHeapStatistics();\n+    setGauge('medplum.node.usedHeapSize', heapStats.used_heap_size, BASE_METRIC_OPTIONS);\n+\n+    const heapSpaceStats = v8.getHeapSpaceStatistics();\n+    setGauge(\n+      'medplum.node.oldSpaceUsedSize',\n+      heapSpaceStats.find((entry) => entry.space_name === 'old_space')?.space_used_size ?? -1,\n+      BASE_METRIC_OPTIONS\n+    );\n+    setGauge(\n+      'medplum.node.newSpaceUsedSize',\n+      heapSpaceStats.find((entry) => entry.space_name === 'new_space')?.space_used_size ?? -1,\n+      BASE_METRIC_OPTIONS\n+    );\n+\n+    const subscriptionQueue = getSubscriptionQueue();\n+    if (subscriptionQueue) {\n+      setGauge('medplum.subscription.waitingCount', await subscriptionQueue.getWaitingCount());\n+      setGauge('medplum.subscription.delayedCount', await subscriptionQueue.getDelayedCount());\n+    }\n+\n+    const cronQueue = getCronQueue();\n+    if (cronQueue) {\n+      setGauge('medplum.cron.waitingCount', await cronQueue.getWaitingCount());\n+      setGauge('medplum.cron.delayedCount', await cronQueue.getDelayedCount());\n+    }\n+  };\n+  heartbeat.addEventListener('heartbeat', otelHeartbeatListener);\n+}\n+\n+export function cleanupOtelHeartbeat(): void {\n+  if (otelHeartbeatListener) {\n+    heartbeat.removeEventListener('heartbeat', otelHeartbeatListener);\n+    otelHeartbeatListener = undefined;\n+  }\n+}\n",
    "test_patch": "diff --git a/packages/server/src/healthcheck.test.ts b/packages/server/src/healthcheck.test.ts\nindex 2d3aa6ce66..9ad714381e 100644\n--- a/packages/server/src/healthcheck.test.ts\n+++ b/packages/server/src/healthcheck.test.ts\n@@ -38,7 +38,7 @@ describe('Health check', () => {\n     const res = await request(app).get('/healthcheck');\n     expect(res.status).toBe(200);\n \n-    expect(setGaugeSpy).toHaveBeenCalledTimes(12);\n+    expect(setGaugeSpy).toHaveBeenCalledTimes(3);\n   });\n \n   test('Get /healthcheck when OTel is enabled and read and write instance are the same', async () => {\n@@ -51,6 +51,6 @@ describe('Health check', () => {\n     const res = await request(app).get('/healthcheck');\n     expect(res.status).toBe(200);\n \n-    expect(setGaugeSpy).toHaveBeenCalledTimes(9);\n+    expect(setGaugeSpy).toHaveBeenCalledTimes(2);\n   });\n });\n\ndiff --git a/packages/server/src/otel/otel.test.ts b/packages/server/src/otel/otel.test.ts\nindex 33d0bff6f7..bdefea6826 100644\n--- a/packages/server/src/otel/otel.test.ts\n+++ b/packages/server/src/otel/otel.test.ts\n@@ -1,15 +1,25 @@\n-import { getGauge, incrementCounter, recordHistogramValue, setGauge } from '../otel/otel';\n+import { Pool } from 'pg';\n+import * as databaseModule from '../database';\n+import { heartbeat } from '../heartbeat';\n+import {\n+  cleanupOtelHeartbeat,\n+  getGauge,\n+  incrementCounter,\n+  initOtelHeartbeat,\n+  recordHistogramValue,\n+  setGauge,\n+} from '../otel/otel';\n \n describe('OpenTelemetry', () => {\n   const OLD_ENV = process.env;\n \n   beforeEach(() => {\n     jest.resetModules();\n-    jest.resetAllMocks();\n+    jest.restoreAllMocks();\n     process.env = { ...OLD_ENV };\n   });\n \n-  afterAll(() => {\n+  afterAll(async () => {\n     process.env = OLD_ENV;\n   });\n \n@@ -70,4 +80,45 @@ describe('OpenTelemetry', () => {\n     expect(setGauge('test', 1, { options: { unit: 's' } })).toBe(true);\n     getGauge('test');\n   });\n+\n+  test('initOtelHeartbeat', () => {\n+    const heartbeatAddListenerSpy = jest.spyOn(heartbeat, 'addEventListener');\n+    const heartbeatRemoveListenerSpy = jest.spyOn(heartbeat, 'removeEventListener');\n+\n+    // Init otel heartbeat\n+    initOtelHeartbeat();\n+    expect(heartbeatAddListenerSpy).toHaveBeenCalled();\n+\n+    heartbeatAddListenerSpy.mockClear();\n+\n+    // Call init again, no-op\n+    initOtelHeartbeat();\n+    expect(heartbeatAddListenerSpy).not.toHaveBeenCalled();\n+\n+    // Cleanup heartbeat\n+    cleanupOtelHeartbeat();\n+    expect(heartbeatRemoveListenerSpy).toHaveBeenCalled();\n+\n+    heartbeatRemoveListenerSpy.mockClear();\n+\n+    // Cleanup heartbeat again, no-op\n+    cleanupOtelHeartbeat();\n+    expect(heartbeatRemoveListenerSpy).not.toHaveBeenCalled();\n+  });\n+\n+  test('Heartbeat listener is called after calling initOtelHeartbeat', async () => {\n+    const getDatabasePoolSpy = jest.spyOn(databaseModule, 'getDatabasePool').mockImplementation(\n+      () =>\n+        ({\n+          query: async () => undefined,\n+        }) as unknown as Pool\n+    );\n+\n+    initOtelHeartbeat();\n+\n+    heartbeat.dispatchEvent({ type: 'heartbeat' });\n+\n+    // We call getDatabasePool at the beginning of the listener callback\n+    expect(getDatabasePoolSpy).toHaveBeenCalled();\n+  });\n });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5791",
    "pr_id": 5791,
    "issue_id": 5759,
    "repo": "medplum/medplum",
    "problem_statement": "Bot timeline improvements\n1. Don't show code snippets by default, add a button or link for \"Expand...\" for any Binary/Attachment diffs\r\n2. Only show the first 3 diffs by default, add a button or link for \"Show...\" to all diffs after the first 3\r\n\r\nThis will primarily be in:\r\n1. `packages/react/src/ResourceTimeline/ResourceTimeline.tsx` - in the `HistoryTimelineItem` component\r\n2. `packages/react/src/ResourceDiffTable/ResourceDiffTable.tsx` - new prop about whether to show attachments or not\r\n3. `packages/react/src/AttachmentDisplay/AttachmentDisplay.tsx` - new prop about whether to show by default or show the \"Expand...\" button",
    "issue_word_count": 98,
    "test_files_count": 2,
    "non_test_files_count": 3,
    "pr_changed_files": [
      "packages/react/src/ResourceDiffRow/ResourceDiffRow.module.css",
      "packages/react/src/ResourceDiffRow/ResourceDiffRow.test.tsx",
      "packages/react/src/ResourceDiffRow/ResourceDiffRow.tsx",
      "packages/react/src/ResourceDiffTable/ResourceDiffTable.test.tsx",
      "packages/react/src/ResourceDiffTable/ResourceDiffTable.tsx"
    ],
    "pr_changed_test_files": [
      "packages/react/src/ResourceDiffRow/ResourceDiffRow.test.tsx",
      "packages/react/src/ResourceDiffTable/ResourceDiffTable.test.tsx"
    ],
    "base_commit": "6faaed07646501ec3bd176d14de62804e17f007a",
    "head_commit": "3fb7489435d9058307ba32715030684d8fa7e2a5",
    "repo_url": "https://github.com/medplum/medplum/pull/5791",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5791",
    "dockerfile": "",
    "pr_merged_at": "2025-01-31T17:55:33.000Z",
    "patch": "diff --git a/packages/react/src/ResourceDiffRow/ResourceDiffRow.module.css b/packages/react/src/ResourceDiffRow/ResourceDiffRow.module.css\nnew file mode 100644\nindex 0000000000..8eaf073e90\n--- /dev/null\n+++ b/packages/react/src/ResourceDiffRow/ResourceDiffRow.module.css\n@@ -0,0 +1,8 @@\n+.removed {\n+  color: var(--mantine-color-red-7);\n+  text-decoration: line-through;\n+}\n+\n+.added {\n+  color: var(--mantine-color-green-7);\n+}\n\ndiff --git a/packages/react/src/ResourceDiffRow/ResourceDiffRow.tsx b/packages/react/src/ResourceDiffRow/ResourceDiffRow.tsx\nnew file mode 100644\nindex 0000000000..2e3b7ff154\n--- /dev/null\n+++ b/packages/react/src/ResourceDiffRow/ResourceDiffRow.tsx\n@@ -0,0 +1,63 @@\n+import { useState } from 'react';\n+import { Table, Button } from '@mantine/core';\n+import { ResourcePropertyDisplay } from '../ResourcePropertyDisplay/ResourcePropertyDisplay';\n+import { InternalSchemaElement, TypedValue } from '@medplum/core';\n+import classes from './ResourceDiffRow.module.css';\n+\n+export interface ResourceDiffRowProps {\n+  name: string;\n+  path: string;\n+  property: InternalSchemaElement | undefined;\n+  originalValue: TypedValue | undefined;\n+  revisedValue: TypedValue | undefined;\n+}\n+\n+export function ResourceDiffRow(props: ResourceDiffRowProps): JSX.Element {\n+  const { name, path, property, originalValue, revisedValue } = props;\n+  const isAttachmentType = !!property?.type?.find((t) => t.code === 'Attachment');\n+  const [isCollapsed, setIsCollapsed] = useState<boolean>(isAttachmentType);\n+  const toggleCollapse = (): void => setIsCollapsed((prev) => !prev);\n+\n+  return (\n+    <>\n+      {(isAttachmentType && !isCollapsed) || !isAttachmentType ? (\n+        <>\n+          <Table.Tr>\n+            <Table.Td>{name}</Table.Td>\n+            <Table.Td className={classes.removed}>\n+              {originalValue && (\n+                <ResourcePropertyDisplay\n+                  path={path}\n+                  property={property}\n+                  propertyType={originalValue.type}\n+                  value={originalValue.value}\n+                  ignoreMissingValues={true}\n+                />\n+              )}\n+            </Table.Td>\n+            <Table.Td className={classes.added}>\n+              {revisedValue && (\n+                <ResourcePropertyDisplay\n+                  path={path}\n+                  property={property}\n+                  propertyType={revisedValue.type}\n+                  value={revisedValue.value}\n+                  ignoreMissingValues={true}\n+                />\n+              )}\n+            </Table.Td>\n+          </Table.Tr>\n+        </>\n+      ) : (\n+        <Table.Tr>\n+          <Table.Td>{name}</Table.Td>\n+          <Table.Td colSpan={2} style={{ textAlign: 'right' }}>\n+            <Button onClick={toggleCollapse} variant=\"light\">\n+              Expand\n+            </Button>\n+          </Table.Td>\n+        </Table.Tr>\n+      )}\n+    </>\n+  );\n+}\n\ndiff --git a/packages/react/src/ResourceDiffTable/ResourceDiffTable.tsx b/packages/react/src/ResourceDiffTable/ResourceDiffTable.tsx\nindex 1498b1271c..dac918b671 100644\n--- a/packages/react/src/ResourceDiffTable/ResourceDiffTable.tsx\n+++ b/packages/react/src/ResourceDiffTable/ResourceDiffTable.tsx\n@@ -12,7 +12,7 @@ import { Resource, SearchParameter } from '@medplum/fhirtypes';\n import { useMedplum } from '@medplum/react-hooks';\n import { useEffect, useMemo, useState } from 'react';\n import { Operation, createPatch } from 'rfc6902';\n-import { ResourcePropertyDisplay } from '../ResourcePropertyDisplay/ResourcePropertyDisplay';\n+import { ResourceDiffRow } from '../ResourceDiffRow/ResourceDiffRow';\n import classes from './ResourceDiffTable.module.css';\n \n export interface ResourceDiffTableProps {\n@@ -82,31 +82,7 @@ export function ResourceDiffTable(props: ResourceDiffTableProps): JSX.Element |\n       </Table.Thead>\n       <Table.Tbody>\n         {diffTable.map((row) => (\n-          <Table.Tr key={row.key}>\n-            <Table.Td>{row.name}</Table.Td>\n-            <Table.Td className={classes.removed}>\n-              {row.originalValue && (\n-                <ResourcePropertyDisplay\n-                  path={row.path}\n-                  property={row.property}\n-                  propertyType={row.originalValue.type}\n-                  value={row.originalValue.value}\n-                  ignoreMissingValues={true}\n-                />\n-              )}\n-            </Table.Td>\n-            <Table.Td className={classes.added}>\n-              {row.revisedValue && (\n-                <ResourcePropertyDisplay\n-                  path={row.path}\n-                  property={row.property}\n-                  propertyType={row.revisedValue.type}\n-                  value={row.revisedValue.value}\n-                  ignoreMissingValues={true}\n-                />\n-              )}\n-            </Table.Td>\n-          </Table.Tr>\n+          <ResourceDiffRow {...row} />\n         ))}\n       </Table.Tbody>\n     </Table>\n",
    "test_patch": "diff --git a/packages/react/src/ResourceDiffRow/ResourceDiffRow.test.tsx b/packages/react/src/ResourceDiffRow/ResourceDiffRow.test.tsx\nnew file mode 100644\nindex 0000000000..2f49a9708b\n--- /dev/null\n+++ b/packages/react/src/ResourceDiffRow/ResourceDiffRow.test.tsx\n@@ -0,0 +1,84 @@\n+import { Table } from '@mantine/core';\n+import { ResourceDiffRow, ResourceDiffRowProps } from './ResourceDiffRow';\n+import { act, render, screen } from '../test-utils/render';\n+\n+describe('ResourceDiffRow', () => {\n+  function setup(props: ResourceDiffRowProps): void {\n+    render(\n+      <Table>\n+        <ResourceDiffRow {...props} />\n+      </Table>\n+    );\n+  }\n+\n+  test('Text diff', async () => {\n+    await act(async () => {\n+      setup({\n+        name: 'Add name',\n+        path: 'given',\n+        property: undefined,\n+        originalValue: { type: 'string', value: 'Bart' },\n+        revisedValue: { type: 'string', value: 'Homer' },\n+      });\n+    });\n+\n+    expect(await screen.findByText('Homer')).toBeInTheDocument();\n+  });\n+\n+  test('Text Expand/Collapse', async () => {\n+    await act(async () => {\n+      setup({\n+        name: 'Replace sourceCode',\n+        path: 'Bot.sourceCode',\n+        property: {\n+          description: 'Bot source code',\n+          path: 'Bot.sourceCode',\n+          min: 0,\n+          max: 1,\n+          type: [\n+            {\n+              code: 'Attachment',\n+            },\n+          ],\n+        },\n+        originalValue: {\n+          type: 'Attachment',\n+          value: {\n+            contentType: 'text/typescript',\n+            title: 'old.ts',\n+            url: 'http://example.com/old.pdf',\n+          },\n+        },\n+        revisedValue: {\n+          type: 'Attachment',\n+          value: {\n+            contentType: 'text/typescript',\n+            url: 'http://example.com/new.ts',\n+            title: 'new.ts',\n+          },\n+        },\n+      });\n+    });\n+\n+    await act(async () => {\n+      const button = screen.getByText('Expand');\n+      button.click();\n+    });\n+\n+    expect(await screen.queryByText('Expand')).not.toBeInTheDocument();\n+  });\n+\n+  test('No Attachmentcd diff - No Expand button', async () => {\n+    await act(async () => {\n+      setup({\n+        name: 'Add name',\n+        path: 'given',\n+        property: undefined,\n+        originalValue: { type: 'string', value: 'Bart' },\n+        revisedValue: { type: 'string', value: 'Homer' },\n+      });\n+    });\n+\n+    expect(await screen.queryByText('Expand')).not.toBeInTheDocument();\n+  });\n+});\n\ndiff --git a/packages/react/src/ResourceDiffTable/ResourceDiffTable.test.tsx b/packages/react/src/ResourceDiffTable/ResourceDiffTable.test.tsx\nindex 36bf54c949..1eaffe6f79 100644\n--- a/packages/react/src/ResourceDiffTable/ResourceDiffTable.test.tsx\n+++ b/packages/react/src/ResourceDiffTable/ResourceDiffTable.test.tsx\n@@ -233,6 +233,11 @@ describe('ResourceDiffTable', () => {\n \n     expect(await screen.findByText('Replace photo[0]')).toBeInTheDocument();\n \n+    await act(async () => {\n+      const button = screen.getByText('Expand');\n+      button.click();\n+    });\n+\n     // There should be 2 download links\n     expect(screen.getAllByText('Download')).toHaveLength(2);\n   });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5764",
    "pr_id": 5764,
    "issue_id": 3955,
    "repo": "medplum/medplum",
    "problem_statement": "Add smoke tests for basic flows\nWe can start simple for now and slowly add more tests over time.\r\n\r\nTests we should add:\r\n- [x] Email login flow\r\n- [x] Creating resource\r\n- [x] Reading created resource\r\n- [x] Search\r\n- [x] Uploading a binary",
    "issue_word_count": 40,
    "test_files_count": 7,
    "non_test_files_count": 5,
    "pr_changed_files": [
      ".github/workflows/build.yml",
      ".gitignore",
      "package-lock.json",
      "packages/e2e/README.md",
      "packages/e2e/content/frodo_baggins.png",
      "packages/e2e/package.json",
      "packages/e2e/playwright.config.ts",
      "packages/e2e/smoke/medplum.smoke.test.ts",
      "packages/e2e/tsconfig.json",
      "packages/server/src/config.ts",
      "postgres/init_test.sql",
      "sonar-project.properties"
    ],
    "pr_changed_test_files": [
      "packages/e2e/README.md",
      "packages/e2e/content/frodo_baggins.png",
      "packages/e2e/package.json",
      "packages/e2e/playwright.config.ts",
      "packages/e2e/smoke/medplum.smoke.test.ts",
      "packages/e2e/tsconfig.json",
      "postgres/init_test.sql"
    ],
    "base_commit": "cb94ab3f29247cd97edf791c78616a2a8b971d49",
    "head_commit": "52c2c7cb479307c6330ad373a27c08d9e5b36d1c",
    "repo_url": "https://github.com/medplum/medplum/pull/5764",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5764",
    "dockerfile": "",
    "pr_merged_at": "2025-01-15T21:55:34.000Z",
    "patch": "diff --git a/.github/workflows/build.yml b/.github/workflows/build.yml\nindex 464f871d28..9e9e8d87d8 100644\n--- a/.github/workflows/build.yml\n+++ b/.github/workflows/build.yml\n@@ -243,6 +243,134 @@ jobs:\n           name: medplum-code-coverage\n           path: coverage/lcov.info\n \n+  e2e:\n+    name: Run e2e tests\n+    runs-on: ubuntu-latest\n+    timeout-minutes: 30\n+    needs: [build]\n+    strategy:\n+      matrix:\n+        node-version: [20, 22]\n+        pg-version: [14, 16]\n+        redis-version: [6, 7]\n+    env:\n+      NODE_OPTIONS: --max-old-space-size=8192\n+      NODE_VERSION: ${{ matrix.node-version }}\n+      PG_VERSION: ${{ matrix.pg-version }}\n+      REDIS_VERSION: ${{ matrix.redis-version }}\n+      SECRETS_TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}\n+    services:\n+      postgres:\n+        image: postgres:${{ matrix.pg-version }}\n+        env:\n+          POSTGRES_DB: medplum\n+          POSTGRES_USER: medplum\n+          POSTGRES_PASSWORD: medplum\n+        options: >-\n+          --health-cmd pg_isready\n+          --health-interval 10s\n+          --health-timeout 5s\n+          --health-retries 5\n+        ports:\n+          - 5432:5432\n+      redis:\n+        image: redis:${{ matrix.redis-version }}\n+        options: >-\n+          --health-cmd \"redis-cli ping\"\n+          --health-interval 10s\n+          --health-timeout 5s\n+          --health-retries 5\n+        ports:\n+          - 6379:6379\n+\n+    steps:\n+      - uses: actions/checkout@v4\n+        with:\n+          fetch-depth: 0\n+      - uses: actions/setup-node@v4\n+        with:\n+          node-version: ${{ matrix.node-version }}\n+          registry-url: 'https://registry.npmjs.org'\n+      - name: Cache node modules\n+        uses: actions/cache@v4\n+        env:\n+          cache-name: cache-node-modules\n+        with:\n+          path: ~/.npm\n+          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}\n+          restore-keys: |\n+            ${{ runner.os }}-build-${{ env.cache-name }}-\n+            ${{ runner.os }}-build-\n+            ${{ runner.os }}-\n+      - id: install\n+        name: Install deps\n+        run: npm ci --maxsockets 1\n+      - name: Setup TurboRepo\n+        # Conditionally setup turborepo\n+        # In the past, turborepo would silently ignore empty environment variables\n+        # This is no longer the case, so we need to check if the secret is set\n+        # You cannot use `if: ${{ secrets.TURBO_TOKEN != '' }}` because secrets are not available in the `if` condition\n+        if: ${{ env.SECRETS_TURBO_TOKEN != '' }}\n+        run: |\n+          echo \"TURBO_TOKEN=${{ secrets.TURBO_TOKEN }}\" >> $GITHUB_ENV\n+          echo \"TURBO_TEAM=${{ secrets.TURBO_TEAM }}\" >> $GITHUB_ENV\n+          echo \"TURBO_REMOTE_ONLY=${{ secrets.TURBO_REMOTE_ONLY }}\" >> $GITHUB_ENV\n+      - name: Wait for PostgreSQL\n+        run: |\n+          until pg_isready -h localhost -p 5432; do\n+            echo \"Waiting for postgres...\"\n+            sleep 2\n+          done\n+      - name: Run additional setup SQL\n+        run: PGPASSWORD=medplum psql -h localhost -U medplum -d medplum -f ./postgres/init_test.sql\n+        env:\n+          PGPASSWORD: medplum\n+      - name: Install playwright\n+        run: npx playwright install --with-deps chromium\n+      - name: Build Medplum\n+        run: npm run build:fast\n+      - name: Start server and app\n+        run: |\n+          pushd packages/server\n+          npm run start &\n+          popd\n+          pushd packages/app\n+          npm run dev &\n+          popd\n+        env:\n+          REDIS_PASSWORD_DISABLED_IN_TESTS: 1\n+      - name: Wait for deployment to be ready\n+        run: |\n+          # Add retry mechanism for deployment readiness check\n+          MAX_RETRIES=10\n+          RETRY_COUNT=0\n+\n+          until curl -s -f http://localhost:8103/healthcheck > /dev/null; do\n+            if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then\n+              echo \"Max retries reached. Deployment not ready.\"\n+              exit 1\n+            fi\n+            \n+            RETRY_COUNT=$((RETRY_COUNT + 1))\n+            echo \"Waiting for deployment to be ready... (Attempt $RETRY_COUNT/$MAX_RETRIES)\"\n+            sleep 30\n+          done\n+      - name: Run e2e tests\n+        # TODO: Later on, we can change this to test:e2e to run all e2e tests, when we have more\n+        run: |\n+          pushd packages/e2e\n+          npm run test:smoke\n+          popd\n+      - name: Upload test results\n+        if: ${{ matrix.node-version == 20 && matrix.pg-version == 14 && matrix.redis-version == 7 }}\n+        uses: actions/upload-artifact@v4\n+        with:\n+          name: e2e-test-results\n+          path: |\n+            packages/e2e/playwright-report/\n+            packages/e2e/test-results/\n+          retention-days: 30\n+\n   build-docs:\n     name: Build the docs\n     runs-on: ubuntu-latest\n\ndiff --git a/.gitignore b/.gitignore\nindex f96694f689..9bf0355540 100644\n--- a/.gitignore\n+++ b/.gitignore\n@@ -90,4 +90,9 @@ override.tf.json\n # Ignore CLI configuration files\n .terraformrc\n terraform.rc\n-*.bak\n\\ No newline at end of file\n+*.bak\n+\n+# Playwright\n+test-results/\n+playwright-report/\n+playwright/.cache/\n\ndiff --git a/package-lock.json b/package-lock.json\nindex b511ebe6a8..9bf2af2b30 100644\n--- a/package-lock.json\n+++ b/package-lock.json\n@@ -11164,6 +11164,10 @@\n       \"resolved\": \"packages/dosespot-react\",\n       \"link\": true\n     },\n+    \"node_modules/@medplum/e2e\": {\n+      \"resolved\": \"packages/e2e\",\n+      \"link\": true\n+    },\n     \"node_modules/@medplum/eslint-config\": {\n       \"resolved\": \"packages/eslint-config\",\n       \"link\": true\n@@ -13016,6 +13020,22 @@\n         \"url\": \"https://opencollective.com/unts\"\n       }\n     },\n+    \"node_modules/@playwright/test\": {\n+      \"version\": \"1.49.1\",\n+      \"resolved\": \"https://registry.npmjs.org/@playwright/test/-/test-1.49.1.tgz\",\n+      \"integrity\": \"sha512-Ky+BVzPz8pL6PQxHqNRW1k3mIyv933LML7HktS8uik0bUXNCdPhoS/kLihiO1tMf/egaJb4IutXd7UywvXEW+g==\",\n+      \"devOptional\": true,\n+      \"license\": \"Apache-2.0\",\n+      \"dependencies\": {\n+        \"playwright\": \"1.49.1\"\n+      },\n+      \"bin\": {\n+        \"playwright\": \"cli.js\"\n+      },\n+      \"engines\": {\n+        \"node\": \">=18\"\n+      }\n+    },\n     \"node_modules/@pnpm/config.env-replace\": {\n       \"version\": \"1.1.0\",\n       \"resolved\": \"https://registry.npmjs.org/@pnpm/config.env-replace/-/config.env-replace-1.1.0.tgz\",\n@@ -41508,6 +41528,53 @@\n         \"node\": \">=4\"\n       }\n     },\n+    \"node_modules/playwright\": {\n+      \"version\": \"1.49.1\",\n+      \"resolved\": \"https://registry.npmjs.org/playwright/-/playwright-1.49.1.tgz\",\n+      \"integrity\": \"sha512-VYL8zLoNTBxVOrJBbDuRgDWa3i+mfQgDTrL8Ah9QXZ7ax4Dsj0MSq5bYgytRnDVVe+njoKnfsYkH3HzqVj5UZA==\",\n+      \"devOptional\": true,\n+      \"license\": \"Apache-2.0\",\n+      \"dependencies\": {\n+        \"playwright-core\": \"1.49.1\"\n+      },\n+      \"bin\": {\n+        \"playwright\": \"cli.js\"\n+      },\n+      \"engines\": {\n+        \"node\": \">=18\"\n+      },\n+      \"optionalDependencies\": {\n+        \"fsevents\": \"2.3.2\"\n+      }\n+    },\n+    \"node_modules/playwright-core\": {\n+      \"version\": \"1.49.1\",\n+      \"resolved\": \"https://registry.npmjs.org/playwright-core/-/playwright-core-1.49.1.tgz\",\n+      \"integrity\": \"sha512-BzmpVcs4kE2CH15rWfzpjzVGhWERJfmnXmniSyKeRZUs9Ws65m+RGIi7mjJK/euCegfn3i7jvqWeWyHe9y3Vgg==\",\n+      \"devOptional\": true,\n+      \"license\": \"Apache-2.0\",\n+      \"bin\": {\n+        \"playwright-core\": \"cli.js\"\n+      },\n+      \"engines\": {\n+        \"node\": \">=18\"\n+      }\n+    },\n+    \"node_modules/playwright/node_modules/fsevents\": {\n+      \"version\": \"2.3.2\",\n+      \"resolved\": \"https://registry.npmjs.org/fsevents/-/fsevents-2.3.2.tgz\",\n+      \"integrity\": \"sha512-xiqMQR4xAeHTuB9uWm+fFRcIOgKBMiOBP+eXiyT7jsgVCq1bkVygt00oASowB7EdtpOHaaPgKt812P9ab+DDKA==\",\n+      \"hasInstallScript\": true,\n+      \"license\": \"MIT\",\n+      \"optional\": true,\n+      \"os\": [\n+        \"darwin\"\n+      ],\n+      \"peer\": true,\n+      \"engines\": {\n+        \"node\": \"^8.16.0 || ^10.6.0 || >=11.0.0\"\n+      }\n+    },\n     \"node_modules/plist\": {\n       \"version\": \"3.1.0\",\n       \"resolved\": \"https://registry.npmjs.org/plist/-/plist-3.1.0.tgz\",\n@@ -53366,6 +53433,17 @@\n         \"react\": \"^18.0.0\"\n       }\n     },\n+    \"packages/e2e\": {\n+      \"name\": \"@medplum/e2e\",\n+      \"version\": \"3.2.27\",\n+      \"license\": \"Apache-2.0\",\n+      \"devDependencies\": {\n+        \"@playwright/test\": \"1.49.1\"\n+      },\n+      \"engines\": {\n+        \"node\": \">=18.0.0\"\n+      }\n+    },\n     \"packages/eslint-config\": {\n       \"name\": \"@medplum/eslint-config\",\n       \"version\": \"3.2.27\",\n\ndiff --git a/packages/server/src/config.ts b/packages/server/src/config.ts\nindex aaf883fe3f..caa015cc67 100644\n--- a/packages/server/src/config.ts\n+++ b/packages/server/src/config.ts\n@@ -212,7 +212,6 @@ export async function loadTestConfig(): Promise<MedplumServerConfig> {\n   config.emailProvider = 'none';\n   config.logLevel = 'error';\n   config.defaultRateLimit = -1; // Disable rate limiter by default in tests\n-\n   return config;\n }\n \n\ndiff --git a/sonar-project.properties b/sonar-project.properties\nindex c31b171b5d..df186d2ea0 100644\n--- a/sonar-project.properties\n+++ b/sonar-project.properties\n@@ -16,6 +16,7 @@ sonar.exclusions=**/node_modules/**,\\\n   **/__mocks__/**,\\\n   packages/core/src/base-schema.json,\\\n   packages/docs/**/*,\\\n+  packages/e2e/**/*,\\\n   packages/examples/src/**/*,\\\n   packages/fhirtypes/**/*,\\\n   packages/generator/**/*,\\\n",
    "test_patch": "diff --git a/packages/e2e/README.md b/packages/e2e/README.md\nnew file mode 100644\nindex 0000000000..5022ccb76b\n--- /dev/null\n+++ b/packages/e2e/README.md\n@@ -0,0 +1,31 @@\n+# @medplum/e2e\n+\n+A collection of end-to-end tests to run against Medplum\n+\n+## Getting started\n+\n+Before running any tests, you have to install Playwright in your local environment. To do this, run the following command in this directory:\n+\n+```bash\n+npm run playwright:install\n+```\n+\n+This installs Playwright along with the required Chromium dependency.\n+\n+## Running the smoke tests\n+\n+To run the tests, after making sure that both `@medplum/server` and `@medplum/app` are running, run the following command:\n+\n+```bash\n+npm run test:smoke\n+```\n+\n+## Writing tests\n+\n+Aside from writing tests manually, you can also use the Playwright codegen tool to create tests by clicking through scenarios in the actual app.\n+\n+To use the tool, start both `@medplum/server` and `@medplum/app` locally on the default ports and then run the following command:\n+\n+```bash\n+npm run playwright:codegen\n+```\n\ndiff --git a/packages/e2e/content/frodo_baggins.png b/packages/e2e/content/frodo_baggins.png\nnew file mode 100644\nindex 0000000000..f7285a9c0d\nBinary files /dev/null and b/packages/e2e/content/frodo_baggins.png differ\n\ndiff --git a/packages/e2e/package.json b/packages/e2e/package.json\nnew file mode 100644\nindex 0000000000..03f25fd726\n--- /dev/null\n+++ b/packages/e2e/package.json\n@@ -0,0 +1,33 @@\n+{\n+  \"name\": \"@medplum/e2e\",\n+  \"version\": \"3.2.27\",\n+  \"description\": \"End-to-end tests for Medplum\",\n+  \"keywords\": [\n+    \"e2e\",\n+    \"end-to-end\",\n+    \"smoke\",\n+    \"test\"\n+  ],\n+  \"homepage\": \"https://github.com/medplum/medplum#readme\",\n+  \"bugs\": {\n+    \"url\": \"https://github.com/medplum/medplum/issues\"\n+  },\n+  \"repository\": {\n+    \"type\": \"git\",\n+    \"url\": \"git+https://github.com/medplum/medplum.git\",\n+    \"directory\": \"packages/e2e\"\n+  },\n+  \"scripts\": {\n+    \"playwright:install\": \"npx playwright install --with-deps chromium\",\n+    \"playwright:codegen\": \"npx playwright codegen http://localhost:3000\",\n+    \"test:smoke\": \"npx playwright test smoke/medplum.smoke.test.ts --reporter=list,html\"\n+  },\n+  \"license\": \"Apache-2.0\",\n+  \"author\": \"Medplum <hello@medplum.com>\",\n+  \"devDependencies\": {\n+    \"@playwright/test\": \"1.49.1\"\n+  },\n+  \"engines\": {\n+    \"node\": \">=18.0.0\"\n+  }\n+}\n\ndiff --git a/packages/e2e/playwright.config.ts b/packages/e2e/playwright.config.ts\nnew file mode 100644\nindex 0000000000..b78e4c31e4\n--- /dev/null\n+++ b/packages/e2e/playwright.config.ts\n@@ -0,0 +1,29 @@\n+import { PlaywrightTestConfig } from '@playwright/test';\n+\n+const config: PlaywrightTestConfig = {\n+  testDir: './',\n+  timeout: 30000,\n+  expect: {\n+    timeout: 5000,\n+  },\n+  use: {\n+    baseURL: 'http://localhost:3000',\n+    screenshot: 'only-on-failure',\n+    video: 'retain-on-failure',\n+    trace: 'retain-on-failure',\n+  },\n+  projects: [\n+    {\n+      name: 'Chrome',\n+      use: {\n+        browserName: 'chromium',\n+      },\n+    },\n+  ],\n+  // Retry failed tests to handle potential flakiness\n+  retries: 2,\n+  // Run tests in parallel\n+  workers: 3,\n+};\n+\n+export default config;\n\ndiff --git a/packages/e2e/smoke/medplum.smoke.test.ts b/packages/e2e/smoke/medplum.smoke.test.ts\nnew file mode 100644\nindex 0000000000..8bce7a7b29\n--- /dev/null\n+++ b/packages/e2e/smoke/medplum.smoke.test.ts\n@@ -0,0 +1,114 @@\n+import { expect, Page, test } from '@playwright/test';\n+import path from 'node:path';\n+\n+test.describe('Medplum App Smoke Tests', () => {\n+  test.beforeEach(async ({ page }) => {\n+    await page.goto('http://localhost:3000');\n+  });\n+\n+  // TODO: Work around recaptcha\n+  test.skip('Register new user', async ({ page }) => {\n+    // We should automatically be redirected to the signin form\n+    await expect(page).toHaveURL(/^http:\\/\\/localhost:3000\\/signin/);\n+\n+    // Make sure the sign in form is there\n+    await expect(page.locator('form')).toContainText('Email *');\n+    await expect(page.getByRole('button', { name: 'Next' })).toBeVisible();\n+    await expect(page.getByRole('button', { name: 'Register' })).toBeVisible();\n+\n+    // Navigate to sign up form\n+    await page.getByRole('button', { name: 'Register' }).click();\n+    await expect(page).toHaveURL('http://localhost:3000/register');\n+\n+    // Fill out sign up form\n+    await page.getByPlaceholder('First name').fill('Test');\n+    await page.getByPlaceholder('Last name').fill('User');\n+    await page.getByPlaceholder('name@domain.com').fill('test@gmail.com');\n+    await page.getByLabel('Password *').fill('TestTest123%');\n+    await page.getByLabel('Remember me').check();\n+    await page.getByRole('button', { name: 'Create account' }).click();\n+\n+    await expect(page).toHaveURL('http://localhost:3000/register');\n+    await page.getByPlaceholder('My Project').fill('Test Project');\n+    await page.getByRole('button', { name: 'Create project' }).click();\n+  });\n+\n+  test('Sign in', async ({ page }) => {\n+    await signIn(page, 'admin@example.com', 'medplum_admin');\n+  });\n+\n+  test('Create a patient', async ({ page }) => {\n+    await signIn(page, 'admin@example.com', 'medplum_admin');\n+\n+    await page.getByRole('button', { name: 'Medplum Logo' }).click();\n+    await page.getByRole('link', { name: 'Patient' }).click();\n+    await page.getByRole('button', { name: 'New...' }).click();\n+    await page.getByRole('button', { name: 'Add Name' }).click();\n+    await page.getByPlaceholder('Given').fill('Frodo');\n+    await page.getByPlaceholder('Family').fill('Baggins');\n+    await page.getByRole('button', { name: 'Add', exact: true }).click();\n+    await page.getByRole('button', { name: 'Create' }).click();\n+    await expect(page).toHaveURL(/^http:\\/\\/localhost:3000\\/Patient\\/[a-zA-Z0-9]+(?:-[a-zA-Z0-9]+)*$/);\n+    await expect(page.getByTestId('timeline-item').getByText('Frodo Baggins')).toBeVisible();\n+  });\n+\n+  test('Search for patient via searchbar', async ({ page }) => {\n+    await signIn(page, 'admin@example.com', 'medplum_admin');\n+\n+    await page.getByPlaceholder('Search').fill('Frodo Baggins');\n+    await expect(page.getByTestId('options')).toBeVisible();\n+    await page.getByText('FBFrodo Baggins').first().click();\n+\n+    await page.getByTestId('timeline-item').getByText('Frodo Baggins').click();\n+  });\n+\n+  test('Search for patient via permalink', async ({ page }) => {\n+    await signIn(page, 'admin@example.com', 'medplum_admin');\n+\n+    await page.goto('http://localhost:3000/Patient?name=Frodo&_sort=-_lastUpdated');\n+    await expect(page.getByTestId('search-control-row').first().locator('div')).toContainText('Frodo Baggins');\n+  });\n+\n+  test('Upload patient profile photo', async ({ page }) => {\n+    await signIn(page, 'admin@example.com', 'medplum_admin');\n+\n+    await page.goto('http://localhost:3000/Patient?name=Frodo&_sort=-_lastUpdated');\n+    await expect(page.getByTestId('search-control-row').first().locator('div')).toContainText('Frodo Baggins');\n+\n+    // Click on patient\n+    await page.getByTestId('search-control-row').first().locator('div').click();\n+\n+    // Edit and upload image\n+    await page.getByRole('tab', { name: 'Edit' }).click();\n+    await page\n+      .getByTestId('upload-file-input')\n+      .setInputFiles(path.resolve(__dirname, '../content', 'frodo_baggins.png'));\n+    await page.getByRole('button', { name: 'Update' }).click();\n+\n+    await expect(page.getByTestId('attachment-image')).toBeVisible();\n+    await page.getByRole('tab', { name: 'Details' }).click();\n+    await expect(page.getByTestId('attachment-details')).toBeVisible();\n+    await expect(page.getByTestId('attachment-details')).toContainText('frodo_baggins.png');\n+  });\n+});\n+\n+async function signIn(page: Page, email: string, password: string): Promise<void> {\n+  // We should automatically be redirected to the signin form\n+  await expect(page).toHaveURL(/^http:\\/\\/localhost:3000\\/signin/);\n+\n+  // Make sure the sign in form is there\n+  await expect(page.locator('form')).toContainText('Email *');\n+  await expect(page.getByRole('button', { name: 'Next' })).toBeVisible();\n+  await expect(page.getByRole('button', { name: 'Register' })).toBeVisible();\n+\n+  // Fill out sign in form\n+  await page.getByPlaceholder('name@domain.com').fill(email);\n+  await page.getByRole('button', { name: 'Next' }).click();\n+  await page.getByLabel('Password *').fill(password);\n+  await page.getByLabel('Remember me').check();\n+  await page.getByRole('button', { name: 'Sign in' }).click();\n+\n+  // Make sure we ended up on the right page\n+  await expect(page).toHaveURL(/^http:\\/\\/localhost:3000\\/Patient\\?/);\n+  await expect(page.locator('div').filter({ hasText: /^Medplum Logo$/ })).toBeVisible();\n+}\n\ndiff --git a/packages/e2e/tsconfig.json b/packages/e2e/tsconfig.json\nnew file mode 100644\nindex 0000000000..3815f36df4\n--- /dev/null\n+++ b/packages/e2e/tsconfig.json\n@@ -0,0 +1,4 @@\n+{\n+  \"extends\": \"../../tsconfig.json\",\n+  \"include\": [\"smoke/**/*.ts\"]\n+}\n\ndiff --git a/postgres/init_test.sql b/postgres/init_test.sql\nindex c41f5f7503..871da7a15e 100644\n--- a/postgres/init_test.sql\n+++ b/postgres/init_test.sql\n@@ -8,4 +8,4 @@ CREATE USER medplum_test_readonly WITH PASSWORD 'medplum_test_readonly';\n GRANT CONNECT ON DATABASE medplum_test TO medplum_test_readonly;\n GRANT USAGE ON SCHEMA public TO medplum_test_readonly;\n GRANT SELECT ON ALL TABLES IN SCHEMA public TO medplum_test_readonly;\n-ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO medplum_test_readonly;\n\\ No newline at end of file\n+ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO medplum_test_readonly;\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5753",
    "pr_id": 5753,
    "issue_id": 5729,
    "repo": "medplum/medplum",
    "problem_statement": "\"Refused to connect to 'https://storage.medplum.com/binary/{...}' because it violates the document's Content Security Policy.\"\nWith this error we also get a more specific error:\r\n`client.ts:3263 Refused to connect to 'https://storage.medplum.com/binary/{...}' because it violates the following Content Security Policy directive: \"connect-src 'self' api.medplum.com *.google.com\".`\r\n\r\nThis seems to be because we have never really needed `storage.medplum.com` to be directly fetchable within appdot, since we typically use some kind of i-frame for most content types. Now after adding the C-CDA viewer in https://github.com/medplum/medplum/pull/5657, I think we need to add `config.storageDomainName` to the `content-src` string in our CDK config.\r\n",
    "issue_word_count": 121,
    "test_files_count": 4,
    "non_test_files_count": 6,
    "pr_changed_files": [
      "packages/cdk/src/storage.ts",
      "packages/core/src/client.test.ts",
      "packages/core/src/client.ts",
      "packages/core/src/contenttype.ts",
      "packages/react/src/AttachmentDisplay/AttachmentDisplay.test.tsx",
      "packages/react/src/AttachmentDisplay/AttachmentDisplay.tsx",
      "packages/react/src/CcdaDisplay/CcdaDisplay.test.tsx",
      "packages/react/src/CcdaDisplay/CcdaDisplay.tsx",
      "packages/react/src/XmlDisplay/XmlDisplay.test.tsx",
      "packages/react/src/XmlDisplay/XmlDisplay.tsx"
    ],
    "pr_changed_test_files": [
      "packages/core/src/client.test.ts",
      "packages/react/src/AttachmentDisplay/AttachmentDisplay.test.tsx",
      "packages/react/src/CcdaDisplay/CcdaDisplay.test.tsx",
      "packages/react/src/XmlDisplay/XmlDisplay.test.tsx"
    ],
    "base_commit": "3953e2b2d023fdc1db8690fede2f99bae5de3527",
    "head_commit": "f151aa62959509bebfc2eeb7d5480a5dcb2e13e0",
    "repo_url": "https://github.com/medplum/medplum/pull/5753",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5753",
    "dockerfile": "",
    "pr_merged_at": "2025-01-17T02:24:41.000Z",
    "patch": "diff --git a/packages/cdk/src/storage.ts b/packages/cdk/src/storage.ts\nindex 2fc3638f69..9dbb8d2e92 100644\n--- a/packages/cdk/src/storage.ts\n+++ b/packages/cdk/src/storage.ts\n@@ -88,9 +88,18 @@ export class Storage extends Construct {\n             },\n           ],\n         },\n+        corsBehavior: {\n+          accessControlAllowCredentials: false,\n+          accessControlAllowOrigins: [config.appDomainName, 'https://ccda.medplum.com'],\n+          accessControlAllowHeaders: ['*'],\n+          accessControlAllowMethods: ['GET', 'HEAD', 'OPTIONS'],\n+          accessControlMaxAge: Duration.seconds(600),\n+          originOverride: false,\n+        },\n         securityHeadersBehavior: {\n           contentSecurityPolicy: {\n-            contentSecurityPolicy: \"default-src 'none'; base-uri 'none'; form-action 'none'; frame-ancestors *;\",\n+            contentSecurityPolicy:\n+              \"default-src 'none'; connect-src https://ccda.medplum.com; base-uri 'none'; form-action 'none'; frame-ancestors *;\",\n             override: true,\n           },\n           contentTypeOptions: { override: true },\n\ndiff --git a/packages/core/src/client.ts b/packages/core/src/client.ts\nindex 225c9280fe..c3ed81ed88 100644\n--- a/packages/core/src/client.ts\n+++ b/packages/core/src/client.ts\n@@ -2160,7 +2160,38 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n     arg4?: (e: ProgressEvent) => void,\n     arg5?: MedplumRequestOptions\n   ): Promise<Attachment> {\n-    const createBinaryOptions = normalizeCreateBinaryOptions(arg1, arg2, arg3, arg4);\n+    let createBinaryOptions = normalizeCreateBinaryOptions(arg1, arg2, arg3, arg4);\n+\n+    if (createBinaryOptions.contentType === ContentType.XML) {\n+      const fileData = createBinaryOptions.data;\n+      let fileStr: string;\n+\n+      if (fileData instanceof Blob) {\n+        fileStr = await new Promise<string>((resolve, reject) => {\n+          const reader = new FileReader();\n+          reader.onload = () => {\n+            if (!reader.result) {\n+              reject(new Error('Failed to load file'));\n+              return;\n+            }\n+            resolve(reader.result as string);\n+          };\n+          reader.readAsText(fileData, 'utf-8');\n+        });\n+      } else if (ArrayBuffer.isView(fileData)) {\n+        fileStr = new TextDecoder().decode(fileData);\n+      } else {\n+        fileStr = fileData;\n+      }\n+\n+      // Both of the above strings are required to be within a valid C-CDA document\n+      // The root element in a CDA document should be a \"ClinicalDocument\"\n+      // \"urn:hl7-org:v3\" is a required namespace to be referenced by all valid C-CDA documents as well\n+      if (fileStr.includes('<ClinicalDocument') && fileStr.includes('xmlns=\"urn:hl7-org:v3\"')) {\n+        createBinaryOptions = { ...createBinaryOptions, contentType: ContentType.CDA_XML };\n+      }\n+    }\n+\n     const requestOptions = arg5 ?? (typeof arg2 === 'object' ? arg2 : {});\n     const binary = await this.createBinary(createBinaryOptions, requestOptions);\n     return {\n\ndiff --git a/packages/core/src/contenttype.ts b/packages/core/src/contenttype.ts\nindex 797bc1c264..0bfee59de5 100644\n--- a/packages/core/src/contenttype.ts\n+++ b/packages/core/src/contenttype.ts\n@@ -18,4 +18,7 @@ export const ContentType = {\n   TEXT: 'text/plain',\n   TYPESCRIPT: 'text/typescript',\n   PING: 'x-application/ping',\n+  XML: 'text/xml',\n+  // See: https://www.iana.org/assignments/media-types/application/cda+xml\n+  CDA_XML: 'application/cda+xml',\n } as const;\n\ndiff --git a/packages/react/src/AttachmentDisplay/AttachmentDisplay.tsx b/packages/react/src/AttachmentDisplay/AttachmentDisplay.tsx\nindex 5b8813352d..96c5834b3d 100644\n--- a/packages/react/src/AttachmentDisplay/AttachmentDisplay.tsx\n+++ b/packages/react/src/AttachmentDisplay/AttachmentDisplay.tsx\n@@ -1,7 +1,8 @@\n import { Anchor } from '@mantine/core';\n+import { ContentType } from '@medplum/core';\n import { Attachment } from '@medplum/fhirtypes';\n import { useCachedBinaryUrl } from '@medplum/react-hooks';\n-import { XmlDisplay } from '../XmlDisplay/XmlDisplay';\n+import { CcdaDisplay } from '../CcdaDisplay/CcdaDisplay';\n \n export interface AttachmentDisplayProps {\n   readonly value?: Attachment;\n@@ -26,7 +27,7 @@ export function AttachmentDisplay(props: AttachmentDisplayProps): JSX.Element |\n           <source type={contentType} src={url} />\n         </video>\n       )}\n-      {((contentType?.startsWith('text/') && contentType !== 'text/xml') ||\n+      {(contentType?.startsWith('text/') ||\n         contentType === 'application/json' ||\n         contentType === 'application/pdf') && (\n         <div data-testid=\"attachment-iframe\" style={{ maxWidth: props.maxWidth, minHeight: 400 }}>\n@@ -40,7 +41,7 @@ export function AttachmentDisplay(props: AttachmentDisplayProps): JSX.Element |\n           />\n         </div>\n       )}\n-      {contentType === 'text/xml' && <XmlDisplay url={url} />}\n+      {contentType === ContentType.CDA_XML && <CcdaDisplay url={url} />}\n       <div data-testid=\"download-link\" style={{ padding: '2px 16px 16px 16px' }}>\n         <Anchor\n           // use the `uncachedUrl` to download the file as the cached URL may expire by the time the user clicks the download link\n\ndiff --git a/packages/react/src/CcdaDisplay/CcdaDisplay.tsx b/packages/react/src/CcdaDisplay/CcdaDisplay.tsx\nindex 7f2888782e..6f67896562 100644\n--- a/packages/react/src/CcdaDisplay/CcdaDisplay.tsx\n+++ b/packages/react/src/CcdaDisplay/CcdaDisplay.tsx\n@@ -4,26 +4,26 @@ import { sendCommand } from '../utils/dom';\n const CCDA_VIEWER_URL = 'https://ccda.medplum.com';\n \n export interface CcdaDisplayProps {\n-  readonly xml?: string;\n+  readonly url?: string;\n   readonly maxWidth?: number;\n }\n \n export function CcdaDisplay(props: CcdaDisplayProps): JSX.Element | null {\n-  const { xml } = props;\n+  const { url } = props;\n   const [shouldSend, setShouldSend] = useState(false);\n   const iframeRef = useRef(null);\n \n   useEffect(() => {\n-    if (!xml) {\n+    if (!url) {\n       return;\n     }\n     if (shouldSend && iframeRef.current) {\n-      sendCommand(iframeRef.current, { command: 'setCcdaXml', value: xml }).catch(console.error);\n+      sendCommand(iframeRef.current, { command: 'loadCcdaXml', value: url }).catch(console.error);\n       setShouldSend(false);\n     }\n-  }, [xml, shouldSend]);\n+  }, [url, shouldSend]);\n \n-  if (!xml) {\n+  if (!url) {\n     return null;\n   }\n \n\ndiff --git a/packages/react/src/XmlDisplay/XmlDisplay.tsx b/packages/react/src/XmlDisplay/XmlDisplay.tsx\ndeleted file mode 100644\nindex 3b090448f9..0000000000\n--- a/packages/react/src/XmlDisplay/XmlDisplay.tsx\n+++ /dev/null\n@@ -1,75 +0,0 @@\n-import { Center } from '@mantine/core';\n-import { useMedplum } from '@medplum/react-hooks';\n-import { useEffect, useRef, useState } from 'react';\n-import { CcdaDisplay } from '../CcdaDisplay/CcdaDisplay';\n-import { Document } from '../Document/Document';\n-import { Loading } from '../Loading/Loading';\n-\n-export interface XmlDisplayProps {\n-  readonly url?: string;\n-  readonly maxWidth?: number;\n-}\n-\n-export function XmlDisplay(props: XmlDisplayProps): JSX.Element | null {\n-  const { url } = props;\n-  const medplum = useMedplum();\n-  const [xml, setXml] = useState<string>();\n-  const [xmlIsCcda, setXmlIsCcda] = useState<boolean>();\n-  const iframeRef = useRef(null);\n-\n-  useEffect(() => {\n-    if (!url) {\n-      return;\n-    }\n-\n-    medplum\n-      .download(url)\n-      .then((blob) => blob.text().then(setXml))\n-      .catch(console.error);\n-  }, [medplum, url]);\n-\n-  useEffect(() => {\n-    if (!xml) {\n-      return;\n-    }\n-    // Both of these strings are required to be within a valid C-CDA document\n-    // The root element in a CDA document should be a \"ClinicalDocument\"\n-    // \"urn:hl7-org:v3\" is a required namespace to be referenced by all valid C-CDA documents as well\n-    if (xml.includes('<ClinicalDocument') && xml.includes('xmlns=\"urn:hl7-org:v3\"')) {\n-      setXmlIsCcda(true);\n-    } else {\n-      setXmlIsCcda(false);\n-    }\n-  }, [xml]);\n-\n-  if (!url) {\n-    return null;\n-  }\n-\n-  if (!xml) {\n-    return (\n-      <Document>\n-        <Center>\n-          <Loading />\n-        </Center>\n-      </Document>\n-    );\n-  }\n-\n-  return xmlIsCcda ? (\n-    <CcdaDisplay xml={xml} />\n-  ) : (\n-    <div data-testid=\"xml-display-iframe\" style={{ maxWidth: props.maxWidth, minHeight: 400 }}>\n-      <iframe\n-        title=\"XMLDisplay Iframe\"\n-        width=\"100%\"\n-        height=\"400\"\n-        ref={iframeRef}\n-        src={url}\n-        allowFullScreen={true}\n-        frameBorder={0}\n-        seamless={true}\n-      />\n-    </div>\n-  );\n-}\n",
    "test_patch": "diff --git a/packages/core/src/client.test.ts b/packages/core/src/client.test.ts\nindex 8aaa2dc06b..94d182a792 100644\n--- a/packages/core/src/client.test.ts\n+++ b/packages/core/src/client.test.ts\n@@ -43,6 +43,37 @@ import { MockAsyncClientStorage } from './storage';\n import { getDataType, isDataTypeLoaded, isProfileLoaded } from './typeschema/types';\n import { ProfileResource, createReference, sleep } from './utils';\n \n+const EXAMPLE_XML = `\n+<note>\n+  <to>Frodo</to>\n+  <from>Gandalf</from>\n+  <heading>Reminder</heading>\n+  <body>Don't forget the ring in Gondor!</body>\n+</note>`;\n+\n+const EXAMPLE_CCDA = `\n+<ClinicalDocument xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"urn:hl7-org:v3\" xmlns:voc=\"urn:hl7-org:v3/voc\" xmlns:sdtc=\"urn:hl7-org:sdtc\">\n+  <!-- ** CDA Header ** -->\n+  <realmCode code=\"US\"/>\n+  <typeId extension=\"POCD_HD000040\" root=\"2.16.840.1.113883.1.3\"/>\n+  <!-- CCD document template within C-CDA 2.0-->\n+  <templateId root=\"2.16.840.1.113883.10.20.22.1.2\" extension=\"2014-06-09\"/>\n+  <!-- Globally unique identifier for the document. Can only be [1..1] -->\n+  <id extension=\"EHRVersion2.0\" root=\"be84a8e4-a22e-4210-a4a6-b3c48273e84c\"/>\n+  <code code=\"34133-9\" displayName=\"Summary of episode note\" codeSystem=\"2.16.840.1.113883.6.1\" codeSystemName=\"LOINC\"/>\n+  <!-- Title of this document -->\n+  <title>Summary of Patient Chart</title>\n+  <!-- This is the time of document generation -->\n+  <effectiveTime value=\"20141015103026-0500\"/>\n+  <confidentialityCode code=\"N\" displayName=\"normal\" codeSystem=\"2.16.840.1.113883.5.25\" codeSystemName=\"Confidentiality\"/>\n+  <!-- This is the document language code which uses internet standard RFC 4646. This often differs from patient language within recordTarget -->\n+  <languageCode code=\"en-US\"/>\n+  <setId extension=\"sTT988\" root=\"2.16.840.1.113883.19.5.99999.19\"/>\n+  <!-- Version of this document -->\n+  <versionNumber value=\"1\"/>\n+</ClinicalDocument>\n+`;\n+\n const patientStructureDefinition: StructureDefinition = {\n   resourceType: 'StructureDefinition',\n   url: 'http://hl7.org/fhir/StructureDefinition/Patient',\n@@ -1615,6 +1646,95 @@ describe('Client', () => {\n     );\n   });\n \n+  describe('Create attachment -- XML', () => {\n+    test('Non-CDA XML', async () => {\n+      const fetch = mockFetch(200, {});\n+      const client = new MedplumClient({ fetch });\n+      const result = await client.createAttachment({\n+        data: EXAMPLE_XML,\n+        contentType: ContentType.XML,\n+      });\n+      expect(result).toBeDefined();\n+      expect(fetch).toHaveBeenCalledWith(\n+        'https://api.medplum.com/fhir/R4/Binary',\n+        expect.objectContaining({\n+          method: 'POST',\n+          headers: {\n+            Accept: DEFAULT_ACCEPT,\n+            'Content-Type': ContentType.XML,\n+            'X-Medplum': 'extended',\n+          },\n+        })\n+      );\n+    });\n+\n+    test('C-CDA -- String', async () => {\n+      const fetch = mockFetch(200, {});\n+      const client = new MedplumClient({ fetch });\n+      const result = await client.createAttachment({\n+        data: EXAMPLE_CCDA,\n+        contentType: ContentType.XML,\n+      });\n+      expect(result).toBeDefined();\n+      expect(fetch).toHaveBeenCalledWith(\n+        'https://api.medplum.com/fhir/R4/Binary',\n+        expect.objectContaining({\n+          method: 'POST',\n+          headers: {\n+            Accept: DEFAULT_ACCEPT,\n+            // Make sure the content type is updated\n+            'Content-Type': ContentType.CDA_XML,\n+            'X-Medplum': 'extended',\n+          },\n+        })\n+      );\n+    });\n+\n+    test('C-CDA -- Encoded bytes', async () => {\n+      const fetch = mockFetch(200, {});\n+      const client = new MedplumClient({ fetch });\n+      const result = await client.createAttachment({\n+        data: new TextEncoder().encode(EXAMPLE_CCDA),\n+        contentType: ContentType.XML,\n+      });\n+      expect(result).toBeDefined();\n+      expect(fetch).toHaveBeenCalledWith(\n+        'https://api.medplum.com/fhir/R4/Binary',\n+        expect.objectContaining({\n+          method: 'POST',\n+          headers: {\n+            Accept: DEFAULT_ACCEPT,\n+            // Make sure the content type is updated\n+            'Content-Type': ContentType.CDA_XML,\n+            'X-Medplum': 'extended',\n+          },\n+        })\n+      );\n+    });\n+\n+    test('C-CDA -- File', async () => {\n+      const fetch = mockFetch(200, {});\n+      const client = new MedplumClient({ fetch });\n+      const result = await client.createAttachment({\n+        data: new File([EXAMPLE_CCDA], 'cda.xml'),\n+        contentType: ContentType.XML,\n+      });\n+      expect(result).toBeDefined();\n+      expect(fetch).toHaveBeenCalledWith(\n+        'https://api.medplum.com/fhir/R4/Binary',\n+        expect.objectContaining({\n+          method: 'POST',\n+          headers: {\n+            Accept: DEFAULT_ACCEPT,\n+            // Make sure the content type is updated\n+            'Content-Type': ContentType.CDA_XML,\n+            'X-Medplum': 'extended',\n+          },\n+        })\n+      );\n+    });\n+  });\n+\n   test('Create attachment (deprecated legacy version)', async () => {\n     const fetch = mockFetch(200, {});\n     const client = new MedplumClient({ fetch });\n\ndiff --git a/packages/react/src/AttachmentDisplay/AttachmentDisplay.test.tsx b/packages/react/src/AttachmentDisplay/AttachmentDisplay.test.tsx\nindex 624d679ce6..46d1b59737 100644\n--- a/packages/react/src/AttachmentDisplay/AttachmentDisplay.test.tsx\n+++ b/packages/react/src/AttachmentDisplay/AttachmentDisplay.test.tsx\n@@ -1,16 +1,8 @@\n-import { MedplumClient } from '@medplum/core';\n+import { ContentType, MedplumClient } from '@medplum/core';\n import { MedplumProvider } from '@medplum/react-hooks';\n import { act, render, screen } from '../test-utils/render';\n import { AttachmentDisplay, AttachmentDisplayProps } from './AttachmentDisplay';\n \n-const EXAMPLE_XML = `\n-<note>\n-  <to>Tove</to>\n-  <from>Jani</from>\n-  <heading>Reminder</heading>\n-  <body>Don't forget me this weekend!</body>\n-</note>`;\n-\n function mockFetch(url: string, options: any): Promise<any> {\n   const result: any = {};\n \n@@ -122,22 +114,26 @@ describe('AttachmentDisplay', () => {\n   });\n \n   test('Renders XML', async () => {\n-    jest.spyOn(medplum, 'download').mockImplementation(async (url: URL | string): Promise<Blob> => {\n-      const urlString = url.toString();\n-      if (urlString.endsWith('note.xml')) {\n-        return {\n-          text: () => Promise.resolve(EXAMPLE_XML),\n-        } as unknown as Blob;\n-      }\n-      throw new Error('UNREACHABLE: Invalid url');\n-    });\n     await setup({\n       value: {\n-        contentType: 'text/xml',\n+        contentType: ContentType.XML,\n         url: 'https://example.com/note.xml',\n         title: 'note.xml',\n       },\n     });\n-    expect(await screen.findByTestId('xml-display-iframe')).toBeInTheDocument();\n+    expect(await screen.findByTestId('attachment-iframe')).toBeInTheDocument();\n+    expect(screen.getByText('note.xml')).toBeInTheDocument();\n+  });\n+\n+  test('Renders C-CDA', async () => {\n+    await setup({\n+      value: {\n+        contentType: ContentType.CDA_XML,\n+        url: 'https://example.com/c-cda.xml',\n+        title: 'c-cda.xml',\n+      },\n+    });\n+    expect(await screen.findByTestId('ccda-iframe')).toBeInTheDocument();\n+    expect(screen.getByText('c-cda.xml')).toBeInTheDocument();\n   });\n });\n\ndiff --git a/packages/react/src/CcdaDisplay/CcdaDisplay.test.tsx b/packages/react/src/CcdaDisplay/CcdaDisplay.test.tsx\nindex 5c9826cb28..3a073cb1b6 100644\n--- a/packages/react/src/CcdaDisplay/CcdaDisplay.test.tsx\n+++ b/packages/react/src/CcdaDisplay/CcdaDisplay.test.tsx\n@@ -1,60 +1,56 @@\n+import { ReadablePromise } from '@medplum/core';\n import { MockClient } from '@medplum/mock';\n import { MedplumProvider } from '@medplum/react-hooks';\n import { act, fireEvent, render, screen } from '../test-utils/render';\n import * as domUtils from '../utils/dom';\n import { CcdaDisplay } from './CcdaDisplay';\n \n-const EXAMPLE_CCDA = `\n-<ClinicalDocument xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"urn:hl7-org:v3\" xmlns:voc=\"urn:hl7-org:v3/voc\" xmlns:sdtc=\"urn:hl7-org:sdtc\">\n-  <!-- ** CDA Header ** -->\n-  <realmCode code=\"US\"/>\n-  <typeId extension=\"POCD_HD000040\" root=\"2.16.840.1.113883.1.3\"/>\n-  <!-- CCD document template within C-CDA 2.0-->\n-  <templateId root=\"2.16.840.1.113883.10.20.22.1.2\" extension=\"2014-06-09\"/>\n-  <!-- Globally unique identifier for the document. Can only be [1..1] -->\n-  <id extension=\"EHRVersion2.0\" root=\"be84a8e4-a22e-4210-a4a6-b3c48273e84c\"/>\n-  <code code=\"34133-9\" displayName=\"Summary of episode note\" codeSystem=\"2.16.840.1.113883.6.1\" codeSystemName=\"LOINC\"/>\n-  <!-- Title of this document -->\n-  <title>Summary of Patient Chart</title>\n-  <!-- This is the time of document generation -->\n-  <effectiveTime value=\"20141015103026-0500\"/>\n-  <confidentialityCode code=\"N\" displayName=\"normal\" codeSystem=\"2.16.840.1.113883.5.25\" codeSystemName=\"Confidentiality\"/>\n-  <!-- This is the document language code which uses internet standard RFC 4646. This often differs from patient language within recordTarget -->\n-  <languageCode code=\"en-US\"/>\n-  <setId extension=\"sTT988\" root=\"2.16.840.1.113883.19.5.99999.19\"/>\n-  <!-- Version of this document -->\n-  <versionNumber value=\"1\"/>\n-</ClinicalDocument>\n-`;\n+const EXAMPLE_CCDA_URL = 'http://example.com/ccda';\n \n describe('XmlDisplay', () => {\n   let medplum: MockClient;\n+  let getSpy: jest.SpyInstance;\n+\n+  beforeAll(() => {});\n \n   beforeEach(() => {\n     medplum = new MockClient();\n+    getSpy = jest.spyOn(medplum, 'get').mockImplementation((url: string | URL, _options: any) => {\n+      return new ReadablePromise(\n+        new Promise((resolve, reject) => {\n+          if (url === EXAMPLE_CCDA_URL) {\n+            resolve('EXAMPLE_CCDA');\n+            return;\n+          }\n+          reject(new Error('Invalid route'));\n+        })\n+      );\n+    });\n   });\n \n-  function setup(xml: string | undefined): void {\n-    render(<CcdaDisplay xml={xml} />, ({ children }) => (\n+  function setup(url: string | undefined): void {\n+    render(<CcdaDisplay url={url} />, ({ children }) => (\n       <MedplumProvider medplum={medplum}>{children}</MedplumProvider>\n     ));\n   }\n \n-  test('Does not open Iframe when no XML passed in', async () => {\n+  test('Does not open Iframe when no URL passed in', async () => {\n     setup(undefined);\n     expect(screen.queryByTestId('ccda-iframe')).not.toBeInTheDocument();\n+    expect(getSpy).not.toHaveBeenCalled();\n   });\n \n   test('Renders C-CDA', async () => {\n     const sendCommandSpy = jest.spyOn(domUtils, 'sendCommand').mockImplementation(jest.fn(async () => {}));\n-    setup(EXAMPLE_CCDA);\n+    setup(EXAMPLE_CCDA_URL);\n     expect(await screen.findByTestId('ccda-iframe')).toBeInTheDocument();\n     await act(async () => {\n       fireEvent.load(screen.getByTitle('C-CDA Viewer'));\n     });\n     expect(sendCommandSpy).toHaveBeenCalledWith(expect.any(HTMLIFrameElement), {\n-      command: 'setCcdaXml',\n-      value: EXAMPLE_CCDA,\n+      command: 'loadCcdaXml',\n+      value: EXAMPLE_CCDA_URL,\n     });\n+    expect(getSpy).not.toHaveBeenCalled();\n   });\n });\n\ndiff --git a/packages/react/src/XmlDisplay/XmlDisplay.test.tsx b/packages/react/src/XmlDisplay/XmlDisplay.test.tsx\ndeleted file mode 100644\nindex f9fbcaa0ef..0000000000\n--- a/packages/react/src/XmlDisplay/XmlDisplay.test.tsx\n+++ /dev/null\n@@ -1,74 +0,0 @@\n-import { MedplumRequestOptions } from '@medplum/core';\n-import { MockClient } from '@medplum/mock';\n-import { MedplumProvider } from '@medplum/react-hooks';\n-import { render, screen } from '../test-utils/render';\n-import { XmlDisplay } from './XmlDisplay';\n-\n-const EXAMPLE_CCDA = `\n-<ClinicalDocument xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns=\"urn:hl7-org:v3\" xmlns:voc=\"urn:hl7-org:v3/voc\" xmlns:sdtc=\"urn:hl7-org:sdtc\">\n-\t<!-- ** CDA Header ** -->\n-\t<realmCode code=\"US\"/>\n-\t<typeId extension=\"POCD_HD000040\" root=\"2.16.840.1.113883.1.3\"/>\n-\t<!-- CCD document template within C-CDA 2.0-->\n-\t<templateId root=\"2.16.840.1.113883.10.20.22.1.2\" extension=\"2014-06-09\"/>\n-\t<!-- Globally unique identifier for the document. Can only be [1..1] -->\n-\t<id extension=\"EHRVersion2.0\" root=\"be84a8e4-a22e-4210-a4a6-b3c48273e84c\"/>\n-\t<code code=\"34133-9\" displayName=\"Summary of episode note\" codeSystem=\"2.16.840.1.113883.6.1\" codeSystemName=\"LOINC\"/>\n-\t<!-- Title of this document -->\n-\t<title>Summary of Patient Chart</title>\n-\t<!-- This is the time of document generation -->\n-\t<effectiveTime value=\"20141015103026-0500\"/>\n-\t<confidentialityCode code=\"N\" displayName=\"normal\" codeSystem=\"2.16.840.1.113883.5.25\" codeSystemName=\"Confidentiality\"/>\n-\t<!-- This is the document language code which uses internet standard RFC 4646. This often differs from patient language within recordTarget -->\n-\t<languageCode code=\"en-US\"/>\n-\t<setId extension=\"sTT988\" root=\"2.16.840.1.113883.19.5.99999.19\"/>\n-\t<!-- Version of this document -->\n-\t<versionNumber value=\"1\"/>\n-</ClinicalDocument>\n-`;\n-\n-const EXAMPLE_XML = `\n-<note>\n-  <to>Tove</to>\n-  <from>Jani</from>\n-  <heading>Reminder</heading>\n-  <body>Don't forget me this weekend!</body>\n-</note>`;\n-\n-describe('XmlDisplay', () => {\n-  let medplum: MockClient;\n-\n-  beforeEach(() => {\n-    medplum = new MockClient();\n-    jest\n-      .spyOn(medplum, 'download')\n-      .mockImplementation(async (url: URL | string, _options: MedplumRequestOptions = {}): Promise<Blob> => {\n-        const urlString = url.toString();\n-        if (urlString.endsWith('note.xml')) {\n-          return {\n-            text: () => Promise.resolve(EXAMPLE_XML),\n-          } as unknown as Blob;\n-        }\n-        if (urlString.endsWith('ccda.xml')) {\n-          return {\n-            text: () => Promise.resolve(EXAMPLE_CCDA),\n-          } as unknown as Blob;\n-        }\n-        throw new Error('UNREACHABLE: Invalid url');\n-      });\n-  });\n-\n-  function setup(url: string): void {\n-    render(<XmlDisplay url={url} />, ({ children }) => <MedplumProvider medplum={medplum}>{children}</MedplumProvider>);\n-  }\n-\n-  test('Renders C-CDA with CcdaDisplay', async () => {\n-    setup('http://example.com/ccda.xml');\n-    expect(await screen.findByTestId('ccda-iframe')).toBeInTheDocument();\n-  });\n-\n-  test('Renders other XML via IFrame', async () => {\n-    setup('http://example.com/note.xml');\n-    expect(await screen.findByTestId('xml-display-iframe')).toBeInTheDocument();\n-  });\n-});\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5751",
    "pr_id": 5751,
    "issue_id": 5750,
    "repo": "medplum/medplum",
    "problem_statement": "Enable call-time auto-batch opt-out for MedplumClient\n## Description\r\nCurrently, when a `MedplumClient` is initialized with auto-batching enabled (via `autoBatchTime`), all eligible GET requests to the FHIR API are automatically batched. However, there are cases where users may want to opt-out of auto-batching for specific GET requests while keeping the general auto-batching behavior enabled.\r\n\r\n## Proposed Solution\r\nAdd a new option specific to GET requests by extending the base `MedplumRequestOptions`:\r\n\r\n```typescript\r\nexport interface MedplumGetRequestOptions extends MedplumRequestOptions {\r\n  /**\r\n   * Optional flag to disable auto-batching for this specific request.\r\n   * Only applies when the client is configured with auto-batching enabled.\r\n   */\r\n  disableAutoBatch?: boolean;\r\n}\r\n\r\n// Update relevant method signatures to use the new options\r\nexport interface MedplumClient {\r\n  readResource<K extends ResourceType>(\r\n    resourceType: K,\r\n    id: string,\r\n    options?: MedplumGetRequestOptions\r\n  ): Promise<ExtractResource<K>>;\r\n  \r\n  search<K extends ResourceType>(\r\n    resourceType: K,\r\n    query?: Record<string, string | string[]> | URLSearchParams | undefined,\r\n    options?: MedplumGetRequestOptions\r\n  ): Promise<Bundle<ExtractResource<K>>>;\r\n  \r\n  // ... other FHIR GET methods\r\n}\r\n```\r\n\r\nExample usage:\r\n```typescript\r\n// Client initialized with auto-batching\r\nconst medplum = new MedplumClient({ \r\n  autoBatchTime: 100 \r\n});\r\n\r\n// Normal auto-batched request\r\nawait medplum.readResource('Patient', '123');\r\n\r\n// Opt out of auto-batching for specific request\r\nawait medplum.readResource('Patient', '456', {\r\n  disableAutoBatch: true\r\n});\r\n```\r\n\r\n## Implementation Details\r\n1. Create new `MedplumGetRequestOptions` interface extending `MedplumRequestOptions`\r\n2. Update signatures of GET methods to use the new options type\r\n3. Modify the `get()` method to check for this flag before adding to auto-batch queue:\r\n\r\n```typescript\r\nif (url.startsWith(this.fhirBaseUrl) && this.autoBatchQueue && !options.disableAutoBatch) {\r\n  // ... existing auto-batch logic ...\r\n}\r\n```\r\n\r\n## Benefits\r\n- Provides more granular control over auto-batching behavior\r\n- Maintains clean inheritance from base request options\r\n- Better TypeScript type safety by making the option only available for GET requests\r\n- Maintains backward compatibility\r\n\r\n## Related Issues/PRs\r\n- None\r\n\r\n## Additional Context\r\nThis feature would be particularly useful in scenarios where:\r\n- Certain GET requests need immediate execution\r\n- Debugging specific API calls\r\n- Performance optimization for time-sensitive operations\r\n",
    "issue_word_count": 303,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/core/src/client.test.ts",
      "packages/core/src/client.ts"
    ],
    "pr_changed_test_files": [
      "packages/core/src/client.test.ts"
    ],
    "base_commit": "5b193958d86f34ace98a08d90393dac6e8d1d060",
    "head_commit": "a63f6cc6091d03b288be111a87e1ebb03831b9e4",
    "repo_url": "https://github.com/medplum/medplum/pull/5751",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5751",
    "dockerfile": "",
    "pr_merged_at": "2025-01-13T20:04:54.000Z",
    "patch": "diff --git a/packages/core/src/client.ts b/packages/core/src/client.ts\nindex 56b619789f..225c9280fe 100644\n--- a/packages/core/src/client.ts\n+++ b/packages/core/src/client.ts\n@@ -359,10 +359,17 @@ export interface MedplumRequestOptions extends RequestInit {\n    * Default value is 1000 (1 second).\n    */\n   pollStatusPeriod?: number;\n+\n   /**\n    * Optional max number of retries that should be made in the case of a failed request. Default is `2`.\n    */\n   maxRetries?: number;\n+\n+  /**\n+   * Optional flag to disable auto-batching for this specific request.\n+   * Only applies when the client is configured with auto-batching enabled.\n+   */\n+  disableAutoBatch?: boolean;\n }\n \n export type FetchLike = (url: string, options?: any) => Promise<any>;\n@@ -1072,7 +1079,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n \n     let promise: Promise<T>;\n \n-    if (url.startsWith(this.fhirBaseUrl) && this.autoBatchQueue) {\n+    if (url.startsWith(this.fhirBaseUrl) && this.autoBatchQueue && !options.disableAutoBatch) {\n       promise = new Promise<T>((resolve, reject) => {\n         (this.autoBatchQueue as AutoBatchEntry[]).push({\n           method: 'GET',\n",
    "test_patch": "diff --git a/packages/core/src/client.test.ts b/packages/core/src/client.test.ts\nindex 080f53e63b..8aaa2dc06b 100644\n--- a/packages/core/src/client.test.ts\n+++ b/packages/core/src/client.test.ts\n@@ -3298,6 +3298,41 @@ describe('Client', () => {\n     expect(fetchOptions.headers).not.toHaveProperty('X-Medplum');\n     expect(fetchOptions.headers).not.toHaveProperty('x-medplum');\n   });\n+\n+  test('Call-time auto-batch opt-out', async () => {\n+    const fetch = mockFetch(200, { resourceType: 'Patient', id: '123' });\n+    const client = new MedplumClient({ fetch, autoBatchTime: 50 });\n+\n+    // Make a request with disableAutoBatch=true\n+    const promise1 = client.readResource('Patient', '123', { disableAutoBatch: true });\n+\n+    // Make normal requests that should be batched\n+    const promise2 = client.readResource('Patient', '456');\n+    expect(promise2).toBeDefined();\n+    const promise3 = client.readResource('Patient', '789');\n+    expect(promise3).toBeDefined();\n+\n+    // The first request should complete immediately\n+    await promise1;\n+    expect(fetch).toHaveBeenCalledTimes(1);\n+    expect(fetch).toHaveBeenCalledWith(\n+      'https://api.medplum.com/fhir/R4/Patient/123',\n+      expect.objectContaining({\n+        method: 'GET',\n+      })\n+    );\n+\n+    // The second request should be batched and not executed yet\n+    expect(fetch).toHaveBeenCalledTimes(1);\n+\n+    // Wait for the batch timeout\n+    await new Promise((resolve) => {\n+      setTimeout(resolve, 100);\n+    });\n+\n+    // Now the second request should have been executed\n+    expect(fetch).toHaveBeenCalledTimes(2);\n+  });\n });\n \n describe('Passed in async-backed `ClientStorage`', () => {\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5717",
    "pr_id": 5717,
    "issue_id": 5713,
    "repo": "medplum/medplum",
    "problem_statement": "MedplumClient 'Error parsing response 201 SyntaxError: Unexpected end of JSON input' occurs when body is empty\nDescription:\r\nWhen making a create request, I received a 201 response with an empty body (not empty json, fully empty), the client then raised the following\r\n\r\n```\r\nError parsing response 201 SyntaxError: Unexpected end of JSON input\r\n    at JSON.parse (<anonymous>)\r\n    at parseJSONFromBytes (node:internal/deps/undici/undici:5472:19)\r\n    at successSteps (node:internal/deps/undici/undici:5454:27)\r\n    at fullyReadBody (node:internal/deps/undici/undici:4381:9)\r\n    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)\r\n    at async consumeBody (node:internal/deps/undici/undici:5463:7)\r\n    at It.parseBody (/Users/elaye/project/node_modules/@medplum/core/src/client.ts:3229:15)\r\n    at It.request (/Users/elaye/project/node_modules/@medplum/core/src/client.ts:3198:17)\r\n```\r\n\r\nAfter some digging, what went wrong was as follows:\r\n1.  The response body was EMPTY (not empty json).\r\n2. Client correctly parsed the content-type header of the response and identified it as a json (i.e., the vendor I was polling returned an empty body with a json content-type).\r\n3. The client did not check the response content-length header (which is 0).\r\n4. The client then attempts to parse the body, see it should be a json, and attempts request.json() (which fails on empty body).\r\n\r\n\r\nSuggestions:\r\nEither parse content-length to check if body is empty before calling the parser in line 3198 of the client, or just directly check if the raw body is empty before attempting to parse it as a json.",
    "issue_word_count": 258,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/core/src/client.test.ts",
      "packages/core/src/client.ts"
    ],
    "pr_changed_test_files": [
      "packages/core/src/client.test.ts"
    ],
    "base_commit": "38fe93bd9e5d2957d3b494454e050f6cca5c7e3d",
    "head_commit": "f3ed7113a18e27237a6c048e21f3555aeb6ee61c",
    "repo_url": "https://github.com/medplum/medplum/pull/5717",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5717",
    "dockerfile": "",
    "pr_merged_at": "2024-12-31T01:08:32.000Z",
    "patch": "diff --git a/packages/core/src/client.ts b/packages/core/src/client.ts\nindex 6219a959ba..56b619789f 100644\n--- a/packages/core/src/client.ts\n+++ b/packages/core/src/client.ts\n@@ -3195,20 +3195,20 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n       throw new OperationOutcomeError(notFound);\n     }\n \n-    const obj = await this.parseBody(response, isJson);\n+    const body = await this.parseBody(response, isJson);\n \n     if (\n       (response.status === 200 && options.followRedirectOnOk) ||\n       (response.status === 201 && options.followRedirectOnCreated)\n     ) {\n-      const contentLocation = await tryGetContentLocation(response, obj);\n+      const contentLocation = await tryGetContentLocation(response, body);\n       if (contentLocation) {\n         return this.request('GET', contentLocation, { ...options, body: undefined });\n       }\n     }\n \n     if (response.status === 202 && options.pollStatusOnAccepted) {\n-      const contentLocation = await tryGetContentLocation(response, obj);\n+      const contentLocation = await tryGetContentLocation(response, body);\n       const statusUrl = contentLocation ?? state.statusUrl;\n       if (statusUrl) {\n         return this.pollStatus(statusUrl, options, state);\n@@ -3216,25 +3216,32 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n     }\n \n     if (response.status >= 400) {\n-      throw new OperationOutcomeError(normalizeOperationOutcome(obj));\n+      throw new OperationOutcomeError(normalizeOperationOutcome(body));\n     }\n \n-    return obj;\n+    return body as T;\n   }\n \n-  private async parseBody(response: Response, isJson: boolean | undefined): Promise<any> {\n-    let obj: any = undefined;\n+  private async parseBody(\n+    response: Response,\n+    isJson: boolean | undefined\n+  ): Promise<Record<string, any> | string | undefined> {\n+    let body: Record<string, string> | string | undefined = undefined;\n+    // If there is no content length, don't attempt to parse the body\n+    if (response.headers.get('content-length') === '0') {\n+      return undefined;\n+    }\n     if (isJson) {\n       try {\n-        obj = await response.json();\n+        body = await response.json();\n       } catch (err) {\n         console.error('Error parsing response', response.status, err);\n         throw err;\n       }\n     } else {\n-      obj = await response.text();\n+      body = await response.text();\n     }\n-    return obj;\n+    return body;\n   }\n \n   private async fetchWithRetry(url: string, options: MedplumRequestOptions): Promise<Response> {\n@@ -4092,7 +4099,10 @@ function getWindowOrigin(): string {\n  * @param body - The response body.\n  * @returns A Promise that resolves to the content location string if it is found, or 'undefined' if the content location cannot be determined from the response.\n  */\n-async function tryGetContentLocation(response: Response, body: any): Promise<string | undefined> {\n+async function tryGetContentLocation(\n+  response: Response,\n+  body: Record<string, string> | string | undefined\n+): Promise<string | undefined> {\n   // Accepted content location can come from multiple sources\n   // The authoritative source is the \"Content-Location\" HTTP header.\n   const contentLocation = response.headers.get('content-location');\n",
    "test_patch": "diff --git a/packages/core/src/client.test.ts b/packages/core/src/client.test.ts\nindex a6c4587e5a..080f53e63b 100644\n--- a/packages/core/src/client.test.ts\n+++ b/packages/core/src/client.test.ts\n@@ -1104,6 +1104,46 @@ describe('Client', () => {\n     expect(result).toStrictEqual({});\n   });\n \n+  test('HTTP CREATE with Content-Length 0', async () => {\n+    const consoleErrorSpy = jest.spyOn(console, 'error');\n+    const fetch: FetchLike = async (_url: string, _options: RequestInit): Promise<any> => {\n+      let streamRead = false;\n+      const streamReader = async (type: 'json' | 'blob' | 'text'): Promise<any> => {\n+        if (streamRead) {\n+          throw new Error('Stream already read');\n+        }\n+        streamRead = true;\n+        switch (type) {\n+          case 'json': {\n+            // Simulate parsing non-JSON\n+            // This will always throw\n+            JSON.parse('EMPTY');\n+            break;\n+          }\n+          default:\n+            return '';\n+        }\n+        throw new Error('UNREACHABLE');\n+      };\n+      return Promise.resolve({\n+        ok: true,\n+        status: 201,\n+        headers: new Map<string, string>([\n+          ['content-type', 'application/json'],\n+          ['content-length', '0'],\n+        ]),\n+        blob: () => streamReader('blob'),\n+        json: () => streamReader('json'),\n+        text: () => streamReader('text'),\n+      });\n+    };\n+    const client = new MedplumClient({ fetch });\n+    await expect(client.post('Practitioner/123', { resourceType: 'Practitioner' })).resolves.toStrictEqual(undefined);\n+\n+    expect(consoleErrorSpy).not.toHaveBeenCalled();\n+    consoleErrorSpy.mockRestore();\n+  });\n+\n   test('Read expired and refresh', async () => {\n     let tokenExpired = true;\n \n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5711",
    "pr_id": 5711,
    "issue_id": 5627,
    "repo": "medplum/medplum",
    "problem_statement": "Missing Endpoint /auth/mfa/disable\nThe \"Disable MFA\" endpoint on our MFA page in `app.` seems to be pointing to a missing endpoint. \r\n\r\nhttps://github.com/medplum/medplum/blob/eab9c11a443cb000cf37373c855561cd33c1d01e/packages/app/src/MfaPage.tsx#L36",
    "issue_word_count": 36,
    "test_files_count": 4,
    "non_test_files_count": 5,
    "pr_changed_files": [
      "packages/app/src/MfaPage.test.tsx",
      "packages/app/src/MfaPage.tsx",
      "packages/mock/src/client.test.ts",
      "packages/mock/src/client.ts",
      "packages/react/src/auth/MfaForm.tsx",
      "packages/react/src/auth/SignInForm.test.tsx",
      "packages/react/src/auth/SignInForm.tsx",
      "packages/server/src/auth/mfa.test.ts",
      "packages/server/src/auth/mfa.ts"
    ],
    "pr_changed_test_files": [
      "packages/app/src/MfaPage.test.tsx",
      "packages/mock/src/client.test.ts",
      "packages/react/src/auth/SignInForm.test.tsx",
      "packages/server/src/auth/mfa.test.ts"
    ],
    "base_commit": "38fe93bd9e5d2957d3b494454e050f6cca5c7e3d",
    "head_commit": "cde8892c96cc8f985ed85dfc6b80b79443b5f348",
    "repo_url": "https://github.com/medplum/medplum/pull/5711",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5711",
    "dockerfile": "",
    "pr_merged_at": "2025-01-02T20:15:29.000Z",
    "patch": "diff --git a/packages/app/src/MfaPage.tsx b/packages/app/src/MfaPage.tsx\nindex 8c62ba7adf..ad0c42237e 100644\n--- a/packages/app/src/MfaPage.tsx\n+++ b/packages/app/src/MfaPage.tsx\n@@ -1,17 +1,21 @@\n-import { Button, Center, Group, TextInput, Title } from '@mantine/core';\n+import { Button, Center, Group, Modal, TextInput, Title } from '@mantine/core';\n import { showNotification } from '@mantine/notifications';\n import { normalizeErrorString } from '@medplum/core';\n+import { OperationOutcome } from '@medplum/fhirtypes';\n import { Document, Form, useMedplum } from '@medplum/react';\n+import { IconCircleCheck } from '@tabler/icons-react';\n import { useCallback, useEffect, useState } from 'react';\n+import { MfaForm, MfaFormFields } from '../../react/src/auth/MfaForm';\n \n export function MfaPage(): JSX.Element | null {\n   const medplum = useMedplum();\n   const [qrCodeUrl, setQrCodeUrl] = useState<string>();\n   const [enrolled, setEnrolled] = useState<boolean | undefined>(undefined);\n+  const [disabling, setDisabling] = useState<boolean>(false);\n \n-  useEffect(() => {\n+  const fetchStatus = useCallback(() => {\n     medplum\n-      .get('auth/mfa/status')\n+      .get('auth/mfa/status', { cache: 'no-cache' })\n       .then((response) => {\n         setQrCodeUrl(response.enrollQrCode);\n         setEnrolled(response.enrolled);\n@@ -19,6 +23,10 @@ export function MfaPage(): JSX.Element | null {\n       .catch((err) => showNotification({ color: 'red', message: normalizeErrorString(err), autoClose: false }));\n   }, [medplum]);\n \n+  useEffect(() => {\n+    fetchStatus();\n+  }, [fetchStatus]);\n+\n   const enableMfa = useCallback(\n     (formData: Record<string, string>) => {\n       medplum\n@@ -32,9 +40,12 @@ export function MfaPage(): JSX.Element | null {\n     [medplum]\n   );\n \n-  const disableMfa = useCallback(() => {\n-    medplum.post('auth/mfa/disable', {}).catch(console.log);\n-  }, [medplum]);\n+  const disableMfa = useCallback(\n+    async (formData: Record<MfaFormFields, string>): Promise<OperationOutcome> => {\n+      return medplum.post('auth/mfa/disable', { token: formData.token });\n+    },\n+    [medplum]\n+  );\n \n   if (enrolled === undefined) {\n     return null;\n@@ -43,9 +54,28 @@ export function MfaPage(): JSX.Element | null {\n   if (enrolled) {\n     return (\n       <Document>\n+        <Modal title=\"Disable MFA\" opened={disabling} onClose={() => setDisabling(false)}>\n+          <MfaForm\n+            onSubmit={async (formData) => {\n+              // This will throw if MFA failed to disable\n+              await disableMfa(formData);\n+              setDisabling(false);\n+              setEnrolled(false);\n+              showNotification({\n+                id: 'mfa-disabled',\n+                color: 'green',\n+                title: 'Success',\n+                message: 'MFA disabled',\n+                icon: <IconCircleCheck />,\n+              });\n+              // We fetch the status so that the MFA QR code is refreshed\n+              fetchStatus();\n+            }}\n+          />\n+        </Modal>\n         <Group>\n           <Title>MFA is enabled</Title>\n-          <Button onClick={disableMfa}>Disable MFA</Button>\n+          <Button onClick={() => setDisabling(true)}>Disable MFA</Button>\n         </Group>\n       </Document>\n     );\n\ndiff --git a/packages/mock/src/client.ts b/packages/mock/src/client.ts\nindex f8149e3294..9391770c14 100644\n--- a/packages/mock/src/client.ts\n+++ b/packages/mock/src/client.ts\n@@ -523,6 +523,20 @@ export class MockFetchClient {\n       return allOk;\n     }\n \n+    if (path.startsWith('auth/mfa/verify')) {\n+      return {\n+        login: '123',\n+        code: 'xyz',\n+      };\n+    }\n+\n+    if (path.startsWith('auth/mfa/disable')) {\n+      if (options.body && JSON.parse(options.body)?.token !== 'INVALID_TOKEN') {\n+        return allOk;\n+      }\n+      return badRequest('Invalid token');\n+    }\n+\n     return null;\n   }\n \n\ndiff --git a/packages/react/src/auth/MfaForm.tsx b/packages/react/src/auth/MfaForm.tsx\nindex 148493bef0..3f3c3e10eb 100644\n--- a/packages/react/src/auth/MfaForm.tsx\n+++ b/packages/react/src/auth/MfaForm.tsx\n@@ -1,30 +1,23 @@\n import { Alert, Button, Center, Group, Stack, TextInput, Title } from '@mantine/core';\n-import { LoginAuthenticationResponse, normalizeErrorString } from '@medplum/core';\n-import { useMedplum } from '@medplum/react-hooks';\n+import { normalizeErrorString } from '@medplum/core';\n import { IconAlertCircle } from '@tabler/icons-react';\n import { useState } from 'react';\n import { Form } from '../Form/Form';\n import { Logo } from '../Logo/Logo';\n \n+export type MfaFormFields = 'token';\n+\n export interface MfaFormProps {\n-  readonly login: string;\n-  readonly handleAuthResponse: (response: LoginAuthenticationResponse) => void;\n+  readonly onSubmit: (formData: Record<MfaFormFields, string>) => Promise<void>;\n }\n \n export function MfaForm(props: MfaFormProps): JSX.Element {\n-  const medplum = useMedplum();\n   const [errorMessage, setErrorMessage] = useState<string>();\n   return (\n     <Form\n-      onSubmit={(formData: Record<string, string>) => {\n+      onSubmit={(formData: Record<MfaFormFields, string>) => {\n         setErrorMessage(undefined);\n-        medplum\n-          .post('auth/mfa/verify', {\n-            login: props.login,\n-            token: formData.token,\n-          })\n-          .then(props.handleAuthResponse)\n-          .catch((err) => setErrorMessage(normalizeErrorString(err)));\n+        props.onSubmit(formData).catch((err) => setErrorMessage(normalizeErrorString(err)));\n       }}\n     >\n       <Stack>\n\ndiff --git a/packages/react/src/auth/SignInForm.tsx b/packages/react/src/auth/SignInForm.tsx\nindex 68a7221851..f4c04aa605 100644\n--- a/packages/react/src/auth/SignInForm.tsx\n+++ b/packages/react/src/auth/SignInForm.tsx\n@@ -129,7 +129,18 @@ export function SignInForm(props: SignInFormProps): JSX.Element {\n             </AuthenticationForm>\n           );\n         } else if (mfaRequired) {\n-          return <MfaForm login={login} handleAuthResponse={handleAuthResponse} />;\n+          return (\n+            <MfaForm\n+              onSubmit={async (fields) => {\n+                const res = await medplum.post('auth/mfa/verify', {\n+                  login: login,\n+                  token: fields.token,\n+                });\n+                console.log({ res });\n+                handleAuthResponse(res);\n+              }}\n+            />\n+          );\n         } else if (memberships) {\n           return <ChooseProfileForm login={login} memberships={memberships} handleAuthResponse={handleAuthResponse} />;\n         } else if (props.projectId === 'new') {\n\ndiff --git a/packages/server/src/auth/mfa.ts b/packages/server/src/auth/mfa.ts\nindex 2c3d0f3c3a..7d66bd7ace 100644\n--- a/packages/server/src/auth/mfa.ts\n+++ b/packages/server/src/auth/mfa.ts\n@@ -100,3 +100,45 @@ mfaRouter.post(\n     return sendLoginResult(res, result);\n   })\n );\n+\n+mfaRouter.post(\n+  '/disable',\n+  [body('token').notEmpty().withMessage('Missing token')],\n+  asyncWrap(async (req: Request, res: Response) => {\n+    const systemRepo = getSystemRepo();\n+    const ctx = getAuthenticatedContext();\n+    const user = await systemRepo.readReference<User>(ctx.membership.user as Reference<User>);\n+\n+    if (!user.mfaSecret) {\n+      sendOutcome(res, badRequest('Secret not found'));\n+      return;\n+    }\n+\n+    if (!user.mfaEnrolled) {\n+      sendOutcome(res, badRequest('User not enrolled in MFA'));\n+      return;\n+    }\n+\n+    const errors = validationResult(req);\n+    if (!errors.isEmpty()) {\n+      sendOutcome(res, invalidRequest(errors));\n+      return;\n+    }\n+\n+    const secret = user.mfaSecret as string;\n+    const token = req.body.token as string;\n+    if (!authenticator.check(token, secret)) {\n+      sendOutcome(res, badRequest('Invalid token'));\n+      return;\n+    }\n+\n+    await systemRepo.updateResource({\n+      ...user,\n+      mfaEnrolled: false,\n+      // We generate a new secret so that next time the user enrolls that they don't get the same secret\n+      // This allows for new secrets in the case of lost / stolen two-factor devices\n+      mfaSecret: authenticator.generateSecret(),\n+    });\n+    sendOutcome(res, allOk);\n+  })\n+);\n",
    "test_patch": "diff --git a/packages/app/src/MfaPage.test.tsx b/packages/app/src/MfaPage.test.tsx\nindex 34c07e4845..4d6b3b9d5d 100644\n--- a/packages/app/src/MfaPage.test.tsx\n+++ b/packages/app/src/MfaPage.test.tsx\n@@ -1,3 +1,5 @@\n+import { MantineProvider } from '@mantine/core';\n+import { notifications, Notifications } from '@mantine/notifications';\n import { MockClient } from '@medplum/mock';\n import { MedplumProvider } from '@medplum/react';\n import { MemoryRouter } from 'react-router-dom';\n@@ -10,15 +12,22 @@ async function setup(): Promise<void> {\n   await act(async () => {\n     render(\n       <MemoryRouter initialEntries={['/mfa']} initialIndex={0}>\n-        <MedplumProvider medplum={medplum}>\n-          <AppRoutes />\n-        </MedplumProvider>\n+        <MantineProvider>\n+          <MedplumProvider medplum={medplum}>\n+            <AppRoutes />\n+            <Notifications />\n+          </MedplumProvider>\n+        </MantineProvider>\n       </MemoryRouter>\n     );\n   });\n }\n \n describe('MfaPage', () => {\n+  beforeEach(() => {\n+    notifications.clean();\n+  });\n+\n   test('Renders', async () => {\n     await setup();\n     expect(screen.getByText('Multi Factor Auth Setup')).toBeInTheDocument();\n@@ -31,4 +40,88 @@ describe('MfaPage', () => {\n     });\n     expect(screen.getByText('MFA is enabled')).toBeInTheDocument();\n   });\n+\n+  test('Disable -- success', async () => {\n+    const getSpy = jest.spyOn(medplum, 'get');\n+    await setup();\n+\n+    // Enroll into MFA\n+    await act(async () => {\n+      fireEvent.click(screen.getByRole('button', { name: 'Enroll' }));\n+    });\n+    expect(screen.getByText('MFA is enabled')).toBeInTheDocument();\n+\n+    // Clean notifications\n+    await act(async () => {\n+      notifications.clean();\n+    });\n+\n+    // Open disable MFA modal\n+    await act(async () => {\n+      fireEvent.click(screen.getByRole('button', { name: 'Disable MFA' }));\n+    });\n+\n+    // Wait for MFA code input to appear\n+    await expect(screen.findByLabelText(/mfa code*/i)).resolves.toBeInTheDocument();\n+\n+    // Enter in a token value\n+    await act(async () => {\n+      fireEvent.change(screen.getByLabelText(/mfa code*/i), { target: { value: '1234567890' } });\n+    });\n+\n+    // Submit disable request\n+    await act(async () => {\n+      fireEvent.click(screen.getByRole('button', { name: 'Submit code' }));\n+    });\n+\n+    // Check that the toast confirms that MFA was disabled\n+    await expect(screen.findByText('MFA disabled')).resolves.toBeInTheDocument();\n+    expect(screen.getByText('Enroll')).toBeInTheDocument();\n+    // Make sure that we called status to refresh MFA QR code\n+    expect(getSpy).toHaveBeenCalledWith('auth/mfa/status', expect.objectContaining({ cache: 'no-cache' }));\n+    getSpy.mockRestore();\n+  });\n+\n+  test('Disable -- failed', async () => {\n+    const getSpy = jest.spyOn(medplum, 'get');\n+    await setup();\n+\n+    // Enroll into MFA\n+    await act(async () => {\n+      fireEvent.click(screen.getByRole('button', { name: 'Enroll' }));\n+    });\n+    expect(screen.getByText('MFA is enabled')).toBeInTheDocument();\n+\n+    // Clean notifications\n+    await act(async () => {\n+      notifications.clean();\n+    });\n+\n+    // Open disable MFA modal\n+    await act(async () => {\n+      fireEvent.click(screen.getByRole('button', { name: 'Disable MFA' }));\n+    });\n+\n+    // Wait for MFA code input to appear\n+    await expect(screen.findByLabelText(/mfa code*/i)).resolves.toBeInTheDocument();\n+\n+    // Enter in an INVALID_TOKEN value\n+    await act(async () => {\n+      fireEvent.change(screen.getByLabelText(/mfa code*/i), { target: { value: 'INVALID_TOKEN' } });\n+    });\n+\n+    // Reset the mock before submitting code\n+    getSpy.mockReset();\n+\n+    // Attempt to submit code without entering\n+    await act(async () => {\n+      fireEvent.click(screen.getByRole('button', { name: 'Submit code' }));\n+    });\n+\n+    // Make sure invalid token came back\n+    await expect(screen.findByText('Invalid token')).resolves.toBeInTheDocument();\n+    await expect(screen.findByText('Enroll')).rejects.toThrow();\n+    expect(getSpy).not.toHaveBeenCalledWith('auth/mfa/status', expect.objectContaining({ cache: 'no-cache' }));\n+    getSpy.mockRestore();\n+  });\n });\n\ndiff --git a/packages/mock/src/client.test.ts b/packages/mock/src/client.test.ts\nindex b4afe5a7d3..0a107adfb3 100644\n--- a/packages/mock/src/client.test.ts\n+++ b/packages/mock/src/client.test.ts\n@@ -10,6 +10,7 @@ import {\n   OperationOutcomeError,\n   SubscriptionEmitter,\n   allOk,\n+  badRequest,\n   getReferenceString,\n   indexSearchParameterBundle,\n   indexStructureDefinitionBundle,\n@@ -202,6 +203,23 @@ describe('MockClient', () => {\n     expect(await client.post('auth/mfa/enroll', { token: 'foo' })).toMatchObject(allOk);\n   });\n \n+  test('MFA verify', async () => {\n+    const client = new MockClient();\n+    expect(await client.post('auth/mfa/verify', { token: 'foo' })).toMatchObject({ login: '123', code: 'xyz' });\n+  });\n+\n+  test('MFA disable -- success', async () => {\n+    const client = new MockClient();\n+    expect(await client.post('auth/mfa/disable', { token: 'foo' })).toMatchObject(allOk);\n+  });\n+\n+  test('MFA disable -- invalid token', async () => {\n+    const client = new MockClient();\n+    await expect(client.post('auth/mfa/disable', { token: 'INVALID_TOKEN' })).rejects.toThrow(\n+      new OperationOutcomeError(badRequest('Invalid token'))\n+    );\n+  });\n+\n   test('Batch request', async () => {\n     const client = new MockClient();\n     await expect(\n\ndiff --git a/packages/react/src/auth/SignInForm.test.tsx b/packages/react/src/auth/SignInForm.test.tsx\nindex 5c15d44fa7..59d47dec69 100644\n--- a/packages/react/src/auth/SignInForm.test.tsx\n+++ b/packages/react/src/auth/SignInForm.test.tsx\n@@ -64,6 +64,12 @@ function mockFetch(url: string, options: any): Promise<any> {\n           },\n         ],\n       };\n+    } else if (email === 'mfa-required@medplum.com' && password === 'mfa-required') {\n+      status = 200;\n+      result = {\n+        login: '1',\n+        mfaRequired: true,\n+      };\n     } else {\n       status = 400;\n       result = {\n@@ -113,6 +119,12 @@ function mockFetch(url: string, options: any): Promise<any> {\n       login: '1',\n       code: '1',\n     };\n+  } else if (options.method === 'POST' && url.endsWith('auth/mfa/verify')) {\n+    status = 200;\n+    result = {\n+      login: '1',\n+      code: '1',\n+    };\n   } else if (options.method === 'GET' && url.endsWith('Practitioner/123')) {\n     status = 200;\n     result = {\n@@ -727,4 +739,45 @@ describe('SignInForm', () => {\n     await waitFor(() => expect(window.location.assign).toHaveBeenCalled());\n     expect(window.location.assign).toHaveBeenCalled();\n   });\n+\n+  test('MFA -- Success', async () => {\n+    let success = false;\n+\n+    await setup({\n+      onSuccess: () => (success = true),\n+    });\n+\n+    await act(async () => {\n+      fireEvent.change(screen.getByLabelText('Email', { exact: false }), {\n+        target: { value: 'mfa-required@medplum.com' },\n+      });\n+    });\n+\n+    await act(async () => {\n+      fireEvent.click(screen.getByText('Next'));\n+    });\n+\n+    await act(async () => {\n+      fireEvent.change(screen.getByLabelText('Password', { exact: false }), {\n+        target: { value: 'mfa-required' },\n+      });\n+    });\n+\n+    await act(async () => {\n+      fireEvent.click(screen.getByText('Sign in'));\n+    });\n+\n+    await expect(screen.findByLabelText(/mfa code*/i)).resolves.toBeInTheDocument();\n+\n+    await act(async () => {\n+      fireEvent.change(screen.getByLabelText(/mfa code*/i), { target: { value: '1234567890' } });\n+    });\n+\n+    await act(async () => {\n+      fireEvent.click(screen.getByRole('button', { name: /submit code/i }));\n+    });\n+\n+    await waitFor(() => expect(medplum.getProfile()).toBeDefined());\n+    expect(success).toBe(true);\n+  });\n });\n\ndiff --git a/packages/server/src/auth/mfa.test.ts b/packages/server/src/auth/mfa.test.ts\nindex 15a019cec3..ef4c3d5a00 100644\n--- a/packages/server/src/auth/mfa.test.ts\n+++ b/packages/server/src/auth/mfa.test.ts\n@@ -1,11 +1,13 @@\n+import { allOk, badRequest } from '@medplum/core';\n+import { OperationOutcome } from '@medplum/fhirtypes';\n import { randomUUID } from 'crypto';\n import express from 'express';\n import { authenticator } from 'otplib';\n import request from 'supertest';\n import { initApp, shutdownApp } from '../app';\n import { loadTestConfig } from '../config';\n-import { registerNew } from './register';\n import { withTestContext } from '../test.setup';\n+import { registerNew } from './register';\n \n const app = express();\n \n@@ -147,4 +149,111 @@ describe('MFA', () => {\n     expect(res13.body.login).toBeDefined();\n     expect(res13.body.code).toBeDefined();\n   });\n+\n+  test('Disable end-to-end', async () => {\n+    const email = `alex${randomUUID()}@example.com`;\n+    const password = 'password!@#';\n+\n+    const { accessToken } = await withTestContext(() =>\n+      registerNew({\n+        firstName: 'Alexander',\n+        lastName: 'The Great',\n+        projectName: 'Macedonian Project',\n+        email,\n+        password,\n+        remoteAddress: '5.5.5.5',\n+        userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/107.0.0.0',\n+      })\n+    );\n+\n+    // Call disable while not enrolled yet and before status, should error\n+    const res1 = await request(app)\n+      .post('/auth/mfa/disable')\n+      .set('Authorization', `Bearer ${accessToken}`)\n+      .type('json')\n+      .send({\n+        token: '123',\n+      });\n+    expect(res1.status).toBe(400);\n+    expect(res1.body).toMatchObject<OperationOutcome>(badRequest('Secret not found'));\n+\n+    // Get status; should not be enrolled and should get a secret\n+    const res2 = await request(app).get('/auth/mfa/status').set('Authorization', `Bearer ${accessToken}`);\n+    expect(res2.status).toBe(200);\n+    expect(res2.body.enrolled).toBe(false);\n+    expect(res2.body).toBeDefined();\n+    expect(res2.body.enrollUri).toBeDefined();\n+\n+    // Start new login\n+    const res3 = await request(app).post('/auth/login').type('json').send({\n+      email,\n+      password,\n+      scope: 'openid',\n+    });\n+    expect(res3.status).toBe(200);\n+    expect(res3.body.login).toBeDefined();\n+\n+    // Get MFA status, should be disabled\n+    const res4 = await request(app).get('/auth/mfa/status').set('Authorization', `Bearer ${accessToken}`);\n+    expect(res4.status).toBe(200);\n+    expect(res4.body).toBeDefined();\n+    expect(res4.body.enrolled).toBe(false);\n+    expect(res4.body.enrollUri).toBeDefined();\n+\n+    const secret = new URL(res4.body.enrollUri).searchParams.get('secret') as string;\n+\n+    // Enroll MFA\n+    const res5 = await request(app)\n+      .post('/auth/mfa/enroll')\n+      .set('Authorization', `Bearer ${accessToken}`)\n+      .type('json')\n+      .send({ token: authenticator.generate(secret) });\n+    expect(res5.status).toBe(200);\n+\n+    // Call disable without token, should fail\n+    const res6 = await request(app)\n+      .post('/auth/mfa/disable')\n+      .set('Authorization', `Bearer ${accessToken}`)\n+      .type('json');\n+    expect(res6.status).toBe(400);\n+    expect(res6.body).toMatchObject<OperationOutcome>(badRequest('Missing token'));\n+\n+    // Call disable with invalid token, should fail\n+    const res7 = await request(app)\n+      .post('/auth/mfa/disable')\n+      .set('Authorization', `Bearer ${accessToken}`)\n+      .type('json')\n+      .send({ token: 'invalid' });\n+    expect(res7.status).toBe(400);\n+    expect(res7.body).toMatchObject<OperationOutcome>(badRequest('Invalid token'));\n+\n+    // Call disable with token, should succeed\n+    const res8 = await request(app)\n+      .post('/auth/mfa/disable')\n+      .set('Authorization', `Bearer ${accessToken}`)\n+      .type('json')\n+      .send({ token: authenticator.generate(secret) });\n+    expect(res8.status).toBe(200);\n+    expect(res8.body).toMatchObject<OperationOutcome>(allOk);\n+\n+    // Get status should not be enrolled and should have a new secret\n+    const res9 = await request(app).get('/auth/mfa/status').set('Authorization', `Bearer ${accessToken}`);\n+    expect(res9.status).toBe(200);\n+    expect(res9.body.enrolled).toBe(false);\n+    expect(res9.body).toBeDefined();\n+    expect(res9.body.enrollUri).not.toBe(res4.body.enrollUri);\n+\n+    const secret2 = new URL(res9.body.enrollUri).searchParams.get('secret') as string;\n+\n+    // Call disable while no longer enrolled, should error\n+    const res10 = await request(app)\n+      .post('/auth/mfa/disable')\n+      .set('Authorization', `Bearer ${accessToken}`)\n+      .type('json')\n+      .send({\n+        token: authenticator.generate(secret2),\n+      });\n+    expect(res10.status).toBe(400);\n+    expect(res10.body).toMatchObject<OperationOutcome>(badRequest('User not enrolled in MFA'));\n+  });\n });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5706",
    "pr_id": 5706,
    "issue_id": 5705,
    "repo": "medplum/medplum",
    "problem_statement": "GraphQL mutations create resources with null prototype\nThis error showed up in the GraphQL requests of some users:\r\n<img width=\"995\" alt=\"Screenshot 2024-12-19 at 8 34 13 PM\" src=\"https://github.com/user-attachments/assets/ac767841-ccf8-4f79-bc2c-1dbc2c6a8bd5\" />\r\n\r\nIt appears resources parsed from GraphQL queries are made of objects which have null prototypes which lead to them causing our FHIRPath evaluator to throw when `x.value?.valueOf()` is called for type coercion within the `evalFhirPathTyped` function.\r\n\r\nWe should `deepClone` the resource before passing it to `repo.createResource` so that all the objects within the resource have the default prototype which has the needed `valueOf` method.\r\n",
    "issue_word_count": 110,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/fhir-router/src/graphql/graphql.ts",
      "packages/server/src/fhir/operations/graphql.test.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/operations/graphql.test.ts"
    ],
    "base_commit": "821b495b24356d0203281fe10e7527fe768ba55e",
    "head_commit": "583123c4c9596b0b1858e3e92cf7ac82e28fa3ee",
    "repo_url": "https://github.com/medplum/medplum/pull/5706",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5706",
    "dockerfile": "",
    "pr_merged_at": "2024-12-20T19:15:49.000Z",
    "patch": "diff --git a/packages/fhir-router/src/graphql/graphql.ts b/packages/fhir-router/src/graphql/graphql.ts\nindex 5756a8331a..3b74969044 100644\n--- a/packages/fhir-router/src/graphql/graphql.ts\n+++ b/packages/fhir-router/src/graphql/graphql.ts\n@@ -2,6 +2,7 @@ import {\n   allOk,\n   badRequest,\n   ContentType,\n+  deepClone,\n   DEFAULT_SEARCH_COUNT,\n   forbidden,\n   getResourceTypes,\n@@ -387,7 +388,10 @@ async function resolveByCreate(\n   if (resourceArgs.resourceType !== resourceType) {\n     throw new OperationOutcomeError(badRequest('Invalid resourceType'));\n   }\n-  return ctx.repo.createResource(resourceArgs as Resource);\n+  // We have to deep clone the args before we try to make them into a resource, since the args are parsed from the request\n+  // as objects with a null prototype (via Object.create(null)), which means that tree of objects have no `valueOf` method which\n+  // we need for evalFhirPath to work properly\n+  return ctx.repo.createResource(deepClone(resourceArgs) as Resource);\n }\n \n /**\n@@ -416,7 +420,10 @@ async function resolveByUpdate(\n   if (resourceId !== resourceArgs.id) {\n     throw new OperationOutcomeError(badRequest('Invalid ID'));\n   }\n-  return ctx.repo.updateResource(resourceArgs as Resource);\n+  // We have to deep clone the args before we try to make them into a resource, since the args are parsed from the request\n+  // as objects with a null prototype (via Object.create(null)), which means that tree of objects have no `valueOf` method which\n+  // we need for evalFhirPath to work properly\n+  return ctx.repo.updateResource(deepClone(resourceArgs) as Resource);\n }\n \n /**\n",
    "test_patch": "diff --git a/packages/server/src/fhir/operations/graphql.test.ts b/packages/server/src/fhir/operations/graphql.test.ts\nindex 979f5acbb4..46d4662260 100644\n--- a/packages/server/src/fhir/operations/graphql.test.ts\n+++ b/packages/server/src/fhir/operations/graphql.test.ts\n@@ -6,10 +6,10 @@ import request from 'supertest';\n import { initApp, shutdownApp } from '../../app';\n import { registerNew } from '../../auth/register';\n import { loadTestConfig } from '../../config';\n+import { DatabaseMode, getDatabasePool } from '../../database';\n import { addTestUser, createTestProject, withTestContext } from '../../test.setup';\n import { Repository } from '../repo';\n import * as searchFile from '../search';\n-import { DatabaseMode, getDatabasePool } from '../../database';\n \n const app = express();\n let practitioner: Practitioner;\n@@ -1082,6 +1082,53 @@ describe('GraphQL', () => {\n     });\n   });\n \n+  test('Create Task with groupIdentifier', async () => {\n+    const { accessToken } = await createTestProject({\n+      withAccessToken: true,\n+      withRepo: true,\n+      accessPolicy: {\n+        resourceType: 'AccessPolicy',\n+        resource: [\n+          {\n+            resourceType: 'CodeSystem',\n+            readonly: true,\n+          },\n+          {\n+            resourceType: 'ValueSet',\n+            readonly: true,\n+          },\n+          {\n+            resourceType: 'Task',\n+            criteria: 'Task?group-identifier=http://example.com/group-identifier-system|example',\n+          },\n+        ],\n+      },\n+    });\n+\n+    const res = await request(app)\n+      .post('/fhir/R4/$graphql')\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Content-Type', ContentType.JSON)\n+      .send({\n+        query: `mutation {\n+          TaskCreate(\n+            res: {\n+              resourceType: \"Task\"\n+              status: \"requested\"\n+              intent: \"order\"\n+              groupIdentifier: {\n+                system: \"http://example.com/group-identifier-system\"\n+                value: \"example\"\n+              }\n+            }\n+          )\n+          { id }\n+        }`,\n+      });\n+    expect('errors' in res.body).toStrictEqual(false);\n+    expect(res.body?.data?.TaskCreate?.id).toBeDefined();\n+  });\n+\n   test('Uses reader instance when available', async () => {\n     const readerSpy = jest.spyOn(getDatabasePool(DatabaseMode.READER), 'query');\n     const writerSpy = jest.spyOn(getDatabasePool(DatabaseMode.WRITER), 'query');\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5673",
    "pr_id": 5673,
    "issue_id": 5669,
    "repo": "medplum/medplum",
    "problem_statement": "Patient Intake demo incorrectly specifying US Core Patient extensions\nThe [intake form Bot code](https://github.com/medplum/medplum/blob/26ca7725254a3fe4ab4b73e6e064cec2650becb4/examples/medplum-patient-intake-demo/src/bots/core/intake-form.ts#L104-L105) is assigning the `race` and `ethnicity` answers as top-level extension values with the US Core race and ethnicity extension URLs. This does not conform with the race/ethnicity extensions.\r\n\r\nCurrent `Patient` resources generated include:\r\n\r\n```json\r\n\"extension\": [\r\n    {\r\n      \"url\": \"http://hl7.org/fhir/us/core/StructureDefinition/us-core-race\",\r\n      \"valueCoding\": {\r\n        \"system\": \"urn:oid:2.16.840.1.113883.6.238\",\r\n        \"code\": \"2028-9\",\r\n        \"display\": \"Asian\"\r\n      }\r\n    },\r\n    {\r\n      \"url\": \"http://hl7.org/fhir/us/core/StructureDefinition/us-core-ethnicity\",\r\n      \"valueCoding\": {\r\n        \"system\": \"urn:oid:2.16.840.1.113883.6.238\",\r\n        \"code\": \"2186-5\",\r\n        \"display\": \"Not Hispanic or Latino\"\r\n      }\r\n    }\r\n]\r\n```\r\n\r\nThe correct structure would look something like the following where the existing `race` and `ethnicity` answers are used as the `ombCategory` nested extensions and with the required `text` nested extension answers populated from the corresponding `valueCoding.display`.\r\n\r\n```json\r\n\"extension\": [\r\n    {\r\n      \"url\": \"http://hl7.org/fhir/us/core/StructureDefinition/us-core-race\",\r\n      \"extension\": [\r\n        {\r\n          \"url\": \"ombCategory\",\r\n          \"valueCoding\": {\r\n            \"system\": \"urn:oid:2.16.840.1.113883.6.238\",\r\n            \"code\": \"2028-9\",\r\n            \"display\": \"Asian\"\r\n          }\r\n        },\r\n        {\r\n          \"url\": \"text\",\r\n          \"valueString\": \"Asian\"\r\n        }\r\n      ]\r\n    },\r\n    {\r\n      \"url\": \"http://hl7.org/fhir/us/core/StructureDefinition/us-core-ethnicity\",\r\n      \"extension\": [\r\n        {\r\n          \"url\": \"ombCategory\",\r\n          \"valueCoding\": {\r\n            \"system\": \"urn:oid:2.16.840.1.113883.6.238\",\r\n            \"code\": \"2186-5\",\r\n            \"display\": \"Not Hispanic or Latino\"\r\n          }\r\n        },\r\n        {\r\n          \"url\": \"text\",\r\n          \"valueString\": \"Not Hispanic or Latino\"\r\n        }\r\n      ]\r\n    }\r\n  ]\r\n```",
    "issue_word_count": 241,
    "test_files_count": 1,
    "non_test_files_count": 3,
    "pr_changed_files": [
      "examples/medplum-patient-intake-demo/data/core/patient-intake-questionnaire.json",
      "examples/medplum-patient-intake-demo/src/bots/core/intake-form.test.ts",
      "examples/medplum-patient-intake-demo/src/bots/core/intake-form.ts",
      "examples/medplum-patient-intake-demo/src/bots/core/intake-utils.ts"
    ],
    "pr_changed_test_files": [
      "examples/medplum-patient-intake-demo/src/bots/core/intake-form.test.ts"
    ],
    "base_commit": "6072d5f3a7fb637a9912155901fe1cdcdf7baaa6",
    "head_commit": "92f22f8b4fe12f2a2897ba33c47813242254a796",
    "repo_url": "https://github.com/medplum/medplum/pull/5673",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5673",
    "dockerfile": "",
    "pr_merged_at": "2024-12-17T23:01:38.000Z",
    "patch": "diff --git a/examples/medplum-patient-intake-demo/data/core/patient-intake-questionnaire.json b/examples/medplum-patient-intake-demo/data/core/patient-intake-questionnaire.json\nindex 43f3392588..b884aeda7c 100644\n--- a/examples/medplum-patient-intake-demo/data/core/patient-intake-questionnaire.json\n+++ b/examples/medplum-patient-intake-demo/data/core/patient-intake-questionnaire.json\n@@ -89,7 +89,8 @@\n                 \"linkId\": \"gender-identity\",\n                 \"text\": \"Gender Identity\",\n                 \"type\": \"choice\",\n-                \"answerValueSet\": \"http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1021.32\"\n+                \"answerValueSet\": \"http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1021.32\",\n+                \"required\": true\n               },\n               {\n                 \"linkId\": \"sexual-orientation\",\n\ndiff --git a/examples/medplum-patient-intake-demo/src/bots/core/intake-form.ts b/examples/medplum-patient-intake-demo/src/bots/core/intake-form.ts\nindex 9e2f713c1f..b5b8ffb2ef 100644\n--- a/examples/medplum-patient-intake-demo/src/bots/core/intake-form.ts\n+++ b/examples/medplum-patient-intake-demo/src/bots/core/intake-form.ts\n@@ -1,10 +1,11 @@\n-import { BotEvent, createReference, getQuestionnaireAnswers, MedplumClient } from '@medplum/core';\n+import { addProfileToResource, BotEvent, createReference, getQuestionnaireAnswers, MedplumClient } from '@medplum/core';\n import { Organization, Patient, Questionnaire, QuestionnaireResponse, Reference } from '@medplum/fhirtypes';\n import {\n   addAllergy,\n   addCondition,\n   addConsent,\n   addCoverage,\n+  addExtension,\n   addFamilyMemberHistory,\n   addImmunization,\n   addLanguage,\n@@ -20,7 +21,7 @@ import {\n   getPatientAddress,\n   observationCategoryMapping,\n   observationCodeMapping,\n-  setExtension,\n+  PROFILE_URLS,\n   upsertObservation,\n } from './intake-utils';\n \n@@ -38,6 +39,8 @@ export async function handler(medplum: MedplumClient, event: BotEvent<Questionna\n     resourceType: 'Patient',\n   };\n \n+  patient = addProfileToResource(patient, PROFILE_URLS.Patient);\n+\n   // Handle demographic information\n \n   const patientName = getHumanName(answers);\n@@ -101,9 +104,9 @@ export async function handler(medplum: MedplumClient, event: BotEvent<Questionna\n     }\n   }\n \n-  setExtension(patient, extensionURLMapping.race, 'valueCoding', answers['race']);\n-  setExtension(patient, extensionURLMapping.ethnicity, 'valueCoding', answers['ethnicity']);\n-  setExtension(patient, extensionURLMapping.veteran, 'valueBoolean', answers['veteran-status']);\n+  addExtension(patient, extensionURLMapping.race, 'valueCoding', answers['race'], 'ombCategory');\n+  addExtension(patient, extensionURLMapping.ethnicity, 'valueCoding', answers['ethnicity'], 'ombCategory');\n+  addExtension(patient, extensionURLMapping.veteran, 'valueBoolean', answers['veteran-status']);\n \n   addLanguage(patient, answers['languages-spoken']?.valueCoding);\n   addLanguage(patient, answers['preferred-language']?.valueCoding, true);\n@@ -125,7 +128,8 @@ export async function handler(medplum: MedplumClient, event: BotEvent<Questionna\n     observationCodeMapping.sexualOrientation,\n     observationCategoryMapping.socialHistory,\n     'valueCodeableConcept',\n-    answers['sexual-orientation']?.valueCoding\n+    answers['sexual-orientation']?.valueCoding,\n+    PROFILE_URLS.ObservationSexualOrientation\n   );\n \n   await upsertObservation(\n@@ -152,7 +156,8 @@ export async function handler(medplum: MedplumClient, event: BotEvent<Questionna\n     observationCodeMapping.smokingStatus,\n     observationCategoryMapping.socialHistory,\n     'valueCodeableConcept',\n-    answers['smoking-status']?.valueCoding\n+    answers['smoking-status']?.valueCoding,\n+    PROFILE_URLS.ObservationSmokingStatus\n   );\n \n   await upsertObservation(\n\ndiff --git a/examples/medplum-patient-intake-demo/src/bots/core/intake-utils.ts b/examples/medplum-patient-intake-demo/src/bots/core/intake-utils.ts\nindex 2f5548def7..f7de209ce5 100644\n--- a/examples/medplum-patient-intake-demo/src/bots/core/intake-utils.ts\n+++ b/examples/medplum-patient-intake-demo/src/bots/core/intake-utils.ts\n@@ -1,6 +1,6 @@\n import {\n+  addProfileToResource,\n   createReference,\n-  getExtension,\n   getReferenceString,\n   HTTP_HL7_ORG,\n   HTTP_TERMINOLOGY_HL7_ORG,\n@@ -25,6 +25,17 @@ import {\n   Reference,\n } from '@medplum/fhirtypes';\n \n+export const PROFILE_URLS: Record<string, string> = {\n+  AllergyIntolerance: `${HTTP_HL7_ORG}/fhir/us/core/StructureDefinition/us-core-allergyintolerance`,\n+  CareTeam: `${HTTP_HL7_ORG}/fhir/us/core/StructureDefinition/us-core-careteam`,\n+  Coverage: `${HTTP_HL7_ORG}/fhir/us/core/StructureDefinition/us-core-coverage`,\n+  Immunization: `${HTTP_HL7_ORG}/fhir/us/core/StructureDefinition/us-core-immunization`,\n+  MedicationRequest: `${HTTP_HL7_ORG}/fhir/us/core/StructureDefinition/us-core-medicationrequest`,\n+  Patient: `${HTTP_HL7_ORG}/fhir/us/core/StructureDefinition/us-core-patient`,\n+  ObservationSexualOrientation: `${HTTP_HL7_ORG}/fhir/us/core/StructureDefinition/us-core-observation-sexual-orientation`,\n+  ObservationSmokingStatus: `${HTTP_HL7_ORG}/fhir/us/core/StructureDefinition/us-core-smokingstatus`,\n+};\n+\n export const extensionURLMapping: Record<string, string> = {\n   race: HTTP_HL7_ORG + '/fhir/us/core/StructureDefinition/us-core-race',\n   ethnicity: HTTP_HL7_ORG + '/fhir/us/core/StructureDefinition/us-core-ethnicity',\n@@ -181,6 +192,7 @@ type ObservationQuestionnaireItemType = 'valueCodeableConcept' | 'valueDateTime'\n  * @param category - A category for the observation\n  * @param answerType - The value[x] field where the answer should be stored\n  * @param value - The value to be stored in the observation\n+ * @param profileUrl - An optional profile URL to be added to the resource\n  */\n export async function upsertObservation(\n   medplum: MedplumClient,\n@@ -188,20 +200,26 @@ export async function upsertObservation(\n   code: CodeableConcept,\n   category: CodeableConcept,\n   answerType: ObservationQuestionnaireItemType,\n-  value: QuestionnaireResponseItemAnswer | undefined\n+  value: QuestionnaireResponseItemAnswer | undefined,\n+  profileUrl?: string\n ): Promise<void> {\n   if (!value || !code) {\n     return;\n   }\n \n-  const observation: Observation = {\n+  let observation: Observation = {\n     resourceType: 'Observation',\n     status: 'final',\n     subject: createReference(patient),\n     code: code,\n     category: [category],\n+    effectiveDateTime: new Date().toISOString(),\n   };\n \n+  if (profileUrl) {\n+    observation = addProfileToResource(observation, profileUrl);\n+  }\n+\n   if (answerType === 'valueCodeableConcept') {\n     observation.valueCodeableConcept = {\n       coding: [value],\n@@ -220,44 +238,52 @@ export async function upsertObservation(\n type ExtensionQuestionnaireItemType = 'valueCoding' | 'valueBoolean';\n \n /**\n- * Sets an extension to a patient\n+ * Add an extension to a patient\n  *\n  * @param patient - A patient resource\n  * @param url - An URL that identifies the extension\n  * @param answerType - The value[x] field where the answer should be stored\n  * @param answer - The value to be stored in the extension\n+ * @param subExtensionKey - A key to identify a sub-extension\n  */\n-export function setExtension(\n+export function addExtension(\n   patient: Patient,\n   url: string,\n   answerType: ExtensionQuestionnaireItemType,\n-  answer: QuestionnaireResponseItemAnswer | undefined\n+  answer: QuestionnaireResponseItemAnswer | undefined,\n+  subExtensionKey?: string\n ): void {\n   let value = answer?.[answerType];\n \n   // Answer to boolean Questionnaire fields will be set as `undefined` if the check mark is not ticked\n   // so in this case we should interpret it as `false`.\n   if (answerType === 'valueBoolean') {\n-    value = !!value;\n+    value = Boolean(value);\n   }\n \n   if (value === undefined) {\n     return;\n   }\n \n-  const extension = getExtension(patient, url);\n+  patient.extension ||= [];\n \n-  if (extension) {\n-    // Update the value if there's already an extension for the URL\n-    Object.assign(extension, { [answerType]: value });\n-  } else {\n-    if (!patient.extension) {\n-      patient.extension = [];\n+  if (subExtensionKey) {\n+    const subExtensions = [\n+      {\n+        url: subExtensionKey,\n+        [answerType]: value,\n+      },\n+    ];\n+    if (answerType === 'valueCoding' && (value as Coding).display) {\n+      subExtensions.push({ url: 'text', valueString: (value as Coding).display as string });\n     }\n-\n-    // Add a new extension if there isn't one\n     patient.extension.push({\n-      url: url,\n+      url,\n+      extension: subExtensions,\n+    });\n+  } else {\n+    patient.extension.push({\n+      url,\n       [answerType]: value,\n     });\n   }\n@@ -323,6 +349,9 @@ export async function addAllergy(\n   await medplum.upsertResource(\n     {\n       resourceType: 'AllergyIntolerance',\n+      meta: {\n+        profile: [PROFILE_URLS.AllergyIntolerance],\n+      },\n       clinicalStatus: {\n         text: 'Active',\n         coding: [\n@@ -379,6 +408,9 @@ export async function addMedication(\n   await medplum.upsertResource(\n     {\n       resourceType: 'MedicationRequest',\n+      meta: {\n+        profile: [PROFILE_URLS.MedicationRequest],\n+      },\n       subject: createReference(patient),\n       status: 'active',\n       intent: 'order',\n@@ -491,6 +523,9 @@ export async function addImmunization(\n   await medplum.upsertResource(\n     {\n       resourceType: 'Immunization',\n+      meta: {\n+        profile: [PROFILE_URLS.Immunization],\n+      },\n       status: 'completed',\n       vaccineCode: { coding: [code] },\n       patient: createReference(patient),\n@@ -520,6 +555,9 @@ export async function addPharmacy(\n   await medplum.upsertResource(\n     {\n       resourceType: 'CareTeam',\n+      meta: {\n+        profile: [PROFILE_URLS.CareTeam],\n+      },\n       status: 'proposed',\n       name: 'Patient Preferred Pharmacy',\n       subject: createReference(patient),\n@@ -571,13 +609,16 @@ export async function addCoverage(\n       name: name ? [name] : undefined,\n       birthDate: relatedPersonAnswers['related-person-dob']?.valueDate,\n       gender:\n-        (relatedPersonAnswers['related-person-gender-identity'].valueCoding?.code as Patient['gender']) ?? undefined,\n+        (relatedPersonAnswers['related-person-gender-identity']?.valueCoding?.code as Patient['gender']) ?? undefined,\n     });\n   }\n \n   await medplum.upsertResource(\n     {\n       resourceType: 'Coverage',\n+      meta: {\n+        profile: [PROFILE_URLS.Coverage],\n+      },\n       status: 'active',\n       beneficiary: createReference(patient),\n       subscriberId: subscriberId,\n",
    "test_patch": "diff --git a/examples/medplum-patient-intake-demo/src/bots/core/intake-form.test.ts b/examples/medplum-patient-intake-demo/src/bots/core/intake-form.test.ts\nindex 343429f535..8dd17f3e66 100644\n--- a/examples/medplum-patient-intake-demo/src/bots/core/intake-form.test.ts\n+++ b/examples/medplum-patient-intake-demo/src/bots/core/intake-form.test.ts\n@@ -18,7 +18,6 @@ import {\n import { readJson, SEARCH_PARAMETER_BUNDLE_FILES } from '@medplum/definitions';\n import {\n   createReference,\n-  getExtensionValue,\n   getReferenceString,\n   indexSearchParameterBundle,\n   indexStructureDefinitionBundle,\n@@ -29,6 +28,7 @@ import {\n   consentScopeMapping,\n   extensionURLMapping,\n   findQuestionnaireItem,\n+  PROFILE_URLS,\n } from './intake-utils';\n \n describe('Intake form', async () => {\n@@ -77,6 +77,7 @@ describe('Intake form', async () => {\n       patient = (await medplum.searchOne('Patient', `identifier=${ssn}`)) as Patient;\n \n       expect(patient).toBeDefined();\n+      expect(patient.meta?.profile).toStrictEqual([PROFILE_URLS.Patient]);\n       expect(patient.name?.[0].given).toStrictEqual(['FirstName', 'MiddleName']);\n       expect(patient.name?.[0].family).toStrictEqual('LastName');\n       expect(patient.gender).toStrictEqual('33791000087105');\n@@ -130,22 +131,52 @@ describe('Intake form', async () => {\n       });\n     });\n \n-    test('Race and ethnicity', async () => {\n+    test('Race, ethnicity, and veteran status', async () => {\n       await handler(medplum, { bot, input: response, contentType, secrets: {} });\n \n       patient = (await medplum.searchOne('Patient', `identifier=${ssn}`)) as Patient;\n \n       expect(patient).toBeDefined();\n-      expect(getExtensionValue(patient, extensionURLMapping.race)).toStrictEqual({\n-        code: '2131-1',\n-        display: 'Other Race',\n-        system: 'urn:oid:2.16.840.1.113883.6.238',\n-      });\n-      expect(getExtensionValue(patient, extensionURLMapping.ethnicity)).toStrictEqual({\n-        code: '2135-2',\n-        display: 'Hispanic or Latino',\n-        system: 'urn:oid:2.16.840.1.113883.6.238',\n-      });\n+      expect(patient.extension).toStrictEqual([\n+        {\n+          url: extensionURLMapping.race,\n+          extension: [\n+            {\n+              url: 'ombCategory',\n+              valueCoding: {\n+                code: '2131-1',\n+                display: 'Other Race',\n+                system: 'urn:oid:2.16.840.1.113883.6.238',\n+              },\n+            },\n+            {\n+              url: 'text',\n+              valueString: 'Other Race',\n+            },\n+          ],\n+        },\n+        {\n+          url: extensionURLMapping.ethnicity,\n+          extension: [\n+            {\n+              url: 'ombCategory',\n+              valueCoding: {\n+                code: '2135-2',\n+                display: 'Hispanic or Latino',\n+                system: 'urn:oid:2.16.840.1.113883.6.238',\n+              },\n+            },\n+            {\n+              url: 'text',\n+              valueString: 'Hispanic or Latino',\n+            },\n+          ],\n+        },\n+        {\n+          url: extensionURLMapping.veteran,\n+          valueBoolean: true,\n+        },\n+      ]);\n     });\n   });\n \n@@ -161,11 +192,13 @@ describe('Intake form', async () => {\n \n       expect(allergies.length).toStrictEqual(2);\n \n+      expect(allergies[0].meta?.profile).toStrictEqual([PROFILE_URLS.AllergyIntolerance]);\n       expect(allergies[0].code?.coding?.[0].code).toStrictEqual('111088007');\n       expect(allergies[0].clinicalStatus?.coding?.[0].code).toStrictEqual('active');\n       expect(allergies[0].reaction?.[0].manifestation?.[0].text).toStrictEqual('Skin rash');\n       expect(allergies[0].onsetDateTime).toStrictEqual('2000-07-01T00:00:00Z');\n \n+      expect(allergies[1]?.meta?.profile).toStrictEqual([PROFILE_URLS.AllergyIntolerance]);\n       expect(allergies[1].code?.coding?.[0].code).toStrictEqual('763875007');\n       expect(allergies[1].clinicalStatus?.coding?.[0].code).toStrictEqual('active');\n       expect(allergies[1].reaction?.[0].manifestation?.[0].text).toStrictEqual('Skin rash');\n@@ -187,10 +220,12 @@ describe('Intake form', async () => {\n \n       expect(medications.length).toStrictEqual(2);\n \n+      expect(medications[0].meta?.profile).toStrictEqual([PROFILE_URLS.MedicationRequest]);\n       expect(medications[0].medicationCodeableConcept?.coding?.[0].code).toStrictEqual('1156277');\n       expect(medications[0].status).toStrictEqual('active');\n       expect(medications[0].note?.[0].text).toStrictEqual('I take it to manage my chronic back pain.');\n \n+      expect(medications[1]?.meta?.profile).toStrictEqual([PROFILE_URLS.MedicationRequest]);\n       expect(medications[1].medicationCodeableConcept?.coding?.[0].code).toStrictEqual('1161610');\n       expect(medications[1].status).toStrictEqual('active');\n       expect(medications[1].note?.[0].text).toStrictEqual('I take it to manage my diabetes.');\n@@ -269,11 +304,13 @@ describe('Intake form', async () => {\n \n       expect(immunizations.length).toStrictEqual(2);\n \n+      expect(immunizations[0].meta?.profile).toStrictEqual([PROFILE_URLS.Immunization]);\n       expect(immunizations[0].vaccineCode?.coding?.[0].system).toStrictEqual('http://hl7.org/fhir/sid/cvx');\n       expect(immunizations[0].vaccineCode?.coding?.[0].code).toStrictEqual('197');\n       expect(immunizations[0].status).toStrictEqual('completed');\n       expect(immunizations[0].occurrenceDateTime).toStrictEqual('2024-02-01T14:00:00-07:00');\n \n+      expect(immunizations[1].meta?.profile).toStrictEqual([PROFILE_URLS.Immunization]);\n       expect(immunizations[1].vaccineCode?.coding?.[0].system).toStrictEqual('http://hl7.org/fhir/sid/cvx');\n       expect(immunizations[1].vaccineCode?.coding?.[0].code).toStrictEqual('115');\n       expect(immunizations[1].status).toStrictEqual('completed');\n@@ -295,17 +332,6 @@ describe('Intake form', async () => {\n     });\n   });\n \n-  describe('Veteran status', async () => {\n-    test('sets as veteran', async () => {\n-      await handler(medplum, { bot, input: response, contentType, secrets: {} });\n-\n-      patient = (await medplum.searchOne('Patient', `identifier=${ssn}`)) as Patient;\n-\n-      expect(patient).toBeDefined();\n-      expect(getExtensionValue(patient, extensionURLMapping.veteran)).toStrictEqual(true);\n-    });\n-  });\n-\n   describe('Observations', async () => {\n     test('Sexual orientation', async () => {\n       await handler(medplum, { bot, input: response, contentType, secrets: {} });\n@@ -319,6 +345,8 @@ describe('Intake form', async () => {\n         subject: getReferenceString(patient),\n       });\n \n+      expect(observation).toBeDefined();\n+      expect(observation?.meta?.profile).toStrictEqual([PROFILE_URLS.ObservationSexualOrientation]);\n       expect(observation?.valueCodeableConcept?.coding?.[0].code).toStrictEqual('42035005');\n     });\n \n@@ -349,6 +377,8 @@ describe('Intake form', async () => {\n         subject: getReferenceString(patient),\n       });\n \n+      expect(observation).toBeDefined();\n+      expect(observation?.meta?.profile).toStrictEqual([PROFILE_URLS.ObservationSmokingStatus]);\n       expect(observation?.valueCodeableConcept?.coding?.[0].code).toStrictEqual('428041000124106');\n     });\n \n@@ -411,6 +441,7 @@ describe('Intake form', async () => {\n       });\n \n       expect(careTeam.length).toStrictEqual(1);\n+      expect(careTeam[0].meta?.profile).toStrictEqual([PROFILE_URLS.CareTeam]);\n       expect(careTeam[0].status).toStrictEqual('proposed');\n       expect(careTeam[0].name).toStrictEqual('Patient Preferred Pharmacy');\n       expect(careTeam[0].participant?.length).toStrictEqual(1);\n@@ -428,11 +459,15 @@ describe('Intake form', async () => {\n \n       const coverages = await medplum.searchResources('Coverage', { beneficiary: getReferenceString(patient) });\n \n+      expect(coverages.length).toStrictEqual(2);\n+\n+      expect(coverages[0].meta?.profile).toStrictEqual([PROFILE_URLS.Coverage]);\n       expect(coverages[0].beneficiary).toStrictEqual(createReference(patient));\n       expect(coverages[0].subscriberId).toStrictEqual('first-provider-id');\n       expect(coverages[0].relationship?.coding?.[0]?.code).toStrictEqual('self');\n       expect(coverages[0].payor?.[0].reference).toStrictEqual(getReferenceString(payor1));\n \n+      expect(coverages[1].meta?.profile).toStrictEqual([PROFILE_URLS.Coverage]);\n       expect(coverages[1].beneficiary).toStrictEqual(createReference(patient));\n       expect(coverages[1].subscriberId).toStrictEqual('second-provider-id');\n       expect(coverages[1].relationship?.coding?.[0]?.code).toStrictEqual('child');\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5668",
    "pr_id": 5668,
    "issue_id": 2726,
    "repo": "medplum/medplum",
    "problem_statement": "Implement Questionnaire Extension: calculatedExpression\nThis calculated value is based on an expression that gets evaluated and can allow for a deeper analysis for next questions in the questionnaire flow. \r\n\r\nhttp://build.fhir.org/ig/HL7/sdc/StructureDefinition-sdc-questionnaire-calculatedExpression.html",
    "issue_word_count": 41,
    "test_files_count": 2,
    "non_test_files_count": 3,
    "pr_changed_files": [
      "packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx",
      "packages/react/src/QuestionnaireForm/QuestionnaireForm.tsx",
      "packages/react/src/QuestionnaireForm/QuestionnaireFormComponents/QuestionnaireFormGroup.tsx",
      "packages/react/src/utils/questionnaire.test.ts",
      "packages/react/src/utils/questionnaire.ts"
    ],
    "pr_changed_test_files": [
      "packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx",
      "packages/react/src/utils/questionnaire.test.ts"
    ],
    "base_commit": "89803db4a8f3e220a44d35386c43271acc2f5ebc",
    "head_commit": "832d71e59422d512db0ad22064f72ec4a7cb8a54",
    "repo_url": "https://github.com/medplum/medplum/pull/5668",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5668",
    "dockerfile": "",
    "pr_merged_at": "2024-12-19T03:10:45.000Z",
    "patch": "diff --git a/packages/react/src/QuestionnaireForm/QuestionnaireForm.tsx b/packages/react/src/QuestionnaireForm/QuestionnaireForm.tsx\nindex 7dbd50b536..f5afb53e30 100644\n--- a/packages/react/src/QuestionnaireForm/QuestionnaireForm.tsx\n+++ b/packages/react/src/QuestionnaireForm/QuestionnaireForm.tsx\n@@ -11,7 +11,13 @@ import {\n import { useMedplum, usePrevious, useResource } from '@medplum/react-hooks';\n import { useCallback, useEffect, useRef, useState } from 'react';\n import { Form } from '../Form/Form';\n-import { buildInitialResponse, getNumberOfPages, isQuestionEnabled } from '../utils/questionnaire';\n+import {\n+  buildInitialResponse,\n+  getNumberOfPages,\n+  isQuestionEnabled,\n+  evaluateCalculatedExpressionsInQuestionnaire,\n+  mergeUpdatedItems,\n+} from '../utils/questionnaire';\n import { QuestionnaireFormContext } from './QuestionnaireForm.context';\n import { QuestionnairePageSequence } from './QuestionnaireFormComponents/QuestionnaireFormPageSequence';\n \n@@ -61,22 +67,35 @@ export function QuestionnaireForm(props: QuestionnaireFormProps): JSX.Element |\n     }\n   }, [response]);\n \n-  const setItems = useCallback((newResponseItems: QuestionnaireResponseItem | QuestionnaireResponseItem[]): void => {\n-    setResponse((prevResponse) => {\n-      const currentItems = prevResponse?.item ?? [];\n-      const mergedItems = mergeItems(\n-        currentItems,\n-        Array.isArray(newResponseItems) ? newResponseItems : [newResponseItems]\n-      );\n-\n-      const newResponse: QuestionnaireResponse = {\n-        resourceType: 'QuestionnaireResponse',\n-        status: 'in-progress',\n-        item: mergedItems,\n-      };\n-      return newResponse;\n-    });\n-  }, []);\n+  const setItems = useCallback(\n+    (newResponseItems: QuestionnaireResponseItem | QuestionnaireResponseItem[]): void => {\n+      setResponse((prevResponse) => {\n+        const currentItems = prevResponse?.item ?? [];\n+        const mergedItems = mergeItems(\n+          currentItems,\n+          Array.isArray(newResponseItems) ? newResponseItems : [newResponseItems]\n+        );\n+\n+        const tempResponse: QuestionnaireResponse = {\n+          resourceType: 'QuestionnaireResponse',\n+          status: 'in-progress',\n+          item: mergedItems,\n+        };\n+\n+        const updatedItems = evaluateCalculatedExpressionsInQuestionnaire(questionnaire?.item ?? [], tempResponse);\n+        const mergedItemsWithUpdates = mergeUpdatedItems(mergedItems, updatedItems);\n+\n+        const newResponse: QuestionnaireResponse = {\n+          resourceType: 'QuestionnaireResponse',\n+          status: 'in-progress',\n+          item: mergedItemsWithUpdates,\n+        };\n+\n+        return newResponse;\n+      });\n+    },\n+    [questionnaire]\n+  );\n \n   const handleSubmit = useCallback(() => {\n     const onSubmit = onSubmitRef.current;\n\ndiff --git a/packages/react/src/QuestionnaireForm/QuestionnaireFormComponents/QuestionnaireFormGroup.tsx b/packages/react/src/QuestionnaireForm/QuestionnaireFormComponents/QuestionnaireFormGroup.tsx\nindex 8f9471709b..edcfa5e402 100644\n--- a/packages/react/src/QuestionnaireForm/QuestionnaireFormComponents/QuestionnaireFormGroup.tsx\n+++ b/packages/react/src/QuestionnaireForm/QuestionnaireFormComponents/QuestionnaireFormGroup.tsx\n@@ -1,6 +1,6 @@\n import { Anchor, Stack, Title } from '@mantine/core';\n import { QuestionnaireItem, QuestionnaireResponseItem } from '@medplum/fhirtypes';\n-import { useState } from 'react';\n+import { useEffect, useState } from 'react';\n import { QuestionnaireItemType, buildInitialResponseItem } from '../../utils/questionnaire';\n import { QuestionnaireRepeatableItem } from '../QuestionnaireFormItem/QuestionnaireRepeatableItem';\n \n@@ -14,6 +14,10 @@ interface QuestionnaireRepeatableGroupProps {\n export function QuestionnaireRepeatedGroup(props: QuestionnaireRepeatableGroupProps): JSX.Element | null {\n   const [responses, setResponses] = useState(props.response);\n \n+  useEffect(() => {\n+    setResponses(props.response);\n+  }, [props.response]);\n+\n   if (responses.length === 0) {\n     return null;\n   }\n@@ -97,6 +101,7 @@ export function QuestionnaireGroup(props: QuestionnaireGroupProps): JSX.Element\n               />\n             );\n           }\n+\n           return (\n             <QuestionnaireRepeatableItem\n               key={item.linkId}\n\ndiff --git a/packages/react/src/utils/questionnaire.ts b/packages/react/src/utils/questionnaire.ts\nindex d2a5890106..90c756463f 100644\n--- a/packages/react/src/utils/questionnaire.ts\n+++ b/packages/react/src/utils/questionnaire.ts\n@@ -1,5 +1,6 @@\n import {\n   HTTP_HL7_ORG,\n+  PropertyType,\n   TypedValue,\n   deepClone,\n   evalFhirPathTyped,\n@@ -94,6 +95,122 @@ export function isQuestionEnabled(\n   return enableBehavior !== 'any';\n }\n \n+export function evaluateCalculatedExpressionsInQuestionnaire(\n+  items: QuestionnaireItem[],\n+  response: QuestionnaireResponse | undefined\n+): QuestionnaireResponseItem[] {\n+  return items\n+    .map((item): QuestionnaireResponseItem | null => {\n+      if (item.item) {\n+        return {\n+          ...item,\n+          item: evaluateCalculatedExpressionsInQuestionnaire(item.item, response),\n+        };\n+      } else {\n+        const calculatedValue = evaluateCalculatedExpression(item, response);\n+        if (!calculatedValue) {\n+          return null;\n+        }\n+\n+        const answer = typedValueToResponseItem(item, calculatedValue);\n+\n+        if (!answer) {\n+          return null;\n+        }\n+\n+        return {\n+          id: item?.id,\n+          linkId: item?.linkId,\n+          text: item.text,\n+          answer: [answer],\n+        };\n+      }\n+    })\n+    .filter((item): item is QuestionnaireResponseItem => item !== null);\n+}\n+\n+export function typedValueToResponseItem(\n+  item: QuestionnaireItem,\n+  value: TypedValue\n+): QuestionnaireResponseItemAnswer | undefined {\n+  if (!item.type) {\n+    return undefined;\n+  }\n+\n+  switch (item.type) {\n+    case QuestionnaireItemType.boolean:\n+      return value.type === PropertyType.boolean ? { valueBoolean: value.value } : undefined;\n+    case QuestionnaireItemType.date:\n+      return value.type === PropertyType.date ? { valueDate: value.value } : undefined;\n+    case QuestionnaireItemType.dateTime:\n+      return value.type === PropertyType.dateTime ? { valueDateTime: value.value } : undefined;\n+    case QuestionnaireItemType.time:\n+      return value.type === PropertyType.time ? { valueTime: value.value } : undefined;\n+    case QuestionnaireItemType.url:\n+      return value.type === PropertyType.url ? { valueString: value.value } : undefined;\n+    case QuestionnaireItemType.text:\n+      return value.type === PropertyType.string ? { valueString: value.value } : undefined;\n+    case QuestionnaireItemType.attachment:\n+      return value.type === PropertyType.Attachment ? { valueAttachment: value.value } : undefined;\n+    case QuestionnaireItemType.reference:\n+      return value.type === PropertyType.Reference ? { valueReference: value.value } : undefined;\n+    case QuestionnaireItemType.quantity:\n+      return { valueQuantity: value.value };\n+    case QuestionnaireItemType.decimal:\n+      return { valueDecimal: value.value };\n+    case QuestionnaireItemType.integer:\n+      return { valueInteger: value.value };\n+    case QuestionnaireItemType.string:\n+      return { valueString: value.value };\n+    default:\n+      return undefined;\n+  }\n+}\n+\n+function evaluateCalculatedExpression(\n+  item: QuestionnaireItem,\n+  response: QuestionnaireResponse | undefined\n+): TypedValue | undefined {\n+  if (!response) {\n+    return undefined;\n+  }\n+\n+  const extension = getExtension(\n+    item,\n+    HTTP_HL7_ORG + '/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression'\n+  );\n+\n+  if (extension) {\n+    const expression = extension.valueExpression?.expression;\n+    if (expression) {\n+      const value = toTypedValue(response);\n+      const result = evalFhirPathTyped(expression, [value], { '%resource': value });\n+      return result.length !== 0 ? result[0] : undefined;\n+    }\n+  }\n+  return undefined;\n+}\n+\n+export function mergeUpdatedItems(\n+  mergedItems: QuestionnaireResponseItem[],\n+  updatedItems: QuestionnaireResponseItem[]\n+): QuestionnaireResponseItem[] {\n+  return mergedItems.map((mergedItem) => {\n+    const updatedItem = updatedItems.find((updated) => updated.linkId === mergedItem.linkId);\n+\n+    // Usually fields with calculated expressions would be readOnly in the case where it allows foe manual updates.\n+    // It would get replaced with content from calcultaed expresion.\n+    if (updatedItem) {\n+      return {\n+        ...mergedItem,\n+        item: updatedItem.item ? mergeUpdatedItems(mergedItem.item || [], updatedItem.item) : mergedItem.item,\n+        answer: updatedItem.answer || mergedItem.answer,\n+      };\n+    }\n+    return mergedItem;\n+  });\n+}\n+\n export function getNewMultiSelectValues(\n   selected: string[],\n   propertyName: string,\n",
    "test_patch": "diff --git a/packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx b/packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx\nindex d03b416471..e2a52566f9 100644\n--- a/packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx\n+++ b/packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx\n@@ -1743,4 +1743,165 @@ describe('QuestionnaireForm', () => {\n     expect(params.get('subject')).toBe('Patient/123');\n     expect(params.get('code')).toBe('Test');\n   });\n+\n+  test('Questionnaire CalculatedExpression with boolean field', async () => {\n+    const onSubmit = jest.fn();\n+\n+    await setup({\n+      questionnaire: {\n+        resourceType: 'Questionnaire',\n+        status: 'active',\n+        id: 'temperature-threshold',\n+        title: 'Temperature Threshold Check',\n+        item: [\n+          {\n+            id: 'id-1',\n+            linkId: 'q1',\n+            type: 'string',\n+            text: 'Fahrenheit',\n+          },\n+          {\n+            id: 'id-2',\n+            linkId: 'q2',\n+            type: 'boolean',\n+            text: 'Is temperature over 120?',\n+            extension: [\n+              {\n+                url: 'http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression',\n+                valueExpression: {\n+                  language: 'text/fhirpath',\n+                  expression:\n+                    \"iif(%resource.item.where(linkId='q1').answer.value.empty(), false, (%resource.item.where(linkId='q1').answer.value.toDecimal() > 120))\",\n+                },\n+              },\n+            ],\n+          },\n+        ],\n+      },\n+      onSubmit,\n+    });\n+\n+    await act(async () => {\n+      fireEvent.change(screen.getByLabelText('Fahrenheit'), { target: { value: '125' } });\n+    });\n+\n+    await act(async () => {\n+      fireEvent.click(screen.getByText('Submit'));\n+    });\n+\n+    expect(onSubmit).toHaveBeenCalled();\n+\n+    const response = onSubmit.mock.calls[0][0];\n+    const answers = getQuestionnaireAnswers(response);\n+\n+    expect(answers['q1']).toMatchObject({ valueString: '125' });\n+    expect(answers['q2']).toMatchObject({ valueBoolean: true });\n+\n+    await act(async () => {\n+      fireEvent.change(screen.getByLabelText('Fahrenheit'), { target: { value: '100' } });\n+    });\n+\n+    await act(async () => {\n+      fireEvent.click(screen.getByText('Submit'));\n+    });\n+\n+    const response2 = onSubmit.mock.calls[1][0];\n+    const answers2 = getQuestionnaireAnswers(response2);\n+\n+    expect(answers2['q1']).toMatchObject({ valueString: '100' });\n+    expect(answers2['q2']).toMatchObject({ valueBoolean: false });\n+\n+    await act(async () => {\n+      fireEvent.change(screen.getByLabelText('Fahrenheit'), { target: { value: '' } });\n+    });\n+\n+    await act(async () => {\n+      fireEvent.click(screen.getByText('Submit'));\n+    });\n+\n+    const response3 = onSubmit.mock.calls[2][0];\n+    const answers3 = getQuestionnaireAnswers(response3);\n+\n+    expect(answers3['q1']).toMatchObject({ valueString: '' });\n+    expect(answers3['q2']).toMatchObject({ valueBoolean: false });\n+  });\n+\n+  test('Questionnaire CalculatedExpression with nested groups', async () => {\n+    const onSubmit = jest.fn();\n+\n+    await setup({\n+      questionnaire: {\n+        resourceType: 'Questionnaire',\n+        status: 'active',\n+        id: 'temperature-conversion',\n+        title: 'Temperature Conversion',\n+        item: [\n+          {\n+            id: 'id-6',\n+            linkId: 'g6',\n+            type: 'group',\n+            text: 'Temperature Group',\n+            item: [\n+              {\n+                id: 'id-1',\n+                linkId: 'q1',\n+                type: 'decimal',\n+                text: 'Fahrenheit',\n+              },\n+              {\n+                id: 'id-2',\n+                linkId: 'q2',\n+                type: 'decimal',\n+                text: 'Celsius',\n+                extension: [\n+                  {\n+                    url: 'http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression',\n+                    valueExpression: {\n+                      language: 'text/fhirpath',\n+                      expression:\n+                        \"iif(%resource.item.where(linkId='g6').item.where(linkId='q1').answer.value.empty(), '', ((%resource.item.where(linkId='g6').item.where(linkId='q1').answer.value - 32) * 5 / 9).round(2))\",\n+                    },\n+                  },\n+                ],\n+              },\n+              {\n+                id: 'id-3',\n+                linkId: 'q3',\n+                type: 'decimal',\n+                text: 'Kelvin',\n+                extension: [\n+                  {\n+                    url: 'http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression',\n+                    valueExpression: {\n+                      language: 'text/fhirpath',\n+                      expression:\n+                        \"iif(%resource.item.where(linkId='g6').item.where(linkId='q1').answer.value.empty(), '', (((%resource.item.where(linkId='g6').item.where(linkId='q1').answer.value - 32) * 5 / 9) + 273.15).round(2))\",\n+                    },\n+                  },\n+                ],\n+              },\n+            ],\n+          },\n+        ],\n+      },\n+      onSubmit,\n+    });\n+\n+    await act(async () => {\n+      fireEvent.change(screen.getByLabelText('Fahrenheit'), { target: { value: '100' } });\n+    });\n+\n+    await act(async () => {\n+      fireEvent.click(screen.getByText('Submit'));\n+    });\n+\n+    expect(onSubmit).toHaveBeenCalled();\n+\n+    const response = onSubmit.mock.calls[0][0];\n+    const answers = getQuestionnaireAnswers(response);\n+\n+    expect(answers['q1']).toMatchObject({ valueDecimal: 100 }); // Original Fahrenheit value\n+    expect(answers['q2']).toMatchObject({ valueDecimal: 38 }); // Calculated Celsius\n+    expect(answers['q3']).toMatchObject({ valueDecimal: 311 }); // Calculated Kelvin\n+  });\n });\n\ndiff --git a/packages/react/src/utils/questionnaire.test.ts b/packages/react/src/utils/questionnaire.test.ts\nindex 701c129156..531b3e7056 100644\n--- a/packages/react/src/utils/questionnaire.test.ts\n+++ b/packages/react/src/utils/questionnaire.test.ts\n@@ -1,5 +1,11 @@\n-import { QuestionnaireItem, QuestionnaireItemEnableWhen } from '@medplum/fhirtypes';\n-import { getNewMultiSelectValues, isChoiceQuestion, isQuestionEnabled } from './questionnaire';\n+import { QuestionnaireItem, QuestionnaireItemEnableWhen, QuestionnaireResponse } from '@medplum/fhirtypes';\n+import {\n+  evaluateCalculatedExpressionsInQuestionnaire,\n+  getNewMultiSelectValues,\n+  isChoiceQuestion,\n+  isQuestionEnabled,\n+  typedValueToResponseItem,\n+} from './questionnaire';\n \n describe('QuestionnaireUtils', () => {\n   test('isChoiceQuestion', () => {\n@@ -1259,4 +1265,241 @@ describe('isQuestionEnabled', () => {\n     const result = getNewMultiSelectValues(selected, propertyName, item);\n     expect(result).toStrictEqual([{ valueCoding: { code: 'code1' } }]);\n   });\n+\n+  describe('typedValueToResponseItem', () => {\n+    it('returns correct value for type boolean', () => {\n+      const item: QuestionnaireItem = { linkId: '1', type: 'boolean' };\n+      const value = { type: 'boolean', value: true };\n+      const result = typedValueToResponseItem(item, value);\n+      expect(result).toEqual({ valueBoolean: true });\n+    });\n+\n+    it('returns undefined for mismatched boolean type', () => {\n+      const item: QuestionnaireItem = { linkId: '1', type: 'boolean' };\n+      const value = { type: 'string', value: 'text' };\n+      const result = typedValueToResponseItem(item, value);\n+      expect(result).toBeUndefined();\n+    });\n+\n+    it('returns correct value for type date', () => {\n+      const item: QuestionnaireItem = { linkId: '1', type: 'date' };\n+      const value = { type: 'date', value: '2024-01-01' };\n+      const result = typedValueToResponseItem(item, value);\n+      expect(result).toEqual({ valueDate: '2024-01-01' });\n+    });\n+\n+    it('returns correct value for type dateTime', () => {\n+      const item: QuestionnaireItem = { linkId: '1', type: 'dateTime' };\n+      const value = { type: 'dateTime', value: '2024-01-01T12:00:00Z' };\n+      const result = typedValueToResponseItem(item, value);\n+      expect(result).toEqual({ valueDateTime: '2024-01-01T12:00:00Z' });\n+    });\n+\n+    it('returns correct value for type time', () => {\n+      const item: QuestionnaireItem = { linkId: '1', type: 'time' };\n+      const value = { type: 'time', value: '12:00:00' };\n+      const result = typedValueToResponseItem(item, value);\n+      expect(result).toEqual({ valueTime: '12:00:00' });\n+    });\n+\n+    it('returns correct value for type url', () => {\n+      const item: QuestionnaireItem = { linkId: '1', type: 'url' };\n+      const value = { type: 'url', value: 'http://example.com' };\n+      const result = typedValueToResponseItem(item, value);\n+      expect(result).toEqual({ valueString: 'http://example.com' });\n+    });\n+\n+    it('returns correct value for type text', () => {\n+      const item: QuestionnaireItem = { linkId: '1', type: 'text' };\n+      const value = { type: 'string', value: 'Sample text' };\n+      const result = typedValueToResponseItem(item, value);\n+      expect(result).toEqual({ valueString: 'Sample text' });\n+    });\n+\n+    it('returns correct value for type attachment', () => {\n+      const item: QuestionnaireItem = { linkId: '1', type: 'attachment' };\n+      const value = { type: 'Attachment', value: { file: 'file.pdf' } };\n+      const result = typedValueToResponseItem(item, value);\n+      expect(result).toEqual({ valueAttachment: { file: 'file.pdf' } });\n+    });\n+\n+    it('returns correct value for type reference', () => {\n+      const item: QuestionnaireItem = { linkId: '1', type: 'reference' };\n+      const value = { type: 'Reference', value: { ref: '123' } };\n+      const result = typedValueToResponseItem(item, value);\n+      expect(result).toEqual({ valueReference: { ref: '123' } });\n+    });\n+\n+    it('returns correct value for type quantity', () => {\n+      const item: QuestionnaireItem = { linkId: '1', type: 'quantity' };\n+      const value = { type: 'quantity', value: 10 };\n+      const result = typedValueToResponseItem(item, value);\n+      expect(result).toEqual({ valueQuantity: 10 });\n+    });\n+\n+    it('returns undefined for unsupported type', () => {\n+      const item: QuestionnaireItem = { linkId: '1', type: 'unsupported' as any };\n+      const value = { type: 'string', value: 'text' };\n+      const result = typedValueToResponseItem(item, value);\n+      expect(result).toBeUndefined();\n+    });\n+  });\n+\n+  describe('evaluateCalculatedExpressionsInQuestionnaire', () => {\n+    test('Boolean type with condition', () => {\n+      const items: QuestionnaireItem[] = [\n+        {\n+          id: 'q1',\n+          linkId: 'q1',\n+          type: 'boolean',\n+          text: 'Is Age Over 18?',\n+          extension: [\n+            {\n+              url: 'http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression',\n+              valueExpression: {\n+                expression: '20 > 18',\n+                language: 'text/fhirpath',\n+              },\n+            },\n+          ],\n+        },\n+      ];\n+\n+      const response: QuestionnaireResponse = { resourceType: 'QuestionnaireResponse', status: 'in-progress' };\n+      const result = evaluateCalculatedExpressionsInQuestionnaire(items, response);\n+      expect(result).toEqual([\n+        {\n+          id: 'q1',\n+          linkId: 'q1',\n+          text: 'Is Age Over 18?',\n+          answer: [{ valueBoolean: true }],\n+        },\n+      ]);\n+    });\n+\n+    test('Date type with today() function', () => {\n+      const items: QuestionnaireItem[] = [\n+        {\n+          id: 'q2',\n+          linkId: 'q2',\n+          type: 'date',\n+          text: \"Today's Date\",\n+          extension: [\n+            {\n+              url: 'http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression',\n+              valueExpression: {\n+                expression: 'today()',\n+                language: 'text/fhirpath',\n+              },\n+            },\n+          ],\n+        },\n+      ];\n+\n+      const response: QuestionnaireResponse = { resourceType: 'QuestionnaireResponse', status: 'in-progress' };\n+      const result = evaluateCalculatedExpressionsInQuestionnaire(items, response);\n+      const today = new Date().toISOString().split('T')[0]; // Get today's date in YYYY-MM-DD format\n+      expect(result).toEqual([\n+        {\n+          id: 'q2',\n+          linkId: 'q2',\n+          text: \"Today's Date\",\n+          answer: [{ valueDate: today }],\n+        },\n+      ]);\n+    });\n+\n+    test('Integer type with addition', () => {\n+      const items: QuestionnaireItem[] = [\n+        {\n+          id: 'q3',\n+          linkId: 'q3',\n+          type: 'integer',\n+          text: 'Age Next Year',\n+          extension: [\n+            {\n+              url: 'http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression',\n+              valueExpression: {\n+                expression: '30 + 1',\n+                language: 'text/fhirpath',\n+              },\n+            },\n+          ],\n+        },\n+      ];\n+\n+      const response: QuestionnaireResponse = { resourceType: 'QuestionnaireResponse', status: 'in-progress' };\n+      const result = evaluateCalculatedExpressionsInQuestionnaire(items, response);\n+      expect(result).toEqual([\n+        {\n+          id: 'q3',\n+          linkId: 'q3',\n+          text: 'Age Next Year',\n+          answer: [{ valueInteger: 31 }],\n+        },\n+      ]);\n+    });\n+\n+    test('Decimal type with division', () => {\n+      const items: QuestionnaireItem[] = [\n+        {\n+          id: 'q4',\n+          linkId: 'q4',\n+          type: 'decimal',\n+          text: 'Half of 98',\n+          extension: [\n+            {\n+              url: 'http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression',\n+              valueExpression: {\n+                expression: '98 / 2',\n+                language: 'text/fhirpath',\n+              },\n+            },\n+          ],\n+        },\n+      ];\n+\n+      const response: QuestionnaireResponse = { resourceType: 'QuestionnaireResponse', status: 'in-progress' };\n+      const result = evaluateCalculatedExpressionsInQuestionnaire(items, response);\n+      expect(result).toEqual([\n+        {\n+          id: 'q4',\n+          linkId: 'q4',\n+          text: 'Half of 98',\n+          answer: [{ valueDecimal: 49.0 }],\n+        },\n+      ]);\n+    });\n+\n+    test('String type with concatenation', () => {\n+      const items: QuestionnaireItem[] = [\n+        {\n+          id: 'q5',\n+          linkId: 'q5',\n+          type: 'string',\n+          text: 'Full Name',\n+          extension: [\n+            {\n+              url: 'http://hl7.org/fhir/uv/sdc/StructureDefinition/sdc-questionnaire-calculatedExpression',\n+              valueExpression: {\n+                expression: \"'John' + ' ' + 'Doe'\",\n+                language: 'text/fhirpath',\n+              },\n+            },\n+          ],\n+        },\n+      ];\n+\n+      const response: QuestionnaireResponse = { resourceType: 'QuestionnaireResponse', status: 'in-progress' };\n+      const result = evaluateCalculatedExpressionsInQuestionnaire(items, response);\n+      expect(result).toEqual([\n+        {\n+          id: 'q5',\n+          linkId: 'q5',\n+          text: 'Full Name',\n+          answer: [{ valueString: 'John Doe' }],\n+        },\n+      ]);\n+    });\n+  });\n });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5661",
    "pr_id": 5661,
    "issue_id": 5644,
    "repo": "medplum/medplum",
    "problem_statement": "Slicing on non-array elements \nHi team, Great work! \r\n\r\nI was trying to use the US Core Smoking Status profile and encountered an issue with Medplum: Slicing can only happen on arrays. \r\n\r\nThe Smoking Status profile defines slices on value[x], which is not an array. Is there an issue there?\r\n\r\n",
    "issue_word_count": 51,
    "test_files_count": 2,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/core/src/default-values.test.ts",
      "packages/core/src/default-values.ts",
      "packages/definitions/dist/fhir/r4/testing/uscore-v7.0.0-smoking-status.json"
    ],
    "pr_changed_test_files": [
      "packages/core/src/default-values.test.ts",
      "packages/definitions/dist/fhir/r4/testing/uscore-v7.0.0-smoking-status.json"
    ],
    "base_commit": "ddde10fdd5e4159fa2a763f495fb3afdc66d8d69",
    "head_commit": "4da2ecd3eb5d7899485352519ad3afaaae6d9844",
    "repo_url": "https://github.com/medplum/medplum/pull/5661",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5661",
    "dockerfile": "",
    "pr_merged_at": "2024-12-13T17:50:56.000Z",
    "patch": "diff --git a/packages/core/src/default-values.ts b/packages/core/src/default-values.ts\nindex 2f08a2d6cd..2957a37bb1 100644\n--- a/packages/core/src/default-values.ts\n+++ b/packages/core/src/default-values.ts\n@@ -201,17 +201,12 @@ class DefaultValueVisitor implements SchemaVisitor {\n     const elementValues = this.value.values;\n     const sliceValues: any[] = [];\n \n-    for (const elementValue of elementValues) {\n-      if (elementValue === undefined) {\n-        continue;\n-      }\n-\n-      if (!Array.isArray(elementValue)) {\n-        throw new Error('Expected array value for sliced element');\n+    for (const value of elementValues) {\n+      if (value !== undefined) {\n+        const elementValues = Array.isArray(value) ? value : [value];\n+        const matchingItems: any[] = this.getMatchingSliceValues(elementValues, slice, slicing);\n+        sliceValues.push(matchingItems);\n       }\n-\n-      const matchingItems: any[] = this.getMatchingSliceValues(elementValue, slice, slicing);\n-      sliceValues.push(matchingItems);\n     }\n \n     this.valueStack.push({\n",
    "test_patch": "diff --git a/packages/core/src/default-values.test.ts b/packages/core/src/default-values.test.ts\nindex 868661178b..eade7b8f09 100644\n--- a/packages/core/src/default-values.test.ts\n+++ b/packages/core/src/default-values.test.ts\n@@ -329,6 +329,28 @@ describe('apply default values', () => {\n       expect(elem.pattern).toBeUndefined();\n     });\n   });\n+\n+  describe('US Core Smoking Status', () => {\n+    const profileUrl = 'http://hl7.org/fhir/us/core/StructureDefinition/us-core-smokingstatus';\n+\n+    beforeAll(() => {\n+      const smokingStatusProfile: StructureDefinition = readJson('fhir/r4/testing/uscore-v7.0.0-smoking-status.json');\n+      indexStructureDefinitionBundle([smokingStatusProfile]);\n+    });\n+\n+    test('Slice on singleton element does not error', () => {\n+      const schema = tryGetProfile(profileUrl);\n+      expect(schema).toBeDefined();\n+\n+      const resource: Observation = {\n+        resourceType: 'Observation',\n+        status: 'final',\n+        code: { coding: [{ system: 'http://loinc.org', code: '72166-2' }] },\n+      };\n+      const withDefaults = applyDefaultValuesToResource(resource, schema as InternalTypeSchema);\n+      expect(withDefaults).toEqual(resource);\n+    });\n+  });\n });\n \n function getComplexUSCorePatient(): Patient {\n\ndiff --git a/packages/definitions/dist/fhir/r4/testing/uscore-v7.0.0-smoking-status.json b/packages/definitions/dist/fhir/r4/testing/uscore-v7.0.0-smoking-status.json\nnew file mode 100644\nindex 0000000000..f5d75c01d8\n--- /dev/null\n+++ b/packages/definitions/dist/fhir/r4/testing/uscore-v7.0.0-smoking-status.json\n@@ -0,0 +1,2696 @@\n+{\n+  \"resourceType\" : \"StructureDefinition\",\n+  \"id\" : \"us-core-smokingstatus\",\n+  \"text\" : {\n+    \"status\" : \"extensions\",\n+    \"div\" : \"<div xmlns=\\\"http://www.w3.org/1999/xhtml\\\"><table border=\\\"0\\\" cellpadding=\\\"0\\\" cellspacing=\\\"0\\\" style=\\\"border: 0px #F0F0F0 solid; font-size: 11px; font-family: verdana; vertical-align: top;\\\"><tr style=\\\"border: 1px #F0F0F0 solid; font-size: 11px; font-family: verdana; vertical-align: top\\\"><th style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><a href=\\\"https://build.fhir.org/ig/FHIR/ig-guidance/readingIgs.html#table-views\\\" title=\\\"The logical name of the element\\\">Name</a></th><th style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><a href=\\\"https://build.fhir.org/ig/FHIR/ig-guidance/readingIgs.html#table-views\\\" title=\\\"Information about the use of the element\\\">Flags</a></th><th style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><a href=\\\"https://build.fhir.org/ig/FHIR/ig-guidance/readingIgs.html#table-views\\\" title=\\\"Minimum and Maximum # of times the the element can appear in the instance\\\">Card.</a></th><th style=\\\"width: 100px\\\" class=\\\"hierarchy\\\"><a href=\\\"https://build.fhir.org/ig/FHIR/ig-guidance/readingIgs.html#table-views\\\" title=\\\"Reference to the type of the element\\\">Type</a></th><th style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><a href=\\\"https://build.fhir.org/ig/FHIR/ig-guidance/readingIgs.html#table-views\\\" title=\\\"Additional information about the element\\\">Description &amp; Constraints</a><span style=\\\"float: right\\\"><a href=\\\"https://build.fhir.org/ig/FHIR/ig-guidance/readingIgs.html#table-views\\\" title=\\\"Legend for this format\\\"><img src=\\\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3goXBCwdPqAP0wAAAldJREFUOMuNk0tIlFEYhp9z/vE2jHkhxXA0zJCMitrUQlq4lnSltEqCFhFG2MJFhIvIFpkEWaTQqjaWZRkp0g26URZkTpbaaOJkDqk10szoODP//7XIMUe0elcfnPd9zsfLOYplGrpRwZaqTtw3K7PtGem7Q6FoidbGgqHVy/HRb669R+56zx7eRV1L31JGxYbBtjKK93cxeqfyQHbehkZbUkK20goELEuIzEd+dHS+qz/Y8PTSif0FnGkbiwcAjHaU1+QWOptFiyCLp/LnKptpqIuXHx6rbR26kJcBX3yLgBfnd7CxwJmflpP2wUg0HIAoUUpZBmKzELGWcN8nAr6Gpu7tLU/CkwAaoKTWRSQyt89Q8w6J+oVQkKnBoblH7V0PPvUOvDYXfopE/SJmALsxnVm6LbkotrUtNowMeIrVrBcBpaMmdS0j9df7abpSuy7HWehwJdt1lhVwi/J58U5beXGAF6c3UXLycw1wdFklArBn87xdh0ZsZtArghBdAA3+OEDVubG4UEzP6x1FOWneHh2VDAHBAt80IbdXDcesNoCvs3E5AFyNSU5nbrDPZpcUEQQTFZiEVx+51fxMhhyJEAgvlriadIJZZksRuwBYMOPBbO3hePVVqgEJhFeUuFLhIPkRP6BQLIBrmMenujm/3g4zc398awIe90Zb5A1vREALqneMcYgP/xVQWlG+Ncu5vgwwlaUNx+3799rfe96u9K0JSDXcOzOTJg4B6IgmXfsygc7/Bvg9g9E58/cDVmGIBOP/zT8Bz1zqWqpbXIsd0O9hajXfL6u4BaOS6SeWAAAAAElFTkSuQmCC\\\" alt=\\\"doco\\\" style=\\\"background-color: inherit\\\"/></a></span></th></tr><tr style=\\\"border: 0px #F0F0F0 solid; padding:0px; vertical-align: top; background-color: white\\\"><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px; white-space: nowrap; background-image: url(tbl_bck1.png)\\\" class=\\\"hierarchy\\\"><img src=\\\"tbl_spacer.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"icon_resource.png\\\" alt=\\\".\\\" style=\\\"background-color: white; background-color: inherit\\\" title=\\\"Resource\\\" class=\\\"hierarchy\\\"/> <a href=\\\"StructureDefinition-us-core-smokingstatus-definitions.html#Observation\\\">Observation</a><a name=\\\"Observation\\\"> </a></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><a style=\\\"padding-left: 3px; padding-right: 3px; border: 1px maroon solid; font-weight: bold; color: #301212; background-color: #fdf4f4;\\\" href=\\\"http://hl7.org/fhir/R4/conformance-rules.html#constraints\\\" title=\\\"This element has or is affected by constraints (us-core-24, us-core-25)\\\">C</a></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"opacity: 0.5\\\">0</span><span style=\\\"opacity: 0.5\\\">..</span><span style=\\\"opacity: 0.5\\\">*</span></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><a href=\\\"http://hl7.org/fhir/R4/observation.html\\\">Observation</a></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"opacity: 0.5\\\">Measurements and simple assertions</span><br/><span style=\\\"font-weight:bold\\\">us-core-24: </span>Observation.code 72166-2|Tobacco smoking status or 11367-0|History of Tobacco use SHALL use valueCodeableConcept<br/><span style=\\\"font-weight:bold\\\">us-core-25: </span>For Observation.code 401201003|Cigarette pack-years or 782516008|Number of calculated smoking pack years SHOULD use valueQuantity</td></tr>\\r\\n<tr style=\\\"border: 0px #F0F0F0 solid; padding:0px; vertical-align: top; background-color: #F7F7F7\\\"><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px; white-space: nowrap; background-image: url(tbl_bck10.png)\\\" class=\\\"hierarchy\\\"><img src=\\\"tbl_spacer.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vjoin.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"icon_element.gif\\\" alt=\\\".\\\" style=\\\"background-color: #F7F7F7; background-color: inherit\\\" title=\\\"Element\\\" class=\\\"hierarchy\\\"/> <a href=\\\"StructureDefinition-us-core-smokingstatus-definitions.html#Observation.status\\\">status</a><a name=\\\"Observation.status\\\"> </a></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"padding-left: 3px; padding-right: 3px; color: white; background-color: red\\\" title=\\\"This element must be supported\\\">S</span></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"opacity: 0.5\\\">1</span><span style=\\\"opacity: 0.5\\\">..</span><span style=\\\"opacity: 0.5\\\">1</span></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><a style=\\\"opacity: 0.5\\\" href=\\\"http://hl7.org/fhir/R4/datatypes.html#code\\\">code</a></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\">final | entered-in-error<br/><span style=\\\"font-weight:bold\\\">Binding: </span><a href=\\\"ValueSet-us-core-observation-smoking-status-status.html\\\" title=\\\"http://hl7.org/fhir/us/core/ValueSet/us-core-observation-smoking-status-status\\\">US Core Status for Smoking Status Observation</a> (<a href=\\\"http://hl7.org/fhir/R4/terminologies.html#required\\\" title=\\\"To be conformant, the concept in this element SHALL be from the specified value set.\\\">required</a>)</td></tr>\\r\\n<tr style=\\\"border: 0px #F0F0F0 solid; padding:0px; vertical-align: top; background-color: white\\\"><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px; white-space: nowrap; background-image: url(tbl_bck13.png)\\\" class=\\\"hierarchy\\\"><img src=\\\"tbl_spacer.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vjoin.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"icon_slice.png\\\" alt=\\\".\\\" style=\\\"background-color: white; background-color: inherit\\\" title=\\\"Slice Definition\\\" class=\\\"hierarchy\\\"/> <a style=\\\"font-style: italic\\\" href=\\\"StructureDefinition-us-core-smokingstatus-definitions.html#Observation.category\\\">Slices for category</a><a name=\\\"Observation.category\\\"> </a></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"padding-left: 3px; padding-right: 3px; color: white; background-color: red; font-style: italic\\\" title=\\\"This element must be supported\\\">S</span></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"font-style: italic\\\"/><span style=\\\"font-style: italic\\\">1</span><span style=\\\"font-style: italic\\\">..</span><span style=\\\"opacity: 0.5; font-style: italic\\\">*</span></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><a style=\\\"opacity: 0.5; font-style: italic\\\" href=\\\"http://hl7.org/fhir/R4/datatypes.html#CodeableConcept\\\">CodeableConcept</a></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"opacity: 0.5; font-style: italic\\\">Classification of  type of observation</span><br style=\\\"font-style: italic\\\"/><span style=\\\"font-weight:bold; font-style: italic\\\">Slice: </span><span style=\\\"font-style: italic\\\">Unordered, Open by pattern:$this</span></td></tr>\\r\\n<tr style=\\\"border: 0px #F0F0F0 solid; padding:0px; vertical-align: top; background-color: #F7F7F7\\\"><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px; white-space: nowrap; background-image: url(tbl_bck125.png)\\\" class=\\\"hierarchy\\\"><img src=\\\"tbl_spacer.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vline.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vjoin_end_slicer.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"icon_slice_item.png\\\" alt=\\\".\\\" style=\\\"background-color: #F7F7F7; background-color: inherit\\\" title=\\\"Slice Item\\\" class=\\\"hierarchy\\\"/> <a href=\\\"StructureDefinition-us-core-smokingstatus-definitions.html#Observation.category:SocialHistory\\\" title=\\\"Slice SocialHistory\\\">category:SocialHistory</a><a name=\\\"Observation.category\\\"> </a></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"padding-left: 3px; padding-right: 3px; color: white; background-color: red\\\" title=\\\"This element must be supported\\\">S</span></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\">1..1</td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><a style=\\\"opacity: 0.5\\\" href=\\\"http://hl7.org/fhir/R4/datatypes.html#CodeableConcept\\\">CodeableConcept</a></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"opacity: 0.5\\\">Classification of  type of observation</span><br/><span style=\\\"font-weight:bold\\\">Required Pattern: </span><span style=\\\"color: darkgreen\\\">At least the following</span></td></tr>\\r\\n<tr style=\\\"border: 0px #F0F0F0 solid; padding:0px; vertical-align: top; background-color: white\\\"><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px; white-space: nowrap; background-image: url(tbl_bck1241.png)\\\" class=\\\"hierarchy\\\"><img src=\\\"tbl_spacer.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vline.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_blank.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vjoin_end_slice.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"icon_fixed.gif\\\" alt=\\\".\\\" style=\\\"background-color: white; background-color: inherit\\\" title=\\\"Fixed Value\\\" class=\\\"hierarchy\\\"/> <a href=\\\"http://hl7.org/fhir/R4/datatypes-definitions.html#CodeableConcept.coding\\\">coding</a></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"/><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\">1..*</td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><a href=\\\"http://hl7.org/fhir/R4/datatypes.html#Coding\\\">Coding</a></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\">Code defined by a terminology system<br/><span style=\\\"font-weight: bold\\\">Fixed Value: </span><span style=\\\"color: darkgreen\\\">(complex)</span></td></tr>\\r\\n<tr style=\\\"border: 0px #F0F0F0 solid; padding:0px; vertical-align: top; background-color: #F7F7F7\\\"><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px; white-space: nowrap; background-image: url(tbl_bck12410.png)\\\" class=\\\"hierarchy\\\"><img src=\\\"tbl_spacer.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vline.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_blank.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_blank.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vjoin.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"icon_fixed.gif\\\" alt=\\\".\\\" style=\\\"background-color: #F7F7F7; background-color: inherit\\\" title=\\\"Fixed Value\\\" class=\\\"hierarchy\\\"/> <a href=\\\"http://hl7.org/fhir/R4/datatypes-definitions.html#Coding.system\\\">system</a></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"/><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\">1..1</td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><a href=\\\"http://hl7.org/fhir/R4/datatypes.html#uri\\\">uri</a></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\">Identity of the terminology system<br/><span style=\\\"font-weight: bold\\\">Fixed Value: </span><span style=\\\"color: darkgreen\\\">http://terminology.hl7.org/CodeSystem/observation-category</span></td></tr>\\r\\n<tr style=\\\"border: 0px #F0F0F0 solid; padding:0px; vertical-align: top; background-color: white\\\"><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px; white-space: nowrap; background-image: url(tbl_bck12400.png)\\\" class=\\\"hierarchy\\\"><img src=\\\"tbl_spacer.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vline.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_blank.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_blank.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vjoin_end.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"icon_fixed.gif\\\" alt=\\\".\\\" style=\\\"background-color: white; background-color: inherit\\\" title=\\\"Fixed Value\\\" class=\\\"hierarchy\\\"/> <a href=\\\"http://hl7.org/fhir/R4/datatypes-definitions.html#Coding.code\\\">code</a></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"/><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\">1..1</td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><a href=\\\"http://hl7.org/fhir/R4/datatypes.html#code\\\">code</a></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\">Symbol in syntax defined by the system<br/><span style=\\\"font-weight: bold\\\">Fixed Value: </span><span style=\\\"color: darkgreen\\\">social-history</span></td></tr>\\r\\n<tr style=\\\"border: 0px #F0F0F0 solid; padding:0px; vertical-align: top; background-color: #F7F7F7\\\"><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px; white-space: nowrap; background-image: url(tbl_bck10.png)\\\" class=\\\"hierarchy\\\"><img src=\\\"tbl_spacer.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vjoin.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"icon_element.gif\\\" alt=\\\".\\\" style=\\\"background-color: #F7F7F7; background-color: inherit\\\" title=\\\"Element\\\" class=\\\"hierarchy\\\"/> <a href=\\\"StructureDefinition-us-core-smokingstatus-definitions.html#Observation.code\\\">code</a><a name=\\\"Observation.code\\\"> </a></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"padding-left: 3px; padding-right: 3px; color: white; background-color: red\\\" title=\\\"This element must be supported\\\">S</span><a style=\\\"padding-left: 3px; padding-right: 3px; border: 1px maroon solid; font-weight: bold; color: #301212; background-color: #fdf4f4;\\\" href=\\\"http://hl7.org/fhir/R4/conformance-rules.html#constraints\\\" title=\\\"This element has or is affected by constraints (us-core-24, us-core-25)\\\">C</a></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"opacity: 0.5\\\">1</span><span style=\\\"opacity: 0.5\\\">..</span><span style=\\\"opacity: 0.5\\\">1</span></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><a style=\\\"opacity: 0.5\\\" href=\\\"http://hl7.org/fhir/R4/datatypes.html#CodeableConcept\\\">CodeableConcept</a></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\">Smoking Status<br/><span style=\\\"font-weight:bold\\\">Binding: </span><a href=\\\"https://vsac.nlm.nih.gov/valueset/2.16.840.1.113762.1.4.1267.6/expansion\\\" title=\\\"http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1267.6\\\">Smoking Status Type <img src=\\\"external.png\\\" alt=\\\".\\\"/></a> (<a href=\\\"http://hl7.org/fhir/R4/terminologies.html#extensible\\\" title=\\\"To be conformant, the concept in this element SHALL be from the specified value set if any of the codes within the value set can apply to the concept being communicated.  If the value set does not cover the concept (based on human review), alternate codings (or, data type allowing, text) may be included instead.\\\">extensible</a>): Smoking status type<br/><br/></td></tr>\\r\\n<tr style=\\\"border: 0px #F0F0F0 solid; padding:0px; vertical-align: top; background-color: white\\\"><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px; white-space: nowrap; background-image: url(tbl_bck10.png)\\\" class=\\\"hierarchy\\\"><img src=\\\"tbl_spacer.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vjoin.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"icon_reference.png\\\" alt=\\\".\\\" style=\\\"background-color: white; background-color: inherit\\\" title=\\\"Reference to another Resource\\\" class=\\\"hierarchy\\\"/> <a href=\\\"StructureDefinition-us-core-smokingstatus-definitions.html#Observation.subject\\\">subject</a><a name=\\\"Observation.subject\\\"> </a></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"padding-left: 3px; padding-right: 3px; color: white; background-color: red\\\" title=\\\"This element must be supported\\\">S</span></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\">1..<span style=\\\"opacity: 0.5\\\">1</span></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><a href=\\\"http://hl7.org/fhir/R4/references.html\\\">Reference</a>(<a href=\\\"StructureDefinition-us-core-patient.html\\\">US Core Patient Profile</a>)</td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"opacity: 0.5\\\">Who and/or what the observation is about</span></td></tr>\\r\\n<tr style=\\\"border: 0px #F0F0F0 solid; padding:0px; vertical-align: top; background-color: #F7F7F7\\\"><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px; white-space: nowrap; background-image: url(tbl_bck11.png)\\\" class=\\\"hierarchy\\\"><img src=\\\"tbl_spacer.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vjoin.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"icon_choice.gif\\\" alt=\\\".\\\" style=\\\"background-color: #F7F7F7; background-color: inherit\\\" title=\\\"Choice of Types\\\" class=\\\"hierarchy\\\"/> <a href=\\\"StructureDefinition-us-core-smokingstatus-definitions.html#Observation.effective[x]\\\">effective[x]</a><a name=\\\"Observation.effective_x_\\\"> </a></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"padding-left: 3px; padding-right: 3px; color: white; background-color: red\\\" title=\\\"This element must be supported\\\">S</span></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\">1..<span style=\\\"opacity: 0.5\\\">1</span></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"/><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"opacity: 0.5\\\">Clinically relevant time/time-period for observation</span></td></tr>\\r\\n<tr style=\\\"border: 0px #F0F0F0 solid; padding:0px; vertical-align: top; background-color: white\\\"><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px; white-space: nowrap; background-image: url(tbl_bck110.png)\\\" class=\\\"hierarchy\\\"><img src=\\\"tbl_spacer.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vline.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vjoin.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"icon_primitive.png\\\" alt=\\\".\\\" style=\\\"background-color: white; background-color: inherit\\\" title=\\\"Primitive Data Type\\\" class=\\\"hierarchy\\\"/> <span title=\\\"Base StructureDefinition for dateTime Type: A date, date-time or partial date (e.g. just year or year + month).  If hours and minutes are specified, a time zone SHALL be populated. The format is a union of the schema types gYear, gYearMonth, date and dateTime. Seconds must be provided due to schema type constraints but may be zero-filled and may be ignored.                 Dates SHALL be valid dates.\\\">effectiveDateTime</span></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"/><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><a href=\\\"http://hl7.org/fhir/R4/datatypes.html#dateTime\\\">dateTime</a></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"/></tr>\\r\\n<tr style=\\\"border: 0px #F0F0F0 solid; padding:0px; vertical-align: top; background-color: #F7F7F7\\\"><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px; white-space: nowrap; background-image: url(tbl_bck100.png)\\\" class=\\\"hierarchy\\\"><img src=\\\"tbl_spacer.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vline.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vjoin_end.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"icon_datatype.gif\\\" alt=\\\".\\\" style=\\\"background-color: #F7F7F7; background-color: inherit\\\" title=\\\"Data Type\\\" class=\\\"hierarchy\\\"/> <span title=\\\"Base StructureDefinition for Period Type: A time period defined by a start and end date and optionally time.\\\">effectivePeriod</span></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"/><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><a href=\\\"http://hl7.org/fhir/R4/datatypes.html#Period\\\">Period</a></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"/></tr>\\r\\n<tr style=\\\"border: 0px #F0F0F0 solid; padding:0px; vertical-align: top; background-color: white\\\"><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px; white-space: nowrap; background-image: url(tbl_bck03.png)\\\" class=\\\"hierarchy\\\"><img src=\\\"tbl_spacer.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vjoin_end.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"icon_slice.png\\\" alt=\\\".\\\" style=\\\"background-color: white; background-color: inherit\\\" title=\\\"Slice Definition\\\" class=\\\"hierarchy\\\"/> <a style=\\\"font-style: italic\\\" href=\\\"StructureDefinition-us-core-smokingstatus-definitions.html#Observation.value[x]\\\">Slices for value[x]</a><a name=\\\"Observation.value_x_\\\"> </a></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"padding-left: 3px; padding-right: 3px; color: white; background-color: red; font-style: italic\\\" title=\\\"This element must be supported\\\">S</span><a style=\\\"padding-left: 3px; padding-right: 3px; border: 1px maroon solid; font-weight: bold; color: #301212; background-color: #fdf4f4;; font-style: italic\\\" href=\\\"http://hl7.org/fhir/R4/conformance-rules.html#constraints\\\" title=\\\"This element has or is affected by constraints (us-core-24, us-core-25)\\\">C</a></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"font-style: italic\\\"/><span style=\\\"font-style: italic\\\">1</span><span style=\\\"font-style: italic\\\">..</span><span style=\\\"opacity: 0.5; font-style: italic\\\">1</span></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><a style=\\\"opacity: 0.5; font-style: italic\\\" href=\\\"http://hl7.org/fhir/R4/datatypes.html#Quantity\\\">Quantity</a><span style=\\\"opacity: 0.5; font-style: italic\\\">, </span><a style=\\\"opacity: 0.5; font-style: italic\\\" href=\\\"http://hl7.org/fhir/R4/datatypes.html#CodeableConcept\\\">CodeableConcept</a><span style=\\\"opacity: 0.5; font-style: italic\\\">, </span><a style=\\\"opacity: 0.5; font-style: italic\\\" href=\\\"http://hl7.org/fhir/R4/datatypes.html#string\\\">string</a><span style=\\\"opacity: 0.5; font-style: italic\\\">, </span><a style=\\\"opacity: 0.5; font-style: italic\\\" href=\\\"http://hl7.org/fhir/R4/datatypes.html#boolean\\\">boolean</a><span style=\\\"opacity: 0.5; font-style: italic\\\">, </span><a style=\\\"opacity: 0.5; font-style: italic\\\" href=\\\"http://hl7.org/fhir/R4/datatypes.html#integer\\\">integer</a><span style=\\\"opacity: 0.5; font-style: italic\\\">, </span><a style=\\\"opacity: 0.5; font-style: italic\\\" href=\\\"http://hl7.org/fhir/R4/datatypes.html#Range\\\">Range</a><span style=\\\"opacity: 0.5; font-style: italic\\\">, </span><a style=\\\"opacity: 0.5; font-style: italic\\\" href=\\\"http://hl7.org/fhir/R4/datatypes.html#Ratio\\\">Ratio</a><span style=\\\"opacity: 0.5; font-style: italic\\\">, </span><a style=\\\"opacity: 0.5; font-style: italic\\\" href=\\\"http://hl7.org/fhir/R4/datatypes.html#SampledData\\\">SampledData</a><span style=\\\"opacity: 0.5; font-style: italic\\\">, </span><a style=\\\"opacity: 0.5; font-style: italic\\\" href=\\\"http://hl7.org/fhir/R4/datatypes.html#time\\\">time</a><span style=\\\"opacity: 0.5; font-style: italic\\\">, </span><a style=\\\"opacity: 0.5; font-style: italic\\\" href=\\\"http://hl7.org/fhir/R4/datatypes.html#dateTime\\\">dateTime</a><span style=\\\"opacity: 0.5; font-style: italic\\\">, </span><a style=\\\"opacity: 0.5; font-style: italic\\\" href=\\\"http://hl7.org/fhir/R4/datatypes.html#Period\\\">Period</a></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"opacity: 0.5; font-style: italic\\\">Actual result</span><br style=\\\"font-style: italic\\\"/><span style=\\\"font-weight:bold; font-style: italic\\\">Slice: </span><span style=\\\"font-style: italic\\\">Unordered, Open by type:$this</span></td></tr>\\r\\n<tr style=\\\"border: 0px #F0F0F0 solid; padding:0px; vertical-align: top; background-color: #F7F7F7\\\"><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px; white-space: nowrap; background-image: url(tbl_bck034.png)\\\" class=\\\"hierarchy\\\"><img src=\\\"tbl_spacer.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_blank.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vjoin_slicer.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"icon_slice_item.png\\\" alt=\\\".\\\" style=\\\"background-color: #F7F7F7; background-color: inherit\\\" title=\\\"Slice Item\\\" class=\\\"hierarchy\\\"/> <a href=\\\"StructureDefinition-us-core-smokingstatus-definitions.html#Observation.value[x]:valueQuantity\\\" title=\\\"Slice valueQuantity\\\">value[x]:valueQuantity</a><a name=\\\"Observation.value_x_\\\"> </a></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"padding-left: 3px; padding-right: 3px; color: white; background-color: red\\\" title=\\\"This element must be supported\\\">S</span></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\">0..1</td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><a href=\\\"http://hl7.org/fhir/R4/datatypes.html#Quantity\\\">Quantity</a></td><td style=\\\"vertical-align: top; text-align : left; background-color: #F7F7F7; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\">Quantitative Response<br/><span style=\\\"font-weight:bold\\\">Binding: </span><a href=\\\"http://terminology.hl7.org/5.5.0/ValueSet-v3-UnitsOfMeasureCaseSensitive.html\\\" title=\\\"http://terminology.hl7.org/ValueSet/v3-UnitsOfMeasureCaseSensitive\\\">UnitsOfMeasureCaseSensitive</a> (<a href=\\\"http://hl7.org/fhir/R4/terminologies.html#required\\\" title=\\\"To be conformant, the concept in this element SHALL be from the specified value set.\\\">required</a>)</td></tr>\\r\\n<tr style=\\\"border: 0px #F0F0F0 solid; padding:0px; vertical-align: top; background-color: white\\\"><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px; white-space: nowrap; background-image: url(tbl_bck024.png)\\\" class=\\\"hierarchy\\\"><img src=\\\"tbl_spacer.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_blank.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"tbl_vjoin_end_slicer.png\\\" alt=\\\".\\\" style=\\\"background-color: inherit\\\" class=\\\"hierarchy\\\"/><img src=\\\"icon_slice_item.png\\\" alt=\\\".\\\" style=\\\"background-color: white; background-color: inherit\\\" title=\\\"Slice Item\\\" class=\\\"hierarchy\\\"/> <a href=\\\"StructureDefinition-us-core-smokingstatus-definitions.html#Observation.value[x]:valueCodeableConcept\\\" title=\\\"Slice valueCodeableConcept\\\">value[x]:valueCodeableConcept</a><a name=\\\"Observation.value_x_\\\"> </a></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><span style=\\\"padding-left: 3px; padding-right: 3px; color: white; background-color: red\\\" title=\\\"This element must be supported\\\">S</span></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\">0..1</td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\"><a href=\\\"http://hl7.org/fhir/R4/datatypes.html#CodeableConcept\\\">CodeableConcept</a></td><td style=\\\"vertical-align: top; text-align : left; background-color: white; border: 0px #F0F0F0 solid; padding:0px 4px 0px 4px\\\" class=\\\"hierarchy\\\">Coded Response<br/><span style=\\\"font-weight:bold\\\">Binding: </span><a href=\\\"https://vsac.nlm.nih.gov/valueset/2.16.840.1.113762.1.4.1267.3/expansion\\\" title=\\\"http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1267.3\\\">Smoking status comprehensive <img src=\\\"external.png\\\" alt=\\\".\\\"/></a> (<a href=\\\"http://hl7.org/fhir/R4/terminologies.html#extensible\\\" title=\\\"To be conformant, the concept in this element SHALL be from the specified value set if any of the codes within the value set can apply to the concept being communicated.  If the value set does not cover the concept (based on human review), alternate codings (or, data type allowing, text) may be included instead.\\\">extensible</a>): Smoking status comprehensive<br/><br/></td></tr>\\r\\n<tr><td colspan=\\\"5\\\" class=\\\"hierarchy\\\"><br/><a href=\\\"https://build.fhir.org/ig/FHIR/ig-guidance/readingIgs.html#table-views\\\" title=\\\"Legend for this format\\\"><img src=\\\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3goXBCwdPqAP0wAAAldJREFUOMuNk0tIlFEYhp9z/vE2jHkhxXA0zJCMitrUQlq4lnSltEqCFhFG2MJFhIvIFpkEWaTQqjaWZRkp0g26URZkTpbaaOJkDqk10szoODP//7XIMUe0elcfnPd9zsfLOYplGrpRwZaqTtw3K7PtGem7Q6FoidbGgqHVy/HRb669R+56zx7eRV1L31JGxYbBtjKK93cxeqfyQHbehkZbUkK20goELEuIzEd+dHS+qz/Y8PTSif0FnGkbiwcAjHaU1+QWOptFiyCLp/LnKptpqIuXHx6rbR26kJcBX3yLgBfnd7CxwJmflpP2wUg0HIAoUUpZBmKzELGWcN8nAr6Gpu7tLU/CkwAaoKTWRSQyt89Q8w6J+oVQkKnBoblH7V0PPvUOvDYXfopE/SJmALsxnVm6LbkotrUtNowMeIrVrBcBpaMmdS0j9df7abpSuy7HWehwJdt1lhVwi/J58U5beXGAF6c3UXLycw1wdFklArBn87xdh0ZsZtArghBdAA3+OEDVubG4UEzP6x1FOWneHh2VDAHBAt80IbdXDcesNoCvs3E5AFyNSU5nbrDPZpcUEQQTFZiEVx+51fxMhhyJEAgvlriadIJZZksRuwBYMOPBbO3hePVVqgEJhFeUuFLhIPkRP6BQLIBrmMenujm/3g4zc398awIe90Zb5A1vREALqneMcYgP/xVQWlG+Ncu5vgwwlaUNx+3799rfe96u9K0JSDXcOzOTJg4B6IgmXfsygc7/Bvg9g9E58/cDVmGIBOP/zT8Bz1zqWqpbXIsd0O9hajXfL6u4BaOS6SeWAAAAAElFTkSuQmCC\\\" alt=\\\"doco\\\" style=\\\"background-color: inherit\\\"/> Documentation for this format</a></td></tr></table></div>\"\n+  },\n+  \"extension\" : [{\n+    \"url\" : \"http://hl7.org/fhir/StructureDefinition/structuredefinition-wg\",\n+    \"valueCode\" : \"cgp\"\n+  },\n+  {\n+    \"url\" : \"http://hl7.org/fhir/StructureDefinition/structuredefinition-fmm\",\n+    \"valueInteger\" : 3,\n+    \"_valueInteger\" : {\n+      \"extension\" : [{\n+        \"url\" : \"http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom\",\n+        \"valueCanonical\" : \"http://hl7.org/fhir/us/core/ImplementationGuide/hl7.fhir.us.core\"\n+      }]\n+    }\n+  },\n+  {\n+    \"url\" : \"http://hl7.org/fhir/StructureDefinition/structuredefinition-standards-status\",\n+    \"valueCode\" : \"trial-use\",\n+    \"_valueCode\" : {\n+      \"extension\" : [{\n+        \"url\" : \"http://hl7.org/fhir/StructureDefinition/structuredefinition-conformance-derivedFrom\",\n+        \"valueCanonical\" : \"http://hl7.org/fhir/us/core/ImplementationGuide/hl7.fhir.us.core\"\n+      }]\n+    }\n+  }],\n+  \"url\" : \"http://hl7.org/fhir/us/core/StructureDefinition/us-core-smokingstatus\",\n+  \"identifier\" : [{\n+    \"system\" : \"urn:ietf:rfc:3986\",\n+    \"value\" : \"urn:oid:2.16.840.1.113883.4.642.40.2.42.55\"\n+  }],\n+  \"version\" : \"7.0.0\",\n+  \"name\" : \"USCoreSmokingStatusProfile\",\n+  \"title\" : \"US Core Smoking Status Observation Profile\",\n+  \"status\" : \"active\",\n+  \"experimental\" : false,\n+  \"date\" : \"2024-03-22\",\n+  \"publisher\" : \"HL7 International / Cross-Group Projects\",\n+  \"contact\" : [{\n+    \"name\" : \"HL7 International / Cross-Group Projects\",\n+    \"telecom\" : [{\n+      \"system\" : \"url\",\n+      \"value\" : \"http://www.hl7.org/Special/committees/cgp\"\n+    },\n+    {\n+      \"system\" : \"email\",\n+      \"value\" : \"cgp@lists.HL7.org\"\n+    }]\n+  }],\n+  \"description\" : \"The US Core Smoking Status Observation Profile inherits from the FHIR [Observation](https://hl7.org/fhir/R4/observation.html) resource; refer to it for scope and usage definitions. This profile meets the requirements of the U.S. Core Data for Interoperability (USCDI)  *Smoking Status* Data Element. This profile sets minimum expectations for the Observation resource to record, search, and fetch smoking status data associated with a patient. It specifies which core elements, extensions,  vocabularies, and value sets **SHALL** be present in the resource and constrains how the elements are used. Providing the floor for standards development for specific use cases promotes interoperability and adoption.\",\n+  \"jurisdiction\" : [{\n+    \"coding\" : [{\n+      \"system\" : \"urn:iso:std:iso:3166\",\n+      \"code\" : \"US\"\n+    }]\n+  }],\n+  \"copyright\" : \"Used by permission of HL7 International, all rights reserved Creative Commons License\",\n+  \"fhirVersion\" : \"4.0.1\",\n+  \"mapping\" : [{\n+    \"identity\" : \"workflow\",\n+    \"uri\" : \"http://hl7.org/fhir/workflow\",\n+    \"name\" : \"Workflow Pattern\"\n+  },\n+  {\n+    \"identity\" : \"sct-concept\",\n+    \"uri\" : \"http://snomed.info/conceptdomain\",\n+    \"name\" : \"SNOMED CT Concept Domain Binding\"\n+  },\n+  {\n+    \"identity\" : \"v2\",\n+    \"uri\" : \"http://hl7.org/v2\",\n+    \"name\" : \"HL7 v2 Mapping\"\n+  },\n+  {\n+    \"identity\" : \"rim\",\n+    \"uri\" : \"http://hl7.org/v3\",\n+    \"name\" : \"RIM Mapping\"\n+  },\n+  {\n+    \"identity\" : \"w5\",\n+    \"uri\" : \"http://hl7.org/fhir/fivews\",\n+    \"name\" : \"FiveWs Pattern Mapping\"\n+  },\n+  {\n+    \"identity\" : \"sct-attr\",\n+    \"uri\" : \"http://snomed.org/attributebinding\",\n+    \"name\" : \"SNOMED CT Attribute Binding\"\n+  }],\n+  \"kind\" : \"resource\",\n+  \"abstract\" : false,\n+  \"type\" : \"Observation\",\n+  \"baseDefinition\" : \"http://hl7.org/fhir/StructureDefinition/Observation\",\n+  \"derivation\" : \"constraint\",\n+  \"snapshot\" : {\n+    \"element\" : [{\n+      \"id\" : \"Observation\",\n+      \"path\" : \"Observation\",\n+      \"short\" : \"Measurements and simple assertions\",\n+      \"definition\" : \"Measurements and simple assertions made about a patient, device or other subject.\",\n+      \"comment\" : \"Used for simple observations such as device measurements, laboratory atomic results, vital signs, height, weight, smoking status, comments, etc.  Other resources are used to provide context for observations such as laboratory reports, etc.\",\n+      \"alias\" : [\"Vital Signs\",\n+      \"Measurement\",\n+      \"Results\",\n+      \"Tests\",\n+      \"Obs\"],\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"Observation\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"constraint\" : [{\n+        \"key\" : \"dom-2\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"If the resource is contained in another resource, it SHALL NOT contain nested Resources\",\n+        \"expression\" : \"contained.contained.empty()\",\n+        \"xpath\" : \"not(parent::f:contained and f:contained)\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/DomainResource\"\n+      },\n+      {\n+        \"key\" : \"dom-3\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"If the resource is contained in another resource, it SHALL be referred to from elsewhere in the resource or SHALL refer to the containing resource\",\n+        \"expression\" : \"contained.where((('#'+id in (%resource.descendants().reference | %resource.descendants().as(canonical) | %resource.descendants().as(uri) | %resource.descendants().as(url))) or descendants().where(reference = '#').exists() or descendants().where(as(canonical) = '#').exists() or descendants().where(as(canonical) = '#').exists()).not()).trace('unmatched', id).empty()\",\n+        \"xpath\" : \"not(exists(for $id in f:contained/*/f:id/@value return $contained[not(parent::*/descendant::f:reference/@value=concat('#', $contained/*/id/@value) or descendant::f:reference[@value='#'])]))\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/DomainResource\"\n+      },\n+      {\n+        \"key\" : \"dom-4\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"If a resource is contained in another resource, it SHALL NOT have a meta.versionId or a meta.lastUpdated\",\n+        \"expression\" : \"contained.meta.versionId.empty() and contained.meta.lastUpdated.empty()\",\n+        \"xpath\" : \"not(exists(f:contained/*/f:meta/f:versionId)) and not(exists(f:contained/*/f:meta/f:lastUpdated))\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/DomainResource\"\n+      },\n+      {\n+        \"key\" : \"dom-5\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"If a resource is contained in another resource, it SHALL NOT have a security label\",\n+        \"expression\" : \"contained.meta.security.empty()\",\n+        \"xpath\" : \"not(exists(f:contained/*/f:meta/f:security))\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/DomainResource\"\n+      },\n+      {\n+        \"extension\" : [{\n+          \"url\" : \"http://hl7.org/fhir/StructureDefinition/elementdefinition-bestpractice\",\n+          \"valueBoolean\" : true\n+        },\n+        {\n+          \"url\" : \"http://hl7.org/fhir/StructureDefinition/elementdefinition-bestpractice-explanation\",\n+          \"valueMarkdown\" : \"When a resource has no narrative, only systems that fully understand the data can display the resource to a human safely. Including a human readable representation in the resource makes for a much more robust eco-system and cheaper handling of resources by intermediary systems. Some ecosystems restrict distribution of resources to only those systems that do fully understand the resources, and as a consequence implementers may believe that the narrative is superfluous. However experience shows that such eco-systems often open up to new participants over time.\"\n+        }],\n+        \"key\" : \"dom-6\",\n+        \"severity\" : \"warning\",\n+        \"human\" : \"A resource should have narrative for robust management\",\n+        \"expression\" : \"text.`div`.exists()\",\n+        \"xpath\" : \"exists(f:text/h:div)\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/DomainResource\"\n+      },\n+      {\n+        \"key\" : \"obs-6\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"dataAbsentReason SHALL only be present if Observation.value[x] is not present\",\n+        \"expression\" : \"dataAbsentReason.empty() or value.empty()\",\n+        \"xpath\" : \"not(exists(f:dataAbsentReason)) or (not(exists(*[starts-with(local-name(.), 'value')])))\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Observation\"\n+      },\n+      {\n+        \"key\" : \"obs-7\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"If Observation.code is the same as an Observation.component.code then the value element associated with the code SHALL NOT be present\",\n+        \"expression\" : \"value.empty() or component.code.where(coding.intersect(%resource.code.coding).exists()).empty()\",\n+        \"xpath\" : \"not(f:*[starts-with(local-name(.), 'value')] and (for $coding in f:code/f:coding return f:component/f:code/f:coding[f:code/@value=$coding/f:code/@value] [f:system/@value=$coding/f:system/@value]))\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Observation\"\n+      },\n+      {\n+        \"key\" : \"us-core-24\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"Observation.code 72166-2|Tobacco smoking status or 11367-0|History of Tobacco use SHALL use valueCodeableConcept\",\n+        \"expression\" : \"code.coding.where(code in '72166-2'|'11367-0').exists() implies value.is(CodeableConcept)\"\n+      },\n+      {\n+        \"key\" : \"us-core-25\",\n+        \"severity\" : \"warning\",\n+        \"human\" : \"For Observation.code 401201003|Cigarette pack-years or 782516008|Number of calculated smoking pack years SHOULD use valueQuantity\",\n+        \"expression\" : \"code.coding.where(code in '401201003'|'782516008').exists() implies value.is(Quantity)\"\n+      }],\n+      \"mustSupport\" : false,\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"mapping\" : [{\n+        \"identity\" : \"rim\",\n+        \"map\" : \"Entity. Role, or Act\"\n+      },\n+      {\n+        \"identity\" : \"workflow\",\n+        \"map\" : \"Event\"\n+      },\n+      {\n+        \"identity\" : \"sct-concept\",\n+        \"map\" : \"< 363787002 |Observable entity|\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"Observation[classCode=OBS, moodCode=EVN]\"\n+      },\n+      {\n+        \"identity\" : \"argonaut-dq-dstu2\",\n+        \"map\" : \"Observation\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.id\",\n+      \"path\" : \"Observation.id\",\n+      \"short\" : \"Logical id of this artifact\",\n+      \"definition\" : \"The logical id of the resource, as used in the URL for the resource. Once assigned, this value never changes.\",\n+      \"comment\" : \"The only time that a resource does not have an id is when it is being submitted to the server using a create operation.\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Resource.id\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"extension\" : [{\n+          \"url\" : \"http://hl7.org/fhir/StructureDefinition/structuredefinition-fhir-type\",\n+          \"valueUrl\" : \"id\"\n+        }],\n+        \"code\" : \"http://hl7.org/fhirpath/System.String\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : true\n+    },\n+    {\n+      \"id\" : \"Observation.meta\",\n+      \"path\" : \"Observation.meta\",\n+      \"short\" : \"Metadata about the resource\",\n+      \"definition\" : \"The metadata about the resource. This is content that is maintained by the infrastructure. Changes to the content might not always be associated with version changes to the resource.\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Resource.meta\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Meta\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : true\n+    },\n+    {\n+      \"id\" : \"Observation.implicitRules\",\n+      \"path\" : \"Observation.implicitRules\",\n+      \"short\" : \"A set of rules under which this content was created\",\n+      \"definition\" : \"A reference to a set of rules that were followed when the resource was constructed, and which must be understood when processing the content. Often, this is a reference to an implementation guide that defines the special rules along with other profiles etc.\",\n+      \"comment\" : \"Asserting this rule set restricts the content to be only understood by a limited set of trading partners. This inherently limits the usefulness of the data in the long term. However, the existing health eco-system is highly fractured, and not yet ready to define, collect, and exchange data in a generally computable sense. Wherever possible, implementers and/or specification writers should avoid using this element. Often, when used, the URL is a reference to an implementation guide that defines these special rules as part of it's narrative along with other profiles, value sets, etc.\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Resource.implicitRules\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"uri\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : true,\n+      \"isModifierReason\" : \"This element is labeled as a modifier because the implicit rules may provide additional knowledge about the resource that modifies it's meaning or interpretation\",\n+      \"isSummary\" : true\n+    },\n+    {\n+      \"id\" : \"Observation.language\",\n+      \"path\" : \"Observation.language\",\n+      \"short\" : \"Language of the resource content\",\n+      \"definition\" : \"The base language in which the resource is written.\",\n+      \"comment\" : \"Language is provided to support indexing and accessibility (typically, services such as text to speech use the language tag). The html language tag in the narrative applies  to the narrative. The language tag on the resource may be used to specify the language of other presentations generated from the data in the resource. Not all the content has to be in the base language. The Resource.language should not be assumed to apply to the narrative automatically. If a language is specified, it should it also be specified on the div element in the html (see rules in HTML5 for information about the relationship between xml:lang and the html lang attribute).\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Resource.language\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"code\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"binding\" : {\n+        \"extension\" : [{\n+          \"url\" : \"http://hl7.org/fhir/StructureDefinition/elementdefinition-maxValueSet\",\n+          \"valueCanonical\" : \"http://hl7.org/fhir/ValueSet/all-languages\"\n+        },\n+        {\n+          \"url\" : \"http://hl7.org/fhir/StructureDefinition/elementdefinition-bindingName\",\n+          \"valueString\" : \"Language\"\n+        }],\n+        \"strength\" : \"preferred\",\n+        \"description\" : \"A human language.\",\n+        \"valueSet\" : \"http://hl7.org/fhir/ValueSet/languages\"\n+      }\n+    },\n+    {\n+      \"id\" : \"Observation.text\",\n+      \"path\" : \"Observation.text\",\n+      \"short\" : \"Text summary of the resource, for human interpretation\",\n+      \"definition\" : \"A human-readable narrative that contains a summary of the resource and can be used to represent the content of the resource to a human. The narrative need not encode all the structured data, but is required to contain sufficient detail to make it \\\"clinically safe\\\" for a human to just read the narrative. Resource definitions may define what content should be represented in the narrative to ensure clinical safety.\",\n+      \"comment\" : \"Contained resources do not have narrative. Resources that are not contained SHOULD have a narrative. In some cases, a resource may only have text with little or no additional discrete data (as long as all minOccurs=1 elements are satisfied).  This may be necessary for data from legacy systems where information is captured as a \\\"text blob\\\" or where text is additionally entered raw or narrated and encoded information is added later.\",\n+      \"alias\" : [\"narrative\",\n+      \"html\",\n+      \"xhtml\",\n+      \"display\"],\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"DomainResource.text\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Narrative\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"mapping\" : [{\n+        \"identity\" : \"rim\",\n+        \"map\" : \"Act.text?\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.contained\",\n+      \"path\" : \"Observation.contained\",\n+      \"short\" : \"Contained, inline Resources\",\n+      \"definition\" : \"These resources do not have an independent existence apart from the resource that contains them - they cannot be identified independently, and nor can they have their own independent transaction scope.\",\n+      \"comment\" : \"This should never be done when the content can be identified properly, as once identification is lost, it is extremely difficult (and context dependent) to restore it again. Contained resources may have profiles and tags In their meta elements, but SHALL NOT have security labels.\",\n+      \"alias\" : [\"inline resources\",\n+      \"anonymous resources\",\n+      \"contained resources\"],\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"DomainResource.contained\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Resource\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"mapping\" : [{\n+        \"identity\" : \"rim\",\n+        \"map\" : \"N/A\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.extension\",\n+      \"path\" : \"Observation.extension\",\n+      \"short\" : \"Additional content defined by implementations\",\n+      \"definition\" : \"May be used to represent additional information that is not part of the basic definition of the resource. To make the use of extensions safe and manageable, there is a strict set of governance  applied to the definition and use of extensions. Though any implementer can define an extension, there is a set of requirements that SHALL be met as part of the definition of the extension.\",\n+      \"comment\" : \"There can be no stigma associated with the use of extensions by any application, project, or standard - regardless of the institution or jurisdiction that uses or defines the extensions.  The use of extensions is what allows the FHIR specification to retain a core level of simplicity for everyone.\",\n+      \"alias\" : [\"extensions\",\n+      \"user content\"],\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"DomainResource.extension\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Extension\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      },\n+      {\n+        \"key\" : \"ext-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"Must have either extensions or value[x], not both\",\n+        \"expression\" : \"extension.exists() != value.exists()\",\n+        \"xpath\" : \"exists(f:extension)!=exists(f:*[starts-with(local-name(.), \\\"value\\\")])\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Extension\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"mapping\" : [{\n+        \"identity\" : \"rim\",\n+        \"map\" : \"N/A\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.modifierExtension\",\n+      \"path\" : \"Observation.modifierExtension\",\n+      \"short\" : \"Extensions that cannot be ignored\",\n+      \"definition\" : \"May be used to represent additional information that is not part of the basic definition of the resource and that modifies the understanding of the element that contains it and/or the understanding of the containing element's descendants. Usually modifier elements provide negation or qualification. To make the use of extensions safe and manageable, there is a strict set of governance applied to the definition and use of extensions. Though any implementer is allowed to define an extension, there is a set of requirements that SHALL be met as part of the definition of the extension. Applications processing a resource are required to check for modifier extensions.\\n\\nModifier extensions SHALL NOT change the meaning of any elements on Resource or DomainResource (including cannot change the meaning of modifierExtension itself).\",\n+      \"comment\" : \"There can be no stigma associated with the use of extensions by any application, project, or standard - regardless of the institution or jurisdiction that uses or defines the extensions.  The use of extensions is what allows the FHIR specification to retain a core level of simplicity for everyone.\",\n+      \"requirements\" : \"Modifier extensions allow for extensions that *cannot* be safely ignored to be clearly distinguished from the vast majority of extensions which can be safely ignored.  This promotes interoperability by eliminating the need for implementers to prohibit the presence of extensions. For further information, see the [definition of modifier extensions](http://hl7.org/fhir/R4/extensibility.html#modifierExtension).\",\n+      \"alias\" : [\"extensions\",\n+      \"user content\"],\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"DomainResource.modifierExtension\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Extension\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      },\n+      {\n+        \"key\" : \"ext-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"Must have either extensions or value[x], not both\",\n+        \"expression\" : \"extension.exists() != value.exists()\",\n+        \"xpath\" : \"exists(f:extension)!=exists(f:*[starts-with(local-name(.), \\\"value\\\")])\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Extension\"\n+      }],\n+      \"isModifier\" : true,\n+      \"isModifierReason\" : \"Modifier extensions are expected to modify the meaning or interpretation of the resource that contains them\",\n+      \"isSummary\" : false,\n+      \"mapping\" : [{\n+        \"identity\" : \"rim\",\n+        \"map\" : \"N/A\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.identifier\",\n+      \"path\" : \"Observation.identifier\",\n+      \"short\" : \"Business Identifier for observation\",\n+      \"definition\" : \"A unique identifier assigned to this observation.\",\n+      \"requirements\" : \"Allows observations to be distinguished and referenced.\",\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"Observation.identifier\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Identifier\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : true,\n+      \"mapping\" : [{\n+        \"identity\" : \"workflow\",\n+        \"map\" : \"Event.identifier\"\n+      },\n+      {\n+        \"identity\" : \"w5\",\n+        \"map\" : \"FiveWs.identifier\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX.21  For OBX segments from systems without OBX-21 support a combination of ORC/OBR and OBX must be negotiated between trading partners to uniquely identify the OBX segment. Depending on how V2 has been implemented each of these may be an option: 1) OBR-3 + OBX-3 + OBX-4 or 2) OBR-3 + OBR-4 + OBX-3 + OBX-4 or 2) some other way to uniquely ID the OBR/ORC + OBX-3 + OBX-4.\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"id\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.basedOn\",\n+      \"path\" : \"Observation.basedOn\",\n+      \"short\" : \"Fulfills plan, proposal or order\",\n+      \"definition\" : \"A plan, proposal or order that is fulfilled in whole or in part by this event.  For example, a MedicationRequest may require a patient to have laboratory test performed before  it is dispensed.\",\n+      \"requirements\" : \"Allows tracing of authorization for the event and tracking whether proposals/recommendations were acted upon.\",\n+      \"alias\" : [\"Fulfills\"],\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"Observation.basedOn\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Reference\",\n+        \"targetProfile\" : [\"http://hl7.org/fhir/StructureDefinition/CarePlan\",\n+        \"http://hl7.org/fhir/StructureDefinition/DeviceRequest\",\n+        \"http://hl7.org/fhir/StructureDefinition/ImmunizationRecommendation\",\n+        \"http://hl7.org/fhir/StructureDefinition/MedicationRequest\",\n+        \"http://hl7.org/fhir/StructureDefinition/NutritionOrder\",\n+        \"http://hl7.org/fhir/StructureDefinition/ServiceRequest\"]\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : true,\n+      \"mapping\" : [{\n+        \"identity\" : \"workflow\",\n+        \"map\" : \"Event.basedOn\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"ORC\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \".inboundRelationship[typeCode=COMP].source[moodCode=EVN]\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.partOf\",\n+      \"path\" : \"Observation.partOf\",\n+      \"short\" : \"Part of referenced event\",\n+      \"definition\" : \"A larger event of which this particular Observation is a component or step.  For example,  an observation as part of a procedure.\",\n+      \"comment\" : \"To link an Observation to an Encounter use `encounter`.  See the  [Notes](http://hl7.org/fhir/R4/observation.html#obsgrouping) below for guidance on referencing another Observation.\",\n+      \"alias\" : [\"Container\"],\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"Observation.partOf\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Reference\",\n+        \"targetProfile\" : [\"http://hl7.org/fhir/StructureDefinition/MedicationAdministration\",\n+        \"http://hl7.org/fhir/StructureDefinition/MedicationDispense\",\n+        \"http://hl7.org/fhir/StructureDefinition/MedicationStatement\",\n+        \"http://hl7.org/fhir/StructureDefinition/Procedure\",\n+        \"http://hl7.org/fhir/StructureDefinition/Immunization\",\n+        \"http://hl7.org/fhir/StructureDefinition/ImagingStudy\"]\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : true,\n+      \"mapping\" : [{\n+        \"identity\" : \"workflow\",\n+        \"map\" : \"Event.partOf\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"Varies by domain\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \".outboundRelationship[typeCode=FLFS].target\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.status\",\n+      \"extension\" : [{\n+        \"url\" : \"http://hl7.org/fhir/StructureDefinition/structuredefinition-display-hint\",\n+        \"valueString\" : \"default: final\"\n+      }],\n+      \"path\" : \"Observation.status\",\n+      \"short\" : \"final | entered-in-error\",\n+      \"definition\" : \"The status of the result value.\",\n+      \"comment\" : \"This element is labeled as a modifier because the status contains codes that mark the resource as not currently valid.\",\n+      \"requirements\" : \"Need to track the status of individual results. Some results are finalized before the whole report is finalized.\",\n+      \"min\" : 1,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.status\",\n+        \"min\" : 1,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"code\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"mustSupport\" : true,\n+      \"isModifier\" : true,\n+      \"isModifierReason\" : \"This element is labeled as a modifier because it is a status element that contains status entered-in-error which means that the resource should not be treated as valid\",\n+      \"isSummary\" : true,\n+      \"binding\" : {\n+        \"strength\" : \"required\",\n+        \"valueSet\" : \"http://hl7.org/fhir/us/core/ValueSet/us-core-observation-smoking-status-status\"\n+      },\n+      \"mapping\" : [{\n+        \"identity\" : \"workflow\",\n+        \"map\" : \"Event.status\"\n+      },\n+      {\n+        \"identity\" : \"w5\",\n+        \"map\" : \"FiveWs.status\"\n+      },\n+      {\n+        \"identity\" : \"sct-concept\",\n+        \"map\" : \"< 445584004 |Report by finality status|\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX-11\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"status  Amended & Final are differentiated by whether it is the subject of a ControlAct event with a type of \\\"revise\\\"\"\n+      },\n+      {\n+        \"identity\" : \"argonaut-dq-dstu2\",\n+        \"map\" : \"Observation.status\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.category\",\n+      \"path\" : \"Observation.category\",\n+      \"slicing\" : {\n+        \"discriminator\" : [{\n+          \"type\" : \"pattern\",\n+          \"path\" : \"$this\"\n+        }],\n+        \"rules\" : \"open\"\n+      },\n+      \"short\" : \"Classification of  type of observation\",\n+      \"definition\" : \"A code that classifies the general type of observation being made.\",\n+      \"comment\" : \"In addition to the required category valueset, this element allows various categorization schemes based on the owner’s definition of the category and effectively multiple categories can be used at once.  The level of granularity is defined by the category concepts in the value set.\",\n+      \"requirements\" : \"Used for filtering what observations are retrieved and displayed.\",\n+      \"min\" : 1,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"Observation.category\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"CodeableConcept\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"mustSupport\" : true,\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"binding\" : {\n+        \"extension\" : [{\n+          \"url\" : \"http://hl7.org/fhir/StructureDefinition/elementdefinition-bindingName\",\n+          \"valueString\" : \"ObservationCategory\"\n+        }],\n+        \"strength\" : \"preferred\",\n+        \"description\" : \"Codes for high level observation categories.\",\n+        \"valueSet\" : \"http://hl7.org/fhir/ValueSet/observation-category\"\n+      },\n+      \"mapping\" : [{\n+        \"identity\" : \"w5\",\n+        \"map\" : \"FiveWs.class\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \".outboundRelationship[typeCode=\\\"COMP].target[classCode=\\\"LIST\\\", moodCode=\\\"EVN\\\"].code\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.category:SocialHistory\",\n+      \"path\" : \"Observation.category\",\n+      \"sliceName\" : \"SocialHistory\",\n+      \"short\" : \"Classification of  type of observation\",\n+      \"definition\" : \"A code that classifies the general type of observation being made.\",\n+      \"comment\" : \"In addition to the required category valueset, this element allows various categorization schemes based on the owner’s definition of the category and effectively multiple categories can be used at once.  The level of granularity is defined by the category concepts in the value set.\",\n+      \"requirements\" : \"Used for filtering what observations are retrieved and displayed.\",\n+      \"min\" : 1,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.category\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"CodeableConcept\"\n+      }],\n+      \"patternCodeableConcept\" : {\n+        \"coding\" : [{\n+          \"system\" : \"http://terminology.hl7.org/CodeSystem/observation-category\",\n+          \"code\" : \"social-history\"\n+        }]\n+      },\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"mustSupport\" : true,\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"binding\" : {\n+        \"extension\" : [{\n+          \"url\" : \"http://hl7.org/fhir/StructureDefinition/elementdefinition-bindingName\",\n+          \"valueString\" : \"ObservationCategory\"\n+        }],\n+        \"strength\" : \"preferred\",\n+        \"description\" : \"Codes for high level observation categories.\",\n+        \"valueSet\" : \"http://hl7.org/fhir/ValueSet/observation-category\"\n+      },\n+      \"mapping\" : [{\n+        \"identity\" : \"w5\",\n+        \"map\" : \"FiveWs.class\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \".outboundRelationship[typeCode=\\\"COMP].target[classCode=\\\"LIST\\\", moodCode=\\\"EVN\\\"].code\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.code\",\n+      \"path\" : \"Observation.code\",\n+      \"short\" : \"Smoking Status\",\n+      \"definition\" : \"Describes what was observed. Sometimes this is called the observation \\\"name\\\".\",\n+      \"comment\" : \"*All* code-value and, if present, component.code-component.value pairs need to be taken into account to correctly understand the meaning of the observation.\",\n+      \"requirements\" : \"Knowing what kind of observation is being made is essential to understanding the observation.\",\n+      \"alias\" : [\"Name\"],\n+      \"min\" : 1,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.code\",\n+        \"min\" : 1,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"CodeableConcept\"\n+      }],\n+      \"condition\" : [\"us-core-24\",\n+      \"us-core-25\"],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"mustSupport\" : true,\n+      \"isModifier\" : false,\n+      \"isSummary\" : true,\n+      \"binding\" : {\n+        \"strength\" : \"extensible\",\n+        \"description\" : \"Smoking status type\",\n+        \"valueSet\" : \"http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1267.6\"\n+      },\n+      \"mapping\" : [{\n+        \"identity\" : \"workflow\",\n+        \"map\" : \"Event.code\"\n+      },\n+      {\n+        \"identity\" : \"w5\",\n+        \"map\" : \"FiveWs.what[x]\"\n+      },\n+      {\n+        \"identity\" : \"sct-concept\",\n+        \"map\" : \"< 363787002 |Observable entity| OR < 386053000 |Evaluation procedure|\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX-3\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"code\"\n+      },\n+      {\n+        \"identity\" : \"sct-attr\",\n+        \"map\" : \"116680003 |Is a|\"\n+      },\n+      {\n+        \"identity\" : \"argonaut-dq-dstu2\",\n+        \"map\" : \"Observation.code\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.subject\",\n+      \"path\" : \"Observation.subject\",\n+      \"short\" : \"Who and/or what the observation is about\",\n+      \"definition\" : \"The patient, or group of patients, location, or device this observation is about and into whose record the observation is placed. If the actual focus of the observation is different from the subject (or a sample of, part, or region of the subject), the `focus` element or the `code` itself specifies the actual focus of the observation.\",\n+      \"comment\" : \"One would expect this element to be a cardinality of 1..1. The only circumstance in which the subject can be missing is when the observation is made by a device that does not know the patient. In this case, the observation SHALL be matched to a patient through some context/channel matching technique, and at this point, the observation should be updated.\",\n+      \"requirements\" : \"Observations have no value if you don't know who or what they're about.\",\n+      \"min\" : 1,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.subject\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Reference\",\n+        \"targetProfile\" : [\"http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient\"]\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"mustSupport\" : true,\n+      \"isModifier\" : false,\n+      \"isSummary\" : true,\n+      \"mapping\" : [{\n+        \"identity\" : \"workflow\",\n+        \"map\" : \"Event.subject\"\n+      },\n+      {\n+        \"identity\" : \"w5\",\n+        \"map\" : \"FiveWs.subject[x]\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"PID-3\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"participation[typeCode=RTGT]\"\n+      },\n+      {\n+        \"identity\" : \"w5\",\n+        \"map\" : \"FiveWs.subject\"\n+      },\n+      {\n+        \"identity\" : \"argonaut-dq-dstu2\",\n+        \"map\" : \"Observation.subject\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.focus\",\n+      \"path\" : \"Observation.focus\",\n+      \"short\" : \"What the observation is about, when it is not about the subject of record\",\n+      \"definition\" : \"The actual focus of an observation when it is not the patient of record representing something or someone associated with the patient such as a spouse, parent, fetus, or donor. For example, fetus observations in a mother's record.  The focus of an observation could also be an existing condition,  an intervention, the subject's diet,  another observation of the subject,  or a body structure such as tumor or implanted device.   An example use case would be using the Observation resource to capture whether the mother is trained to change her child's tracheostomy tube. In this example, the child is the patient of record and the mother is the focus.\",\n+      \"comment\" : \"Typically, an observation is made about the subject - a patient, or group of patients, location, or device - and the distinction between the subject and what is directly measured for an observation is specified in the observation code itself ( e.g., \\\"Blood Glucose\\\") and does not need to be represented separately using this element.  Use `specimen` if a reference to a specimen is required.  If a code is required instead of a resource use either  `bodysite` for bodysites or the standard extension [focusCode](http://hl7.org/fhir/R4/extension-observation-focuscode.html).\",\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"Observation.focus\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Reference\",\n+        \"targetProfile\" : [\"http://hl7.org/fhir/StructureDefinition/Resource\"]\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : true,\n+      \"mapping\" : [{\n+        \"identity\" : \"w5\",\n+        \"map\" : \"FiveWs.subject[x]\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX-3\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"participation[typeCode=SBJ]\"\n+      },\n+      {\n+        \"identity\" : \"w5\",\n+        \"map\" : \"FiveWs.subject\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.encounter\",\n+      \"path\" : \"Observation.encounter\",\n+      \"short\" : \"Healthcare event during which this observation is made\",\n+      \"definition\" : \"The healthcare event  (e.g. a patient and healthcare provider interaction) during which this observation is made.\",\n+      \"comment\" : \"This will typically be the encounter the event occurred within, but some events may be initiated prior to or after the official completion of an encounter but still be tied to the context of the encounter (e.g. pre-admission laboratory tests).\",\n+      \"requirements\" : \"For some observations it may be important to know the link between an observation and a particular encounter.\",\n+      \"alias\" : [\"Context\"],\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.encounter\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Reference\",\n+        \"targetProfile\" : [\"http://hl7.org/fhir/StructureDefinition/Encounter\"]\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : true,\n+      \"mapping\" : [{\n+        \"identity\" : \"workflow\",\n+        \"map\" : \"Event.context\"\n+      },\n+      {\n+        \"identity\" : \"w5\",\n+        \"map\" : \"FiveWs.context\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"PV1\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"inboundRelationship[typeCode=COMP].source[classCode=ENC, moodCode=EVN]\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.effective[x]\",\n+      \"path\" : \"Observation.effective[x]\",\n+      \"short\" : \"Clinically relevant time/time-period for observation\",\n+      \"definition\" : \"The time or time-period the observed value is asserted as being true. For biological subjects - e.g. human patients - this is usually called the \\\"physiologically relevant time\\\". This is usually either the time of the procedure or of specimen collection, but very often the source of the date/time is not known, only the date/time itself.\",\n+      \"comment\" : \"At least a date should be present unless this observation is a historical report.  For recording imprecise or \\\"fuzzy\\\" times (For example, a blood glucose measurement taken \\\"after breakfast\\\") use the [Timing](http://hl7.org/fhir/R4/datatypes.html#timing) datatype which allow the measurement to be tied to regular life events.\",\n+      \"requirements\" : \"Knowing when an observation was deemed true is important to its relevance as well as determining trends.\",\n+      \"alias\" : [\"Occurrence\"],\n+      \"min\" : 1,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.effective[x]\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"dateTime\"\n+      },\n+      {\n+        \"code\" : \"Period\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"mustSupport\" : true,\n+      \"isModifier\" : false,\n+      \"isSummary\" : true,\n+      \"mapping\" : [{\n+        \"identity\" : \"workflow\",\n+        \"map\" : \"Event.occurrence[x]\"\n+      },\n+      {\n+        \"identity\" : \"w5\",\n+        \"map\" : \"FiveWs.done[x]\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX-14, and/or OBX-19 after v2.4  (depends on who observation made)\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"effectiveTime\"\n+      },\n+      {\n+        \"identity\" : \"argonaut-dq-dstu2\",\n+        \"map\" : \"Observation.issued\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.issued\",\n+      \"path\" : \"Observation.issued\",\n+      \"short\" : \"Date/Time this version was made available\",\n+      \"definition\" : \"The date and time this version of the observation was made available to providers, typically after the results have been reviewed and verified.\",\n+      \"comment\" : \"For Observations that don’t require review and verification, it may be the same as the [`lastUpdated` ](http://hl7.org/fhir/R4/resource-definitions.html#Meta.lastUpdated) time of the resource itself.  For Observations that do require review and verification for certain updates, it might not be the same as the `lastUpdated` time of the resource itself due to a non-clinically significant update that doesn’t require the new version to be reviewed and verified again.\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.issued\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"instant\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : true,\n+      \"mapping\" : [{\n+        \"identity\" : \"w5\",\n+        \"map\" : \"FiveWs.recorded\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBR.22 (or MSH.7), or perhaps OBX-19 (depends on who observation made)\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"participation[typeCode=AUT].time\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.performer\",\n+      \"path\" : \"Observation.performer\",\n+      \"short\" : \"Who is responsible for the observation\",\n+      \"definition\" : \"Who was responsible for asserting the observed value as \\\"true\\\".\",\n+      \"requirements\" : \"May give a degree of confidence in the observation and also indicates where follow-up questions should be directed.\",\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"Observation.performer\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Reference\",\n+        \"targetProfile\" : [\"http://hl7.org/fhir/StructureDefinition/Practitioner\",\n+        \"http://hl7.org/fhir/StructureDefinition/PractitionerRole\",\n+        \"http://hl7.org/fhir/StructureDefinition/Organization\",\n+        \"http://hl7.org/fhir/StructureDefinition/CareTeam\",\n+        \"http://hl7.org/fhir/StructureDefinition/Patient\",\n+        \"http://hl7.org/fhir/StructureDefinition/RelatedPerson\"]\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : true,\n+      \"mapping\" : [{\n+        \"identity\" : \"workflow\",\n+        \"map\" : \"Event.performer.actor\"\n+      },\n+      {\n+        \"identity\" : \"w5\",\n+        \"map\" : \"FiveWs.actor\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX.15 / (Practitioner)  OBX-16,  PRT-5:PRT-4='RO' /  (Device)  OBX-18 , PRT-10:PRT-4='EQUIP' / (Organization)  OBX-23,  PRT-8:PRT-4='PO'\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"participation[typeCode=PRF]\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.value[x]\",\n+      \"path\" : \"Observation.value[x]\",\n+      \"slicing\" : {\n+        \"discriminator\" : [{\n+          \"type\" : \"type\",\n+          \"path\" : \"$this\"\n+        }],\n+        \"ordered\" : false,\n+        \"rules\" : \"open\"\n+      },\n+      \"short\" : \"Actual result\",\n+      \"definition\" : \"The information determined as a result of making the observation, if the information has a simple value.\",\n+      \"comment\" : \"An observation may have; 1)  a single value here, 2)  both a value and a set of related or component values,  or 3)  only a set of related or component values. If a value is present, the datatype for this element should be determined by Observation.code.  A CodeableConcept with just a text would be used instead of a string if the field was usually coded, or if the type associated with the Observation.code defines a coded value.  For additional guidance, see the [Notes section](http://hl7.org/fhir/R4/observation.html#notes) below.\",\n+      \"requirements\" : \"An observation exists to have a value, though it might not if it is in error, or if it represents a group of observations.\",\n+      \"min\" : 1,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.value[x]\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Quantity\"\n+      },\n+      {\n+        \"code\" : \"CodeableConcept\"\n+      },\n+      {\n+        \"code\" : \"string\"\n+      },\n+      {\n+        \"code\" : \"boolean\"\n+      },\n+      {\n+        \"code\" : \"integer\"\n+      },\n+      {\n+        \"code\" : \"Range\"\n+      },\n+      {\n+        \"code\" : \"Ratio\"\n+      },\n+      {\n+        \"code\" : \"SampledData\"\n+      },\n+      {\n+        \"code\" : \"time\"\n+      },\n+      {\n+        \"code\" : \"dateTime\"\n+      },\n+      {\n+        \"code\" : \"Period\"\n+      }],\n+      \"condition\" : [\"obs-7\",\n+      \"us-core-24\",\n+      \"us-core-25\"],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"mustSupport\" : true,\n+      \"isModifier\" : false,\n+      \"isSummary\" : true,\n+      \"mapping\" : [{\n+        \"identity\" : \"sct-concept\",\n+        \"map\" : \"< 441742003 |Evaluation finding|\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX.2, OBX.5, OBX.6\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"value\"\n+      },\n+      {\n+        \"identity\" : \"sct-attr\",\n+        \"map\" : \"363714003 |Interprets|\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.value[x]:valueQuantity\",\n+      \"path\" : \"Observation.value[x]\",\n+      \"sliceName\" : \"valueQuantity\",\n+      \"short\" : \"Quantitative Response\",\n+      \"definition\" : \"The information determined as a result of making the observation, if the information has a simple value.\",\n+      \"comment\" : \"An observation may have; 1)  a single value here, 2)  both a value and a set of related or component values,  or 3)  only a set of related or component values. If a value is present, the datatype for this element should be determined by Observation.code.  A CodeableConcept with just a text would be used instead of a string if the field was usually coded, or if the type associated with the Observation.code defines a coded value.  For additional guidance, see the [Notes section](http://hl7.org/fhir/R4/observation.html#notes) below.\",\n+      \"requirements\" : \"An observation exists to have a value, though it might not if it is in error, or if it represents a group of observations.\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.value[x]\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Quantity\"\n+      }],\n+      \"condition\" : [\"obs-7\"],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"mustSupport\" : true,\n+      \"isModifier\" : false,\n+      \"isSummary\" : true,\n+      \"binding\" : {\n+        \"strength\" : \"required\",\n+        \"valueSet\" : \"http://terminology.hl7.org/ValueSet/v3-UnitsOfMeasureCaseSensitive\"\n+      },\n+      \"mapping\" : [{\n+        \"identity\" : \"sct-concept\",\n+        \"map\" : \"< 441742003 |Evaluation finding|\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX.2, OBX.5, OBX.6\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"value\"\n+      },\n+      {\n+        \"identity\" : \"sct-attr\",\n+        \"map\" : \"363714003 |Interprets|\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.value[x]:valueCodeableConcept\",\n+      \"path\" : \"Observation.value[x]\",\n+      \"sliceName\" : \"valueCodeableConcept\",\n+      \"short\" : \"Coded Response\",\n+      \"definition\" : \"The information determined as a result of making the observation, if the information has a simple value.\",\n+      \"comment\" : \"An observation may have; 1)  a single value here, 2)  both a value and a set of related or component values,  or 3)  only a set of related or component values. If a value is present, the datatype for this element should be determined by Observation.code.  A CodeableConcept with just a text would be used instead of a string if the field was usually coded, or if the type associated with the Observation.code defines a coded value.  For additional guidance, see the [Notes section](http://hl7.org/fhir/R4/observation.html#notes) below.\",\n+      \"requirements\" : \"An observation exists to have a value, though it might not if it is in error, or if it represents a group of observations.\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.value[x]\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"CodeableConcept\"\n+      }],\n+      \"condition\" : [\"obs-7\"],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"mustSupport\" : true,\n+      \"isModifier\" : false,\n+      \"isSummary\" : true,\n+      \"binding\" : {\n+        \"strength\" : \"extensible\",\n+        \"description\" : \"Smoking status comprehensive\",\n+        \"valueSet\" : \"http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1267.3\"\n+      },\n+      \"mapping\" : [{\n+        \"identity\" : \"sct-concept\",\n+        \"map\" : \"< 441742003 |Evaluation finding|\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX.2, OBX.5, OBX.6\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"value\"\n+      },\n+      {\n+        \"identity\" : \"sct-attr\",\n+        \"map\" : \"363714003 |Interprets|\"\n+      },\n+      {\n+        \"identity\" : \"argonaut-dq-dstu2\",\n+        \"map\" : \"Observation.valueCodeableConcept\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.dataAbsentReason\",\n+      \"path\" : \"Observation.dataAbsentReason\",\n+      \"short\" : \"Why the result is missing\",\n+      \"definition\" : \"Provides a reason why the expected value in the element Observation.value[x] is missing.\",\n+      \"comment\" : \"Null or exceptional values can be represented two ways in FHIR Observations.  One way is to simply include them in the value set and represent the exceptions in the value.  For example, measurement values for a serology test could be  \\\"detected\\\", \\\"not detected\\\", \\\"inconclusive\\\", or  \\\"specimen unsatisfactory\\\".   \\n\\nThe alternate way is to use the value element for actual observations and use the explicit dataAbsentReason element to record exceptional values.  For example, the dataAbsentReason code \\\"error\\\" could be used when the measurement was not completed. Note that an observation may only be reported if there are values to report. For example differential cell counts values may be reported only when > 0.  Because of these options, use-case agreements are required to interpret general observations for null or exceptional values.\",\n+      \"requirements\" : \"For many results it is necessary to handle exceptional values in measurements.\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.dataAbsentReason\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"CodeableConcept\"\n+      }],\n+      \"condition\" : [\"obs-6\"],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"binding\" : {\n+        \"extension\" : [{\n+          \"url\" : \"http://hl7.org/fhir/StructureDefinition/elementdefinition-bindingName\",\n+          \"valueString\" : \"ObservationValueAbsentReason\"\n+        }],\n+        \"strength\" : \"extensible\",\n+        \"description\" : \"Codes specifying why the result (`Observation.value[x]`) is missing.\",\n+        \"valueSet\" : \"http://hl7.org/fhir/ValueSet/data-absent-reason\"\n+      },\n+      \"mapping\" : [{\n+        \"identity\" : \"v2\",\n+        \"map\" : \"N/A\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"value.nullFlavor\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.interpretation\",\n+      \"path\" : \"Observation.interpretation\",\n+      \"short\" : \"High, low, normal, etc.\",\n+      \"definition\" : \"A categorical assessment of an observation value.  For example, high, low, normal.\",\n+      \"comment\" : \"Historically used for laboratory results (known as 'abnormal flag' ),  its use extends to other use cases where coded interpretations  are relevant.  Often reported as one or more simple compact codes this element is often placed adjacent to the result value in reports and flow sheets to signal the meaning/normalcy status of the result.\",\n+      \"requirements\" : \"For some results, particularly numeric results, an interpretation is necessary to fully understand the significance of a result.\",\n+      \"alias\" : [\"Abnormal Flag\"],\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"Observation.interpretation\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"CodeableConcept\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"binding\" : {\n+        \"extension\" : [{\n+          \"url\" : \"http://hl7.org/fhir/StructureDefinition/elementdefinition-bindingName\",\n+          \"valueString\" : \"ObservationInterpretation\"\n+        }],\n+        \"strength\" : \"extensible\",\n+        \"description\" : \"Codes identifying interpretations of observations.\",\n+        \"valueSet\" : \"http://hl7.org/fhir/ValueSet/observation-interpretation\"\n+      },\n+      \"mapping\" : [{\n+        \"identity\" : \"sct-concept\",\n+        \"map\" : \"< 260245000 |Findings values|\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX-8\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"interpretationCode\"\n+      },\n+      {\n+        \"identity\" : \"sct-attr\",\n+        \"map\" : \"363713009 |Has interpretation|\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.note\",\n+      \"path\" : \"Observation.note\",\n+      \"short\" : \"Comments about the observation\",\n+      \"definition\" : \"Comments about the observation or the results.\",\n+      \"comment\" : \"May include general statements about the observation, or statements about significant, unexpected or unreliable results values, or information about its source when relevant to its interpretation.\",\n+      \"requirements\" : \"Need to be able to provide free text additional information.\",\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"Observation.note\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Annotation\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"mapping\" : [{\n+        \"identity\" : \"v2\",\n+        \"map\" : \"NTE.3 (partner NTE to OBX, or sometimes another (child?) OBX)\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"subjectOf.observationEvent[code=\\\"annotation\\\"].value\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.bodySite\",\n+      \"path\" : \"Observation.bodySite\",\n+      \"short\" : \"Observed body part\",\n+      \"definition\" : \"Indicates the site on the subject's body where the observation was made (i.e. the target site).\",\n+      \"comment\" : \"Only used if not implicit in code found in Observation.code.  In many systems, this may be represented as a related observation instead of an inline component.   \\n\\nIf the use case requires BodySite to be handled as a separate resource (e.g. to identify and track separately) then use the standard extension[ bodySite](http://hl7.org/fhir/R4/extension-bodysite.html).\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.bodySite\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"CodeableConcept\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"binding\" : {\n+        \"extension\" : [{\n+          \"url\" : \"http://hl7.org/fhir/StructureDefinition/elementdefinition-bindingName\",\n+          \"valueString\" : \"BodySite\"\n+        }],\n+        \"strength\" : \"example\",\n+        \"description\" : \"Codes describing anatomical locations. May include laterality.\",\n+        \"valueSet\" : \"http://hl7.org/fhir/ValueSet/body-site\"\n+      },\n+      \"mapping\" : [{\n+        \"identity\" : \"sct-concept\",\n+        \"map\" : \"< 123037004 |Body structure|\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX-20\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"targetSiteCode\"\n+      },\n+      {\n+        \"identity\" : \"sct-attr\",\n+        \"map\" : \"718497002 |Inherent location|\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.method\",\n+      \"path\" : \"Observation.method\",\n+      \"short\" : \"How it was done\",\n+      \"definition\" : \"Indicates the mechanism used to perform the observation.\",\n+      \"comment\" : \"Only used if not implicit in code for Observation.code.\",\n+      \"requirements\" : \"In some cases, method can impact results and is thus used for determining whether results can be compared or determining significance of results.\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.method\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"CodeableConcept\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"binding\" : {\n+        \"extension\" : [{\n+          \"url\" : \"http://hl7.org/fhir/StructureDefinition/elementdefinition-bindingName\",\n+          \"valueString\" : \"ObservationMethod\"\n+        }],\n+        \"strength\" : \"example\",\n+        \"description\" : \"Methods for simple observations.\",\n+        \"valueSet\" : \"http://hl7.org/fhir/ValueSet/observation-methods\"\n+      },\n+      \"mapping\" : [{\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX-17\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"methodCode\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.specimen\",\n+      \"path\" : \"Observation.specimen\",\n+      \"short\" : \"Specimen used for this observation\",\n+      \"definition\" : \"The specimen that was used when this observation was made.\",\n+      \"comment\" : \"Should only be used if not implicit in code found in `Observation.code`.  Observations are not made on specimens themselves; they are made on a subject, but in many cases by the means of a specimen. Note that although specimens are often involved, they are not always tracked and reported explicitly. Also note that observation resources may be used in contexts that track the specimen explicitly (e.g. Diagnostic Report).\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.specimen\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Reference\",\n+        \"targetProfile\" : [\"http://hl7.org/fhir/StructureDefinition/Specimen\"]\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"mapping\" : [{\n+        \"identity\" : \"sct-concept\",\n+        \"map\" : \"< 123038009 |Specimen|\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"SPM segment\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"participation[typeCode=SPC].specimen\"\n+      },\n+      {\n+        \"identity\" : \"sct-attr\",\n+        \"map\" : \"704319004 |Inherent in|\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.device\",\n+      \"path\" : \"Observation.device\",\n+      \"short\" : \"(Measurement) Device\",\n+      \"definition\" : \"The device used to generate the observation data.\",\n+      \"comment\" : \"Note that this is not meant to represent a device involved in the transmission of the result, e.g., a gateway.  Such devices may be documented using the Provenance resource where relevant.\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.device\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Reference\",\n+        \"targetProfile\" : [\"http://hl7.org/fhir/StructureDefinition/Device\",\n+        \"http://hl7.org/fhir/StructureDefinition/DeviceMetric\"]\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"mapping\" : [{\n+        \"identity\" : \"sct-concept\",\n+        \"map\" : \"< 49062001 |Device|\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX-17 / PRT -10\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"participation[typeCode=DEV]\"\n+      },\n+      {\n+        \"identity\" : \"sct-attr\",\n+        \"map\" : \"424226004 |Using device|\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.referenceRange\",\n+      \"path\" : \"Observation.referenceRange\",\n+      \"short\" : \"Provides guide for interpretation\",\n+      \"definition\" : \"Guidance on how to interpret the value by comparison to a normal or recommended range.  Multiple reference ranges are interpreted as an \\\"OR\\\".   In other words, to represent two distinct target populations, two `referenceRange` elements would be used.\",\n+      \"comment\" : \"Most observations only have one generic reference range. Systems MAY choose to restrict to only supplying the relevant reference range based on knowledge about the patient (e.g., specific to the patient's age, gender, weight and other factors), but this might not be possible or appropriate. Whenever more than one reference range is supplied, the differences between them SHOULD be provided in the reference range and/or age properties.\",\n+      \"requirements\" : \"Knowing what values are considered \\\"normal\\\" can help evaluate the significance of a particular result. Need to be able to provide multiple reference ranges for different contexts.\",\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"Observation.referenceRange\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"BackboneElement\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      },\n+      {\n+        \"key\" : \"obs-3\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"Must have at least a low or a high or text\",\n+        \"expression\" : \"low.exists() or high.exists() or text.exists()\",\n+        \"xpath\" : \"(exists(f:low) or exists(f:high)or exists(f:text))\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Observation\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"mapping\" : [{\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX.7\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"outboundRelationship[typeCode=REFV]/target[classCode=OBS, moodCode=EVN]\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.referenceRange.id\",\n+      \"path\" : \"Observation.referenceRange.id\",\n+      \"representation\" : [\"xmlAttr\"],\n+      \"short\" : \"Unique id for inter-element referencing\",\n+      \"definition\" : \"Unique id for the element within a resource (for internal references). This may be any string value that does not contain spaces.\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Element.id\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"extension\" : [{\n+          \"url\" : \"http://hl7.org/fhir/StructureDefinition/structuredefinition-fhir-type\",\n+          \"valueUrl\" : \"string\"\n+        }],\n+        \"code\" : \"http://hl7.org/fhirpath/System.String\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"mapping\" : [{\n+        \"identity\" : \"rim\",\n+        \"map\" : \"n/a\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.referenceRange.extension\",\n+      \"path\" : \"Observation.referenceRange.extension\",\n+      \"short\" : \"Additional content defined by implementations\",\n+      \"definition\" : \"May be used to represent additional information that is not part of the basic definition of the element. To make the use of extensions safe and manageable, there is a strict set of governance  applied to the definition and use of extensions. Though any implementer can define an extension, there is a set of requirements that SHALL be met as part of the definition of the extension.\",\n+      \"comment\" : \"There can be no stigma associated with the use of extensions by any application, project, or standard - regardless of the institution or jurisdiction that uses or defines the extensions.  The use of extensions is what allows the FHIR specification to retain a core level of simplicity for everyone.\",\n+      \"alias\" : [\"extensions\",\n+      \"user content\"],\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"Element.extension\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Extension\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      },\n+      {\n+        \"key\" : \"ext-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"Must have either extensions or value[x], not both\",\n+        \"expression\" : \"extension.exists() != value.exists()\",\n+        \"xpath\" : \"exists(f:extension)!=exists(f:*[starts-with(local-name(.), \\\"value\\\")])\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Extension\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"mapping\" : [{\n+        \"identity\" : \"rim\",\n+        \"map\" : \"n/a\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.referenceRange.modifierExtension\",\n+      \"path\" : \"Observation.referenceRange.modifierExtension\",\n+      \"short\" : \"Extensions that cannot be ignored even if unrecognized\",\n+      \"definition\" : \"May be used to represent additional information that is not part of the basic definition of the element and that modifies the understanding of the element in which it is contained and/or the understanding of the containing element's descendants. Usually modifier elements provide negation or qualification. To make the use of extensions safe and manageable, there is a strict set of governance applied to the definition and use of extensions. Though any implementer can define an extension, there is a set of requirements that SHALL be met as part of the definition of the extension. Applications processing a resource are required to check for modifier extensions.\\n\\nModifier extensions SHALL NOT change the meaning of any elements on Resource or DomainResource (including cannot change the meaning of modifierExtension itself).\",\n+      \"comment\" : \"There can be no stigma associated with the use of extensions by any application, project, or standard - regardless of the institution or jurisdiction that uses or defines the extensions.  The use of extensions is what allows the FHIR specification to retain a core level of simplicity for everyone.\",\n+      \"requirements\" : \"Modifier extensions allow for extensions that *cannot* be safely ignored to be clearly distinguished from the vast majority of extensions which can be safely ignored.  This promotes interoperability by eliminating the need for implementers to prohibit the presence of extensions. For further information, see the [definition of modifier extensions](http://hl7.org/fhir/R4/extensibility.html#modifierExtension).\",\n+      \"alias\" : [\"extensions\",\n+      \"user content\",\n+      \"modifiers\"],\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"BackboneElement.modifierExtension\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Extension\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      },\n+      {\n+        \"key\" : \"ext-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"Must have either extensions or value[x], not both\",\n+        \"expression\" : \"extension.exists() != value.exists()\",\n+        \"xpath\" : \"exists(f:extension)!=exists(f:*[starts-with(local-name(.), \\\"value\\\")])\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Extension\"\n+      }],\n+      \"isModifier\" : true,\n+      \"isModifierReason\" : \"Modifier extensions are expected to modify the meaning or interpretation of the element that contains them\",\n+      \"isSummary\" : true,\n+      \"mapping\" : [{\n+        \"identity\" : \"rim\",\n+        \"map\" : \"N/A\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.referenceRange.low\",\n+      \"path\" : \"Observation.referenceRange.low\",\n+      \"short\" : \"Low Range, if relevant\",\n+      \"definition\" : \"The value of the low bound of the reference range.  The low bound of the reference range endpoint is inclusive of the value (e.g.  reference range is >=5 - <=9). If the low bound is omitted,  it is assumed to be meaningless (e.g. reference range is <=2.3).\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.referenceRange.low\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Quantity\",\n+        \"profile\" : [\"http://hl7.org/fhir/StructureDefinition/SimpleQuantity\"]\n+      }],\n+      \"condition\" : [\"obs-3\"],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"mapping\" : [{\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX-7\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"value:IVL_PQ.low\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.referenceRange.high\",\n+      \"path\" : \"Observation.referenceRange.high\",\n+      \"short\" : \"High Range, if relevant\",\n+      \"definition\" : \"The value of the high bound of the reference range.  The high bound of the reference range endpoint is inclusive of the value (e.g.  reference range is >=5 - <=9). If the high bound is omitted,  it is assumed to be meaningless (e.g. reference range is >= 2.3).\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.referenceRange.high\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Quantity\",\n+        \"profile\" : [\"http://hl7.org/fhir/StructureDefinition/SimpleQuantity\"]\n+      }],\n+      \"condition\" : [\"obs-3\"],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"mapping\" : [{\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX-7\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"value:IVL_PQ.high\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.referenceRange.type\",\n+      \"path\" : \"Observation.referenceRange.type\",\n+      \"short\" : \"Reference range qualifier\",\n+      \"definition\" : \"Codes to indicate the what part of the targeted reference population it applies to. For example, the normal or therapeutic range.\",\n+      \"comment\" : \"This SHOULD be populated if there is more than one range.  If this element is not present then the normal range is assumed.\",\n+      \"requirements\" : \"Need to be able to say what kind of reference range this is - normal, recommended, therapeutic, etc.,  - for proper interpretation.\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.referenceRange.type\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"CodeableConcept\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"binding\" : {\n+        \"extension\" : [{\n+          \"url\" : \"http://hl7.org/fhir/StructureDefinition/elementdefinition-bindingName\",\n+          \"valueString\" : \"ObservationRangeMeaning\"\n+        }],\n+        \"strength\" : \"preferred\",\n+        \"description\" : \"Code for the meaning of a reference range.\",\n+        \"valueSet\" : \"http://hl7.org/fhir/ValueSet/referencerange-meaning\"\n+      },\n+      \"mapping\" : [{\n+        \"identity\" : \"sct-concept\",\n+        \"map\" : \"< 260245000 |Findings values| OR  \\r< 365860008 |General clinical state finding| \\rOR \\r< 250171008 |Clinical history or observation findings| OR  \\r< 415229000 |Racial group| OR \\r< 365400002 |Finding of puberty stage| OR\\r< 443938003 |Procedure carried out on subject|\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX-10\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"interpretationCode\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.referenceRange.appliesTo\",\n+      \"path\" : \"Observation.referenceRange.appliesTo\",\n+      \"short\" : \"Reference range population\",\n+      \"definition\" : \"Codes to indicate the target population this reference range applies to.  For example, a reference range may be based on the normal population or a particular sex or race.  Multiple `appliesTo`  are interpreted as an \\\"AND\\\" of the target populations.  For example, to represent a target population of African American females, both a code of female and a code for African American would be used.\",\n+      \"comment\" : \"This SHOULD be populated if there is more than one range.  If this element is not present then the normal population is assumed.\",\n+      \"requirements\" : \"Need to be able to identify the target population for proper interpretation.\",\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"Observation.referenceRange.appliesTo\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"CodeableConcept\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"binding\" : {\n+        \"extension\" : [{\n+          \"url\" : \"http://hl7.org/fhir/StructureDefinition/elementdefinition-bindingName\",\n+          \"valueString\" : \"ObservationRangeType\"\n+        }],\n+        \"strength\" : \"example\",\n+        \"description\" : \"Codes identifying the population the reference range applies to.\",\n+        \"valueSet\" : \"http://hl7.org/fhir/ValueSet/referencerange-appliesto\"\n+      },\n+      \"mapping\" : [{\n+        \"identity\" : \"sct-concept\",\n+        \"map\" : \"< 260245000 |Findings values| OR  \\r< 365860008 |General clinical state finding| \\rOR \\r< 250171008 |Clinical history or observation findings| OR  \\r< 415229000 |Racial group| OR \\r< 365400002 |Finding of puberty stage| OR\\r< 443938003 |Procedure carried out on subject|\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX-10\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"interpretationCode\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.referenceRange.age\",\n+      \"path\" : \"Observation.referenceRange.age\",\n+      \"short\" : \"Applicable age range, if relevant\",\n+      \"definition\" : \"The age at which this reference range is applicable. This is a neonatal age (e.g. number of weeks at term) if the meaning says so.\",\n+      \"requirements\" : \"Some analytes vary greatly over age.\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.referenceRange.age\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Range\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"mapping\" : [{\n+        \"identity\" : \"rim\",\n+        \"map\" : \"outboundRelationship[typeCode=PRCN].targetObservationCriterion[code=\\\"age\\\"].value\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.referenceRange.text\",\n+      \"path\" : \"Observation.referenceRange.text\",\n+      \"short\" : \"Text based reference range in an observation\",\n+      \"definition\" : \"Text based reference range in an observation which may be used when a quantitative range is not appropriate for an observation.  An example would be a reference value of \\\"Negative\\\" or a list or table of \\\"normals\\\".\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.referenceRange.text\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"string\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"mapping\" : [{\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX-7\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"value:ST\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.hasMember\",\n+      \"path\" : \"Observation.hasMember\",\n+      \"short\" : \"Related resource that belongs to the Observation group\",\n+      \"definition\" : \"This observation is a group observation (e.g. a battery, a panel of tests, a set of vital sign measurements) that includes the target as a member of the group.\",\n+      \"comment\" : \"When using this element, an observation will typically have either a value or a set of related resources, although both may be present in some cases.  For a discussion on the ways Observations can assembled in groups together, see [Notes](http://hl7.org/fhir/R4/observation.html#obsgrouping) below.  Note that a system may calculate results from [QuestionnaireResponse](questionnaireresponse.html)  into a final score and represent the score as an Observation.\",\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"Observation.hasMember\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Reference\",\n+        \"targetProfile\" : [\"http://hl7.org/fhir/StructureDefinition/Observation\",\n+        \"http://hl7.org/fhir/StructureDefinition/QuestionnaireResponse\",\n+        \"http://hl7.org/fhir/StructureDefinition/MolecularSequence\"]\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : true,\n+      \"mapping\" : [{\n+        \"identity\" : \"v2\",\n+        \"map\" : \"Relationships established by OBX-4 usage\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"outBoundRelationship\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.derivedFrom\",\n+      \"path\" : \"Observation.derivedFrom\",\n+      \"short\" : \"Related measurements the observation is made from\",\n+      \"definition\" : \"The target resource that represents a measurement from which this observation value is derived. For example, a calculated anion gap or a fetal measurement based on an ultrasound image.\",\n+      \"comment\" : \"All the reference choices that are listed in this element can represent clinical observations and other measurements that may be the source for a derived value.  The most common reference will be another Observation.  For a discussion on the ways Observations can assembled in groups together, see [Notes](http://hl7.org/fhir/R4/observation.html#obsgrouping) below.\",\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"Observation.derivedFrom\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Reference\",\n+        \"targetProfile\" : [\"http://hl7.org/fhir/StructureDefinition/DocumentReference\",\n+        \"http://hl7.org/fhir/StructureDefinition/ImagingStudy\",\n+        \"http://hl7.org/fhir/StructureDefinition/Media\",\n+        \"http://hl7.org/fhir/StructureDefinition/QuestionnaireResponse\",\n+        \"http://hl7.org/fhir/StructureDefinition/Observation\",\n+        \"http://hl7.org/fhir/StructureDefinition/MolecularSequence\"]\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : true,\n+      \"mapping\" : [{\n+        \"identity\" : \"v2\",\n+        \"map\" : \"Relationships established by OBX-4 usage\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \".targetObservation\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.component\",\n+      \"path\" : \"Observation.component\",\n+      \"short\" : \"Component results\",\n+      \"definition\" : \"Some observations have multiple component observations.  These component observations are expressed as separate code value pairs that share the same attributes.  Examples include systolic and diastolic component observations for blood pressure measurement and multiple component observations for genetics observations.\",\n+      \"comment\" : \"For a discussion on the ways Observations can be assembled in groups together see [Notes](http://hl7.org/fhir/R4/observation.html#notes) below.\",\n+      \"requirements\" : \"Component observations share the same attributes in the Observation resource as the primary observation and are always treated a part of a single observation (they are not separable).   However, the reference range for the primary observation value is not inherited by the component values and is required when appropriate for each component observation.\",\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"Observation.component\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"BackboneElement\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : true,\n+      \"mapping\" : [{\n+        \"identity\" : \"v2\",\n+        \"map\" : \"containment by OBX-4?\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"outBoundRelationship[typeCode=COMP]\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.component.id\",\n+      \"path\" : \"Observation.component.id\",\n+      \"representation\" : [\"xmlAttr\"],\n+      \"short\" : \"Unique id for inter-element referencing\",\n+      \"definition\" : \"Unique id for the element within a resource (for internal references). This may be any string value that does not contain spaces.\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Element.id\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"extension\" : [{\n+          \"url\" : \"http://hl7.org/fhir/StructureDefinition/structuredefinition-fhir-type\",\n+          \"valueUrl\" : \"string\"\n+        }],\n+        \"code\" : \"http://hl7.org/fhirpath/System.String\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"mapping\" : [{\n+        \"identity\" : \"rim\",\n+        \"map\" : \"n/a\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.component.extension\",\n+      \"path\" : \"Observation.component.extension\",\n+      \"short\" : \"Additional content defined by implementations\",\n+      \"definition\" : \"May be used to represent additional information that is not part of the basic definition of the element. To make the use of extensions safe and manageable, there is a strict set of governance  applied to the definition and use of extensions. Though any implementer can define an extension, there is a set of requirements that SHALL be met as part of the definition of the extension.\",\n+      \"comment\" : \"There can be no stigma associated with the use of extensions by any application, project, or standard - regardless of the institution or jurisdiction that uses or defines the extensions.  The use of extensions is what allows the FHIR specification to retain a core level of simplicity for everyone.\",\n+      \"alias\" : [\"extensions\",\n+      \"user content\"],\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"Element.extension\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Extension\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      },\n+      {\n+        \"key\" : \"ext-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"Must have either extensions or value[x], not both\",\n+        \"expression\" : \"extension.exists() != value.exists()\",\n+        \"xpath\" : \"exists(f:extension)!=exists(f:*[starts-with(local-name(.), \\\"value\\\")])\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Extension\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"mapping\" : [{\n+        \"identity\" : \"rim\",\n+        \"map\" : \"n/a\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.component.modifierExtension\",\n+      \"path\" : \"Observation.component.modifierExtension\",\n+      \"short\" : \"Extensions that cannot be ignored even if unrecognized\",\n+      \"definition\" : \"May be used to represent additional information that is not part of the basic definition of the element and that modifies the understanding of the element in which it is contained and/or the understanding of the containing element's descendants. Usually modifier elements provide negation or qualification. To make the use of extensions safe and manageable, there is a strict set of governance applied to the definition and use of extensions. Though any implementer can define an extension, there is a set of requirements that SHALL be met as part of the definition of the extension. Applications processing a resource are required to check for modifier extensions.\\n\\nModifier extensions SHALL NOT change the meaning of any elements on Resource or DomainResource (including cannot change the meaning of modifierExtension itself).\",\n+      \"comment\" : \"There can be no stigma associated with the use of extensions by any application, project, or standard - regardless of the institution or jurisdiction that uses or defines the extensions.  The use of extensions is what allows the FHIR specification to retain a core level of simplicity for everyone.\",\n+      \"requirements\" : \"Modifier extensions allow for extensions that *cannot* be safely ignored to be clearly distinguished from the vast majority of extensions which can be safely ignored.  This promotes interoperability by eliminating the need for implementers to prohibit the presence of extensions. For further information, see the [definition of modifier extensions](http://hl7.org/fhir/R4/extensibility.html#modifierExtension).\",\n+      \"alias\" : [\"extensions\",\n+      \"user content\",\n+      \"modifiers\"],\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"BackboneElement.modifierExtension\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Extension\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      },\n+      {\n+        \"key\" : \"ext-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"Must have either extensions or value[x], not both\",\n+        \"expression\" : \"extension.exists() != value.exists()\",\n+        \"xpath\" : \"exists(f:extension)!=exists(f:*[starts-with(local-name(.), \\\"value\\\")])\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Extension\"\n+      }],\n+      \"isModifier\" : true,\n+      \"isModifierReason\" : \"Modifier extensions are expected to modify the meaning or interpretation of the element that contains them\",\n+      \"isSummary\" : true,\n+      \"mapping\" : [{\n+        \"identity\" : \"rim\",\n+        \"map\" : \"N/A\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.component.code\",\n+      \"path\" : \"Observation.component.code\",\n+      \"short\" : \"Type of component observation (code / type)\",\n+      \"definition\" : \"Describes what was observed. Sometimes this is called the observation \\\"code\\\".\",\n+      \"comment\" : \"*All* code-value and  component.code-component.value pairs need to be taken into account to correctly understand the meaning of the observation.\",\n+      \"requirements\" : \"Knowing what kind of observation is being made is essential to understanding the observation.\",\n+      \"min\" : 1,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.component.code\",\n+        \"min\" : 1,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"CodeableConcept\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : true,\n+      \"binding\" : {\n+        \"extension\" : [{\n+          \"url\" : \"http://hl7.org/fhir/StructureDefinition/elementdefinition-bindingName\",\n+          \"valueString\" : \"ObservationCode\"\n+        }],\n+        \"strength\" : \"example\",\n+        \"description\" : \"Codes identifying names of simple observations.\",\n+        \"valueSet\" : \"http://hl7.org/fhir/ValueSet/observation-codes\"\n+      },\n+      \"mapping\" : [{\n+        \"identity\" : \"w5\",\n+        \"map\" : \"FiveWs.what[x]\"\n+      },\n+      {\n+        \"identity\" : \"sct-concept\",\n+        \"map\" : \"< 363787002 |Observable entity| OR \\r< 386053000 |Evaluation procedure|\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX-3\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"code\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.component.value[x]\",\n+      \"path\" : \"Observation.component.value[x]\",\n+      \"short\" : \"Actual component result\",\n+      \"definition\" : \"The information determined as a result of making the observation, if the information has a simple value.\",\n+      \"comment\" : \"Used when observation has a set of component observations. An observation may have both a value (e.g. an  Apgar score)  and component observations (the observations from which the Apgar score was derived). If a value is present, the datatype for this element should be determined by Observation.code. A CodeableConcept with just a text would be used instead of a string if the field was usually coded, or if the type associated with the Observation.code defines a coded value.  For additional guidance, see the [Notes section](http://hl7.org/fhir/R4/observation.html#notes) below.\",\n+      \"requirements\" : \"An observation exists to have a value, though it might not if it is in error, or if it represents a group of observations.\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.component.value[x]\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"Quantity\"\n+      },\n+      {\n+        \"code\" : \"CodeableConcept\"\n+      },\n+      {\n+        \"code\" : \"string\"\n+      },\n+      {\n+        \"code\" : \"boolean\"\n+      },\n+      {\n+        \"code\" : \"integer\"\n+      },\n+      {\n+        \"code\" : \"Range\"\n+      },\n+      {\n+        \"code\" : \"Ratio\"\n+      },\n+      {\n+        \"code\" : \"SampledData\"\n+      },\n+      {\n+        \"code\" : \"time\"\n+      },\n+      {\n+        \"code\" : \"dateTime\"\n+      },\n+      {\n+        \"code\" : \"Period\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : true,\n+      \"mapping\" : [{\n+        \"identity\" : \"sct-concept\",\n+        \"map\" : \"363714003 |Interprets| < 441742003 |Evaluation finding|\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX.2, OBX.5, OBX.6\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"value\"\n+      },\n+      {\n+        \"identity\" : \"sct-attr\",\n+        \"map\" : \"363714003 |Interprets|\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.component.dataAbsentReason\",\n+      \"path\" : \"Observation.component.dataAbsentReason\",\n+      \"short\" : \"Why the component result is missing\",\n+      \"definition\" : \"Provides a reason why the expected value in the element Observation.component.value[x] is missing.\",\n+      \"comment\" : \"\\\"Null\\\" or exceptional values can be represented two ways in FHIR Observations.  One way is to simply include them in the value set and represent the exceptions in the value.  For example, measurement values for a serology test could be  \\\"detected\\\", \\\"not detected\\\", \\\"inconclusive\\\", or  \\\"test not done\\\". \\n\\nThe alternate way is to use the value element for actual observations and use the explicit dataAbsentReason element to record exceptional values.  For example, the dataAbsentReason code \\\"error\\\" could be used when the measurement was not completed.  Because of these options, use-case agreements are required to interpret general observations for exceptional values.\",\n+      \"requirements\" : \"For many results it is necessary to handle exceptional values in measurements.\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"base\" : {\n+        \"path\" : \"Observation.component.dataAbsentReason\",\n+        \"min\" : 0,\n+        \"max\" : \"1\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"CodeableConcept\"\n+      }],\n+      \"condition\" : [\"obs-6\"],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"binding\" : {\n+        \"extension\" : [{\n+          \"url\" : \"http://hl7.org/fhir/StructureDefinition/elementdefinition-bindingName\",\n+          \"valueString\" : \"ObservationValueAbsentReason\"\n+        }],\n+        \"strength\" : \"extensible\",\n+        \"description\" : \"Codes specifying why the result (`Observation.value[x]`) is missing.\",\n+        \"valueSet\" : \"http://hl7.org/fhir/ValueSet/data-absent-reason\"\n+      },\n+      \"mapping\" : [{\n+        \"identity\" : \"v2\",\n+        \"map\" : \"N/A\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"value.nullFlavor\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.component.interpretation\",\n+      \"path\" : \"Observation.component.interpretation\",\n+      \"short\" : \"High, low, normal, etc.\",\n+      \"definition\" : \"A categorical assessment of an observation value.  For example, high, low, normal.\",\n+      \"comment\" : \"Historically used for laboratory results (known as 'abnormal flag' ),  its use extends to other use cases where coded interpretations  are relevant.  Often reported as one or more simple compact codes this element is often placed adjacent to the result value in reports and flow sheets to signal the meaning/normalcy status of the result.\",\n+      \"requirements\" : \"For some results, particularly numeric results, an interpretation is necessary to fully understand the significance of a result.\",\n+      \"alias\" : [\"Abnormal Flag\"],\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"Observation.component.interpretation\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"type\" : [{\n+        \"code\" : \"CodeableConcept\"\n+      }],\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"binding\" : {\n+        \"extension\" : [{\n+          \"url\" : \"http://hl7.org/fhir/StructureDefinition/elementdefinition-bindingName\",\n+          \"valueString\" : \"ObservationInterpretation\"\n+        }],\n+        \"strength\" : \"extensible\",\n+        \"description\" : \"Codes identifying interpretations of observations.\",\n+        \"valueSet\" : \"http://hl7.org/fhir/ValueSet/observation-interpretation\"\n+      },\n+      \"mapping\" : [{\n+        \"identity\" : \"sct-concept\",\n+        \"map\" : \"< 260245000 |Findings values|\"\n+      },\n+      {\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX-8\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"interpretationCode\"\n+      },\n+      {\n+        \"identity\" : \"sct-attr\",\n+        \"map\" : \"363713009 |Has interpretation|\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.component.referenceRange\",\n+      \"path\" : \"Observation.component.referenceRange\",\n+      \"short\" : \"Provides guide for interpretation of component result\",\n+      \"definition\" : \"Guidance on how to interpret the value by comparison to a normal or recommended range.\",\n+      \"comment\" : \"Most observations only have one generic reference range. Systems MAY choose to restrict to only supplying the relevant reference range based on knowledge about the patient (e.g., specific to the patient's age, gender, weight and other factors), but this might not be possible or appropriate. Whenever more than one reference range is supplied, the differences between them SHOULD be provided in the reference range and/or age properties.\",\n+      \"requirements\" : \"Knowing what values are considered \\\"normal\\\" can help evaluate the significance of a particular result. Need to be able to provide multiple reference ranges for different contexts.\",\n+      \"min\" : 0,\n+      \"max\" : \"*\",\n+      \"base\" : {\n+        \"path\" : \"Observation.component.referenceRange\",\n+        \"min\" : 0,\n+        \"max\" : \"*\"\n+      },\n+      \"contentReference\" : \"http://hl7.org/fhir/StructureDefinition/Observation#Observation.referenceRange\",\n+      \"constraint\" : [{\n+        \"key\" : \"ele-1\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"All FHIR elements must have a @value or children\",\n+        \"expression\" : \"hasValue() or (children().count() > id.count())\",\n+        \"xpath\" : \"@value|f:*|h:div\",\n+        \"source\" : \"http://hl7.org/fhir/StructureDefinition/Element\"\n+      }],\n+      \"isModifier\" : false,\n+      \"isSummary\" : false,\n+      \"mapping\" : [{\n+        \"identity\" : \"v2\",\n+        \"map\" : \"OBX.7\"\n+      },\n+      {\n+        \"identity\" : \"rim\",\n+        \"map\" : \"outboundRelationship[typeCode=REFV]/target[classCode=OBS, moodCode=EVN]\"\n+      }]\n+    }]\n+  },\n+  \"differential\" : {\n+    \"element\" : [{\n+      \"id\" : \"Observation\",\n+      \"path\" : \"Observation\",\n+      \"alias\" : [\"Obs\"],\n+      \"constraint\" : [{\n+        \"key\" : \"us-core-24\",\n+        \"severity\" : \"error\",\n+        \"human\" : \"Observation.code 72166-2|Tobacco smoking status or 11367-0|History of Tobacco use SHALL use valueCodeableConcept\",\n+        \"expression\" : \"code.coding.where(code in '72166-2'|'11367-0').exists() implies value.is(CodeableConcept)\"\n+      },\n+      {\n+        \"key\" : \"us-core-25\",\n+        \"severity\" : \"warning\",\n+        \"human\" : \"For Observation.code 401201003|Cigarette pack-years or 782516008|Number of calculated smoking pack years SHOULD use valueQuantity\",\n+        \"expression\" : \"code.coding.where(code in '401201003'|'782516008').exists() implies value.is(Quantity)\"\n+      }],\n+      \"mustSupport\" : false,\n+      \"mapping\" : [{\n+        \"identity\" : \"argonaut-dq-dstu2\",\n+        \"map\" : \"Observation\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.status\",\n+      \"path\" : \"Observation.status\",\n+      \"short\" : \"final | entered-in-error\",\n+      \"mustSupport\" : true,\n+      \"binding\" : {\n+        \"strength\" : \"required\",\n+        \"valueSet\" : \"http://hl7.org/fhir/us/core/ValueSet/us-core-observation-smoking-status-status\"\n+      },\n+      \"mapping\" : [{\n+        \"identity\" : \"argonaut-dq-dstu2\",\n+        \"map\" : \"Observation.status\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.category\",\n+      \"path\" : \"Observation.category\",\n+      \"slicing\" : {\n+        \"discriminator\" : [{\n+          \"type\" : \"pattern\",\n+          \"path\" : \"$this\"\n+        }],\n+        \"rules\" : \"open\"\n+      },\n+      \"min\" : 1,\n+      \"mustSupport\" : true\n+    },\n+    {\n+      \"id\" : \"Observation.category:SocialHistory\",\n+      \"path\" : \"Observation.category\",\n+      \"sliceName\" : \"SocialHistory\",\n+      \"min\" : 1,\n+      \"max\" : \"1\",\n+      \"patternCodeableConcept\" : {\n+        \"coding\" : [{\n+          \"system\" : \"http://terminology.hl7.org/CodeSystem/observation-category\",\n+          \"code\" : \"social-history\"\n+        }]\n+      },\n+      \"mustSupport\" : true\n+    },\n+    {\n+      \"id\" : \"Observation.code\",\n+      \"path\" : \"Observation.code\",\n+      \"short\" : \"Smoking Status\",\n+      \"condition\" : [\"us-core-24\",\n+      \"us-core-25\"],\n+      \"mustSupport\" : true,\n+      \"binding\" : {\n+        \"strength\" : \"extensible\",\n+        \"description\" : \"Smoking status type\",\n+        \"valueSet\" : \"http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1267.6\"\n+      },\n+      \"mapping\" : [{\n+        \"identity\" : \"argonaut-dq-dstu2\",\n+        \"map\" : \"Observation.code\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.subject\",\n+      \"path\" : \"Observation.subject\",\n+      \"min\" : 1,\n+      \"type\" : [{\n+        \"code\" : \"Reference\",\n+        \"targetProfile\" : [\"http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient\"]\n+      }],\n+      \"mustSupport\" : true,\n+      \"mapping\" : [{\n+        \"identity\" : \"argonaut-dq-dstu2\",\n+        \"map\" : \"Observation.subject\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.effective[x]\",\n+      \"path\" : \"Observation.effective[x]\",\n+      \"min\" : 1,\n+      \"type\" : [{\n+        \"code\" : \"dateTime\"\n+      },\n+      {\n+        \"code\" : \"Period\"\n+      }],\n+      \"mustSupport\" : true,\n+      \"mapping\" : [{\n+        \"identity\" : \"argonaut-dq-dstu2\",\n+        \"map\" : \"Observation.issued\"\n+      }]\n+    },\n+    {\n+      \"id\" : \"Observation.value[x]\",\n+      \"path\" : \"Observation.value[x]\",\n+      \"slicing\" : {\n+        \"discriminator\" : [{\n+          \"type\" : \"type\",\n+          \"path\" : \"$this\"\n+        }],\n+        \"rules\" : \"open\"\n+      },\n+      \"min\" : 1,\n+      \"condition\" : [\"us-core-24\",\n+      \"us-core-25\"],\n+      \"mustSupport\" : true\n+    },\n+    {\n+      \"id\" : \"Observation.value[x]:valueQuantity\",\n+      \"path\" : \"Observation.value[x]\",\n+      \"sliceName\" : \"valueQuantity\",\n+      \"short\" : \"Quantitative Response\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"type\" : [{\n+        \"code\" : \"Quantity\"\n+      }],\n+      \"mustSupport\" : true,\n+      \"binding\" : {\n+        \"strength\" : \"required\",\n+        \"valueSet\" : \"http://terminology.hl7.org/ValueSet/v3-UnitsOfMeasureCaseSensitive\"\n+      }\n+    },\n+    {\n+      \"id\" : \"Observation.value[x]:valueCodeableConcept\",\n+      \"path\" : \"Observation.value[x]\",\n+      \"sliceName\" : \"valueCodeableConcept\",\n+      \"short\" : \"Coded Response\",\n+      \"min\" : 0,\n+      \"max\" : \"1\",\n+      \"type\" : [{\n+        \"code\" : \"CodeableConcept\"\n+      }],\n+      \"mustSupport\" : true,\n+      \"binding\" : {\n+        \"strength\" : \"extensible\",\n+        \"description\" : \"Smoking status comprehensive\",\n+        \"valueSet\" : \"http://cts.nlm.nih.gov/fhir/ValueSet/2.16.840.1.113762.1.4.1267.3\"\n+      },\n+      \"mapping\" : [{\n+        \"identity\" : \"argonaut-dq-dstu2\",\n+        \"map\" : \"Observation.valueCodeableConcept\"\n+      }]\n+    }]\n+  }\n+}\n\\ No newline at end of file\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5643",
    "pr_id": 5643,
    "issue_id": 1938,
    "repo": "medplum/medplum",
    "problem_statement": "Support multiple selections in QuestionnaireForm drop-downs\nIt looks like \"multi-select\" is not actually part of the \"questionnaire-item-control\" spec: https://fhir-ru.github.io/valueset-questionnaire-item-control.html\r\n\r\nHowever, the \"android-fhir\" library added it: https://github.com/google/android-fhir/pull/698",
    "issue_word_count": 47,
    "test_files_count": 1,
    "non_test_files_count": 2,
    "pr_changed_files": [
      "packages/definitions/dist/fhir/r4/valuesets.json",
      "packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx",
      "packages/react/src/QuestionnaireForm/QuestionnaireFormItem/QuestionnaireFormItem.tsx"
    ],
    "pr_changed_test_files": [
      "packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx"
    ],
    "base_commit": "eef0f20e387a2556170485bcd2ed56d401480fdb",
    "head_commit": "f5d05016c98d4adc296a0096ffa124597d7b14ae",
    "repo_url": "https://github.com/medplum/medplum/pull/5643",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5643",
    "dockerfile": "",
    "pr_merged_at": "2024-12-10T18:55:50.000Z",
    "patch": "diff --git a/packages/definitions/dist/fhir/r4/valuesets.json b/packages/definitions/dist/fhir/r4/valuesets.json\nindex dc5e1b08b4..f478ad4ca7 100644\n--- a/packages/definitions/dist/fhir/r4/valuesets.json\n+++ b/packages/definitions/dist/fhir/r4/valuesets.json\n@@ -44990,6 +44990,11 @@\n           \"display\" : \"Drop down\",\n           \"definition\" : \"A control where an item (or multiple items) can be selected from a list that is only displayed when the user is editing the field.\"\n         },\n+        {\n+          \"code\" : \"multi-select\",\n+          \"display\" : \"Multi select\",\n+          \"definition\" : \"A control where multiple items can be selected from a list that is only displayed when the user is editing the field.\"\n+        },\n         {\n           \"code\" : \"check-box\",\n           \"display\" : \"Check-box\",\n\ndiff --git a/packages/react/src/QuestionnaireForm/QuestionnaireFormItem/QuestionnaireFormItem.tsx b/packages/react/src/QuestionnaireForm/QuestionnaireFormItem/QuestionnaireFormItem.tsx\nindex 942bd4edea..bfb503b91f 100644\n--- a/packages/react/src/QuestionnaireForm/QuestionnaireFormItem/QuestionnaireFormItem.tsx\n+++ b/packages/react/src/QuestionnaireForm/QuestionnaireFormItem/QuestionnaireFormItem.tsx\n@@ -5,6 +5,7 @@ import {\n   formatCodeableConcept,\n   formatCoding,\n   getElementDefinition,\n+  HTTP_HL7_ORG,\n   stringify,\n   TypedValue,\n } from '@medplum/core';\n@@ -219,6 +220,16 @@ export function QuestionnaireFormItem(props: QuestionnaireFormItemProps): JSX.El\n             onChangeAnswer={(e) => onChangeAnswer(e)}\n           />\n         );\n+      } else if (isMultiSelectChoice(item) && !item.answerValueSet) {\n+        return (\n+          <QuestionnaireMultiSelectInput\n+            name={name}\n+            item={item}\n+            initial={initial}\n+            response={response}\n+            onChangeAnswer={(e) => onChangeAnswer(e)}\n+          />\n+        );\n       } else {\n         return (\n           <QuestionnaireChoiceSetInput\n@@ -302,6 +313,31 @@ function QuestionnaireChoiceDropDownInput(props: QuestionnaireChoiceInputProps):\n   );\n }\n \n+function QuestionnaireMultiSelectInput(props: QuestionnaireChoiceInputProps): JSX.Element {\n+  const { item, initial, response } = props;\n+\n+  if (!item.answerOption?.length) {\n+    return <NoAnswerDisplay />;\n+  }\n+\n+  const initialValue = getItemInitialValue(initial);\n+  const { propertyName, data } = formatSelectData(props.item);\n+  const currentAnswer = getCurrentMultiSelectAnswer(response);\n+\n+  return (\n+    <MultiSelect\n+      data={data}\n+      placeholder=\"Select items\"\n+      searchable\n+      defaultValue={currentAnswer || [typedValueToString(initialValue)]}\n+      onChange={(selected) => {\n+        const values = getNewMultiSelectValues(selected, propertyName, item);\n+        props.onChangeAnswer(values);\n+      }}\n+    />\n+  );\n+}\n+\n function QuestionnaireChoiceSetInput(props: QuestionnaireChoiceInputProps): JSX.Element {\n   const { name, item, initial, onChangeAnswer, response } = props;\n \n@@ -436,6 +472,14 @@ function isDropDownChoice(item: QuestionnaireItem): boolean {\n   );\n }\n \n+function isMultiSelectChoice(item: QuestionnaireItem): boolean {\n+  return !!item.extension?.some(\n+    (e) =>\n+      e.url === HTTP_HL7_ORG + '/fhir/StructureDefinition/questionnaire-itemControl' &&\n+      e.valueCodeableConcept?.coding?.[0]?.code === 'multi-select'\n+  );\n+}\n+\n interface MultiSelect {\n   readonly value: any;\n   readonly label: any;\n",
    "test_patch": "diff --git a/packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx b/packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx\nindex e789087d8a..d03b416471 100644\n--- a/packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx\n+++ b/packages/react/src/QuestionnaireForm/QuestionnaireForm.test.tsx\n@@ -1387,6 +1387,102 @@ describe('QuestionnaireForm', () => {\n     expect(searchInput).toBeInstanceOf(HTMLInputElement);\n   });\n \n+  test('Multi Select Code', async () => {\n+    await setup({\n+      questionnaire: {\n+        resourceType: 'Questionnaire',\n+        status: 'active',\n+        id: 'default-values',\n+        title: 'Default Values Example',\n+        item: [\n+          {\n+            id: 'choice',\n+            linkId: 'choice',\n+            text: 'choice',\n+            type: 'choice',\n+            answerOption: [\n+              {\n+                valueString: 'Yes',\n+              },\n+              {\n+                valueString: 'No',\n+              },\n+            ],\n+            extension: [\n+              {\n+                url: 'http://hl7.org/fhir/StructureDefinition/questionnaire-itemControl',\n+                valueCodeableConcept: {\n+                  coding: [\n+                    {\n+                      system: 'http://hl7.org/fhir/questionnaire-item-control',\n+                      code: 'multi-select',\n+                      display: 'Multi Select',\n+                    },\n+                  ],\n+                  text: 'Multi Select',\n+                },\n+              },\n+            ],\n+          },\n+        ],\n+      },\n+      onSubmit: jest.fn(),\n+    });\n+\n+    const dropDown = screen.getByText('choice');\n+\n+    await act(async () => {\n+      fireEvent.click(dropDown);\n+    });\n+\n+    await act(async () => {\n+      fireEvent.change(dropDown, { target: 'Yes' });\n+    });\n+\n+    await act(async () => {\n+      fireEvent.change(dropDown, { target: 'No' });\n+    });\n+  });\n+\n+  test('Multi Select Code shows with no data', async () => {\n+    await setup({\n+      questionnaire: {\n+        resourceType: 'Questionnaire',\n+        status: 'active',\n+        item: [\n+          {\n+            linkId: 'q1',\n+            type: QuestionnaireItemType.choice,\n+            extension: [\n+              {\n+                url: 'http://hl7.org/fhir/StructureDefinition/questionnaire-itemControl',\n+                valueCodeableConcept: {\n+                  coding: [\n+                    {\n+                      system: 'http://hl7.org/fhir/questionnaire-item-control',\n+                      code: 'multi-select',\n+                      display: 'Multi Select',\n+                    },\n+                  ],\n+                  text: 'Multi Select',\n+                },\n+              },\n+            ],\n+            text: 'q1',\n+            answerOption: [],\n+          },\n+        ],\n+      },\n+      onSubmit: jest.fn(),\n+    });\n+\n+    expect(screen.getByText('q1')).toBeInTheDocument();\n+\n+    const searchInput = screen.getByPlaceholderText('No Answers Defined');\n+    expect(searchInput).toBeInTheDocument();\n+    expect(searchInput).toBeInstanceOf(HTMLInputElement);\n+  });\n+\n   test('Nested repeat', async () => {\n     const onSubmit = jest.fn();\n     await setup({\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5635",
    "pr_id": 5635,
    "issue_id": 5634,
    "repo": "medplum/medplum",
    "problem_statement": "`Failed to retrieve client information.` when logging in via `npx medplum login`\n<img width=\"1728\" alt=\"Screenshot 2024-12-05 at 3 27 40 PM\" src=\"https://github.com/user-attachments/assets/b7d825a9-233c-4255-8c23-54e52fdb3a7e\">\r\n\r\nWhen attempting to login via Medplum CLI, the `client_id` passed in is `\"medplum-cli\"` which causes the call to `/auth/clientinfo/${client_id}` to return an error and throw when fetching the new info on `ClientApplication` about which welcome string and logo to display for the `OAuthPage` added in #4805\r\n\r\nWe should probably add an explicit check for `medplum-cli` and not make the request for clientinfo in that case",
    "issue_word_count": 106,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/app/src/OAuthPage.test.tsx",
      "packages/app/src/OAuthPage.tsx"
    ],
    "pr_changed_test_files": [
      "packages/app/src/OAuthPage.test.tsx"
    ],
    "base_commit": "d208b15d9490e1b07e7b87eac5a6895fa7236a59",
    "head_commit": "79e3db92e6634515e56abe726efbb3c2785f8d0b",
    "repo_url": "https://github.com/medplum/medplum/pull/5635",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5635",
    "dockerfile": "",
    "pr_merged_at": "2024-12-06T01:44:54.000Z",
    "patch": "diff --git a/packages/app/src/OAuthPage.tsx b/packages/app/src/OAuthPage.tsx\nindex 8574bb0c36..cf389b39a7 100644\n--- a/packages/app/src/OAuthPage.tsx\n+++ b/packages/app/src/OAuthPage.tsx\n@@ -17,7 +17,7 @@ export function OAuthPage(): JSX.Element | null {\n   const clientId = params.get('client_id');\n \n   useEffect(() => {\n-    if (!clientId) {\n+    if (!clientId || clientId === 'medplum-cli') {\n       return;\n     }\n     async function fetchProjectInfo(): Promise<void> {\n",
    "test_patch": "diff --git a/packages/app/src/OAuthPage.test.tsx b/packages/app/src/OAuthPage.test.tsx\nindex 36cdb8f35a..9b1e12ebee 100644\n--- a/packages/app/src/OAuthPage.test.tsx\n+++ b/packages/app/src/OAuthPage.test.tsx\n@@ -139,4 +139,11 @@ describe('OAuthPage', () => {\n     const logo = screen.getByAltText('Welcome Logo');\n     expect(logo).toBeInTheDocument();\n   });\n+\n+  test('Do not fetch client info when client_id is medplum-cli', async () => {\n+    jest.spyOn(medplum, 'get').mockReset();\n+    const mockGet = jest.spyOn(medplum, 'get');\n+    await setup('/oauth?client_id=medplum-cli');\n+    expect(mockGet).not.toHaveBeenCalled();\n+  });\n });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5630",
    "pr_id": 5630,
    "issue_id": 5629,
    "repo": "medplum/medplum",
    "problem_statement": "Reject strings with control characters\nFrom the R4 spec for the [string primitive type](https://hl7.org/fhir/r4/datatypes.html#primitive):\r\n\r\n> Strings SHOULD not contain Unicode character points below 32, except for u0009 (horizontal tab), u0010 (carriage return) and u0013 (line feed).",
    "issue_word_count": 43,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/core/src/typeschema/validation.test.ts",
      "packages/core/src/typeschema/validation.ts"
    ],
    "pr_changed_test_files": [
      "packages/core/src/typeschema/validation.test.ts"
    ],
    "base_commit": "b5553034d4aa200d25c086e4310cf3151c2ef60d",
    "head_commit": "7cbe294641fe262b8cf3c4c195268159dd286a8c",
    "repo_url": "https://github.com/medplum/medplum/pull/5630",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5630",
    "dockerfile": "",
    "pr_merged_at": "2025-02-19T23:39:57.000Z",
    "patch": "diff --git a/packages/core/src/typeschema/validation.ts b/packages/core/src/typeschema/validation.ts\nindex bbe3c390b3..772e43d265 100644\n--- a/packages/core/src/typeschema/validation.ts\n+++ b/packages/core/src/typeschema/validation.ts\n@@ -80,9 +80,9 @@ export const validationRegexes: Record<string, RegExp> = {\n   id: /^[A-Za-z0-9\\-.]{1,64}$/,\n   instant:\n     /^(\\d(\\d(\\d[1-9]|[1-9]0)|[1-9]00)|[1-9]000)-(0[1-9]|1[0-2])-(0[1-9]|[1-2]\\d|3[0-1])T([01]\\d|2[0-3]):[0-5]\\d:([0-5]\\d|60)(\\.\\d{1,9})?(Z|[+-]((0\\d|1[0-3]):[0-5]\\d|14:00))$/,\n-  markdown: /^[\\s\\S]+$/,\n+  markdown: /^[\\r\\n\\t\\u0020-\\uFFFF]+$/,\n   oid: /^urn:oid:[0-2](\\.(0|[1-9]\\d*))+$/,\n-  string: /^[\\s\\S]+$/,\n+  string: /^[\\r\\n\\t\\u0020-\\uFFFF]+$/,\n   time: /^([01]\\d|2[0-3]):[0-5]\\d:([0-5]\\d|60)(\\.\\d{1,9})?$/,\n   uri: /^\\S*$/,\n   url: /^\\S*$/,\n",
    "test_patch": "diff --git a/packages/core/src/typeschema/validation.test.ts b/packages/core/src/typeschema/validation.test.ts\nindex 444bf2778d..cfca031219 100644\n--- a/packages/core/src/typeschema/validation.test.ts\n+++ b/packages/core/src/typeschema/validation.test.ts\n@@ -1085,6 +1085,15 @@ describe('FHIR resource validation', () => {\n \n     acct.name = 'test';\n     expect(() => validateResource(acct)).not.toThrow();\n+\n+    acct.name = 'Invalid controls character \\x00 \\x01 \\x0B \\x1F are not allowed';\n+    expect(() => validateResource(acct)).toThrow();\n+\n+    acct.name = 'Valid controls characters \\x09 \\x0A \\x0D \\x20 \\x21 are allowed';\n+    expect(() => validateResource(acct)).not.toThrow();\n+\n+    acct.name = 'High unicode characters \\uFFFF \\u1234 are allowed';\n+    expect(() => validateResource(acct)).not.toThrow();\n   });\n \n   test('positiveInt', () => {\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5625",
    "pr_id": 5625,
    "issue_id": 4378,
    "repo": "medplum/medplum",
    "problem_statement": "Consider constraining allowed types of input to `getReferenceString`\nCurrently `getReferenceString` allows an input of `Resource | Reference`. However because all the properties on `Reference` are optional, this function allows any object to be passed in.\r\n\r\nFor example, the following TypeScript code compiles without error:\r\n\r\n```ts\r\nconst string = getReferenceString({});\r\nconsole.log('reference string is', string);\r\n```\r\n\r\nand prints the following:\r\n\r\n```ts\r\nreference string is undefined/undefined\r\n```\r\n\r\nthis tripped us up in production recently.\r\n\r\n---\r\n\r\nwould you consider potentially changing the signature of this function to enforce the string value being present on the passed-in input? for example something like so?\r\n\r\n```ts\r\nexport function getReferenceString(\r\n  input:\r\n    | (Reference & { reference: string })\r\n    | (Resource & { resourceType: ResourceType; id: string }),\r\n): string {\r\n  if (isReference(input)) {\r\n    return input.reference;\r\n  }\r\n  return `${input.resourceType}/${input.id}`;\r\n}\r\n```\r\n\r\nthis would result in the above code sample no longer compiling successfully:\r\n\r\n```ts\r\nconst string = getReferenceString({});\r\n```\r\n\r\n```ts\r\nerror TS2345: Argument of type '{}' is not assignable to parameter of type '(Reference<Resource> & { reference: string; }) | (Resource & { resourceType: \"Appointment\" | \"AccessPolicy\" | \"Account\" | \"ActivityDefinition\" | ... 157 more ... | \"VisionPrescription\"; id: string; })'.\r\n````",
    "issue_word_count": 166,
    "test_files_count": 6,
    "non_test_files_count": 62,
    "pr_changed_files": [
      "examples/medplum-chart-demo/src/bots/core/obstetric-encounter.test.ts",
      "examples/medplum-chart-demo/src/pages/UploadDataPage.tsx",
      "examples/medplum-chat-demo/src/components/PatientDetails.tsx",
      "examples/medplum-demo-bots/src/deduplication/merge-matching-patients.test.ts",
      "examples/medplum-demo-bots/src/deduplication/merge-matching-patients.ts",
      "examples/medplum-demo-bots/src/sample-account-setup.ts",
      "examples/medplum-eligibility-demo/src/components/CoverageDetails.tsx",
      "examples/medplum-eligibility-demo/src/pages/UploadDataPage.tsx",
      "examples/medplum-health-gorilla-demo/src/components/PerformingLabInput.tsx",
      "examples/medplum-patient-intake-demo/src/pages/UploadDataPage.tsx",
      "examples/medplum-photon-integration/src/pages/UploadDataPage.tsx",
      "examples/medplum-scheduling-demo/src/pages/AppointmentsPage.tsx",
      "examples/medplum-scheduling-demo/src/pages/UploadDataPage.tsx",
      "examples/medplum-task-demo/src/pages/UploadDataPage.tsx",
      "packages/core/src/client-test-utils.ts",
      "packages/core/src/client.test.ts",
      "packages/core/src/client.ts",
      "packages/core/src/fhirpath/atoms.ts",
      "packages/core/src/types.ts",
      "packages/core/src/utils.ts",
      "packages/fhir-router/src/batch.ts",
      "packages/fhir-router/src/fhirrouter.ts",
      "packages/fhir-router/src/graphql/utils.ts",
      "packages/fhir-router/src/repo.test.ts",
      "packages/fhir-router/src/repo.ts",
      "packages/health-gorilla-react/src/autocomplete-endpoint.ts",
      "packages/mock/src/client.ts",
      "packages/mock/src/mocks/accesspolicy.ts",
      "packages/mock/src/mocks/alice.ts",
      "packages/mock/src/mocks/workflow.ts",
      "packages/react/src/BookmarkDialog/BookmarkDialog.test.tsx",
      "packages/react/src/BookmarkDialog/BookmarkDialog.tsx",
      "packages/react/src/PatientSummary/PatientSummary.tsx",
      "packages/react/src/QuestionnaireForm/QuestionnaireForm.tsx",
      "packages/react/src/ResourceInput/ResourceInput.tsx",
      "packages/react/src/Scheduler/Scheduler.tsx",
      "packages/react/src/chat/BaseChat/BaseChat.tsx",
      "packages/react/src/chat/ThreadChat/ThreadChat.tsx",
      "packages/react/src/stories/covid19.ts",
      "packages/server/src/admin/invite.ts",
      "packages/server/src/auth/me.ts",
      "packages/server/src/auth/newuser.ts",
      "packages/server/src/auth/utils.ts",
      "packages/server/src/context.ts",
      "packages/server/src/fhir/binary.ts",
      "packages/server/src/fhir/operations/agentbulkstatus.ts",
      "packages/server/src/fhir/operations/agentreloadconfig.ts",
      "packages/server/src/fhir/operations/agentupgrade.ts",
      "packages/server/src/fhir/operations/execute.ts",
      "packages/server/src/fhir/operations/export.ts",
      "packages/server/src/fhir/operations/patienteverything.ts",
      "packages/server/src/fhir/operations/patientsummary.ts",
      "packages/server/src/fhir/operations/resourcegraph.ts",
      "packages/server/src/fhir/operations/utils/agentutils.ts",
      "packages/server/src/fhir/operations/utils/bulkexporter.ts",
      "packages/server/src/fhir/operations/utils/parameters.ts",
      "packages/server/src/fhir/patient.ts",
      "packages/server/src/fhir/repo.ts",
      "packages/server/src/fhir/search.ts",
      "packages/server/src/oauth/middleware.ts",
      "packages/server/src/oauth/token.ts",
      "packages/server/src/oauth/utils.ts",
      "packages/server/src/openapi.ts",
      "packages/server/src/scim/utils.ts",
      "packages/server/src/workers/batch.ts",
      "packages/server/src/workers/reindex.ts",
      "packages/server/src/workers/subscription.ts",
      "packages/server/src/workers/utils.ts"
    ],
    "pr_changed_test_files": [
      "examples/medplum-chart-demo/src/bots/core/obstetric-encounter.test.ts",
      "examples/medplum-demo-bots/src/deduplication/merge-matching-patients.test.ts",
      "packages/core/src/client-test-utils.ts",
      "packages/core/src/client.test.ts",
      "packages/fhir-router/src/repo.test.ts",
      "packages/react/src/BookmarkDialog/BookmarkDialog.test.tsx"
    ],
    "base_commit": "b5553034d4aa200d25c086e4310cf3151c2ef60d",
    "head_commit": "c1b800eba9032d6191fb8cf5c0a5bd73b65711af",
    "repo_url": "https://github.com/medplum/medplum/pull/5625",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5625",
    "dockerfile": "",
    "pr_merged_at": "2025-02-20T00:22:30.000Z",
    "patch": "diff --git a/examples/medplum-chart-demo/src/pages/UploadDataPage.tsx b/examples/medplum-chart-demo/src/pages/UploadDataPage.tsx\nindex 5f9e1b6255..4a047bc80a 100644\n--- a/examples/medplum-chart-demo/src/pages/UploadDataPage.tsx\n+++ b/examples/medplum-chart-demo/src/pages/UploadDataPage.tsx\n@@ -1,6 +1,6 @@\n import { Button, LoadingOverlay } from '@mantine/core';\n import { showNotification } from '@mantine/notifications';\n-import { capitalize, getReferenceString, isOk, MedplumClient, normalizeErrorString } from '@medplum/core';\n+import { capitalize, getReferenceString, isOk, MedplumClient, normalizeErrorString, WithId } from '@medplum/core';\n import { Bot, Bundle, BundleEntry, Practitioner } from '@medplum/fhirtypes';\n import { Document, useMedplum, useMedplumProfile } from '@medplum/react';\n import { IconCircleCheck, IconCircleOff } from '@tabler/icons-react';\n@@ -164,7 +164,7 @@ async function uploadExampleBots(medplum: MedplumClient, profile: Practitioner):\n       const createBotUrl = new URL('admin/projects/' + (projectId as string) + '/bot', medplum.getBaseUrl());\n       existingBot = (await medplum.post(createBotUrl, {\n         name: botName,\n-      })) as Bot;\n+      })) as WithId<Bot>;\n     }\n \n     botIds[botName] = existingBot.id as string;\n\ndiff --git a/examples/medplum-chat-demo/src/components/PatientDetails.tsx b/examples/medplum-chat-demo/src/components/PatientDetails.tsx\nindex 9f5d2dc3c3..72b9863f87 100644\n--- a/examples/medplum-chat-demo/src/components/PatientDetails.tsx\n+++ b/examples/medplum-chat-demo/src/components/PatientDetails.tsx\n@@ -1,6 +1,6 @@\n import { Loader, Tabs } from '@mantine/core';\n import { showNotification } from '@mantine/notifications';\n-import { getReferenceString, normalizeErrorString, Operator, SearchRequest } from '@medplum/core';\n+import { getReferenceString, normalizeErrorString, Operator, SearchRequest, WithId } from '@medplum/core';\n import { Patient, Practitioner, Resource } from '@medplum/fhirtypes';\n import {\n   Document,\n@@ -24,7 +24,7 @@ interface PatientDetailsProps {\n export function PatientDetails({ onChange }: PatientDetailsProps): JSX.Element {\n   const medplum = useMedplum();\n   const navigate = useNavigate();\n-  const profile = useMedplumProfile() as Practitioner;\n+  const profile = useMedplumProfile() as WithId<Practitioner>;\n   const { id } = useParams() as { id: string };\n   const patient = useResource<Patient>({ reference: `Patient/${id}` });\n \n\ndiff --git a/examples/medplum-demo-bots/src/deduplication/merge-matching-patients.ts b/examples/medplum-demo-bots/src/deduplication/merge-matching-patients.ts\nindex 34557e22c8..a3d77416ac 100644\n--- a/examples/medplum-demo-bots/src/deduplication/merge-matching-patients.ts\n+++ b/examples/medplum-demo-bots/src/deduplication/merge-matching-patients.ts\n@@ -1,6 +1,7 @@\n import {\n   BotEvent,\n   MedplumClient,\n+  WithId,\n   createReference,\n   deepClone,\n   getQuestionnaireAnswers,\n@@ -68,8 +69,8 @@ export async function handler(medplum: MedplumClient, event: BotEvent<Questionna\n   }\n \n   // Read the source and target Patient resource\n-  const targetPatient = (await medplum.readReference(targetReference)) as Patient;\n-  const sourcePatient = (await medplum.readReference(srcReference)) as Patient;\n+  const targetPatient = await medplum.readReference(targetReference);\n+  const sourcePatient = await medplum.readReference(srcReference);\n \n   const patients = linkPatientRecords(sourcePatient, targetPatient);\n \n@@ -112,8 +113,8 @@ export async function handler(medplum: MedplumClient, event: BotEvent<Questionna\n \n // start-block linkPatientRecords\n interface MergedPatients {\n-  readonly src: Patient;\n-  readonly target: Patient;\n+  readonly src: WithId<Patient>;\n+  readonly target: WithId<Patient>;\n }\n \n /**\n@@ -123,7 +124,7 @@ interface MergedPatients {\n  * @param target - The target patient record which will replace the source.\n  * @returns - Object containing updated source and target patient records with their links.\n  */\n-export function linkPatientRecords(src: Patient, target: Patient): MergedPatients {\n+export function linkPatientRecords(src: WithId<Patient>, target: WithId<Patient>): MergedPatients {\n   const targetCopy = deepClone(target);\n   const targetLinks = targetCopy.link ?? [];\n   targetLinks.push({ other: createReference(src), type: 'replaces' });\n@@ -145,7 +146,7 @@ export function linkPatientRecords(src: Patient, target: Patient): MergedPatient\n  * @param target - The target patient marked as the master record.\n  * @returns - Object containing updated source and target patient records with their links.\n  */\n-export function unlinkPatientRecords(src: Patient, target: Patient): MergedPatients {\n+export function unlinkPatientRecords(src: WithId<Patient>, target: WithId<Patient>): MergedPatients {\n   const targetCopy = deepClone(target);\n   const srcCopy = deepClone(src);\n   // Filter out links from the target to the source\n@@ -173,7 +174,11 @@ export function unlinkPatientRecords(src: Patient, target: Patient): MergedPatie\n  * @param fields - Optional additional fields to be merged.\n  * @returns - Object containing the original source and the merged target patient records.\n  */\n-export function mergePatientRecords(src: Patient, target: Patient, fields?: Partial<Patient>): MergedPatients {\n+export function mergePatientRecords(\n+  src: WithId<Patient>,\n+  target: WithId<Patient>,\n+  fields?: Partial<Patient>\n+): MergedPatients {\n   const targetCopy = deepClone(target);\n   const mergedIdentifiers = targetCopy.identifier ?? [];\n   const srcIdentifiers = src.identifier ?? [];\n@@ -254,8 +259,8 @@ export function patientsAlreadyMerged(src: Patient, target: Patient): boolean {\n  */\n export async function updateResourceReferences<T extends ResourceType>(\n   medplum: MedplumClient,\n-  sourcePatient: Patient,\n-  targetPatient: Patient,\n+  sourcePatient: WithId<Patient>,\n+  targetPatient: WithId<Patient>,\n   resourceType: T\n ): Promise<void> {\n   // Search for clinical resources related to the source patient, by searching for all resources in the patient compartment\n\ndiff --git a/examples/medplum-demo-bots/src/sample-account-setup.ts b/examples/medplum-demo-bots/src/sample-account-setup.ts\nindex 79d5b199ae..8b9143762d 100644\n--- a/examples/medplum-demo-bots/src/sample-account-setup.ts\n+++ b/examples/medplum-demo-bots/src/sample-account-setup.ts\n@@ -1,4 +1,13 @@\n-import { BotEvent, createReference, getReferenceString, LOINC, MedplumClient, SNOMED, UCUM } from '@medplum/core';\n+import {\n+  BotEvent,\n+  createReference,\n+  getReferenceString,\n+  LOINC,\n+  MedplumClient,\n+  SNOMED,\n+  UCUM,\n+  WithId,\n+} from '@medplum/core';\n import {\n   AllergyIntolerance,\n   BundleEntry,\n@@ -206,7 +215,7 @@ async function ensureSchedule(medplum: MedplumClient, practitioner: Practitioner\n  * @param schedule - The practitioner's schedule.\n  * @param slotDate - The day of slots.\n  */\n-async function ensureSlots(medplum: MedplumClient, schedule: Schedule, slotDate: Date): Promise<void> {\n+async function ensureSlots(medplum: MedplumClient, schedule: WithId<Schedule>, slotDate: Date): Promise<void> {\n   const existingSlots = await medplum.search(\n     'Slot',\n     new URLSearchParams([\n\ndiff --git a/examples/medplum-eligibility-demo/src/components/CoverageDetails.tsx b/examples/medplum-eligibility-demo/src/components/CoverageDetails.tsx\nindex 2606311453..0d0494a564 100644\n--- a/examples/medplum-eligibility-demo/src/components/CoverageDetails.tsx\n+++ b/examples/medplum-eligibility-demo/src/components/CoverageDetails.tsx\n@@ -17,14 +17,18 @@ export function CoverageDetails(props: CoverageDetailsProps): JSX.Element {\n   // A search request to show all CoverageEligibilityRequest resources that are related the current coverage's beneficiary\n   const eligibilityRequestSearch: SearchRequest = {\n     resourceType: 'CoverageEligibilityRequest',\n-    filters: [{ code: 'patient', operator: Operator.EQUALS, value: getReferenceString(props.coverage.beneficiary) }],\n+    filters: [\n+      { code: 'patient', operator: Operator.EQUALS, value: getReferenceString(props.coverage.beneficiary) ?? '' },\n+    ],\n     fields: ['patient', 'purpose', 'item', 'insurance'],\n   };\n \n   // A search request to show all CoverageEligibilityResponse resources that are related the current coverage's beneficiary\n   const eligibilityResponseSearch: SearchRequest = {\n     resourceType: 'CoverageEligibilityResponse',\n-    filters: [{ code: 'patient', operator: Operator.EQUALS, value: getReferenceString(props.coverage.beneficiary) }],\n+    filters: [\n+      { code: 'patient', operator: Operator.EQUALS, value: getReferenceString(props.coverage.beneficiary) ?? '' },\n+    ],\n     fields: ['patient', 'outcome', 'disposition', 'insurance'],\n   };\n \n\ndiff --git a/examples/medplum-eligibility-demo/src/pages/UploadDataPage.tsx b/examples/medplum-eligibility-demo/src/pages/UploadDataPage.tsx\nindex c5cd7ccbfe..1b68c6c2d3 100644\n--- a/examples/medplum-eligibility-demo/src/pages/UploadDataPage.tsx\n+++ b/examples/medplum-eligibility-demo/src/pages/UploadDataPage.tsx\n@@ -1,6 +1,6 @@\n import { Button, LoadingOverlay } from '@mantine/core';\n import { showNotification } from '@mantine/notifications';\n-import { capitalize, getReferenceString, MedplumClient, normalizeErrorString } from '@medplum/core';\n+import { capitalize, getReferenceString, MedplumClient, normalizeErrorString, WithId } from '@medplum/core';\n import { Bot, Bundle, BundleEntry, Practitioner } from '@medplum/fhirtypes';\n import { Document, useMedplum, useMedplumProfile } from '@medplum/react';\n import { IconCircleCheck, IconCircleOff } from '@tabler/icons-react';\n@@ -92,7 +92,7 @@ async function uploadExampleBots(medplum: MedplumClient, profile: Practitioner):\n       const createBotUrl = new URL('admin/projects/' + (projectId as string) + '/bot', medplum.getBaseUrl());\n       existingBot = (await medplum.post(createBotUrl, {\n         name: botName,\n-      })) as Bot;\n+      })) as WithId<Bot>;\n     }\n \n     botIds[botName] = existingBot.id as string;\n\ndiff --git a/examples/medplum-health-gorilla-demo/src/components/PerformingLabInput.tsx b/examples/medplum-health-gorilla-demo/src/components/PerformingLabInput.tsx\nindex 515debd238..ed0fddcb73 100644\n--- a/examples/medplum-health-gorilla-demo/src/components/PerformingLabInput.tsx\n+++ b/examples/medplum-health-gorilla-demo/src/components/PerformingLabInput.tsx\n@@ -33,7 +33,7 @@ export function PerformingLabInput({ patient, error }: PractitionerInputProps):\n \n function resourceToOption<T extends Resource>(resource: T): AsyncAutocompleteOption<T> {\n   return {\n-    value: getReferenceString(resource),\n+    value: getReferenceString(resource) ?? '',\n     label: getDisplayString(resource),\n     resource,\n   };\n\ndiff --git a/examples/medplum-patient-intake-demo/src/pages/UploadDataPage.tsx b/examples/medplum-patient-intake-demo/src/pages/UploadDataPage.tsx\nindex e279613f23..cacea01d7c 100644\n--- a/examples/medplum-patient-intake-demo/src/pages/UploadDataPage.tsx\n+++ b/examples/medplum-patient-intake-demo/src/pages/UploadDataPage.tsx\n@@ -1,6 +1,6 @@\n import { Button, LoadingOverlay } from '@mantine/core';\n import { showNotification } from '@mantine/notifications';\n-import { capitalize, getReferenceString, isOk, MedplumClient, normalizeErrorString } from '@medplum/core';\n+import { capitalize, getReferenceString, isOk, MedplumClient, normalizeErrorString, WithId } from '@medplum/core';\n import { Bot, Bundle, BundleEntry, Practitioner, Questionnaire, Resource } from '@medplum/fhirtypes';\n import { Document, useMedplum, useMedplumProfile } from '@medplum/react';\n import { IconCircleCheck, IconCircleOff } from '@tabler/icons-react';\n@@ -14,7 +14,11 @@ import valuesetsData from '../../data/core/valuesets.json';\n \n import { IntakeQuestionnaireContext } from '../Questionnaire.context';\n \n-type UploadFunction = (medplum: MedplumClient, profile: Practitioner, questionnaire: Questionnaire) => Promise<void>;\n+type UploadFunction = (\n+  medplum: MedplumClient,\n+  profile: Practitioner,\n+  questionnaire: WithId<Questionnaire>\n+) => Promise<void>;\n \n export function UploadDataPage(): JSX.Element {\n   const medplum = useMedplum();\n@@ -52,7 +56,7 @@ export function UploadDataPage(): JSX.Element {\n         throw new Error(`Invalid upload type: ${dataType}`);\n     }\n \n-    uploadFunction(medplum, profile as Practitioner, questionnaire as Questionnaire)\n+    uploadFunction(medplum, profile as Practitioner, questionnaire as WithId<Questionnaire>)\n       .then(() => navigate('/'))\n       .catch((error) => {\n         showNotification({\n@@ -135,7 +139,7 @@ async function uploadExampleData(medplum: MedplumClient): Promise<void> {\n async function uploadExampleBots(\n   medplum: MedplumClient,\n   profile: Practitioner,\n-  questionnaire: Questionnaire\n+  questionnaire: WithId<Questionnaire>\n ): Promise<void> {\n   let transactionString = JSON.stringify(exampleBotData);\n   const botEntries: BundleEntry[] =\n@@ -151,7 +155,7 @@ async function uploadExampleBots(\n       const createBotUrl = new URL('admin/projects/' + (projectId as string) + '/bot', medplum.getBaseUrl());\n       existingBot = (await medplum.post(createBotUrl, {\n         name: botName,\n-      })) as Bot;\n+      })) as WithId<Bot>;\n     }\n \n     botIds[botName] = existingBot.id as string;\n\ndiff --git a/examples/medplum-photon-integration/src/pages/UploadDataPage.tsx b/examples/medplum-photon-integration/src/pages/UploadDataPage.tsx\nindex f759a13b31..4538cc9e5f 100644\n--- a/examples/medplum-photon-integration/src/pages/UploadDataPage.tsx\n+++ b/examples/medplum-photon-integration/src/pages/UploadDataPage.tsx\n@@ -1,6 +1,6 @@\n import { Button } from '@mantine/core';\n import { notifications } from '@mantine/notifications';\n-import { capitalize, getReferenceString, isOk, MedplumClient } from '@medplum/core';\n+import { capitalize, getReferenceString, isOk, MedplumClient, WithId } from '@medplum/core';\n import { Binary, Bot, Bundle, BundleEntry, Practitioner } from '@medplum/fhirtypes';\n import { Document, useMedplum, useMedplumProfile } from '@medplum/react';\n import { IconCircleCheck } from '@tabler/icons-react';\n@@ -64,7 +64,7 @@ async function uploadExampleBots(medplum: MedplumClient, profile: Practitioner):\n       const createBotUrl = new URL('admin/projects/' + (projectId as string) + '/bot', medplum.getBaseUrl());\n       existingBot = (await medplum.post(createBotUrl, {\n         name: botName,\n-      })) as Bot;\n+      })) as WithId<Bot>;\n     }\n \n     botIds[botName] = existingBot.id as string;\n\ndiff --git a/examples/medplum-scheduling-demo/src/pages/AppointmentsPage.tsx b/examples/medplum-scheduling-demo/src/pages/AppointmentsPage.tsx\nindex 7765362929..a27fa8a2cd 100644\n--- a/examples/medplum-scheduling-demo/src/pages/AppointmentsPage.tsx\n+++ b/examples/medplum-scheduling-demo/src/pages/AppointmentsPage.tsx\n@@ -1,12 +1,12 @@\n import { Paper, Tabs } from '@mantine/core';\n-import { Filter, getReferenceString, Operator, SearchRequest } from '@medplum/core';\n+import { Filter, getReferenceString, Operator, SearchRequest, WithId } from '@medplum/core';\n import { Practitioner } from '@medplum/fhirtypes';\n import { SearchControl, useMedplumProfile } from '@medplum/react';\n import { useEffect, useState } from 'react';\n import { useLocation, useNavigate } from 'react-router-dom';\n \n export function AppointmentsPage(): JSX.Element {\n-  const profile = useMedplumProfile() as Practitioner;\n+  const profile = useMedplumProfile() as WithId<Practitioner>;\n   const navigate = useNavigate();\n   const location = useLocation();\n \n@@ -33,7 +33,7 @@ export function AppointmentsPage(): JSX.Element {\n     resourceType: 'Appointment',\n     fields: ['patient', 'start', 'end', 'status', 'appointmentType', 'serviceType'],\n     filters: [\n-      { code: 'actor', operator: Operator.EQUALS, value: getReferenceString(profile as Practitioner) },\n+      { code: 'actor', operator: Operator.EQUALS, value: getReferenceString(profile) },\n       tab === 'upcoming' ? upcomingFilter : pastFilter,\n     ],\n     sortRules: [\n\ndiff --git a/examples/medplum-scheduling-demo/src/pages/UploadDataPage.tsx b/examples/medplum-scheduling-demo/src/pages/UploadDataPage.tsx\nindex bd5402558b..1e115397c2 100644\n--- a/examples/medplum-scheduling-demo/src/pages/UploadDataPage.tsx\n+++ b/examples/medplum-scheduling-demo/src/pages/UploadDataPage.tsx\n@@ -1,6 +1,6 @@\n import { Button, LoadingOverlay } from '@mantine/core';\n import { showNotification } from '@mantine/notifications';\n-import { capitalize, getReferenceString, isOk, MedplumClient, normalizeErrorString } from '@medplum/core';\n+import { capitalize, getReferenceString, isOk, MedplumClient, normalizeErrorString, WithId } from '@medplum/core';\n import { Bot, Bundle, BundleEntry, Practitioner, Resource } from '@medplum/fhirtypes';\n import { Document, useMedplum, useMedplumProfile } from '@medplum/react';\n import { IconCircleCheck, IconCircleOff } from '@tabler/icons-react';\n@@ -100,7 +100,7 @@ async function uploadExampleBots(medplum: MedplumClient, profile: Practitioner):\n       const createBotUrl = new URL('admin/projects/' + (projectId as string) + '/bot', medplum.getBaseUrl());\n       existingBot = (await medplum.post(createBotUrl, {\n         name: botName,\n-      })) as Bot;\n+      })) as WithId<Bot>;\n     }\n \n     botIds[botName] = existingBot.id as string;\n\ndiff --git a/examples/medplum-task-demo/src/pages/UploadDataPage.tsx b/examples/medplum-task-demo/src/pages/UploadDataPage.tsx\nindex 49a7c1052a..1ed92ce3a0 100644\n--- a/examples/medplum-task-demo/src/pages/UploadDataPage.tsx\n+++ b/examples/medplum-task-demo/src/pages/UploadDataPage.tsx\n@@ -1,6 +1,7 @@\n import { Button, LoadingOverlay } from '@mantine/core';\n import {\n   MedplumClient,\n+  WithId,\n   capitalize,\n   createReference,\n   getReferenceString,\n@@ -24,7 +25,7 @@ import exampleReportData from '../../data/example/example-reports.json';\n import exampleTaskData from '../../data/example/example-tasks.json';\n \n type UploadFunction =\n-  | ((medplum: MedplumClient, profile: Practitioner) => Promise<void>)\n+  | ((medplum: MedplumClient, profile: WithId<Practitioner>) => Promise<void>)\n   | ((medplum: MedplumClient) => Promise<void>);\n \n export function UploadDataPage(): JSX.Element {\n@@ -65,7 +66,7 @@ export function UploadDataPage(): JSX.Element {\n         throw new Error(`Invalid upload type '${dataType}'`);\n     }\n \n-    uploadFunction(medplum, profile as Practitioner)\n+    uploadFunction(medplum, profile as WithId<Practitioner>)\n       .then(() => navigate(-1))\n       .catch((error) => {\n         showNotification({\n@@ -219,7 +220,7 @@ async function uploadExampleQualifications(medplum: MedplumClient, profile: Prac\n   });\n }\n \n-async function uploadExampleRoleData(medplum: MedplumClient, profile: Practitioner): Promise<void> {\n+async function uploadExampleRoleData(medplum: MedplumClient, profile: WithId<Practitioner>): Promise<void> {\n   // Update the suffix of the current user to highlight the change\n   if (!profile?.name?.[0]?.suffix) {\n     await medplum.patchResource(profile.resourceType, profile.id as string, [\n@@ -262,7 +263,7 @@ async function uploadExampleBots(medplum: MedplumClient, profile: Practitioner):\n       const createBotUrl = new URL('admin/projects/' + (projectId as string) + '/bot', medplum.getBaseUrl());\n       existingBot = (await medplum.post(createBotUrl, {\n         name: botName,\n-      })) as Bot;\n+      })) as WithId<Bot>;\n     }\n \n     botIds[botName] = existingBot.id as string;\n\ndiff --git a/packages/core/src/client.ts b/packages/core/src/client.ts\nindex 6ff43534c5..25fcfbe315 100644\n--- a/packages/core/src/client.ts\n+++ b/packages/core/src/client.ts\n@@ -79,6 +79,7 @@ import {\n   CodeChallengeMethod,\n   ProfileResource,\n   QueryTypes,\n+  WithId,\n   arrayBufferToBase64,\n   concatUrls,\n   createReference,\n@@ -710,8 +711,8 @@ export enum OAuthClientAssertionType {\n interface SessionDetails {\n   project: Project;\n   membership: ProjectMembership;\n-  profile: ProfileResource;\n-  config: UserConfiguration;\n+  profile: WithId<ProfileResource>;\n+  config: WithId<UserConfiguration>;\n   accessPolicy: AccessPolicy;\n }\n \n@@ -1048,7 +1049,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @category Caching\n    * @param resourceType - The resource type to invalidate.\n    */\n-  invalidateSearches<K extends ResourceType>(resourceType: K): void {\n+  invalidateSearches(resourceType: ResourceType): void {\n     const url = concatUrls(this.fhirBaseUrl, resourceType);\n     if (this.requestCache) {\n       for (const key of this.requestCache.keys()) {\n@@ -1506,18 +1507,18 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @param options - Optional fetch options.\n    * @returns Promise to the search result bundle.\n    */\n-  search<K extends ResourceType>(\n-    resourceType: K,\n+  search<RT extends ResourceType>(\n+    resourceType: RT,\n     query?: QueryTypes,\n     options?: MedplumRequestOptions\n-  ): ReadablePromise<Bundle<ExtractResource<K>>> {\n+  ): ReadablePromise<Bundle<WithId<ExtractResource<RT>>>> {\n     const url = this.fhirSearchUrl(resourceType, query);\n     const cacheKey = 'search-' + url.toString();\n     const cached = this.getCacheEntry(cacheKey, options);\n     if (cached) {\n       return cached.value;\n     }\n-    const promise = this.getBundle<ExtractResource<K>>(url, options);\n+    const promise = this.getBundle<WithId<ExtractResource<RT>>>(url, options);\n     this.setCacheEntry(cacheKey, promise);\n     return promise;\n   }\n@@ -1544,11 +1545,11 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @param options - Optional fetch options.\n    * @returns Promise to the first search result.\n    */\n-  searchOne<K extends ResourceType>(\n-    resourceType: K,\n+  searchOne<RT extends ResourceType>(\n+    resourceType: RT,\n     query?: QueryTypes,\n     options?: MedplumRequestOptions\n-  ): ReadablePromise<ExtractResource<K> | undefined> {\n+  ): ReadablePromise<WithId<ExtractResource<RT>> | undefined> {\n     const url = this.fhirSearchUrl(resourceType, query);\n     url.searchParams.set('_count', '1');\n     url.searchParams.sort();\n@@ -1558,7 +1559,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n       return cached.value;\n     }\n     const promise = new ReadablePromise(\n-      this.search<K>(resourceType, url.searchParams, options).then((b) => b.entry?.[0]?.resource)\n+      this.search<RT>(resourceType, url.searchParams, options).then((b) => b.entry?.[0]?.resource)\n     );\n     this.setCacheEntry(cacheKey, promise);\n     return promise;\n@@ -1586,18 +1587,18 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @param options - Optional fetch options.\n    * @returns Promise to the array of search results.\n    */\n-  searchResources<K extends ResourceType>(\n-    resourceType: K,\n+  searchResources<RT extends ResourceType>(\n+    resourceType: RT,\n     query?: QueryTypes,\n     options?: MedplumRequestOptions\n-  ): ReadablePromise<ResourceArray<ExtractResource<K>>> {\n+  ): ReadablePromise<ResourceArray<WithId<ExtractResource<RT>>>> {\n     const url = this.fhirSearchUrl(resourceType, query);\n     const cacheKey = 'searchResources-' + url.toString();\n     const cached = this.getCacheEntry(cacheKey, options);\n     if (cached) {\n       return cached.value;\n     }\n-    const promise = new ReadablePromise(this.search<K>(resourceType, query, options).then(bundleToResourceArray));\n+    const promise = new ReadablePromise(this.search<RT>(resourceType, query, options).then(bundleToResourceArray));\n     this.setCacheEntry(cacheKey, promise);\n     return promise;\n   }\n@@ -1626,11 +1627,11 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @param options - Optional fetch options.\n    * @yields An async generator, where each result is an array of resources for each page.\n    */\n-  async *searchResourcePages<K extends ResourceType>(\n-    resourceType: K,\n+  async *searchResourcePages<RT extends ResourceType>(\n+    resourceType: RT,\n     query?: QueryTypes,\n     options?: MedplumRequestOptions\n-  ): AsyncGenerator<ResourceArray<ExtractResource<K>>> {\n+  ): AsyncGenerator<ResourceArray<WithId<ExtractResource<RT>>>> {\n     let url: URL | undefined = this.fhirSearchUrl(resourceType, query);\n \n     while (url) {\n@@ -1667,9 +1668,9 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @param id - The FHIR resource ID.\n    * @returns The resource if it is available in the cache; undefined otherwise.\n    */\n-  getCached<K extends ResourceType>(resourceType: K, id: string): ExtractResource<K> | undefined {\n+  getCached<RT extends ResourceType>(resourceType: RT, id: string): WithId<ExtractResource<RT>> | undefined {\n     const cached = this.requestCache?.get(this.fhirUrl(resourceType, id).toString())?.value;\n-    return cached?.isOk() ? (cached.read() as ExtractResource<K>) : undefined;\n+    return cached?.isOk() ? (cached.read() as WithId<ExtractResource<RT>>) : undefined;\n   }\n \n   /**\n@@ -1711,15 +1712,15 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @param options - Optional fetch options.\n    * @returns The resource if available.\n    */\n-  readResource<K extends ResourceType>(\n-    resourceType: K,\n+  readResource<RT extends ResourceType>(\n+    resourceType: RT,\n     id: string,\n     options?: MedplumRequestOptions\n-  ): ReadablePromise<ExtractResource<K>> {\n+  ): ReadablePromise<WithId<ExtractResource<RT>>> {\n     if (!id) {\n       throw new Error('The \"id\" parameter cannot be null, undefined, or an empty string.');\n     }\n-    return this.get<ExtractResource<K>>(this.fhirUrl(resourceType, id), options);\n+    return this.get<WithId<ExtractResource<RT>>>(this.fhirUrl(resourceType, id), options);\n   }\n \n   /**\n@@ -1742,19 +1743,22 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @param options - Optional fetch options.\n    * @returns The resource if available.\n    */\n-  readReference<T extends Resource>(reference: Reference<T>, options?: MedplumRequestOptions): ReadablePromise<T> {\n+  readReference<T extends Resource>(\n+    reference: Reference<T>,\n+    options?: MedplumRequestOptions\n+  ): ReadablePromise<WithId<T>> {\n     const refString = reference.reference;\n     if (!refString) {\n       return new ReadablePromise(Promise.reject(new Error('Missing reference')));\n     }\n     if (refString === 'system') {\n-      return new ReadablePromise(Promise.resolve(system as unknown as T));\n+      return new ReadablePromise(Promise.resolve(system as unknown as WithId<T>));\n     }\n     const [resourceType, id] = refString.split('/');\n     if (!resourceType || !id) {\n       return new ReadablePromise(Promise.reject(new Error('Invalid reference')));\n     }\n-    return this.readResource(resourceType as ResourceType, id, options) as ReadablePromise<T>;\n+    return this.readResource(resourceType as ResourceType, id, options) as ReadablePromise<WithId<T>>;\n   }\n \n   /**\n@@ -1899,11 +1903,11 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @param options - Optional fetch options.\n    * @returns Promise to the resource history.\n    */\n-  readHistory<K extends ResourceType>(\n-    resourceType: K,\n+  readHistory<RT extends ResourceType>(\n+    resourceType: RT,\n     id: string,\n     options?: MedplumRequestOptions\n-  ): ReadablePromise<Bundle<ExtractResource<K>>> {\n+  ): ReadablePromise<Bundle<WithId<ExtractResource<RT>>>> {\n     return this.get(this.fhirUrl(resourceType, id, '_history'), options);\n   }\n \n@@ -1926,12 +1930,12 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @param options - Optional fetch options.\n    * @returns The resource if available.\n    */\n-  readVersion<K extends ResourceType>(\n-    resourceType: K,\n+  readVersion<RT extends ResourceType>(\n+    resourceType: RT,\n     id: string,\n     vid: string,\n     options?: MedplumRequestOptions\n-  ): ReadablePromise<ExtractResource<K>> {\n+  ): ReadablePromise<WithId<ExtractResource<RT>>> {\n     return this.get(this.fhirUrl(resourceType, id, '_history', vid), options);\n   }\n \n@@ -2004,7 +2008,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @param options - Optional fetch options.\n    * @returns The result of the create operation.\n    */\n-  createResource<T extends Resource>(resource: T, options?: MedplumRequestOptions): Promise<T> {\n+  createResource<T extends Resource>(resource: T, options?: MedplumRequestOptions): Promise<WithId<T>> {\n     if (!resource.resourceType) {\n       throw new Error('Missing resourceType');\n     }\n@@ -2057,7 +2061,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n     resource: T,\n     query: string,\n     options?: MedplumRequestOptions\n-  ): Promise<T> {\n+  ): Promise<WithId<T>> {\n     const url = this.fhirUrl(resource.resourceType);\n     if (!options) {\n       options = { headers: { 'If-None-Exist': query } };\n@@ -2090,7 +2094,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n     resource: T,\n     query: QueryTypes,\n     options?: MedplumRequestOptions\n-  ): Promise<T> {\n+  ): Promise<WithId<T>> {\n     // Build conditional update URL, e.g. `PUT /ResourceType?search-param=value`\n     const url = this.fhirSearchUrl(resource.resourceType, query);\n \n@@ -2195,7 +2199,10 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @param requestOptions - Optional fetch options. **NOTE:** only `options.signal` is respected when `onProgress` is also provided.\n    * @returns The result of the create operation.\n    */\n-  createBinary(createBinaryOptions: CreateBinaryOptions, requestOptions: MedplumRequestOptions = {}): Promise<Binary> {\n+  createBinary(\n+    createBinaryOptions: CreateBinaryOptions,\n+    requestOptions: MedplumRequestOptions = {}\n+  ): Promise<WithId<Binary>> {\n     const { data, contentType, filename, securityContext, onProgress } = createBinaryOptions;\n \n     const url = this.fhirUrl('Binary');\n@@ -2298,7 +2305,10 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @param requestOptions - Optional fetch options.\n    * @returns The result of the create operation.\n    */\n-  async createPdf(createPdfOptions: CreatePdfOptions, requestOptions: MedplumRequestOptions = {}): Promise<Binary> {\n+  async createPdf(\n+    createPdfOptions: CreatePdfOptions,\n+    requestOptions: MedplumRequestOptions = {}\n+  ): Promise<WithId<Binary>> {\n     if (!this.createPdfImpl) {\n       throw new Error('PDF creation not enabled');\n     }\n@@ -2318,7 +2328,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @param options - Optional fetch options.\n    * @returns The result of the create operation.\n    */\n-  createComment(resource: Resource, text: string, options?: MedplumRequestOptions): Promise<Communication> {\n+  createComment(resource: Resource, text: string, options?: MedplumRequestOptions): Promise<WithId<Communication>> {\n     const profile = this.getProfile();\n     let encounter: Reference<Encounter> | undefined = undefined;\n     let subject: Reference<Patient> | undefined = undefined;\n@@ -2337,7 +2347,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n       subject = createReference(resource);\n     }\n \n-    return this.createResource<Communication>(\n+    return this.createResource(\n       {\n         resourceType: 'Communication',\n         status: 'completed',\n@@ -2378,7 +2388,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @param options - Optional fetch options.\n    * @returns The result of the update operation.\n    */\n-  async updateResource<T extends Resource>(resource: T, options?: MedplumRequestOptions): Promise<T> {\n+  async updateResource<T extends Resource>(resource: T, options?: MedplumRequestOptions): Promise<WithId<T>> {\n     if (!resource.resourceType) {\n       throw new Error('Missing resourceType');\n     }\n@@ -2422,12 +2432,12 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @param options - Optional fetch options.\n    * @returns The result of the patch operations.\n    */\n-  async patchResource<K extends ResourceType>(\n-    resourceType: K,\n+  async patchResource<RT extends ResourceType>(\n+    resourceType: RT,\n     id: string,\n     operations: PatchOperation[],\n     options?: MedplumRequestOptions\n-  ): Promise<ExtractResource<K>> {\n+  ): Promise<WithId<ExtractResource<RT>>> {\n     const result = await this.patch(this.fhirUrl(resourceType, id), operations, options);\n     this.cacheResource(result);\n     this.invalidateUrl(this.fhirUrl(resourceType, id, '_history'));\n@@ -2671,8 +2681,8 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @param options - Optional fetch options.\n    * @returns A Bundle\n    */\n-  readResourceGraph<K extends ResourceType>(\n-    resourceType: K,\n+  readResourceGraph(\n+    resourceType: ResourceType,\n     id: string,\n     graphName: string,\n     options?: MedplumRequestOptions\n@@ -2787,7 +2797,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n     this.storage.setObject('logins', logins);\n   }\n \n-  private async refreshProfile(): Promise<ProfileResource | undefined> {\n+  private async refreshProfile(): Promise<WithId<ProfileResource> | undefined> {\n     if (!this.medplumServer) {\n       return Promise.resolve(undefined);\n     }\n@@ -2872,7 +2882,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @returns The current user profile resource.\n    * @category User Profile\n    */\n-  async getProfileAsync(): Promise<ProfileResource | undefined> {\n+  async getProfileAsync(): Promise<WithId<ProfileResource> | undefined> {\n     if (this.profilePromise) {\n       return this.profilePromise;\n     }\n@@ -2887,7 +2897,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @returns The current user configuration if available.\n    * @category User Profile\n    */\n-  getUserConfiguration(): UserConfiguration | undefined {\n+  getUserConfiguration(): WithId<UserConfiguration> | undefined {\n     return this.sessionDetails?.config;\n   }\n \n\ndiff --git a/packages/core/src/fhirpath/atoms.ts b/packages/core/src/fhirpath/atoms.ts\nindex a043c6dd08..a25d33b3e4 100644\n--- a/packages/core/src/fhirpath/atoms.ts\n+++ b/packages/core/src/fhirpath/atoms.ts\n@@ -1,3 +1,4 @@\n+import { ResourceType } from '@medplum/fhirtypes';\n import { Atom, AtomContext, InfixOperatorAtom, PrefixOperatorAtom } from '../fhirlexer/parse';\n import { PropertyType, TypedValue, isResource } from '../types';\n import { functions } from './functions';\n@@ -92,7 +93,7 @@ export class SymbolAtom implements Atom {\n       return undefined;\n     }\n \n-    if (isResource(input) && input.resourceType === this.name) {\n+    if (isResource(input, this.name as ResourceType)) {\n       return typedValue;\n     }\n \n\ndiff --git a/packages/core/src/types.ts b/packages/core/src/types.ts\nindex 8fd8bde71c..5d90679b4a 100644\n--- a/packages/core/src/types.ts\n+++ b/packages/core/src/types.ts\n@@ -12,7 +12,7 @@ import {\n import { formatHumanName } from './format';\n import { SearchParameterDetails } from './search/details';\n import { InternalSchemaElement, InternalTypeSchema, getAllDataTypes, tryGetDataType } from './typeschema/types';\n-import { capitalize, createReference } from './utils';\n+import { capitalize, getReferenceString, isResourceWithId } from './utils';\n \n export type TypeName<T> = T extends string\n   ? 'string'\n@@ -418,16 +418,26 @@ export function getElementDefinitionFromElements(\n }\n \n /**\n- * Typeguard to validate that an object is a FHIR resource\n+ * Type guard to validate that an object is a FHIR resource\n  * @param value - The object to check\n+ * @param resourceType - Checks that the resource is of the given type\n  * @returns True if the input is of type 'object' and contains property 'resourceType'\n  */\n-export function isResource(value: unknown): value is Resource {\n-  return !!(value && typeof value === 'object' && 'resourceType' in value);\n+export function isResource<T extends Resource>(value: unknown, resourceType?: T['resourceType']): value is T {\n+  if (!value || typeof value !== 'object') {\n+    return false;\n+  }\n+  if (!('resourceType' in value)) {\n+    return false;\n+  }\n+  if (resourceType && value.resourceType !== resourceType) {\n+    return false;\n+  }\n+  return true;\n }\n \n /**\n- * Typeguard to validate that an object is a FHIR resource\n+ * Type guard to validate that an object is a FHIR reference\n  * @param value - The object to check\n  * @returns True if the input is of type 'object' and contains property 'reference'\n  */\n@@ -493,8 +503,8 @@ export function stringifyTypedValue(v: TypedValue): string {\n     case PropertyType.Reference:\n       return v.value.reference;\n     default:\n-      if (isResource(v.value)) {\n-        return createReference(v.value).reference;\n+      if (isResourceWithId(v.value)) {\n+        return getReferenceString(v.value);\n       }\n       return JSON.stringify(v);\n   }\n\ndiff --git a/packages/core/src/utils.ts b/packages/core/src/utils.ts\nindex 9a7149f760..d6caa190ad 100644\n--- a/packages/core/src/utils.ts\n+++ b/packages/core/src/utils.ts\n@@ -22,7 +22,7 @@ import {\n import { getTypedPropertyValue } from './fhirpath/utils';\n import { formatCodeableConcept, formatHumanName } from './format';\n import { OperationOutcomeError, validationError } from './outcomes';\n-import { isReference } from './types';\n+import { isReference, isResource } from './types';\n \n /**\n  * QueryTypes defines the different ways to specify FHIR search parameters.\n@@ -54,13 +54,22 @@ export interface Code {\n \n export type ResourceWithCode = Resource & Code;\n \n+export type WithId<T> = T & { id: string };\n+\n+export function isResourceWithId<T extends Resource>(\n+  resource: unknown,\n+  resourceType?: T['resourceType']\n+): resource is WithId<T> {\n+  return isResource(resource, resourceType) && 'id' in resource && typeof resource.id === 'string';\n+}\n+\n /**\n  * Creates a reference resource.\n  * @param resource - The FHIR resource.\n  * @returns A reference resource.\n  */\n export function createReference<T extends Resource>(resource: T): Reference<T> & { reference: string } {\n-  const reference = getReferenceString(resource);\n+  const reference = getReferenceString(resource) ?? 'undefined/undefined';\n   const display = getDisplayString(resource);\n   return display === reference ? { reference } : { reference, display };\n }\n@@ -70,11 +79,18 @@ export function createReference<T extends Resource>(resource: T): Reference<T> &\n  * @param input - The FHIR resource or reference.\n  * @returns A reference string of the form resourceType/id.\n  */\n-export function getReferenceString(input: Reference | Resource): string {\n+export function getReferenceString(input: (Reference & { reference: string }) | WithId<Resource>): string;\n+export function getReferenceString(input: Reference | Resource): string | undefined;\n+export function getReferenceString(\n+  input: Reference | Resource | (Reference & { reference: string }) | WithId<Resource>\n+): string | undefined {\n   if (isReference(input)) {\n     return input.reference;\n   }\n-  return `${(input as Resource).resourceType}/${input.id}`;\n+  if (isResourceWithId(input)) {\n+    return `${(input as Resource).resourceType}/${input.id}`;\n+  }\n+  return undefined;\n }\n \n /**\n@@ -163,7 +179,7 @@ export function getDisplayString(resource: Resource): string {\n       return code.text;\n     }\n   }\n-  return getReferenceString(resource);\n+  return getReferenceString(resource) ?? '';\n }\n \n /**\n\ndiff --git a/packages/fhir-router/src/batch.ts b/packages/fhir-router/src/batch.ts\nindex c950ad7dc6..a00b215bdf 100644\n--- a/packages/fhir-router/src/batch.ts\n+++ b/packages/fhir-router/src/batch.ts\n@@ -8,6 +8,7 @@ import {\n   Event,\n   normalizeOperationOutcome,\n   notFound,\n+  WithId,\n } from '@medplum/core';\n import {\n   Bundle,\n@@ -280,7 +281,7 @@ class BatchProcessor {\n     }\n     if (entry.resource) {\n       entry.resource.id = this.repo.generateId();\n-      return { placeholder, reference: getReferenceString(entry.resource) };\n+      return { placeholder, reference: getReferenceString(entry.resource as WithId<Resource>) };\n     }\n     return undefined;\n   }\n@@ -317,7 +318,7 @@ class BatchProcessor {\n               }\n \n               entry.resource.id = this.repo.generateId();\n-              return { placeholder, reference: getReferenceString(entry.resource) };\n+              return { placeholder, reference: getReferenceString(entry.resource as WithId<Resource>) };\n             }\n             return undefined;\n           default:\n\ndiff --git a/packages/fhir-router/src/fhirrouter.ts b/packages/fhir-router/src/fhirrouter.ts\nindex 919571b029..239ec414db 100644\n--- a/packages/fhir-router/src/fhirrouter.ts\n+++ b/packages/fhir-router/src/fhirrouter.ts\n@@ -177,21 +177,21 @@ export async function createResourceImpl<T extends Resource>(\n // Read resource by ID\n async function readResourceById(req: FhirRequest, repo: FhirRepository): Promise<FhirResponse> {\n   const { resourceType, id } = req.params;\n-  const resource = await repo.readResource(resourceType, id);\n+  const resource = await repo.readResource(resourceType as ResourceType, id);\n   return [allOk, resource];\n }\n \n // Read resource history\n async function readHistory(req: FhirRequest, repo: FhirRepository): Promise<FhirResponse> {\n   const { resourceType, id } = req.params;\n-  const bundle = await repo.readHistory(resourceType, id);\n+  const bundle = await repo.readHistory(resourceType as ResourceType, id);\n   return [allOk, bundle];\n }\n \n // Read resource version by version ID\n async function readVersion(req: FhirRequest, repo: FhirRepository): Promise<FhirResponse> {\n   const { resourceType, id, vid } = req.params;\n-  const resource = await repo.readVersion(resourceType, id, vid);\n+  const resource = await repo.readVersion(resourceType as ResourceType, id, vid);\n   return [allOk, resource];\n }\n \n@@ -262,7 +262,7 @@ async function patchResource(req: FhirRequest, repo: FhirRepository): Promise<Fh\n   if (!Array.isArray(patch)) {\n     return [badRequest('Patch body must be an array')];\n   }\n-  const resource = await repo.patchResource(resourceType, id, patch);\n+  const resource = await repo.patchResource(resourceType as ResourceType, id, patch);\n   return [allOk, resource];\n }\n \n\ndiff --git a/packages/fhir-router/src/graphql/utils.ts b/packages/fhir-router/src/graphql/utils.ts\nindex b4832b6c15..d811cb08ce 100644\n--- a/packages/fhir-router/src/graphql/utils.ts\n+++ b/packages/fhir-router/src/graphql/utils.ts\n@@ -78,7 +78,7 @@ function parseSearchArgsWithReference(\n     referenceFilter = {\n       code: reference,\n       operator: Operator.EQUALS,\n-      value: getReferenceString(source as Resource),\n+      value: getReferenceString(source),\n     };\n   }\n \n\ndiff --git a/packages/fhir-router/src/repo.ts b/packages/fhir-router/src/repo.ts\nindex e577478ead..5b496decb5 100644\n--- a/packages/fhir-router/src/repo.ts\n+++ b/packages/fhir-router/src/repo.ts\n@@ -3,6 +3,7 @@ import {\n   Operator,\n   SearchRequest,\n   SortRule,\n+  WithId,\n   allOk,\n   badRequest,\n   created,\n@@ -17,7 +18,7 @@ import {\n   preconditionFailed,\n   stringify,\n } from '@medplum/core';\n-import { Bundle, BundleEntry, OperationOutcome, Reference, Resource } from '@medplum/fhirtypes';\n+import { Bundle, OperationOutcome, Reference, Resource } from '@medplum/fhirtypes';\n import { Operation, applyPatch } from 'rfc6902';\n \n export type CreateResourceOptions = {\n@@ -61,7 +62,7 @@ export abstract class FhirRepository<TClient = unknown> {\n    * @param resource - The FHIR resource to create.\n    * @returns The created resource.\n    */\n-  abstract createResource<T extends Resource>(resource: T, options?: CreateResourceOptions): Promise<T>;\n+  abstract createResource<T extends Resource>(resource: T, options?: CreateResourceOptions): Promise<WithId<T>>;\n \n   /**\n    * Generates a new unique ID for a resource.\n@@ -79,7 +80,7 @@ export abstract class FhirRepository<TClient = unknown> {\n    * @param id - The FHIR resource ID.\n    * @returns The FHIR resource.\n    */\n-  abstract readResource<T extends Resource>(resourceType: string, id: string): Promise<T>;\n+  abstract readResource<T extends Resource>(resourceType: string, id: string): Promise<WithId<T>>;\n \n   /**\n    * Reads a FHIR resource by reference.\n@@ -88,7 +89,7 @@ export abstract class FhirRepository<TClient = unknown> {\n    * @param reference - The FHIR reference.\n    * @returns The FHIR resource.\n    */\n-  abstract readReference<T extends Resource>(reference: Reference<T>): Promise<T>;\n+  abstract readReference<T extends Resource>(reference: Reference<T>): Promise<WithId<T>>;\n \n   /**\n    * Reads a collection of FHIR resources by reference.\n@@ -97,7 +98,7 @@ export abstract class FhirRepository<TClient = unknown> {\n    * @param references - The FHIR references.\n    * @returns The FHIR resources.\n    */\n-  abstract readReferences(references: readonly Reference[]): Promise<(Resource | Error)[]>;\n+  abstract readReferences<T extends Resource>(references: readonly Reference<T>[]): Promise<(T | Error)[]>;\n \n   /**\n    * Returns resource history.\n@@ -109,7 +110,7 @@ export abstract class FhirRepository<TClient = unknown> {\n    * @param id - The FHIR resource ID.\n    * @returns Operation outcome and a history bundle.\n    */\n-  abstract readHistory<T extends Resource>(resourceType: string, id: string): Promise<Bundle<T>>;\n+  abstract readHistory<T extends Resource>(resourceType: string, id: string): Promise<Bundle<WithId<T>>>;\n \n   /**\n    * Reads a FHIR resource version.\n@@ -119,7 +120,7 @@ export abstract class FhirRepository<TClient = unknown> {\n    * @param id - The FHIR resource ID.\n    * @param vid - The FHIR resource version ID.\n    */\n-  abstract readVersion<T extends Resource>(resourceType: string, id: string, vid: string): Promise<T>;\n+  abstract readVersion<T extends Resource>(resourceType: string, id: string, vid: string): Promise<WithId<T>>;\n \n   /**\n    * Updates a FHIR resource.\n@@ -128,7 +129,7 @@ export abstract class FhirRepository<TClient = unknown> {\n    * @param resource - The FHIR resource to update.\n    * @returns The updated resource.\n    */\n-  abstract updateResource<T extends Resource>(resource: T, options?: UpdateResourceOptions): Promise<T>;\n+  abstract updateResource<T extends Resource>(resource: T, options?: UpdateResourceOptions): Promise<WithId<T>>;\n \n   /**\n    * Deletes a FHIR resource.\n@@ -148,7 +149,11 @@ export abstract class FhirRepository<TClient = unknown> {\n    * @param patch - The JSONPatch operations.\n    * @returns The patched resource.\n    */\n-  abstract patchResource(resourceType: string, id: string, patch: Operation[]): Promise<Resource>;\n+  abstract patchResource<T extends Resource>(\n+    resourceType: T['resourceType'],\n+    id: string,\n+    patch: Operation[]\n+  ): Promise<WithId<T>>;\n \n   /**\n    * Searches for FHIR resources.\n@@ -157,13 +162,13 @@ export abstract class FhirRepository<TClient = unknown> {\n    * @param searchRequest - The FHIR search request.\n    * @returns The search results.\n    */\n-  abstract search<T extends Resource>(searchRequest: SearchRequest<T>): Promise<Bundle<T>>;\n+  abstract search<T extends Resource>(searchRequest: SearchRequest<T>): Promise<Bundle<WithId<T>>>;\n \n   abstract searchByReference<T extends Resource>(\n     searchRequest: SearchRequest<T>,\n     referenceField: string,\n     references: string[]\n-  ): Promise<Record<string, T[]>>;\n+  ): Promise<Record<string, WithId<T>[]>>;\n \n   /**\n    * Runs a callback function within a transaction.\n@@ -186,9 +191,9 @@ export abstract class FhirRepository<TClient = unknown> {\n    * @param searchRequest - The FHIR search request.\n    * @returns Promise to the first search result or undefined.\n    */\n-  async searchOne<T extends Resource>(searchRequest: SearchRequest<T>): Promise<T | undefined> {\n+  async searchOne<T extends Resource>(searchRequest: SearchRequest<T>): Promise<WithId<T> | undefined> {\n     const bundle = await this.search({ ...searchRequest, count: 1 });\n-    return bundle.entry?.[0]?.resource as T | undefined;\n+    return bundle.entry?.[0]?.resource;\n   }\n \n   /**\n@@ -202,9 +207,9 @@ export abstract class FhirRepository<TClient = unknown> {\n    * @param searchRequest - The FHIR search request.\n    * @returns Promise to the array of search results.\n    */\n-  async searchResources<T extends Resource>(searchRequest: SearchRequest<T>): Promise<T[]> {\n+  async searchResources<T extends Resource>(searchRequest: SearchRequest<T>): Promise<WithId<T>[]> {\n     const bundle = await this.search(searchRequest);\n-    return bundle.entry?.map((e) => e.resource as T) ?? [];\n+    return bundle.entry?.map((e) => e.resource as WithId<T>) ?? [];\n   }\n \n   async conditionalCreate<T extends Resource>(\n@@ -323,7 +328,7 @@ export class MemoryRepository extends FhirRepository<undefined> {\n     // MockRepository ignores reader/writer mode\n   }\n \n-  async createResource<T extends Resource>(resource: T): Promise<T> {\n+  async createResource<T extends Resource>(resource: T): Promise<WithId<T>> {\n     const result = JSON.parse(stringify(resource));\n \n     if (!result.id) {\n@@ -367,7 +372,7 @@ export class MemoryRepository extends FhirRepository<undefined> {\n     return generateId();\n   }\n \n-  updateResource<T extends Resource>(resource: T, options?: UpdateResourceOptions): Promise<T> {\n+  updateResource<T extends Resource>(resource: T, options?: UpdateResourceOptions): Promise<WithId<T>> {\n     if (!resource.id) {\n       throw new OperationOutcomeError(badRequest('Missing id'));\n     }\n@@ -396,8 +401,12 @@ export class MemoryRepository extends FhirRepository<undefined> {\n     return this.createResource(result);\n   }\n \n-  async patchResource(resourceType: string, id: string, patch: Operation[]): Promise<Resource> {\n-    const resource = await this.readResource(resourceType, id);\n+  async patchResource<T extends Resource>(\n+    resourceType: T['resourceType'],\n+    id: string,\n+    patch: Operation[]\n+  ): Promise<WithId<T>> {\n+    const resource = await this.readResource<T>(resourceType, id);\n \n     try {\n       const patchResult = applyPatch(resource, patch).filter(Boolean);\n@@ -408,7 +417,7 @@ export class MemoryRepository extends FhirRepository<undefined> {\n       throw new OperationOutcomeError(normalizeOperationOutcome(err));\n     }\n \n-    return this.updateResource(resource);\n+    return this.updateResource<T>(resource);\n   }\n \n   async readResource<T extends Resource>(resourceType: string, id: string): Promise<T> {\n@@ -419,7 +428,7 @@ export class MemoryRepository extends FhirRepository<undefined> {\n     return deepClone(resource);\n   }\n \n-  async readReference<T extends Resource>(reference: Reference<T>): Promise<T> {\n+  async readReference<T extends Resource>(reference: Reference<T>): Promise<WithId<T>> {\n     const parts = reference.reference?.split('/');\n     if (!parts || parts.length !== 2) {\n       throw new OperationOutcomeError(badRequest('Invalid reference'));\n@@ -427,8 +436,10 @@ export class MemoryRepository extends FhirRepository<undefined> {\n     return this.readResource(parts[0], parts[1]);\n   }\n \n-  async readReferences(references: readonly Reference[]): Promise<(Resource | OperationOutcomeError)[]> {\n-    return Promise.all(references.map((r) => this.readReference(r)));\n+  async readReferences<T extends Resource>(\n+    references: readonly Reference<T>[]\n+  ): Promise<(T | OperationOutcomeError)[]> {\n+    return Promise.all(references.map((r) => this.readReference<T>(r)));\n   }\n \n   async readHistory<T extends Resource>(resourceType: string, id: string): Promise<Bundle<T>> {\n@@ -455,7 +466,7 @@ export class MemoryRepository extends FhirRepository<undefined> {\n     return deepClone(version);\n   }\n \n-  async search<T extends Resource>(searchRequest: SearchRequest<T>): Promise<Bundle<T>> {\n+  async search<T extends Resource>(searchRequest: SearchRequest<T>): Promise<Bundle<WithId<T>>> {\n     const { resourceType } = searchRequest;\n     const resources = this.resources.get(resourceType) ?? new Map();\n     const result = [];\n@@ -464,7 +475,7 @@ export class MemoryRepository extends FhirRepository<undefined> {\n         result.push(resource);\n       }\n     }\n-    let entry = result.map((resource): BundleEntry<T> => ({ resource: deepClone(resource) }));\n+    let entry = result.map((resource) => ({ resource: deepClone(resource) }));\n     if (searchRequest.sortRules) {\n       for (const sortRule of searchRequest.sortRules) {\n         entry = entry.sort((a, b) => sortComparator(a.resource as T, b.resource as T, sortRule));\n@@ -479,7 +490,7 @@ export class MemoryRepository extends FhirRepository<undefined> {\n     return {\n       resourceType: 'Bundle',\n       type: 'searchset',\n-      ...(entry.length ? { entry } : undefined),\n+      entry: entry.length ? entry : undefined,\n       total: result.length,\n     };\n   }\n@@ -488,9 +499,9 @@ export class MemoryRepository extends FhirRepository<undefined> {\n     searchRequest: SearchRequest<T>,\n     referenceField: string,\n     references: string[]\n-  ): Promise<Record<string, T[]>> {\n+  ): Promise<Record<string, WithId<T>[]>> {\n     searchRequest.filters ??= [];\n-    const results: Record<string, T[]> = {};\n+    const results: Record<string, WithId<T>[]> = {};\n     for (const reference of references) {\n       searchRequest.filters.push({ code: referenceField, operator: Operator.EQUALS, value: reference });\n       const bundle = await this.search(searchRequest);\n\ndiff --git a/packages/health-gorilla-react/src/autocomplete-endpoint.ts b/packages/health-gorilla-react/src/autocomplete-endpoint.ts\nindex 498bd5e2cc..7f02445b0e 100644\n--- a/packages/health-gorilla-react/src/autocomplete-endpoint.ts\n+++ b/packages/health-gorilla-react/src/autocomplete-endpoint.ts\n@@ -30,7 +30,7 @@ export function getAutocompleteSearchFunction(\n     const { result } = botResponse;\n     switch (botResponse.type) {\n       case 'lab': {\n-        if (Array.isArray(result) && result.every((item) => isResource(item) && item.resourceType === 'Organization')) {\n+        if (Array.isArray(result) && result.every((item) => isResource(item, 'Organization'))) {\n           return { type: 'lab', result } as LabSearchResult;\n         }\n         break;\n\ndiff --git a/packages/mock/src/client.ts b/packages/mock/src/client.ts\nindex 9391770c14..2707018be4 100644\n--- a/packages/mock/src/client.ts\n+++ b/packages/mock/src/client.ts\n@@ -9,6 +9,7 @@ import {\n   OperationOutcomeError,\n   ProfileResource,\n   SubscriptionEmitter,\n+  WithId,\n   allOk,\n   badRequest,\n   generateId,\n@@ -178,9 +179,10 @@ export class MockClient extends MedplumClient {\n     return this.profile;\n   }\n \n-  getUserConfiguration(): UserConfiguration | undefined {\n+  getUserConfiguration(): WithId<UserConfiguration> | undefined {\n     return {\n       resourceType: 'UserConfiguration',\n+      id: 'mock-user-config',\n       menu: [\n         {\n           title: 'Favorites',\n@@ -229,7 +231,7 @@ export class MockClient extends MedplumClient {\n     arg2: string | undefined | MedplumRequestOptions,\n     arg3?: string,\n     arg4?: (e: ProgressEvent) => void\n-  ): Promise<Binary> {\n+  ): Promise<WithId<Binary>> {\n     const createBinaryOptions = normalizeCreateBinaryOptions(arg1, arg2, arg3, arg4);\n     const { filename, contentType, onProgress } = createBinaryOptions;\n \n@@ -245,6 +247,7 @@ export class MockClient extends MedplumClient {\n \n     return {\n       resourceType: 'Binary',\n+      id: 'mock-binary',\n       contentType,\n       url: 'https://example.com/binary/123',\n     };\n\ndiff --git a/packages/mock/src/mocks/accesspolicy.ts b/packages/mock/src/mocks/accesspolicy.ts\nindex f9dec750a4..6f7f2fa71a 100644\n--- a/packages/mock/src/mocks/accesspolicy.ts\n+++ b/packages/mock/src/mocks/accesspolicy.ts\n@@ -1,12 +1,13 @@\n+import { WithId } from '@medplum/core';\n import { AccessPolicy, UserConfiguration, ValueSet } from '@medplum/fhirtypes';\n \n-export const ExampleAccessPolicy: AccessPolicy = {\n+export const ExampleAccessPolicy: WithId<AccessPolicy> = {\n   resourceType: 'AccessPolicy',\n   id: '123',\n   name: 'Example Access Policy',\n };\n \n-export const ExampleStatusValueSet: ValueSet = {\n+export const ExampleStatusValueSet: WithId<ValueSet> = {\n   resourceType: 'ValueSet',\n   id: 'example-statuses',\n   status: 'active',\n@@ -25,7 +26,7 @@ export const ExampleStatusValueSet: ValueSet = {\n   },\n };\n \n-export const ExampleUserConfiguration: UserConfiguration = {\n+export const ExampleUserConfiguration: WithId<UserConfiguration> = {\n   resourceType: 'UserConfiguration',\n   id: '123',\n   name: 'Example User Configuration',\n\ndiff --git a/packages/mock/src/mocks/alice.ts b/packages/mock/src/mocks/alice.ts\nindex 5650b54b92..e9f98e2505 100644\n--- a/packages/mock/src/mocks/alice.ts\n+++ b/packages/mock/src/mocks/alice.ts\n@@ -1,7 +1,7 @@\n-import { lazy, ContentType, createReference } from '@medplum/core';\n+import { lazy, ContentType, createReference, WithId } from '@medplum/core';\n import { Organization, Practitioner, Schedule, Slot } from '@medplum/fhirtypes';\n \n-export const TestOrganization: Organization = {\n+export const TestOrganization: WithId<Organization> = {\n   resourceType: 'Organization',\n   id: '123',\n   meta: {\n@@ -10,7 +10,7 @@ export const TestOrganization: Organization = {\n   name: 'Test Organization',\n };\n \n-export const DifferentOrganization: Organization = {\n+export const DifferentOrganization: WithId<Organization> = {\n   resourceType: 'Organization',\n   id: '456',\n   meta: {\n@@ -19,7 +19,7 @@ export const DifferentOrganization: Organization = {\n   name: 'Different',\n };\n \n-export const DrAliceSmith: Practitioner = {\n+export const DrAliceSmith: WithId<Practitioner> = {\n   resourceType: 'Practitioner',\n   id: '123',\n   meta: {\n@@ -43,7 +43,7 @@ export const DrAliceSmith: Practitioner = {\n   ],\n };\n \n-export const DrAliceSmithPreviousVersion: Practitioner = {\n+export const DrAliceSmithPreviousVersion: WithId<Practitioner> = {\n   resourceType: 'Practitioner',\n   id: '123',\n   meta: {\n@@ -56,7 +56,7 @@ export const DrAliceSmithPreviousVersion: Practitioner = {\n   name: [{ given: ['Medplum'], family: 'Admin' }],\n };\n \n-export const DrAliceSmithSchedule: Schedule = {\n+export const DrAliceSmithSchedule: WithId<Schedule> = {\n   resourceType: 'Schedule',\n   id: 'alice-smith-schedule',\n   actor: [\n@@ -67,9 +67,9 @@ export const DrAliceSmithSchedule: Schedule = {\n   ],\n };\n \n-export const makeDrAliceSmithSlots = lazy((): Slot[] => {\n+export const makeDrAliceSmithSlots = lazy((): WithId<Slot>[] => {\n   const schedule = createReference(DrAliceSmithSchedule);\n-  const result: Slot[] = [];\n+  const result: (Slot & { id: string })[] = [];\n   const slotDate = new Date();\n   for (let day = 0; day < 60; day++) {\n     for (const hour of [9, 10, 11, 13, 14, 15]) {\n\ndiff --git a/packages/mock/src/mocks/workflow.ts b/packages/mock/src/mocks/workflow.ts\nindex a00ea87b3a..3e711818e3 100644\n--- a/packages/mock/src/mocks/workflow.ts\n+++ b/packages/mock/src/mocks/workflow.ts\n@@ -1,9 +1,9 @@\n-import { createReference, getReferenceString } from '@medplum/core';\n+import { createReference, getReferenceString, WithId } from '@medplum/core';\n import { PlanDefinition, Questionnaire, QuestionnaireResponse, RequestGroup, Task } from '@medplum/fhirtypes';\n import { DrAliceSmith } from './alice';\n import { HomerSimpson } from './simpsons';\n \n-export const ExampleWorkflowQuestionnaire1: Questionnaire = {\n+export const ExampleWorkflowQuestionnaire1: WithId<Questionnaire> = {\n   resourceType: 'Questionnaire',\n   id: 'workflow-questionnaire-1',\n   status: 'active',\n@@ -19,7 +19,7 @@ export const ExampleWorkflowQuestionnaire1: Questionnaire = {\n   ],\n };\n \n-export const ExampleWorkflowQuestionnaire2: Questionnaire = {\n+export const ExampleWorkflowQuestionnaire2: WithId<Questionnaire> = {\n   resourceType: 'Questionnaire',\n   id: 'workflow-questionnaire-2',\n   status: 'active',\n@@ -35,7 +35,7 @@ export const ExampleWorkflowQuestionnaire2: Questionnaire = {\n   ],\n };\n \n-export const ExampleWorkflowQuestionnaire3: Questionnaire = {\n+export const ExampleWorkflowQuestionnaire3: WithId<Questionnaire> = {\n   resourceType: 'Questionnaire',\n   id: 'workflow-questionnaire-3',\n   status: 'active',\n@@ -51,7 +51,7 @@ export const ExampleWorkflowQuestionnaire3: Questionnaire = {\n   ],\n };\n \n-export const ExampleWorkflowPlanDefinition: PlanDefinition = {\n+export const ExampleWorkflowPlanDefinition: WithId<PlanDefinition> = {\n   resourceType: 'PlanDefinition',\n   id: 'workflow-plan-definition-1',\n   status: 'active',\n@@ -72,7 +72,7 @@ export const ExampleWorkflowPlanDefinition: PlanDefinition = {\n   ],\n };\n \n-export const ExampleWorkflowQuestionnaireResponse1: QuestionnaireResponse = {\n+export const ExampleWorkflowQuestionnaireResponse1: WithId<QuestionnaireResponse> = {\n   resourceType: 'QuestionnaireResponse',\n   id: 'workflow-questionnaire-response-1',\n   status: 'completed',\n@@ -82,7 +82,7 @@ export const ExampleWorkflowQuestionnaireResponse1: QuestionnaireResponse = {\n };\n \n // Based on: http://build.fhir.org/ig/HL7/sdc/Task-example.json.html\n-export const ExampleWorkflowTask1: Task = {\n+export const ExampleWorkflowTask1: WithId<Task> = {\n   resourceType: 'Task',\n   id: 'workflow-task-1',\n   status: 'completed',\n@@ -103,7 +103,7 @@ export const ExampleWorkflowTask1: Task = {\n   ],\n };\n \n-export const ExampleWorkflowTask2: Task = {\n+export const ExampleWorkflowTask2: WithId<Task> = {\n   resourceType: 'Task',\n   id: 'workflow-task-2',\n   status: 'requested',\n@@ -118,7 +118,7 @@ export const ExampleWorkflowTask2: Task = {\n   ],\n };\n \n-export const ExampleWorkflowTask3: Task = {\n+export const ExampleWorkflowTask3: WithId<Task> = {\n   resourceType: 'Task',\n   id: 'workflow-task-3',\n   status: 'requested',\n@@ -133,7 +133,7 @@ export const ExampleWorkflowTask3: Task = {\n   ],\n };\n \n-export const ExampleWorkflowRequestGroup: RequestGroup = {\n+export const ExampleWorkflowRequestGroup: WithId<RequestGroup> = {\n   resourceType: 'RequestGroup',\n   id: 'workflow-request-group-1',\n   instantiatesCanonical: [getReferenceString(ExampleWorkflowPlanDefinition)],\n\ndiff --git a/packages/react/src/BookmarkDialog/BookmarkDialog.tsx b/packages/react/src/BookmarkDialog/BookmarkDialog.tsx\nindex bed754144f..c8994f7d6d 100644\n--- a/packages/react/src/BookmarkDialog/BookmarkDialog.tsx\n+++ b/packages/react/src/BookmarkDialog/BookmarkDialog.tsx\n@@ -1,6 +1,6 @@\n import { Button, Group, Modal, NativeSelect, Stack, TextInput } from '@mantine/core';\n import { showNotification } from '@mantine/notifications';\n-import { deepClone, normalizeErrorString } from '@medplum/core';\n+import { deepClone, normalizeErrorString, WithId } from '@medplum/core';\n import { UserConfiguration } from '@medplum/fhirtypes';\n import { useMedplum } from '@medplum/react-hooks';\n import { Form } from '../Form/Form';\n@@ -15,12 +15,12 @@ interface BookmarkDialogProps {\n }\n export function BookmarkDialog(props: BookmarkDialogProps): JSX.Element | null {\n   const medplum = useMedplum();\n-  const config = medplum.getUserConfiguration() as UserConfiguration;\n+  const config = medplum.getUserConfiguration() as WithId<UserConfiguration>;\n \n   function submitHandler(formData: Record<string, string>): void {\n     const { menuname, bookmarkname: name } = formData;\n     const target = `${props.pathname}?${props.searchParams.toString()}`;\n-    const newConfig = deepClone(config) as UserConfiguration;\n+    const newConfig = deepClone(config);\n     const menu = newConfig.menu?.find(({ title }) => title === menuname);\n \n     menu?.link?.push({ name, target });\n\ndiff --git a/packages/react/src/PatientSummary/PatientSummary.tsx b/packages/react/src/PatientSummary/PatientSummary.tsx\nindex 327c0be40c..1f74201761 100644\n--- a/packages/react/src/PatientSummary/PatientSummary.tsx\n+++ b/packages/react/src/PatientSummary/PatientSummary.tsx\n@@ -104,7 +104,12 @@ export function PatientSummary(props: PatientSummaryProps): JSX.Element | null {\n         status: 'proposed,pending,booked',\n         ...searchMeta,\n       }),\n-      medplum.searchResources('Encounter', { subject: ref, date: `le${today}`, status: 'finished', ...searchMeta }),\n+      medplum.searchResources('Encounter', {\n+        subject: ref,\n+        date: `le${today}`,\n+        status: 'finished',\n+        ...searchMeta,\n+      }),\n     ])\n       .then((results) => {\n         const observations = results[3];\n\ndiff --git a/packages/react/src/QuestionnaireForm/QuestionnaireForm.tsx b/packages/react/src/QuestionnaireForm/QuestionnaireForm.tsx\nindex f5afb53e30..224110aa18 100644\n--- a/packages/react/src/QuestionnaireForm/QuestionnaireForm.tsx\n+++ b/packages/react/src/QuestionnaireForm/QuestionnaireForm.tsx\n@@ -1,5 +1,5 @@\n import { Title } from '@mantine/core';\n-import { createReference, getReferenceString } from '@medplum/core';\n+import { createReference } from '@medplum/core';\n import {\n   Encounter,\n   Questionnaire,\n@@ -109,7 +109,7 @@ export function QuestionnaireForm(props: QuestionnaireFormProps): JSX.Element |\n       }\n       onSubmit({\n         ...response,\n-        questionnaire: getReferenceString(questionnaire as Questionnaire),\n+        questionnaire: questionnaire?.url,\n         subject,\n         source,\n         authored: new Date().toISOString(),\n\ndiff --git a/packages/react/src/ResourceInput/ResourceInput.tsx b/packages/react/src/ResourceInput/ResourceInput.tsx\nindex 6bd7b102a1..71b2648b4c 100644\n--- a/packages/react/src/ResourceInput/ResourceInput.tsx\n+++ b/packages/react/src/ResourceInput/ResourceInput.tsx\n@@ -95,7 +95,7 @@ export interface ResourceInputProps<T extends Resource = Resource> {\n \n function toOption<T extends Resource>(resource: T): AsyncAutocompleteOption<T> {\n   return {\n-    value: getReferenceString(resource),\n+    value: getReferenceString(resource) ?? '',\n     label: getDisplayString(resource),\n     resource,\n   };\n\ndiff --git a/packages/react/src/Scheduler/Scheduler.tsx b/packages/react/src/Scheduler/Scheduler.tsx\nindex 02e4ce33b0..29b8c82502 100644\n--- a/packages/react/src/Scheduler/Scheduler.tsx\n+++ b/packages/react/src/Scheduler/Scheduler.tsx\n@@ -1,5 +1,5 @@\n import { Button, Stack, Text } from '@mantine/core';\n-import { getReferenceString, isReference } from '@medplum/core';\n+import { getReferenceString, isReference, WithId } from '@medplum/core';\n import { Questionnaire, QuestionnaireResponse, Reference, Schedule, Slot } from '@medplum/fhirtypes';\n import { useResource, useSearchResources } from '@medplum/react-hooks';\n import { useState } from 'react';\n@@ -32,7 +32,7 @@ export function Scheduler(props: SchedulerProps): JSX.Element | null {\n         'schedule',\n         isReference(props.schedule)\n           ? (props.schedule.reference as string)\n-          : getReferenceString(props.schedule as Schedule),\n+          : getReferenceString(props.schedule as WithId<Schedule>),\n       ],\n       ['start', 'gt' + getStart(month)],\n       ['start', 'lt' + getEnd(month)],\n\ndiff --git a/packages/react/src/chat/BaseChat/BaseChat.tsx b/packages/react/src/chat/BaseChat/BaseChat.tsx\nindex 0c4cceb358..ea3f2a8674 100644\n--- a/packages/react/src/chat/BaseChat/BaseChat.tsx\n+++ b/packages/react/src/chat/BaseChat/BaseChat.tsx\n@@ -12,7 +12,7 @@ import {\n } from '@mantine/core';\n import { useResizeObserver } from '@mantine/hooks';\n import { showNotification } from '@mantine/notifications';\n-import { ProfileResource, getDisplayString, getReferenceString, normalizeErrorString } from '@medplum/core';\n+import { ProfileResource, WithId, getDisplayString, getReferenceString, normalizeErrorString } from '@medplum/core';\n import { Bundle, Communication, Reference } from '@medplum/fhirtypes';\n import { useMedplum, useResource, useSubscription } from '@medplum/react-hooks';\n import { IconArrowRight } from '@tabler/icons-react';\n@@ -110,7 +110,7 @@ export function BaseChat(props: BaseChatProps): JSX.Element | null {\n   }\n \n   const profileRefStr = useMemo<string>(\n-    () => (profile ? getReferenceString(medplum.getProfile() as ProfileResource) : ''),\n+    () => (profile ? getReferenceString(medplum.getProfile() as WithId<ProfileResource>) : ''),\n     [profile, medplum]\n   );\n \n\ndiff --git a/packages/react/src/chat/ThreadChat/ThreadChat.tsx b/packages/react/src/chat/ThreadChat/ThreadChat.tsx\nindex 4f81c69f60..e158d87ebd 100644\n--- a/packages/react/src/chat/ThreadChat/ThreadChat.tsx\n+++ b/packages/react/src/chat/ThreadChat/ThreadChat.tsx\n@@ -63,7 +63,7 @@ export function ThreadChat(props: ThreadChatProps): JSX.Element | null {\n         ? (message: Communication): void => {\n             if (!(message.received && message.status === 'completed')) {\n               medplum\n-                .updateResource<Communication>({\n+                .updateResource({\n                   ...message,\n                   received: message.received ?? new Date().toISOString(), // Mark as received if needed\n                   status: 'completed', // Mark as 'read'\n\ndiff --git a/packages/react/src/stories/covid19.ts b/packages/react/src/stories/covid19.ts\nindex 04ed81f170..083654ef77 100644\n--- a/packages/react/src/stories/covid19.ts\n+++ b/packages/react/src/stories/covid19.ts\n@@ -1,4 +1,4 @@\n-import { LOINC, SNOMED, UCUM, createReference, getReferenceString } from '@medplum/core';\n+import { LOINC, SNOMED, UCUM, WithId, createReference, getReferenceString } from '@medplum/core';\n import {\n   ActivityDefinition,\n   ObservationDefinition,\n@@ -11,7 +11,7 @@ import {\n } from '@medplum/fhirtypes';\n import { DrAliceSmith, DrAliceSmithSchedule, HomerDiagnosticReport, HomerSimpson } from '@medplum/mock';\n \n-export const Covid19AssessmentQuestionnaire: Questionnaire = {\n+export const Covid19AssessmentQuestionnaire: WithId<Questionnaire> = {\n   resourceType: 'Questionnaire',\n   url: 'http://fhir.data4life.care/covid-19/r4/Questionnaire/covid19-recommendation',\n   version: '4.0.0',\n@@ -676,7 +676,7 @@ export const Covid19AssessmentQuestionnaire: Questionnaire = {\n   id: 'covid19-assessment',\n };\n \n-export const Covid19NasalSpecimen: SpecimenDefinition = {\n+export const Covid19NasalSpecimen: WithId<SpecimenDefinition> = {\n   resourceType: 'SpecimenDefinition',\n   id: 'covid19-nasal-specimen',\n   typeCollected: {\n@@ -684,7 +684,7 @@ export const Covid19NasalSpecimen: SpecimenDefinition = {\n   },\n };\n \n-export const Covid19PCRObservationDefinition: ObservationDefinition = {\n+export const Covid19PCRObservationDefinition: WithId<ObservationDefinition> = {\n   resourceType: 'ObservationDefinition',\n   id: 'covid19pcr-observation-definition',\n   preferredReportName: 'SARS-CoV-2 (COVID-19) RNA [Presence] in Respiratory specimen by NAA with probe detection',\n@@ -700,7 +700,7 @@ export const Covid19PCRObservationDefinition: ObservationDefinition = {\n   permittedDataType: ['string'],\n };\n \n-export const Covid19PCRTest: ActivityDefinition = {\n+export const Covid19PCRTest: WithId<ActivityDefinition> = {\n   resourceType: 'ActivityDefinition',\n   id: 'covid19-pcr-test',\n   status: 'active',\n@@ -723,7 +723,7 @@ export const Covid19PCRTest: ActivityDefinition = {\n   observationResultRequirement: [createReference(Covid19PCRObservationDefinition)],\n };\n \n-export const Covid19ReviewReport: ActivityDefinition = {\n+export const Covid19ReviewReport: WithId<ActivityDefinition> = {\n   resourceType: 'ActivityDefinition',\n   title: 'Review COVID-19 Report',\n   name: 'Review COVID-19 Report',\n@@ -738,7 +738,7 @@ export const Covid19ReviewReport: ActivityDefinition = {\n   ],\n };\n \n-export const Covid19CarePlanDefinition: PlanDefinition = {\n+export const Covid19CarePlanDefinition: WithId<PlanDefinition> = {\n   resourceType: 'PlanDefinition',\n   title: 'COVID-19 Evaluation Pre-Admission to Inpatient Oncology Department',\n   identifier: [\n@@ -789,7 +789,7 @@ export const Covid19CarePlanDefinition: PlanDefinition = {\n   id: 'covid19-care-plan-definition',\n };\n \n-export const Covid19PCRLabService: PlanDefinition = {\n+export const Covid19PCRLabService: WithId<PlanDefinition> = {\n   resourceType: 'PlanDefinition',\n   title: 'SARS-CoV-2 (COVID-19) RNA panel',\n   description: 'SARS-CoV-2 (COVID-19) RNA panel - Respiratory specimen by NAA with probe detection (Loinc: 94531-1)',\n@@ -851,7 +851,7 @@ export const Covid19PCRLabService: PlanDefinition = {\n   id: 'covid19-care-plan-definition',\n };\n \n-export const Covid19AssessmentTask: Task = {\n+export const Covid19AssessmentTask: WithId<Task> = {\n   meta: { author: createReference(DrAliceSmith) },\n   resourceType: 'Task',\n \n@@ -867,7 +867,7 @@ export const Covid19AssessmentTask: Task = {\n   id: 'covid19-assessment-task',\n };\n \n-export const Covid19InitialConsultTask: Task = {\n+export const Covid19InitialConsultTask: WithId<Task> = {\n   meta: { author: createReference(DrAliceSmith) },\n   resourceType: 'Task',\n   focus: {\n@@ -881,7 +881,7 @@ export const Covid19InitialConsultTask: Task = {\n   id: 'covid19-initial-consult-task',\n };\n \n-export const Covid19PCRServiceRequest: ServiceRequest = {\n+export const Covid19PCRServiceRequest: WithId<ServiceRequest> = {\n   // Required fields\n   resourceType: 'ServiceRequest',\n   id: 'covid19pcr-service-request',\n@@ -901,7 +901,7 @@ export const Covid19PCRServiceRequest: ServiceRequest = {\n   },\n };\n \n-export const Covid19PCRTask: Task = {\n+export const Covid19PCRTask: WithId<Task> = {\n   meta: { author: createReference(DrAliceSmith) },\n   resourceType: 'Task',\n \n@@ -914,7 +914,7 @@ export const Covid19PCRTask: Task = {\n   id: 'covid19pcr-task',\n };\n \n-export const Covid19ReviewLabsTask: Task = {\n+export const Covid19ReviewLabsTask: WithId<Task> = {\n   meta: { author: createReference(DrAliceSmith) },\n   resourceType: 'Task',\n   focus: createReference(HomerDiagnosticReport),\n@@ -926,7 +926,7 @@ export const Covid19ReviewLabsTask: Task = {\n   id: 'covid19-review-labs-task',\n };\n \n-export const Covid19FollowUpConsultTask: Task = {\n+export const Covid19FollowUpConsultTask: WithId<Task> = {\n   meta: { author: createReference(DrAliceSmith) },\n   resourceType: 'Task',\n   focus: createReference(DrAliceSmithSchedule),\n@@ -938,7 +938,7 @@ export const Covid19FollowUpConsultTask: Task = {\n   id: 'covid19-follow-up-consult-task',\n };\n \n-export const Covid19RequestGroup: RequestGroup = {\n+export const Covid19RequestGroup: WithId<RequestGroup> = {\n   resourceType: 'RequestGroup',\n   status: 'active',\n   intent: 'order',\n\ndiff --git a/packages/server/src/admin/invite.ts b/packages/server/src/admin/invite.ts\nindex 94d2e6ed73..03fbaf6800 100644\n--- a/packages/server/src/admin/invite.ts\n+++ b/packages/server/src/admin/invite.ts\n@@ -10,8 +10,9 @@ import {\n   Operator,\n   ProfileResource,\n   resolveId,\n+  WithId,\n } from '@medplum/core';\n-import { Practitioner, Project, ProjectMembership, Reference, User } from '@medplum/fhirtypes';\n+import { Project, ProjectMembership, Reference, User } from '@medplum/fhirtypes';\n import { Request, Response } from 'express';\n import { body, oneOf } from 'express-validator';\n import Mail from 'nodemailer/lib/mailer';\n@@ -61,9 +62,9 @@ export interface ServerInviteRequest extends InviteRequest {\n }\n \n export interface ServerInviteResponse {\n-  user: User;\n-  profile: ProfileResource;\n-  membership: ProjectMembership;\n+  user: WithId<User>;\n+  profile: WithId<ProfileResource>;\n+  membership: WithId<ProjectMembership>;\n }\n \n export async function inviteUser(request: ServerInviteRequest): Promise<ServerInviteResponse> {\n@@ -74,7 +75,7 @@ export async function inviteUser(request: ServerInviteRequest): Promise<ServerIn\n     request.email = request.email.toLowerCase();\n   }\n \n-  const project = request.project;\n+  const project = request.project as WithId<Project>;\n   const email = request.email;\n   let user = undefined;\n   let existingUser = true;\n@@ -82,7 +83,7 @@ export async function inviteUser(request: ServerInviteRequest): Promise<ServerIn\n \n   if (email) {\n     if (request.resourceType === 'Patient') {\n-      user = await getUserByEmailInProject(email, project.id as string);\n+      user = await getUserByEmailInProject(email, project.id);\n     } else {\n       user = await getUserByEmailWithoutProject(email);\n     }\n@@ -103,13 +104,7 @@ export async function inviteUser(request: ServerInviteRequest): Promise<ServerIn\n       email,\n       profileType: request.resourceType,\n     });\n-    profile = (await createProfile(\n-      project,\n-      request.resourceType,\n-      request.firstName,\n-      request.lastName,\n-      email\n-    )) as Practitioner;\n+    profile = await createProfile(project, request.resourceType, request.firstName, request.lastName, email);\n \n     logger.info('Profile  created', { profile: getReferenceString(profile) });\n   }\n@@ -144,7 +139,7 @@ export async function inviteUser(request: ServerInviteRequest): Promise<ServerIn\n   return { user, profile, membership };\n }\n \n-async function createUser(request: ServerInviteRequest): Promise<User> {\n+async function createUser(request: ServerInviteRequest): Promise<WithId<User>> {\n   const { firstName, lastName, externalId } = request;\n   const email = request.email?.toLowerCase();\n   const password = request.password ?? generateSecret(16);\n@@ -171,7 +166,7 @@ async function createUser(request: ServerInviteRequest): Promise<User> {\n   });\n }\n \n-async function searchForExistingProfile(request: ServerInviteRequest): Promise<ProfileResource | undefined> {\n+async function searchForExistingProfile(request: ServerInviteRequest): Promise<WithId<ProfileResource> | undefined> {\n   const { project, resourceType, membership, email } = request;\n   const systemRepo = getSystemRepo();\n \n@@ -183,7 +178,7 @@ async function searchForExistingProfile(request: ServerInviteRequest): Promise<P\n     if (result.resourceType !== resourceType) {\n       throw new OperationOutcomeError(badRequest('Profile resourceType does not match request'));\n     }\n-    return result as ProfileResource;\n+    return result;\n   }\n \n   if (email) {\n@@ -209,12 +204,12 @@ async function searchForExistingProfile(request: ServerInviteRequest): Promise<P\n \n async function createOrUpdateProjectMembership(\n   systemRepo: Repository,\n-  user: User,\n-  project: Project,\n+  user: WithId<User>,\n+  project: WithId<Project>,\n   profile: ProfileResource,\n   membershipTemplate: Partial<ProjectMembership>,\n   upsert: boolean\n-): Promise<ProjectMembership> {\n+): Promise<WithId<ProjectMembership>> {\n   const existingMembership = await searchForExistingMembership(systemRepo, user, project);\n   if (existingMembership) {\n     if (!upsert) {\n@@ -244,8 +239,8 @@ async function createOrUpdateProjectMembership(\n \n async function searchForExistingMembership(\n   systemRepo: Repository,\n-  user: User,\n-  project: Project\n+  user: WithId<User>,\n+  project: WithId<Project>\n ): Promise<ProjectMembership | undefined> {\n   return systemRepo.searchOne<ProjectMembership>({\n     resourceType: 'ProjectMembership',\n\ndiff --git a/packages/server/src/auth/me.ts b/packages/server/src/auth/me.ts\nindex d7dd9f20e5..282393b224 100644\n--- a/packages/server/src/auth/me.ts\n+++ b/packages/server/src/auth/me.ts\n@@ -1,4 +1,4 @@\n-import { getReferenceString, Operator, ProfileResource } from '@medplum/core';\n+import { getReferenceString, Operator, ProfileResource, WithId } from '@medplum/core';\n import { Login, Project, ProjectMembership, Reference, User, UserConfiguration } from '@medplum/fhirtypes';\n import { Request, Response } from 'express';\n import { getAuthenticatedContext } from '../context';\n@@ -29,7 +29,7 @@ export async function meHandler(req: Request, res: Response): Promise<void> {\n   const profile = await systemRepo.readReference<ProfileResource>(profileRef);\n   const config = await getUserConfiguration(systemRepo, project, membership);\n   const accessPolicy = await getAccessPolicyForLogin(authState);\n-  let user: User | undefined = undefined;\n+  let user: WithId<User> | undefined = undefined;\n \n   let security: UserSecurity | undefined = undefined;\n   if (membership.user?.reference?.startsWith('User/')) {\n@@ -122,7 +122,7 @@ async function getUserConfiguration(\n   return result;\n }\n \n-async function getSessions(systemRepo: Repository, user: User): Promise<UserSession[]> {\n+async function getSessions(systemRepo: Repository, user: WithId<User>): Promise<UserSession[]> {\n   const logins = await systemRepo.searchResources<Login>({\n     resourceType: 'Login',\n     filters: [\n\ndiff --git a/packages/server/src/auth/newuser.ts b/packages/server/src/auth/newuser.ts\nindex ac5f4b3343..7456047003 100644\n--- a/packages/server/src/auth/newuser.ts\n+++ b/packages/server/src/auth/newuser.ts\n@@ -1,4 +1,4 @@\n-import { badRequest, NewUserRequest, normalizeOperationOutcome } from '@medplum/core';\n+import { badRequest, NewUserRequest, normalizeOperationOutcome, WithId } from '@medplum/core';\n import { ClientApplication, User } from '@medplum/fhirtypes';\n import { randomUUID } from 'crypto';\n import { Request, Response } from 'express';\n@@ -93,7 +93,7 @@ export async function newUserHandler(req: Request, res: Response): Promise<void>\n   }\n }\n \n-export async function createUser(request: Omit<NewUserRequest, 'recaptchaToken'>): Promise<User> {\n+export async function createUser(request: Omit<NewUserRequest, 'recaptchaToken'>): Promise<WithId<User>> {\n   const { firstName, lastName, email, password, projectId } = request;\n \n   const numPwns = await pwnedPassword(password);\n\ndiff --git a/packages/server/src/auth/utils.ts b/packages/server/src/auth/utils.ts\nindex 6575930061..71e36c2a18 100644\n--- a/packages/server/src/auth/utils.ts\n+++ b/packages/server/src/auth/utils.ts\n@@ -5,6 +5,7 @@ import {\n   Operator,\n   ProfileResource,\n   resolveId,\n+  WithId,\n } from '@medplum/core';\n import { ContactPoint, Login, OperationOutcome, Project, ProjectMembership, Reference, User } from '@medplum/fhirtypes';\n import bcrypt from 'bcryptjs';\n@@ -23,7 +24,7 @@ export async function createProfile(\n   firstName: string,\n   lastName: string,\n   email: string | undefined\n-): Promise<ProfileResource> {\n+): Promise<WithId<ProfileResource>> {\n   const logger = getLogger();\n   logger.info('Creating profile', { resourceType, firstName, lastName });\n   let telecom: ContactPoint[] | undefined = undefined;\n@@ -54,7 +55,7 @@ export async function createProjectMembership(\n   project: Project,\n   profile: ProfileResource,\n   details?: Partial<ProjectMembership>\n-): Promise<ProjectMembership> {\n+): Promise<WithId<ProjectMembership>> {\n   const logger = getLogger();\n   logger.info('Creating project membership', { name: project.name });\n \n\ndiff --git a/packages/server/src/context.ts b/packages/server/src/context.ts\nindex c527de8233..1301f9413e 100644\n--- a/packages/server/src/context.ts\n+++ b/packages/server/src/context.ts\n@@ -1,4 +1,4 @@\n-import { Logger, ProfileResource, isUUID, parseLogLevel } from '@medplum/core';\n+import { Logger, ProfileResource, isUUID, parseLogLevel, WithId } from '@medplum/core';\n import { Bot, ClientApplication, Extension, Login, Project, ProjectMembership, Reference } from '@medplum/fhirtypes';\n import { randomUUID } from 'crypto';\n import { NextFunction, Request, Response } from 'express';\n@@ -47,11 +47,11 @@ export class AuthenticatedRequestContext extends RequestContext {\n     super(requestId, traceId, logger, loggerMetadata);\n   }\n \n-  get project(): Project {\n+  get project(): WithId<Project> {\n     return this.authState.project;\n   }\n \n-  get membership(): ProjectMembership {\n+  get membership(): WithId<ProjectMembership> {\n     return this.authState.onBehalfOfMembership ?? this.authState.membership;\n   }\n \n\ndiff --git a/packages/server/src/fhir/binary.ts b/packages/server/src/fhir/binary.ts\nindex 3c2302fdbd..48a8aabd97 100644\n--- a/packages/server/src/fhir/binary.ts\n+++ b/packages/server/src/fhir/binary.ts\n@@ -60,7 +60,7 @@ async function handleBinaryWriteRequest(req: Request, res: Response): Promise<vo\n       getLogger().debug('Invalid JSON', { error: err });\n     }\n \n-    if (isResource(body) && body.resourceType === 'Binary' && (!id || body.id === id)) {\n+    if (isResource(body, 'Binary') && (!id || body.id === id)) {\n       // Special case where the content is actually a Binary resource.\n       // From the spec: https://hl7.org/fhir/R4/binary.html#rest\n       //\n\ndiff --git a/packages/server/src/fhir/operations/agentbulkstatus.ts b/packages/server/src/fhir/operations/agentbulkstatus.ts\nindex db5b37bc25..1c6959a640 100644\n--- a/packages/server/src/fhir/operations/agentbulkstatus.ts\n+++ b/packages/server/src/fhir/operations/agentbulkstatus.ts\n@@ -1,5 +1,5 @@\n import { FhirRequest, FhirResponse } from '@medplum/fhir-router';\n-import { Agent, OperationDefinition } from '@medplum/fhirtypes';\n+import { OperationDefinition } from '@medplum/fhirtypes';\n import { agentStatusHandler } from './agentstatus';\n import { handleBulkAgentOperation } from './utils/agentutils';\n \n@@ -30,7 +30,5 @@ export const operation: OperationDefinition = {\n  * @returns The FHIR response.\n  */\n export async function agentBulkStatusHandler(req: FhirRequest): Promise<FhirResponse> {\n-  return handleBulkAgentOperation(req, (agent: Agent) =>\n-    agentStatusHandler({ ...req, params: { id: agent.id as string } })\n-  );\n+  return handleBulkAgentOperation(req, (agent) => agentStatusHandler({ ...req, params: { id: agent.id as string } }));\n }\n\ndiff --git a/packages/server/src/fhir/operations/agentreloadconfig.ts b/packages/server/src/fhir/operations/agentreloadconfig.ts\nindex 0f7e01605f..cda791f2a2 100644\n--- a/packages/server/src/fhir/operations/agentreloadconfig.ts\n+++ b/packages/server/src/fhir/operations/agentreloadconfig.ts\n@@ -1,4 +1,4 @@\n-import { AgentReloadConfigResponse, OperationOutcomeError, badRequest, serverError } from '@medplum/core';\n+import { AgentReloadConfigResponse, OperationOutcomeError, WithId, badRequest, serverError } from '@medplum/core';\n import { FhirRequest, FhirResponse } from '@medplum/fhir-router';\n import { Agent, OperationDefinition } from '@medplum/fhirtypes';\n import { handleBulkAgentOperation, publishAgentRequest } from './utils/agentutils';\n@@ -28,10 +28,10 @@ export const operation: OperationDefinition = {\n  * @returns The FHIR response.\n  */\n export async function agentReloadConfigHandler(req: FhirRequest): Promise<FhirResponse> {\n-  return handleBulkAgentOperation(req, async (agent: Agent) => reloadConfig(agent));\n+  return handleBulkAgentOperation(req, async (agent) => reloadConfig(agent));\n }\n \n-async function reloadConfig(agent: Agent): Promise<FhirResponse> {\n+async function reloadConfig(agent: WithId<Agent>): Promise<FhirResponse> {\n   // Send agent message\n   const [outcome, result] = await publishAgentRequest<AgentReloadConfigResponse>(\n     agent,\n\ndiff --git a/packages/server/src/fhir/operations/agentupgrade.ts b/packages/server/src/fhir/operations/agentupgrade.ts\nindex 8e42a42ac7..9f18ce54fa 100644\n--- a/packages/server/src/fhir/operations/agentupgrade.ts\n+++ b/packages/server/src/fhir/operations/agentupgrade.ts\n@@ -1,4 +1,11 @@\n-import { AgentUpgradeResponse, OperationOutcomeError, badRequest, serverError, singularize } from '@medplum/core';\n+import {\n+  AgentUpgradeResponse,\n+  OperationOutcomeError,\n+  WithId,\n+  badRequest,\n+  serverError,\n+  singularize,\n+} from '@medplum/core';\n import { FhirRequest, FhirResponse } from '@medplum/fhir-router';\n import { Agent, OperationDefinition } from '@medplum/fhirtypes';\n import { handleBulkAgentOperation, publishAgentRequest } from './utils/agentutils';\n@@ -48,7 +55,7 @@ export async function agentUpgradeHandler(req: FhirRequest): Promise<FhirRespons\n     }\n   }\n \n-  return handleBulkAgentOperation(req, async (agent: Agent) =>\n+  return handleBulkAgentOperation(req, async (agent) =>\n     upgradeAgent(agent, { version: singularize(version), timeout })\n   );\n }\n@@ -58,7 +65,7 @@ export type AgentUpgradeOptions = {\n   timeout?: number;\n };\n \n-async function upgradeAgent(agent: Agent, options?: AgentUpgradeOptions): Promise<FhirResponse> {\n+async function upgradeAgent(agent: WithId<Agent>, options?: AgentUpgradeOptions): Promise<FhirResponse> {\n   let timeout = options?.timeout ?? DEFAULT_UPGRADE_TIMEOUT;\n   if (timeout > MAX_UPGRADE_TIMEOUT) {\n     timeout = MAX_UPGRADE_TIMEOUT;\n\ndiff --git a/packages/server/src/fhir/operations/execute.ts b/packages/server/src/fhir/operations/execute.ts\nindex 8c47810d04..81791847fe 100644\n--- a/packages/server/src/fhir/operations/execute.ts\n+++ b/packages/server/src/fhir/operations/execute.ts\n@@ -106,7 +106,7 @@ export const executeHandler = asyncWrap(async (req: Request, res: Response) => {\n     const responseBody = getResponseBodyFromResult(result);\n     const outcome = result.success ? allOk : badRequest(result.logResult);\n \n-    if (isResource(responseBody) && responseBody.resourceType === 'Binary') {\n+    if (isResource(responseBody, 'Binary')) {\n       await sendFhirResponse(req, res, outcome, responseBody);\n       return;\n     }\n\ndiff --git a/packages/server/src/fhir/operations/export.ts b/packages/server/src/fhir/operations/export.ts\nindex 36c79af305..3045f51183 100644\n--- a/packages/server/src/fhir/operations/export.ts\n+++ b/packages/server/src/fhir/operations/export.ts\n@@ -98,7 +98,7 @@ export async function exportResourceType<T extends Resource>(\n     filters: since ? [{ code: '_lastUpdated', operator: Operator.GREATER_THAN_OR_EQUALS, value: since }] : undefined,\n     sortRules: [{ code: '_lastUpdated', descending: false }],\n   };\n-  await repo.processAllResources(searchRequest, async (resource: T) => {\n+  await repo.processAllResources(searchRequest, async (resource) => {\n     await exporter.writeResource(resource);\n   });\n }\n\ndiff --git a/packages/server/src/fhir/operations/patienteverything.ts b/packages/server/src/fhir/operations/patienteverything.ts\nindex d44f3e9ac4..1d18f715bb 100644\n--- a/packages/server/src/fhir/operations/patienteverything.ts\n+++ b/packages/server/src/fhir/operations/patienteverything.ts\n@@ -6,6 +6,7 @@ import {\n   isResource,\n   Operator,\n   sortStringArray,\n+  WithId,\n } from '@medplum/core';\n import { FhirRequest, FhirResponse } from '@medplum/fhir-router';\n import {\n@@ -69,9 +70,9 @@ export async function patientEverythingHandler(req: FhirRequest): Promise<FhirRe\n  */\n export async function getPatientEverything(\n   repo: Repository,\n-  patient: Patient,\n+  patient: WithId<Patient>,\n   params?: PatientEverythingParameters\n-): Promise<Bundle> {\n+): Promise<Bundle<WithId<Resource>>> {\n   // First get all compartment resources\n   const resourceList = getPatientCompartments().resource as CompartmentDefinitionResource[];\n   const types = params?._type ?? resourceList.map((r) => r.code as ResourceType).filter((t) => t !== 'Binary');\n@@ -133,7 +134,7 @@ async function addResolvedReferences(repo: Repository, entries: BundleEntry[] |\n function processReferencesFromResources(toProcess: BundleEntry[], processedRefs: Set<string>): Reference[] {\n   const references = new Set<string>();\n   for (const entry of toProcess) {\n-    const resource = entry.resource as Resource;\n+    const resource = entry.resource as WithId<Resource>;\n     const refString = getReferenceString(resource);\n     if (processedRefs.has(refString)) {\n       continue;\n\ndiff --git a/packages/server/src/fhir/operations/patientsummary.ts b/packages/server/src/fhir/operations/patientsummary.ts\nindex b5ca3f33ba..04ce8b983f 100644\n--- a/packages/server/src/fhir/operations/patientsummary.ts\n+++ b/packages/server/src/fhir/operations/patientsummary.ts\n@@ -1,4 +1,4 @@\n-import { allOk, createReference, HTTP_TERMINOLOGY_HL7_ORG, LOINC, resolveId } from '@medplum/core';\n+import { allOk, createReference, HTTP_TERMINOLOGY_HL7_ORG, LOINC, resolveId, WithId } from '@medplum/core';\n import { FhirRequest, FhirResponse } from '@medplum/fhir-router';\n import {\n   Bundle,\n@@ -107,7 +107,7 @@ export async function patientSummaryHandler(req: FhirRequest): Promise<FhirRespo\n  */\n export async function getPatientSummary(\n   repo: Repository,\n-  patient: Patient,\n+  patient: WithId<Patient>,\n   params: PatientSummaryParameters = {}\n ): Promise<Bundle> {\n   params._type = resourceTypes;\n\ndiff --git a/packages/server/src/fhir/operations/resourcegraph.ts b/packages/server/src/fhir/operations/resourcegraph.ts\nindex 7d01cef3ad..a91c8d2111 100644\n--- a/packages/server/src/fhir/operations/resourcegraph.ts\n+++ b/packages/server/src/fhir/operations/resourcegraph.ts\n@@ -11,6 +11,7 @@ import {\n   PropertyType,\n   toTypedValue,\n   TypedValue,\n+  WithId,\n } from '@medplum/core';\n import { FhirRequest, FhirResponse } from '@medplum/fhir-router';\n import {\n@@ -25,6 +26,8 @@ import { getAuthenticatedContext } from '../../context';\n import { getLogger } from '../../logger';\n import { Repository } from '../repo';\n \n+type ResourceCache = Record<string, WithId<Resource>>;\n+\n /**\n  * Handles a Resource $graph request.\n  *\n@@ -43,8 +46,8 @@ export async function resourceGraphHandler(req: FhirRequest): Promise<FhirRespon\n   }\n \n   const rootResource = await ctx.repo.readResource(resourceType, id);\n-  const results = [rootResource] as Resource[];\n-  const resourceCache = {} as Record<string, Resource>;\n+  const results = [rootResource];\n+  const resourceCache: ResourceCache = Object.create(null);\n   resourceCache[getReferenceString(rootResource)] = rootResource;\n   if ('url' in rootResource) {\n     resourceCache[(rootResource as { url: string }).url] = rootResource;\n@@ -90,10 +93,10 @@ function isSearchLink(link: GraphDefinitionLink): link is SearchLink {\n }\n async function followLinks(\n   repo: Repository,\n-  resource: Resource,\n+  resource: WithId<Resource>,\n   links: GraphDefinitionLink[] | undefined,\n-  results: Resource[],\n-  resourceCache: Record<string, Resource>,\n+  results: WithId<Resource>[],\n+  resourceCache: ResourceCache,\n   depth = 0\n ): Promise<void> {\n   // Circuit Breaker\n@@ -107,7 +110,7 @@ async function followLinks(\n   }\n   for (const link of links) {\n     for (const target of link.target || []) {\n-      let linkedResources: Resource[];\n+      let linkedResources: WithId<Resource>[];\n \n       if (isFhirPathLink(link)) {\n         linkedResources = await followFhirPathLink(repo, link, target, resource, resourceCache);\n@@ -142,10 +145,10 @@ async function followFhirPathLink(\n   repo: Repository,\n   link: FhirPathLink,\n   target: GraphDefinitionLinkTarget,\n-  resource: Resource,\n-  resourceCache: Record<string, Resource>\n-): Promise<Resource[]> {\n-  const results = [] as Resource[];\n+  resource: WithId<Resource>,\n+  resourceCache: ResourceCache\n+): Promise<WithId<Resource>[]> {\n+  const results = [] as WithId<Resource>[];\n \n   const elements = evalFhirPathTyped(link.path, [toTypedValue(resource)]);\n \n@@ -174,13 +177,13 @@ async function followReferenceElements(\n   repo: Repository,\n   elements: TypedValue[],\n   target: GraphDefinitionLinkTarget,\n-  resourceCache: Record<string, Resource>\n-): Promise<Resource[]> {\n+  resourceCache: ResourceCache\n+): Promise<WithId<Resource>[]> {\n   const targetReferences = elements\n     .filter((elem) => elem.value.reference?.split('/')[0] === target.type)\n     .map((elem) => elem.value as Reference);\n \n-  const results = [] as Resource[];\n+  const results = [] as WithId<Resource>[];\n \n   for (const ref of targetReferences) {\n     if (ref.reference) {\n@@ -202,12 +205,12 @@ async function followCanonicalElements(\n   repo: Repository,\n   elements: TypedValue[],\n   target: GraphDefinitionLinkTarget,\n-  resourceCache: Record<string, Resource>\n-): Promise<Resource[]> {\n+  resourceCache: ResourceCache\n+): Promise<WithId<Resource>[]> {\n   // Filter out Resources where we've seen the canonical URL\n   const targetUrls = elements.map((elem) => elem.value as string);\n \n-  const results = [] as Resource[];\n+  const results = [] as WithId<Resource>[];\n   for (const url of targetUrls) {\n     if (url in resourceCache) {\n       results.push(resourceCache[url]);\n@@ -240,11 +243,11 @@ async function followCanonicalElements(\n  */\n async function followSearchLink(\n   repo: Repository,\n-  resource: Resource,\n+  resource: WithId<Resource>,\n   link: SearchLink,\n-  resourceCache: Record<string, Resource>\n-): Promise<Resource[]> {\n-  const results = [] as Resource[];\n+  resourceCache: ResourceCache\n+): Promise<WithId<Resource>[]> {\n+  const results = [] as WithId<Resource>[];\n   for (const target of link.target) {\n     const searchResourceType = target.type;\n     const params = target.params as string;\n@@ -310,7 +313,7 @@ function parseCardinality(cardinality: string | undefined): number {\n   return Number.parseInt(cardinality, 10);\n }\n \n-function addToCache(resource: Resource, cache: Record<string, Resource>): void {\n+function addToCache(resource: WithId<Resource>, cache: ResourceCache): void {\n   cache[getReferenceString(resource)] = resource;\n   const url = (resource as any).url;\n   if (url) {\n@@ -318,7 +321,7 @@ function addToCache(resource: Resource, cache: Record<string, Resource>): void {\n   }\n }\n \n-function deduplicateResources(resources: Resource[]): Resource[] {\n+function deduplicateResources<T extends Resource>(resources: WithId<T>[]): WithId<T>[] {\n   const seen = new Set<string>();\n   return resources.filter((item) => {\n     const key = getReferenceString(item);\n\ndiff --git a/packages/server/src/fhir/operations/utils/agentutils.ts b/packages/server/src/fhir/operations/utils/agentutils.ts\nindex 16974a1e9c..4a80da1c8a 100644\n--- a/packages/server/src/fhir/operations/utils/agentutils.ts\n+++ b/packages/server/src/fhir/operations/utils/agentutils.ts\n@@ -5,6 +5,7 @@ import {\n   ContentType,\n   OperationOutcomeError,\n   Operator,\n+  WithId,\n   allOk,\n   badRequest,\n   getReferenceString,\n@@ -41,7 +42,10 @@ export const MAX_AGENTS_PER_PAGE = 100;\n  * @param repo - The repository.\n  * @returns The agent, or undefined if not found.\n  */\n-export async function getAgentForRequest(req: Request | FhirRequest, repo: Repository): Promise<Agent | undefined> {\n+export async function getAgentForRequest(\n+  req: Request | FhirRequest,\n+  repo: Repository\n+): Promise<WithId<Agent> | undefined> {\n   // Prefer to search by ID from path parameter\n   const { id } = req.params;\n   if (id) {\n@@ -68,7 +72,7 @@ export async function getAgentForRequest(req: Request | FhirRequest, repo: Repos\n  * @param repo - The repository.\n  * @returns The agent, or undefined if not found.\n  */\n-export async function getAgentsForRequest(req: FhirRequest, repo: Repository): Promise<Agent[] | undefined> {\n+export async function getAgentsForRequest(req: FhirRequest, repo: Repository): Promise<WithId<Agent>[] | undefined> {\n   if (req.params.id) {\n     const agent = await getAgentForRequest(req, repo);\n     return agent ? [agent] : undefined;\n@@ -96,7 +100,7 @@ export async function getDevice(repo: Repository, params: AgentPushParameters):\n \n export async function handleBulkAgentOperation(\n   req: FhirRequest,\n-  handler: (agent: Agent) => Promise<FhirResponse>\n+  handler: (agent: WithId<Agent>) => Promise<FhirResponse>\n ): Promise<FhirResponse> {\n   const { repo } = getAuthenticatedContext();\n \n@@ -114,7 +118,7 @@ export async function handleBulkAgentOperation(\n     return handler(agents[0]);\n   }\n \n-  const promises = agents.map((agent: Agent) => handler(agent));\n+  const promises = agents.map((agent) => handler(agent));\n   const results = await Promise.allSettled(promises);\n   const entries: BundleEntry<Parameters>[] = [];\n \n@@ -165,7 +169,7 @@ export interface AgentMessageOptions {\n }\n \n export async function publishAgentRequest<T extends AgentResponseMessage = AgentResponseMessage>(\n-  agent: Agent,\n+  agent: WithId<Agent>,\n   message: AgentRequestMessage,\n   options?: AgentMessageOptions\n ): Promise<[OperationOutcome] | [OperationOutcome, T | AgentError]> {\n@@ -206,7 +210,7 @@ export async function publishAgentRequest<T extends AgentResponseMessage = Agent\n }\n \n function publishRequestMessage<T extends AgentRequestMessage = AgentRequestMessage>(\n-  agent: Agent,\n+  agent: WithId<Agent>,\n   message: T\n ): Promise<number> {\n   return getRedis().publish(getReferenceString(agent), JSON.stringify(message));\n\ndiff --git a/packages/server/src/fhir/operations/utils/bulkexporter.ts b/packages/server/src/fhir/operations/utils/bulkexporter.ts\nindex 1958f8723b..b03f944e84 100644\n--- a/packages/server/src/fhir/operations/utils/bulkexporter.ts\n+++ b/packages/server/src/fhir/operations/utils/bulkexporter.ts\n@@ -1,4 +1,4 @@\n-import { getReferenceString } from '@medplum/core';\n+import { getReferenceString, WithId } from '@medplum/core';\n import { AsyncJob, Binary, Bundle, Parameters, Project, Resource } from '@medplum/fhirtypes';\n import { PassThrough } from 'node:stream';\n import { Repository, getSystemRepo } from '../../repo';\n@@ -7,11 +7,11 @@ import { getBinaryStorage } from '../../storage';\n const NDJSON_CONTENT_TYPE = 'application/fhir+ndjson';\n \n class BulkFileWriter {\n-  readonly binary: Binary;\n+  readonly binary: WithId<Binary>;\n   private readonly stream: PassThrough;\n   private readonly writerPromise: Promise<void>;\n \n-  constructor(binary: Binary) {\n+  constructor(binary: WithId<Binary>) {\n     this.binary = binary;\n \n     const filename = `export.ndjson`;\n@@ -31,7 +31,7 @@ class BulkFileWriter {\n \n export class BulkExporter {\n   readonly repo: Repository;\n-  private resource: AsyncJob | undefined;\n+  private resource: WithId<AsyncJob> | undefined;\n   readonly writers: Record<string, BulkFileWriter> = {};\n   readonly resourceSet = new Set<string>();\n \n@@ -39,7 +39,7 @@ export class BulkExporter {\n     this.repo = repo;\n   }\n \n-  async start(url: string): Promise<AsyncJob> {\n+  async start(url: string): Promise<WithId<AsyncJob>> {\n     this.resource = await this.repo.createResource<AsyncJob>({\n       resourceType: 'AsyncJob',\n       status: 'active',\n@@ -62,7 +62,7 @@ export class BulkExporter {\n     return writer;\n   }\n \n-  async writeBundle(bundle: Bundle): Promise<void> {\n+  async writeBundle(bundle: Bundle<WithId<Resource>>): Promise<void> {\n     if (bundle.entry) {\n       for (const entry of bundle.entry) {\n         if (entry.resource) {\n@@ -72,7 +72,7 @@ export class BulkExporter {\n     }\n   }\n \n-  async writeResource(resource: Resource): Promise<void> {\n+  async writeResource(resource: WithId<Resource>): Promise<void> {\n     const ref = getReferenceString(resource);\n     if (!this.resourceSet.has(ref)) {\n       const writer = await this.getWriter(resource.resourceType);\n\ndiff --git a/packages/server/src/fhir/operations/utils/parameters.ts b/packages/server/src/fhir/operations/utils/parameters.ts\nindex 50348d25a1..36513ecb4b 100644\n--- a/packages/server/src/fhir/operations/utils/parameters.ts\n+++ b/packages/server/src/fhir/operations/utils/parameters.ts\n@@ -1,6 +1,12 @@\n import { OperationOutcomeError, badRequest, capitalize, isEmpty, isResource, validateResource } from '@medplum/core';\n import { FhirRequest } from '@medplum/fhir-router';\n-import { OperationDefinition, OperationDefinitionParameter, Parameters, ParametersParameter } from '@medplum/fhirtypes';\n+import {\n+  OperationDefinition,\n+  OperationDefinitionParameter,\n+  Parameters,\n+  ParametersParameter,\n+  ResourceType,\n+} from '@medplum/fhirtypes';\n import { Request } from 'express';\n \n export function parseParameters<T>(input: T | Parameters): T {\n@@ -154,7 +160,7 @@ export function buildOutputParameters(operation: OperationDefinition, output: an\n   const outputParameters = operation.parameter?.filter((p) => p.use === 'out');\n   const param1 = outputParameters?.[0];\n   if (outputParameters?.length === 1 && param1 && param1.name === 'return') {\n-    if (!isResource(output) || (param1.type && output.resourceType !== param1.type)) {\n+    if (!isResource(output, param1.type as ResourceType | undefined)) {\n       throw new Error(`Expected ${param1.type ?? 'Resource'} output, but got unexpected ${typeof output}`);\n     } else {\n       // Send Resource as output directly, instead of using Parameters format\n\ndiff --git a/packages/server/src/fhir/patient.ts b/packages/server/src/fhir/patient.ts\nindex d709dbdd2f..57a6d193d2 100644\n--- a/packages/server/src/fhir/patient.ts\n+++ b/packages/server/src/fhir/patient.ts\n@@ -1,4 +1,4 @@\n-import { evalFhirPath, getReferenceString, getSearchParameter } from '@medplum/core';\n+import { evalFhirPath, getReferenceString, getSearchParameter, WithId } from '@medplum/core';\n import { readJson } from '@medplum/definitions';\n import {\n   CompartmentDefinition,\n@@ -52,7 +52,7 @@ export function getPatientCompartmentParams(resourceType: string): string[] | un\n  * @param resource - The resource to inspect.\n  * @returns The patient ID if found; undefined otherwise.\n  */\n-export function getPatients(resource: Resource): (Reference<Patient> & { reference: string })[] {\n+export function getPatients(resource: WithId<Resource>): (Reference<Patient> & { reference: string })[] {\n   const result = new Set<string>();\n   if (resource.resourceType === 'Patient' && resource.id) {\n     result.add(getReferenceString(resource));\n\ndiff --git a/packages/server/src/fhir/repo.ts b/packages/server/src/fhir/repo.ts\nindex f309f3c221..2f5cf5c464 100644\n--- a/packages/server/src/fhir/repo.ts\n+++ b/packages/server/src/fhir/repo.ts\n@@ -9,6 +9,7 @@ import {\n   SearchParameterType,\n   SearchRequest,\n   TypedValue,\n+  WithId,\n   allOk,\n   arrayify,\n   badRequest,\n@@ -31,6 +32,7 @@ import {\n   isOk,\n   isReference,\n   isResource,\n+  isResourceWithId,\n   normalizeErrorString,\n   normalizeOperationOutcome,\n   notFound,\n@@ -264,7 +266,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     return this.context.currentProject;\n   }\n \n-  async createResource<T extends Resource>(resource: T, options?: CreateResourceOptions): Promise<T> {\n+  async createResource<T extends Resource>(resource: T, options?: CreateResourceOptions): Promise<WithId<T>> {\n     const resourceWithId = {\n       ...resource,\n       id: options?.assignedId && resource.id ? resource.id : this.generateId(),\n@@ -293,7 +295,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     resourceType: T['resourceType'],\n     id: string,\n     options?: ReadResourceOptions\n-  ): Promise<T> {\n+  ): Promise<WithId<T>> {\n     const startTime = Date.now();\n     try {\n       const result = this.removeHiddenFields(await this.readResourceImpl<T>(resourceType, id, options));\n@@ -314,7 +316,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     resourceType: T['resourceType'],\n     id: string,\n     options?: ReadResourceOptions\n-  ): Promise<T> {\n+  ): Promise<WithId<T>> {\n     if (!id || !validator.isUUID(id)) {\n       throw new OperationOutcomeError(notFound);\n     }\n@@ -382,9 +384,9 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     return true;\n   }\n \n-  async readReferences(references: Reference[]): Promise<(Resource | Error)[]> {\n+  async readReferences<T extends Resource>(references: Reference<T>[]): Promise<(T | Error)[]> {\n     const cacheEntries = await this.getCacheEntries(references);\n-    const result: (Resource | Error)[] = new Array(references.length);\n+    const result: (T | Error)[] = new Array(references.length);\n \n     for (let i = 0; i < result.length; i++) {\n       const startTime = Date.now();\n@@ -403,7 +405,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n         entryResult = this.removeHiddenFields(entryResult);\n         this.logEvent(ReadInteraction, AuditEventOutcome.Success, undefined, { resource: entryResult, durationMs });\n       }\n-      result[i] = entryResult;\n+      result[i] = entryResult as T | Error;\n     }\n \n     return result;\n@@ -436,7 +438,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     }\n   }\n \n-  async readReference<T extends Resource>(reference: Reference<T>): Promise<T> {\n+  async readReference<T extends Resource>(reference: Reference<T>): Promise<WithId<T>> {\n     let parts: [T['resourceType'], string];\n     try {\n       parts = parseReference(reference);\n@@ -566,10 +568,10 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     }\n   }\n \n-  async updateResource<T extends Resource>(resource: T, options?: UpdateResourceOptions): Promise<T> {\n+  async updateResource<T extends Resource>(resource: T, options?: UpdateResourceOptions): Promise<WithId<T>> {\n     const startTime = Date.now();\n     try {\n-      let result: T;\n+      let result: WithId<T>;\n       if (options?.ifMatch) {\n         // Conditional update requires transaction\n         result = await this.withTransaction(() => this.updateResourceImpl(resource, false, options.ifMatch));\n@@ -588,11 +590,15 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     }\n   }\n \n-  private async updateResourceImpl<T extends Resource>(resource: T, create: boolean, versionId?: string): Promise<T> {\n-    const { resourceType, id } = resource;\n-    if (!id) {\n+  private async updateResourceImpl<T extends Resource>(\n+    resource: T,\n+    create: boolean,\n+    versionId?: string\n+  ): Promise<WithId<T>> {\n+    if (!isResourceWithId(resource)) {\n       throw new OperationOutcomeError(badRequest('Missing id'));\n     }\n+    const { resourceType, id } = resource;\n     if (!validator.isUUID(id)) {\n       throw new OperationOutcomeError(badRequest('Invalid id'));\n     }\n@@ -621,7 +627,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n       }\n     }\n \n-    let updated = await rewriteAttachments<T>(RewriteMode.REFERENCE, this, {\n+    let updated = await rewriteAttachments(RewriteMode.REFERENCE, this, {\n       ...this.restoreReadonlyFields(resource, existing),\n     });\n     updated = await replaceConditionalReferences(this, updated);\n@@ -634,7 +640,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n       onBehalfOf: this.context.onBehalfOf,\n     };\n \n-    const result: T = { ...updated, meta: resultMeta };\n+    const result = { ...updated, meta: resultMeta };\n \n     const project = this.getProjectId(existing, updated);\n     if (project) {\n@@ -890,7 +896,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n   private async checkExistingResource<T extends Resource>(\n     resourceType: T['resourceType'],\n     id: string\n-  ): Promise<T | undefined> {\n+  ): Promise<WithId<T> | undefined> {\n     try {\n       return await this.readResourceImpl<T>(resourceType, id);\n     } catch (err) {\n@@ -954,12 +960,11 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n    * @param conn - Database client to use for reindex operations.\n    * @param resources - The resource(s) to reindex.\n    */\n-  async reindexResources<T extends Resource>(conn: PoolClient, resources: T[]): Promise<void> {\n-    let resource: Resource;\n+  async reindexResources<T extends Resource>(conn: PoolClient, resources: WithId<T>[]): Promise<void> {\n     // Since the page size could be relatively large (1k+), preferring a simple for loop with re-used variables\n     // eslint-disable-next-line @typescript-eslint/prefer-for-of\n     for (let i = 0; i < resources.length; i++) {\n-      resource = resources[i];\n+      const resource = resources[i];\n       const meta = resource.meta as Meta;\n       meta.compartment = this.getCompartments(resource);\n \n@@ -1008,7 +1013,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n \n   async deleteResource<T extends Resource = Resource>(resourceType: T['resourceType'], id: string): Promise<void> {\n     const startTime = Date.now();\n-    let resource: Resource;\n+    let resource: WithId<T>;\n     try {\n       resource = await this.readResourceImpl<T>(resourceType, id);\n     } catch (err) {\n@@ -1075,12 +1080,12 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     }\n   }\n \n-  async patchResource<T extends Resource = Resource>(\n+  async patchResource<T extends Resource>(\n     resourceType: T['resourceType'],\n     id: string,\n     patch: Operation[],\n     options?: UpdateResourceOptions\n-  ): Promise<T> {\n+  ): Promise<WithId<T>> {\n     const startTime = Date.now();\n     try {\n       return await this.withTransaction(async () => {\n@@ -1168,7 +1173,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     await new DeleteQuery(resourceType + '_History').where('lastUpdated', '<=', before).execute(client);\n   }\n \n-  async search<T extends Resource>(searchRequest: SearchRequest<T>): Promise<Bundle<T>> {\n+  async search<T extends Resource>(searchRequest: SearchRequest<T>): Promise<Bundle<WithId<T>>> {\n     const startTime = Date.now();\n     try {\n       // Resource type validation is performed in the searchImpl function\n@@ -1185,7 +1190,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n \n   async processAllResources<T extends Resource>(\n     initialSearchRequest: SearchRequest<T>,\n-    process: (resource: T) => Promise<void>,\n+    process: (resource: WithId<T>) => Promise<void>,\n     options?: ProcessAllResourcesOptions\n   ): Promise<void> {\n     let searchRequest: SearchRequest<T> | undefined = initialSearchRequest;\n@@ -1196,7 +1201,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n       }\n       for (const entry of bundle.entry) {\n         if (entry.resource?.id) {\n-          await process(entry.resource);\n+          await process(entry.resource as WithId<T>);\n         }\n       }\n       const nextLink = bundle.link?.find((b) => b.relation === 'next');\n@@ -1215,10 +1220,10 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     searchRequest: SearchRequest<T>,\n     referenceField: string,\n     references: string[]\n-  ): Promise<Record<string, T[]>> {\n+  ): Promise<Record<string, WithId<T>[]>> {\n     const startTime = Date.now();\n     try {\n-      const result = await searchByReferenceImpl<T>(this, searchRequest, referenceField, references);\n+      const result = await searchByReferenceImpl(this, searchRequest, referenceField, references);\n       const durationMs = Date.now() - startTime;\n       this.logEvent(SearchInteraction, AuditEventOutcome.Success, undefined, { searchRequest, durationMs });\n       return result;\n@@ -1396,7 +1401,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n    * @param resource - The resource.\n    * @returns The list of compartments for the resource.\n    */\n-  private getCompartments(resource: Resource): Reference[] {\n+  private getCompartments(resource: WithId<Resource>): Reference[] {\n     const compartments = new Set<string>();\n \n     if (resource.meta?.project && validator.isUUID(resource.meta.project)) {\n@@ -1827,7 +1832,10 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n    * @param updated - The incoming updated resource.\n    * @returns The account values.\n    */\n-  private async getAccounts(existing: Resource | undefined, updated: Resource): Promise<Reference[] | undefined> {\n+  private async getAccounts(\n+    existing: WithId<Resource> | undefined,\n+    updated: WithId<Resource>\n+  ): Promise<Reference[] | undefined> {\n     const updatedAccounts = this.extractAccountReferences(updated.meta);\n     if (updatedAccounts && this.canWriteAccount()) {\n       // If the user specifies an account, allow it if they have permission.\n@@ -2409,13 +2417,13 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n   private async getCacheEntry<T extends Resource>(\n     resourceType: string,\n     id: string\n-  ): Promise<CacheEntry<T> | undefined> {\n+  ): Promise<CacheEntry<WithId<T>> | undefined> {\n     // No cache access allowed mid-transaction\n     if (this.transactionDepth) {\n       return undefined;\n     }\n     const cachedValue = await getRedis().get(getCacheKey(resourceType, id));\n-    return cachedValue ? (JSON.parse(cachedValue) as CacheEntry<T>) : undefined;\n+    return cachedValue ? (JSON.parse(cachedValue) as CacheEntry<WithId<T>>) : undefined;\n   }\n \n   /**\n\ndiff --git a/packages/server/src/fhir/search.ts b/packages/server/src/fhir/search.ts\nindex bf05eccae4..c35f2d24cf 100644\n--- a/packages/server/src/fhir/search.ts\n+++ b/packages/server/src/fhir/search.ts\n@@ -31,6 +31,7 @@ import {\n   toPeriod,\n   toTypedValue,\n   validateResourceType,\n+  WithId,\n } from '@medplum/core';\n import {\n   Bundle,\n@@ -107,7 +108,7 @@ interface ChainedSearchParameter {\n export async function searchImpl<T extends Resource>(\n   repo: Repository,\n   searchRequest: SearchRequest<T>\n-): Promise<Bundle<T>> {\n+): Promise<Bundle<WithId<T>>> {\n   validateSearchResourceTypes(repo, searchRequest);\n   applyCountAndOffsetLimits(searchRequest);\n \n@@ -138,7 +139,7 @@ export async function searchByReferenceImpl<T extends Resource>(\n   searchRequest: SearchRequest<T>,\n   referenceField: string,\n   referenceValues: string[]\n-): Promise<Record<string, T[]>> {\n+): Promise<Record<string, WithId<T>[]>> {\n   validateSearchResourceTypes(repo, searchRequest);\n   applyCountAndOffsetLimits(searchRequest);\n \n@@ -181,12 +182,12 @@ export async function searchByReferenceImpl<T extends Resource>(\n     ref: string;\n   }[] = await builder.execute(repo.getDatabaseClient(DatabaseMode.READER));\n \n-  const results: Record<string, T[]> = {};\n+  const results: Record<string, WithId<T>[]> = Object.create(null);\n   for (const ref of referenceValues) {\n     results[ref] = [];\n   }\n   for (const row of rows) {\n-    const resource = JSON.parse(row.content) as T;\n+    const resource = JSON.parse(row.content) as WithId<T>;\n     removeResourceFields(resource, repo, searchRequest);\n     results[row.ref].push(resource);\n   }\n@@ -290,17 +291,17 @@ async function getSearchEntries<T extends Resource>(\n   repo: Repository,\n   searchRequest: SearchRequestWithCountAndOffset<T>,\n   builder: SelectQuery\n-): Promise<{ entry: BundleEntry<T>[]; rowCount: number; nextResource?: T }> {\n+): Promise<{ entry: BundleEntry<WithId<T>>[]; rowCount: number; nextResource?: T }> {\n   const rows = await builder.execute(repo.getDatabaseClient(DatabaseMode.READER));\n   const rowCount = rows.length;\n-  const resources = rows.map((row) => JSON.parse(row.content as string)) as T[];\n+  const resources = rows.map((row) => JSON.parse(row.content)) as WithId<T>[];\n   let nextResource: T | undefined;\n   if (resources.length > searchRequest.count) {\n     nextResource = resources.pop();\n   }\n   const entries = resources.map(\n-    (resource): BundleEntry<T> => ({\n-      fullUrl: getFullUrl(resource.resourceType, resource.id as string),\n+    (resource): BundleEntry<WithId<T>> => ({\n+      fullUrl: getFullUrl(resource.resourceType, resource.id),\n       search: { mode: 'match' },\n       resource,\n     })\n@@ -480,7 +481,7 @@ async function getSearchIncludeEntries(\n     }\n   }\n \n-  const includedResources = (await repo.readReferences(references)).filter(isResource);\n+  const includedResources = (await repo.readReferences(references)).filter((v) => isResource(v));\n   if (searchParam.target && canonicalReferences.length > 0) {\n     const canonicalSearches = searchParam.target.map((resourceType) => {\n       const searchRequest = {\n\ndiff --git a/packages/server/src/oauth/middleware.ts b/packages/server/src/oauth/middleware.ts\nindex 8271659b59..d0e58e3334 100644\n--- a/packages/server/src/oauth/middleware.ts\n+++ b/packages/server/src/oauth/middleware.ts\n@@ -1,4 +1,4 @@\n-import { OperationOutcomeError, ProfileResource, unauthorized } from '@medplum/core';\n+import { OperationOutcomeError, ProfileResource, unauthorized, WithId } from '@medplum/core';\n import { Login, Project, ProjectMembership } from '@medplum/fhirtypes';\n import { NextFunction, Request, Response } from 'express';\n import { IncomingMessage } from 'http';\n@@ -8,12 +8,12 @@ import { getConfig } from '../config/loader';\n \n export interface AuthState {\n   login: Login;\n-  project: Project;\n-  membership: ProjectMembership;\n+  project: WithId<Project>;\n+  membership: WithId<ProjectMembership>;\n   accessToken?: string;\n \n-  onBehalfOf?: ProfileResource;\n-  onBehalfOfMembership?: ProjectMembership;\n+  onBehalfOf?: WithId<ProfileResource>;\n+  onBehalfOfMembership?: WithId<ProjectMembership>;\n }\n \n export const PROMPT_BASIC_AUTH_PARAM = '_medplum-prompt-basic-auth';\n\ndiff --git a/packages/server/src/oauth/token.ts b/packages/server/src/oauth/token.ts\nindex a7054c623f..e5d4e92e44 100644\n--- a/packages/server/src/oauth/token.ts\n+++ b/packages/server/src/oauth/token.ts\n@@ -5,6 +5,7 @@ import {\n   OAuthTokenType,\n   Operator,\n   ProfileResource,\n+  WithId,\n   createReference,\n   getStatus,\n   isJwt,\n@@ -103,7 +104,7 @@ async function handleClientCredentials(req: Request, res: Response): Promise<voi\n   }\n \n   const systemRepo = getSystemRepo();\n-  let client: ClientApplication;\n+  let client: WithId<ClientApplication>;\n   try {\n     client = await systemRepo.readResource<ClientApplication>('ClientApplication', clientId);\n   } catch (_err) {\n\ndiff --git a/packages/server/src/oauth/utils.ts b/packages/server/src/oauth/utils.ts\nindex 96cddf7cfb..b9ed8f5375 100644\n--- a/packages/server/src/oauth/utils.ts\n+++ b/packages/server/src/oauth/utils.ts\n@@ -12,6 +12,7 @@ import {\n   ProfileResource,\n   resolveId,\n   tooManyRequests,\n+  WithId,\n   unauthorized,\n } from '@medplum/core';\n import {\n@@ -358,7 +359,9 @@ export async function getMembershipsForLogin(login: Login): Promise<ProjectMembe\n  * @param client - The client application.\n  * @returns The project membership for the client application if found; otherwise undefined.\n  */\n-export function getClientApplicationMembership(client: ClientApplication): Promise<ProjectMembership | undefined> {\n+export function getClientApplicationMembership(\n+  client: WithId<ClientApplication>\n+): Promise<WithId<ProjectMembership> | undefined> {\n   const systemRepo = getSystemRepo();\n   return systemRepo.searchOne<ProjectMembership>({\n     resourceType: 'ProjectMembership',\n@@ -675,9 +678,9 @@ export async function getUserByEmail(email: string, projectId: string | undefine\n  * @param projectId - The project ID.\n  * @returns The user if found; otherwise, undefined.\n  */\n-export async function getUserByEmailInProject(email: string, projectId: string): Promise<User | undefined> {\n+export async function getUserByEmailInProject(email: string, projectId: string): Promise<WithId<User> | undefined> {\n   const systemRepo = getSystemRepo();\n-  const bundle = await systemRepo.search({\n+  const bundle = await systemRepo.search<User>({\n     resourceType: 'User',\n     filters: [\n       {\n@@ -692,7 +695,7 @@ export async function getUserByEmailInProject(email: string, projectId: string):\n       },\n     ],\n   });\n-  return bundle.entry && bundle.entry.length > 0 ? (bundle.entry[0].resource as User) : undefined;\n+  return bundle.entry && bundle.entry.length > 0 ? bundle.entry[0].resource : undefined;\n }\n \n /**\n@@ -701,9 +704,9 @@ export async function getUserByEmailInProject(email: string, projectId: string):\n  * @param email - The email string.\n  * @returns The user if found; otherwise, undefined.\n  */\n-export async function getUserByEmailWithoutProject(email: string): Promise<User | undefined> {\n+export async function getUserByEmailWithoutProject(email: string): Promise<WithId<User> | undefined> {\n   const systemRepo = getSystemRepo();\n-  const bundle = await systemRepo.search({\n+  const bundle = await systemRepo.search<User>({\n     resourceType: 'User',\n     filters: [\n       {\n@@ -718,7 +721,7 @@ export async function getUserByEmailWithoutProject(email: string): Promise<User\n       },\n     ],\n   });\n-  return bundle.entry && bundle.entry.length > 0 ? (bundle.entry[0].resource as User) : undefined;\n+  return bundle.entry && bundle.entry.length > 0 ? bundle.entry[0].resource : undefined;\n }\n \n /**\n@@ -895,7 +898,7 @@ export async function getLoginForBasicAuth(req: IncomingMessage, token: string):\n   }\n \n   const systemRepo = getSystemRepo();\n-  let client: ClientApplication;\n+  let client: WithId<ClientApplication>;\n   try {\n     client = await systemRepo.readResource<ClientApplication>('ClientApplication', username);\n   } catch (_err) {\n@@ -939,7 +942,7 @@ async function tryAddOnBehalfOf(req: IncomingMessage | undefined, authState: Aut\n     throw new OperationOutcomeError(unauthorized);\n   }\n \n-  let onBehalfOfMembership: ProjectMembership | undefined = undefined;\n+  let onBehalfOfMembership: WithId<ProjectMembership> | undefined = undefined;\n \n   const adminRepo = await getRepoForLogin(authState);\n \n\ndiff --git a/packages/server/src/openapi.ts b/packages/server/src/openapi.ts\nindex a73696fb97..5c744efaf8 100644\n--- a/packages/server/src/openapi.ts\n+++ b/packages/server/src/openapi.ts\n@@ -1,4 +1,4 @@\n-import { isResource } from '@medplum/core';\n+import { isResourceWithId } from '@medplum/core';\n import { Request, Response } from 'express';\n import { JSONSchema4 } from 'json-schema';\n import type {\n@@ -525,5 +525,5 @@ function buildPatchPath(): any {\n \n function isResourceType(definition: JSONSchema4): boolean {\n   const props = definition.properties;\n-  return !!(isResource(props) && 'id' in props && 'meta' in props);\n+  return !!(isResourceWithId(props) && 'meta' in props);\n }\n\ndiff --git a/packages/server/src/scim/utils.ts b/packages/server/src/scim/utils.ts\nindex 42ed0b235d..ba3f8d68fe 100644\n--- a/packages/server/src/scim/utils.ts\n+++ b/packages/server/src/scim/utils.ts\n@@ -5,6 +5,7 @@ import {\n   OperationOutcomeError,\n   Operator,\n   SearchRequest,\n+  WithId,\n } from '@medplum/core';\n import { Project, ProjectMembership, Reference, User } from '@medplum/fhirtypes';\n import { Operation } from 'rfc6902';\n@@ -24,7 +25,7 @@ import { ScimListResponse, ScimPatchRequest, ScimUser } from './types';\n  * @returns List of SCIM users in the project.\n  */\n export async function searchScimUsers(\n-  project: Project,\n+  project: WithId<Project>,\n   params: Record<string, string>\n ): Promise<ScimListResponse<ScimUser>> {\n   const searchRequest = {\n\ndiff --git a/packages/server/src/workers/batch.ts b/packages/server/src/workers/batch.ts\nindex 27ef8e8875..d33c32e989 100644\n--- a/packages/server/src/workers/batch.ts\n+++ b/packages/server/src/workers/batch.ts\n@@ -5,6 +5,7 @@ import {\n   isOk,\n   OperationOutcomeError,\n   serverError,\n+  WithId,\n } from '@medplum/core';\n import { FhirRequest, FhirRouter } from '@medplum/fhir-router';\n import { AsyncJob, Bundle, Login, Project, ProjectMembership } from '@medplum/fhirtypes';\n@@ -26,8 +27,8 @@ export interface BatchJobData {\n   readonly asyncJob: AsyncJob;\n   readonly bundle: Bundle;\n   readonly login: Login;\n-  readonly project: Project;\n-  readonly membership: ProjectMembership;\n+  readonly project: WithId<Project>;\n+  readonly membership: WithId<ProjectMembership>;\n   readonly requestId?: string;\n   readonly traceId?: string;\n }\n\ndiff --git a/packages/server/src/workers/reindex.ts b/packages/server/src/workers/reindex.ts\nindex 58e5da86e8..d0738b794f 100644\n--- a/packages/server/src/workers/reindex.ts\n+++ b/packages/server/src/workers/reindex.ts\n@@ -1,4 +1,4 @@\n-import { Operator, SearchRequest, normalizeErrorString, parseSearchRequest } from '@medplum/core';\n+import { Operator, SearchRequest, normalizeErrorString, parseSearchRequest, WithId } from '@medplum/core';\n import { AsyncJob, Parameters, ParametersParameter, Resource, ResourceType } from '@medplum/fhirtypes';\n import { Job, Queue, QueueBaseOptions, Worker } from 'bullmq';\n import { MedplumServerConfig } from '../config/types';\n@@ -189,7 +189,7 @@ async function processPage(job: Job<ReindexJobData>): Promise<ReindexResult> {\n     await systemRepo.withTransaction(async (conn) => {\n       const bundle = await systemRepo.search(searchRequest);\n       if (bundle.entry?.length) {\n-        const resources = bundle.entry.map((e) => e.resource as Resource);\n+        const resources = bundle.entry.map((e) => e.resource as WithId<Resource>);\n         await systemRepo.reindexResources(conn, resources);\n         newCount += resources.length;\n         nextTimestamp = bundle.entry[bundle.entry.length - 1].resource?.meta?.lastUpdated ?? nextTimestamp;\n\ndiff --git a/packages/server/src/workers/subscription.ts b/packages/server/src/workers/subscription.ts\nindex dce3383405..f3441f7b5b 100644\n--- a/packages/server/src/workers/subscription.ts\n+++ b/packages/server/src/workers/subscription.ts\n@@ -5,6 +5,7 @@ import {\n   ContentType,\n   OperationOutcomeError,\n   Operator,\n+  WithId,\n   createReference,\n   getExtension,\n   getExtensionValue,\n@@ -366,7 +367,7 @@ async function getSubscriptions(resource: Resource, project: Project): Promise<S\n         await redis.srem(setKey, inactiveSubs);\n       }\n       const subArrStr = '[' + activeSubStrs.join(',') + ']';\n-      const inMemorySubs = JSON.parse(subArrStr) as { resource: Subscription; projectId: string }[];\n+      const inMemorySubs = JSON.parse(subArrStr) as { resource: WithId<Subscription>; projectId: string }[];\n       for (const { resource } of inMemorySubs) {\n         subscriptions.push(resource);\n       }\n\ndiff --git a/packages/server/src/workers/utils.ts b/packages/server/src/workers/utils.ts\nindex c955287e27..f7dff6c46b 100644\n--- a/packages/server/src/workers/utils.ts\n+++ b/packages/server/src/workers/utils.ts\n@@ -89,7 +89,7 @@ export async function createAuditEvent(\n }\n \n export function createAuditEventEntities(...resources: unknown[]): AuditEventEntity[] {\n-  return resources.filter(isResource).map(createAuditEventEntity);\n+  return resources.filter((v) => isResource(v)).map(createAuditEventEntity);\n }\n \n export function createAuditEventEntity(resource: Resource): AuditEventEntity {\n",
    "test_patch": "diff --git a/examples/medplum-chart-demo/src/bots/core/obstetric-encounter.test.ts b/examples/medplum-chart-demo/src/bots/core/obstetric-encounter.test.ts\nindex 6cdfd09d87..261dc2e713 100644\n--- a/examples/medplum-chart-demo/src/bots/core/obstetric-encounter.test.ts\n+++ b/examples/medplum-chart-demo/src/bots/core/obstetric-encounter.test.ts\n@@ -84,10 +84,10 @@ describe('Obstetric Encounter Note', async () => {\n     const responseBundle = await handler(medplum, { bot, input: onlyCondition, contentType, secrets: {} });\n \n     const observations = await medplum.searchResources('Observation', {\n-      encounter: getReferenceString(encounter),\n+      encounter: getReferenceString(testEncounter),\n     });\n     const clinicalImpressions = await medplum.searchResources('ClinicalImpression', {\n-      encounter: getReferenceString(encounter),\n+      encounter: getReferenceString(testEncounter),\n     });\n \n     expect(responseBundle.entry?.length).toBe(1);\n\ndiff --git a/examples/medplum-demo-bots/src/deduplication/merge-matching-patients.test.ts b/examples/medplum-demo-bots/src/deduplication/merge-matching-patients.test.ts\nindex c9f2d3ea4f..b097a22bc5 100644\n--- a/examples/medplum-demo-bots/src/deduplication/merge-matching-patients.test.ts\n+++ b/examples/medplum-demo-bots/src/deduplication/merge-matching-patients.test.ts\n@@ -1,4 +1,4 @@\n-import { ContentType, MedplumClient, createReference, getStatus, isOperationOutcome } from '@medplum/core';\n+import { ContentType, MedplumClient, WithId, createReference, getStatus, isOperationOutcome } from '@medplum/core';\n import { OperationOutcome, Patient, ServiceRequest } from '@medplum/fhirtypes';\n import { Mock, vi } from 'vitest';\n import {\n@@ -38,13 +38,13 @@ describe('Deduplication', () => {\n       resourceType: 'Patient',\n       id: 'src',\n       name: [{ given: ['Homer'], family: 'Simpson' }],\n-    } as Patient;\n+    } as WithId<Patient>;\n \n     const targetPatient = {\n       resourceType: 'Patient',\n       id: 'target',\n       name: [{ given: ['Lisa'], family: 'Simpson' }],\n-    } as Patient;\n+    } as WithId<Patient>;\n \n     const result = linkPatientRecords(srcPatient, targetPatient);\n \n@@ -66,14 +66,14 @@ describe('Deduplication', () => {\n       resourceType: 'Patient',\n       id: 'src',\n       name: [{ given: ['Homer'], family: 'Simpson' }],\n-    } as Patient;\n+    } as WithId<Patient>;\n \n     const targetPatient = {\n       resourceType: 'Patient',\n       id: 'target',\n       name: [{ given: ['Lisa'], family: 'Simpson' }],\n       link: [{ other: [createReference({ resourceType: 'Patient', id: '123' })], type: 'seealso' }],\n-    } as Patient;\n+    } as WithId<Patient>;\n \n     const result = linkPatientRecords(srcPatient, targetPatient);\n \n@@ -92,7 +92,7 @@ describe('Deduplication', () => {\n       active: false,\n       name: [{ given: ['Homer'], family: 'Simpson' }],\n       link: [{ other: { reference: 'Patient/target' }, type: 'replaced-by' }],\n-    } as Patient;\n+    } as WithId<Patient>;\n \n     const targetPatient = {\n       resourceType: 'Patient',\n@@ -100,7 +100,7 @@ describe('Deduplication', () => {\n       active: true,\n       name: [{ given: ['Lisa'], family: 'Simpson' }],\n       link: [{ other: createReference(srcPatient), type: 'replaces' }],\n-    } as Patient;\n+    } as WithId<Patient>;\n \n     const result = unlinkPatientRecords(srcPatient, targetPatient);\n \n@@ -114,13 +114,13 @@ describe('Deduplication', () => {\n       resourceType: 'Patient',\n       id: 'src',\n       identifier: [{ use: 'usual', system: 'http://foo.org', value: '123' }],\n-    } as Patient;\n+    } as WithId<Patient>;\n \n     const targetPatient = {\n       resourceType: 'Patient',\n       id: 'target',\n       identifier: [{ use: 'official', system: 'http://bar.org', value: '456' }],\n-    } as Patient;\n+    } as WithId<Patient>;\n \n     const fields = {\n       address: [{ city: 'Springfield' }],\n@@ -141,13 +141,13 @@ describe('Deduplication', () => {\n     const srcPatient = {\n       resourceType: 'Patient',\n       id: 'src',\n-    } as Patient;\n+    } as WithId<Patient>;\n \n     const targetPatient = {\n       resourceType: 'Patient',\n       id: 'target',\n       identifier: [{ use: 'usual', value: '123', system: 'http://example.org' }],\n-    } as Patient;\n+    } as WithId<Patient>;\n \n     const fields = {\n       address: [{ city: 'Springfield' }],\n@@ -170,12 +170,12 @@ describe('Deduplication', () => {\n     const srcPatient = {\n       resourceType: 'Patient',\n       id: 'src',\n-    } as Patient;\n+    } as WithId<Patient>;\n     const targetPatient = {\n       resourceType: 'Patient',\n       id: 'target',\n       name: [{ given: ['Lisa'], family: 'Simpson' }],\n-    } as Patient;\n+    } as WithId<Patient>;\n     const fetch = mockFetch(200, (url: string) => {\n       if (url.includes('subject=')) {\n         return {\n\ndiff --git a/packages/core/src/client-test-utils.ts b/packages/core/src/client-test-utils.ts\nindex 76940e862c..5404401ea1 100644\n--- a/packages/core/src/client-test-utils.ts\n+++ b/packages/core/src/client-test-utils.ts\n@@ -4,7 +4,7 @@ import { ContentType } from './contenttype';\n import { generateId } from './crypto';\n import { OperationOutcomeError, badRequest, getStatus, isOperationOutcome } from './outcomes';\n import { ReadablePromise } from './readablepromise';\n-import { ProfileResource, ensureNoLeadingSlash } from './utils';\n+import { ProfileResource, WithId, ensureNoLeadingSlash } from './utils';\n \n export function mockFetch(\n   status: number,\n@@ -98,16 +98,16 @@ export class MockMedplumClient extends MedplumClient {\n     this.nextResourceId = 'DEFAULT_MOCK_ID';\n   }\n \n-  get<T = any>(url: string | URL, _options?: RequestInit): ReadablePromise<T> {\n-    return new ReadablePromise<T>(Promise.resolve<T>(this.router.fetchRoute<T>('GET', url.toString())));\n+  get<T = any>(url: string | URL, _options?: RequestInit): ReadablePromise<WithId<T>> {\n+    return new ReadablePromise<WithId<T>>(Promise.resolve(this.router.fetchRoute<WithId<T>>('GET', url.toString())));\n   }\n \n   addNextResourceId(id: string): void {\n     this.nextResourceId = id;\n   }\n \n-  createResource<T extends Resource = Resource>(resource: T, _options?: RequestInit): Promise<T> {\n-    return Promise.resolve<T>({ ...resource, id: this.nextResourceId });\n+  createResource<T extends Resource = Resource>(resource: T, _options?: RequestInit): Promise<WithId<T>> {\n+    return Promise.resolve({ ...resource, id: this.nextResourceId });\n   }\n \n   setProfile(profile: Practitioner | undefined): void {\n\ndiff --git a/packages/core/src/client.test.ts b/packages/core/src/client.test.ts\nindex 63a9f3fdd5..17c207f457 100644\n--- a/packages/core/src/client.test.ts\n+++ b/packages/core/src/client.test.ts\n@@ -41,7 +41,7 @@ import {\n } from './outcomes';\n import { MockAsyncClientStorage } from './storage';\n import { getDataType, isDataTypeLoaded, isProfileLoaded } from './typeschema/types';\n-import { ProfileResource, createReference, sleep } from './utils';\n+import { ProfileResource, WithId, createReference, sleep } from './utils';\n \n const EXAMPLE_XML = `\n <note>\n@@ -1603,13 +1603,13 @@ describe('Client', () => {\n     const fetch = mockFetch(200, {});\n     const client = new MedplumClient({ fetch });\n     try {\n-      await client.updateResource({} as Patient);\n+      await client.updateResource({} as unknown as WithId<Patient>);\n       fail('Expected error');\n     } catch (err) {\n       expect((err as Error).message).toStrictEqual('Missing resourceType');\n     }\n     try {\n-      await client.updateResource({ resourceType: 'Patient' });\n+      await client.updateResource({ resourceType: 'Patient' } as unknown as WithId<Patient>);\n       fail('Expected error');\n     } catch (err) {\n       expect((err as Error).message).toStrictEqual('Missing id');\n\ndiff --git a/packages/fhir-router/src/repo.test.ts b/packages/fhir-router/src/repo.test.ts\nindex 32713216cf..4f3ae4b0af 100644\n--- a/packages/fhir-router/src/repo.test.ts\n+++ b/packages/fhir-router/src/repo.test.ts\n@@ -7,6 +7,7 @@ import {\n   notFound,\n   OperationOutcomeError,\n   parseSearchRequest,\n+  WithId,\n } from '@medplum/core';\n import { readJson } from '@medplum/definitions';\n import { Bundle, Observation, Patient, Resource, ResourceType, SearchParameter } from '@medplum/fhirtypes';\n@@ -143,7 +144,7 @@ describe('MemoryRepository', () => {\n   });\n \n   describe('searchByReference', () => {\n-    async function createPatients(repo: MemoryRepository, count: number): Promise<Patient[]> {\n+    async function createPatients(repo: MemoryRepository, count: number): Promise<WithId<Patient>[]> {\n       const patients = [];\n       for (let i = 0; i < count; i++) {\n         patients.push(await repo.createResource<Patient>({ resourceType: 'Patient' }));\n@@ -151,7 +152,11 @@ describe('MemoryRepository', () => {\n       return patients;\n     }\n \n-    async function createObservations(repo: MemoryRepository, count: number, patient: Patient): Promise<Observation[]> {\n+    async function createObservations(\n+      repo: MemoryRepository,\n+      count: number,\n+      patient: Patient\n+    ): Promise<WithId<Observation>[]> {\n       const resources = [];\n       for (let i = 0; i < count; i++) {\n         resources.push(\n@@ -177,7 +182,7 @@ describe('MemoryRepository', () => {\n     ): void {\n       expect(Object.keys(results)).toHaveLength(parents.length);\n       for (const [parent, children] of zip(parents, childrenByParent)) {\n-        const result = results[getReferenceString(parent)];\n+        const result = results[getReferenceString(parent) as string];\n         expect(result).toHaveLength(Math.min(children.length - offset, count));\n         for (const child of result) {\n           expect(children.map((c) => c.id)).toContain(child.id);\n\ndiff --git a/packages/react/src/BookmarkDialog/BookmarkDialog.test.tsx b/packages/react/src/BookmarkDialog/BookmarkDialog.test.tsx\nindex f8bc70413d..3d2fa4b22c 100644\n--- a/packages/react/src/BookmarkDialog/BookmarkDialog.test.tsx\n+++ b/packages/react/src/BookmarkDialog/BookmarkDialog.test.tsx\n@@ -4,10 +4,11 @@ import { MockClient } from '@medplum/mock';\n import { MedplumProvider } from '@medplum/react-hooks';\n import { act, fireEvent, render, screen } from '../test-utils/render';\n import { BookmarkDialog } from './BookmarkDialog';\n+import { WithId } from '@medplum/core';\n \n jest.mock('@mantine/notifications');\n \n-function getTestUserConfiguration(id: string): UserConfiguration {\n+function getTestUserConfiguration(id: string): WithId<UserConfiguration> {\n   return {\n     id,\n     resourceType: 'UserConfiguration',\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5592",
    "pr_id": 5592,
    "issue_id": 5590,
    "repo": "medplum/medplum",
    "problem_statement": "Incorrect default values for OAuth config settings\nSee: https://github.com/medplum/medplum/blob/main/packages/server/src/config.ts#L278-L280\r\n\r\nExisting:\r\n\r\n```ts\r\n  config.authorizeUrl = config.authorizeUrl || config.baseUrl + '/authorize';\r\n  config.tokenUrl = config.tokenUrl || config.baseUrl + '/token';\r\n  config.userInfoUrl = config.userInfoUrl || config.baseUrl + '/userinfo';\r\n```\r\n\r\nCorrect:\r\n\r\n```ts\r\n  config.authorizeUrl = config.authorizeUrl || config.baseUrl + '/oauth2/authorize';\r\n  config.tokenUrl = config.tokenUrl || config.baseUrl + '/oauth2/token';\r\n  config.userInfoUrl = config.userInfoUrl || config.baseUrl + '/oauth2/userinfo';\r\n```",
    "issue_word_count": 71,
    "test_files_count": 2,
    "non_test_files_count": 5,
    "pr_changed_files": [
      "packages/server/medplum.config.json",
      "packages/server/src/cloud/aws/signer.ts",
      "packages/server/src/cloud/aws/storage.ts",
      "packages/server/src/config.ts",
      "packages/server/src/fhir/rewrite.test.ts",
      "packages/server/src/fhir/storage.ts",
      "packages/server/src/util/auditevent.test.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/rewrite.test.ts",
      "packages/server/src/util/auditevent.test.ts"
    ],
    "base_commit": "7ede7f9a064408dc34da2af2b2ad299da9271ab7",
    "head_commit": "ddddc1ae4680cea90c97fd30676427310880b3d2",
    "repo_url": "https://github.com/medplum/medplum/pull/5592",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5592",
    "dockerfile": "",
    "pr_merged_at": "2024-11-26T21:26:10.000Z",
    "patch": "diff --git a/packages/server/medplum.config.json b/packages/server/medplum.config.json\nindex d9ddcf45b2..5ca33b82b7 100644\n--- a/packages/server/medplum.config.json\n+++ b/packages/server/medplum.config.json\n@@ -1,12 +1,6 @@\n {\n   \"port\": 8103,\n   \"baseUrl\": \"http://localhost:8103/\",\n-  \"issuer\": \"http://localhost:8103/\",\n-  \"audience\": \"http://localhost:8103/\",\n-  \"jwksUrl\": \"http://localhost:8103/.well-known/jwks.json\",\n-  \"authorizeUrl\": \"http://localhost:8103/oauth2/authorize\",\n-  \"tokenUrl\": \"http://localhost:8103/oauth2/token\",\n-  \"userInfoUrl\": \"http://localhost:8103/oauth2/userinfo\",\n   \"appBaseUrl\": \"http://localhost:3000/\",\n   \"binaryStorage\": \"file:./binary/\",\n   \"storageBaseUrl\": \"http://localhost:8103/storage/\",\n\ndiff --git a/packages/server/src/cloud/aws/signer.ts b/packages/server/src/cloud/aws/signer.ts\nindex e33001b78f..b4cdd803f2 100644\n--- a/packages/server/src/cloud/aws/signer.ts\n+++ b/packages/server/src/cloud/aws/signer.ts\n@@ -1,4 +1,5 @@\n import { getSignedUrl } from '@aws-sdk/cloudfront-signer';\n+import { concatUrls } from '@medplum/core';\n import { Binary } from '@medplum/fhirtypes';\n import { getConfig } from '../../config';\n \n@@ -13,7 +14,7 @@ import { getConfig } from '../../config';\n export function getPresignedUrl(binary: Binary): string {\n   const config = getConfig();\n   const storageBaseUrl = config.storageBaseUrl;\n-  const unsignedUrl = `${storageBaseUrl}${binary.id}/${binary.meta?.versionId}`;\n+  const unsignedUrl = concatUrls(storageBaseUrl, `${binary.id}/${binary.meta?.versionId}`);\n   const dateLessThan = new Date();\n   dateLessThan.setHours(dateLessThan.getHours() + 1);\n   return getSignedUrl({\n\ndiff --git a/packages/server/src/cloud/aws/storage.ts b/packages/server/src/cloud/aws/storage.ts\nindex d5082215f6..5aea717b28 100644\n--- a/packages/server/src/cloud/aws/storage.ts\n+++ b/packages/server/src/cloud/aws/storage.ts\n@@ -1,6 +1,7 @@\n import { CopyObjectCommand, GetObjectCommand, S3Client } from '@aws-sdk/client-s3';\n import { getSignedUrl } from '@aws-sdk/cloudfront-signer';\n import { Upload } from '@aws-sdk/lib-storage';\n+import { concatUrls } from '@medplum/core';\n import { Binary } from '@medplum/fhirtypes';\n import { Readable } from 'stream';\n import { getConfig } from '../../config';\n@@ -115,7 +116,7 @@ export class S3Storage implements BinaryStorage {\n   getPresignedUrl(binary: Binary): string {\n     const config = getConfig();\n     const storageBaseUrl = config.storageBaseUrl;\n-    const unsignedUrl = `${storageBaseUrl}${binary.id}/${binary.meta?.versionId}`;\n+    const unsignedUrl = concatUrls(storageBaseUrl, `${binary.id}/${binary.meta?.versionId}`);\n     const dateLessThan = new Date();\n     dateLessThan.setHours(dateLessThan.getHours() + 1);\n     return getSignedUrl({\n\ndiff --git a/packages/server/src/config.ts b/packages/server/src/config.ts\nindex 9cca9fccaf..7cbd5d382f 100644\n--- a/packages/server/src/config.ts\n+++ b/packages/server/src/config.ts\n@@ -1,4 +1,4 @@\n-import { splitN } from '@medplum/core';\n+import { concatUrls, splitN } from '@medplum/core';\n import { KeepJobs } from 'bullmq';\n import { mkdtempSync, readFileSync } from 'fs';\n import { tmpdir } from 'os';\n@@ -274,11 +274,11 @@ async function loadFileConfig(path: string): Promise<MedplumServerConfig> {\n function addDefaults(config: MedplumServerConfig): MedplumServerConfig {\n   config.port = config.port || 8103;\n   config.issuer = config.issuer || config.baseUrl;\n-  config.jwksUrl = config.jwksUrl || config.baseUrl + '/.well-known/jwks.json';\n-  config.authorizeUrl = config.authorizeUrl || config.baseUrl + '/oauth2/authorize';\n-  config.tokenUrl = config.tokenUrl || config.baseUrl + '/oauth2/token';\n-  config.userInfoUrl = config.userInfoUrl || config.baseUrl + '/oauth2/userinfo';\n-  config.storageBaseUrl = config.storageBaseUrl || config.baseUrl + '/storage';\n+  config.jwksUrl = config.jwksUrl || concatUrls(config.baseUrl, '/.well-known/jwks.json');\n+  config.authorizeUrl = config.authorizeUrl || concatUrls(config.baseUrl, '/oauth2/authorize');\n+  config.tokenUrl = config.tokenUrl || concatUrls(config.baseUrl, '/oauth2/token');\n+  config.userInfoUrl = config.userInfoUrl || concatUrls(config.baseUrl, '/oauth2/userinfo');\n+  config.storageBaseUrl = config.storageBaseUrl || concatUrls(config.baseUrl, '/storage');\n   config.maxJsonSize = config.maxJsonSize || '1mb';\n   config.maxBatchSize = config.maxBatchSize || '50mb';\n   config.awsRegion = config.awsRegion || DEFAULT_AWS_REGION;\n\ndiff --git a/packages/server/src/fhir/storage.ts b/packages/server/src/fhir/storage.ts\nindex 1d70d3fd12..7f2b480e45 100644\n--- a/packages/server/src/fhir/storage.ts\n+++ b/packages/server/src/fhir/storage.ts\n@@ -1,3 +1,4 @@\n+import { concatUrls } from '@medplum/core';\n import { Binary } from '@medplum/fhirtypes';\n import { createSign } from 'crypto';\n import { copyFileSync, createReadStream, createWriteStream, existsSync, mkdirSync } from 'fs';\n@@ -129,7 +130,7 @@ class FileSystemStorage implements BinaryStorage {\n   getPresignedUrl(binary: Binary): string {\n     const config = getConfig();\n     const storageBaseUrl = config.storageBaseUrl;\n-    const result = new URL(`${storageBaseUrl}${binary.id}/${binary.meta?.versionId}`);\n+    const result = new URL(concatUrls(storageBaseUrl, `${binary.id}/${binary.meta?.versionId}`));\n \n     const dateLessThan = new Date();\n     dateLessThan.setHours(dateLessThan.getHours() + 1);\n",
    "test_patch": "diff --git a/packages/server/src/fhir/rewrite.test.ts b/packages/server/src/fhir/rewrite.test.ts\nindex aa9ea3ed8b..88e12ec1f1 100644\n--- a/packages/server/src/fhir/rewrite.test.ts\n+++ b/packages/server/src/fhir/rewrite.test.ts\n@@ -1,4 +1,4 @@\n-import { ContentType, createReference, deepClone, getReferenceString } from '@medplum/core';\n+import { ContentType, concatUrls, createReference, deepClone, getReferenceString } from '@medplum/core';\n import { Binary, Bundle, Media, Patient, Practitioner } from '@medplum/fhirtypes';\n import { randomUUID } from 'crypto';\n import { URL } from 'url';\n@@ -202,7 +202,7 @@ describe('URL rewrite', () => {\n       photo: [\n         {\n           contentType: 'image/jpeg',\n-          url: `${config.storageBaseUrl}${binary.id}`,\n+          url: concatUrls(config.storageBaseUrl, binary.id as string),\n         },\n       ],\n     };\n\ndiff --git a/packages/server/src/util/auditevent.test.ts b/packages/server/src/util/auditevent.test.ts\nindex 59b051712d..da8be224ff 100644\n--- a/packages/server/src/util/auditevent.test.ts\n+++ b/packages/server/src/util/auditevent.test.ts\n@@ -7,8 +7,7 @@ import {\n import { AuditEvent } from '@medplum/fhirtypes';\n import { AwsClientStub, mockClient } from 'aws-sdk-client-mock';\n import 'aws-sdk-client-mock-jest';\n-import fs from 'fs';\n-import { loadConfig } from '../config';\n+import { loadTestConfig } from '../config';\n import { waitFor } from '../test.setup';\n import { logAuditEvent } from './auditevent';\n \n@@ -34,9 +33,8 @@ describe('AuditEvent utils', () => {\n     console.info = jest.fn();\n     console.log = jest.fn();\n \n-    jest.spyOn(fs, 'readFileSync').mockReturnValue(JSON.stringify({ logAuditEvents: false }));\n-\n-    await loadConfig('file:test.json');\n+    const config = await loadTestConfig();\n+    config.logAuditEvents = false;\n \n     logAuditEvent({ resourceType: 'AuditEvent' } as AuditEvent);\n \n@@ -47,8 +45,8 @@ describe('AuditEvent utils', () => {\n   test('AuditEvent to console.log', async () => {\n     console.log = jest.fn();\n \n-    jest.spyOn(fs, 'readFileSync').mockReturnValue(JSON.stringify({ logAuditEvents: true }));\n-    await loadConfig('file:test.json');\n+    const config = await loadTestConfig();\n+    config.logAuditEvents = true;\n \n     // Log an AuditEvent\n     logAuditEvent({ resourceType: 'AuditEvent' } as AuditEvent);\n@@ -61,16 +59,10 @@ describe('AuditEvent utils', () => {\n     console.info = jest.fn();\n     console.log = jest.fn();\n \n-    // Mock readFileSync for custom config file\n-    jest.spyOn(fs, 'readFileSync').mockReturnValue(\n-      JSON.stringify({\n-        logAuditEvents: true,\n-        auditEventLogGroup: 'test-log-group',\n-        auditEventLogStream: 'test-log-stream',\n-      })\n-    );\n-\n-    await loadConfig('file:test.json');\n+    const config = await loadTestConfig();\n+    config.logAuditEvents = true;\n+    config.auditEventLogGroup = 'test-log-group';\n+    config.auditEventLogStream = 'test-log-stream';\n \n     // Log an AuditEvent\n     logAuditEvent({ resourceType: 'AuditEvent' } as AuditEvent);\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5587",
    "pr_id": 5587,
    "issue_id": 5584,
    "repo": "medplum/medplum",
    "problem_statement": "Support AsyncJob cancel via DELETE request on `Content-Location`\nAs part of the Asynchronous Request Pattern spec:\nhttps://www.hl7.org/fhir/R4/async.html#3.1.6.3.0.2\n\nWe missed this on our initial pass working towards data migrations but I found we had already stubbed this route out here:\nhttps://github.com/medplum/medplum/blob/585e3cb3b1ac18acb2bdf0694d790c8899830278/packages/server/src/fhir/job.ts#L36",
    "issue_word_count": 67,
    "test_files_count": 2,
    "non_test_files_count": 3,
    "pr_changed_files": [
      "packages/server/src/fhir/job.test.ts",
      "packages/server/src/fhir/job.ts",
      "packages/server/src/fhir/operations/asyncjobcancel.test.ts",
      "packages/server/src/fhir/operations/asyncjobcancel.ts",
      "packages/server/src/fhir/routes.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/job.test.ts",
      "packages/server/src/fhir/operations/asyncjobcancel.test.ts"
    ],
    "base_commit": "63c50e00d78256aa782c1bf42d464ef6c5825d0e",
    "head_commit": "7d67bd5e573a914fd65d9f11c09bf231d47ba515",
    "repo_url": "https://github.com/medplum/medplum/pull/5587",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5587",
    "dockerfile": "",
    "pr_merged_at": "2024-11-23T00:59:19.000Z",
    "patch": "diff --git a/packages/server/src/fhir/job.ts b/packages/server/src/fhir/job.ts\nindex 5d14e76dec..c39362dc84 100644\n--- a/packages/server/src/fhir/job.ts\n+++ b/packages/server/src/fhir/job.ts\n@@ -1,10 +1,13 @@\n-import { accepted, allOk } from '@medplum/core';\n+import { accepted, allOk, isOk } from '@medplum/core';\n+import { FhirRequest, HttpMethod } from '@medplum/fhir-router';\n import { AsyncJob, OperationOutcome } from '@medplum/fhirtypes';\n import { Request, Response, Router } from 'express';\n import { asyncWrap } from '../async';\n import { getConfig } from '../config';\n import { getAuthenticatedContext } from '../context';\n+import { asyncJobCancelHandler } from './operations/asyncjobcancel';\n import { AsyncJobExecutor } from './operations/utils/asyncjobexecutor';\n+import { sendOutcome } from './outcomes';\n import { sendFhirResponse } from './response';\n \n // Asychronous Job Status API\n@@ -33,6 +36,44 @@ jobRouter.get(\n   })\n );\n \n-jobRouter.delete('/:id/status', (req: Request, res: Response) => {\n-  res.sendStatus(202);\n-});\n+jobRouter.delete(\n+  '/:id/status',\n+  asyncWrap(async (req: Request, res: Response) => {\n+    let normalizedOutcome: OperationOutcome;\n+    const request: FhirRequest = {\n+      method: req.method as HttpMethod,\n+      url: req.originalUrl.replace('/fhir/R4', ''),\n+      pathname: '',\n+      params: req.params,\n+      query: {},\n+      body: req.body,\n+      headers: req.headers,\n+    };\n+    const [outcome] = await asyncJobCancelHandler(request);\n+    if (isOk(outcome)) {\n+      // We need an `accepted` outcome without the location set since the spec for async requests only wants the 202 header\n+      // And an optional OperationOutcome body\n+      // Source: https://www.hl7.org/fhir/R4/async.html#3.1.6.3.0.2\n+      /* 3.1.6.3.0.2 Response - Success\n+       * HTTP Status Code of 202 Accepted\n+       * Optionally a FHIR OperationOutcome in the body\n+       */\n+      normalizedOutcome = {\n+        resourceType: 'OperationOutcome',\n+        id: 'accepted',\n+        issue: [\n+          {\n+            severity: 'information',\n+            code: 'informational',\n+            details: {\n+              text: 'Accepted',\n+            },\n+          },\n+        ],\n+      };\n+    } else {\n+      normalizedOutcome = outcome;\n+    }\n+    sendOutcome(res, normalizedOutcome);\n+  })\n+);\n\ndiff --git a/packages/server/src/fhir/operations/asyncjobcancel.ts b/packages/server/src/fhir/operations/asyncjobcancel.ts\nindex b8af3f2c47..4b45103601 100644\n--- a/packages/server/src/fhir/operations/asyncjobcancel.ts\n+++ b/packages/server/src/fhir/operations/asyncjobcancel.ts\n@@ -1,9 +1,7 @@\n import { allOk, assert, badRequest } from '@medplum/core';\n+import { FhirRequest, FhirResponse } from '@medplum/fhir-router';\n import { AsyncJob, OperationDefinition } from '@medplum/fhirtypes';\n-import { Request, Response } from 'express';\n-import { asyncWrap } from '../../async';\n import { getAuthenticatedContext } from '../../context';\n-import { sendOutcome } from '../outcomes';\n import { getSystemRepo } from '../repo';\n \n export const operation: OperationDefinition = {\n@@ -24,8 +22,11 @@ export const operation: OperationDefinition = {\n /**\n  * Handles HTTP requests for the AsyncJob $cancel operation.\n  * Sets the status of the `AsyncJob` to `cancelled`.\n+ *\n+ * @param req - A request to cancel a particular async job.\n+ * @returns A FhirResponse.\n  */\n-export const asyncJobCancelHandler = asyncWrap(async (req: Request, res: Response) => {\n+export async function asyncJobCancelHandler(req: FhirRequest): Promise<FhirResponse> {\n   assert(req.params.id, 'This operation can only be executed on an instance');\n   // Update status of async job\n   const { repo } = getAuthenticatedContext();\n@@ -48,10 +49,7 @@ export const asyncJobCancelHandler = asyncWrap(async (req: Request, res: Respons\n     case 'cancelled':\n       break;\n     default:\n-      sendOutcome(\n-        res,\n-        badRequest(`AsyncJob cannot be cancelled if status is not 'accepted', job had status '${job.status}'`)\n-      );\n+      return [badRequest(`AsyncJob cannot be cancelled if status is not 'accepted', job had status '${job.status}'`)];\n   }\n-  sendOutcome(res, allOk);\n-});\n+  return [allOk];\n+}\n\ndiff --git a/packages/server/src/fhir/routes.ts b/packages/server/src/fhir/routes.ts\nindex b7d17db1d3..ce6413cd9a 100644\n--- a/packages/server/src/fhir/routes.ts\n+++ b/packages/server/src/fhir/routes.ts\n@@ -124,9 +124,6 @@ protectedRoutes.get('/:resourceType/([$]|%24)csv', asyncWrap(csvHandler));\n protectedRoutes.post('/Agent/([$]|%24)push', agentPushHandler);\n protectedRoutes.post('/Agent/:id/([$]|%24)push', agentPushHandler);\n \n-// AsyncJob $cancel operation\n-protectedRoutes.post('/AsyncJob/:id/([$]|%24)cancel', asyncJobCancelHandler);\n-\n // Bot $execute operation\n // Allow extra path content after the \"$execute\" to support external callers who append path info\n const botPaths = [\n@@ -227,6 +224,9 @@ function initInternalFhirRouter(): FhirRouter {\n   router.add('GET', '/Agent/$upgrade', agentUpgradeHandler);\n   router.add('GET', '/Agent/:id/$upgrade', agentUpgradeHandler);\n \n+  // AsyncJob $cancel operation\n+  router.add('POST', '/AsyncJob/:id/$cancel', asyncJobCancelHandler);\n+\n   // Bot $deploy operation\n   router.add('POST', '/Bot/:id/$deploy', deployHandler);\n \n",
    "test_patch": "diff --git a/packages/server/src/fhir/job.test.ts b/packages/server/src/fhir/job.test.ts\nindex 12c2c63794..6bc66b260b 100644\n--- a/packages/server/src/fhir/job.test.ts\n+++ b/packages/server/src/fhir/job.test.ts\n@@ -1,3 +1,5 @@\n+import { ContentType } from '@medplum/core';\n+import { AsyncJob } from '@medplum/fhirtypes';\n import { randomUUID } from 'crypto';\n import express from 'express';\n import request from 'supertest';\n@@ -51,7 +53,7 @@ describe('Job status', () => {\n       const job = await asyncJobManager.init('http://example.com');\n       const callback = jest.fn();\n \n-      await asyncJobManager.start(async () => {\n+      asyncJobManager.start(async () => {\n         callback();\n       });\n \n@@ -68,16 +70,90 @@ describe('Job status', () => {\n       expect(res.body).toEqual(expect.objectContaining({ id: job.id, request: job.request, status: 'completed' }));\n     }));\n \n-  test('cancel', () =>\n+  test('Cancel -- Happy path', () =>\n     withTestContext(async () => {\n       const job = await asyncJobManager.init('http://example.com');\n \n+      const res1 = await request(app)\n+        .get(`/fhir/R4/job/${job.id}/status`)\n+        .set('Authorization', 'Bearer ' + accessToken);\n+      expect(res1.status).toEqual(202);\n+      expect(res1.body?.status).toEqual('accepted');\n+\n+      // Cancel the job\n+      const res2 = await request(app)\n+        .delete(`/fhir/R4/job/${job.id}/status`)\n+        .set('Authorization', 'Bearer ' + accessToken);\n+      expect(res2.status).toEqual(202);\n+      expect(res2.body).toMatchObject({\n+        resourceType: 'OperationOutcome',\n+        id: 'accepted',\n+        issue: [\n+          {\n+            severity: 'information',\n+            code: 'informational',\n+            details: {\n+              text: 'Accepted',\n+            },\n+          },\n+        ],\n+      });\n+\n+      // Check if AsyncJob.status === 'cancelled'\n+      const res3 = await request(app)\n+        .get(`/fhir/R4/AsyncJob/${job.id as string}`)\n+        .set('Authorization', 'Bearer ' + accessToken)\n+        .set('Content-Type', ContentType.FHIR_JSON);\n+\n+      expect(res3.status).toEqual(200);\n+      expect(res3.body).toMatchObject<AsyncJob>({\n+        id: job.id,\n+        resourceType: 'AsyncJob',\n+        status: 'cancelled',\n+        requestTime: job.requestTime,\n+        request: 'http://example.com',\n+      });\n+    }));\n+\n+  test('Cancel -- error (job already completed)', () =>\n+    withTestContext(async () => {\n+      const job = await asyncJobManager.init('http://example.com');\n+      const callback = jest.fn();\n+\n+      asyncJobManager.start(async () => {\n+        callback();\n+      });\n+\n+      expect(callback).toHaveBeenCalled();\n+\n+      await waitForAsyncJob(asyncJobManager.getContentLocation('http://example.com/'), app, accessToken);\n+\n       const res = await request(app)\n+        .get(`/fhir/R4/job/${job.id}/status`)\n+        .set('Authorization', 'Bearer ' + accessToken);\n+\n+      expect(res.status).toBe(200);\n+      expect(res.get('Content-Type')).toEqual('application/fhir+json; charset=utf-8');\n+      expect(res.body).toEqual(expect.objectContaining({ id: job.id, request: job.request, status: 'completed' }));\n+\n+      // Now try to cancel the job after it's already completed\n+      const res2 = await request(app)\n         .delete(`/fhir/R4/job/${job.id}/status`)\n         .set('Authorization', 'Bearer ' + accessToken);\n \n-      expect(res.status).toBe(202);\n-      expect(res.get('Content-Type')).toEqual('text/plain; charset=utf-8');\n-      expect(res.body).toEqual({});\n+      expect(res2.status).toBe(400);\n+      expect(res2.get('Content-Type')).toEqual('application/fhir+json; charset=utf-8');\n+      expect(res2.body).toMatchObject({\n+        resourceType: 'OperationOutcome',\n+        issue: [\n+          {\n+            code: 'invalid',\n+            details: {\n+              text: \"AsyncJob cannot be cancelled if status is not 'accepted', job had status 'completed'\",\n+            },\n+            severity: 'error',\n+          },\n+        ],\n+      });\n     }));\n });\n\ndiff --git a/packages/server/src/fhir/operations/asyncjobcancel.test.ts b/packages/server/src/fhir/operations/asyncjobcancel.test.ts\nindex e5f0010dae..33d75623cc 100644\n--- a/packages/server/src/fhir/operations/asyncjobcancel.test.ts\n+++ b/packages/server/src/fhir/operations/asyncjobcancel.test.ts\n@@ -1,4 +1,5 @@\n-import { allOk, badRequest, ContentType, sleep } from '@medplum/core';\n+import { allOk, badRequest, ContentType } from '@medplum/core';\n+import { FhirRequest } from '@medplum/fhir-router';\n import { AsyncJob, OperationOutcome } from '@medplum/fhirtypes';\n import express from 'express';\n import request from 'supertest';\n@@ -129,12 +130,18 @@ describe('AsyncJob/$cancel', () => {\n   });\n \n   test('Fails if not executed on an instance (no ID given)', async () => {\n-    const next = jest.fn();\n-    expect(() => asyncJobCancelHandler({ params: {} } as express.Request, {} as express.Response, next)).not.toThrow();\n-    while (next.mock.calls.length === 0) {\n-      await sleep(100);\n-    }\n-    expect(next).toHaveBeenCalledWith(new Error('This operation can only be executed on an instance'));\n+    const req = {\n+      method: 'POST',\n+      url: 'AsyncJob/$cancel',\n+      pathname: '',\n+      params: {},\n+      query: {},\n+      body: '',\n+      headers: {},\n+    } satisfies FhirRequest;\n+    await expect(asyncJobCancelHandler(req)).rejects.toThrow(\n+      new Error('This operation can only be executed on an instance')\n+    );\n   });\n \n   test('Cancelled job does not get added to super admin project', () =>\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5577",
    "pr_id": 5577,
    "issue_id": 5576,
    "repo": "medplum/medplum",
    "problem_statement": "Calling `AsyncJob/$cancel` adds an `AsyncJob` to the Super Admin project\n<img width=\"1182\" alt=\"Screenshot 2024-11-21 at 3 41 28 PM\" src=\"https://github.com/user-attachments/assets/b7327f2b-84bb-436f-9ca1-0ca2c3c11424\">\r\n",
    "issue_word_count": 36,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/server/src/fhir/operations/asyncjobcancel.test.ts",
      "packages/server/src/fhir/operations/asyncjobcancel.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/operations/asyncjobcancel.test.ts"
    ],
    "base_commit": "bd4e034982cc617353df258b8ea1283252eff5ef",
    "head_commit": "05f427896f7b40d51876ba4a004d2cc6f9df03dd",
    "repo_url": "https://github.com/medplum/medplum/pull/5577",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5577",
    "dockerfile": "",
    "pr_merged_at": "2024-11-22T18:24:04.000Z",
    "patch": "diff --git a/packages/server/src/fhir/operations/asyncjobcancel.ts b/packages/server/src/fhir/operations/asyncjobcancel.ts\nindex c7f415b819..b8af3f2c47 100644\n--- a/packages/server/src/fhir/operations/asyncjobcancel.ts\n+++ b/packages/server/src/fhir/operations/asyncjobcancel.ts\n@@ -4,6 +4,7 @@ import { Request, Response } from 'express';\n import { asyncWrap } from '../../async';\n import { getAuthenticatedContext } from '../../context';\n import { sendOutcome } from '../outcomes';\n+import { getSystemRepo } from '../repo';\n \n export const operation: OperationDefinition = {\n   id: 'AsyncJob-cancel',\n@@ -28,10 +29,18 @@ export const asyncJobCancelHandler = asyncWrap(async (req: Request, res: Respons\n   assert(req.params.id, 'This operation can only be executed on an instance');\n   // Update status of async job\n   const { repo } = getAuthenticatedContext();\n+  // We read with the users repo to make sure they have permissions for this\n   const job = await repo.readResource<AsyncJob>('AsyncJob', req.params.id);\n   switch (job.status) {\n     case 'accepted':\n-      await repo.patchResource('AsyncJob', req.params.id, [\n+      // We patch with system repo so that AsyncJob is not added to a project\n+      // This occurs because the behavior when a super admin updates a resource is different depending on whether\n+      // The `X-Medplum` header is set or not\n+      // With the header set (ie. `X-Medplum: extended`), the resource will be added to the Super Admin project\n+      // With the header NOT set, the resource will not be added to any project and remain without a project\n+      // Using system repo always maintains that the resource is not added to a project\n+      // Due to it lacking any projects listed in `context.projects`\n+      await getSystemRepo().patchResource('AsyncJob', req.params.id, [\n         { op: 'test', path: '/status', value: 'accepted' },\n         { op: 'add', path: '/status', value: 'cancelled' },\n       ]);\n",
    "test_patch": "diff --git a/packages/server/src/fhir/operations/asyncjobcancel.test.ts b/packages/server/src/fhir/operations/asyncjobcancel.test.ts\nindex b0105f1332..e5f0010dae 100644\n--- a/packages/server/src/fhir/operations/asyncjobcancel.test.ts\n+++ b/packages/server/src/fhir/operations/asyncjobcancel.test.ts\n@@ -4,7 +4,8 @@ import express from 'express';\n import request from 'supertest';\n import { initApp, shutdownApp } from '../../app';\n import { loadTestConfig } from '../../config';\n-import { initTestAuth } from '../../test.setup';\n+import { initTestAuth, withTestContext } from '../../test.setup';\n+import { getSystemRepo } from '../repo';\n import { asyncJobCancelHandler } from './asyncjobcancel';\n \n const app = express();\n@@ -14,7 +15,7 @@ describe('AsyncJob/$cancel', () => {\n \n   beforeAll(async () => {\n     const config = await loadTestConfig();\n-    await initApp(app, config);\n+    await withTestContext(() => initApp(app, config));\n   });\n \n   beforeEach(async () => {\n@@ -135,4 +136,44 @@ describe('AsyncJob/$cancel', () => {\n     }\n     expect(next).toHaveBeenCalledWith(new Error('This operation can only be executed on an instance'));\n   });\n+\n+  test('Cancelled job does not get added to super admin project', () =>\n+    withTestContext(async () => {\n+      // We create the resource with system repo so that it is like how system AsyncJobs get created\n+      const asyncJob = await getSystemRepo().createResource<AsyncJob>({\n+        resourceType: 'AsyncJob',\n+        status: 'accepted',\n+        requestTime: new Date().toISOString(),\n+        request: 'random-request',\n+      });\n+\n+      const res2 = await request(app)\n+        .post(`/fhir/R4/AsyncJob/${asyncJob.id as string}/$cancel`)\n+        .set('Authorization', 'Bearer ' + accessToken)\n+        .set('X-Medplum', 'extended');\n+      expect(res2.status).toEqual(200);\n+      expect(res2.body).toMatchObject(allOk);\n+\n+      const res3 = await request(app)\n+        .get(`/fhir/R4/AsyncJob/${asyncJob.id}`)\n+        .set('Authorization', 'Bearer ' + accessToken)\n+        .set('X-Medplum', 'extended');\n+\n+      expect(res3.status).toEqual(200);\n+      expect(res3.body).toEqual({\n+        id: asyncJob.id as string,\n+        resourceType: 'AsyncJob',\n+        requestTime: asyncJob.requestTime,\n+        request: 'random-request',\n+        status: 'cancelled',\n+        meta: {\n+          lastUpdated: expect.any(String),\n+          versionId: expect.any(String),\n+          author: {\n+            reference: 'system',\n+          },\n+          // We make sure meta does not contain project\n+        },\n+      });\n+    }));\n });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5559",
    "pr_id": 5559,
    "issue_id": 5558,
    "repo": "medplum/medplum",
    "problem_statement": "Be able to set lambda timeout via Bot resource\nThe default timeout for AWS lambda is 15s, which can be too short for some applications of Bots. \r\nRight now the only way to set a Bot timeout is to log into the AWS console and manually set it on the Lambda resource\r\n\r\n## Proposal\r\n\r\n- [ ] Add a new element on the `Bot` resource called `timeout`, that specifies the timeout (in seconds)\r\n- [ ] When [Bot deploy](https://www.medplum.com/docs/api/fhir/operations/bot-deploy#invoke-deploy-operation) is called, update the underlying runner (e.g. AWS Lambda) with the appropriate timeout configuration",
    "issue_word_count": 100,
    "test_files_count": 2,
    "non_test_files_count": 9,
    "pr_changed_files": [
      "packages/definitions/dist/fhir/r4/fhir.schema.json",
      "packages/definitions/dist/fhir/r4/profiles-medplum.json",
      "packages/docs/static/data/medplumDefinitions/bot.json",
      "packages/fhirtypes/dist/Bot.d.ts",
      "packages/mock/src/mocks/structuredefinitions.json",
      "packages/server/src/cloud/aws/deploy.test.ts",
      "packages/server/src/cloud/aws/deploy.ts",
      "packages/server/src/fhir/operations/deploy.test.ts",
      "packages/server/src/fhir/operations/deploy.ts",
      "packages/server/src/fhir/operations/execute.ts",
      "packages/server/src/fhir/repo.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/cloud/aws/deploy.test.ts",
      "packages/server/src/fhir/operations/deploy.test.ts"
    ],
    "base_commit": "e337388c9a9888870249e3c3cb4308e25efee2bd",
    "head_commit": "e81d2a5dd4e4f6444078dfaffcb3365cbbd6f47a",
    "repo_url": "https://github.com/medplum/medplum/pull/5559",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5559",
    "dockerfile": "",
    "pr_merged_at": "2024-11-21T01:00:45.000Z",
    "patch": "diff --git a/packages/definitions/dist/fhir/r4/fhir.schema.json b/packages/definitions/dist/fhir/r4/fhir.schema.json\nindex c8b047bf70..741ab93673 100644\n--- a/packages/definitions/dist/fhir/r4/fhir.schema.json\n+++ b/packages/definitions/dist/fhir/r4/fhir.schema.json\n@@ -60321,6 +60321,10 @@\n           \"description\": \"The identifier of the bot runtime environment (i.e., vmcontext, awslambda, etc).\",\n           \"enum\": [\"awslambda\", \"vmcontext\"]\n         },\n+        \"timeout\": {\n+          \"description\": \"The maximum allowed execution time of the bot in seconds.\",\n+          \"$ref\": \"#/definitions/integer\"\n+        },\n         \"photo\": {\n           \"description\": \"Image of the bot.\",\n           \"$ref\": \"#/definitions/Attachment\"\n\ndiff --git a/packages/definitions/dist/fhir/r4/profiles-medplum.json b/packages/definitions/dist/fhir/r4/profiles-medplum.json\nindex a88f8f92a4..dd6338edf9 100644\n--- a/packages/definitions/dist/fhir/r4/profiles-medplum.json\n+++ b/packages/definitions/dist/fhir/r4/profiles-medplum.json\n@@ -1842,6 +1842,21 @@\n               \"valueSet\" : \"https://medplum.com/fhir/ValueSet/bot-runtime-version|4.0.1\"\n             }\n           },\n+          {\n+            \"id\" : \"Bot.timeout\",\n+            \"path\" : \"Bot.timeout\",\n+            \"definition\" : \"The maximum allowed execution time of the bot in seconds.\",\n+            \"min\" : 0,\n+            \"max\" : \"1\",\n+            \"type\" : [{\n+              \"code\" : \"integer\"\n+            }],\n+            \"base\" : {\n+              \"path\" : \"Bot.timeout\",\n+              \"min\" : 0,\n+              \"max\" : \"1\"\n+            }\n+          },\n           {\n             \"id\" : \"Bot.photo\",\n             \"path\" : \"Bot.photo\",\n\ndiff --git a/packages/docs/static/data/medplumDefinitions/bot.json b/packages/docs/static/data/medplumDefinitions/bot.json\nindex 717aeea185..912e37bf8e 100644\n--- a/packages/docs/static/data/medplumDefinitions/bot.json\n+++ b/packages/docs/static/data/medplumDefinitions/bot.json\n@@ -224,6 +224,22 @@\n       \"comment\": \"\",\n       \"inherited\": false\n     },\n+    {\n+      \"name\": \"timeout\",\n+      \"depth\": 1,\n+      \"types\": [\n+        {\n+          \"datatype\": \"integer\"\n+        }\n+      ],\n+      \"path\": \"Bot.timeout\",\n+      \"min\": 0,\n+      \"max\": \"1\",\n+      \"short\": \"\",\n+      \"definition\": \"The maximum allowed execution time of the bot in seconds.\",\n+      \"comment\": \"\",\n+      \"inherited\": false\n+    },\n     {\n       \"name\": \"photo\",\n       \"depth\": 1,\n\ndiff --git a/packages/fhirtypes/dist/Bot.d.ts b/packages/fhirtypes/dist/Bot.d.ts\nindex be3173fcae..c5c8eb30a5 100644\n--- a/packages/fhirtypes/dist/Bot.d.ts\n+++ b/packages/fhirtypes/dist/Bot.d.ts\n@@ -114,6 +114,11 @@ export interface Bot {\n    */\n   runtimeVersion?: 'awslambda' | 'vmcontext';\n \n+  /**\n+   * The maximum allowed execution time of the bot in seconds.\n+   */\n+  timeout?: number;\n+\n   /**\n    * Image of the bot.\n    */\n\ndiff --git a/packages/mock/src/mocks/structuredefinitions.json b/packages/mock/src/mocks/structuredefinitions.json\nindex 35df38c027..2b71525d1f 100644\n--- a/packages/mock/src/mocks/structuredefinitions.json\n+++ b/packages/mock/src/mocks/structuredefinitions.json\n@@ -12513,6 +12513,17 @@\n             }\n           ]\n         },\n+        {\n+          \"id\": \"Bot.timeout\",\n+          \"path\": \"Bot.timeout\",\n+          \"min\": 0,\n+          \"max\": \"1\",\n+          \"type\": [\n+            {\n+              \"code\": \"integer\"\n+            }\n+          ]\n+        },\n         {\n           \"id\": \"Bot.photo\",\n           \"path\": \"Bot.photo\",\n\ndiff --git a/packages/server/src/cloud/aws/deploy.ts b/packages/server/src/cloud/aws/deploy.ts\nindex 6ff2b8acf7..e5a44f1c2d 100644\n--- a/packages/server/src/cloud/aws/deploy.ts\n+++ b/packages/server/src/cloud/aws/deploy.ts\n@@ -7,6 +7,7 @@ import {\n   ListLayerVersionsCommand,\n   PackageType,\n   ResourceConflictException,\n+  ResourceNotFoundException,\n   UpdateFunctionCodeCommand,\n   UpdateFunctionConfigurationCommand,\n } from '@aws-sdk/client-lambda';\n@@ -17,11 +18,11 @@ import JSZip from 'jszip';\n import { getConfig } from '../../config';\n import { getLogger } from '../../context';\n \n-const LAMBDA_RUNTIME = 'nodejs18.x';\n-\n-const LAMBDA_HANDLER = 'index.handler';\n-\n-const LAMBDA_MEMORY = 1024;\n+export const LAMBDA_RUNTIME = 'nodejs18.x';\n+export const LAMBDA_HANDLER = 'index.handler';\n+export const LAMBDA_MEMORY = 1024;\n+export const DEFAULT_LAMBDA_TIMEOUT = 10;\n+export const MAX_LAMBDA_TIMEOUT = 900; // 60 * 15 (15 mins)\n \n const WRAPPER_CODE = `const { ContentType, Hl7Message, MedplumClient } = require(\"@medplum/core\");\n const fetch = require(\"node-fetch\");\n@@ -95,9 +96,47 @@ function createPdf(docDefinition, tableLayouts, fonts) {\n }\n `;\n \n+export function getLambdaNameForBot(bot: Bot): string {\n+  return `medplum-bot-lambda-${bot.id}`;\n+}\n+\n+export async function getLambdaTimeoutForBot(bot: Bot): Promise<number> {\n+  // Create a new AWS Lambda client\n+  // Use a custom retry strategy to avoid throttling errors\n+  // This is especially important when updating lambdas which also\n+  // involve upgrading the layer version.\n+\n+  const client = new LambdaClient({\n+    region: getConfig().awsRegion,\n+    retryStrategy: new ConfiguredRetryStrategy(\n+      5, // max attempts\n+      (attempt: number) => 500 * 2 ** attempt // Exponential backoff\n+    ),\n+  });\n+\n+  const name = getLambdaNameForBot(bot);\n+  let timeout: number;\n+  try {\n+    const command = new GetFunctionCommand({ FunctionName: name });\n+    const response = await client.send(command);\n+    timeout = response?.Configuration?.Timeout ?? DEFAULT_LAMBDA_TIMEOUT;\n+  } catch (err) {\n+    if (err instanceof ResourceNotFoundException) {\n+      timeout = DEFAULT_LAMBDA_TIMEOUT;\n+    } else {\n+      throw err;\n+    }\n+  }\n+  return timeout;\n+}\n+\n export async function deployLambda(bot: Bot, code: string): Promise<void> {\n   const log = getLogger();\n \n+  if (bot.timeout !== undefined && bot.timeout > MAX_LAMBDA_TIMEOUT) {\n+    throw new Error('Bot timeout exceeds allowed maximum of 900 seconds');\n+  }\n+\n   // Create a new AWS Lambda client\n   // Use a custom retry strategy to avoid throttling errors\n   // This is especially important when updating lambdas which also\n@@ -110,16 +149,16 @@ export async function deployLambda(bot: Bot, code: string): Promise<void> {\n     ),\n   });\n \n-  const name = `medplum-bot-lambda-${bot.id}`;\n+  const name = getLambdaNameForBot(bot);\n   log.info('Deploying lambda function for bot', { name });\n   const zipFile = await createZipFile(code);\n   log.debug('Lambda function zip size', { bytes: zipFile.byteLength });\n \n   const exists = await lambdaExists(client, name);\n   if (!exists) {\n-    await createLambda(client, name, zipFile);\n+    await createLambda(bot, client, name, zipFile);\n   } else {\n-    await updateLambda(client, name, zipFile);\n+    await updateLambda(bot, client, name, zipFile);\n   }\n }\n \n@@ -141,18 +180,22 @@ async function lambdaExists(client: LambdaClient, name: string): Promise<boolean\n     const command = new GetFunctionCommand({ FunctionName: name });\n     const response = await client.send(command);\n     return response.Configuration?.FunctionName === name;\n-  } catch (_err) {\n-    return false;\n+  } catch (err) {\n+    if (err instanceof ResourceNotFoundException) {\n+      return false;\n+    }\n+    throw err;\n   }\n }\n \n /**\n  * Creates a new AWS Lambda for the bot name.\n+ * @param bot - The Bot resource for this bot.\n  * @param client - The AWS Lambda client.\n  * @param name - The bot name.\n  * @param zipFile - The zip file with the bot code.\n  */\n-async function createLambda(client: LambdaClient, name: string, zipFile: Uint8Array): Promise<void> {\n+async function createLambda(bot: Bot, client: LambdaClient, name: string, zipFile: Uint8Array): Promise<void> {\n   const layerVersion = await getLayerVersion(client);\n \n   await client.send(\n@@ -168,20 +211,21 @@ async function createLambda(client: LambdaClient, name: string, zipFile: Uint8Ar\n         ZipFile: zipFile,\n       },\n       Publish: true,\n-      Timeout: 10, // seconds\n+      Timeout: bot.timeout ?? DEFAULT_LAMBDA_TIMEOUT, // seconds\n     })\n   );\n }\n \n /**\n  * Updates an existing AWS Lambda for the bot name.\n+ * @param bot - The Bot resource for this bot.\n  * @param client - The AWS Lambda client.\n  * @param name - The bot name.\n  * @param zipFile - The zip file with the bot code.\n  */\n-async function updateLambda(client: LambdaClient, name: string, zipFile: Uint8Array): Promise<void> {\n+async function updateLambda(bot: Bot, client: LambdaClient, name: string, zipFile: Uint8Array): Promise<void> {\n   // First, make sure the lambda configuration is up to date\n-  await updateLambdaConfig(client, name);\n+  await updateLambdaConfig(bot, client, name);\n \n   // Then update the code\n   await updateLambdaCode(client, name, zipFile);\n@@ -189,16 +233,21 @@ async function updateLambda(client: LambdaClient, name: string, zipFile: Uint8Ar\n \n /**\n  * Updates the lambda configuration.\n+ * @param bot - The Bot resource for this bot.\n  * @param client - The AWS Lambda client.\n  * @param name - The lambda name.\n  */\n-async function updateLambdaConfig(client: LambdaClient, name: string): Promise<void> {\n+async function updateLambdaConfig(bot: Bot, client: LambdaClient, name: string): Promise<void> {\n   const layerVersion = await getLayerVersion(client);\n   const functionConfig = await getLambdaConfig(client, name);\n+\n+  const timeout = bot.timeout ?? DEFAULT_LAMBDA_TIMEOUT;\n+\n   if (\n     functionConfig.Runtime === LAMBDA_RUNTIME &&\n     functionConfig.Handler === LAMBDA_HANDLER &&\n-    functionConfig.Layers?.[0].Arn === layerVersion\n+    functionConfig.Layers?.[0].Arn === layerVersion &&\n+    functionConfig.Timeout === timeout\n   ) {\n     // Everything is up-to-date\n     return;\n@@ -212,6 +261,7 @@ async function updateLambdaConfig(client: LambdaClient, name: string): Promise<v\n       Runtime: LAMBDA_RUNTIME,\n       Handler: LAMBDA_HANDLER,\n       Layers: [layerVersion],\n+      Timeout: timeout,\n     })\n   );\n }\n\ndiff --git a/packages/server/src/fhir/operations/deploy.ts b/packages/server/src/fhir/operations/deploy.ts\nindex 6de7473975..85e4429705 100644\n--- a/packages/server/src/fhir/operations/deploy.ts\n+++ b/packages/server/src/fhir/operations/deploy.ts\n@@ -2,7 +2,7 @@ import { ContentType, allOk, badRequest, getReferenceString, normalizeOperationO\n import { FhirRequest, FhirResponse } from '@medplum/fhir-router';\n import { Attachment, Binary, Bot } from '@medplum/fhirtypes';\n import { Readable } from 'node:stream';\n-import { deployLambda } from '../../cloud/aws/deploy';\n+import { deployLambda, getLambdaTimeoutForBot } from '../../cloud/aws/deploy';\n import { getAuthenticatedContext } from '../../context';\n import { readStreamToString } from '../../util/streams';\n import { getSystemRepo } from '../repo';\n@@ -64,10 +64,16 @@ export async function deployHandler(req: FhirRequest): Promise<FhirResponse> {\n       codeToDeploy = await readStreamToString(stream);\n     }\n \n-    const latestBot = updatedBot ?? bot;\n+    let latestBot = updatedBot ?? bot;\n \n     // Deploy the bot\n     if (latestBot.runtimeVersion === 'awslambda') {\n+      if (latestBot.timeout === undefined) {\n+        latestBot = await ctx.repo.updateResource<Bot>({\n+          ...latestBot,\n+          timeout: await getLambdaTimeoutForBot(latestBot),\n+        });\n+      }\n       await deployLambda(latestBot, codeToDeploy as string);\n     }\n \n\ndiff --git a/packages/server/src/fhir/operations/execute.ts b/packages/server/src/fhir/operations/execute.ts\nindex 6d965fc209..a1b9dea47c 100644\n--- a/packages/server/src/fhir/operations/execute.ts\n+++ b/packages/server/src/fhir/operations/execute.ts\n@@ -51,6 +51,8 @@ import { sendFhirResponse } from '../response';\n import { getBinaryStorage } from '../storage';\n import { sendAsyncResponse } from './utils/asyncjobexecutor';\n \n+export const DEFAULT_VM_CONTEXT_TIMEOUT = 10000;\n+\n export interface BotExecutionRequest {\n   readonly bot: Bot;\n   readonly runAs: ProjectMembership;\n@@ -395,7 +397,7 @@ async function runInVmContext(request: BotExecutionContext): Promise<BotExecutio\n   };\n \n   const options: vm.RunningScriptOptions = {\n-    timeout: 10000,\n+    timeout: bot.timeout ? bot.timeout * 1000 : DEFAULT_VM_CONTEXT_TIMEOUT,\n   };\n \n   // Wrap code in an async block for top-level await support\n\ndiff --git a/packages/server/src/fhir/repo.ts b/packages/server/src/fhir/repo.ts\nindex 1abdf3b001..13e8951d48 100644\n--- a/packages/server/src/fhir/repo.ts\n+++ b/packages/server/src/fhir/repo.ts\n@@ -67,6 +67,7 @@ import validator from 'validator';\n import { getConfig } from '../config';\n import { getLogger } from '../context';\n import { DatabaseMode, getDatabasePool } from '../database';\n+import { recordHistogramValue } from '../otel/otel';\n import { getRedis } from '../redis';\n import { r4ProjectId } from '../seed';\n import {\n@@ -109,7 +110,6 @@ import {\n   periodToRangeString,\n } from './sql';\n import { getBinaryStorage } from './storage';\n-import { recordHistogramValue } from '../otel/otel';\n \n const transactionAttempts = 2;\n const retryableTransactionErrorCodes = ['40001'];\n@@ -1063,6 +1063,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n \n         const result = await this.updateResourceImpl(resource, false);\n         const durationMs = Date.now() - startTime;\n+\n         await this.postCommit(async () => {\n           this.logEvent(PatchInteraction, AuditEventOutcome.Success, undefined, { resource: result, durationMs });\n         });\n",
    "test_patch": "diff --git a/packages/server/src/cloud/aws/deploy.test.ts b/packages/server/src/cloud/aws/deploy.test.ts\nindex 7f5b646f96..1593c3f264 100644\n--- a/packages/server/src/cloud/aws/deploy.test.ts\n+++ b/packages/server/src/cloud/aws/deploy.test.ts\n@@ -6,24 +6,36 @@ import {\n   LambdaClient,\n   ListLayerVersionsCommand,\n   ResourceConflictException,\n+  ResourceNotFoundException,\n+  TooManyRequestsException,\n   UpdateFunctionCodeCommand,\n   UpdateFunctionConfigurationCommand,\n } from '@aws-sdk/client-lambda';\n-import { ContentType } from '@medplum/core';\n+import { allOk, badRequest, ContentType } from '@medplum/core';\n import { Bot } from '@medplum/fhirtypes';\n import { AwsClientStub, mockClient } from 'aws-sdk-client-mock';\n import 'aws-sdk-client-mock-jest';\n+import { randomUUID } from 'crypto';\n import express from 'express';\n import request from 'supertest';\n import { initApp, shutdownApp } from '../../app';\n-import { loadTestConfig } from '../../config';\n+import { getConfig, loadTestConfig } from '../../config';\n import { initTestAuth } from '../../test.setup';\n+import {\n+  DEFAULT_LAMBDA_TIMEOUT,\n+  getLambdaNameForBot,\n+  getLambdaTimeoutForBot,\n+  LAMBDA_HANDLER,\n+  LAMBDA_RUNTIME,\n+} from './deploy';\n \n-const app = express();\n-let accessToken: string;\n-let mockLambdaClient: AwsClientStub<LambdaClient>;\n+const TEST_LAYER_ARN = 'arn:aws:lambda:us-east-1:123456789012:layer:test-layer:1';\n \n describe('Deploy', () => {\n+  const app = express();\n+  let accessToken: string;\n+  let mockLambdaClient: AwsClientStub<LambdaClient>;\n+\n   beforeAll(async () => {\n     const config = await loadTestConfig();\n     await initApp(app, config);\n@@ -35,61 +47,77 @@ describe('Deploy', () => {\n   });\n \n   beforeEach(() => {\n-    let created = false;\n+    const lambdaMap = new Map<string, Record<string, any>>();\n \n     mockLambdaClient = mockClient(LambdaClient);\n \n-    mockLambdaClient.on(CreateFunctionCommand).callsFake(({ FunctionName }) => {\n-      created = true;\n-\n-      return {\n-        Configuration: {\n-          FunctionName,\n-        },\n+    mockLambdaClient.on(CreateFunctionCommand).callsFake(({ FunctionName, Timeout }) => {\n+      const lambdaConfig = {\n+        FunctionName,\n+        Timeout,\n       };\n+      lambdaMap.set(FunctionName, lambdaConfig);\n+      return { Configuration: lambdaConfig };\n     });\n \n     mockLambdaClient.on(GetFunctionCommand).callsFake(({ FunctionName }) => {\n-      if (created) {\n-        return {\n-          Configuration: {\n-            FunctionName,\n-          },\n-        };\n+      if (lambdaMap.has(FunctionName)) {\n+        const lambdaConfig = lambdaMap.get(FunctionName);\n+        return { Configuration: lambdaConfig };\n       }\n-\n-      return {\n-        Configuration: {},\n-      };\n+      // When the function is not found, a `ResourceNotFoundException` is thrown\n+      throw new ResourceNotFoundException({ $metadata: {}, message: 'Function not found' });\n     });\n \n     mockLambdaClient.on(GetFunctionConfigurationCommand).callsFake(({ FunctionName }) => {\n-      return {\n-        FunctionName,\n-        Runtime: 'nodejs18.x',\n-        Handler: 'index.handler',\n-        State: 'Active',\n-        Layers: [\n-          {\n-            Arn: 'arn:aws:lambda:us-east-1:123456789012:layer:test-layer:1',\n-          },\n-        ],\n-      };\n+      if (lambdaMap.has(FunctionName)) {\n+        const config = lambdaMap.get(FunctionName) as Record<string, any>;\n+        return {\n+          FunctionName,\n+          Timeout: config.Timeout ?? DEFAULT_LAMBDA_TIMEOUT,\n+          Runtime: 'nodejs18.x',\n+          Handler: 'index.handler',\n+          State: 'Active',\n+          Layers: [\n+            {\n+              Arn: TEST_LAYER_ARN,\n+            },\n+          ],\n+        };\n+      }\n+      throw new ResourceNotFoundException({ $metadata: {}, message: 'Function not found' });\n     });\n \n     mockLambdaClient.on(ListLayerVersionsCommand).resolves({\n       LayerVersions: [\n         {\n-          LayerVersionArn: 'arn:aws:lambda:us-east-1:123456789012:layer:test-layer:1',\n+          LayerVersionArn: TEST_LAYER_ARN,\n         },\n       ],\n     });\n \n-    mockLambdaClient.on(UpdateFunctionCodeCommand).callsFake(({ FunctionName }) => ({\n-      Configuration: {\n+    mockLambdaClient.on(UpdateFunctionConfigurationCommand).callsFake(({ FunctionName, Timeout }) => {\n+      const lambdaConfig = {\n         FunctionName,\n-      },\n-    }));\n+        Timeout,\n+      };\n+\n+      if (lambdaMap.has(FunctionName)) {\n+        lambdaMap.set(FunctionName, lambdaConfig);\n+        return { Configuration: lambdaConfig };\n+      }\n+\n+      throw new ResourceNotFoundException({ $metadata: {}, message: 'Function not found' });\n+    });\n+\n+    mockLambdaClient.on(UpdateFunctionCodeCommand).callsFake(({ FunctionName }) => {\n+      if (lambdaMap.has(FunctionName)) {\n+        const lambdaConfig = lambdaMap.get(FunctionName);\n+        return { Configuration: lambdaConfig };\n+      }\n+\n+      throw new ResourceNotFoundException({ $metadata: {}, message: 'Function not found' });\n+    });\n   });\n \n   afterEach(() => {\n@@ -133,7 +161,7 @@ describe('Deploy', () => {\n       });\n     expect(res2.status).toBe(200);\n \n-    expect(mockLambdaClient).toHaveReceivedCommandTimes(GetFunctionCommand, 1);\n+    expect(mockLambdaClient).toHaveReceivedCommandTimes(GetFunctionCommand, 2);\n     expect(mockLambdaClient).toHaveReceivedCommandTimes(ListLayerVersionsCommand, 1);\n     expect(mockLambdaClient).toHaveReceivedCommandTimes(CreateFunctionCommand, 1);\n     expect(mockLambdaClient).toHaveReceivedCommandWith(GetFunctionCommand, {\n@@ -206,7 +234,7 @@ describe('Deploy', () => {\n       });\n     expect(res2.status).toBe(200);\n \n-    expect(mockLambdaClient).toHaveReceivedCommandTimes(GetFunctionCommand, 1);\n+    expect(mockLambdaClient).toHaveReceivedCommandTimes(GetFunctionCommand, 2);\n     expect(mockLambdaClient).toHaveReceivedCommandTimes(ListLayerVersionsCommand, 1);\n     expect(mockLambdaClient).toHaveReceivedCommandTimes(CreateFunctionCommand, 1);\n     expect(mockLambdaClient).toHaveReceivedCommandWith(GetFunctionCommand, {\n@@ -265,4 +293,283 @@ describe('Deploy', () => {\n     expect(mockLambdaClient).toHaveReceivedCommandTimes(UpdateFunctionConfigurationCommand, 1);\n     expect(mockLambdaClient).toHaveReceivedCommandTimes(UpdateFunctionCodeCommand, 2);\n   });\n+\n+  test('Deploy bot with timeout configured', async () => {\n+    // Step 1: Create a bot with no timeout\n+    const res1 = await request(app)\n+      .post(`/fhir/R4/Bot`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        resourceType: 'Bot',\n+        name: 'Test Bot',\n+        runtimeVersion: 'awslambda',\n+        code: `\n+        export async function handler() {\n+          console.log('input', input);\n+          return input;\n+        }\n+        `,\n+      });\n+    expect(res1.status).toBe(201);\n+\n+    const bot = res1.body as Bot;\n+\n+    // Step 2: Deploy the bot without timeout ... check that default timeout was set on lambda\n+    const res2 = await request(app)\n+      .post(`/fhir/R4/Bot/${bot.id}/$deploy`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        code: `\n+      export async function handler() {\n+        console.log('input', input);\n+        return input;\n+      }\n+      `,\n+      });\n+    expect(res2.status).toBe(200);\n+    expect(res2.body).toMatchObject(allOk);\n+\n+    expect(mockLambdaClient).toHaveReceivedCommandTimes(GetFunctionCommand, 2);\n+    expect(mockLambdaClient).toHaveReceivedCommandTimes(ListLayerVersionsCommand, 1);\n+    expect(mockLambdaClient).toHaveReceivedCommandTimes(CreateFunctionCommand, 1);\n+\n+    mockLambdaClient.resetHistory();\n+\n+    // Step 3: Update bot to have to have a timeout\n+    const res3 = await request(app)\n+      .put(`/fhir/R4/Bot/${bot.id}`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        ...bot,\n+        timeout: 15,\n+      });\n+    expect(res3.status).toBe(200);\n+\n+    // Step 4: Deploy bot again\n+    const res4 = await request(app)\n+      .post(`/fhir/R4/Bot/${bot.id}/$deploy`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        code: `\n+      export async function handler() {\n+        console.log('input', input);\n+        return input;\n+      }\n+      `,\n+      });\n+    // expect(res4.status).toBe(200);\n+    expect(res4.body).toMatchObject(allOk);\n+\n+    // Make sure that timeout was updated\n+    expect(mockLambdaClient).toHaveReceivedCommandTimes(GetFunctionCommand, 1);\n+    expect(mockLambdaClient).toHaveReceivedCommandTimes(ListLayerVersionsCommand, 1);\n+    expect(mockLambdaClient).toHaveReceivedCommandTimes(GetFunctionConfigurationCommand, 1);\n+    expect(mockLambdaClient).toHaveReceivedCommandTimes(UpdateFunctionConfigurationCommand, 1);\n+    expect(mockLambdaClient).toHaveReceivedNthSpecificCommandWith(1, UpdateFunctionConfigurationCommand, {\n+      FunctionName: getLambdaNameForBot(bot),\n+      Role: getConfig().botLambdaRoleArn,\n+      Runtime: LAMBDA_RUNTIME,\n+      Handler: LAMBDA_HANDLER,\n+      Layers: [TEST_LAYER_ARN],\n+      Timeout: 15,\n+    });\n+\n+    mockLambdaClient.resetHistory();\n+\n+    // Step 5: Remove timeout\n+    // This actually tests that timeout is not overridden\n+    const res5 = await request(app)\n+      .put(`/fhir/R4/Bot/${bot.id}`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        ...bot,\n+      });\n+    expect(res5.status).toBe(200);\n+\n+    // Step 6: Deploy bot for final time\n+    const res6 = await request(app)\n+      .post(`/fhir/R4/Bot/${bot.id}/$deploy`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        code: `\n+      export async function handler() {\n+        console.log('input', input);\n+        return input;\n+      }\n+      `,\n+      });\n+    expect(res6.status).toBe(200);\n+    expect(res6.body).toMatchObject(allOk);\n+\n+    // Make sure that timeout was updated again\n+    expect(mockLambdaClient).toHaveReceivedCommandTimes(GetFunctionCommand, 2);\n+    expect(mockLambdaClient).toHaveReceivedCommandTimes(ListLayerVersionsCommand, 1);\n+    expect(mockLambdaClient).toHaveReceivedCommandTimes(GetFunctionConfigurationCommand, 1);\n+    expect(mockLambdaClient).toHaveReceivedCommandTimes(UpdateFunctionConfigurationCommand, 0);\n+  });\n+\n+  test('Deploying new Bot with no timeout results in Bot with default timeout', async () => {\n+    const botProps = {\n+      resourceType: 'Bot',\n+      name: 'Test Bot',\n+      runtimeVersion: 'awslambda',\n+      code: `\n+    export async function handler() {\n+      console.log('input', input);\n+      return input;\n+    }\n+    `,\n+    };\n+    const res1 = await request(app)\n+      .post(`/fhir/R4/Bot`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        ...botProps,\n+      });\n+    expect(res1.status).toBe(201);\n+\n+    const bot = res1.body as Bot;\n+\n+    const res2 = await request(app)\n+      .post(`/fhir/R4/Bot/${bot.id as string}/$deploy`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        code: `\n+      export async function handler() {\n+        console.log('input', input);\n+        return input;\n+      }\n+      `,\n+      });\n+    expect(res2.status).toBe(200);\n+    expect(res2.body).toMatchObject(allOk);\n+\n+    const res3 = await request(app)\n+      .get(`/fhir/R4/Bot/${bot.id as string}`)\n+      .set('Authorization', 'Bearer ' + accessToken);\n+    expect(res3.status).toBe(200);\n+    expect(res3.body).toMatchObject({ ...botProps, timeout: DEFAULT_LAMBDA_TIMEOUT });\n+\n+    expect(mockLambdaClient).toHaveReceivedCommandTimes(GetFunctionCommand, 2);\n+    expect(mockLambdaClient).toHaveReceivedCommandTimes(ListLayerVersionsCommand, 1);\n+    expect(mockLambdaClient).toHaveReceivedCommandTimes(GetFunctionConfigurationCommand, 0);\n+    expect(mockLambdaClient).toHaveReceivedCommandTimes(UpdateFunctionConfigurationCommand, 0);\n+    expect(mockLambdaClient).toHaveReceivedCommandTimes(UpdateFunctionCodeCommand, 0);\n+  });\n+\n+  test('Deploy fails when Bot timeout is greater than max', async () => {\n+    const res1 = await request(app)\n+      .post(`/fhir/R4/Bot`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        resourceType: 'Bot',\n+        name: 'Test Bot',\n+        runtimeVersion: 'awslambda',\n+        code: `\n+        export async function handler() {\n+          console.log('input', input);\n+          return input;\n+        }\n+        `,\n+        timeout: 1000,\n+      });\n+    expect(res1.status).toBe(201);\n+\n+    const bot = res1.body as Bot;\n+\n+    const res2 = await request(app)\n+      .post(`/fhir/R4/Bot/${bot.id as string}/$deploy`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        code: `\n+        export async function handler() {\n+          console.log('input', input);\n+          return input;\n+        }\n+        `,\n+      });\n+    expect(res2.status).toBe(400);\n+    expect(res2.body).toMatchObject(badRequest('Bot timeout exceeds allowed maximum of 900 seconds'));\n+  });\n+\n+  test('Exists check throws error', async () => {\n+    mockLambdaClient.on(GetFunctionCommand).callsFakeOnce(() => {\n+      throw new TooManyRequestsException({ message: 'Too many requests', $metadata: {} });\n+    });\n+\n+    const res1 = await request(app)\n+      .post(`/fhir/R4/Bot`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        resourceType: 'Bot',\n+        name: 'Test Bot',\n+        runtimeVersion: 'awslambda',\n+        code: `\n+        export async function handler() {\n+          console.log('input', input);\n+          return input;\n+        }\n+        `,\n+        timeout: 100,\n+      });\n+    expect(res1.status).toBe(201);\n+\n+    const bot = res1.body as Bot;\n+\n+    const res2 = await request(app)\n+      .post(`/fhir/R4/Bot/${bot.id as string}/$deploy`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        code: `\n+        export async function handler() {\n+          console.log('input', input);\n+          return input;\n+        }\n+        `,\n+      });\n+    expect(res2.status).toBe(400);\n+    expect(res2.body).toMatchObject(badRequest('Too many requests'));\n+  });\n+});\n+\n+describe('getLambdaTimeoutForBot', () => {\n+  const app = express();\n+  let mockLambdaClient: AwsClientStub<LambdaClient>;\n+\n+  beforeAll(async () => {\n+    const config = await loadTestConfig();\n+    await initApp(app, config);\n+\n+    mockLambdaClient = mockClient(LambdaClient);\n+  });\n+\n+  afterAll(async () => {\n+    await shutdownApp();\n+  });\n+\n+  afterEach(() => {\n+    mockLambdaClient.restore();\n+  });\n+\n+  test('Throws when any exception except for `ResourceNotFoundException` is thrown', async () => {\n+    mockLambdaClient.on(GetFunctionCommand).callsFake(() => {\n+      throw new TooManyRequestsException({ message: 'Too many requests', $metadata: {} });\n+    });\n+\n+    await expect(getLambdaTimeoutForBot({ id: randomUUID(), resourceType: 'Bot', name: 'Test Bot' })).rejects.toThrow(\n+      new TooManyRequestsException({ message: 'Too many requests', $metadata: {} })\n+    );\n+  });\n });\n\ndiff --git a/packages/server/src/fhir/operations/deploy.test.ts b/packages/server/src/fhir/operations/deploy.test.ts\nindex 321b0474a3..18e26e7db0 100644\n--- a/packages/server/src/fhir/operations/deploy.test.ts\n+++ b/packages/server/src/fhir/operations/deploy.test.ts\n@@ -38,6 +38,12 @@ describe('Deploy', () => {\n     accessToken = await initTestAuth();\n   });\n \n+  beforeEach(() => {\n+    jest\n+      .spyOn(awsDeploy, 'getLambdaTimeoutForBot')\n+      .mockImplementation(async (_bot: Bot) => awsDeploy.DEFAULT_LAMBDA_TIMEOUT);\n+  });\n+\n   afterAll(async () => {\n     await shutdownApp();\n   });\n@@ -99,8 +105,7 @@ describe('Deploy', () => {\n     const res3 = await request(app)\n       .post(`/fhir/R4/Bot/${bot.id}/$deploy`)\n       .set('Content-Type', ContentType.FHIR_JSON)\n-      .set('Authorization', 'Bearer ' + accessToken)\n-      .send();\n+      .set('Authorization', 'Bearer ' + accessToken);\n     expect(res3.status).toBe(200);\n \n     expect(readBinarySpy).toHaveBeenCalledWith(\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5542",
    "pr_id": 5542,
    "issue_id": 5486,
    "repo": "medplum/medplum",
    "problem_statement": "Webhooks for linked projects\n* What is a \"linked project\"?\r\n   * Medplum projects can optional \"link\" in another project\r\n   * This provides a read-only view into the resources in the \"linked project\"\r\n   * For example, we maintain a UMLS project with UMLS terminologies such as ICD, CPT, and SNOMED\r\n   * Customers can \"link in\" the UMLS project to get a read-only view into those resources\r\n* What are bot webhooks?\r\n   * Medplum bots can receive webhooks on the `$execute` endpoint (i.e., `/fhir/R4/Bot/{id}/$execute`)\r\n   * Those bots execute logic as necessary\r\n   * The bot context can be either:\r\n      * The bot running as the bot\r\n      * The bot running as the \"user\" (as defined by the `Authorization` HTTP header)\r\n* Why would you want a bot in a linked project?\r\n   * Consider an enterprise integration such as Health Gorilla, DoseSpot, Candid, etc.\r\n   * Those integrations typically have a combination of FHIR resources + logic as bots\r\n   * One option is to duplicate the resources and bots in every Medplum project that needs them\r\n   * But a cleaner option would be to expose them as a \"linked project\"\r\n   * That lends itself to a cleaner upgrade and maintenance story\r\n* How do webhooks work with linked projects?\r\n   * This model should fit pretty naturally, but there are some important details to work out\r\n   * The bot context should still flow naturally, because the `Authorization` header will refer to a Medplum `ProjectMembership`, which by definition is inside a `Project`\r\n   * Bot secrets must be figured out\r\n      * If `Bot.system === true`, then the Bot should get access to the `Project.systemSecret` of both the \"current project\" and the \"linked project\"\r\n   * We should add tests to ensure that the Bot executing in this fashion correctly follows all project boundaries (this should be true, but we should make it explicit with tests)\r\n\r\nTasks:\r\n\r\n- [ ] Make sure project secrets work correctly with bots in linked projects\r\n- [ ] Add tests to confirm project boundaries for bots in linked projects",
    "issue_word_count": 313,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/server/src/fhir/operations/execute.test.ts",
      "packages/server/src/fhir/operations/execute.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/operations/execute.test.ts"
    ],
    "base_commit": "ed7843dc42bded529ab7a298b96ad5d2f68f2d4d",
    "head_commit": "9e98f4b7bf4d2208cf69029b93e708fdfc778b74",
    "repo_url": "https://github.com/medplum/medplum/pull/5542",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5542",
    "dockerfile": "",
    "pr_merged_at": "2024-11-14T20:53:37.000Z",
    "patch": "diff --git a/packages/server/src/fhir/operations/execute.ts b/packages/server/src/fhir/operations/execute.ts\nindex e3dff8fa46..6d965fc209 100644\n--- a/packages/server/src/fhir/operations/execute.ts\n+++ b/packages/server/src/fhir/operations/execute.ts\n@@ -493,12 +493,12 @@ async function getBotAccessToken(runAs: ProjectMembership): Promise<string> {\n  *   1. Most specific beats more general - the runAs project secrets override the bot project secrets\n  *   2. Defer to local control\" - project admin secrets override system secrets\n  *\n- * In order of precedence:\n+ * From lowest to highest priority:\n  *\n- *   1. Bot project secrets\n- *   2. Bot project system secrets (if bot.system is true)\n- *   3. RunAs project secrets (if running in a different linked project)\n- *   4. RunAs project system secrets (if bot.system is true and running in a different linked project)\n+ *   1. Bot project system secrets (if bot.system is true)\n+ *   2. Bot project secrets\n+ *   3. RunAs project system secrets (if bot.system is true and running in a different linked project)\n+ *   4. RunAs project secrets (if running in a different linked project)\n  *\n  * @param bot - The bot to get secrets for.\n  * @param runAs - The project membership to get secrets for.\n",
    "test_patch": "diff --git a/packages/server/src/fhir/operations/execute.test.ts b/packages/server/src/fhir/operations/execute.test.ts\nindex 5946316c38..c4bedeead7 100644\n--- a/packages/server/src/fhir/operations/execute.test.ts\n+++ b/packages/server/src/fhir/operations/execute.test.ts\n@@ -17,30 +17,26 @@ import { getConfig, loadTestConfig } from '../../config';\n import { createTestProject, waitForAsyncJob, withTestContext } from '../../test.setup';\n import { getSystemRepo } from '../repo';\n import { getBinaryStorage } from '../storage';\n+import * as oathKeysModule from '../../oauth/keys';\n+import { getLoginForAccessToken } from '../../oauth/utils';\n \n-describe('Execute', () => {\n-  let app: express.Express;\n-  let project: Project;\n-  let accessToken: string;\n-  const bots = [] as Bot[];\n-\n-  const botCodes = [\n-    [\n-      `\n+const botCodes = [\n+  [\n+    `\n export async function handler(medplum, event) {\n   console.log(JSON.stringify(event));\n   return event.input;\n }\n   `,\n-      `\n+    `\n exports.handler = async function (medplum, event) {\n   console.log(JSON.stringify(event));\n   return event.input;\n };\n `,\n-    ],\n-    [\n-      `\n+  ],\n+  [\n+    `\n export async function handler(medplum, event) {\n   console.log('input', event.input);\n   if (event.input === 'input: true') {\n@@ -52,7 +48,7 @@ export async function handler(medplum, event) {\n   }\n }\n   `,\n-      `\n+    `\n exports.handler = async function (medplum, event) {\n   console.log('input', event.input);\n   if (event.input === 'input: true') {\n@@ -64,9 +60,9 @@ exports.handler = async function (medplum, event) {\n   }\n };\n `,\n-    ],\n-    [\n-      `\n+  ],\n+  [\n+    `\n export async function handler(medplum, event) {\n   return {\n     resourceType: 'Binary',\n@@ -75,7 +71,7 @@ export async function handler(medplum, event) {\n   };\n }\n   `,\n-      `\n+    `\n exports.handler = async function (medplum, event) {\n   return {\n     resourceType: 'Binary',\n@@ -84,8 +80,22 @@ exports.handler = async function (medplum, event) {\n   };\n };\n `,\n-    ],\n-  ] as [string, string][];\n+  ],\n+] as [string, string][];\n+\n+type BotName = 'echoBot' | 'systemEchoBot' | 'booleanBot' | 'binaryBot';\n+const botDefinitions: { name: BotName; system: boolean; code: [string, string] }[] = [\n+  { name: 'systemEchoBot', system: true, code: botCodes[0] },\n+  { name: 'echoBot', system: false, code: botCodes[0] },\n+  { name: 'booleanBot', system: false, code: botCodes[1] },\n+  { name: 'binaryBot', system: false, code: botCodes[2] },\n+];\n+\n+describe('Execute', () => {\n+  let app: express.Express;\n+  let project1: Project;\n+  let accessToken1: string;\n+  const bots: Record<BotName, Bot> = {} as Record<BotName, Bot>;\n \n   beforeAll(async () => {\n     app = express();\n@@ -95,28 +105,32 @@ exports.handler = async function (medplum, event) {\n \n     const testSetup = await createTestProject({\n       project: {\n-        secret: [{ name: 'secret1', valueString: 'value1' }],\n-        systemSecret: [{ name: 'secret2', valueString: 'value2' }],\n+        systemSecret: [\n+          { name: 'secret1', valueString: 'proj1systemValue1' },\n+          { name: 'secret2', valueString: 'proj1systemValue2' },\n+        ],\n+        secret: [\n+          { name: 'secret2', valueString: 'proj1value2' },\n+          { name: 'secret3', valueString: 'proj1value3' },\n+        ],\n       },\n       withAccessToken: true,\n     });\n-    project = testSetup.project;\n-    accessToken = testSetup.accessToken;\n-\n-    for (let i = 0; i < botCodes.length; i++) {\n-      const [esmCode, cjsCode] = botCodes[i];\n+    project1 = testSetup.project;\n+    accessToken1 = testSetup.accessToken;\n \n+    async function setupBot(name: string, system: boolean, esmCode: string, cjsCode: string): Promise<Bot> {\n       const res1 = await request(app)\n         .post('/fhir/R4/Bot')\n         .set('Content-Type', ContentType.FHIR_JSON)\n-        .set('Authorization', 'Bearer ' + accessToken)\n+        .set('Authorization', 'Bearer ' + accessToken1)\n         .send({\n           resourceType: 'Bot',\n           identifier: [{ system: 'https://example.com/bot', value: randomUUID() }],\n-          name: `Test Bot #${i + 1}`,\n+          name: `${name} Test Bot`,\n           runtimeVersion: 'vmcontext',\n           code: esmCode,\n-          system: i === 0,\n+          system,\n         });\n \n       expect(res1.status).toBe(201);\n@@ -125,13 +139,18 @@ exports.handler = async function (medplum, event) {\n       const res2 = await request(app)\n         .post(`/fhir/R4/Bot/${bot.id}/$deploy`)\n         .set('Content-Type', ContentType.FHIR_JSON)\n-        .set('Authorization', 'Bearer ' + accessToken)\n+        .set('Authorization', 'Bearer ' + accessToken1)\n         .send({\n           code: cjsCode,\n         });\n \n       expect(res2.status).toBe(200);\n-      bots[i] = bot;\n+\n+      return bot;\n+    }\n+\n+    for (const { name, system, code } of botDefinitions) {\n+      bots[name] = await setupBot(name, system, code[0], code[1]);\n     }\n   });\n \n@@ -141,9 +160,9 @@ exports.handler = async function (medplum, event) {\n \n   test('Submit plain text', async () => {\n     const res = await request(app)\n-      .post(`/fhir/R4/Bot/${bots[0].id}/$execute`)\n+      .post(`/fhir/R4/Bot/${bots.systemEchoBot.id}/$execute`)\n       .set('Content-Type', ContentType.TEXT)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send('input');\n     expect(res.status).toBe(200);\n     expect(res.headers['content-type']).toBe('text/plain; charset=utf-8');\n@@ -152,9 +171,9 @@ exports.handler = async function (medplum, event) {\n \n   test('Submit FHIR with content type returns non-FHIR JSON', async () => {\n     const res = await request(app)\n-      .post(`/fhir/R4/Bot/${bots[0].id}/$execute`)\n+      .post(`/fhir/R4/Bot/${bots.systemEchoBot.id}/$execute`)\n       .set('Content-Type', ContentType.FHIR_JSON)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send({\n         resourceType: 'Patient',\n         name: [{ given: ['John'], family: ['Doe'] }],\n@@ -167,8 +186,8 @@ exports.handler = async function (medplum, event) {\n \n   test('Submit FHIR without content type return JSON content', async () => {\n     const res = await request(app)\n-      .post(`/fhir/R4/Bot/${bots[0].id}/$execute`)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .post(`/fhir/R4/Bot/${bots.systemEchoBot.id}/$execute`)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send({\n         resourceType: 'Patient',\n         name: [{ given: ['John'], family: ['Doe'] }],\n@@ -182,8 +201,8 @@ exports.handler = async function (medplum, event) {\n   test('Return non-Resource JSON response', async () => {\n     const input = { type: 'not-a-resource', result: [] };\n     const res = await request(app)\n-      .post(`/fhir/R4/Bot/${bots[0].id}/$execute`)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .post(`/fhir/R4/Bot/${bots.systemEchoBot.id}/$execute`)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send(JSON.parse(JSON.stringify(input)));\n     expect(res.status).toBe(200);\n     expect(res.headers['content-type']).toBe('application/json; charset=utf-8');\n@@ -199,9 +218,9 @@ exports.handler = async function (medplum, event) {\n       'MSA|AA|9B38584D|Everything was okay dokay!|';\n \n     const res = await request(app)\n-      .post(`/fhir/R4/Bot/${bots[0].id}/$execute`)\n+      .post(`/fhir/R4/Bot/${bots.systemEchoBot.id}/$execute`)\n       .set('Content-Type', ContentType.HL7_V2)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send(text);\n     expect(res.status).toBe(200);\n     expect(res.headers['content-type']).toBe('x-application/hl7-v2+er7; charset=utf-8');\n@@ -213,7 +232,7 @@ exports.handler = async function (medplum, event) {\n     expect(args[1]).toBe(ContentType.JSON);\n \n     const row = JSON.parse(args[2] as string);\n-    expect(row.botId).toEqual(bots[0].id);\n+    expect(row.botId).toEqual(bots.systemEchoBot.id);\n     expect(row.hl7MessageType).toEqual('ACK');\n     expect(row.hl7Version).toEqual('2.6.1');\n   });\n@@ -223,7 +242,7 @@ exports.handler = async function (medplum, event) {\n     const res1 = await request(app)\n       .post('/fhir/R4/Bot')\n       .set('Content-Type', ContentType.FHIR_JSON)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send({\n         resourceType: 'Bot',\n         name: 'Test Bot',\n@@ -236,7 +255,7 @@ exports.handler = async function (medplum, event) {\n     const res2 = await request(app)\n       .post(`/fhir/R4/Bot/${bot.id}/$execute`)\n       .set('Content-Type', ContentType.FHIR_JSON)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send({});\n     expect(res2.status).toBe(400);\n   });\n@@ -245,7 +264,7 @@ exports.handler = async function (medplum, event) {\n     const res1 = await request(app)\n       .post('/fhir/R4/Bot')\n       .set('Content-Type', ContentType.FHIR_JSON)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send({\n         resourceType: 'Bot',\n         name: 'Test Bot',\n@@ -258,7 +277,7 @@ exports.handler = async function (medplum, event) {\n     const res2 = await request(app)\n       .post(`/fhir/R4/Bot/${bot.id}/$deploy`)\n       .set('Content-Type', ContentType.FHIR_JSON)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send({\n         code: `\n         export async function handler() {\n@@ -273,7 +292,7 @@ exports.handler = async function (medplum, event) {\n     const res3 = await request(app)\n       .post(`/fhir/R4/Bot/${bot.id}/$execute`)\n       .set('Content-Type', ContentType.FHIR_JSON)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send({});\n     expect(res3.status).toBe(400);\n   });\n@@ -320,7 +339,7 @@ exports.handler = async function (medplum, event) {\n     const res1 = await request(app)\n       .post(`/fhir/R4/Bot`)\n       .set('Content-Type', ContentType.FHIR_JSON)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send({\n         resourceType: 'Bot',\n         name: 'Test Bot',\n@@ -334,7 +353,7 @@ exports.handler = async function (medplum, event) {\n     const res2 = await request(app)\n       .post(`/fhir/R4/Bot/${bot.id}/$execute`)\n       .set('Content-Type', ContentType.FHIR_JSON)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send({});\n     expect(res2.status).toBe(400);\n     expect(res2.body.issue[0].details.text).toEqual('No executable code');\n@@ -343,7 +362,7 @@ exports.handler = async function (medplum, event) {\n     const res3 = await request(app)\n       .put(`/fhir/R4/Bot/${bot.id}`)\n       .set('Content-Type', ContentType.FHIR_JSON)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send({\n         ...bot,\n         executableCode: {\n@@ -358,7 +377,7 @@ exports.handler = async function (medplum, event) {\n     const res4 = await request(app)\n       .post(`/fhir/R4/Bot/${bot.id}/$execute`)\n       .set('Content-Type', ContentType.FHIR_JSON)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send({});\n     expect(res4.status).toBe(400);\n     expect(res4.body.issue[0].details.text).toEqual('Executable code is not a Binary');\n@@ -367,7 +386,7 @@ exports.handler = async function (medplum, event) {\n     const res5 = await request(app)\n       .post(`/fhir/R4/Bot/${bot.id}/$deploy`)\n       .set('Content-Type', ContentType.FHIR_JSON)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send({\n         code: `\n           const { getReferenceString } = require(\"@medplum/core\");\n@@ -385,7 +404,7 @@ exports.handler = async function (medplum, event) {\n     const res6 = await request(app)\n       .post(`/fhir/R4/Bot/${bot.id}/$execute`)\n       .set('Content-Type', ContentType.FHIR_JSON)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send({});\n     expect(res6.status).toBe(200);\n     expect(res6.body).toMatchObject({\n@@ -401,7 +420,7 @@ exports.handler = async function (medplum, event) {\n     const res7 = await request(app)\n       .post(`/fhir/R4/Bot/${bot.id}/$execute`)\n       .set('Content-Type', ContentType.FHIR_JSON)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send({});\n     expect(res7.status).toBe(400);\n     expect(res7.body.issue[0].details.text).toEqual('VM Context bots not enabled on this server');\n@@ -414,7 +433,7 @@ exports.handler = async function (medplum, event) {\n     const res1 = await request(app)\n       .post(`/fhir/R4/Bot`)\n       .set('Content-Type', ContentType.FHIR_JSON)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send({\n         resourceType: 'Bot',\n         name: 'Test Bot',\n@@ -427,7 +446,7 @@ exports.handler = async function (medplum, event) {\n     const res5 = await request(app)\n       .post(`/fhir/R4/Bot/${bot.id}/$deploy`)\n       .set('Content-Type', ContentType.FHIR_JSON)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send({\n         code: `\n           exports.handler = async function () {\n@@ -441,7 +460,7 @@ exports.handler = async function (medplum, event) {\n     const res6 = await request(app)\n       .post(`/fhir/R4/Bot/${bot.id}/$execute`)\n       .set('Content-Type', ContentType.FHIR_JSON)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send({});\n     expect(res6.status).toBe(200);\n     expect(res6.body).toEqual(42);\n@@ -450,7 +469,7 @@ exports.handler = async function (medplum, event) {\n   test('OperationOutcome response', async () => {\n     const res = await request(app)\n       .post(`/fhir/R4/Bot/$execute?identifier=invalid-identifier`)\n-      .set('Authorization', 'Bearer ' + accessToken)\n+      .set('Authorization', 'Bearer ' + accessToken1)\n       .send('');\n     expect(res.status).toBe(400);\n     expect(res.headers['content-type']).toBe('application/fhir+json; charset=utf-8');\n@@ -459,107 +478,195 @@ exports.handler = async function (medplum, event) {\n \n   test('Binary response', async () => {\n     const res = await request(app)\n-      .get(`/fhir/R4/Bot/${bots[2].id}/$execute`)\n-      .set('Authorization', 'Bearer ' + accessToken);\n+      .get(`/fhir/R4/Bot/${bots.binaryBot.id}/$execute`)\n+      .set('Authorization', 'Bearer ' + accessToken1);\n     expect(res.status).toBe(200);\n     expect(res.headers['content-type']).toBe('text/plain; charset=utf-8');\n     expect(res.text).toEqual('Hello, world!');\n   });\n \n-  test('Bot secrets from linked project', async () => {\n-    // Use the first test bot for everything\n-    const bot = bots[0];\n+  describe('linked project', () => {\n+    let project2: Project;\n+    let accessToken2: string;\n+\n+    beforeAll(async () => {\n+      // Create a new project that links to the first project\n+      const testSetup2 = await createTestProject({\n+        withAccessToken: true,\n+        project: {\n+          name: 'Project 2',\n+          systemSecret: [\n+            { name: 'secret2', valueString: 'proj2systemValue2' },\n+            { name: 'secret3', valueString: 'proj2systemValue3' },\n+          ],\n+          secret: [\n+            { name: 'secret3', valueString: 'proj2value3' },\n+            { name: 'secret4', valueString: 'proj2value4' },\n+          ],\n+          link: [{ project: createReference(project1) }],\n+        },\n+        membership: {\n+          admin: true,\n+        },\n+      });\n+      project2 = testSetup2.project;\n+      accessToken2 = testSetup2.accessToken;\n+\n+      const systemRepo = getSystemRepo();\n+      for (const bot of [bots.echoBot, bots.systemEchoBot]) {\n+        await systemRepo.createResource<ProjectMembership>({\n+          resourceType: 'ProjectMembership',\n+          project: createReference(project2),\n+          user: createReference(bot),\n+          profile: createReference(bot),\n+        });\n \n-    // Create a new project that links to the first project\n-    const testSetup2 = await createTestProject({\n-      withAccessToken: true,\n-      project: {\n-        name: 'Project 2',\n-        secret: [{ name: 'secret3', valueString: 'value3' }],\n-        systemSecret: [{ name: 'secret4', valueString: 'value4' }],\n-        link: [{ project: createReference(project) }],\n-      },\n-      membership: {\n-        admin: true,\n-      },\n-    });\n-    const project2 = testSetup2.project;\n-    const accessToken2 = testSetup2.accessToken;\n-\n-    // Create a project membership for the existing bot in the new project\n-    const systemRepo = getSystemRepo();\n-    await systemRepo.createResource<ProjectMembership>({\n-      resourceType: 'ProjectMembership',\n-      project: createReference(project2),\n-      user: createReference(bot),\n-      profile: createReference(bot),\n+        // Confirm that we can read our own project\n+        const res1 = await request(app)\n+          .get(`/fhir/R4/Project/${project2.id}`)\n+          .set('Authorization', 'Bearer ' + accessToken2);\n+        expect(res1.status).toBe(200);\n+        expect(res1.body.resourceType).toBe('Project');\n+        expect(res1.body.id).toBe(project2.id);\n+\n+        // Confirm that we can read the linked project\n+        const res2 = await request(app)\n+          .get(`/fhir/R4/Project/${project1.id}`)\n+          .set('Authorization', 'Bearer ' + accessToken2);\n+        expect(res2.status).toBe(200);\n+        expect(res2.body.resourceType).toBe('Project');\n+        expect(res2.body.id).toBe(project1.id);\n+\n+        // Confirm that we can read the bot in the new project\n+        const res3 = await request(app)\n+          .get(`/fhir/R4/Bot/${bot.id}`)\n+          .set('Authorization', 'Bearer ' + accessToken2);\n+        expect(res3.status).toBe(200);\n+        expect(res3.body.resourceType).toBe('Bot');\n+        expect(res3.body.id).toBe(bot.id);\n+      }\n     });\n \n-    // Confirm that we can read our own project\n-    const res1 = await request(app)\n-      .get(`/fhir/R4/Project/${project2.id}`)\n-      .set('Authorization', 'Bearer ' + accessToken2);\n-    expect(res1.status).toBe(200);\n-    expect(res1.body.resourceType).toBe('Project');\n-    expect(res1.body.id).toBe(project2.id);\n+    function populateNamesInSecrets(expected: any): void {\n+      for (const key of Object.keys(expected)) {\n+        expected[key].name = key;\n+      }\n+    }\n \n-    // Confirm that we can read the linked project\n-    const res2 = await request(app)\n-      .get(`/fhir/R4/Project/${project.id}`)\n-      .set('Authorization', 'Bearer ' + accessToken2);\n-    expect(res2.status).toBe(200);\n-    expect(res2.body.resourceType).toBe('Project');\n-    expect(res2.body.id).toBe(project.id);\n+    test.each<[BotName, 'linking' | 'own', any]>([\n+      [\n+        'echoBot',\n+        'own',\n+        {\n+          secret2: { valueString: 'proj1value2' },\n+          secret3: { valueString: 'proj1value3' },\n+        },\n+      ],\n+      [\n+        'echoBot',\n+        'linking',\n+        {\n+          secret2: { valueString: 'proj1value2' },\n+          secret3: { valueString: 'proj2value3' },\n+          secret4: { valueString: 'proj2value4' },\n+        },\n+      ],\n+      [\n+        'systemEchoBot',\n+        'own',\n+        {\n+          secret1: { valueString: 'proj1systemValue1' },\n+          secret2: { valueString: 'proj1value2' },\n+          secret3: { valueString: 'proj1value3' },\n+        },\n+      ],\n+      [\n+        'systemEchoBot',\n+        'linking',\n+        {\n+          secret1: { valueString: 'proj1systemValue1' },\n+          secret2: { valueString: 'proj2systemValue2' },\n+          secret3: { valueString: 'proj2value3' },\n+          secret4: { valueString: 'proj2value4' },\n+        },\n+      ],\n+    ])('%s bot in %s project secrets', async (botName, whichProject, expectedSecrets) => {\n+      const bot = bots[botName];\n+      const systemRepo = getSystemRepo();\n \n-    // Confirm that we can read the bot in the new project\n-    const res3 = await request(app)\n-      .get(`/fhir/R4/Bot/${bot.id}`)\n-      .set('Authorization', 'Bearer ' + accessToken2);\n-    expect(res3.status).toBe(200);\n-    expect(res3.body.resourceType).toBe('Bot');\n-    expect(res3.body.id).toBe(bot.id);\n+      // execute the bot in the appropriate project context\n+      const project = whichProject === 'own' ? project1 : project2;\n+      const accessToken = whichProject === 'own' ? accessToken1 : accessToken2;\n \n-    // Now execute the bot in the new project\n-    const res = await request(app)\n-      .post(`/fhir/R4/Bot/${bot.id}/$execute`)\n-      .set('Content-Type', ContentType.TEXT)\n-      .set('Authorization', 'Bearer ' + accessToken2)\n-      .send('input');\n-    expect(res.status).toBe(200);\n-    expect(res.headers['content-type']).toBe('text/plain; charset=utf-8');\n-    expect(res.text).toEqual('input');\n+      const res = await request(app)\n+        .post(`/fhir/R4/Bot/${bot.id}/$execute`)\n+        .set('Content-Type', ContentType.TEXT)\n+        .set('Authorization', 'Bearer ' + accessToken)\n+        .send('input');\n+      expect(res.status).toBe(200);\n+      expect(res.headers['content-type']).toBe('text/plain; charset=utf-8');\n+      expect(res.text).toEqual('input');\n+\n+      // Get the audit event\n+      const auditEvent = await systemRepo.searchOne<AuditEvent>({\n+        resourceType: 'AuditEvent',\n+        filters: [\n+          { code: '_project', operator: Operator.EQUALS, value: project.id as string },\n+          { code: 'entity', operator: Operator.EQUALS, value: getReferenceString(bot) },\n+        ],\n+      });\n+      expect(auditEvent).toBeDefined();\n+      expect(auditEvent?.meta?.project).toBe(project.id);\n \n-    // Get the audit event\n-    const auditEvent = await systemRepo.searchOne<AuditEvent>({\n-      resourceType: 'AuditEvent',\n-      filters: [\n-        { code: '_project', operator: Operator.EQUALS, value: project2.id as string },\n-        { code: 'entity', operator: Operator.EQUALS, value: getReferenceString(bot) },\n-      ],\n+      // verify secrets\n+      const output = JSON.parse(auditEvent?.outcomeDesc as string);\n+      populateNamesInSecrets(expectedSecrets);\n+      expect(output.secrets).toEqual(expectedSecrets);\n     });\n-    expect(auditEvent).toBeDefined();\n-    expect(auditEvent?.meta?.project).toBe(project2.id);\n-\n-    const output = JSON.parse(auditEvent?.outcomeDesc as string);\n-    expect(output.secrets).toMatchObject({\n-      secret1: { valueString: 'value1' },\n-      secret2: { valueString: 'value2' },\n-      secret3: { valueString: 'value3' },\n-      secret4: { valueString: 'value4' },\n+\n+    test.each<[BotName, 'linking' | 'own']>([\n+      ['echoBot', 'linking'],\n+      ['echoBot', 'own'],\n+      ['systemEchoBot', 'linking'],\n+      ['systemEchoBot', 'own'],\n+    ])('Bot %s in %s project executes with correct accessToken', async (botName, whichProject) => {\n+      const generateAccessTokenSpy = jest.spyOn(oathKeysModule, 'generateAccessToken');\n+      generateAccessTokenSpy.mockClear();\n+\n+      // execute the bot in the appropriate project context\n+      const bot = bots[botName];\n+      const accessToken = whichProject === 'own' ? accessToken1 : accessToken2;\n+\n+      const res = await request(app)\n+        .post(`/fhir/R4/Bot/${bot.id}/$execute`)\n+        .set('Content-Type', ContentType.TEXT)\n+        .set('Authorization', 'Bearer ' + accessToken)\n+        .send('input');\n+      expect(res.status).toBe(200);\n+      expect(res.headers['content-type']).toBe('text/plain; charset=utf-8');\n+      expect(res.text).toEqual('input');\n+\n+      expect(generateAccessTokenSpy).toHaveBeenCalledTimes(1);\n+      const generatedAccessToken = (await generateAccessTokenSpy.mock.results[0].value) as string;\n+      const authState = await getLoginForAccessToken(generatedAccessToken);\n+\n+      const expectedProject = whichProject === 'own' ? project1 : project2;\n+      expect(authState?.project?.id).toBeDefined();\n+      expect(authState?.project?.id).toBe(expectedProject.id);\n     });\n   });\n \n   describe('Prefer: respond-async', () => {\n     test('Plain text -- Prefer: respond-async', async () => {\n       const res = await request(app)\n-        .post(`/fhir/R4/Bot/${bots[0].id}/$execute`)\n+        .post(`/fhir/R4/Bot/${bots.systemEchoBot.id}/$execute`)\n         .set('Content-Type', ContentType.TEXT)\n-        .set('Authorization', 'Bearer ' + accessToken)\n+        .set('Authorization', 'Bearer ' + accessToken1)\n         .set('Prefer', 'respond-async')\n         .send('input');\n       expect(res.status).toBe(202);\n \n-      const job = await waitForAsyncJob(res.headers['content-location'], app, accessToken);\n+      const job = await waitForAsyncJob(res.headers['content-location'], app, accessToken1);\n       expect(job).toMatchObject<Partial<AsyncJob>>({\n         resourceType: 'AsyncJob',\n         status: 'completed',\n@@ -578,14 +685,14 @@ exports.handler = async function (medplum, event) {\n \n     test('JSON -- Prefer: respond-async', async () => {\n       const res = await request(app)\n-        .post(`/fhir/R4/Bot/${bots[0].id}/$execute`)\n+        .post(`/fhir/R4/Bot/${bots.systemEchoBot.id}/$execute`)\n         .set('Content-Type', ContentType.JSON)\n-        .set('Authorization', 'Bearer ' + accessToken)\n+        .set('Authorization', 'Bearer ' + accessToken1)\n         .set('Prefer', 'respond-async')\n         .send({ hello: 'medplum' });\n       expect(res.status).toBe(202);\n \n-      const job = await waitForAsyncJob(res.headers['content-location'], app, accessToken);\n+      const job = await waitForAsyncJob(res.headers['content-location'], app, accessToken1);\n       expect(job).toMatchObject<Partial<AsyncJob>>({\n         resourceType: 'AsyncJob',\n         status: 'completed',\n@@ -604,14 +711,14 @@ exports.handler = async function (medplum, event) {\n \n     test('Boolean -- Prefer: respond-async', async () => {\n       const res = await request(app)\n-        .post(`/fhir/R4/Bot/${bots[1].id}/$execute`)\n+        .post(`/fhir/R4/Bot/${bots.booleanBot.id}/$execute`)\n         .set('Content-Type', ContentType.TEXT)\n-        .set('Authorization', 'Bearer ' + accessToken)\n+        .set('Authorization', 'Bearer ' + accessToken1)\n         .set('Prefer', 'respond-async')\n         .send('input: true');\n       expect(res.status).toBe(202);\n \n-      const job = await waitForAsyncJob(res.headers['content-location'], app, accessToken);\n+      const job = await waitForAsyncJob(res.headers['content-location'], app, accessToken1);\n       expect(job).toMatchObject<Partial<AsyncJob>>({\n         resourceType: 'AsyncJob',\n         status: 'completed',\n@@ -632,12 +739,12 @@ exports.handler = async function (medplum, event) {\n       const res = await request(app)\n         .post('/fhir/R4/Bot/$execute')\n         .set('Content-Type', ContentType.TEXT)\n-        .set('Authorization', 'Bearer ' + accessToken)\n+        .set('Authorization', 'Bearer ' + accessToken1)\n         .set('Prefer', 'respond-async')\n         .send('input');\n       expect(res.status).toBe(202);\n \n-      const job = await waitForAsyncJob(res.headers['content-location'], app, accessToken);\n+      const job = await waitForAsyncJob(res.headers['content-location'], app, accessToken1);\n       expect(job).toMatchObject<Partial<AsyncJob>>({\n         resourceType: 'AsyncJob',\n         status: 'error',\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5536",
    "pr_id": 5536,
    "issue_id": 5498,
    "repo": "medplum/medplum",
    "problem_statement": "Large JSON import partially fails.\nGood morning,\r\n\r\n## Intro\r\n\r\nI recently synchronized my fork of the project with ~107 commits. I think my initial fork was pre-October.\r\nSince the database version was updated, I redid my test database.\r\nIn the process, I attempted to re-import a 57mb JSON bundle via the Medplum App.\r\n\r\nThis bundle is a Synthea generated bundle for R4 which had succeeded in the past. I just needed to set the following setting in the server's config.\r\n\r\n- \"maxJsonSize\": \"100mb\"\r\n\r\nI updated my copy of the repo due to a need to investigate another issue trying to request a chained search with _has.\r\nOnce I get my test data back, I will try to see if I need to open another ticket for the search issue.\r\n\r\n## Error\r\n\r\nOn the latest version of the main branch, I now get this in the server terminal output.\r\n\r\n> {\"level\":\"WARN\",\"timestamp\":\"2024-11-05T13:37:17.324Z\",\"msg\":\"Unknown profile referenced\",\"resource\":\"Encounter/29452cb1-7c5e-431f-805f-8c07d174e36c\",\"url\":\"http://hl7.org/fhir/us/core/StructureDefinition/us-core-encounter\",\"requestId\":\"82f28d8c-48db-40ef-8b8d-e76aaef7e310\",\"traceId\":\"7d201994-43c3-4ad7-92f4-f6b58f387f74\"}\r\n{\"level\":\"WARN\",\"timestamp\":\"2024-11-05T13:37:17.353Z\",\"msg\":\"Unknown profile referenced\",\"resource\":\"DiagnosticReport/2b1242a8-a904-40cf-bafe-008374a978fe\",\"url\":\"http://hl7.org/fhir/us/core/StructureDefinition/us-core-diagnosticreport-lab\",\"requestId\":\"82f28d8c-48db-40ef-8b8d-e76aaef7e310\",\"traceId\":\"7d201994-43c3-4ad7-92f4-f6b58f387f74\"}\r\n{\"level\":\"WARN\",\"timestamp\":\"2024-11-05T13:37:17.369Z\",\"msg\":\"Unknown profile referenced\",\"resource\":\"DiagnosticReport/41448fa1-eedd-4cd6-9c37-ca6de4dd9731\",\"url\":\"http://hl7.org/fhir/us/core/StructureDefinition/us-core-diagnosticreport-note\",\"requestId\":\"82f28d8c-48db-40ef-8b8d-e76aaef7e310\",\"traceId\":\"7d201994-43c3-4ad7-92f4-f6b58f387f74\"}\r\n{\"level\":\"WARN\",\"timestamp\":\"2024-11-05T13:37:17.388Z\",\"msg\":\"Unknown profile referenced\",\"resource\":\"DocumentReference/048180b1-165a-4ce9-aa0c-900ea1e2662d\",\"url\":\"http://hl7.org/fhir/us/core/StructureDefinition/us-core-documentreference\",\"requestId\":\"82f28d8c-48db-40ef-8b8d-e76aaef7e310\",\"traceId\":\"7d201994-43c3-4ad7-92f4-f6b58f387f74\"}\r\n{\"level\":\"WARN\",\"timestamp\":\"2024-11-05T13:37:17.412Z\",\"msg\":\"Validator warning: Invalid reference: got \\\"#referral\\\", expected \\\"http://hl7.org/fhir/StructureDefinition/ServiceRequest\\\"\",\"project\":\"ed3ec4ff-0af6-45f7-a6cc-8138f190ad8b\",\"issue\":{\"severity\":\"warning\",\"code\":\"structure\",\"details\":{\"text\":\"Invalid reference: got \\\"#referral\\\", expected \\\"http://hl7.org/fhir/StructureDefinition/ServiceRequest\\\"\"},\"expression\":[\"ExplanationOfBenefit.referral\"]},\"requestId\":\"82f28d8c-48db-40ef-8b8d-e76aaef7e310\",\"traceId\":\"7d201994-43c3-4ad7-92f4-f6b58f387f74\"}\r\n{\"level\":\"WARN\",\"timestamp\":\"2024-11-05T13:37:17.412Z\",\"msg\":\"Validator warning: Invalid reference: got \\\"#coverage\\\", expected \\\"http://hl7.org/fhir/StructureDefinition/Coverage\\\"\",\"project\":\"ed3ec4ff-0af6-45f7-a6cc-8138f190ad8b\",\"issue\":{\"severity\":\"warning\",\"code\":\"structure\",\"details\":{\"text\":\"Invalid reference: got \\\"#coverage\\\", expected \\\"http://hl7.org/fhir/StructureDefinition/Coverage\\\"\"},\"expression\":[\"ExplanationOfBenefit.insurance[0].coverage\"]},\"requestId\":\"82f28d8c-48db-40ef-8b8d-e76aaef7e310\",\"traceId\":\"7d201994-43c3-4ad7-92f4-f6b58f387f74\"}\r\n{\"level\":\"WARN\",\"timestamp\":\"2024-11-05T13:37:17.978Z\",\"msg\":\"Unknown profile referenced\",\"resource\":\"Provenance/300c5f9a-ec02-469e-9311-bc95da1d0160\",\"url\":\"http://hl7.org/fhir/us/core/StructureDefinition/us-core-provenance\",\"requestId\":\"82f28d8c-48db-40ef-8b8d-e76aaef7e310\",\"traceId\":\"7d201994-43c3-4ad7-92f4-f6b58f387f74\"}\r\n{\"level\":\"ERROR\",\"timestamp\":\"2024-11-05T13:37:18.610Z\",\"msg\":\"Database error\",\"error\":\"bind message has 797 parameter formats but 0 parameters\",\"stack\":\"error: bind message has 797 parameter formats but 0 parameters\\n    at /home/lsantos/WebstormProjects/medplum/node_modules/pg/lib/client.js:535:17\\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\\n    at SqlBuilder.execute (/home/lsantos/WebstormProjects/medplum/packages/server/src/fhir/sql.ts:419:22)\\n    at ReferenceTable.insertValuesForResource (/home/lsantos/WebstormProjects/medplum/packages/server/src/fhir/lookups/reference.ts:57:5)\\n    at ReferenceTable.indexResource (/home/lsantos/WebstormProjects/medplum/packages/server/src/fhir/lookups/reference.ts:35:5)\\n    at async Promise.all (index 4)\\n    at Repository.writeLookupTables (/home/lsantos/WebstormProjects/medplum/packages/server/src/fhir/repo.ts:1642:5)\\n    at /home/lsantos/WebstormProjects/medplum/packages/server/src/fhir/repo.ts:841:7\\n    at Repository.withTransaction (/home/lsantos/WebstormProjects/medplum/packages/server/src/fhir/repo.ts:2151:22)\\n    at Repository.writeToDatabase (/home/lsantos/WebstormProjects/medplum/packages/server/src/fhir/repo.ts:838:5)\",\"code\":\"08P01\",\"requestId\":\"82f28d8c-48db-40ef-8b8d-e76aaef7e310\",\"traceId\":\"7d201994-43c3-4ad7-92f4-f6b58f387f74\"}\r\n{\"level\":\"WARN\",\"timestamp\":\"2024-11-05T13:37:18.613Z\",\"msg\":\"Error processing transaction Bundle\",\"errors\":69,\"project\":\"ed3ec4ff-0af6-45f7-a6cc-8138f190ad8b\",\"requestId\":\"82f28d8c-48db-40ef-8b8d-e76aaef7e310\",\"traceId\":\"7d201994-43c3-4ad7-92f4-f6b58f387f74\"}\r\n\r\nThe input test Bundle is \r\n[Rozella39_Mertz280_ef167059-cef0-12c4-49db-993ca3a20c01.zip](https://github.com/user-attachments/files/17633524/Rozella39_Mertz280_ef167059-cef0-12c4-49db-993ca3a20c01.zip)\r\n\r\n## Miscellaneous\r\n\r\nThe new server config has the option. \r\n\r\n- \"maxBatchSize\": \"50mb\"\r\n\r\nMentioning it in case recent changes expose an unexpected issue.\r\nI tried changing the batch size to 100mb without luck.\r\n\r\nI am running the server in \"dev\" mode using the new Postgres 16 database container.\r\n\r\n## Conclusion\r\nA large JSON Bundle seems to have an error on import. I will try other test datasets for my own testing. I have not narrowed down the issue to the exact code area, but I will try to inform you of any further findings I make.\r\n\r\nLet me know if I need to provide more information.\r\nThank you for Medplum!",
    "issue_word_count": 843,
    "test_files_count": 1,
    "non_test_files_count": 2,
    "pr_changed_files": [
      "packages/server/src/fhir/lookups/lookuptable.ts",
      "packages/server/src/fhir/lookups/reference.ts",
      "packages/server/src/fhir/repo.test.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/repo.test.ts"
    ],
    "base_commit": "0da18476ce48215ef8bf7161bf16b6793a83a448",
    "head_commit": "cd591d6408c71a29d17b217f1af31c3b97b37a17",
    "repo_url": "https://github.com/medplum/medplum/pull/5536",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5536",
    "dockerfile": "",
    "pr_merged_at": "2024-11-14T16:41:18.000Z",
    "patch": "diff --git a/packages/server/src/fhir/lookups/lookuptable.ts b/packages/server/src/fhir/lookups/lookuptable.ts\nindex 6fefca0ddd..bcdb60c246 100644\n--- a/packages/server/src/fhir/lookups/lookuptable.ts\n+++ b/packages/server/src/fhir/lookups/lookuptable.ts\n@@ -15,6 +15,8 @@ import {\n   escapeLikeString,\n } from '../sql';\n \n+export const lookupTableBatchSize = 5_000;\n+\n /**\n  * The LookupTable interface is used for search parameters that are indexed in separate tables.\n  * This is necessary for array properties with specific structure.\n@@ -149,8 +151,11 @@ export abstract class LookupTable {\n       return;\n     }\n     const tableName = this.getTableName(resourceType);\n-    const insert = new InsertQuery(tableName, values);\n-    await insert.execute(client);\n+    for (let i = 0; i < values.length; i += lookupTableBatchSize) {\n+      const batchedValues = values.slice(i, i + lookupTableBatchSize);\n+      const insert = new InsertQuery(tableName, batchedValues);\n+      await insert.execute(client);\n+    }\n   }\n \n   /**\n\ndiff --git a/packages/server/src/fhir/lookups/reference.ts b/packages/server/src/fhir/lookups/reference.ts\nindex 152ed082c7..ea16698f41 100644\n--- a/packages/server/src/fhir/lookups/reference.ts\n+++ b/packages/server/src/fhir/lookups/reference.ts\n@@ -53,8 +53,11 @@ export class ReferenceTable extends LookupTable {\n \n     // Reference lookup tables have a covering primary key, so a conflict means\n     // that the exact desired row already exists in the database\n-    const insert = new InsertQuery(tableName, values).ignoreOnConflict();\n-    await insert.execute(client);\n+    for (let i = 0; i < values.length; i += 10_000) {\n+      const batchedValues = values.slice(i, i + 10_000);\n+      const insert = new InsertQuery(tableName, batchedValues).ignoreOnConflict();\n+      await insert.execute(client);\n+    }\n   }\n }\n \n",
    "test_patch": "diff --git a/packages/server/src/fhir/repo.test.ts b/packages/server/src/fhir/repo.test.ts\nindex 26035872ae..41e5598b07 100644\n--- a/packages/server/src/fhir/repo.test.ts\n+++ b/packages/server/src/fhir/repo.test.ts\n@@ -1254,4 +1254,21 @@ describe('FHIR Repo', () => {\n       expect(cachedPatient.meta?.project).toEqual(project.id);\n       expect(cachedPatient.gender).toEqual('unknown');\n     }));\n+\n+  test('Handles resources with many entries stored in lookup table', async () =>\n+    withTestContext(async () => {\n+      const { repo } = await createTestProject({ withRepo: true });\n+\n+      const patient: Patient = {\n+        resourceType: 'Patient',\n+        link: [],\n+      };\n+      // Postgres uses a 16-bit counter for placeholder formats internally,\n+      // so 2^16 + 1 = 64k + 1 will definitely overflow it if not sent in smaller batches\n+      for (let i = 0; i < 64 * 1024 + 1; i++) {\n+        patient.link?.push({ type: 'seealso', other: { reference: 'Patient/' + randomUUID() } });\n+      }\n+\n+      await expect(repo.createResource<Patient>(patient)).resolves.toBeDefined();\n+    }));\n });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5525",
    "pr_id": 5525,
    "issue_id": 4878,
    "repo": "medplum/medplum",
    "problem_statement": "Race condition in createResourceIfNoneExist\nUser Driven: \r\n\r\n## Background\r\nOur [current implementation](https://github.com/medplum/medplum/blob/b1f86f8c1a0a0999d9ec91e203662b15b3fb4a33/packages/core/src/client.ts#L1982-L1989) of `createResourceIfNoneExist` performs a search and then writes a resource. \r\n\r\nIn rare cases, this can cause two client side jobs running in parallel to create duplicate resources\r\n\r\n## Proposal\r\nmake the `createResourceIfNoneExist` SDK function wrap a 1-element `transaction` bundle instead.\r\n\r\n",
    "issue_word_count": 64,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/core/src/client.test.ts",
      "packages/core/src/client.ts"
    ],
    "pr_changed_test_files": [
      "packages/core/src/client.test.ts"
    ],
    "base_commit": "024162297a646723757f033ef9abedb70cbb39c0",
    "head_commit": "a74e2e0c9db4d005939bcdd3df863890febf113b",
    "repo_url": "https://github.com/medplum/medplum/pull/5525",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5525",
    "dockerfile": "",
    "pr_merged_at": "2024-11-14T01:44:20.000Z",
    "patch": "diff --git a/packages/core/src/client.ts b/packages/core/src/client.ts\nindex 0a83614096..21d2901c8b 100644\n--- a/packages/core/src/client.ts\n+++ b/packages/core/src/client.ts\n@@ -2034,8 +2034,24 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n     query: string,\n     options?: MedplumRequestOptions\n   ): Promise<T> {\n-    return ((await this.searchOne(resource.resourceType, query, options)) ??\n-      this.createResource(resource, options)) as Promise<T>;\n+    const url = this.fhirUrl(resource.resourceType);\n+    if (!options) {\n+      options = { headers: { 'If-None-Exist': query } };\n+    } else if (!options.headers) {\n+      options.headers = { 'If-None-Exist': query };\n+    } else if (Array.isArray(options.headers)) {\n+      options.headers.push(['If-None-Exist', query]);\n+    } else if (options.headers instanceof Headers) {\n+      options.headers.set('If-None-Exist', query);\n+    } else {\n+      options.headers['If-None-Exist'] = query;\n+    }\n+\n+    const result = await this.post(url, resource, undefined, options);\n+    this.cacheResource(result);\n+    this.invalidateUrl(this.fhirUrl(resource.resourceType, resource.id as string, '_history'));\n+    this.invalidateSearches(resource.resourceType);\n+    return result;\n   }\n \n   /**\n",
    "test_patch": "diff --git a/packages/core/src/client.test.ts b/packages/core/src/client.test.ts\nindex 2cf6913443..0a0eed09cb 100644\n--- a/packages/core/src/client.test.ts\n+++ b/packages/core/src/client.test.ts\n@@ -1402,7 +1402,7 @@ describe('Client', () => {\n     expect(result.id).toBe('123'); // Expect existing patient\n   });\n \n-  test('Create resource if none exist creates new', async () => {\n+  test.each([undefined, {}])('Create resource if none exist creates new', async (emptyOptions) => {\n     const fetch = mockFetch(200, (_url, options) => {\n       if (options.method === 'GET') {\n         return { resourceType: 'Bundle', total: 0, entry: [] };\n@@ -1416,12 +1416,55 @@ describe('Client', () => {\n         resourceType: 'Patient',\n         name: [{ given: ['Bob'], family: 'Smith' }],\n       },\n-      'name:contains=bob'\n+      'name:contains=bob',\n+      emptyOptions\n     );\n     expect(result).toBeDefined();\n-    expect(fetch).toHaveBeenCalledTimes(2);\n+    expect(fetch).toHaveBeenCalledTimes(1);\n+    expect(fetch).toHaveBeenCalledWith(\n+      'https://api.medplum.com/fhir/R4/Patient',\n+      expect.objectContaining({\n+        method: 'POST',\n+        headers: {\n+          Accept: DEFAULT_ACCEPT,\n+          'Content-Type': ContentType.FHIR_JSON,\n+          'X-Medplum': 'extended',\n+          'If-None-Exist': 'name:contains=bob',\n+        },\n+      })\n+    );\n   });\n \n+  test.each<HeadersInit>([[['foo', 'bar']], { foo: 'bar' }, new Headers({ foo: 'bar' })])(\n+    'Conditional create merges passed-in headers',\n+    async (headers) => {\n+      const fetch = mockFetch(200, (_url, _options) => {\n+        return { resourceType: 'Patient', id: '123' };\n+      });\n+      const client = new MedplumClient({ fetch });\n+      const result = await client.createResourceIfNoneExist<Patient>(\n+        {\n+          resourceType: 'Patient',\n+          name: [{ given: ['Bob'], family: 'Smith' }],\n+        },\n+        'name:contains=bob',\n+        { headers }\n+      );\n+      expect(result).toBeDefined();\n+      expect(fetch).toHaveBeenCalledTimes(1);\n+\n+      expect(fetch).toHaveBeenCalledWith(\n+        'https://api.medplum.com/fhir/R4/Patient',\n+        expect.objectContaining({\n+          method: 'POST',\n+        })\n+      );\n+      const passedHeaders = new Headers(fetch.mock.calls[0][1].headers);\n+      expect(passedHeaders.get('foo')).toEqual('bar');\n+      expect(passedHeaders.get('If-None-Exist')).toEqual('name:contains=bob');\n+    }\n+  );\n+\n   test('Update resource', async () => {\n     const fetch = mockFetch(200, {});\n     const client = new MedplumClient({ fetch });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5524",
    "pr_id": 5524,
    "issue_id": 5248,
    "repo": "medplum/medplum",
    "problem_statement": "Improve OperationOutcome expression for choice-of-type properties\nCurrently, when a user encounters an issue with duplicate choice-of-type properties (e.g., multiple `value` properties in an Observation resource), our OperationOutcome returns a warning with an unresolved expression. This makes it difficult for users to identify the exact location of the problem in their resource.\r\n\r\nExample of current output:\r\n```json\r\n{\r\n  \"severity\": \"warning\",\r\n  \"code\": \"structure\",\r\n  \"expression\": [\r\n    \"value[x]\"\r\n  ],\r\n  \"details\": {\r\n    \"text\": \"Duplicate choice of type property \\\"value[x]\\\"\"\r\n  }\r\n}\r\n```\r\n\r\n## Proposed Change\r\nModify the OperationOutcome generation to include the resolved expression instead of the choice-of-type expression. This will provide users with more precise information about the location of the issue in their resource.\r\n\r\n## Expected Outcome\r\nThe OperationOutcome should include the specific property names that are in conflict, rather than the generic `value[x]` expression.\r\n\r\nExample of desired output:\r\n```json\r\n{\r\n  \"severity\": \"warning\",\r\n  \"code\": \"structure\",\r\n  \"expression\": [\r\n    \"valueString\",\r\n    \"valueQuantity\"\r\n  ],\r\n  \"details\": {\r\n    \"text\": \"Duplicate choice of type properties: \\\"valueString\\\" and \\\"valueQuantity\\\"\"\r\n  }\r\n}\r\n```\r\n\r\n## Implementation Notes\r\n1. Identify the point in our validation process where we generate OperationOutcomes for choice-of-type property conflicts.\r\n2. Modify the code to capture and include the specific property names in conflict.\r\n3. Update the expression array and details text in the OperationOutcome to reflect the resolved property names.\r\n\r\n## Testing\r\n1. Create unit tests with resources containing conflicting choice-of-type properties.\r\n2. Verify that the generated OperationOutcomes include the resolved property names.\r\n3. Test with various FHIR resources that use choice-of-type properties (e.g., Observation, Condition) to ensure broad coverage.\r\n\r\n## Impact\r\nThis change will improve the user experience by providing more actionable error messages, allowing users to quickly identify and resolve issues in their FHIR resources.\r\n\r\n## Related Issues\r\n- Link to the original customer report (if applicable)\r\n\r\n## Acceptance Criteria\r\n- [ ] OperationOutcomes for choice-of-type property conflicts include resolved property names in the `expression` array\r\n- [ ] The `details.text` provides a clear explanation mentioning the specific conflicting properties\r\n- [ ] Unit tests are in place to verify the new behavior\r\n- [ ] Documentation is updated to reflect the improved error messages (if applicable)",
    "issue_word_count": 336,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/core/src/typeschema/validation.test.ts",
      "packages/core/src/typeschema/validation.ts"
    ],
    "pr_changed_test_files": [
      "packages/core/src/typeschema/validation.test.ts"
    ],
    "base_commit": "c33f3a895ad5fa6692c66eec2ceb70d817b10b4f",
    "head_commit": "0fc148d54e77ffaaa0377720666b4e9870af045f",
    "repo_url": "https://github.com/medplum/medplum/pull/5524",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5524",
    "dockerfile": "",
    "pr_merged_at": "2024-11-12T23:17:20.000Z",
    "patch": "diff --git a/packages/core/src/typeschema/validation.ts b/packages/core/src/typeschema/validation.ts\nindex 8060a31f9d..bbe3c390b3 100644\n--- a/packages/core/src/typeschema/validation.ts\n+++ b/packages/core/src/typeschema/validation.ts\n@@ -339,8 +339,8 @@ class ResourceValidator implements CrawlerVisitor {\n             createOperationOutcomeIssue(\n               'warning',\n               'structure',\n-              `Duplicate choice of type property \"${choiceOfTypeElementName}\"`,\n-              choiceOfTypeElementName\n+              `Conflicting choice of type properties: \"${key}\", \"${choiceOfTypeElements[choiceOfTypeElementName]}\"`,\n+              key\n             )\n           );\n         }\n",
    "test_patch": "diff --git a/packages/core/src/typeschema/validation.test.ts b/packages/core/src/typeschema/validation.test.ts\nindex dbd9ac2129..3572aeb573 100644\n--- a/packages/core/src/typeschema/validation.test.ts\n+++ b/packages/core/src/typeschema/validation.test.ts\n@@ -1367,7 +1367,7 @@ describe('FHIR resource validation', () => {\n     expect(issues[0].details?.text).toContain(textContains);\n   }\n \n-  const DUPLICATE_CHOICE_OF_TYPE_PROPERTY = 'Duplicate choice of type property';\n+  const DUPLICATE_CHOICE_OF_TYPE_PROPERTY = 'Conflicting choice of type properties';\n   const PRIMITIVE_EXTENSION_TYPE_MISMATCH = 'Type of primitive extension does not match the type of property';\n \n   test('Multiple values for choice of type property', () => {\n@@ -1398,6 +1398,8 @@ describe('FHIR resource validation', () => {\n     };\n \n     expectOneWarning(carePlan, DUPLICATE_CHOICE_OF_TYPE_PROPERTY);\n+    expectOneWarning(carePlan, 'scheduledTiming');\n+    expectOneWarning(carePlan, 'scheduledPeriod');\n   });\n \n   test('Valid choice of type properties with primitive extensions', () => {\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5523",
    "pr_id": 5523,
    "issue_id": 5416,
    "repo": "medplum/medplum",
    "problem_statement": "Odd caching bug around `projectId`s \nI'm running into a bunch of 404s on GraphQL after PATCHing resources. \r\n\r\nThe cause of this \"404\" is that frequently in the redis cache, we're putting in resources with missing projectIds, so when we query overy GQL, the API 404s the object, since it can't verify which project it came from.\r\n![image](https://github.com/user-attachments/assets/87739c52-32e2-4ede-9769-5442e10a075e)\r\n\r\n\r\nI dropped a debugger in the code, and it seems to be stemming from the postCommit callbacks. On my specific transaction, I see that there are 3 stacked postCommit callBacks, and on the final callBack, project becomes undefined and then we store the broken object in Redis, which ends up causing the 404. (On the first two callBacks, there is a `projectId` present)\r\n\r\nI'm not exactly sure what's causing this final callback to be missing the project, but I believe it's related to the changes in PR #4358. I reverted to version `3.2.10` and the behavior returns to what we expect.\r\n",
    "issue_word_count": 178,
    "test_files_count": 2,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/server/src/fhir/repo.test.ts",
      "packages/server/src/fhir/repo.ts",
      "packages/server/src/test.setup.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/repo.test.ts",
      "packages/server/src/test.setup.ts"
    ],
    "base_commit": "c33f3a895ad5fa6692c66eec2ceb70d817b10b4f",
    "head_commit": "3a5a3e48edd7299b259e0b57a03f30032a755e84",
    "repo_url": "https://github.com/medplum/medplum/pull/5523",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5523",
    "dockerfile": "",
    "pr_merged_at": "2024-11-13T19:16:25.000Z",
    "patch": "diff --git a/packages/server/src/fhir/repo.ts b/packages/server/src/fhir/repo.ts\nindex 75f53f5c8b..6b9caf9ffa 100644\n--- a/packages/server/src/fhir/repo.ts\n+++ b/packages/server/src/fhir/repo.ts\n@@ -15,6 +15,7 @@ import {\n   canReadResourceType,\n   canWriteResourceType,\n   createReference,\n+  deepClone,\n   deepEquals,\n   evalFhirPath,\n   evalFhirPathTyped,\n@@ -2310,7 +2311,10 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n   private async setCacheEntry(resource: Resource): Promise<void> {\n     // No cache access allowed mid-transaction\n     if (this.transactionDepth) {\n-      await this.postCommit(() => this.setCacheEntry(resource));\n+      const cachedResource = deepClone(resource);\n+      await this.postCommit(() => {\n+        return this.setCacheEntry(cachedResource);\n+      });\n       return;\n     }\n \n",
    "test_patch": "diff --git a/packages/server/src/fhir/repo.test.ts b/packages/server/src/fhir/repo.test.ts\nindex 8cecbee075..26035872ae 100644\n--- a/packages/server/src/fhir/repo.test.ts\n+++ b/packages/server/src/fhir/repo.test.ts\n@@ -1230,4 +1230,28 @@ describe('FHIR Repo', () => {\n       });\n       await expect(repo.createResource(patientJson)).resolves.toBeDefined();\n     }));\n+\n+  test('Patch post-commit stores full resource in cache', async () =>\n+    withTestContext(async () => {\n+      const { project, repo, login, membership } = await createTestProject({\n+        withRepo: { extendedMode: false },\n+        withAccessToken: true,\n+        withClient: true,\n+      });\n+      const extendedRepo = await getRepoForLogin({ login, project, membership }, true);\n+\n+      const patient = await repo.createResource<Patient>({ resourceType: 'Patient' });\n+      expect(patient.meta?.project).toBeUndefined();\n+      expect(patient.gender).toBeUndefined();\n+\n+      const updatedPatient = await repo.patchResource<Patient>('Patient', patient.id as string, [\n+        { op: 'add', path: '/gender', value: 'unknown' },\n+      ]);\n+      expect(updatedPatient.meta?.project).toBeUndefined();\n+      expect(updatedPatient.gender).toEqual('unknown');\n+\n+      const cachedPatient = await extendedRepo.readResource<Patient>('Patient', patient.id as string);\n+      expect(cachedPatient.meta?.project).toEqual(project.id);\n+      expect(cachedPatient.gender).toEqual('unknown');\n+    }));\n });\n\ndiff --git a/packages/server/src/test.setup.ts b/packages/server/src/test.setup.ts\nindex a499911886..ee75cadd24 100644\n--- a/packages/server/src/test.setup.ts\n+++ b/packages/server/src/test.setup.ts\n@@ -16,7 +16,7 @@ import internal from 'stream';\n import request from 'supertest';\n import { ServerInviteResponse, inviteUser } from './admin/invite';\n import { AuthenticatedRequestContext, requestContextStore } from './context';\n-import { Repository, getSystemRepo } from './fhir/repo';\n+import { Repository, RepositoryContext, getSystemRepo } from './fhir/repo';\n import { generateAccessToken } from './oauth/keys';\n import { tryLogin } from './oauth/utils';\n \n@@ -27,7 +27,7 @@ export interface TestProjectOptions {\n   superAdmin?: boolean;\n   withClient?: boolean;\n   withAccessToken?: boolean;\n-  withRepo?: boolean;\n+  withRepo?: boolean | Partial<RepositoryContext>;\n }\n \n type Exact<T, U extends T> = T & Record<Exclude<keyof U, keyof T>, never>;\n@@ -40,7 +40,7 @@ export type TestProjectResult<T extends TestProjectOptions> = {\n   membership: T['withClient'] extends true ? ProjectMembership : undefined;\n   login: T['withAccessToken'] extends true ? Login : undefined;\n   accessToken: T['withAccessToken'] extends true ? string : undefined;\n-  repo: T['withRepo'] extends true ? Repository : undefined;\n+  repo: T['withRepo'] extends true | Partial<RepositoryContext> ? Repository : undefined;\n };\n \n export async function createTestProject<T extends StrictTestProjectOptions<T> = TestProjectOptions>(\n@@ -126,7 +126,7 @@ export async function createTestProject<T extends StrictTestProjectOptions<T> =\n       }\n \n       if (options?.withRepo) {\n-        repo = new Repository({\n+        const repoContext = {\n           projects: [project.id as string],\n           currentProject: project,\n           author: createReference(client),\n@@ -136,7 +136,12 @@ export async function createTestProject<T extends StrictTestProjectOptions<T> =\n           strictMode: project.strictMode,\n           extendedMode: true,\n           checkReferencesOnWrite: project.checkReferencesOnWrite,\n-        });\n+        };\n+\n+        if (typeof options.withRepo === 'object') {\n+          Object.assign(repoContext, options.withRepo);\n+        }\n+        repo = new Repository(repoContext);\n       }\n     }\n \n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5520",
    "pr_id": 5520,
    "issue_id": 5519,
    "repo": "medplum/medplum",
    "problem_statement": "`Bundle.entry` without a `fullUrl` incorrectly fails validation\nWhen attempting to create a `Bundle` resource with an `entry` without `fullUrl` like:\r\n```ts\r\n{\r\n  \"resourceType\": \"Bundle\",\r\n  \"type\": \"searchset\",\r\n  \"entry\": [\r\n    {\r\n      \"resource\": {\r\n        \"resourceType\": \"Patient\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nWe get a violation of constraint `bdl-8` (see: https://hl7.org/fhir/R4/bundle.html#invs):\r\n`fullUrl.contains('/_history/').not()`\r\n\r\nThis constraint in R4 conflicts with the optional cardinality of `fullUrl`, however this was fixed in R5 with an update to `bdl-8` (see: https://hl7.org/fhir/R5/bundle.html#invs):\r\n`fullUrl.exists() implies fullUrl.contains('/_history/').not()`\r\n\r\nWe should backport this change to `bdl-8` so that a `Bundle.entry` without `fullUrl` doesn't cause validation to fail.\r\n",
    "issue_word_count": 111,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/core/src/typeschema/validation.test.ts",
      "packages/definitions/dist/fhir/r4/profiles-resources.json"
    ],
    "pr_changed_test_files": [
      "packages/core/src/typeschema/validation.test.ts"
    ],
    "base_commit": "030f8fc938a245e2d84debd2244eecfa3fbcf11f",
    "head_commit": "eda554532c4005e9b1fcfdeb21ff27fdf3a29a46",
    "repo_url": "https://github.com/medplum/medplum/pull/5520",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5520",
    "dockerfile": "",
    "pr_merged_at": "2024-11-12T18:57:49.000Z",
    "patch": "diff --git a/packages/definitions/dist/fhir/r4/profiles-resources.json b/packages/definitions/dist/fhir/r4/profiles-resources.json\nindex 29c7af60b6..82acb4ae11 100644\n--- a/packages/definitions/dist/fhir/r4/profiles-resources.json\n+++ b/packages/definitions/dist/fhir/r4/profiles-resources.json\n@@ -47255,7 +47255,7 @@\n             \"key\" : \"bdl-8\",\n             \"severity\" : \"error\",\n             \"human\" : \"fullUrl cannot be a version specific reference\",\n-            \"expression\" : \"fullUrl.contains('/_history/').not()\",\n+            \"expression\" : \"fullUrl.exists() implies fullUrl.contains('/_history/').not()\",\n             \"xpath\" : \"not(exists(f:fullUrl[contains(string(@value), '/_history/')]))\"\n           },\n           {\n@@ -48472,7 +48472,7 @@\n             \"key\" : \"bdl-8\",\n             \"severity\" : \"error\",\n             \"human\" : \"fullUrl cannot be a version specific reference\",\n-            \"expression\" : \"fullUrl.contains('/_history/').not()\",\n+            \"expression\" : \"fullUrl.exists() implies fullUrl.contains('/_history/').not()\",\n             \"xpath\" : \"not(exists(f:fullUrl[contains(string(@value), '/_history/')]))\"\n           },\n           {\n",
    "test_patch": "diff --git a/packages/core/src/typeschema/validation.test.ts b/packages/core/src/typeschema/validation.test.ts\nindex cb813ca80f..dbd9ac2129 100644\n--- a/packages/core/src/typeschema/validation.test.ts\n+++ b/packages/core/src/typeschema/validation.test.ts\n@@ -35,7 +35,8 @@ import { readFileSync } from 'fs';\n import { resolve } from 'path';\n import { HTTP_HL7_ORG, LOINC, RXNORM, SNOMED, UCUM } from '../constants';\n import { ContentType } from '../contenttype';\n-import { OperationOutcomeError } from '../outcomes';\n+import { generateId } from '../crypto';\n+import { OperationOutcomeError, validationError } from '../outcomes';\n import { createReference, deepClone } from '../utils';\n import { indexStructureDefinitionBundle, loadDataType } from './types';\n import { validateResource, validateTypedValue } from './validation';\n@@ -1698,6 +1699,43 @@ describe('FHIR resource validation', () => {\n     };\n     expect(() => validateTypedValue({ type: 'Timing', value: timing2 })).toThrow('Constraint tim-9 not met');\n   });\n+\n+  test('Bundle constraint: bdl-8', () => {\n+    // fullUrl not required in `Bundle.entry`\n+    const noFullUrlBdl: Bundle = {\n+      resourceType: 'Bundle',\n+      type: 'searchset',\n+      entry: [{ resource: { resourceType: 'Patient' } }],\n+    };\n+    expect(() => validateResource(noFullUrlBdl)).not.toThrow();\n+\n+    // If it does exist, no `_history` version\n+    const validFullUrlBdl: Bundle = {\n+      resourceType: 'Bundle',\n+      type: 'searchset',\n+      entry: [{ fullUrl: `http://example.com/fhir/R4/Patient/${generateId()}`, resource: { resourceType: 'Patient' } }],\n+    };\n+    expect(() => validateResource(validFullUrlBdl)).not.toThrow();\n+\n+    // This should fail since it contains `_history`\n+    const invalidFullUrlBdl: Bundle = {\n+      resourceType: 'Bundle',\n+      type: 'searchset',\n+      entry: [\n+        {\n+          fullUrl: `http://example.com/fhir/R4/Patient/${generateId()}/_history/${generateId()}`,\n+          resource: { resourceType: 'Patient' },\n+        },\n+      ],\n+    };\n+    expect(() => validateResource(invalidFullUrlBdl)).toThrow(\n+      new OperationOutcomeError(\n+        validationError(\n+          `Constraint bdl-8 not met: fullUrl cannot be a version specific reference ({\"fhirpath\":\"fullUrl.exists() implies fullUrl.contains('/_history/').not()\"}) (Bundle.entry[0])`\n+        )\n+      )\n+    );\n+  });\n });\n \n function fail(reason: string): never {\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5513",
    "pr_id": 5513,
    "issue_id": 5499,
    "repo": "medplum/medplum",
    "problem_statement": "Using chained search or _filter in query with _sort and _count breaks expected sorting.\nHello again,\r\n\r\n## Background\r\n\r\nI have been doing a lot of testing recently and came across this issue while learning chained search and _filter in the standard.\r\nAll testing here was done against a Synthea dataset.\r\n\r\nI initially had a query with the following parameters.\r\n```\r\n   {\r\n        subject: ref,\r\n        _count: 20,\r\n        category: 'BG,CG,CH,CP,GE,HM,IMM,LAB,MB,MCB,MYC,PAR,PAT,PF,SR,TX,VR,URN',\r\n        status: 'final',\r\n        _offset: 0,\r\n        _sort: -date,\r\n        _total: accurate\r\n    }\r\n```\r\nThis would yield a list of `DiagnosticReport` resources presorted by the date time in descending order.\r\n\r\nI then tried filtering with a chained search like so\r\n\r\n```\r\n   {\r\n        subject: ref,\r\n        _count: 20,\r\n        category: 'BG,CG,CH,CP,GE,HM,IMM,LAB,MB,MCB,MYC,PAR,PAT,PF,SR,TX,VR,URN',\r\n        status: 'final',\r\n        'result:Observation.category': 'http://terminology.hl7.org/CodeSystem/observation-category|laboratory',\r\n        _offset: 0,\r\n        _sort: -date,\r\n        _total: accurate\r\n    }\r\n```\r\n\r\nNow, each block of 20 resource instances are sorted by the date time in descending order (possibly because of a sorting function after the query), but the global sorting is no longer valid.\r\nMeaning, if I set the _offset to 20, the next page of results does not appear to match the expected order.\r\n\r\nNo difference was spotted with the usage of _filter\r\n\r\n```\r\n   {\r\n        subject: ref,\r\n        _count: 20,\r\n        category: 'BG,CG,CH,CP,GE,HM,IMM,LAB,MB,MCB,MYC,PAR,PAT,PF,SR,TX,VR,URN',\r\n        status: 'final',\r\n        _filter: 'result.category eq http://terminology.hl7.org/CodeSystem/observation-category|laboratory',\r\n        _offset: 0,\r\n        _sort: -date,\r\n        _total: accurate\r\n    }\r\n```\r\n\r\nIn fact, the results and sorting are comparable.\r\n\r\nMeaning, \r\n\r\n1. Imaging you have a some list L [ R1(2008/10/11), R2(2006/10/11), R3(2007/10/11), R4(2008/10/11)]\r\n2. It sorted like L1 [ R1(2008/10/11), R4(2008/10/11)] and L2 [R3(2007/10/11), R2(2006/10/11)]\r\n3. With chained search or _filter, the new sorting is more like L1 [ R1(2008/10/11), R3(2007/10/11)] and L2 [R4(2008/10/11), R2(2006/10/11)] during pagination.\r\n\r\n## Raw FHIR Query\r\n`subject=Patient%2F4b7f03ae-6696-4e73-9ca7-ba6b3a201fce&_count=20&category=BG%2CCG%2CCH%2CCP%2CGE%2CHM%2CIMM%2CLAB%2CMB%2CMCB%2CMYC%2CPAR%2CPAT%2CPF%2CSR%2CTX%2CVR%2CURN&status=final&result%3AObservation.category%3Anot=http%3A%2F%2Fterminology.hl7.org%2FCodeSystem%2Fobservation-category%7Claboratory&_offset=0&_sort=-date&_total=accurate`\r\n\r\n![image](https://github.com/user-attachments/assets/bf598576-f3ed-44be-b6ec-e78b3ae4ece8)\r\n\r\n## Sample Synthea case\r\n\r\n[Rozella39_Mertz280_ef167059-cef0-12c4-49db-993ca3a20c01.zip](https://github.com/user-attachments/files/17637929/Rozella39_Mertz280_ef167059-cef0-12c4-49db-993ca3a20c01.zip)\r\n\r\n## Images\r\n### Without chained search\r\n![image](https://github.com/user-attachments/assets/30d0a535-b2a1-4ceb-90cb-a2d0bf05ace9)\r\n![image](https://github.com/user-attachments/assets/cf84c26b-cdde-4ced-9263-b5a5ddcde886)\r\n![image](https://github.com/user-attachments/assets/f874e747-7081-441e-b43d-ed498785dcbe)\r\n\r\n### With chained search\r\n\r\n![image](https://github.com/user-attachments/assets/d5591335-0c1a-4452-9041-93155cefe0ad)\r\n![image](https://github.com/user-attachments/assets/af0cc88d-d47b-4434-ad5a-c9de1a194158)\r\n![image](https://github.com/user-attachments/assets/9697bee2-a792-434e-becb-f8949108a5f0)\r\n\r\nI expected the survey entries to drop but the order to remain the same.\r\n\r\n## Possible Scenarios\r\n\r\n- Sorting is done after isolating n count of entries from unsorted match pool.\r\n- Sorting is applied globally but perhaps the chained search returns the final match pool unsorted.\r\n- Other?\r\n\r\nI will need to find out the exact SQL query pushed to the database to get an idea of how the FHIR query is getting transformed. Maybe it is as simple as a subtle order of operations issue.\r\nI will try to report back what I find later in the week, but reporting issue now in case someone with experience recognizes the issue right away.\r\n\r\n## Notes\r\n\r\n- I tried using _query and _has for the filtering. _has may be wrong for what I was trying to do, but both of these special parameters are not recognized by the server.\r\n",
    "issue_word_count": 661,
    "test_files_count": 2,
    "non_test_files_count": 5,
    "pr_changed_files": [
      "packages/server/src/fhir/lookups/lookuptable.ts",
      "packages/server/src/fhir/lookups/token.ts",
      "packages/server/src/fhir/operations/utils/terminology.ts",
      "packages/server/src/fhir/search.test.ts",
      "packages/server/src/fhir/search.ts",
      "packages/server/src/fhir/sql.test.ts",
      "packages/server/src/fhir/sql.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/search.test.ts",
      "packages/server/src/fhir/sql.test.ts"
    ],
    "base_commit": "eab9c11a443cb000cf37373c855561cd33c1d01e",
    "head_commit": "b53cd4b921102c81c4fd775c0434282ab3d944b8",
    "repo_url": "https://github.com/medplum/medplum/pull/5513",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5513",
    "dockerfile": "",
    "pr_merged_at": "2024-12-03T17:56:26.000Z",
    "patch": "diff --git a/packages/server/src/fhir/lookups/lookuptable.ts b/packages/server/src/fhir/lookups/lookuptable.ts\nindex bcdb60c246..1917c5ff9b 100644\n--- a/packages/server/src/fhir/lookups/lookuptable.ts\n+++ b/packages/server/src/fhir/lookups/lookuptable.ts\n@@ -99,14 +99,12 @@ export abstract class LookupTable {\n     }\n \n     const exists = new SqlFunction('EXISTS', [\n-      new SelectQuery(lookupTableName)\n-        .column('resourceId')\n-        .whereExpr(\n-          new Conjunction([\n-            new Condition(new Column(table, 'id'), '=', new Column(lookupTableName, 'resourceId')),\n-            disjunction,\n-          ])\n-        ),\n+      new SelectQuery(lookupTableName).whereExpr(\n+        new Conjunction([\n+          new Condition(new Column(table, 'id'), '=', new Column(lookupTableName, 'resourceId')),\n+          disjunction,\n+        ])\n+      ),\n     ]);\n \n     if (filter.operator === FhirOperator.NOT_EQUALS || filter.operator === FhirOperator.NOT) {\n\ndiff --git a/packages/server/src/fhir/lookups/token.ts b/packages/server/src/fhir/lookups/token.ts\nindex 2892b51c2c..8df54bafac 100644\n--- a/packages/server/src/fhir/lookups/token.ts\n+++ b/packages/server/src/fhir/lookups/token.ts\n@@ -134,9 +134,7 @@ export class TokenTable extends LookupTable {\n       conjunction.expressions.push(whereExpression);\n     }\n \n-    const exists = new SqlFunction('EXISTS', [\n-      new SelectQuery(lookupTableName).column('resourceId').whereExpr(conjunction),\n-    ]);\n+    const exists = new SqlFunction('EXISTS', [new SelectQuery(lookupTableName).whereExpr(conjunction)]);\n \n     if (shouldTokenRowExist(filter)) {\n       return exists;\n\ndiff --git a/packages/server/src/fhir/operations/utils/terminology.ts b/packages/server/src/fhir/operations/utils/terminology.ts\nindex 366e839af2..7ed04b98a5 100644\n--- a/packages/server/src/fhir/operations/utils/terminology.ts\n+++ b/packages/server/src/fhir/operations/utils/terminology.ts\n@@ -86,14 +86,12 @@ export function addPropertyFilter(\n   operator: keyof typeof SqlOperator,\n   value: string | string[]\n ): SelectQuery {\n-  const propertyQuery = new SelectQuery('Coding_Property')\n-    .column('coding')\n-    .whereExpr(\n-      new Conjunction([\n-        new Condition(new Column(query.tableName, 'id'), '=', new Column('Coding_Property', 'coding')),\n-        new Condition('value', operator, value),\n-      ])\n-    );\n+  const propertyQuery = new SelectQuery('Coding_Property').whereExpr(\n+    new Conjunction([\n+      new Condition(new Column(query.tableName, 'id'), '=', new Column('Coding_Property', 'coding')),\n+      new Condition('value', operator, value),\n+    ])\n+  );\n \n   const csPropertyTable = propertyQuery.getNextJoinAlias();\n   propertyQuery.join(\n\ndiff --git a/packages/server/src/fhir/search.ts b/packages/server/src/fhir/search.ts\nindex d02eb0119e..b45681d124 100644\n--- a/packages/server/src/fhir/search.ts\n+++ b/packages/server/src/fhir/search.ts\n@@ -63,6 +63,7 @@ import {\n   periodToRangeString,\n   SelectQuery,\n   Operator as SQL,\n+  SqlFunction,\n   Union,\n   ValuesQuery,\n } from './sql';\n@@ -85,16 +86,23 @@ interface Cursor {\n   excludedIds?: string[];\n }\n \n+/** Linking direction for chained search. */\n+const Direction = {\n+  FORWARD: 1,\n+  REVERSE: -1,\n+} as const;\n+\n interface ChainedSearchLink {\n-  resourceType: string;\n+  originType: string;\n+  targetType: string;\n   code: string;\n   details: SearchParameterDetails;\n-  reverse?: boolean;\n-  filter?: Filter;\n+  direction: (typeof Direction)['FORWARD'] | (typeof Direction)['REVERSE'];\n }\n \n interface ChainedSearchParameter {\n   chain: ChainedSearchLink[];\n+  filter: Filter;\n }\n \n export async function searchImpl<T extends Resource>(\n@@ -1371,9 +1379,9 @@ function buildChainedSearch(\n   // Special case: single-link chain of the form param._id=<id> can be rewritten as param=ResourceType/<id>\n   // Note that this does slightly change the behavior of the search query: true chained search would require the\n   // reference to point to an existing resource, while the rewritten query just matches the reference string\n-  if (param.chain.length === 1 && param.chain[0].filter?.code === '_id' && !param.chain[0].reverse) {\n-    const { resourceType: targetType, code, filter } = param.chain[0];\n-    const targetId = filter.value;\n+  if (param.chain.length === 1 && param.filter?.code === '_id' && param.chain[0].direction === Direction.FORWARD) {\n+    const { targetType, code } = param.chain[0];\n+    const targetId = param.filter.value;\n     return buildSearchFilterExpression(repo, selectQuery, resourceType as ResourceType, resourceType, {\n       code,\n       operator: Operator.EQUALS,\n@@ -1382,7 +1390,7 @@ function buildChainedSearch(\n   }\n \n   if (usesReferenceLookupTable(repo)) {\n-    return buildChainedSearchUsingReferenceTable(repo, selectQuery, resourceType, param);\n+    return buildChainedSearchUsingReferenceTable(repo, selectQuery, param);\n   } else {\n     return buildChainedSearchUsingReferenceStrings(repo, selectQuery, resourceType, param);\n   }\n@@ -1401,94 +1409,134 @@ function usesReferenceLookupTable(repo: Repository): boolean {\n  * Self-hosted servers need to run a full re-index before this technique can be used.\n  * @param repo - The repository.\n  * @param selectQuery - The select query builder.\n- * @param resourceType - The top level resource type.\n  * @param param - The chained search parameter.\n  * @returns The WHERE clause expression for the final chained filter.\n  */\n function buildChainedSearchUsingReferenceTable(\n   repo: Repository,\n   selectQuery: SelectQuery,\n-  resourceType: string,\n   param: ChainedSearchParameter\n ): Expression {\n-  let currentResourceType = resourceType;\n-  let currentTable = resourceType;\n-  for (const link of param.chain) {\n+  let link = param.chain[0];\n+  let currentTable = nextChainedTable(link);\n+\n+  // Set up subquery for EXISTS(), starting on the first link of the chain\n+  let innerQuery: SelectQuery;\n+  if (link.details.type === SearchParameterType.CANONICAL) {\n+    innerQuery = new SelectQuery(currentTable).whereExpr(\n+      getCanonicalJoinCondition(selectQuery.tableName, link, currentTable)\n+    );\n+  } else {\n+    innerQuery = new SelectQuery(currentTable).whereExpr(\n+      lookupTableJoinCondition(selectQuery.tableName, link, currentTable)\n+    );\n+    currentTable = linkLiteralReference(innerQuery, currentTable, link);\n+  }\n+\n+  // Add joins to inner query for all subsequent chain links\n+  for (let i = 1; i < param.chain.length; i++) {\n+    link = param.chain[i];\n     if (link.details.type === SearchParameterType.CANONICAL) {\n-      currentTable = linkCanonicalReference(selectQuery, currentTable, link);\n+      currentTable = linkCanonicalReference(innerQuery, currentTable, link);\n     } else {\n-      currentTable = linkLiteralReference(selectQuery, currentTable, link, currentResourceType);\n-    }\n-    currentResourceType = link.resourceType;\n-\n-    if (link.filter) {\n-      return buildSearchFilterExpression(\n-        repo,\n-        selectQuery,\n-        currentResourceType as ResourceType,\n-        currentTable,\n-        link.filter\n-      );\n+      const lookupTable = linkReferenceLookupTable(innerQuery, currentTable, link);\n+      currentTable = linkLiteralReference(innerQuery, lookupTable, link);\n     }\n   }\n-  throw new OperationOutcomeError(badRequest('Unterminated chained search'));\n+\n+  // Add terminal conditions on final target table, and return EXISTS() over subquery\n+  innerQuery\n+    .where(new Column(currentTable, 'id'), '!=', null)\n+    .whereExpr(\n+      buildSearchFilterExpression(repo, innerQuery, link.targetType as ResourceType, currentTable, param.filter)\n+    );\n+  return new SqlFunction('EXISTS', [innerQuery]);\n }\n \n+/**\n+ * Join a query to the next table via canonical reference (i.e. by `url`).\n+ * @param selectQuery - The query to which the join will be added.\n+ * @param currentTable - The \"current\" table in the chained search construction.\n+ * @param link - The current link of the chained search.\n+ * @returns The next table alias.\n+ */\n function linkCanonicalReference(selectQuery: SelectQuery, currentTable: string, link: ChainedSearchLink): string {\n-  const nextTableAlias = selectQuery.getNextJoinAlias();\n-  const eq = link.details.array ? 'IN_SUBQUERY' : '=';\n-\n-  let join: Condition;\n-  if (link.reverse) {\n-    join = new Condition(new Column(currentTable, 'url'), eq, new Column(nextTableAlias, link.details.columnName));\n-  } else {\n-    join = new Condition(new Column(nextTableAlias, 'url'), eq, new Column(currentTable, link.details.columnName));\n-  }\n-\n-  selectQuery.join('LEFT JOIN', link.resourceType, nextTableAlias, join);\n-  return nextTableAlias;\n+  const nextTable = selectQuery.getNextJoinAlias();\n+  const join = getCanonicalJoinCondition(currentTable, link, nextTable);\n+  selectQuery.join('LEFT JOIN', nextChainedTable(link), nextTable, join);\n+  return nextTable;\n }\n \n-function linkLiteralReference(\n-  selectQuery: SelectQuery,\n-  currentTable: string,\n-  link: ChainedSearchLink,\n-  currentResourceType: string\n-): string {\n-  let referenceTableName: string;\n-  let currentColumnName: string;\n-  let nextColumnName;\n-\n-  if (link.reverse) {\n-    referenceTableName = `${link.resourceType}_References`;\n-    currentColumnName = 'targetId';\n-    nextColumnName = 'resourceId';\n-  } else {\n-    referenceTableName = `${currentResourceType}_References`;\n-    currentColumnName = 'resourceId';\n-    nextColumnName = 'targetId';\n-  }\n-\n-  const referenceTableAlias = selectQuery.getNextJoinAlias();\n+/**\n+ * Join a query to a reference lookup table for chained search.\n+ * @param selectQuery - The query to which the join will be added.\n+ * @param currentTable - The \"current\" table in the chained search construction.\n+ * @param link - The current link of the chained search.\n+ * @returns The next table alias.\n+ */\n+function linkReferenceLookupTable(selectQuery: SelectQuery, currentTable: string, link: ChainedSearchLink): string {\n+  const referenceTable = selectQuery.getNextJoinAlias();\n   selectQuery.join(\n     'LEFT JOIN',\n-    referenceTableName,\n-    referenceTableAlias,\n-    new Conjunction([\n-      new Condition(new Column(referenceTableAlias, currentColumnName), '=', new Column(currentTable, 'id')),\n-      new Condition(new Column(referenceTableAlias, 'code'), '=', link.code),\n-    ])\n+    nextChainedTable(link),\n+    referenceTable,\n+    lookupTableJoinCondition(currentTable, link, referenceTable)\n   );\n+  return referenceTable;\n+}\n \n-  const nextTableAlias = selectQuery.getNextJoinAlias();\n+/**\n+ * Join a query to the next resource table for chained search.\n+ * @param selectQuery - The query to which the join will be added.\n+ * @param lookupTable - The \"current\" table in the chained search construction, assumed to be a reference lookup table.\n+ * @param link - The current link of the chained search.\n+ * @returns The next table alias.\n+ */\n+function linkLiteralReference(selectQuery: SelectQuery, lookupTable: string, link: ChainedSearchLink): string {\n+  const nextColumn = link.direction === Direction.FORWARD ? 'targetId' : 'resourceId';\n+  const nextTable = selectQuery.getNextJoinAlias();\n   selectQuery.join(\n     'LEFT JOIN',\n-    link.resourceType,\n-    nextTableAlias,\n-    new Condition(new Column(nextTableAlias, 'id'), '=', new Column(referenceTableAlias, nextColumnName))\n+    link.targetType,\n+    nextTable,\n+    new Condition(new Column(nextTable, 'id'), '=', new Column(lookupTable, nextColumn))\n   );\n \n-  return nextTableAlias;\n+  return nextTable;\n+}\n+\n+function getCanonicalJoinCondition(currentTable: string, link: ChainedSearchLink, nextTable: string): Expression {\n+  const eq = link.details.array ? 'IN_SUBQUERY' : '=';\n+  if (link.direction === Direction.FORWARD) {\n+    return new Condition(new Column(nextTable, 'url'), eq, new Column(currentTable, link.details.columnName));\n+  } else {\n+    return new Condition(new Column(currentTable, 'url'), eq, new Column(nextTable, link.details.columnName));\n+  }\n+}\n+\n+function nextChainedTable(link: ChainedSearchLink): string {\n+  if (link.details.type === SearchParameterType.CANONICAL) {\n+    return link.targetType;\n+  } else if (link.direction === Direction.FORWARD) {\n+    return `${link.originType}_References`;\n+  } else {\n+    return `${link.targetType}_References`;\n+  }\n+}\n+\n+/**\n+ * Constructs the condition for joining a resource table to a reference lookup table for chained search.\n+ * @param currentTable - The \"current\" table in the chained search construction, assumed to be a resource table.\n+ * @param link - The current link of the chained search.\n+ * @param nextTable - The reference lookup table next in the chained search.\n+ * @returns The expression relating the two tables, which can be used as a JOIN condition or in a WHERE clause.\n+ */\n+function lookupTableJoinCondition(currentTable: string, link: ChainedSearchLink, nextTable: string): Expression {\n+  const column = link.direction === Direction.FORWARD ? 'resourceId' : 'targetId';\n+  return new Conjunction([\n+    new Condition(new Column(nextTable, column), '=', new Column(currentTable, 'id')),\n+    new Condition(new Column(nextTable, 'code'), '=', link.code),\n+  ]);\n }\n \n /**\n@@ -1517,24 +1565,20 @@ function buildChainedSearchUsingReferenceStrings(\n     } else {\n       const nextTable = selectQuery.getNextJoinAlias();\n       const joinCondition = buildSearchLinkCondition(currentResourceType, link, currentTable, nextTable);\n-      selectQuery.join('LEFT JOIN', link.resourceType, nextTable, joinCondition);\n+      selectQuery.join('LEFT JOIN', link.targetType, nextTable, joinCondition);\n \n       currentTable = nextTable;\n     }\n \n-    currentResourceType = link.resourceType;\n-\n-    if (link.filter) {\n-      return buildSearchFilterExpression(\n-        repo,\n-        selectQuery,\n-        link.resourceType as ResourceType,\n-        currentTable,\n-        link.filter\n-      );\n-    }\n+    currentResourceType = link.targetType;\n   }\n-  throw new OperationOutcomeError(badRequest('Unterminated chained search'));\n+  return buildSearchFilterExpression(\n+    repo,\n+    selectQuery,\n+    currentResourceType as ResourceType,\n+    currentTable,\n+    param.filter\n+  );\n }\n \n function buildSearchLinkCondition(\n@@ -1544,7 +1588,7 @@ function buildSearchLinkCondition(\n   nextTable: string\n ): Expression {\n   const linkColumn = new Column(currentTable, link.details.columnName);\n-  if (link.reverse) {\n+  if (link.direction === Direction.REVERSE) {\n     const nextColumn = new Column(nextTable, link.details.columnName);\n     const currentColumn = new Column(currentTable, 'id');\n \n@@ -1567,32 +1611,36 @@ function buildSearchLinkCondition(\n }\n \n function parseChainedParameter(resourceType: string, key: string, value: string): ChainedSearchParameter {\n-  const param: ChainedSearchParameter = {\n-    chain: [],\n-  };\n   let currentResourceType = resourceType;\n-\n   const parts = splitChainedSearch(key);\n+\n+  const chain: ChainedSearchLink[] = [];\n+  let filter: Filter | undefined;\n   for (let i = 0; i < parts.length; i++) {\n     const part = parts[i];\n     if (part.startsWith('_has')) {\n       const link = parseReverseChainLink(part, currentResourceType);\n-      param.chain.push(link);\n-      currentResourceType = link.resourceType;\n+      chain.push(link);\n+      currentResourceType = link.targetType;\n     } else if (i === parts.length - 1) {\n       const [code, modifier] = splitN(part, ':', 2);\n       const searchParam = getSearchParameter(currentResourceType, code);\n       if (!searchParam) {\n         throw new Error(`Invalid search parameter at end of chain: ${currentResourceType}?${code}`);\n       }\n-      param.chain[param.chain.length - 1].filter = parseParameter(searchParam, modifier, value);\n+      filter = parseParameter(searchParam, modifier, value);\n     } else {\n       const link = parseChainLink(part, currentResourceType);\n-      param.chain.push(link);\n-      currentResourceType = link.resourceType;\n+      chain.push(link);\n+      currentResourceType = link.targetType;\n     }\n   }\n-  return param;\n+\n+  if (!filter) {\n+    throw new OperationOutcomeError(badRequest('Unterminated chained search'));\n+  }\n+\n+  return { chain, filter };\n }\n \n function parseChainLink(param: string, currentResourceType: string): ChainedSearchLink {\n@@ -1601,16 +1649,16 @@ function parseChainLink(param: string, currentResourceType: string): ChainedSear\n   if (!searchParam) {\n     throw new Error(`Invalid search parameter in chain: ${currentResourceType}?${code}`);\n   }\n-  let resourceType: string;\n+  let targetType: string;\n   if (searchParam.target?.length === 1) {\n-    resourceType = searchParam.target[0];\n+    targetType = searchParam.target[0];\n   } else if (searchParam.target?.includes(modifier as ResourceType)) {\n-    resourceType = modifier;\n+    targetType = modifier;\n   } else {\n     throw new Error(`Unable to identify next resource type for search parameter: ${currentResourceType}?${code}`);\n   }\n   const details = getSearchParameterDetails(currentResourceType, searchParam);\n-  return { resourceType, code, details };\n+  return { originType: currentResourceType, targetType, code, details, direction: Direction.FORWARD };\n }\n \n function parseReverseChainLink(param: string, targetResourceType: string): ChainedSearchLink {\n@@ -1624,7 +1672,7 @@ function parseReverseChainLink(param: string, targetResourceType: string): Chain\n     );\n   }\n   const details = getSearchParameterDetails(resourceType, searchParam);\n-  return { resourceType, code, details, reverse: true };\n+  return { originType: targetResourceType, targetType: resourceType, code, details, direction: Direction.REVERSE };\n }\n \n function splitChainedSearch(chain: string): string[] {\n\ndiff --git a/packages/server/src/fhir/sql.ts b/packages/server/src/fhir/sql.ts\nindex e2662d6197..ddef222dd2 100644\n--- a/packages/server/src/fhir/sql.ts\n+++ b/packages/server/src/fhir/sql.ts\n@@ -635,8 +635,10 @@ export class SelectQuery extends BaseQuery implements Expression {\n \n   private buildColumns(sql: SqlBuilder): void {\n     if (this.columns.length === 0) {\n-      throw new Error('No columns selected');\n+      sql.append('1');\n+      return;\n     }\n+\n     let first = true;\n     for (const column of this.columns) {\n       if (!first) {\n",
    "test_patch": "diff --git a/packages/server/src/fhir/search.test.ts b/packages/server/src/fhir/search.test.ts\nindex ed9f897ccf..462d3c9aaf 100644\n--- a/packages/server/src/fhir/search.test.ts\n+++ b/packages/server/src/fhir/search.test.ts\n@@ -1867,6 +1867,99 @@ describe('FHIR Search', () => {\n         expect(result.entry?.[0]?.resource?.id).toStrictEqual(patient.id);\n       }));\n \n+    test('Chained search sort order', () =>\n+      withTestContext(async () => {\n+        config.chainedSearchWithReferenceTables = true;\n+\n+        const identifier = randomUUID();\n+        // Create linked resources\n+        const link1 = await repo.createResource<Patient>({\n+          resourceType: 'Patient',\n+          identifier: [{ value: identifier }],\n+        });\n+        const link2 = await repo.createResource<Patient>({\n+          resourceType: 'Patient',\n+          identifier: [{ value: identifier }],\n+        });\n+\n+        const patientIds: string[] = [];\n+        for (let i = 1; i < 10; i++) {\n+          const patient = await repo.createResource<Patient>({\n+            resourceType: 'Patient',\n+            birthDate: '1994-11-0' + i,\n+            link: [\n+              { type: 'seealso', other: createReference(link1) },\n+              { type: 'seealso', other: createReference(link2) },\n+            ],\n+          });\n+          patientIds.unshift(patient.id as string);\n+        }\n+\n+        const result = await repo.search(\n+          parseSearchRequest(`Patient?link:Patient.identifier=${identifier}&_sort=-birthdate`)\n+        );\n+        expect(result.entry?.map((e) => (e.resource as Patient).birthDate)).toEqual([\n+          '1994-11-09',\n+          '1994-11-08',\n+          '1994-11-07',\n+          '1994-11-06',\n+          '1994-11-05',\n+          '1994-11-04',\n+          '1994-11-03',\n+          '1994-11-02',\n+          '1994-11-01',\n+        ]);\n+        expect(result.entry?.map((e) => e.resource?.id)).toEqual(patientIds);\n+      }));\n+\n+    test('Chained search with negated filter', () =>\n+      withTestContext(async () => {\n+        config.chainedSearchWithReferenceTables = true;\n+\n+        // Create linked resources\n+        const link1 = await repo.createResource<Patient>({\n+          resourceType: 'Patient',\n+          identifier: [{ value: randomUUID() }],\n+        });\n+        const link2 = await repo.createResource<Patient>({\n+          resourceType: 'Patient',\n+          identifier: [{ value: randomUUID() }],\n+        });\n+\n+        const patientIds: string[] = [];\n+        for (let i = 1; i < 10; i++) {\n+          const middlePatient = await repo.createResource<Patient>({\n+            resourceType: 'Patient',\n+            link: [\n+              { type: 'seealso', other: createReference(link1) },\n+              { type: 'seealso', other: createReference(link2) },\n+            ],\n+          });\n+          const patient = await repo.createResource<Patient>({\n+            resourceType: 'Patient',\n+            birthDate: '1994-11-0' + i,\n+            link: [{ type: 'seealso', other: createReference(middlePatient) }],\n+          });\n+          patientIds.unshift(patient.id as string);\n+        }\n+\n+        const result = await repo.search(\n+          parseSearchRequest(`Patient?link:Patient.link:Patient.identifier:not=${randomUUID()}&_sort=-birthdate`)\n+        );\n+        expect(result.entry?.map((e) => (e.resource as Patient).birthDate)).toEqual([\n+          '1994-11-09',\n+          '1994-11-08',\n+          '1994-11-07',\n+          '1994-11-06',\n+          '1994-11-05',\n+          '1994-11-04',\n+          '1994-11-03',\n+          '1994-11-02',\n+          '1994-11-01',\n+        ]);\n+        expect(result.entry?.map((e) => e.resource?.id)).toEqual(patientIds);\n+      }));\n+\n     test.each([true, false])('Chained search on canonical reference', (ff) =>\n       withTestContext(async () => {\n         config.chainedSearchWithReferenceTables = ff;\n\ndiff --git a/packages/server/src/fhir/sql.test.ts b/packages/server/src/fhir/sql.test.ts\nindex 21ec57a735..578bd1aeef 100644\n--- a/packages/server/src/fhir/sql.test.ts\n+++ b/packages/server/src/fhir/sql.test.ts\n@@ -157,7 +157,8 @@ describe('SqlBuilder', () => {\n \n     test('Select missing columns', () => {\n       const sql = new SqlBuilder();\n-      expect(() => new SelectQuery('MyTable').buildSql(sql)).toThrow('No columns selected');\n+      new SelectQuery('MyTable').buildSql(sql);\n+      expect(sql.toString()).toEqual(`SELECT 1 FROM \"MyTable\"`);\n     });\n \n     test('periodToRangeString', () => {\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5506",
    "pr_id": 5506,
    "issue_id": 5502,
    "repo": "medplum/medplum",
    "problem_statement": "Fix `HGAutocompleteBotResponse` and related HealthGorilla search results when `result` is `undefined`\nWhen the HealthGorilla hooks / components were initially written, the server always returned `result` on the response from the HealthGorilla bot even when the `result` array was empty, but now we are always filtering out empty values and so the components expecting `result` to be there are hitting unhandled cases when there are no results for a search. ",
    "issue_word_count": 68,
    "test_files_count": 4,
    "non_test_files_count": 10,
    "pr_changed_files": [
      "packages/fhir-router/src/fhirrouter.ts",
      "packages/fhir-router/src/graphql/graphql.test.ts",
      "packages/fhir-router/src/graphql/graphql.ts",
      "packages/health-gorilla-react/src/autocomplete-endpoint.ts",
      "packages/server/src/admin/invite.ts",
      "packages/server/src/cloud/aws/execute.test.ts",
      "packages/server/src/fhir/binary.ts",
      "packages/server/src/fhir/job.test.ts",
      "packages/server/src/fhir/job.ts",
      "packages/server/src/fhir/operations/execute.test.ts",
      "packages/server/src/fhir/operations/execute.ts",
      "packages/server/src/fhir/outcomes.ts",
      "packages/server/src/fhir/response.ts",
      "packages/server/src/fhir/routes.ts"
    ],
    "pr_changed_test_files": [
      "packages/fhir-router/src/graphql/graphql.test.ts",
      "packages/server/src/cloud/aws/execute.test.ts",
      "packages/server/src/fhir/job.test.ts",
      "packages/server/src/fhir/operations/execute.test.ts"
    ],
    "base_commit": "6e1ba885d8c399282a5475d38ef3a9a097fd83ca",
    "head_commit": "732d1bfce844756746df006b34d0328313ce3002",
    "repo_url": "https://github.com/medplum/medplum/pull/5506",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5506",
    "dockerfile": "",
    "pr_merged_at": "2024-11-08T20:45:05.000Z",
    "patch": "diff --git a/packages/fhir-router/src/fhirrouter.ts b/packages/fhir-router/src/fhirrouter.ts\nindex bb0a25db0b..90837045e0 100644\n--- a/packages/fhir-router/src/fhirrouter.ts\n+++ b/packages/fhir-router/src/fhirrouter.ts\n@@ -43,7 +43,14 @@ export type FhirRequestConfig = {\n   transactions?: boolean;\n };\n \n-export type FhirResponse = [OperationOutcome] | [OperationOutcome, Resource];\n+export type FhirResponseOptions = {\n+  contentType?: string;\n+};\n+\n+export type FhirResponse =\n+  | [OperationOutcome]\n+  | [OperationOutcome, Resource]\n+  | [OperationOutcome, Resource, FhirResponseOptions];\n \n export type FhirRouteOptions = {\n   batch?: boolean;\n\ndiff --git a/packages/fhir-router/src/graphql/graphql.ts b/packages/fhir-router/src/graphql/graphql.ts\nindex ae2f110c43..5756a8331a 100644\n--- a/packages/fhir-router/src/graphql/graphql.ts\n+++ b/packages/fhir-router/src/graphql/graphql.ts\n@@ -1,6 +1,7 @@\n import {\n   allOk,\n   badRequest,\n+  ContentType,\n   DEFAULT_SEARCH_COUNT,\n   forbidden,\n   getResourceTypes,\n@@ -142,7 +143,7 @@ export async function graphqlHandler(\n     });\n   }\n \n-  return [allOk, result];\n+  return [allOk, result, { contentType: ContentType.JSON }];\n }\n \n /**\n\ndiff --git a/packages/health-gorilla-react/src/autocomplete-endpoint.ts b/packages/health-gorilla-react/src/autocomplete-endpoint.ts\nindex e595e4f883..498bd5e2cc 100644\n--- a/packages/health-gorilla-react/src/autocomplete-endpoint.ts\n+++ b/packages/health-gorilla-react/src/autocomplete-endpoint.ts\n@@ -1,4 +1,4 @@\n-import { MedplumClient, isCoding, isResource } from '@medplum/core';\n+import { ContentType, MedplumClient, isCoding, isResource } from '@medplum/core';\n import { Identifier, Questionnaire } from '@medplum/fhirtypes';\n import { HGAutocompleteBotResponse, LabOrganization, TestCoding } from '@medplum/health-gorilla-core';\n \n@@ -22,7 +22,7 @@ export function getAutocompleteSearchFunction(\n   autocompleteBot: string | Identifier\n ): HGSearchFunction {\n   return async (params) => {\n-    const botResponse: HGAutocompleteBotResponse = await medplum.executeBot(autocompleteBot, params);\n+    const botResponse: HGAutocompleteBotResponse = await medplum.executeBot(autocompleteBot, params, ContentType.JSON);\n     if (botResponse.type === 'error') {\n       throw new Error('Error executing autocomplete bot', { cause: botResponse });\n     }\n\ndiff --git a/packages/server/src/admin/invite.ts b/packages/server/src/admin/invite.ts\nindex a958183d69..a7c9adf82b 100644\n--- a/packages/server/src/admin/invite.ts\n+++ b/packages/server/src/admin/invite.ts\n@@ -21,7 +21,7 @@ import { getConfig } from '../config';\n import { getAuthenticatedContext, getLogger } from '../context';\n import { sendEmail } from '../email/email';\n import { getSystemRepo, Repository } from '../fhir/repo';\n-import { sendResponse } from '../fhir/response';\n+import { sendFhirResponse } from '../fhir/response';\n import { generateSecret } from '../oauth/keys';\n import { getUserByEmailInProject, getUserByEmailWithoutProject } from '../oauth/utils';\n import { makeValidationMiddleware } from '../util/validator';\n@@ -52,7 +52,7 @@ export async function inviteHandler(req: Request, res: Response): Promise<void>\n   }\n \n   const { membership } = await inviteUser(inviteRequest);\n-  return sendResponse(req, res, allOk, membership);\n+  return sendFhirResponse(req, res, allOk, membership);\n }\n \n export interface ServerInviteRequest extends InviteRequest {\n\ndiff --git a/packages/server/src/fhir/binary.ts b/packages/server/src/fhir/binary.ts\nindex a510c55fef..9cf6cfb01f 100644\n--- a/packages/server/src/fhir/binary.ts\n+++ b/packages/server/src/fhir/binary.ts\n@@ -7,7 +7,7 @@ import { asyncWrap } from '../async';\n import { getAuthenticatedContext, getLogger } from '../context';\n import { authenticateRequest } from '../oauth/middleware';\n import { sendOutcome } from './outcomes';\n-import { sendResponse } from './response';\n+import { sendFhirResponse } from './response';\n import { BinarySource, getBinaryStorage } from './storage';\n import { Repository } from './repo';\n \n@@ -28,7 +28,7 @@ binaryRouter.get(\n     const ctx = getAuthenticatedContext();\n     const { id } = req.params;\n     const binary = await ctx.repo.readResource<Binary>('Binary', id);\n-    await sendResponse(req, res, allOk, binary);\n+    await sendFhirResponse(req, res, allOk, binary);\n   })\n );\n \n@@ -71,7 +71,7 @@ async function handleBinaryWriteRequest(req: Request, res: Response): Promise<vo\n       // \"\"\"\n       const resource = body as Binary;\n       const binary = await (create ? repo.createResource<Binary>(resource) : repo.updateResource<Binary>(resource));\n-      await sendResponse(req, res, create ? created : allOk, binary);\n+      await sendFhirResponse(req, res, create ? created : allOk, binary);\n       return;\n     }\n   }\n@@ -83,7 +83,7 @@ async function handleBinaryWriteRequest(req: Request, res: Response): Promise<vo\n     securityContext: req.get('X-Security-Context'),\n   });\n \n-  await sendResponse(req, res, create ? created : allOk, binary);\n+  await sendFhirResponse(req, res, create ? created : allOk, binary);\n }\n \n /**\n\ndiff --git a/packages/server/src/fhir/job.ts b/packages/server/src/fhir/job.ts\nindex a8ecebacc9..5d14e76dec 100644\n--- a/packages/server/src/fhir/job.ts\n+++ b/packages/server/src/fhir/job.ts\n@@ -1,9 +1,11 @@\n-import { allOk } from '@medplum/core';\n-import { AsyncJob } from '@medplum/fhirtypes';\n+import { accepted, allOk } from '@medplum/core';\n+import { AsyncJob, OperationOutcome } from '@medplum/fhirtypes';\n import { Request, Response, Router } from 'express';\n import { asyncWrap } from '../async';\n+import { getConfig } from '../config';\n import { getAuthenticatedContext } from '../context';\n-import { sendResponse } from './response';\n+import { AsyncJobExecutor } from './operations/utils/asyncjobexecutor';\n+import { sendFhirResponse } from './response';\n \n // Asychronous Job Status API\n // https://hl7.org/fhir/async-bundle.html\n@@ -19,12 +21,15 @@ jobRouter.get(\n     const { id } = req.params;\n     const asyncJob = await ctx.repo.readResource<AsyncJob>('AsyncJob', id);\n \n+    let outcome: OperationOutcome;\n     if (!finalJobStatusCodes.includes(asyncJob.status as string)) {\n-      res.status(202).send(asyncJob).end();\n-      return;\n+      const exec = new AsyncJobExecutor(ctx.repo, asyncJob);\n+      outcome = accepted(exec.getContentLocation(getConfig().baseUrl));\n+    } else {\n+      outcome = allOk;\n     }\n \n-    await sendResponse(req, res, allOk, asyncJob);\n+    return sendFhirResponse(req, res, outcome, asyncJob);\n   })\n );\n \n\ndiff --git a/packages/server/src/fhir/operations/execute.ts b/packages/server/src/fhir/operations/execute.ts\nindex 8d58871c47..e3dff8fa46 100644\n--- a/packages/server/src/fhir/operations/execute.ts\n+++ b/packages/server/src/fhir/operations/execute.ts\n@@ -47,12 +47,10 @@ import { readStreamToString } from '../../util/streams';\n import { createAuditEventEntities, findProjectMembership } from '../../workers/utils';\n import { sendOutcome } from '../outcomes';\n import { getSystemRepo, Repository } from '../repo';\n-import { sendResponse } from '../response';\n+import { sendFhirResponse } from '../response';\n import { getBinaryStorage } from '../storage';\n import { sendAsyncResponse } from './utils/asyncjobexecutor';\n \n-export const EXECUTE_CONTENT_TYPES = [ContentType.JSON, ContentType.FHIR_JSON, ContentType.TEXT, ContentType.HL7_V2];\n-\n export interface BotExecutionRequest {\n   readonly bot: Bot;\n   readonly runAs: ProjectMembership;\n@@ -105,7 +103,7 @@ export const executeHandler = asyncWrap(async (req: Request, res: Response) => {\n     const outcome = result.success ? allOk : badRequest(result.logResult);\n \n     if (isResource(responseBody) && responseBody.resourceType === 'Binary') {\n-      await sendResponse(req, res, outcome, responseBody);\n+      await sendFhirResponse(req, res, outcome, responseBody);\n       return;\n     }\n \n@@ -534,14 +532,16 @@ async function addBotSecrets(\n   }\n }\n \n+const MIRRORED_CONTENT_TYPES: string[] = [ContentType.TEXT, ContentType.HL7_V2];\n+\n function getResponseContentType(req: Request): string {\n   const requestContentType = req.get('Content-Type');\n-  if (requestContentType && (EXECUTE_CONTENT_TYPES as string[]).includes(requestContentType)) {\n+  if (requestContentType && MIRRORED_CONTENT_TYPES.includes(requestContentType)) {\n     return requestContentType;\n   }\n \n-  // Default to FHIR\n-  return ContentType.FHIR_JSON;\n+  // Default to JSON\n+  return ContentType.JSON;\n }\n \n /**\n\ndiff --git a/packages/server/src/fhir/outcomes.ts b/packages/server/src/fhir/outcomes.ts\nindex b5f4d21acb..d6e7b14761 100644\n--- a/packages/server/src/fhir/outcomes.ts\n+++ b/packages/server/src/fhir/outcomes.ts\n@@ -1,4 +1,4 @@\n-import { getStatus, isAccepted } from '@medplum/core';\n+import { ContentType, getStatus, isAccepted } from '@medplum/core';\n import { OperationOutcome } from '@medplum/fhirtypes';\n import { Response } from 'express';\n import { Result, ValidationError } from 'express-validator';\n@@ -38,8 +38,11 @@ export function sendOutcome(res: Response, outcome: OperationOutcome): Response\n   if (isAccepted(outcome) && outcome.issue?.[0].diagnostics) {\n     res.set('Content-Location', outcome.issue[0].diagnostics);\n   }\n-  return res.status(getStatus(outcome)).json({\n-    ...outcome,\n-    extension: buildTracingExtension(),\n-  } as OperationOutcome);\n+  return res\n+    .status(getStatus(outcome))\n+    .type(ContentType.FHIR_JSON)\n+    .json({\n+      ...outcome,\n+      extension: buildTracingExtension(),\n+    } as OperationOutcome);\n }\n\ndiff --git a/packages/server/src/fhir/response.ts b/packages/server/src/fhir/response.ts\nindex c6699686ca..6d5ae2caca 100644\n--- a/packages/server/src/fhir/response.ts\n+++ b/packages/server/src/fhir/response.ts\n@@ -1,10 +1,11 @@\n-import { ContentType, concatUrls, getStatus, isCreated, isResource } from '@medplum/core';\n+import { ContentType, concatUrls, getStatus, isCreated } from '@medplum/core';\n import { OperationOutcome, Resource } from '@medplum/fhirtypes';\n import { Request, Response } from 'express';\n import { getConfig } from '../config';\n import { getAuthenticatedContext } from '../context';\n import { RewriteMode, rewriteAttachments } from './rewrite';\n import { getBinaryStorage } from './storage';\n+import { FhirResponseOptions } from '@medplum/fhir-router';\n \n export function isFhirJsonContentType(req: Request): boolean {\n   return !!(req.is(ContentType.JSON) || req.is(ContentType.FHIR_JSON));\n@@ -28,43 +29,32 @@ export function sendResponseHeaders(_req: Request, res: Response, outcome: Opera\n   res.status(getStatus(outcome));\n }\n \n-export async function sendResponse(\n+export async function sendFhirResponse(\n   req: Request,\n   res: Response,\n   outcome: OperationOutcome,\n-  body: Resource\n+  body: Resource,\n+  options?: FhirResponseOptions\n ): Promise<void> {\n-  const isBodyResource = isResource(body);\n-\n-  if (isBodyResource) {\n-    sendResponseHeaders(req, res, outcome, body);\n-    const acceptHeader = req.get('Accept');\n-    if (body.resourceType === 'Binary' && req.method === 'GET' && !acceptHeader?.startsWith(ContentType.FHIR_JSON)) {\n-      // When the read request has some other type in the Accept header,\n-      // then the content should be returned with the content type stated in the resource in the Content-Type header.\n-      // E.g. if the content type in the resource is \"application/pdf\", then the content should be returned as a PDF directly.\n-      res.contentType(body.contentType as string);\n-      if (body.data) {\n-        res.send(Buffer.from(body.data, 'base64'));\n-      } else {\n-        const stream = await getBinaryStorage().readBinary(body);\n-        stream.pipe(res);\n-      }\n-      return;\n+  sendResponseHeaders(req, res, outcome, body);\n+\n+  if (body.resourceType === 'Binary' && req.method === 'GET' && !req.get('Accept')?.startsWith(ContentType.FHIR_JSON)) {\n+    // When the read request has some other type in the Accept header,\n+    // then the content should be returned with the content type stated in the resource in the Content-Type header.\n+    // E.g. if the content type in the resource is \"application/pdf\", then the content should be returned as a PDF directly.\n+    res.contentType(body.contentType as string);\n+    if (body.data) {\n+      res.send(Buffer.from(body.data, 'base64'));\n+    } else {\n+      const stream = await getBinaryStorage().readBinary(body);\n+      stream.pipe(res);\n     }\n-    res.set('Content-Type', ContentType.FHIR_JSON);\n+    return;\n   }\n \n-  // Even if the body is not a resource, we still rewriteAttachments to ensure attachment URLs are correct\n-  // e.g. within a graphql response\n   const ctx = getAuthenticatedContext();\n   const result = await rewriteAttachments(RewriteMode.PRESIGNED_URL, ctx.repo, body);\n \n-  if (!isBodyResource) {\n-    res.set('Content-Type', ContentType.JSON);\n-    res.send(JSON.stringify(result));\n-    return;\n-  }\n-\n+  res.set('Content-Type', options?.contentType ?? ContentType.FHIR_JSON);\n   res.json(result);\n }\n\ndiff --git a/packages/server/src/fhir/routes.ts b/packages/server/src/fhir/routes.ts\nindex 8ab58bc878..81a761b856 100644\n--- a/packages/server/src/fhir/routes.ts\n+++ b/packages/server/src/fhir/routes.ts\n@@ -40,7 +40,7 @@ import { codeSystemSubsumesOperation } from './operations/subsumes';\n import { valueSetValidateOperation } from './operations/valuesetvalidatecode';\n import { sendOutcome } from './outcomes';\n import { ResendSubscriptionsOptions } from './repo';\n-import { sendResponse } from './response';\n+import { sendFhirResponse } from './response';\n import { smartConfigurationHandler, smartStylingHandler } from './smart';\n \n export const fhirRouter = Router();\n@@ -66,28 +66,30 @@ fhirRouter.use((req: Request, res: Response, next: NextFunction) => {\n       return res.send();\n     }\n \n-    // Unless already set, use the FHIR content type\n     if (!res.get('Content-Type')) {\n-      res.contentType(ContentType.FHIR_JSON);\n-    }\n-\n-    let legacyFhirJsonResponseFormat: boolean | undefined;\n-    try {\n-      const ctx = getAuthenticatedContext();\n-      legacyFhirJsonResponseFormat = ctx.project.systemSetting?.find(\n-        (s) => s.name === 'legacyFhirJsonResponseFormat'\n-      )?.valueBoolean;\n-    } catch (_err) {\n-      // Ignore errors since unauthenticated requests also use this middleware\n+      res.contentType(ContentType.JSON);\n     }\n \n     const pretty = req.query._pretty === 'true';\n \n-    if (legacyFhirJsonResponseFormat) {\n-      return res.send(JSON.stringify(data, undefined, pretty ? 2 : undefined));\n-    } else {\n-      return res.send(stringify(data, pretty));\n+    if (res.get('Content-Type')?.startsWith(ContentType.FHIR_JSON)) {\n+      let legacyFhirJsonResponseFormat: boolean | undefined;\n+      try {\n+        const ctx = getAuthenticatedContext();\n+        legacyFhirJsonResponseFormat = ctx.project.systemSetting?.find(\n+          (s) => s.name === 'legacyFhirJsonResponseFormat'\n+        )?.valueBoolean;\n+      } catch (_err) {\n+        // Ignore errors since unauthenticated requests also use this middleware\n+      }\n+\n+      if (!legacyFhirJsonResponseFormat) {\n+        return res.send(stringify(data, pretty));\n+      }\n     }\n+\n+    // Default JSON response\n+    return res.send(JSON.stringify(data, undefined, pretty ? 2 : undefined));\n   };\n   next();\n });\n@@ -341,8 +343,9 @@ protectedRoutes.use(\n         throw new OperationOutcomeError(result[0]);\n       }\n       sendOutcome(res, result[0]);\n-    } else {\n-      await sendResponse(req, res, result[0], result[1]);\n+      return;\n     }\n+\n+    await sendFhirResponse(req, res, result[0], result[1], result[2]);\n   })\n );\n",
    "test_patch": "diff --git a/packages/fhir-router/src/graphql/graphql.test.ts b/packages/fhir-router/src/graphql/graphql.test.ts\nindex 6620b0f01e..d01642f7f5 100644\n--- a/packages/fhir-router/src/graphql/graphql.test.ts\n+++ b/packages/fhir-router/src/graphql/graphql.test.ts\n@@ -170,14 +170,14 @@ describe('GraphQL', () => {\n     });\n     const fhirRouter = new FhirRouter();\n     const result = await graphqlHandler(request, repo, fhirRouter);\n-    expect(result).toBeDefined();\n-    expect(result.length).toBe(2);\n+    expect(result?.length).toBe(3);\n     expect(result[0]).toMatchObject(allOk);\n \n     const data = (result[1] as any).data;\n     expect(data.Patient).toBeDefined();\n     expect(data.Patient.id).toEqual(patient.id);\n     expect(data.Patient.photo[0].url).toBeDefined();\n+    expect(result[2]?.contentType).toBe('application/json');\n   });\n \n   test('Read by ID not found', async () => {\n@@ -345,8 +345,7 @@ describe('GraphQL', () => {\n \n     const fhirRouter = new FhirRouter();\n     const result = await graphqlHandler(request, repo, fhirRouter);\n-    expect(result).toBeDefined();\n-    expect(result.length).toBe(2);\n+    expect(result?.length).toBe(3);\n     expect(result[0]).toMatchObject(allOk);\n \n     const data = (result[1] as any).data;\n@@ -354,6 +353,8 @@ describe('GraphQL', () => {\n     expect(data.Encounter.subject.resource).toBeDefined();\n     expect(data.Encounter.subject.resource.id).toEqual(patient.id);\n     expect(data.Encounter.subject.resource.name[0].given[0]).toEqual('Alice');\n+\n+    expect(result[2]?.contentType).toBe('application/json');\n   });\n \n   test('Read resource by reference not found', async () => {\n@@ -1042,6 +1043,7 @@ describe('GraphQL', () => {\n           PatientCreate: null,\n         },\n       },\n+      { contentType: 'application/json' },\n     ]);\n   });\n \n@@ -1147,6 +1149,7 @@ describe('GraphQL', () => {\n           PatientUpdate: null,\n         },\n       },\n+      { contentType: 'application/json' },\n     ]);\n   });\n \n@@ -1189,6 +1192,7 @@ describe('GraphQL', () => {\n           PatientUpdate: null,\n         },\n       },\n+      { contentType: 'application/json' },\n     ]);\n   });\n \n@@ -1270,7 +1274,7 @@ describe('GraphQL', () => {\n     const fhirRouter = new FhirRouter();\n     const result = await graphqlHandler(request, repo, fhirRouter);\n     expect(result).toBeDefined();\n-    expect(result.length).toBe(2);\n+    expect(result.length).toBe(3);\n     expect(result[0]).toMatchObject(allOk);\n \n     const data = (result[1] as any).data;\n@@ -1278,5 +1282,7 @@ describe('GraphQL', () => {\n     expect(data.Encounter.subject.resource).toBeDefined();\n     expect(data.Encounter.subject.resource.id).toEqual(patient.id);\n     expect(data.Encounter.subject.resource.name[0].given[0]).toEqual('Alice');\n+\n+    expect(result[2]?.contentType).toBe('application/json');\n   });\n });\n\ndiff --git a/packages/server/src/cloud/aws/execute.test.ts b/packages/server/src/cloud/aws/execute.test.ts\nindex 912321a1f3..dc7fed2546 100644\n--- a/packages/server/src/cloud/aws/execute.test.ts\n+++ b/packages/server/src/cloud/aws/execute.test.ts\n@@ -96,7 +96,7 @@ describe('Execute', () => {\n         name: [{ given: ['John'], family: ['Doe'] }],\n       });\n     expect(res.status).toBe(200);\n-    expect(res.headers['content-type']).toBe('application/fhir+json; charset=utf-8');\n+    expect(res.headers['content-type']).toBe('application/json; charset=utf-8');\n   });\n \n   test('Submit FHIR without content type', async () => {\n\ndiff --git a/packages/server/src/fhir/job.test.ts b/packages/server/src/fhir/job.test.ts\nindex 0fd583ccb4..12c2c63794 100644\n--- a/packages/server/src/fhir/job.test.ts\n+++ b/packages/server/src/fhir/job.test.ts\n@@ -42,11 +42,13 @@ describe('Job status', () => {\n         .set('Authorization', 'Bearer ' + accessToken);\n \n       expect(res.status).toBe(202);\n+      expect(res.get('Content-Type')).toEqual('application/fhir+json; charset=utf-8');\n+      expect(res.body).toEqual(expect.objectContaining({ id: job.id, request: job.request, status: 'accepted' }));\n     }));\n \n   test('completed', () =>\n     withTestContext(async () => {\n-      await asyncJobManager.init('http://example.com');\n+      const job = await asyncJobManager.init('http://example.com');\n       const callback = jest.fn();\n \n       await asyncJobManager.start(async () => {\n@@ -56,6 +58,14 @@ describe('Job status', () => {\n       expect(callback).toHaveBeenCalled();\n \n       await waitForAsyncJob(asyncJobManager.getContentLocation('http://example.com/'), app, accessToken);\n+\n+      const res = await request(app)\n+        .get(`/fhir/R4/job/${job.id}/status`)\n+        .set('Authorization', 'Bearer ' + accessToken);\n+\n+      expect(res.status).toBe(200);\n+      expect(res.get('Content-Type')).toEqual('application/fhir+json; charset=utf-8');\n+      expect(res.body).toEqual(expect.objectContaining({ id: job.id, request: job.request, status: 'completed' }));\n     }));\n \n   test('cancel', () =>\n@@ -67,5 +77,7 @@ describe('Job status', () => {\n         .set('Authorization', 'Bearer ' + accessToken);\n \n       expect(res.status).toBe(202);\n+      expect(res.get('Content-Type')).toEqual('text/plain; charset=utf-8');\n+      expect(res.body).toEqual({});\n     }));\n });\n\ndiff --git a/packages/server/src/fhir/operations/execute.test.ts b/packages/server/src/fhir/operations/execute.test.ts\nindex 6a0887064b..5946316c38 100644\n--- a/packages/server/src/fhir/operations/execute.test.ts\n+++ b/packages/server/src/fhir/operations/execute.test.ts\n@@ -1,4 +1,4 @@\n-import { ContentType, Operator, allOk, badRequest, createReference, getReferenceString } from '@medplum/core';\n+import { ContentType, Operator, badRequest, createReference, getReferenceString } from '@medplum/core';\n import {\n   AsyncJob,\n   AuditEvent,\n@@ -150,7 +150,7 @@ exports.handler = async function (medplum, event) {\n     expect(res.text).toEqual('input');\n   });\n \n-  test('Submit FHIR with content type', async () => {\n+  test('Submit FHIR with content type returns non-FHIR JSON', async () => {\n     const res = await request(app)\n       .post(`/fhir/R4/Bot/${bots[0].id}/$execute`)\n       .set('Content-Type', ContentType.FHIR_JSON)\n@@ -158,21 +158,36 @@ exports.handler = async function (medplum, event) {\n       .send({\n         resourceType: 'Patient',\n         name: [{ given: ['John'], family: ['Doe'] }],\n+        identifier: [],\n       });\n     expect(res.status).toBe(200);\n-    expect(res.headers['content-type']).toBe('application/fhir+json; charset=utf-8');\n+    expect(res.headers['content-type']).toBe('application/json; charset=utf-8');\n+    expect(res.body.identifier).toEqual([]);\n   });\n \n-  test('Submit FHIR without content type', async () => {\n+  test('Submit FHIR without content type return JSON content', async () => {\n     const res = await request(app)\n       .post(`/fhir/R4/Bot/${bots[0].id}/$execute`)\n       .set('Authorization', 'Bearer ' + accessToken)\n       .send({\n         resourceType: 'Patient',\n         name: [{ given: ['John'], family: ['Doe'] }],\n+        identifier: [],\n       });\n     expect(res.status).toBe(200);\n     expect(res.headers['content-type']).toBe('application/json; charset=utf-8');\n+    expect(res.body.identifier).toEqual([]);\n+  });\n+\n+  test('Return non-Resource JSON response', async () => {\n+    const input = { type: 'not-a-resource', result: [] };\n+    const res = await request(app)\n+      .post(`/fhir/R4/Bot/${bots[0].id}/$execute`)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send(JSON.parse(JSON.stringify(input)));\n+    expect(res.status).toBe(200);\n+    expect(res.headers['content-type']).toBe('application/json; charset=utf-8');\n+    expect(res.body).toEqual({ type: 'not-a-resource', result: [] });\n   });\n \n   test('Submit HL7', async () => {\n@@ -434,13 +449,12 @@ exports.handler = async function (medplum, event) {\n \n   test('OperationOutcome response', async () => {\n     const res = await request(app)\n-      .post(`/fhir/R4/Bot/${bots[0].id}/$execute`)\n-      .set('Content-Type', ContentType.FHIR_JSON)\n+      .post(`/fhir/R4/Bot/$execute?identifier=invalid-identifier`)\n       .set('Authorization', 'Bearer ' + accessToken)\n-      .send(allOk);\n-    expect(res.status).toBe(200);\n+      .send('');\n+    expect(res.status).toBe(400);\n     expect(res.headers['content-type']).toBe('application/fhir+json; charset=utf-8');\n-    expect(res.body).toMatchObject(allOk);\n+    expect(res.body).toMatchObject(badRequest('Must specify bot ID or identifier.'));\n   });\n \n   test('Binary response', async () => {\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5476",
    "pr_id": 5476,
    "issue_id": 5329,
    "repo": "medplum/medplum",
    "problem_statement": "Harden Agent reconnect logic\nWe have some reconnect logic for Medplum Agent and we have a heartbeat protocol for the Agent WebSocket connection but currently the heartbeat being missed does not trigger a reconnect, only a full close of the WebSocket does. We could stitch those two mechanics together to harden the Agent reconnect logic",
    "issue_word_count": 55,
    "test_files_count": 1,
    "non_test_files_count": 2,
    "pr_changed_files": [
      "packages/agent/src/app.test.ts",
      "packages/agent/src/app.ts",
      "packages/core/src/websockets/reconnecting-websocket.ts"
    ],
    "pr_changed_test_files": [
      "packages/agent/src/app.test.ts"
    ],
    "base_commit": "825c965e39668c9a10bd6b85aad5ab1fe31fb512",
    "head_commit": "b1553c158daef7992f106678e7d1e1ad0867c45c",
    "repo_url": "https://github.com/medplum/medplum/pull/5476",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5476",
    "dockerfile": "",
    "pr_merged_at": "2024-11-08T18:13:06.000Z",
    "patch": "diff --git a/packages/agent/src/app.ts b/packages/agent/src/app.ts\nindex cb3269ff95..09f7d9532b 100644\n--- a/packages/agent/src/app.ts\n+++ b/packages/agent/src/app.ts\n@@ -12,6 +12,7 @@ import {\n   Logger,\n   MEDPLUM_VERSION,\n   MedplumClient,\n+  ReconnectingWebSocket,\n   checkIfValidMedplumVersion,\n   fetchLatestVersionString,\n   isValidHostname,\n@@ -44,6 +45,7 @@ async function execAsync(command: string, options: ExecOptions): Promise<{ stdou\n }\n \n export const DEFAULT_PING_TIMEOUT = 3600;\n+export const MAX_MISSED_HEARTBEATS = 1;\n \n export class App {\n   static instance: App;\n@@ -54,8 +56,8 @@ export class App {\n   readonly hl7Clients = new Map<string, Hl7Client>();\n   heartbeatPeriod = 10 * 1000;\n   private heartbeatTimer?: NodeJS.Timeout;\n-  private reconnectTimer?: NodeJS.Timeout;\n-  private webSocket?: WebSocket;\n+  private outstandingHeartbeats = 0;\n+  private webSocket?: ReconnectingWebSocket<WebSocket>;\n   private webSocketWorker?: Promise<void>;\n   private live = false;\n   private shutdown = false;\n@@ -132,36 +134,41 @@ export class App {\n   }\n \n   private async heartbeat(): Promise<void> {\n-    if (!(this.webSocket || this.reconnectTimer)) {\n+    if (!this.webSocket) {\n       this.log.warn('WebSocket not connected');\n       this.connectWebSocket().catch(this.log.error);\n       return;\n     }\n \n-    if (this.webSocket && this.live) {\n+    if (this.live) {\n+      if (this.outstandingHeartbeats > MAX_MISSED_HEARTBEATS) {\n+        this.outstandingHeartbeats = 0;\n+        this.webSocket.reconnect();\n+        this.log.info('Disconnected from Medplum server. Attempting to reconnect...');\n+        return;\n+      }\n+      this.outstandingHeartbeats += 1;\n       await this.sendToWebSocket({ type: 'agent:heartbeat:request' });\n     }\n   }\n \n   private async connectWebSocket(): Promise<void> {\n-    if (this.reconnectTimer) {\n-      clearTimeout(this.reconnectTimer);\n-      this.reconnectTimer = undefined;\n-    }\n-\n     const webSocketUrl = new URL(this.medplum.getBaseUrl());\n     webSocketUrl.protocol = webSocketUrl.protocol === 'https:' ? 'wss:' : 'ws:';\n     webSocketUrl.pathname = '/ws/agent';\n     this.log.info(`Connecting to WebSocket: ${webSocketUrl.href}`);\n \n-    this.webSocket = new WebSocket(webSocketUrl);\n-    this.webSocket.binaryType = 'nodebuffer';\n+    this.webSocket = new ReconnectingWebSocket<WebSocket>(webSocketUrl.toString(), undefined, {\n+      WebSocket,\n+      binaryType: 'nodebuffer',\n+    });\n \n-    this.webSocket.addEventListener('error', (err) => {\n+    this.webSocket.addEventListener('error', () => {\n       if (!this.shutdown) {\n         // This event is only fired when WebSocket closes due to some kind of error\n         // https://developer.mozilla.org/en-US/docs/Web/API/WebSocket/error_event\n-        this.log.error(`WebSocket closed due to an error: ${normalizeErrorString(err)}`);\n+        // The error event seems to never contain an actual error though\n+        this.log.error('WebSocket closed due to an error');\n       }\n     });\n \n@@ -174,11 +181,9 @@ export class App {\n     });\n \n     this.webSocket.addEventListener('close', () => {\n-      if (!this.shutdown) {\n-        this.webSocket = undefined;\n+      if (!this.shutdown && this.live) {\n         this.live = false;\n         this.log.info('WebSocket closed');\n-        this.reconnectTimer = setTimeout(() => this.connectWebSocket(), 1000);\n       }\n     });\n \n@@ -194,12 +199,14 @@ export class App {\n           case 'agent:connect:response':\n             this.live = true;\n             this.startWebSocketWorker();\n+            this.log.info('Successfully connected to Medplum server');\n             break;\n           case 'agent:heartbeat:request':\n+            this.outstandingHeartbeats = 0;\n             await this.sendToWebSocket({ type: 'agent:heartbeat:response', version: MEDPLUM_VERSION });\n             break;\n           case 'agent:heartbeat:response':\n-            // Do nothing\n+            this.outstandingHeartbeats = 0;\n             break;\n           // @ts-expect-error - Deprecated message type\n           case 'transmit':\n@@ -432,11 +439,6 @@ export class App {\n       this.heartbeatTimer = undefined;\n     }\n \n-    if (this.reconnectTimer) {\n-      clearTimeout(this.reconnectTimer);\n-      this.reconnectTimer = undefined;\n-    }\n-\n     if (this.webSocket) {\n       this.webSocket.close();\n       this.webSocket = undefined;\n\ndiff --git a/packages/core/src/websockets/reconnecting-websocket.ts b/packages/core/src/websockets/reconnecting-websocket.ts\nindex ca476edabe..7372d35fed 100644\n--- a/packages/core/src/websockets/reconnecting-websocket.ts\n+++ b/packages/core/src/websockets/reconnecting-websocket.ts\n@@ -39,6 +39,70 @@ export type WebSocketEventMap = {\n   open: Event;\n };\n \n+/**\n+ * This map exists separately from `WebSocketEventMap`, which is the actual event map used for the `ReconnectingWebSocket` class itself,\n+ * due to slight difference in the type between the events as we use them, and the events as they exist as global interfaces. We need the global interfaces\n+ * to be generic enough to satisfy conformant implementations that don't exactly match the events we export and use in `ReconnectingWebSocket` itself.\n+ */\n+export type IWebSocketEventMap = {\n+  close: globalThis.CloseEvent;\n+  error: globalThis.ErrorEvent;\n+  message: globalThis.MessageEvent;\n+  open: Event;\n+};\n+\n+/**\n+ * Generic interface that an implementation of `WebSocket` must satisfy to be used with `ReconnectingWebSocket`.\n+ * This is a slightly modified fork of the `WebSocket` global type used in Node.\n+ *\n+ * The main key difference is making all the `onclose`, `onerror`, etc. functions have `any[]` args, making `data` in `send()` of type `any`, and making `binaryType` of type string,\n+ * though the particular implementation should narrow each of these implementation-specific types.\n+ */\n+export interface IWebSocket {\n+  binaryType: string;\n+\n+  readonly bufferedAmount: number;\n+  readonly extensions: string;\n+\n+  onclose: ((...args: any[]) => any) | null;\n+  onerror: ((...args: any[]) => any) | null;\n+  onmessage: ((...args: any[]) => any) | null;\n+  onopen: ((...args: any[]) => any) | null;\n+\n+  readonly protocol: string;\n+  readonly readyState: number;\n+  readonly url: string;\n+\n+  close(code?: number, reason?: string): void;\n+  send(data: any): void;\n+\n+  readonly CLOSED: number;\n+  readonly CLOSING: number;\n+  readonly CONNECTING: number;\n+  readonly OPEN: number;\n+\n+  addEventListener<K extends keyof WebSocketEventMap>(\n+    type: K,\n+    listener: (ev: WebSocketEventMap[K]) => any,\n+    options?: boolean | AddEventListenerOptions\n+  ): void;\n+  addEventListener(\n+    type: string,\n+    listener: EventListenerOrEventListenerObject,\n+    options?: boolean | AddEventListenerOptions\n+  ): void;\n+  removeEventListener<K extends keyof WebSocketEventMap>(\n+    type: K,\n+    listener: (ev: WebSocketEventMap[K]) => any,\n+    options?: boolean | EventListenerOptions\n+  ): void;\n+  removeEventListener(\n+    type: string,\n+    listener: EventListenerOrEventListenerObject,\n+    options?: boolean | EventListenerOptions\n+  ): void;\n+}\n+\n const Events = {\n   Event: (typeof globalThis.Event !== 'undefined' ? globalThis.Event : undefined) as\n     | typeof globalThis.Event\n@@ -89,8 +153,9 @@ function cloneEvent(e: Event): Event {\n   return new (e as any).constructor(e.type, e);\n }\n \n-export type Options = {\n+export type Options<WS extends IWebSocket = WebSocket> = {\n   WebSocket?: any;\n+  binaryType?: WS['binaryType'];\n   maxReconnectionDelay?: number;\n   minReconnectionDelay?: number;\n   reconnectionDelayGrowFactor?: number;\n@@ -121,14 +186,17 @@ export type Message = string | ArrayBuffer | Blob | ArrayBufferView;\n \n let didWarnAboutMissingWebSocket = false;\n \n-export class ReconnectingWebSocket extends TypedEventTarget<WebSocketEventMap> implements IReconnectingWebSocket {\n-  private _ws: WebSocket | undefined;\n+export class ReconnectingWebSocket<WS extends IWebSocket = WebSocket>\n+  extends TypedEventTarget<WebSocketEventMap>\n+  implements IReconnectingWebSocket\n+{\n+  private _ws: IWebSocket | undefined;\n   private _retryCount = -1;\n   private _uptimeTimeout: ReturnType<typeof setTimeout> | undefined;\n   private _connectTimeout: ReturnType<typeof setTimeout> | undefined;\n   private _shouldReconnect = true;\n   private _connectLock = false;\n-  private _binaryType: BinaryType = 'blob';\n+  private _binaryType: WS['binaryType'];\n   private _closeCalled = false;\n   private _messageQueue: Message[] = [];\n \n@@ -136,9 +204,9 @@ export class ReconnectingWebSocket extends TypedEventTarget<WebSocketEventMap> i\n \n   protected _url: string;\n   protected _protocols?: ProtocolsProvider;\n-  protected _options: Options;\n+  protected _options: Options<WS>;\n \n-  constructor(url: string, protocols?: ProtocolsProvider, options: Options = {}) {\n+  constructor(url: string, protocols?: ProtocolsProvider, options: Options<WS> = {}) {\n     // Initialize all events if they haven't been created yet\n     if (!eventsInitialized) {\n       lazyInitEvents();\n@@ -152,6 +220,11 @@ export class ReconnectingWebSocket extends TypedEventTarget<WebSocketEventMap> i\n     if (this._options.startClosed) {\n       this._shouldReconnect = false;\n     }\n+    if (this._options.binaryType) {\n+      this._binaryType = this._options.binaryType;\n+    } else {\n+      this._binaryType = 'blob';\n+    }\n     if (this._options.debugLogger) {\n       this._debugLogger = this._options.debugLogger;\n     }\n@@ -184,11 +257,11 @@ export class ReconnectingWebSocket extends TypedEventTarget<WebSocketEventMap> i\n     return ReconnectingWebSocket.CLOSED;\n   }\n \n-  get binaryType(): 'arraybuffer' | 'blob' {\n+  get binaryType(): WS['binaryType'] {\n     return this._ws ? this._ws.binaryType : this._binaryType;\n   }\n \n-  set binaryType(value: BinaryType) {\n+  set binaryType(value: WS['binaryType']) {\n     this._binaryType = value;\n     if (this._ws) {\n       this._ws.binaryType = value;\n@@ -507,7 +580,6 @@ export class ReconnectingWebSocket extends TypedEventTarget<WebSocketEventMap> i\n     this._ws.removeEventListener('open', this._handleOpen);\n     this._ws.removeEventListener('close', this._handleClose);\n     this._ws.removeEventListener('message', this._handleMessage);\n-    // @ts-expect-error we need to fix event/listener types\n     this._ws.removeEventListener('error', this._handleError);\n   }\n \n@@ -519,7 +591,6 @@ export class ReconnectingWebSocket extends TypedEventTarget<WebSocketEventMap> i\n     this._ws.addEventListener('open', this._handleOpen);\n     this._ws.addEventListener('close', this._handleClose);\n     this._ws.addEventListener('message', this._handleMessage);\n-    // @ts-expect-error we need to fix event/listener types\n     this._ws.addEventListener('error', this._handleError);\n   }\n \n",
    "test_patch": "diff --git a/packages/agent/src/app.test.ts b/packages/agent/src/app.test.ts\nindex d74715906a..fc7b6b6669 100644\n--- a/packages/agent/src/app.test.ts\n+++ b/packages/agent/src/app.test.ts\n@@ -176,6 +176,70 @@ describe('App', () => {\n     mockServer2.stop();\n   });\n \n+  test('Attempt to reconnect after missed heartbeats', async () => {\n+    const state = {\n+      mySocket: undefined as Client | undefined,\n+      heartbeatCount: 0,\n+      connectRequestCount: 0,\n+    };\n+\n+    function mockConnectionHandler(socket: Client): void {\n+      state.mySocket = socket;\n+      socket.on('message', (data) => {\n+        const command = JSON.parse((data as Buffer).toString('utf8'));\n+        if (command.type === 'agent:connect:request') {\n+          state.connectRequestCount += 1;\n+          socket.send(Buffer.from(JSON.stringify({ type: 'agent:connect:response' })));\n+        } else if (command.type === 'agent:heartbeat:request') {\n+          state.heartbeatCount += 1;\n+        }\n+      });\n+    }\n+\n+    const mockServer = new Server('wss://example.com/ws/agent');\n+    mockServer.on('connection', mockConnectionHandler);\n+\n+    const agent = await medplum.createResource<Agent>({\n+      resourceType: 'Agent',\n+      name: 'Test Agent',\n+      status: 'active',\n+    });\n+\n+    const app = new App(medplum, agent.id as string, LogLevel.INFO);\n+\n+    app.heartbeatPeriod = 200;\n+    await app.start();\n+\n+    // Wait for the WebSocket to connect\n+    while (!state.mySocket) {\n+      await sleep(100);\n+    }\n+\n+    while (state.connectRequestCount < 1) {\n+      await sleep(100);\n+    }\n+\n+    expect(state.connectRequestCount).toBe(1);\n+\n+    // Wait for 2 heartbeats to pass (we should disconnect)\n+    while (state.heartbeatCount < 2) {\n+      await sleep(100);\n+    }\n+\n+    expect(state.connectRequestCount).toBe(1);\n+\n+    // Wait for another connect request (we reconnected)\n+    while (state.connectRequestCount < 2) {\n+      await sleep(100);\n+    }\n+\n+    expect(state.connectRequestCount).toBe(2);\n+\n+    await app.stop();\n+    await app.stop();\n+    mockServer.stop();\n+  });\n+\n   test('Empty endpoint URL', async () => {\n     medplum.router.router.add('POST', ':resourceType/:id/$execute', async () => {\n       return [allOk, {} as Resource];\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5473",
    "pr_id": 5473,
    "issue_id": 5467,
    "repo": "medplum/medplum",
    "problem_statement": "Make `MockClient` strip out empty values\nAfter making server responses more FHIR compliant when it comes to stripping empty values in #5437, our results from `MockClient.search` and `MockClient.readResource` are now out of sync with how the real Medplum server responds. \r\n\r\nWe should ensure that we always return resources that would be the result of parsing 100% compliant resources from over the wire rather than returning whatever JSON object the user puts into `MemoryRepository`.\r\n\r\nWe should also check that there are no places where we are casting away the possible `undefined` value for a field which can be empty where it wasn't previously empty like `Bundle.entry`.",
    "issue_word_count": 109,
    "test_files_count": 2,
    "non_test_files_count": 3,
    "pr_changed_files": [
      "packages/agent/src/app.ts",
      "packages/app/src/resource/ProfilesPage.test.tsx",
      "packages/fhir-router/src/repo.ts",
      "packages/mock/src/client.test.ts",
      "packages/react/src/SearchControl/SearchControl.tsx"
    ],
    "pr_changed_test_files": [
      "packages/app/src/resource/ProfilesPage.test.tsx",
      "packages/mock/src/client.test.ts"
    ],
    "base_commit": "9793a070a7c455cab9f6ba6dc81a00a29d66ae5a",
    "head_commit": "c8ffd83325e4a763fd31898bb8acee2ba83d5ad6",
    "repo_url": "https://github.com/medplum/medplum/pull/5473",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5473",
    "dockerfile": "",
    "pr_merged_at": "2024-11-04T17:56:32.000Z",
    "patch": "diff --git a/packages/agent/src/app.ts b/packages/agent/src/app.ts\nindex ccf67dc12d..cb3269ff95 100644\n--- a/packages/agent/src/app.ts\n+++ b/packages/agent/src/app.ts\n@@ -377,7 +377,7 @@ export class App {\n       const channel = channels[i];\n       const endpoint = endpoints[i];\n \n-      if (endpoint.address === '') {\n+      if (!endpoint.address) {\n         throw new Error(`Invalid empty endpoint address for channel '${channel.name}'`);\n       }\n \n\ndiff --git a/packages/fhir-router/src/repo.ts b/packages/fhir-router/src/repo.ts\nindex 60defe5c1a..e577478ead 100644\n--- a/packages/fhir-router/src/repo.ts\n+++ b/packages/fhir-router/src/repo.ts\n@@ -15,6 +15,7 @@ import {\n   normalizeOperationOutcome,\n   notFound,\n   preconditionFailed,\n+  stringify,\n } from '@medplum/core';\n import { Bundle, BundleEntry, OperationOutcome, Reference, Resource } from '@medplum/fhirtypes';\n import { Operation, applyPatch } from 'rfc6902';\n@@ -323,7 +324,7 @@ export class MemoryRepository extends FhirRepository<undefined> {\n   }\n \n   async createResource<T extends Resource>(resource: T): Promise<T> {\n-    const result = deepClone(resource);\n+    const result = JSON.parse(stringify(resource));\n \n     if (!result.id) {\n       result.id = this.generateId();\n@@ -432,12 +433,13 @@ export class MemoryRepository extends FhirRepository<undefined> {\n \n   async readHistory<T extends Resource>(resourceType: string, id: string): Promise<Bundle<T>> {\n     await this.readResource(resourceType, id);\n+    const entry = ((this.history.get(resourceType)?.get(id) ?? []) as T[])\n+      .reverse()\n+      .map((version) => ({ resource: deepClone(version) }));\n     return {\n       resourceType: 'Bundle',\n       type: 'history',\n-      entry: ((this.history.get(resourceType)?.get(id) ?? []) as T[])\n-        .reverse()\n-        .map((version) => ({ resource: deepClone(version) })),\n+      ...(entry.length ? { entry } : undefined),\n     };\n   }\n \n@@ -477,7 +479,7 @@ export class MemoryRepository extends FhirRepository<undefined> {\n     return {\n       resourceType: 'Bundle',\n       type: 'searchset',\n-      entry,\n+      ...(entry.length ? { entry } : undefined),\n       total: result.length,\n     };\n   }\n\ndiff --git a/packages/react/src/SearchControl/SearchControl.tsx b/packages/react/src/SearchControl/SearchControl.tsx\nindex e65824487f..3696043620 100644\n--- a/packages/react/src/SearchControl/SearchControl.tsx\n+++ b/packages/react/src/SearchControl/SearchControl.tsx\n@@ -459,7 +459,7 @@ export function SearchControl(props: SearchControlProps): JSX.Element {\n           )}\n         </Table.Tbody>\n       </Table>\n-      {resources?.length === 0 && (\n+      {!resources?.length && (\n         <Container>\n           <Center style={{ height: 150 }}>\n             <Text size=\"xl\" c=\"dimmed\">\n",
    "test_patch": "diff --git a/packages/app/src/resource/ProfilesPage.test.tsx b/packages/app/src/resource/ProfilesPage.test.tsx\nindex fae31492d9..9044c43d7a 100644\n--- a/packages/app/src/resource/ProfilesPage.test.tsx\n+++ b/packages/app/src/resource/ProfilesPage.test.tsx\n@@ -103,6 +103,6 @@ describe('ProfilesPage', () => {\n     });\n \n     const updatedPatient = await medplum.readResource('Patient', patient.id as string);\n-    expect(updatedPatient.meta?.profile?.includes(fishPatientProfile.url)).toEqual(false);\n+    expect(updatedPatient.meta?.profile).toEqual(undefined);\n   });\n });\n\ndiff --git a/packages/mock/src/client.test.ts b/packages/mock/src/client.test.ts\nindex fe80825b18..d5646d3e48 100644\n--- a/packages/mock/src/client.test.ts\n+++ b/packages/mock/src/client.test.ts\n@@ -354,6 +354,12 @@ describe('MockClient', () => {\n     expect(result.entry).toHaveLength(2);\n   });\n \n+  test('Search returning no results', async () => {\n+    const client = new MockClient();\n+    const result = await client.search('Patient', 'name=Simperson');\n+    expect(result.entry).toBeUndefined();\n+  });\n+\n   test('Create binary success', async () => {\n     const client = new MockClient();\n     const result = await client.createBinary('test', 'test.txt', ContentType.TEXT);\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5455",
    "pr_id": 5455,
    "issue_id": 5424,
    "repo": "medplum/medplum",
    "problem_statement": "Practitioners with Uppercase characters in their email won't map to Users with the same\nIf you create a Practitioner with an email that contains uppercase letters like\n\n```\n{\n    \"resourceType\": \"Practitioner\",\n    \"meta\": {\n        \"accounts\": [\n            {\n                \"reference\": \"Organization/A\"\n            }\n        ]\n    },\n    \"name\": [\n        {\n            \"given\": [\n                \"Practitioner\"\n            ],\n            \"family\": \"A.1\"\n        }\n    ],\n    \"telecom\": [\n        {\n            \"system\": \"email\",\n            \"use\": \"work\",\n            \"value\": \"Practitioner.A.1@example.com\"\n        }\n    ]\n}\n```\n\nThen create a user also using uppercase letters in the email \n\n\n```\n{\n    \"resourceType\": \"Practitioner\",\n    \"firstName\": \"Practitioner\",\n    \"lastName\": \"A.1\",\n    \"email\": \"Practitioner.A.1@example.com\",\n    \"sendEmail\": \"false\",\n    \"password\": \"foobar\"\n}\n```\n\nThese accounts won't be matched together. \n\nI think the logic to create a user converts the email to lowercase whereas the logic to create a Practitioner does not. ",
    "issue_word_count": 109,
    "test_files_count": 1,
    "non_test_files_count": 3,
    "pr_changed_files": [
      "packages/server/src/fhir/lookups/lookuptable.ts",
      "packages/server/src/fhir/lookups/token.ts",
      "packages/server/src/fhir/search.test.ts",
      "packages/server/src/fhir/search.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/search.test.ts"
    ],
    "base_commit": "70a28416da7baef8f9d162659288785e15ff52a7",
    "head_commit": "c96b9d0224a84de0ef003bbe7598412dafa90582",
    "repo_url": "https://github.com/medplum/medplum/pull/5455",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5455",
    "dockerfile": "",
    "pr_merged_at": "2024-11-05T19:13:12.000Z",
    "patch": "diff --git a/packages/server/src/fhir/lookups/lookuptable.ts b/packages/server/src/fhir/lookups/lookuptable.ts\nindex 7f8784b4a5..6fefca0ddd 100644\n--- a/packages/server/src/fhir/lookups/lookuptable.ts\n+++ b/packages/server/src/fhir/lookups/lookuptable.ts\n@@ -58,10 +58,17 @@ export abstract class LookupTable {\n    * @param _selectQuery - The select query builder.\n    * @param resourceType - The FHIR resource type.\n    * @param table - The resource table.\n+   * @param _param - The search parameter.\n    * @param filter - The search filter details.\n    * @returns The select query where expression.\n    */\n-  buildWhere(_selectQuery: SelectQuery, resourceType: ResourceType, table: string, filter: Filter): Expression {\n+  buildWhere(\n+    _selectQuery: SelectQuery,\n+    resourceType: ResourceType,\n+    table: string,\n+    _param: SearchParameter,\n+    filter: Filter\n+  ): Expression {\n     const lookupTableName = this.getTableName(resourceType);\n     const columnName = this.getColumnName(filter.code);\n \n\ndiff --git a/packages/server/src/fhir/lookups/token.ts b/packages/server/src/fhir/lookups/token.ts\nindex 126cb773e2..5702bd6d3a 100644\n--- a/packages/server/src/fhir/lookups/token.ts\n+++ b/packages/server/src/fhir/lookups/token.ts\n@@ -109,10 +109,17 @@ export class TokenTable extends LookupTable {\n    * @param _selectQuery - The select query builder.\n    * @param resourceType - The resource type.\n    * @param table - The resource table.\n+   * @param param - The search parameter.\n    * @param filter - The search filter details.\n    * @returns The select query where expression.\n    */\n-  buildWhere(_selectQuery: SelectQuery, resourceType: ResourceType, table: string, filter: Filter): Expression {\n+  buildWhere(\n+    _selectQuery: SelectQuery,\n+    resourceType: ResourceType,\n+    table: string,\n+    param: SearchParameter,\n+    filter: Filter\n+  ): Expression {\n     const lookupTableName = this.getTableName(resourceType);\n \n     const conjunction = new Conjunction([\n@@ -120,7 +127,9 @@ export class TokenTable extends LookupTable {\n       new Condition(new Column(lookupTableName, 'code'), '=', filter.code),\n     ]);\n \n-    const whereExpression = buildWhereExpression(lookupTableName, filter);\n+    const caseSensitive = isCaseSensitiveSearchParameter(param, resourceType);\n+\n+    const whereExpression = buildWhereExpression(lookupTableName, caseSensitive, filter);\n     if (whereExpression) {\n       conjunction.expressions.push(whereExpression);\n     }\n@@ -270,16 +279,15 @@ function getTableName(resourceType: ResourceType): string {\n  * @returns An array of all tokens from the resource to be inserted into the database.\n  */\n function getTokens(resource: Resource): Token[] {\n-  const typedResource = [toTypedValue(resource)];\n   const searchParams = getSearchParameters(resource.resourceType);\n   const result: Token[] = [];\n   if (searchParams) {\n     for (const searchParam of Object.values(searchParams)) {\n       if (isIndexed(searchParam, resource.resourceType)) {\n-        buildTokensForSearchParameter(result, typedResource, searchParam);\n+        buildTokensForSearchParameter(result, resource, searchParam);\n       }\n       if (searchParam.type === 'reference') {\n-        buildTokensForSearchParameter(result, typedResource, deriveIdentifierSearchParameter(searchParam));\n+        buildTokensForSearchParameter(result, resource, deriveIdentifierSearchParameter(searchParam));\n       }\n     }\n   }\n@@ -289,17 +297,13 @@ function getTokens(resource: Resource): Token[] {\n /**\n  * Builds a list of zero or more tokens for a search parameter and resource.\n  * @param result - The result array where tokens will be added.\n- * @param typedResource - The typed resource.\n+ * @param resource - The resource.\n  * @param searchParam - The search parameter.\n  */\n-function buildTokensForSearchParameter(\n-  result: Token[],\n-  typedResource: TypedValue[],\n-  searchParam: SearchParameter\n-): void {\n-  const typedValues = evalFhirPathTyped(searchParam.expression as string, typedResource);\n+function buildTokensForSearchParameter(result: Token[], resource: Resource, searchParam: SearchParameter): void {\n+  const typedValues = evalFhirPathTyped(searchParam.expression as string, [toTypedValue(resource)]);\n   for (const typedValue of typedValues) {\n-    buildTokens(result, searchParam, typedValue);\n+    buildTokens(result, searchParam, resource, typedValue);\n   }\n }\n \n@@ -307,25 +311,29 @@ function buildTokensForSearchParameter(\n  * Builds a list of zero or more tokens for a search parameter and value.\n  * @param result - The result array where tokens will be added.\n  * @param searchParam - The search parameter.\n+ * @param resource - The resource.\n  * @param typedValue - A typed value to be indexed for the search parameter.\n  */\n-function buildTokens(result: Token[], searchParam: SearchParameter, typedValue: TypedValue): void {\n+function buildTokens(result: Token[], searchParam: SearchParameter, resource: Resource, typedValue: TypedValue): void {\n   const { type, value } = typedValue;\n+\n+  const caseSensitive = isCaseSensitiveSearchParameter(searchParam, resource.resourceType);\n+\n   switch (type) {\n     case PropertyType.Identifier:\n-      buildIdentifierToken(result, searchParam, value as Identifier);\n+      buildIdentifierToken(result, searchParam, caseSensitive, value as Identifier);\n       break;\n     case PropertyType.CodeableConcept:\n-      buildCodeableConceptToken(result, searchParam, value as CodeableConcept);\n+      buildCodeableConceptToken(result, searchParam, caseSensitive, value as CodeableConcept);\n       break;\n     case PropertyType.Coding:\n-      buildCodingToken(result, searchParam, value as Coding);\n+      buildCodingToken(result, searchParam, caseSensitive, value as Coding);\n       break;\n     case PropertyType.ContactPoint:\n-      buildContactPointToken(result, searchParam, value as ContactPoint);\n+      buildContactPointToken(result, searchParam, caseSensitive, value as ContactPoint);\n       break;\n     default:\n-      buildSimpleToken(result, searchParam, undefined, value?.toString() as string | undefined);\n+      buildSimpleToken(result, searchParam, caseSensitive, undefined, value?.toString() as string | undefined);\n   }\n }\n \n@@ -333,29 +341,37 @@ function buildTokens(result: Token[], searchParam: SearchParameter, typedValue:\n  * Builds an identifier token.\n  * @param result - The result array where tokens will be added.\n  * @param searchParam - The search parameter.\n+ * @param caseSensitive - If the token value should be case sensitive.\n  * @param identifier - The Identifier object to be indexed.\n  */\n-function buildIdentifierToken(result: Token[], searchParam: SearchParameter, identifier: Identifier | undefined): void {\n-  buildSimpleToken(result, searchParam, identifier?.system, identifier?.value);\n+function buildIdentifierToken(\n+  result: Token[],\n+  searchParam: SearchParameter,\n+  caseSensitive: boolean,\n+  identifier: Identifier | undefined\n+): void {\n+  buildSimpleToken(result, searchParam, caseSensitive, identifier?.system, identifier?.value);\n }\n \n /**\n  * Builds zero or more CodeableConcept tokens.\n  * @param result - The result array where tokens will be added.\n  * @param searchParam - The search parameter.\n+ * @param caseSensitive - If the token value should be case sensitive.\n  * @param codeableConcept - The CodeableConcept object to be indexed.\n  */\n function buildCodeableConceptToken(\n   result: Token[],\n   searchParam: SearchParameter,\n+  caseSensitive: boolean,\n   codeableConcept: CodeableConcept | undefined\n ): void {\n   if (codeableConcept?.text) {\n-    buildSimpleToken(result, searchParam, 'text', codeableConcept.text);\n+    buildSimpleToken(result, searchParam, caseSensitive, 'text', codeableConcept.text);\n   }\n   if (codeableConcept?.coding) {\n     for (const coding of codeableConcept.coding) {\n-      buildCodingToken(result, searchParam, coding);\n+      buildCodingToken(result, searchParam, caseSensitive, coding);\n     }\n   }\n }\n@@ -364,14 +380,20 @@ function buildCodeableConceptToken(\n  * Builds a Coding token.\n  * @param result - The result array where tokens will be added.\n  * @param searchParam - The search parameter.\n+ * @param caseSensitive - If the token value should be case sensitive.\n  * @param coding - The Coding object to be indexed.\n  */\n-function buildCodingToken(result: Token[], searchParam: SearchParameter, coding: Coding | undefined): void {\n+function buildCodingToken(\n+  result: Token[],\n+  searchParam: SearchParameter,\n+  caseSensitive: boolean,\n+  coding: Coding | undefined\n+): void {\n   if (coding) {\n     if (coding.display) {\n-      buildSimpleToken(result, searchParam, 'text', coding.display);\n+      buildSimpleToken(result, searchParam, caseSensitive, 'text', coding.display);\n     }\n-    buildSimpleToken(result, searchParam, coding.system, coding.code);\n+    buildSimpleToken(result, searchParam, caseSensitive, coding.system, coding.code);\n   }\n }\n \n@@ -379,26 +401,36 @@ function buildCodingToken(result: Token[], searchParam: SearchParameter, coding:\n  * Builds a ContactPoint token.\n  * @param result - The result array where tokens will be added.\n  * @param searchParam - The search parameter.\n+ * @param caseSensitive - If the token value should be case sensitive.\n  * @param contactPoint - The ContactPoint object to be indexed.\n  */\n function buildContactPointToken(\n   result: Token[],\n   searchParam: SearchParameter,\n+  caseSensitive: boolean,\n   contactPoint: ContactPoint | undefined\n ): void {\n-  buildSimpleToken(result, searchParam, contactPoint?.system, contactPoint?.value);\n+  buildSimpleToken(\n+    result,\n+    searchParam,\n+    caseSensitive,\n+    contactPoint?.system,\n+    contactPoint?.value ? contactPoint.value.toLocaleLowerCase() : contactPoint?.value\n+  );\n }\n \n /**\n  * Builds a simple token.\n  * @param result - The result array where tokens will be added.\n  * @param searchParam - The search parameter.\n+ * @param caseSensitive - If the token value should be case sensitive.\n  * @param system - The token system.\n  * @param value - The token value.\n  */\n function buildSimpleToken(\n   result: Token[],\n   searchParam: SearchParameter,\n+  caseSensitive: boolean,\n   system: string | undefined,\n   value: string | undefined\n ): void {\n@@ -410,7 +442,7 @@ function buildSimpleToken(\n     result.push({\n       code: searchParam.code as string,\n       system,\n-      value,\n+      value: value && !caseSensitive ? value.toLocaleLowerCase() : value,\n     });\n   }\n }\n@@ -421,14 +453,15 @@ function buildSimpleToken(\n  * The Disjunction will contain one filter for each specified query value.\n  *\n  * @param tableName - The token table name\n+ * @param caseSensitive - If the query value should be case sensitive.\n  * @param filter - The SearchRequest filter being performed on the token\n  * @returns A Disjunction of filters on the token table based on `filter.operator`, or `undefined` if no filters are\n  * required.\n  */\n-function buildWhereExpression(tableName: string, filter: Filter): Expression | undefined {\n+function buildWhereExpression(tableName: string, caseSensitive: boolean, filter: Filter): Expression | undefined {\n   const subExpressions = [];\n   for (const option of splitSearchOnComma(filter.value)) {\n-    const expression = buildWhereCondition(tableName, filter.operator, option);\n+    const expression = buildWhereCondition(tableName, filter.operator, caseSensitive, option);\n     if (expression) {\n       subExpressions.push(expression);\n     }\n@@ -446,16 +479,22 @@ function buildWhereExpression(tableName: string, filter: Filter): Expression | u\n  *\n  * @param tableName - The token table name\n  * @param operator - The SearchRequest operator being performed on the token\n+ * @param caseSensitive - If the query value should be case sensitive.\n  * @param query - The query value of the operator\n  * @returns A WHERE Condition on the token table, if applicable, else undefined\n  */\n-function buildWhereCondition(tableName: string, operator: FhirOperator, query: string): Expression | undefined {\n+function buildWhereCondition(\n+  tableName: string,\n+  operator: FhirOperator,\n+  caseSensitive: boolean,\n+  query: string\n+): Expression | undefined {\n   const parts = splitN(query, '|', 2);\n   // Handle the case where the query value is a system|value pair (e.g. token or identifier search)\n   if (parts.length === 2) {\n     const systemCondition = new Condition(new Column(tableName, 'system'), '=', parts[0]);\n     return parts[1]\n-      ? new Conjunction([systemCondition, buildValueCondition(tableName, operator, parts[1])])\n+      ? new Conjunction([systemCondition, buildValueCondition(tableName, operator, caseSensitive, parts[1])])\n       : systemCondition;\n   } else {\n     // If using the :in operator, build the condition for joining to the ValueSet table specified by `query`\n@@ -465,7 +504,7 @@ function buildWhereCondition(tableName: string, operator: FhirOperator, query: s\n     // If we we are searching for a particular token value, build a Condition that filters the lookup table on that\n     //value\n     if (shouldCompareTokenValue(operator)) {\n-      return buildValueCondition(tableName, operator, query);\n+      return buildValueCondition(tableName, operator, caseSensitive, query);\n     }\n     // Otherwise we are just looking for the presence / absence of a token (e.g. when using the FhirOperator.MISSING)\n     // so we don't need to construct a filter Condition on the token table.\n@@ -473,19 +512,30 @@ function buildWhereCondition(tableName: string, operator: FhirOperator, query: s\n   }\n }\n \n-function buildValueCondition(tableName: string, operator: FhirOperator, value: string): Expression {\n+function buildValueCondition(\n+  tableName: string,\n+  operator: FhirOperator,\n+  caseSensitive: boolean,\n+  value: string\n+): Expression {\n   const column = new Column(tableName, 'value');\n+  value = value.trim();\n+\n   if (operator === FhirOperator.TEXT) {\n     getLogger().warn('Potentially expensive token lookup query', { operator });\n     return new Conjunction([\n       new Condition(new Column(tableName, 'system'), '=', 'text'),\n-      new Condition(column, 'TSVECTOR_SIMPLE', value.trim() + ':*'),\n+      new Condition(column, 'TSVECTOR_SIMPLE', value + ':*'),\n     ]);\n   } else if (operator === FhirOperator.CONTAINS) {\n     getLogger().warn('Potentially expensive token lookup query', { operator });\n-    return new Condition(column, 'LIKE', escapeLikeString(value.trim()) + '%');\n+    return new Condition(column, 'LIKE', escapeLikeString(value) + '%');\n+  } else if (caseSensitive) {\n+    return new Condition(column, '=', value);\n   } else {\n-    return new Condition(column, '=', value.trim());\n+    // In Medplum v4, or when there is a guarantee all resources have been reindexed, the IN (...) can be\n+    // switched to an '=' of just the lower-cased value for a simplified query and potentially better performance.\n+    return new Condition(column, 'IN', [value, value.toLocaleLowerCase()]);\n   }\n }\n \n@@ -568,3 +618,15 @@ function buildInValueSetCondition(tableName: string, value: string): Condition {\n     'TEXT[]'\n   );\n }\n+\n+/**\n+ * If the search parameter should be considered case-sensitive when searching for tokens.\n+ * @param param - The search parameter.\n+ * @param resourceType - The resource type being searched.\n+ * @returns True if the search parameter should be considered case-sensitive when searching for tokens.\n+ */\n+function isCaseSensitiveSearchParameter(param: SearchParameter, resourceType: ResourceType): boolean {\n+  const details = getSearchParameterDetails(resourceType, param);\n+  // The param is case-sensitive unless it covers an ElementDefinition that can be of type \"ContactPoint\"\n+  return !details.elementDefinitions?.some((ed) => ed.type?.some((t) => t.code === PropertyType.ContactPoint));\n+}\n\ndiff --git a/packages/server/src/fhir/search.ts b/packages/server/src/fhir/search.ts\nindex 8074c58bb1..531221911c 100644\n--- a/packages/server/src/fhir/search.ts\n+++ b/packages/server/src/fhir/search.ts\n@@ -880,7 +880,7 @@ function buildSearchFilterExpression(\n \n   const lookupTable = getLookupTable(resourceType, param);\n   if (lookupTable) {\n-    return lookupTable.buildWhere(selectQuery, resourceType, table, filter);\n+    return lookupTable.buildWhere(selectQuery, resourceType, table, param, filter);\n   }\n \n   // Not any special cases, just a normal search parameter.\n",
    "test_patch": "diff --git a/packages/server/src/fhir/search.test.ts b/packages/server/src/fhir/search.test.ts\nindex bb740ad740..06e2d40614 100644\n--- a/packages/server/src/fhir/search.test.ts\n+++ b/packages/server/src/fhir/search.test.ts\n@@ -3436,6 +3436,58 @@ describe('FHIR Search', () => {\n         expect(result.entry?.length).toBe(0);\n       }));\n \n+    test('Practitioner by email is case insensitive', () =>\n+      withTestContext(async () => {\n+        const email = 'UPPER@EXAMPLE.COM';\n+        const practitioner = await repo.createResource<Practitioner>({\n+          resourceType: 'Practitioner',\n+          telecom: [{ system: 'email', value: email }],\n+        });\n+        const result = await repo.search({\n+          resourceType: 'Practitioner',\n+          filters: [\n+            {\n+              code: 'telecom',\n+              operator: Operator.EQUALS,\n+              value: 'uPpeR@ExAmPlE.CoM',\n+            },\n+          ],\n+        });\n+        expect(result.entry?.length).toBe(1);\n+        expect(bundleContains(result, practitioner)).toBeDefined();\n+      }));\n+\n+    test('Practitioner by identifier is case sensitive', () =>\n+      withTestContext(async () => {\n+        const value = 'MiXeD-cAsE';\n+        const practitioner = await repo.createResource<Practitioner>({\n+          resourceType: 'Practitioner',\n+          identifier: [{ system: 'http://example.com', value }],\n+        });\n+        for (const [query, shouldFind] of [\n+          [value, true],\n+          [value.toLocaleLowerCase(), false],\n+          [value.toLocaleUpperCase(), false],\n+        ] as [string, boolean][]) {\n+          const result = await repo.search({\n+            resourceType: 'Practitioner',\n+            filters: [\n+              {\n+                code: 'identifier',\n+                operator: Operator.EQUALS,\n+                value: query,\n+              },\n+            ],\n+          });\n+          if (shouldFind) {\n+            expect(result.entry?.length).toBe(1);\n+            expect(bundleContains(result, practitioner)).toBeDefined();\n+          } else {\n+            expect(result.entry?.length).toBe(0);\n+          }\n+        }\n+      }));\n+\n     test('Patient by name with stop word', () =>\n       withTestContext(async () => {\n         const seed = randomUUID();\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5449",
    "pr_id": 5449,
    "issue_id": 5294,
    "repo": "medplum/medplum",
    "problem_statement": "Allow users to configure `create` only `Subscription` for `Questionnaire` bots from `@medplum/app`\nCurrently the default for bots associated to `Questionnaire` via the automatic `Subscription` creation in the `Questionnaire`-related UI will create a `Subscription` that will trigger not only on creation of a `QuestionnaireResponse` associated with the given `Questionnaire` but also on any update to those `QuestionnaireResponse`s that may happen at a later time.\r\n\r\nThis may not be the assumed behavior of most users authoring Questionnaires and it should be easier to get the assumed behavior, and as a separate question, it may be better if `create only` trigger was the default.\r\n\r\nThe proposed UI change would be a dropdown where you can select the `Trigger Event` for this `Subscription`; something like `All Events`, `Update Only`, `Create Only`, etc. would be the options. The selection of this value would then add the appropriate extension (or not add any in the case of `All Events` trigger being selected) without the user having to go in and manually update the `Subscription` resource.",
    "issue_word_count": 172,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/app/src/resource/QuestionnaireBotsPage.tsx",
      "packages/app/src/resource/ResourcePage.test.tsx"
    ],
    "pr_changed_test_files": [
      "packages/app/src/resource/ResourcePage.test.tsx"
    ],
    "base_commit": "db406abb5fc03bb6e02fcfa52fe1a7c4d1dd4bdd",
    "head_commit": "450b7a3b17cc973e504ece2f8d33af9206522e1b",
    "repo_url": "https://github.com/medplum/medplum/pull/5449",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5449",
    "dockerfile": "",
    "pr_merged_at": "2024-10-31T02:01:48.000Z",
    "patch": "diff --git a/packages/app/src/resource/QuestionnaireBotsPage.tsx b/packages/app/src/resource/QuestionnaireBotsPage.tsx\nindex 6b222e61ef..cd4cd5dd9c 100644\n--- a/packages/app/src/resource/QuestionnaireBotsPage.tsx\n+++ b/packages/app/src/resource/QuestionnaireBotsPage.tsx\n@@ -1,4 +1,4 @@\n-import { Button, Group, Title } from '@mantine/core';\n+import { Button, Divider, Group, InputLabel, NativeSelect, Stack, Title } from '@mantine/core';\n import { showNotification } from '@mantine/notifications';\n import { getReferenceString, normalizeErrorString } from '@medplum/core';\n import { Bot, Subscription } from '@medplum/fhirtypes';\n@@ -6,10 +6,24 @@ import { Document, ResourceInput, ResourceName, useMedplum } from '@medplum/reac\n import { useState } from 'react';\n import { useParams } from 'react-router-dom';\n \n+const SUBSCRIPTION_INTERACTION_MAP = {\n+  'Create Only': 'create',\n+  'Update Only': 'update',\n+  'Delete Only': 'delete',\n+  'All Interactions': undefined,\n+} as const;\n+\n+const SUBSCRIPTION_INTERACTION_KEYS = Object.keys(SUBSCRIPTION_INTERACTION_MAP);\n+\n+type SubscriptionInteractionKey = keyof typeof SUBSCRIPTION_INTERACTION_MAP;\n+\n export function QuestionnaireBotsPage(): JSX.Element {\n   const medplum = useMedplum();\n   const { id } = useParams() as { id: string };\n   const [connectBot, setConnectBot] = useState<Bot | undefined>();\n+  const [supportedInteraction, setSupportedInteraction] = useState<'create' | 'update' | 'delete' | undefined>(\n+    'create'\n+  );\n   const [updated, setUpdated] = useState<number>(0);\n   const subscriptions = medplum\n     .searchResources('Subscription', 'status=active&_count=100')\n@@ -28,6 +42,16 @@ export function QuestionnaireBotsPage(): JSX.Element {\n             type: 'rest-hook',\n             endpoint: getReferenceString(connectBot),\n           },\n+          ...(supportedInteraction\n+            ? {\n+                extension: [\n+                  {\n+                    url: 'https://medplum.com/fhir/StructureDefinition/subscription-supported-interaction',\n+                    valueCode: supportedInteraction,\n+                  },\n+                ],\n+              }\n+            : undefined),\n         })\n         .then(() => {\n           setConnectBot(undefined);\n@@ -42,21 +66,38 @@ export function QuestionnaireBotsPage(): JSX.Element {\n   return (\n     <Document>\n       <Title>Bots</Title>\n-      {subscriptions.length === 0 && <p>No bots found.</p>}\n-      {subscriptions.map((subscription) => (\n-        <div key={subscription.id}>\n-          <h3>\n-            <ResourceName value={{ reference: subscription.channel?.endpoint as string }} link={true} />\n-          </h3>\n-          <p>Criteria: {subscription.criteria}</p>\n-        </div>\n-      ))}\n-      <hr />\n-      <Title>Connect to bot</Title>\n-      <Group>\n-        <ResourceInput name=\"bot\" resourceType=\"Bot\" onChange={(r) => setConnectBot(r as Bot)} />\n-        <Button onClick={connectToBot}>Connect</Button>\n-      </Group>\n+      <Stack>\n+        {subscriptions.length === 0 && <p>No bots found.</p>}\n+        {subscriptions.map((subscription) => (\n+          <div key={subscription.id}>\n+            <h3>\n+              <ResourceName value={{ reference: subscription.channel?.endpoint as string }} link={true} />\n+            </h3>\n+            <p>Criteria: {subscription.criteria}</p>\n+          </div>\n+        ))}\n+      </Stack>\n+      <Divider />\n+      <Stack mt={10}>\n+        <InputLabel size=\"lg\" htmlFor=\"bot\">\n+          Connect to bot\n+        </InputLabel>\n+        <Group>\n+          <ResourceInput name=\"bot\" resourceType=\"Bot\" onChange={(r) => setConnectBot(r as Bot)} />\n+          <Button onClick={connectToBot}>Connect</Button>\n+        </Group>\n+        <Group>\n+          <NativeSelect\n+            name=\"subscription-trigger-event\"\n+            defaultValue=\"Create Only\"\n+            label=\"Subscription Trigger Event\"\n+            data={SUBSCRIPTION_INTERACTION_KEYS}\n+            onChange={(event) =>\n+              setSupportedInteraction(SUBSCRIPTION_INTERACTION_MAP[event.target.value as SubscriptionInteractionKey])\n+            }\n+          />\n+        </Group>\n+      </Stack>\n       <div style={{ display: 'none' }}>{updated}</div>\n     </Document>\n   );\n",
    "test_patch": "diff --git a/packages/app/src/resource/ResourcePage.test.tsx b/packages/app/src/resource/ResourcePage.test.tsx\nindex df98cf565b..faea30bed5 100644\n--- a/packages/app/src/resource/ResourcePage.test.tsx\n+++ b/packages/app/src/resource/ResourcePage.test.tsx\n@@ -7,7 +7,7 @@ import { ErrorBoundary, Loading, MedplumProvider } from '@medplum/react';\n import { Suspense } from 'react';\n import { MemoryRouter } from 'react-router-dom';\n import { AppRoutes } from '../AppRoutes';\n-import { act, fireEvent, render, screen } from '../test-utils/render';\n+import { act, fireEvent, render, screen, userEvent } from '../test-utils/render';\n \n describe('ResourcePage', () => {\n   async function setup(url: string, medplum = new MockClient()): Promise<void> {\n@@ -113,7 +113,7 @@ describe('ResourcePage', () => {\n     expect(window.alert).toHaveBeenCalledWith('You submitted the preview');\n   });\n \n-  test('Questionnaire bots', async () => {\n+  test('Questionnaire bots -- create only (default)', async () => {\n     const medplum = new MockClient();\n     const bot = await medplum.createResource<Bot>({\n       resourceType: 'Bot',\n@@ -121,14 +121,16 @@ describe('ResourcePage', () => {\n     });\n     expect(bot.id).toBeDefined();\n \n-    await setup('/Questionnaire/123/bots');\n+    await setup('/Questionnaire/123/bots', medplum);\n     expect(await screen.findByText('Connect to bot')).toBeInTheDocument();\n \n+    const createResourceSpy = jest.spyOn(medplum, 'createResource');\n+\n     // Select \"Test Bot\" in the bot input field\n \n     const input = screen.getByRole('searchbox') as HTMLInputElement;\n \n-    // Enter \"Simpson\"\n+    // Enter \"Test\"\n     await act(async () => {\n       fireEvent.change(input, { target: { value: 'Test' } });\n     });\n@@ -155,6 +157,110 @@ describe('ResourcePage', () => {\n \n     // Bot subscription should now be listed\n     expect(screen.getByText('Criteria: QuestionnaireResponse?questionnaire=Questionnaire/123')).toBeInTheDocument();\n+\n+    // Should have created a subscription with the `subscription-supported-interaction` extension value of `create`\n+    expect(createResourceSpy).toHaveBeenLastCalledWith({\n+      resourceType: 'Subscription',\n+      status: 'active',\n+      reason: 'Connect bot Test Bot to questionnaire responses',\n+      criteria: 'QuestionnaireResponse?questionnaire=Questionnaire/123',\n+      channel: {\n+        type: 'rest-hook',\n+        endpoint: 'Bot/123',\n+      },\n+      extension: [\n+        {\n+          url: 'https://medplum.com/fhir/StructureDefinition/subscription-supported-interaction',\n+          valueCode: 'create',\n+        },\n+      ],\n+    });\n+\n+    // Wait for the drop down\n+    await act(async () => {\n+      jest.advanceTimersByTime(1000);\n+    });\n+\n+    // Wait for the drop down\n+    await act(async () => {\n+      jest.advanceTimersByTime(1000);\n+    });\n+  });\n+\n+  test('Questionnaire bots -- all interactions', async () => {\n+    const user = userEvent.setup();\n+    const medplum = new MockClient();\n+    const bot = await medplum.createResource<Bot>({\n+      resourceType: 'Bot',\n+      name: 'Test Bot',\n+    });\n+    expect(bot.id).toBeDefined();\n+\n+    await setup('/Questionnaire/123/bots', medplum);\n+    expect(await screen.findByText('Connect to bot')).toBeInTheDocument();\n+\n+    const createResourceSpy = jest.spyOn(medplum, 'createResource');\n+\n+    // Select \"Test Bot\" in the bot input field\n+\n+    const input = screen.getByRole('searchbox') as HTMLInputElement;\n+\n+    // Now let's create a subscription without any extension (fires for all interactions)\n+    // Select \"Test Bot\" in the bot input field\n+\n+    // Enter \"Test\"\n+    await act(async () => {\n+      fireEvent.change(input, { target: { value: 'Test' } });\n+    });\n+\n+    // Wait for the drop down\n+    await act(async () => {\n+      jest.advanceTimersByTime(1000);\n+    });\n+\n+    // Press the down arrow\n+    await act(async () => {\n+      fireEvent.keyDown(input, { key: 'ArrowDown', code: 'ArrowDown' });\n+    });\n+\n+    // Press \"Enter\"\n+    await act(async () => {\n+      fireEvent.keyDown(input, { key: 'Enter', code: 'Enter' });\n+    });\n+\n+    const interactionDropdown = screen.getByRole<HTMLSelectElement>('combobox', {\n+      name: /subscription trigger event/i,\n+    });\n+\n+    // We have to disable fake timers for the `selectOptions` to work\n+    jest.useRealTimers();\n+\n+    await act(async () => {\n+      // Find the dropdown for interaction trigger\n+      await user.selectOptions(interactionDropdown, ['All Interactions']);\n+    });\n+\n+    jest.useFakeTimers();\n+\n+    // Click on \"Connect\"\n+    await act(async () => {\n+      fireEvent.click(screen.getByText('Connect'));\n+    });\n+\n+    // Bot subscription should now be listed, #2 in the list\n+    expect(screen.getByText('Criteria: QuestionnaireResponse?questionnaire=Questionnaire/123')).toBeInTheDocument();\n+\n+    // Should have created a subscription with the `subscription-supported-interaction` extension value of `create`\n+    expect(createResourceSpy).toHaveBeenLastCalledWith({\n+      resourceType: 'Subscription',\n+      status: 'active',\n+      reason: 'Connect bot Test Bot to questionnaire responses',\n+      criteria: 'QuestionnaireResponse?questionnaire=Questionnaire/123',\n+      channel: {\n+        type: 'rest-hook',\n+        endpoint: 'Bot/123',\n+      },\n+    });\n   });\n \n   test('Bot editor', async () => {\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5448",
    "pr_id": 5448,
    "issue_id": 5441,
    "repo": "medplum/medplum",
    "problem_statement": "Allow '*' in access policy search criteria\n## Use Case\r\nRight now, to write a [patient access](https://www.medplum.com/docs/access/access-policies#patient-access) `AccessPolicy`, you have enumerate every resource the patient has access to. \r\n\r\nIt would be ideal if there was a way to express \"Give me access to all resources in a given patient's compartment\". \r\n\r\nWe already support the \"*\" syntax for `resourceType`, but can't use it in the criteria string, which makes its use limited\r\n\r\n\r\n## Proposal\r\n```js\r\n{\r\n      \"resourceType\": \"*\",\r\n      \"criteria\": \"_compartment=%patient\"\r\n}\r\n```    \r\n(preferred)\r\nOR \r\n\r\n```js\r\n{\r\n      \"resourceType\": \"*\",\r\n      \"criteria\": \"*?_compartment=%patient\"\r\n}\r\n```    \r\n(if this is easy to implement)\r\n\r\n",
    "issue_word_count": 99,
    "test_files_count": 2,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/server/src/fhir/accesspolicy.test.ts",
      "packages/server/src/fhir/repo.ts",
      "packages/server/src/test.setup.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/accesspolicy.test.ts",
      "packages/server/src/test.setup.ts"
    ],
    "base_commit": "11bad2949b7d66c5152a973fb3139008e82f50ea",
    "head_commit": "426a57948a7495dd85f7de90cdbcb6b43208eb5b",
    "repo_url": "https://github.com/medplum/medplum/pull/5448",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5448",
    "dockerfile": "",
    "pr_merged_at": "2024-10-31T19:20:33.000Z",
    "patch": "diff --git a/packages/server/src/fhir/repo.ts b/packages/server/src/fhir/repo.ts\nindex 10aaea9d08..72e36b674f 100644\n--- a/packages/server/src/fhir/repo.ts\n+++ b/packages/server/src/fhir/repo.ts\n@@ -1173,7 +1173,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     const expressions: Expression[] = [];\n \n     for (const policy of accessPolicy.resource) {\n-      if (policy.resourceType === resourceType) {\n+      if (policy.resourceType === resourceType || policy.resourceType === '*') {\n         const policyCompartmentId = resolveId(policy.compartment);\n         if (policyCompartmentId) {\n           // Deprecated - to be removed\n@@ -1188,8 +1188,14 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n             });\n             return; // Ignore invalid access policy criteria\n           }\n+\n           // Add subquery for access policy criteria.\n-          const searchRequest = parseSearchRequest(policy.criteria);\n+          let criteria = policy.criteria;\n+          if (policy.resourceType === '*') {\n+            const queryIndex = criteria.indexOf('?');\n+            criteria = resourceType + '?' + criteria.slice(queryIndex + 1);\n+          }\n+          const searchRequest = parseSearchRequest(criteria);\n           const accessPolicyExpression = buildSearchExpression(\n             this,\n             builder,\n",
    "test_patch": "diff --git a/packages/server/src/fhir/accesspolicy.test.ts b/packages/server/src/fhir/accesspolicy.test.ts\nindex 2caf236688..b05cd35542 100644\n--- a/packages/server/src/fhir/accesspolicy.test.ts\n+++ b/packages/server/src/fhir/accesspolicy.test.ts\n@@ -2546,4 +2546,36 @@ describe('AccessPolicy', () => {\n       ).rejects.toThrow(expectedError);\n     })\n   );\n+\n+  test('Wildcard policy with criteria', async () =>\n+    withTestContext(async () => {\n+      const compartment = 'Patient/' + randomUUID();\n+      const { repo, project } = await createTestProject({\n+        withRepo: true,\n+        accessPolicy: {\n+          resourceType: 'AccessPolicy',\n+          resource: [\n+            {\n+              resourceType: '*',\n+              criteria: `*?_compartment=${compartment}`,\n+            },\n+          ],\n+        },\n+      });\n+\n+      const patient = await systemRepo.createResource<Patient>({\n+        resourceType: 'Patient',\n+        meta: { project: project.id },\n+        link: [{ type: 'refer', other: { reference: compartment } }], // In the correct compartment\n+      });\n+      const readPatient = await repo.readResource('Patient', patient.id as string);\n+      expect(readPatient.meta?.compartment).toContainEqual({ reference: compartment });\n+\n+      const patient2 = await systemRepo.createResource<Patient>({\n+        resourceType: 'Patient',\n+        meta: { project: project.id },\n+        // Not in the compartment; should not be accessible per the access policy\n+      });\n+      await expect(repo.readResource('Patient', patient2.id as string)).rejects.toThrow('Not found');\n+    }));\n });\n\ndiff --git a/packages/server/src/test.setup.ts b/packages/server/src/test.setup.ts\nindex 03c5f63604..a499911886 100644\n--- a/packages/server/src/test.setup.ts\n+++ b/packages/server/src/test.setup.ts\n@@ -98,7 +98,7 @@ export async function createTestProject<T extends StrictTestProjectOptions<T> =\n         user: createReference(client),\n         profile: createReference(client),\n         project: createReference(project),\n-        accessPolicy: accessPolicy && createReference(accessPolicy),\n+        accessPolicy: accessPolicy ? createReference(accessPolicy) : undefined,\n         ...options?.membership,\n       });\n \n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5429",
    "pr_id": 5429,
    "issue_id": 5378,
    "repo": "medplum/medplum",
    "problem_statement": "Cannot add Multiple Codes to Timing.Repeat.When of MedicationRequest\nI wanted to add Multiple codes for When since It is an array of String, But System doesn't allow it.\r\n\r\n**Use Case :** I want to place  a medication request with below details\r\n\r\n- **Frequency :** 3 times a day (TID)\r\n- **Frequency Period :** 1 day\r\n- **When is :** MORN,NOON,NIGHT\r\n\r\n**But when I try to do this, I get below Error Message:**\r\n_Error evaluating invariant expression ({\"fhirpath\":\"offset.empty() or (when.exists() and ((when in ('C' | 'CM' | 'CD' | 'CV')).not()))\",\"error\":{}}) (MedicationRequest.dosageInstruction[0].timing.repeat); Constraint tim-9 not met: If there's an offset, there must be a when (and not C, CM, CD, CV) ({\"fhirpath\":\"offset.empty() or (when.exists() and ((when in ('C' | 'CM' | 'CD' | 'CV')).not()))\"}) (MedicationRequest.dosageInstruction[0].timing.repeat)_\r\n\r\n\r\n### RESOURCE JSON:\r\n\r\n```json\r\n{\r\n  \"resourceType\": \"MedicationRequest\",\r\n  \"medicationCodeableConcept\": {\r\n    \"coding\": [\r\n      {\r\n        \"system\": \"http://www.nlm.nih.gov/research/umls/rxnorm\",\r\n        \"code\": \"123456\",\r\n        \"display\": \"acne\"\r\n      }\r\n    ],\r\n    \"text\": \"acne\"\r\n  },\r\n  \"status\": \"active\",\r\n  \"intent\": \"order\",\r\n  \"dosageInstruction\": [\r\n    {\r\n      \"text\": \"asdfghjkl\",\r\n      \"route\": {\r\n        \"coding\": [\r\n          {\r\n            \"system\": \"http://terminology.hl7.org/CodeSystem/v3-RouteOfAdministration\",\r\n            \"code\": \"PO\",\r\n            \"display\": \"oral\"\r\n          }\r\n        ]\r\n      },\r\n      \"timing\": {\r\n        \"repeat\": {\r\n          \"frequency\": 3,\r\n          \"period\": 1,\r\n          \"periodUnit\": \"d\",\r\n          \"when\": [\r\n            \"MORN\",\r\n            \"NOON\",\r\n            \"NIGHT\"\r\n          ],\r\n          \"dayOfWeek\": [\r\n            \"MON\",\r\n            \"WED\",\r\n            \"FRI\"\r\n          ]\r\n        }\r\n      },\r\n      \"additionalInstruction\": [\r\n        {\r\n          \"coding\": [\r\n            {\r\n              \"system\": \"http://hl7.org/fhir/r4/valueset-additional-instruction-codes\",\r\n              \"code\": \"311501008\",\r\n              \"display\": \"Before Food\"\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    }\r\n  ],\r\n  \"requester\": {\r\n    \"reference\": \"Practitioner/778e1bee-9bba-4cb1-99c8-bdd0e3e0cb54\"\r\n  },\r\n  \"subject\": {\r\n    \"reference\": \"Patient/f91b9d1d-454d-4bed-a545-14e58034f4c6\"\r\n  },\r\n  \"encounter\": {\r\n    \"reference\": \"Encounter/76c703af-8261-424c-9966-4dde387429a4\"\r\n  },\r\n  \"id\": \"07a246f0-d6ce-4c2d-8b65-8d4b41525924\",\r\n  \"meta\": {\r\n    \"project\": \"40da207b-9168-4e6b-990a-8d686ba4cbab\",\r\n    \"compartment\": [\r\n      {\r\n        \"reference\": \"Project/40da207b-9168-4e6b-990a-8d686ba4cbab\"\r\n      },\r\n      {\r\n        \"reference\": \"Patient/f91b9d1d-454d-4bed-a545-14e58034f4c6\"\r\n      }\r\n    ],\r\n    \"versionId\": \"ef814e32-1bfc-4111-8578-72c3c85631f5\",\r\n    \"lastUpdated\": \"2024-10-11T11:32:25.115Z\",\r\n    \"author\": {\r\n      \"reference\": \"Practitioner/778e1bee-9bba-4cb1-99c8-bdd0e3e0cb54\",\r\n      \"display\": \"Vilas Shirodkar\"\r\n    }\r\n  }\r\n}\r\n```",
    "issue_word_count": 287,
    "test_files_count": 1,
    "non_test_files_count": 2,
    "pr_changed_files": [
      "packages/core/src/fhirpath/functions.ts",
      "packages/core/src/typeschema/validation.test.ts",
      "packages/definitions/dist/fhir/r4/profiles-types.json"
    ],
    "pr_changed_test_files": [
      "packages/core/src/typeschema/validation.test.ts"
    ],
    "base_commit": "75533c1704ead9455b543d925d7dd256de9c39ee",
    "head_commit": "ba9274fe9f6be958eb4da45e0c36ed8e2a62e03e",
    "repo_url": "https://github.com/medplum/medplum/pull/5429",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5429",
    "dockerfile": "",
    "pr_merged_at": "2024-10-28T13:48:26.000Z",
    "patch": "diff --git a/packages/core/src/fhirpath/functions.ts b/packages/core/src/fhirpath/functions.ts\nindex 50bf4033e1..b7afbebb5c 100644\n--- a/packages/core/src/fhirpath/functions.ts\n+++ b/packages/core/src/fhirpath/functions.ts\n@@ -311,7 +311,7 @@ export const functions: Record<string, FhirPathFunction> = {\n    * @returns A collection containing only those elements in the input collection for which the stated criteria expression evaluates to true.\n    */\n   select: (context: AtomContext, input: TypedValue[], criteria: Atom): TypedValue[] => {\n-    return input.map((e) => criteria.eval(context, [e])).flat();\n+    return input.map((e) => criteria.eval({ parent: context, variables: { $this: e } }, [e])).flat();\n   },\n \n   /**\n\ndiff --git a/packages/definitions/dist/fhir/r4/profiles-types.json b/packages/definitions/dist/fhir/r4/profiles-types.json\nindex 0046e72fcd..93dbd3f76b 100644\n--- a/packages/definitions/dist/fhir/r4/profiles-types.json\n+++ b/packages/definitions/dist/fhir/r4/profiles-types.json\n@@ -28918,7 +28918,7 @@\n             \"key\" : \"tim-9\",\n             \"severity\" : \"error\",\n             \"human\" : \"If there's an offset, there must be a when (and not C, CM, CD, CV)\",\n-            \"expression\" : \"offset.empty() or (when.exists() and ((when in ('C' | 'CM' | 'CD' | 'CV')).not()))\",\n+            \"expression\" : \"offset.empty() or (when.exists() and when.select($this in ('C' | 'CM' | 'CD' | 'CV')).allFalse())\",\n             \"xpath\" : \"not(exists(f:offset)) or exists(f:when)\"\n           },\n           {\n",
    "test_patch": "diff --git a/packages/core/src/typeschema/validation.test.ts b/packages/core/src/typeschema/validation.test.ts\nindex 464d0219f4..cb813ca80f 100644\n--- a/packages/core/src/typeschema/validation.test.ts\n+++ b/packages/core/src/typeschema/validation.test.ts\n@@ -28,6 +28,7 @@ import {\n   StructureDefinition,\n   StructureDefinitionSnapshot,\n   SubstanceProtein,\n+  Timing,\n   ValueSet,\n } from '@medplum/fhirtypes';\n import { readFileSync } from 'fs';\n@@ -1664,6 +1665,39 @@ describe('FHIR resource validation', () => {\n       'Invalid dateTime format (SubstanceAdministration.effectiveTime[0])'\n     );\n   });\n+\n+  test('Multiple codes in Timing.repeat.when', () => {\n+    // Timing constraint \"tim-9\" had a bug in R4 that prevents multiple codes in \"when\"\n+    // We are fixing by backporting the R5 constraint to R4\n+    // R4 constraint: offset.empty() or (when.exists() and ((when in ('C' | 'CM' | 'CD' | 'CV')).not()))\n+    // R5 constraint: offset.empty() or (when.exists() and when.select($this in ('C' | 'CM' | 'CD' | 'CV')).allFalse())\n+\n+    // As submitted by user\n+    // See: https://github.com/medplum/medplum/issues/5378\n+    const timing1: Timing = {\n+      repeat: {\n+        frequency: 3,\n+        period: 1,\n+        periodUnit: 'd',\n+        when: ['MORN', 'NOON', 'NIGHT'],\n+        dayOfWeek: ['mon', 'wed', 'fri'],\n+      },\n+    };\n+    expect(() => validateTypedValue({ type: 'Timing', value: timing1 })).not.toThrow();\n+\n+    // Make sure that a bad code throws\n+    const timing2: Timing = {\n+      repeat: {\n+        offset: 1,\n+        frequency: 3,\n+        period: 1,\n+        periodUnit: 'd',\n+        when: ['C'],\n+        dayOfWeek: ['mon', 'wed', 'fri'],\n+      },\n+    };\n+    expect(() => validateTypedValue({ type: 'Timing', value: timing2 })).toThrow('Constraint tim-9 not met');\n+  });\n });\n \n function fail(reason: string): never {\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5413",
    "pr_id": 5413,
    "issue_id": 5402,
    "repo": "medplum/medplum",
    "problem_statement": "Add debounce to `useSearch` and related search hooks\nCurrently changing FHIR search query input to these hooks constantly retriggers search without debounce, so the re-render velocity of the search determines how fast searches are sent out",
    "issue_word_count": 37,
    "test_files_count": 3,
    "non_test_files_count": 2,
    "pr_changed_files": [
      "packages/react-hooks/src/useDebouncedValue/useDebouncedValue.ts",
      "packages/react-hooks/src/useSearch/useSearch.test.tsx",
      "packages/react-hooks/src/useSearch/useSearch.ts",
      "packages/react-hooks/src/useSearch/useSearchOne.test.tsx",
      "packages/react-hooks/src/useSearch/useSearchResources.test.tsx"
    ],
    "pr_changed_test_files": [
      "packages/react-hooks/src/useSearch/useSearch.test.tsx",
      "packages/react-hooks/src/useSearch/useSearchOne.test.tsx",
      "packages/react-hooks/src/useSearch/useSearchResources.test.tsx"
    ],
    "base_commit": "38ab55bf3f536a21ab43c7ebed12104abed511d6",
    "head_commit": "c286f60ca870b21d27b467ee4202cdd0a605c1bf",
    "repo_url": "https://github.com/medplum/medplum/pull/5413",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5413",
    "dockerfile": "",
    "pr_merged_at": "2024-10-25T23:32:27.000Z",
    "patch": "diff --git a/packages/react-hooks/src/useDebouncedValue/useDebouncedValue.ts b/packages/react-hooks/src/useDebouncedValue/useDebouncedValue.ts\nnew file mode 100644\nindex 0000000000..624a0a11c1\n--- /dev/null\n+++ b/packages/react-hooks/src/useDebouncedValue/useDebouncedValue.ts\n@@ -0,0 +1,81 @@\n+/*\n+  This hook was forked from: https://github.com/mantinedev/mantine/blob/fbcee929e0b11782092f48c1e7af2a1d1c878823/packages/%40mantine/hooks/src/use-debounced-value/use-debounced-value.ts\n+  and has the following license:\n+\n+  MIT License\n+\n+  Copyright (c) 2021 Vitaly Rtishchev\n+\n+  Permission is hereby granted, free of charge, to any person obtaining a copy\n+  of this software and associated documentation files (the \"Software\"), to deal\n+  in the Software without restriction, including without limitation the rights\n+  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+  copies of the Software, and to permit persons to whom the Software is\n+  furnished to do so, subject to the following conditions:\n+\n+  The above copyright notice and this permission notice shall be included in all\n+  copies or substantial portions of the Software.\n+\n+  THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+  SOFTWARE.\n+*/\n+\n+import { useCallback, useEffect, useRef, useState } from 'react';\n+\n+export type UseDebouncedValueOptions = {\n+  /** Whether the first update to `value` should be immediate or not */\n+  leading?: boolean;\n+};\n+\n+/**\n+ * This hook allows users to debounce an incoming value by a specified number of milliseconds.\n+ *\n+ * Users can also specify whether the first update to `value` in a sequence of rapid updates should be immediate, by specifying `leading: true` in the options.\n+ * The default value for `leading` is `false`.\n+ *\n+ * The return value is a tuple containing the debounced value at `arr[0]` and a function to cancel the pending debounced value change at `arr[1]`.\n+ *\n+ * @param value - The value to debounce.\n+ * @param waitMs - How long in milliseconds should.\n+ * @param options - Optional options for configuring the debounce.\n+ * @returns An array tuple of `[debouncedValue, cancelFn]`.\n+ */\n+export function useDebouncedValue<T = any>(\n+  value: T,\n+  waitMs: number,\n+  options: UseDebouncedValueOptions = { leading: false }\n+): [T, () => void] {\n+  const [debouncedValue, setDebouncedValue] = useState(value);\n+  const mountedRef = useRef(false);\n+  const timeoutRef = useRef<ReturnType<typeof setTimeout>>();\n+  const cooldownRef = useRef(false);\n+\n+  const cancel = useCallback(() => window.clearTimeout(timeoutRef.current), []);\n+\n+  useEffect(() => {\n+    if (mountedRef.current) {\n+      if (!cooldownRef.current && options.leading) {\n+        cooldownRef.current = true;\n+        setDebouncedValue(value);\n+      } else {\n+        cancel();\n+        timeoutRef.current = setTimeout(() => {\n+          cooldownRef.current = false;\n+          setDebouncedValue(value);\n+        }, waitMs);\n+      }\n+    }\n+  }, [value, options.leading, waitMs, cancel]);\n+\n+  useEffect(() => {\n+    mountedRef.current = true;\n+    return cancel;\n+  }, [cancel]);\n+\n+  return [debouncedValue, cancel] as const;\n+}\n\ndiff --git a/packages/react-hooks/src/useSearch/useSearch.ts b/packages/react-hooks/src/useSearch/useSearch.ts\nindex e0c65afc61..30871a5306 100644\n--- a/packages/react-hooks/src/useSearch/useSearch.ts\n+++ b/packages/react-hooks/src/useSearch/useSearch.ts\n@@ -2,8 +2,12 @@ import { allOk, normalizeOperationOutcome, QueryTypes, ResourceArray } from '@me\n import { Bundle, ExtractResource, OperationOutcome, ResourceType } from '@medplum/fhirtypes';\n import { useEffect, useState } from 'react';\n import { useMedplum } from '../MedplumProvider/MedplumProvider.context';\n+import { useDebouncedValue } from '../useDebouncedValue/useDebouncedValue';\n \n type SearchFn = 'search' | 'searchOne' | 'searchResources';\n+export type SearchOptions = { debounceMs?: number };\n+\n+const DEFAULT_DEBOUNCE_MS = 250;\n \n /**\n  * React hook for searching FHIR resources.\n@@ -12,13 +16,15 @@ type SearchFn = 'search' | 'searchOne' | 'searchResources';\n  *\n  * @param resourceType - The FHIR resource type to search.\n  * @param query - Optional search parameters.\n+ * @param options - Optional options for configuring the search.\n  * @returns A 3-element tuple containing the search result, loading flag, and operation outcome.\n  */\n export function useSearch<K extends ResourceType>(\n   resourceType: K,\n-  query?: QueryTypes\n+  query?: QueryTypes,\n+  options?: SearchOptions\n ): [Bundle<ExtractResource<K>> | undefined, boolean, OperationOutcome | undefined] {\n-  return useSearchImpl<K, Bundle<ExtractResource<K>>>('search', resourceType, query);\n+  return useSearchImpl<K, Bundle<ExtractResource<K>>>('search', resourceType, query, options);\n }\n \n /**\n@@ -28,13 +34,15 @@ export function useSearch<K extends ResourceType>(\n  *\n  * @param resourceType - The FHIR resource type to search.\n  * @param query - Optional search parameters.\n+ * @param options - Optional options for configuring the search.\n  * @returns A 3-element tuple containing the search result, loading flag, and operation outcome.\n  */\n export function useSearchOne<K extends ResourceType>(\n   resourceType: K,\n-  query?: QueryTypes\n+  query?: QueryTypes,\n+  options?: SearchOptions\n ): [ExtractResource<K> | undefined, boolean, OperationOutcome | undefined] {\n-  return useSearchImpl<K, ExtractResource<K>>('searchOne', resourceType, query);\n+  return useSearchImpl<K, ExtractResource<K>>('searchOne', resourceType, query, options);\n }\n \n /**\n@@ -44,34 +52,41 @@ export function useSearchOne<K extends ResourceType>(\n  *\n  * @param resourceType - The FHIR resource type to search.\n  * @param query - Optional search parameters.\n+ * @param options - Optional options for configuring the search.\n  * @returns A 3-element tuple containing the search result, loading flag, and operation outcome.\n  */\n export function useSearchResources<K extends ResourceType>(\n   resourceType: K,\n-  query?: QueryTypes\n+  query?: QueryTypes,\n+  options?: SearchOptions\n ): [ResourceArray<ExtractResource<K>> | undefined, boolean, OperationOutcome | undefined] {\n-  return useSearchImpl<K, ResourceArray<ExtractResource<K>>>('searchResources', resourceType, query);\n+  return useSearchImpl<K, ResourceArray<ExtractResource<K>>>('searchResources', resourceType, query, options);\n }\n \n-function useSearchImpl<K extends ResourceType, ReturnType>(\n+function useSearchImpl<K extends ResourceType, SearchReturnType>(\n   searchFn: SearchFn,\n   resourceType: K,\n-  query: QueryTypes | undefined\n-): [ReturnType | undefined, boolean, OperationOutcome | undefined] {\n+  query: QueryTypes | undefined,\n+  options?: SearchOptions\n+): [SearchReturnType | undefined, boolean, OperationOutcome | undefined] {\n   const medplum = useMedplum();\n-  const [searchKey, setSearchKey] = useState<string>();\n+  const [lastSearchKey, setLastSearchKey] = useState<string>();\n   const [loading, setLoading] = useState<boolean>(true);\n-  const [result, setResult] = useState<ReturnType>();\n+  const [result, setResult] = useState<SearchReturnType>();\n   const [outcome, setOutcome] = useState<OperationOutcome>();\n \n+  const searchKey = medplum.fhirSearchUrl(resourceType, query).toString();\n+  const [debouncedSearchKey] = useDebouncedValue(searchKey, options?.debounceMs ?? DEFAULT_DEBOUNCE_MS, {\n+    leading: true,\n+  });\n+\n   useEffect(() => {\n-    const key = medplum.fhirSearchUrl(resourceType, query).toString();\n-    if (key !== searchKey) {\n-      setSearchKey(key);\n+    if (debouncedSearchKey !== lastSearchKey) {\n+      setLastSearchKey(debouncedSearchKey);\n       medplum[searchFn](resourceType, query)\n         .then((res) => {\n           setLoading(false);\n-          setResult(res as ReturnType);\n+          setResult(res as SearchReturnType);\n           setOutcome(allOk);\n         })\n         .catch((err) => {\n@@ -80,7 +95,7 @@ function useSearchImpl<K extends ResourceType, ReturnType>(\n           setOutcome(normalizeOperationOutcome(err));\n         });\n     }\n-  }, [medplum, searchFn, resourceType, query, searchKey]);\n+  }, [medplum, searchFn, resourceType, query, lastSearchKey, debouncedSearchKey]);\n \n   return [result, loading, outcome];\n }\n",
    "test_patch": "diff --git a/packages/react-hooks/src/useSearch/useSearch.test.tsx b/packages/react-hooks/src/useSearch/useSearch.test.tsx\nindex 70c6c9eeb5..27bd56c0e8 100644\n--- a/packages/react-hooks/src/useSearch/useSearch.test.tsx\n+++ b/packages/react-hooks/src/useSearch/useSearch.test.tsx\n@@ -1,6 +1,6 @@\n-import { operationOutcomeToString } from '@medplum/core';\n+import { allOk, operationOutcomeToString, sleep } from '@medplum/core';\n import { MockClient } from '@medplum/mock';\n-import { act, render, screen } from '@testing-library/react';\n+import { act, render, renderHook, screen } from '@testing-library/react';\n import { ReactNode } from 'react';\n import { MemoryRouter } from 'react-router-dom';\n import { MedplumProvider } from '../MedplumProvider/MedplumProvider';\n@@ -44,4 +44,44 @@ describe('useSearch hooks', () => {\n     expect(bundle.resourceType).toBe('Bundle');\n     expect(bundle.entry).toHaveLength(1);\n   });\n+\n+  test('Debounced search', async () => {\n+    const medplum = new MockClient();\n+    const medplumSearch = jest.spyOn(medplum, 'search');\n+\n+    const { result, rerender } = renderHook(\n+      (props) => useSearch('Patient', { name: props.name }, { debounceMs: 150 }),\n+      {\n+        initialProps: { name: 'bart' },\n+        wrapper: ({ children }) => <MedplumProvider medplum={medplum}>{children}</MedplumProvider>,\n+      }\n+    );\n+\n+    // Check until useSearch is no longer loading\n+    while (result.current[1]) {\n+      await sleep(0);\n+    }\n+\n+    expect(result.current[0]?.resourceType).toEqual('Bundle');\n+    expect(result.current[0]?.entry).toHaveLength(1);\n+    expect(result.current[1]).toEqual(false);\n+    expect(result.current[2]).toEqual(allOk);\n+    expect(medplumSearch).toHaveBeenCalledTimes(1);\n+\n+    rerender({ name: 'marge' });\n+    expect(medplumSearch).toHaveBeenCalledTimes(2);\n+    rerender({ name: 'home' });\n+    expect(medplumSearch).toHaveBeenCalledTimes(2);\n+    rerender({ name: 'homer' });\n+    expect(medplumSearch).toHaveBeenCalledTimes(2);\n+\n+    // Wait for debounce to time out\n+    await sleep(300);\n+    expect(medplumSearch).toHaveBeenLastCalledWith('Patient', { name: 'homer' });\n+    expect(medplumSearch).toHaveBeenCalledTimes(3);\n+    expect(result.current[0]?.resourceType).toEqual('Bundle');\n+    expect(result.current[0]?.entry).toHaveLength(1);\n+    expect(result.current[1]).toEqual(false);\n+    expect(result.current[2]).toEqual(allOk);\n+  });\n });\n\ndiff --git a/packages/react-hooks/src/useSearch/useSearchOne.test.tsx b/packages/react-hooks/src/useSearch/useSearchOne.test.tsx\nindex 3fd60d0685..db90632e69 100644\n--- a/packages/react-hooks/src/useSearch/useSearchOne.test.tsx\n+++ b/packages/react-hooks/src/useSearch/useSearchOne.test.tsx\n@@ -1,6 +1,6 @@\n-import { operationOutcomeToString } from '@medplum/core';\n+import { allOk, operationOutcomeToString, sleep } from '@medplum/core';\n import { MockClient } from '@medplum/mock';\n-import { act, render, screen } from '@testing-library/react';\n+import { act, render, renderHook, screen } from '@testing-library/react';\n import { ReactNode } from 'react';\n import { MemoryRouter } from 'react-router-dom';\n import { MedplumProvider } from '../MedplumProvider/MedplumProvider';\n@@ -43,4 +43,44 @@ describe('useSearch hooks', () => {\n     const patient = JSON.parse(el.innerHTML);\n     expect(patient?.resourceType).toBe('Patient');\n   });\n+\n+  test('Debounced search', async () => {\n+    const medplum = new MockClient();\n+    const medplumSearchOne = jest.spyOn(medplum, 'searchOne');\n+\n+    const { result, rerender } = renderHook(\n+      (props) => useSearchOne('Patient', { name: props.name }, { debounceMs: 150 }),\n+      {\n+        initialProps: { name: 'bart' },\n+        wrapper: ({ children }) => <MedplumProvider medplum={medplum}>{children}</MedplumProvider>,\n+      }\n+    );\n+\n+    // Check until useSearch is no longer loading\n+    while (result.current[1]) {\n+      await sleep(0);\n+    }\n+\n+    expect(result.current[0]?.resourceType).toEqual('Patient');\n+    expect(result.current[0]?.name).toEqual([{ given: ['Bart'], family: 'Simpson' }]);\n+    expect(result.current[1]).toEqual(false);\n+    expect(result.current[2]).toEqual(allOk);\n+    expect(medplumSearchOne).toHaveBeenCalledTimes(1);\n+\n+    rerender({ name: 'marge' });\n+    expect(medplumSearchOne).toHaveBeenCalledTimes(2);\n+    rerender({ name: 'home' });\n+    expect(medplumSearchOne).toHaveBeenCalledTimes(2);\n+    rerender({ name: 'homer' });\n+    expect(medplumSearchOne).toHaveBeenCalledTimes(2);\n+\n+    // Wait for debounce to time out\n+    await sleep(300);\n+    expect(medplumSearchOne).toHaveBeenLastCalledWith('Patient', { name: 'homer' });\n+    expect(medplumSearchOne).toHaveBeenCalledTimes(3);\n+    expect(result.current[0]?.resourceType).toEqual('Patient');\n+    expect(result.current[0]?.name).toEqual([{ given: ['Homer'], family: 'Simpson' }]);\n+    expect(result.current[1]).toEqual(false);\n+    expect(result.current[2]).toEqual(allOk);\n+  });\n });\n\ndiff --git a/packages/react-hooks/src/useSearch/useSearchResources.test.tsx b/packages/react-hooks/src/useSearch/useSearchResources.test.tsx\nindex 1c1f9cef8e..281afdfe75 100644\n--- a/packages/react-hooks/src/useSearch/useSearchResources.test.tsx\n+++ b/packages/react-hooks/src/useSearch/useSearchResources.test.tsx\n@@ -1,7 +1,7 @@\n-import { operationOutcomeToString } from '@medplum/core';\n+import { allOk, operationOutcomeToString, sleep } from '@medplum/core';\n import { Patient } from '@medplum/fhirtypes';\n import { MockClient } from '@medplum/mock';\n-import { act, render, screen } from '@testing-library/react';\n+import { act, render, renderHook, screen } from '@testing-library/react';\n import { ReactNode } from 'react';\n import { MemoryRouter } from 'react-router-dom';\n import { MedplumProvider } from '../MedplumProvider/MedplumProvider';\n@@ -45,4 +45,46 @@ describe('useSearch hooks', () => {\n     expect(Array.isArray(resources)).toBe(true);\n     expect(resources as Patient[]).toHaveLength(1);\n   });\n+\n+  test('Debounced search', async () => {\n+    const medplum = new MockClient();\n+    const medplumSearchResources = jest.spyOn(medplum, 'searchResources');\n+\n+    const { result, rerender } = renderHook(\n+      (props) => useSearchResources('Patient', { name: props.name }, { debounceMs: 150 }),\n+      {\n+        initialProps: { name: 'bart' },\n+        wrapper: ({ children }) => <MedplumProvider medplum={medplum}>{children}</MedplumProvider>,\n+      }\n+    );\n+\n+    // Check until useSearch is no longer loading\n+    while (result.current[1]) {\n+      await sleep(0);\n+    }\n+\n+    expect(result.current[0]).toHaveLength(1);\n+    expect(result.current[0]?.[0]?.resourceType).toEqual('Patient');\n+    expect(result.current[0]?.[0]?.name).toEqual([{ given: ['Bart'], family: 'Simpson' }]);\n+    expect(result.current[1]).toEqual(false);\n+    expect(result.current[2]).toEqual(allOk);\n+    expect(medplumSearchResources).toHaveBeenCalledTimes(1);\n+\n+    rerender({ name: 'marge' });\n+    expect(medplumSearchResources).toHaveBeenCalledTimes(2);\n+    rerender({ name: 'home' });\n+    expect(medplumSearchResources).toHaveBeenCalledTimes(2);\n+    rerender({ name: 'homer' });\n+    expect(medplumSearchResources).toHaveBeenCalledTimes(2);\n+\n+    // Wait for debounce to time out\n+    await sleep(300);\n+    expect(medplumSearchResources).toHaveBeenLastCalledWith('Patient', { name: 'homer' });\n+    expect(medplumSearchResources).toHaveBeenCalledTimes(3);\n+    expect(result.current[0]).toHaveLength(1);\n+    expect(result.current[0]?.[0]?.resourceType).toEqual('Patient');\n+    expect(result.current[0]?.[0]?.name).toEqual([{ given: ['Homer'], family: 'Simpson' }]);\n+    expect(result.current[1]).toEqual(false);\n+    expect(result.current[2]).toEqual(allOk);\n+  });\n });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5366",
    "pr_id": 5366,
    "issue_id": 5356,
    "repo": "medplum/medplum",
    "problem_statement": "Allow using STU3 URLs for FHIRcast\nWe are trying to utilize the medplum client to interact with a third party fhircast hub which implements the STU3 spec where the hub topic can be defined in the body instead of being required on the url itself: https://hl7.org/fhir/uv/fhircast/2024May/2-6-RequestContextChange.html#request-context-change-example. Currently having to manually override the url:\r\n\r\n```\r\n  const { fetch: originalFetch } = window;\r\n\r\n  window.fetch = async (...args) => {\r\n    let [resource] = args;\r\n\r\n    return await originalFetch(\r\n      resource.toString().replace(\"fhircast/STU3\", fhircastPrefix)\r\n    );\r\n  };\r\n```\r\n\r\nThis should be supported if Medplum plans on supporting FHIR cast STU3: https://www.medplum.com/docs/fhircast. If this is already on the road map, apologies!",
    "issue_word_count": 114,
    "test_files_count": 3,
    "non_test_files_count": 3,
    "pr_changed_files": [
      "packages/core/src/client-fhircast.test.ts",
      "packages/core/src/client.test.ts",
      "packages/core/src/client.ts",
      "packages/server/src/fhir/outcomes.ts",
      "packages/server/src/fhircast/routes.test.ts",
      "packages/server/src/fhircast/routes.ts"
    ],
    "pr_changed_test_files": [
      "packages/core/src/client-fhircast.test.ts",
      "packages/core/src/client.test.ts",
      "packages/server/src/fhircast/routes.test.ts"
    ],
    "base_commit": "4b60d754ad709d30321cdebb4cac36cb61315985",
    "head_commit": "039670b496f16b031eb9dbe39a7bcba636fa239b",
    "repo_url": "https://github.com/medplum/medplum/pull/5366",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5366",
    "dockerfile": "",
    "pr_merged_at": "2024-10-10T18:11:04.000Z",
    "patch": "diff --git a/packages/core/src/client.ts b/packages/core/src/client.ts\nindex 01b47ffd34..1ba7541078 100644\n--- a/packages/core/src/client.ts\n+++ b/packages/core/src/client.ts\n@@ -168,6 +168,17 @@ export interface MedplumClientOptions {\n    */\n   logoutUrl?: string;\n \n+  /**\n+   * FHIRcast Hub URL.\n+   *\n+   * Default value is `fhircast/STU3`.\n+   *\n+   * Can be specified as absolute URL or relative to `baseUrl`.\n+   *\n+   * Use this if you want to use a different path when connecting to a FHIRcast hub.\n+   */\n+  fhircastHubUrl?: string;\n+\n   /**\n    * The client ID.\n    *\n@@ -780,6 +791,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n   private readonly authorizeUrl: string;\n   private readonly tokenUrl: string;\n   private readonly logoutUrl: string;\n+  private readonly fhircastHubUrl: string;\n   private readonly onUnauthenticated?: () => void;\n   private readonly autoBatchTime: number;\n   private readonly autoBatchQueue: AutoBatchEntry[] | undefined;\n@@ -818,6 +830,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n     this.authorizeUrl = concatUrls(this.baseUrl, options?.authorizeUrl ?? 'oauth2/authorize');\n     this.tokenUrl = concatUrls(this.baseUrl, options?.tokenUrl ?? 'oauth2/token');\n     this.logoutUrl = concatUrls(this.baseUrl, options?.logoutUrl ?? 'oauth2/logout');\n+    this.fhircastHubUrl = concatUrls(this.baseUrl, options?.fhircastHubUrl ?? 'fhircast/STU3');\n     this.clientId = options?.clientId ?? '';\n     this.clientSecret = options?.clientSecret ?? '';\n     this.onUnauthenticated = options?.onUnauthenticated;\n@@ -938,6 +951,17 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n     return this.logoutUrl;\n   }\n \n+  /**\n+   * Returns the current FHIRcast Hub URL.\n+   * By default, this is set to `https://api.medplum.com/fhircast/STU3`.\n+   * This can be overridden by setting the `logoutUrl` option when creating the client.\n+   * @category HTTP\n+   * @returns The current FHIRcast Hub URL.\n+   */\n+  getFhircastHubUrl(): string {\n+    return this.fhircastHubUrl;\n+  }\n+\n   /**\n    * Clears all auth state including local storage and session storage.\n    * @category Authentication\n@@ -3618,7 +3642,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n     } as PendingSubscriptionRequest;\n \n     const body = (await this.post(\n-      '/fhircast/STU3',\n+      this.fhircastHubUrl,\n       serializeFhircastSubscriptionRequest(subRequest),\n       ContentType.FORM_URL_ENCODED\n     )) as { 'hub.channel.endpoint': string };\n@@ -3655,7 +3679,11 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n     // Turn subRequest -> unsubRequest\n     subRequest.mode = 'unsubscribe';\n     // Send unsub request\n-    await this.post('/fhircast/STU3', serializeFhircastSubscriptionRequest(subRequest), ContentType.FORM_URL_ENCODED);\n+    await this.post(\n+      this.fhircastHubUrl,\n+      serializeFhircastSubscriptionRequest(subRequest),\n+      ContentType.FORM_URL_ENCODED\n+    );\n   }\n \n   /**\n@@ -3701,14 +3729,14 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n   ): Promise<Record<string, any>> {\n     if (isContextVersionRequired(event)) {\n       return this.post(\n-        `/fhircast/STU3/${topic}`,\n+        this.fhircastHubUrl,\n         createFhircastMessagePayload<typeof event>(topic, event, context, versionId as string),\n         ContentType.JSON\n       );\n     }\n     assertContextVersionOptional(event);\n     return this.post(\n-      `/fhircast/STU3/${topic}`,\n+      this.fhircastHubUrl,\n       createFhircastMessagePayload<typeof event>(topic, event, context),\n       ContentType.JSON\n     );\n@@ -3722,7 +3750,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @returns A Promise which resolves to the `CurrentContext` for the given topic.\n    */\n   async fhircastGetContext(topic: string): Promise<CurrentContext> {\n-    return this.get(`/fhircast/STU3/${topic}`);\n+    return this.get(`${this.fhircastHubUrl}/${topic}`);\n   }\n \n   /**\n\ndiff --git a/packages/server/src/fhir/outcomes.ts b/packages/server/src/fhir/outcomes.ts\nindex b39bbdbd75..b5f4d21acb 100644\n--- a/packages/server/src/fhir/outcomes.ts\n+++ b/packages/server/src/fhir/outcomes.ts\n@@ -1,20 +1,28 @@\n import { getStatus, isAccepted } from '@medplum/core';\n import { OperationOutcome } from '@medplum/fhirtypes';\n-import { randomUUID } from 'crypto';\n import { Response } from 'express';\n import { Result, ValidationError } from 'express-validator';\n+import { randomUUID } from 'node:crypto';\n import { buildTracingExtension } from '../context';\n \n export function invalidRequest(errors: Result<ValidationError>): OperationOutcome {\n   return {\n     resourceType: 'OperationOutcome',\n     id: randomUUID(),\n-    issue: errors.array().map((error) => ({\n-      severity: 'error',\n-      code: 'invalid',\n-      expression: getValidationErrorExpression(error),\n-      details: { text: error.msg },\n-    })),\n+    issue: errors\n+      .array()\n+      .flatMap((error) => {\n+        if (error.type === 'alternative') {\n+          return error.nestedErrors;\n+        }\n+        return error;\n+      })\n+      .map((error) => ({\n+        severity: 'error',\n+        code: 'invalid',\n+        expression: getValidationErrorExpression(error),\n+        details: { text: error.msg },\n+      })),\n   };\n }\n \n\ndiff --git a/packages/server/src/fhircast/routes.ts b/packages/server/src/fhircast/routes.ts\nindex 4e03cc3bcf..f3da9af453 100644\n--- a/packages/server/src/fhircast/routes.ts\n+++ b/packages/server/src/fhircast/routes.ts\n@@ -7,7 +7,7 @@ import {\n   normalizeErrorString,\n } from '@medplum/core';\n import { Request, Response, Router } from 'express';\n-import { body, validationResult } from 'express-validator';\n+import { body, oneOf, validationResult } from 'express-validator';\n import { asyncWrap } from '../async';\n import { getConfig } from '../config';\n import { getLogger } from '../context';\n@@ -71,14 +71,29 @@ publicSTU3Routes.get('/.well-known/fhircast-configuration', (_req: Request, res:\n });\n \n // Register a new subscription\n+// Or publish an event depending on payload\n+// See: https://hl7.org/fhir/uv/fhircast/2024May/2-6-RequestContextChange.html#:~:text=Similar%20to%20the%20Hub%E2%80%99s%20notifications%20to%20the%20Subscriber%2C%20the%20Subscriber%20MAY%20request%20context%20changes%20with%20an%20HTTP%20POST%20to%20the%20hub.url\n protectedCommonRoutes.post(\n   '/',\n-  [\n-    body('hub.channel.type').notEmpty().withMessage('Missing hub.channel.type'),\n-    body('hub.mode').notEmpty().withMessage('Missing hub.mode'),\n-    body('hub.topic').notEmpty().withMessage('Missing hub.topic'),\n-    body('hub.events').notEmpty().withMessage('Missing hub.events'),\n-  ],\n+  oneOf(\n+    [\n+      [\n+        body('id').notEmpty().withMessage('Missing event ID'),\n+        body('timestamp').notEmpty().withMessage('Missing event timestamp'),\n+        body('event').notEmpty().withMessage('Missing event payload'),\n+        body('event[\"hub.topic\"]').notEmpty().withMessage('Missing event[\"hub.topic\"]'),\n+        body('event[\"hub.event\"]').notEmpty().withMessage('Missing event[\"hub.event\"]'),\n+        body('event.context').notEmpty().withMessage('Missing event.context'),\n+      ],\n+      [\n+        body('hub.channel.type').notEmpty().withMessage('Missing hub.channel.type'),\n+        body('hub.mode').notEmpty().withMessage('Missing hub.mode'),\n+        body('hub.topic').notEmpty().withMessage('Missing hub.topic'),\n+        body('hub.events').notEmpty().withMessage('Missing hub.events'),\n+      ],\n+    ],\n+    { errorType: 'least_errored' }\n+  ),\n   asyncWrap(async (req: Request, res: Response) => {\n     const errors = validationResult(req);\n     if (!errors.isEmpty()) {\n@@ -86,50 +101,13 @@ protectedCommonRoutes.post(\n       return;\n     }\n \n-    const type = req.body['hub.channel.type'];\n-    if (type !== 'websocket') {\n-      sendOutcome(res, badRequest('Invalid hub.channel.type'));\n-      return;\n-    }\n-\n-    const mode = req.body['hub.mode'] as 'subscribe' | 'unsubscribe';\n-    if (!(['subscribe', 'unsubscribe'] as const).includes(mode)) {\n-      sendOutcome(res, badRequest('Invalid hub.mode'));\n+    // If there is an ID, this is a context change request\n+    if (req.body.id) {\n+      await handleContextChangeRequest(req, res);\n       return;\n     }\n-\n-    const topic = req.body['hub.topic'];\n-    const subscriptionEndpoint = topic; // TODO: Create separate subscription endpoint for topic\n-    const config = getConfig();\n-\n-    switch (mode) {\n-      case 'subscribe':\n-        res.status(202).json({\n-          'hub.channel.endpoint': getWebSocketUrl(config.baseUrl, `/ws/fhircast/${subscriptionEndpoint}`),\n-        });\n-        break;\n-      case 'unsubscribe':\n-        res.status(202).json({\n-          'hub.channel.endpoint': getWebSocketUrl(config.baseUrl, `/ws/fhircast/${subscriptionEndpoint}`),\n-        });\n-        getRedis()\n-          .publish(\n-            topic,\n-            JSON.stringify({\n-              'hub.mode': 'denied',\n-              'hub.topic': topic,\n-              'hub.events': req.body['hub.events'],\n-              'hub.reason': 'Subscriber unsubscribed from topic',\n-            })\n-          )\n-          .catch((err: Error) => {\n-            getLogger().error(\n-              `Error when publishing to Redis channel for FHIRcast topic: ${normalizeErrorString(err)}`,\n-              { topic }\n-            );\n-          });\n-        break;\n-    }\n+    // Otherwise it has to be a subscription request\n+    await handleSubscriptionRequest(req, res);\n   })\n );\n \n@@ -140,6 +118,9 @@ protectedCommonRoutes.post(\n     body('id').notEmpty().withMessage('Missing event ID'),\n     body('timestamp').notEmpty().withMessage('Missing event timestamp'),\n     body('event').notEmpty().withMessage('Missing event payload'),\n+    body('event[\"hub.topic\"]').notEmpty().withMessage('Missing event[\"hub.topic\"]'),\n+    body('event[\"hub.event\"]').notEmpty().withMessage('Missing event[\"hub.event\"]'),\n+    body('event.context').notEmpty().withMessage('Missing event.context'),\n   ],\n   asyncWrap(async (req: Request, res: Response) => {\n     const errors = validationResult(req);\n@@ -147,33 +128,82 @@ protectedCommonRoutes.post(\n       sendOutcome(res, invalidRequest(errors));\n       return;\n     }\n+    await handleContextChangeRequest(req, res);\n+  })\n+);\n \n-    const { event } = req.body as FhircastMessagePayload;\n-    let stringifiedBody = JSON.stringify(req.body);\n-    // Check if this an open event\n-    if (event['hub.event'].endsWith('-open')) {\n-      // TODO: Support this as a param for event type: \"versionable\"?\n-      if (event['hub.event'] === 'DiagnosticReport-open') {\n-        event['context.versionId'] = generateId();\n-        stringifiedBody = JSON.stringify(req.body);\n-      }\n-      // TODO: we need to get topic from event and not route param since per spec, the topic shouldn't be the slug like we have it\n-      await getRedis().set(`medplum:fhircast:topic:${req.params.topic}:latest`, stringifiedBody);\n-    } else if (event['hub.event'].endsWith('-close')) {\n-      // We always close the current context, even if the event is not for the original resource... There isn't any mention of checking to see it's the right resource, so it seems it may be assumed to be always valid to do any arbitrary close as long as there is an existing context...\n-      await getRedis().del(`medplum:fhircast:topic:${req.params.topic}:latest`);\n-    } else if (event['hub.event'] === 'DiagnosticReport-update') {\n-      // See: https://build.fhir.org/ig/HL7/fhircast-docs/3-6-3-DiagnosticReport-update.html#:~:text=The%20Hub%20SHALL,the%20new%20updates.\n-      event['context.priorVersionId'] = event['context.versionId'];\n+async function handleSubscriptionRequest(req: Request, res: Response): Promise<void> {\n+  const type = req.body['hub.channel.type'];\n+  if (type !== 'websocket') {\n+    sendOutcome(res, badRequest('Invalid hub.channel.type'));\n+    return;\n+  }\n+\n+  const mode = req.body['hub.mode'] as 'subscribe' | 'unsubscribe';\n+  if (!(['subscribe', 'unsubscribe'] as const).includes(mode)) {\n+    sendOutcome(res, badRequest('Invalid hub.mode'));\n+    return;\n+  }\n+\n+  const topic = req.body['hub.topic'];\n+  const subscriptionEndpoint = topic; // TODO: Create separate subscription endpoint for topic\n+  const config = getConfig();\n+\n+  switch (mode) {\n+    case 'subscribe':\n+      res.status(202).json({\n+        'hub.channel.endpoint': getWebSocketUrl(config.baseUrl, `/ws/fhircast/${subscriptionEndpoint}`),\n+      });\n+      break;\n+    case 'unsubscribe':\n+      res.status(202).json({\n+        'hub.channel.endpoint': getWebSocketUrl(config.baseUrl, `/ws/fhircast/${subscriptionEndpoint}`),\n+      });\n+      getRedis()\n+        .publish(\n+          topic,\n+          JSON.stringify({\n+            'hub.mode': 'denied',\n+            'hub.topic': topic,\n+            'hub.events': req.body['hub.events'],\n+            'hub.reason': 'Subscriber unsubscribed from topic',\n+          })\n+        )\n+        .catch((err: Error) => {\n+          getLogger().error(`Error when publishing to Redis channel for FHIRcast topic: ${normalizeErrorString(err)}`, {\n+            topic,\n+          });\n+        });\n+    // break;\n+  }\n+}\n+\n+async function handleContextChangeRequest(req: Request, res: Response): Promise<void> {\n+  const { event } = req.body as FhircastMessagePayload;\n+  let stringifiedBody = JSON.stringify(req.body);\n+  // Check if this an open event\n+  if (event['hub.event'].endsWith('-open')) {\n+    // TODO: Support this as a param for event type: \"versionable\"?\n+    if (event['hub.event'] === 'DiagnosticReport-open') {\n       event['context.versionId'] = generateId();\n       stringifiedBody = JSON.stringify(req.body);\n-      // TODO: Make sure this is actually supposed to be stored / overwrite open context? (ambiguous from docs, see: https://build.fhir.org/ig/HL7/fhircast-docs/2-9-GetCurrentContext.html)\n-      await getRedis().set(`medplum:fhircast:topic:${req.params.topic}:latest`, stringifiedBody);\n     }\n-    await getRedis().publish(req.params.topic as string, stringifiedBody);\n-    res.status(201).json({ success: true, event: body });\n-  })\n-);\n+    // TODO: we need to get topic from event and not route param since per spec, the topic shouldn't be the slug like we have it\n+    await getRedis().set(`medplum:fhircast:topic:${event['hub.topic']}:latest`, stringifiedBody);\n+  } else if (event['hub.event'].endsWith('-close')) {\n+    // We always close the current context, even if the event is not for the original resource... There isn't any mention of checking to see it's the right resource, so it seems it may be assumed to be always valid to do any arbitrary close as long as there is an existing context...\n+    await getRedis().del(`medplum:fhircast:topic:${event['hub.topic']}:latest`);\n+  } else if (event['hub.event'] === 'DiagnosticReport-update') {\n+    // See: https://build.fhir.org/ig/HL7/fhircast-docs/3-6-3-DiagnosticReport-update.html#:~:text=The%20Hub%20SHALL,the%20new%20updates.\n+    event['context.priorVersionId'] = event['context.versionId'];\n+    event['context.versionId'] = generateId();\n+    stringifiedBody = JSON.stringify(req.body);\n+    // TODO: Make sure this is actually supposed to be stored / overwrite open context? (ambiguous from docs, see: https://build.fhir.org/ig/HL7/fhircast-docs/2-9-GetCurrentContext.html)\n+    await getRedis().set(`medplum:fhircast:topic:${event['hub.topic']}:latest`, stringifiedBody);\n+  }\n+  await getRedis().publish(event['hub.topic'], stringifiedBody);\n+  res.status(201).json({ success: true, event: body });\n+}\n \n // Get the current subscription status\n protectedSTU2Routes.get(\n",
    "test_patch": "diff --git a/packages/core/src/client-fhircast.test.ts b/packages/core/src/client-fhircast.test.ts\nindex 2485e992c8..9f012868f9 100644\n--- a/packages/core/src/client-fhircast.test.ts\n+++ b/packages/core/src/client-fhircast.test.ts\n@@ -169,11 +169,11 @@ describe('FHIRcast', () => {\n       const client = new MedplumClient({ fetch });\n       await expect(client.fhircastPublish('abc123', 'Patient-open', context)).resolves.toBeDefined();\n       expect(fetch).toHaveBeenCalledWith(\n-        'https://api.medplum.com/fhircast/STU3/abc123',\n+        'https://api.medplum.com/fhircast/STU3',\n         expect.objectContaining<RequestInit>({\n           method: 'POST',\n           headers: expect.objectContaining({ 'Content-Type': ContentType.JSON }),\n-          body: expect.any(String),\n+          body: expect.stringContaining('\"hub.topic\":\"abc123\"'),\n         })\n       );\n \n@@ -185,11 +185,11 @@ describe('FHIRcast', () => {\n         ])\n       ).resolves.toBeDefined();\n       expect(fetch).toHaveBeenCalledWith(\n-        'https://api.medplum.com/fhircast/STU3/def456',\n+        'https://api.medplum.com/fhircast/STU3',\n         expect.objectContaining<RequestInit>({\n           method: 'POST',\n           headers: expect.objectContaining({ 'Content-Type': ContentType.JSON }),\n-          body: expect.any(String),\n+          body: expect.stringContaining('\"hub.topic\":\"def456\"'),\n         })\n       );\n \n@@ -201,11 +201,11 @@ describe('FHIRcast', () => {\n         ])\n       ).resolves.toBeDefined();\n       expect(fetch).toHaveBeenCalledWith(\n-        'https://api.medplum.com/fhircast/STU3/xyz-789',\n+        'https://api.medplum.com/fhircast/STU3',\n         expect.objectContaining<RequestInit>({\n           method: 'POST',\n           headers: expect.objectContaining({ 'Content-Type': ContentType.JSON }),\n-          body: expect.any(String),\n+          body: expect.stringContaining('\"hub.topic\":\"xyz-789\"'),\n         })\n       );\n     });\n@@ -243,12 +243,28 @@ describe('FHIRcast', () => {\n         )\n       ).rejects.toBeInstanceOf(OperationOutcomeError);\n     });\n+\n+    test('Setting `fhircastHubUrl`', async () => {\n+      const context = createFhircastMessageContext<'Patient-open'>('patient', 'Patient', 'patient-123');\n+      const fetch = mockFetch(201, { success: true, event: context });\n+      const client = new MedplumClient({ fetch, fhircastHubUrl: 'http://example.com/foo/hub' });\n+      await expect(client.fhircastPublish('abc123', 'Patient-open', context)).resolves.toBeDefined();\n+      expect(fetch).toHaveBeenCalledWith(\n+        'http://example.com/foo/hub',\n+        expect.objectContaining<RequestInit>({\n+          method: 'POST',\n+          headers: expect.objectContaining({ 'Content-Type': ContentType.JSON }),\n+          body: expect.stringContaining('\"hub.topic\":\"abc123\"'),\n+        })\n+      );\n+    });\n   });\n \n   describe('fhircastGetContext', () => {\n     let client: MedplumClient;\n     let topic: string;\n     let topicContext: CurrentContext<'DiagnosticReport-open'>;\n+    let medplumGetSpy: jest.SpyInstance;\n \n     beforeAll(() => {\n       topic = generateId();\n@@ -265,14 +281,17 @@ describe('FHIRcast', () => {\n         }\n       });\n       client = new MedplumClient({ fetch });\n+      medplumGetSpy = jest.spyOn(client, 'get');\n     });\n \n     test('Get context for topic with context', async () => {\n       await expect(client.fhircastGetContext(topic)).resolves.toEqual(topicContext);\n+      expect(medplumGetSpy).toHaveBeenCalledWith(`https://api.medplum.com/fhircast/STU3/${topic}`);\n     });\n \n     test('Get context for topic without context', async () => {\n       await expect(client.fhircastGetContext('abc-123')).resolves.toEqual({ 'context.type': '', context: [] });\n+      expect(medplumGetSpy).toHaveBeenCalledWith('https://api.medplum.com/fhircast/STU3/abc-123');\n     });\n   });\n });\n\ndiff --git a/packages/core/src/client.test.ts b/packages/core/src/client.test.ts\nindex 9d67654d56..3f843cbd4a 100644\n--- a/packages/core/src/client.test.ts\n+++ b/packages/core/src/client.test.ts\n@@ -237,11 +237,13 @@ describe('Client', () => {\n       authorizeUrl: 'https://authorize.example.com',\n       tokenUrl: 'https://token.example.com',\n       logoutUrl: 'https://logout.example.com',\n+      fhircastHubUrl: 'https://hub.example.com',\n     });\n     expect(client.getBaseUrl()).toBe('https://example.com/');\n     expect(client.getAuthorizeUrl()).toBe('https://authorize.example.com/');\n     expect(client.getTokenUrl()).toBe('https://token.example.com/');\n     expect(client.getLogoutUrl()).toBe('https://logout.example.com/');\n+    expect(client.getFhircastHubUrl()).toBe('https://hub.example.com/');\n   });\n \n   test('getAuthorizeUrl', () => {\n\ndiff --git a/packages/server/src/fhircast/routes.test.ts b/packages/server/src/fhircast/routes.test.ts\nindex 0a4ae8bcd8..0e2543cdec 100644\n--- a/packages/server/src/fhircast/routes.test.ts\n+++ b/packages/server/src/fhircast/routes.test.ts\n@@ -202,6 +202,193 @@ describe('FHIRCast routes', () => {\n     }\n   });\n \n+  test('Context change request on hub.url', async () => {\n+    const topic = randomUUID();\n+    for (const route of [STU2_BASE_ROUTE, STU3_BASE_ROUTE]) {\n+      const res = await request(server)\n+        .post(route)\n+        .set('Content-Type', ContentType.JSON)\n+        .set('Authorization', 'Bearer ' + accessToken)\n+        .send({\n+          id: randomUUID(),\n+          timestamp: new Date().toISOString(),\n+          event: {\n+            'hub.topic': topic,\n+            'hub.event': 'Patient-close',\n+            context: [\n+              {\n+                key: 'patient',\n+                resource: {\n+                  resourceType: 'Patient',\n+                  id: '798E4MyMcpCWHab9',\n+                  identifier: [\n+                    {\n+                      type: {\n+                        coding: [\n+                          {\n+                            system: 'http://terminology.hl7.org/CodeSystem/v2-0203',\n+                            value: 'MR',\n+                            display: 'Medical Record Number',\n+                          },\n+                        ],\n+                        text: 'MRN',\n+                      },\n+                    },\n+                  ],\n+                },\n+              },\n+            ],\n+          },\n+        });\n+      expect(res.status).toBe(201);\n+    }\n+  });\n+\n+  test('Context change request on /:topic', async () => {\n+    const topic = randomUUID();\n+    for (const route of [STU2_BASE_ROUTE, STU3_BASE_ROUTE]) {\n+      const res = await request(server)\n+        .post(route + topic)\n+        .set('Content-Type', ContentType.JSON)\n+        .set('Authorization', 'Bearer ' + accessToken)\n+        .send({\n+          id: randomUUID(),\n+          timestamp: new Date().toISOString(),\n+          event: {\n+            'hub.topic': topic,\n+            'hub.event': 'Patient-close',\n+            context: [\n+              {\n+                key: 'patient',\n+                resource: {\n+                  resourceType: 'Patient',\n+                  id: '798E4MyMcpCWHab9',\n+                  identifier: [\n+                    {\n+                      type: {\n+                        coding: [\n+                          {\n+                            system: 'http://terminology.hl7.org/CodeSystem/v2-0203',\n+                            value: 'MR',\n+                            display: 'Medical Record Number',\n+                          },\n+                        ],\n+                        text: 'MRN',\n+                      },\n+                    },\n+                  ],\n+                },\n+              },\n+            ],\n+          },\n+        });\n+      expect(res.status).toBe(201);\n+    }\n+  });\n+\n+  test('Context change -- missing \"hub.topic\"', async () => {\n+    for (const route of [STU2_BASE_ROUTE, STU3_BASE_ROUTE]) {\n+      const res = await request(server)\n+        .post(route)\n+        .set('Content-Type', ContentType.JSON)\n+        .set('Authorization', 'Bearer ' + accessToken)\n+        .send({\n+          id: randomUUID(),\n+          timestamp: new Date().toISOString(),\n+          event: {\n+            'hub.event': 'Patient-close',\n+            context: [\n+              {\n+                key: 'patient',\n+                resource: {\n+                  resourceType: 'Patient',\n+                  id: '798E4MyMcpCWHab9',\n+                  identifier: [\n+                    {\n+                      type: {\n+                        coding: [\n+                          {\n+                            system: 'http://terminology.hl7.org/CodeSystem/v2-0203',\n+                            value: 'MR',\n+                            display: 'Medical Record Number',\n+                          },\n+                        ],\n+                        text: 'MRN',\n+                      },\n+                    },\n+                  ],\n+                },\n+              },\n+            ],\n+          },\n+        });\n+      expect(res.status).toBe(400);\n+      expect(res.body.issue[0].details.text).toEqual('Missing event[\"hub.topic\"]');\n+    }\n+  });\n+\n+  test('Context change -- missing \"hub.event\"', async () => {\n+    const topic = randomUUID();\n+    for (const route of [STU2_BASE_ROUTE, STU3_BASE_ROUTE]) {\n+      const res = await request(server)\n+        .post(route)\n+        .set('Content-Type', ContentType.JSON)\n+        .set('Authorization', 'Bearer ' + accessToken)\n+        .send({\n+          id: randomUUID(),\n+          timestamp: new Date().toISOString(),\n+          event: {\n+            'hub.topic': topic,\n+            context: [\n+              {\n+                key: 'patient',\n+                resource: {\n+                  resourceType: 'Patient',\n+                  id: '798E4MyMcpCWHab9',\n+                  identifier: [\n+                    {\n+                      type: {\n+                        coding: [\n+                          {\n+                            system: 'http://terminology.hl7.org/CodeSystem/v2-0203',\n+                            value: 'MR',\n+                            display: 'Medical Record Number',\n+                          },\n+                        ],\n+                        text: 'MRN',\n+                      },\n+                    },\n+                  ],\n+                },\n+              },\n+            ],\n+          },\n+        });\n+      expect(res.status).toBe(400);\n+      expect(res.body.issue[0].details.text).toEqual('Missing event[\"hub.event\"]');\n+    }\n+  });\n+\n+  test('Context change -- missing context', async () => {\n+    const topic = randomUUID();\n+    for (const route of [STU2_BASE_ROUTE, STU3_BASE_ROUTE]) {\n+      const res = await request(server)\n+        .post(route)\n+        .set('Content-Type', ContentType.JSON)\n+        .set('Authorization', 'Bearer ' + accessToken)\n+        .send({\n+          id: randomUUID(),\n+          timestamp: new Date().toISOString(),\n+          event: {\n+            'hub.topic': topic,\n+            'hub.event': 'Patient-close',\n+          },\n+        });\n+      expect(res.status).toBe(400);\n+      expect(res.body.issue[0].details.text).toEqual('Missing event.context');\n+    }\n+  });\n+\n   test('Get context', async () => {\n     const topic = randomUUID();\n     let res;\n@@ -230,7 +417,7 @@ describe('FHIRCast routes', () => {\n       { key: 'patient', resource: { id: 'xyz-789', resourceType: 'Patient' } },\n     ]);\n     const publishRes = await request(server)\n-      .post(`${STU3_BASE_ROUTE}my-topic`)\n+      .post(STU3_BASE_ROUTE)\n       .set('Content-Type', ContentType.JSON)\n       .set('Authorization', 'Bearer ' + accessToken)\n       .send(payload);\n@@ -288,7 +475,7 @@ describe('FHIRCast routes', () => {\n     });\n \n     const publishRes = await request(server)\n-      .post(`${STU3_BASE_ROUTE}my-topic`)\n+      .post(STU3_BASE_ROUTE)\n       .set('Content-Type', ContentType.JSON)\n       .set('Authorization', 'Bearer ' + accessToken)\n       .send(createFhircastMessagePayload('my-topic', 'DiagnosticReport-close', context));\n@@ -320,7 +507,7 @@ describe('FHIRCast routes', () => {\n     const payload = createFhircastMessagePayload('my-topic', 'DiagnosticReport-open', context);\n \n     const publishRes = await request(server)\n-      .post(`${STU3_BASE_ROUTE}my-topic`)\n+      .post(STU3_BASE_ROUTE)\n       .set('Content-Type', ContentType.JSON)\n       .set('Authorization', 'Bearer ' + accessToken)\n       .send(payload);\n@@ -348,7 +535,7 @@ describe('FHIRCast routes', () => {\n     const payload = createFhircastMessagePayload('my-topic', 'DiagnosticReport-update', context, versionId);\n \n     const publishRes = await request(server)\n-      .post(`${STU3_BASE_ROUTE}my-topic`)\n+      .post(STU3_BASE_ROUTE)\n       .set('Content-Type', ContentType.JSON)\n       .set('Authorization', 'Bearer ' + accessToken)\n       .send(payload);\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5342",
    "pr_id": 5342,
    "issue_id": 4876,
    "repo": "medplum/medplum",
    "problem_statement": "BaseChat shouldn't call `onMessageReceived` twice when setting received timestamp\nConsider this scenario for the `BaseChat` component:\r\n\r\n- `onMessageReceived` currently triggers on any change made to a communication that:\r\n- Matches the search query\r\n- The sender is not the current user\r\n- So `onMessageReceived` gets called:\r\n- received is null\r\n- Client sets `Communication.received`\r\n- The `Communication` is upserted\r\n- **`onMessageReceived called _again_, with the new received time**  (this should change, since the message is new)\r\n\r\nhttps://github.com/medplum/medplum/blob/b1f86f8c1a0a0999d9ec91e203662b15b3fb4a33/packages/react/src/chat/BaseChat/BaseChat.tsx#L20-L39",
    "issue_word_count": 86,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/react/src/chat/BaseChat/BaseChat.test.tsx",
      "packages/react/src/chat/BaseChat/BaseChat.tsx"
    ],
    "pr_changed_test_files": [
      "packages/react/src/chat/BaseChat/BaseChat.test.tsx"
    ],
    "base_commit": "a8b478fe69df55d2bca3c4aaec8f8f7a87e399ce",
    "head_commit": "cc6019f6405e874917f8149287c9e9a2ceaf459d",
    "repo_url": "https://github.com/medplum/medplum/pull/5342",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5342",
    "dockerfile": "",
    "pr_merged_at": "2024-10-04T20:50:07.000Z",
    "patch": "diff --git a/packages/react/src/chat/BaseChat/BaseChat.tsx b/packages/react/src/chat/BaseChat/BaseChat.tsx\nindex 22c82fada3..e72a564323 100644\n--- a/packages/react/src/chat/BaseChat/BaseChat.tsx\n+++ b/packages/react/src/chat/BaseChat/BaseChat.tsx\n@@ -68,6 +68,7 @@ export interface BaseChatProps extends PaperProps {\n   readonly query: string;\n   readonly sendMessage: (content: string) => void;\n   readonly onMessageReceived?: (message: Communication) => void;\n+  readonly onMessageUpdated?: (message: Communication) => void;\n   readonly inputDisabled?: boolean;\n   readonly onError?: (err: Error) => void;\n }\n@@ -80,6 +81,7 @@ export function BaseChat(props: BaseChatProps): JSX.Element | null {\n     query,\n     sendMessage,\n     onMessageReceived,\n+    onMessageUpdated,\n     inputDisabled,\n     onError,\n     ...paperProps\n@@ -122,9 +124,17 @@ export function BaseChat(props: BaseChatProps): JSX.Element | null {\n     (bundle: Bundle) => {\n       const communication = bundle.entry?.[1]?.resource as Communication;\n       upsertCommunications(communicationsRef.current, [communication], setCommunications);\n-      // Call `onMessageReceived` when we are not the sender of a chat message that came in\n-      if (onMessageReceived && getReferenceString(communication.sender as Reference) !== profileRefStr) {\n-        onMessageReceived(communication);\n+      // If we are the sender of this message, then we want to skip calling `onMessageUpdated` or `onMessageReceived`\n+      if (getReferenceString(communication.sender as Reference) === profileRefStr) {\n+        return;\n+      }\n+      // If this communication already exists, call `onMessageUpdated`\n+      if (communicationsRef.current.find((c) => c.id === communication.id)) {\n+        onMessageUpdated?.(communication);\n+      } else {\n+        // Else a new message was created\n+        // Call `onMessageReceived` when we are not the sender of a chat message that came in\n+        onMessageReceived?.(communication);\n       }\n     },\n     {\n",
    "test_patch": "diff --git a/packages/react/src/chat/BaseChat/BaseChat.test.tsx b/packages/react/src/chat/BaseChat/BaseChat.test.tsx\nindex b65b59b3b2..cd00bada80 100644\n--- a/packages/react/src/chat/BaseChat/BaseChat.test.tsx\n+++ b/packages/react/src/chat/BaseChat/BaseChat.test.tsx\n@@ -78,11 +78,8 @@ describe('BaseChat', () => {\n   let defaultMedplum: MockClient;\n   let defaultSubManager: MockSubscriptionManager;\n \n-  beforeAll(() => {\n-    defaultMedplum = new MockClient({ profile: DrAliceSmith });\n-  });\n-\n   beforeEach(() => {\n+    defaultMedplum = new MockClient({ profile: DrAliceSmith });\n     defaultSubManager = new MockSubscriptionManager(\n       defaultMedplum,\n       getWebSocketUrl(defaultMedplum.getBaseUrl(), '/ws/subscriptions-r4'),\n@@ -217,6 +214,7 @@ describe('BaseChat', () => {\n \n     expect(await screen.findByText(\"Doc, I can't feel my legs\")).toBeInTheDocument();\n     expect(onMessageReceived).toHaveBeenCalledWith(incomingMessage);\n+    expect(onMessageReceived).toHaveBeenCalledTimes(1);\n   });\n \n   test('`onMessageReceived` not called on outgoing message', async () => {\n@@ -245,6 +243,55 @@ describe('BaseChat', () => {\n     expect(onMessageReceived).not.toHaveBeenCalled();\n   });\n \n+  test('`onMessageUpdated` called on incoming message update', async () => {\n+    const onMessageReceived = jest.fn();\n+    const onMessageUpdated = jest.fn();\n+\n+    await setup({\n+      title: 'Test Chat',\n+      query: HOMER_DR_ALICE_CHAT_QUERY,\n+      sendMessage: () => undefined,\n+      onMessageReceived,\n+      onMessageUpdated,\n+    });\n+\n+    const incomingMessage = await createCommunication(defaultMedplum, {\n+      sender: homerReference,\n+      recipient: [drAliceReference],\n+      payload: [{ contentString: \"Doc, I can't feel my legs\" }],\n+    });\n+\n+    const bundle1 = await createCommunicationSubBundle(defaultMedplum, incomingMessage);\n+    act(() => {\n+      defaultSubManager.emitEventForCriteria(`Communication?${HOMER_DR_ALICE_CHAT_QUERY}`, {\n+        type: 'message',\n+        payload: bundle1,\n+      });\n+    });\n+\n+    expect(await screen.findByText(\"Doc, I can't feel my legs\")).toBeInTheDocument();\n+    expect(onMessageReceived).toHaveBeenCalledTimes(1);\n+    expect(onMessageUpdated).not.toHaveBeenCalled();\n+\n+    const updatedMessage = await defaultMedplum.updateResource({\n+      ...incomingMessage,\n+      payload: [{ contentString: \"Doc, I can't feel my arms\" }],\n+    });\n+\n+    const bundle2 = await createCommunicationSubBundle(defaultMedplum, updatedMessage);\n+    act(() => {\n+      defaultSubManager.emitEventForCriteria(`Communication?${HOMER_DR_ALICE_CHAT_QUERY}`, {\n+        type: 'message',\n+        payload: bundle2,\n+      });\n+    });\n+\n+    expect(await screen.findByText(\"Doc, I can't feel my arms\")).toBeInTheDocument();\n+    expect(onMessageUpdated).toHaveBeenCalledWith(updatedMessage);\n+    expect(onMessageUpdated).toHaveBeenCalledTimes(1);\n+    expect(onMessageReceived).toHaveBeenCalledTimes(1);\n+  });\n+\n   test('Messages cleared if profile changes', async () => {\n     const medplum = new MockClient({ profile: DrAliceSmith });\n     await Promise.all([\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5339",
    "pr_id": 5339,
    "issue_id": 5322,
    "repo": "medplum/medplum",
    "problem_statement": "Duplicate results in _has query\nIn the query to retrieve Patients using _has:ChargeItem, for example:\r\n\r\n`Patient?_has:ChargeItem:subject:occurrence=ge2024/09/01&_total=accurate`\r\n\r\nThe result is duplicated as many times as the patient has a ChargeItem on the specified date. If you add another _has with an end date, for example:\r\n\r\n`Patient?_has:ChargeItem:subject:occurrence=ge2024/09/01&_has:ChargeItem:subject:occurrence=le2024/09/30&_total=accurate`\r\n\r\nThe results are repeated even more. However, the total inside the bundle is correct and corresponds to the number of patients meeting the condition.",
    "issue_word_count": 95,
    "test_files_count": 1,
    "non_test_files_count": 2,
    "pr_changed_files": [
      "packages/server/src/fhir/search.test.ts",
      "packages/server/src/fhir/search.ts",
      "packages/server/src/fhir/sql.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/search.test.ts"
    ],
    "base_commit": "2a17ea425d2275e24c7e2d5b5cf522258e1fc54a",
    "head_commit": "bc44146daaf98317f8757659a88ac13d9568b7a6",
    "repo_url": "https://github.com/medplum/medplum/pull/5339",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5339",
    "dockerfile": "",
    "pr_merged_at": "2024-10-07T17:06:03.000Z",
    "patch": "diff --git a/packages/server/src/fhir/search.ts b/packages/server/src/fhir/search.ts\nindex ab4a6c81ed..e43591890d 100644\n--- a/packages/server/src/fhir/search.ts\n+++ b/packages/server/src/fhir/search.ts\n@@ -344,10 +344,9 @@ function getBaseSelectQueryForResourceType(\n   opts?: GetBaseSelectQueryOptions\n ): SelectQuery {\n   const builder = new SelectQuery(resourceType);\n-  if (opts?.addColumns ?? true) {\n-    builder\n-      .column({ tableName: resourceType, columnName: 'id' })\n-      .column({ tableName: resourceType, columnName: 'content' });\n+  const idColumn = new Column(resourceType, 'id');\n+  if (opts?.addColumns !== false) {\n+    builder.column(idColumn).column(new Column(resourceType, 'content'));\n   }\n   repo.addDeletedFilter(builder);\n   repo.addSecurityFilters(builder, resourceType);\n@@ -355,6 +354,10 @@ function getBaseSelectQueryForResourceType(\n   if (opts?.resourceTypeQueryCallback) {\n     opts.resourceTypeQueryCallback(resourceType, builder);\n   }\n+\n+  if (builder.joins.length > 0) {\n+    builder.distinctOn(idColumn);\n+  }\n   return builder;\n }\n \n\ndiff --git a/packages/server/src/fhir/sql.ts b/packages/server/src/fhir/sql.ts\nindex 4f58d757c8..b9076cb49b 100644\n--- a/packages/server/src/fhir/sql.ts\n+++ b/packages/server/src/fhir/sql.ts\n@@ -89,7 +89,7 @@ export const Operator = {\n     if (paramType) {\n       sql.append('(');\n     }\n-    (parameter as SelectQuery).buildSql(sql);\n+    sql.appendExpression(parameter);\n     if (paramType) {\n       sql.append(')::' + paramType);\n     }\n@@ -145,13 +145,17 @@ export function escapeLikeString(str: string): string {\n   return str.replaceAll(/[\\\\_%]/g, (c) => '\\\\' + c);\n }\n \n-export class Column {\n+export class Column implements Expression {\n   constructor(\n     readonly tableName: string | undefined,\n     readonly columnName: string,\n     readonly raw?: boolean,\n     readonly alias?: string\n   ) {}\n+\n+  buildSql(sql: SqlBuilder): void {\n+    sql.appendColumn(this);\n+  }\n }\n \n export class Literal implements Expression {\n@@ -171,7 +175,7 @@ export class Negation implements Expression {\n \n   buildSql(sql: SqlBuilder): void {\n     sql.append('NOT (');\n-    this.expression.buildSql(sql);\n+    sql.appendExpression(this.expression);\n     sql.append(')');\n   }\n }\n@@ -221,7 +225,7 @@ export abstract class Connective implements Expression {\n       if (!first) {\n         builder.append(this.keyword);\n       }\n-      expr.buildSql(builder);\n+      builder.appendExpression(expr);\n       first = false;\n     }\n     if (this.expressions.length > 1) {\n@@ -252,11 +256,7 @@ export class SqlFunction implements Expression {\n     sql.append(this.name + '(');\n     for (let i = 0; i < this.args.length; i++) {\n       const arg = this.args[i];\n-      if (arg instanceof Column) {\n-        sql.appendColumn(arg);\n-      } else {\n-        arg.buildSql(sql);\n-      }\n+      sql.appendExpression(arg);\n       if (i + 1 < this.args.length) {\n         sql.append(', ');\n       }\n@@ -277,7 +277,7 @@ export class Union implements Expression {\n         sql.append(' UNION ');\n       }\n       sql.append('(');\n-      this.queries[i].buildSql(sql);\n+      sql.appendExpression(this.queries[i]);\n       sql.append(')');\n     }\n   }\n@@ -340,6 +340,11 @@ export class SqlBuilder {\n     return this;\n   }\n \n+  appendExpression(expr: Expression): this {\n+    expr.buildSql(this);\n+    return this;\n+  }\n+\n   param(value: any): this {\n     if (value instanceof Column) {\n       this.appendColumn(value);\n@@ -391,7 +396,7 @@ export class SqlBuilder {\n       if (this.debug) {\n         const endTime = Date.now();\n         const duration = endTime - startTime;\n-        console.log(`result: ${result.rowCount} rows (${duration} ms)`);\n+        console.log(`result: ${result.rowCount ?? 0} rows (${duration} ms)`);\n       }\n \n       return { rowCount: result.rowCount ?? 0, rows: result.rows };\n@@ -441,7 +446,7 @@ export abstract class BaseQuery {\n   protected buildConditions(sql: SqlBuilder): void {\n     if (this.predicate.expressions.length > 0) {\n       sql.append(' WHERE ');\n-      this.predicate.buildSql(sql);\n+      sql.appendExpression(this.predicate);\n     }\n   }\n }\n@@ -550,7 +555,7 @@ export class SelectQuery extends BaseQuery implements Expression {\n       }\n       sql.appendIdentifier(this.with.name);\n       sql.append(' AS (');\n-      this.with.expr.buildSql(sql);\n+      sql.appendExpression(this.with.expr);\n       sql.append(') ');\n     }\n     sql.append('SELECT ');\n@@ -574,7 +579,7 @@ export class SelectQuery extends BaseQuery implements Expression {\n \n   async execute(conn: Pool | PoolClient): Promise<any[]> {\n     const sql = new SqlBuilder();\n-    this.buildSql(sql);\n+    sql.appendExpression(this);\n     return (await sql.execute(conn)).rows;\n   }\n \n@@ -616,7 +621,7 @@ export class SelectQuery extends BaseQuery implements Expression {\n \n     if (this.innerQuery) {\n       sql.append('(');\n-      this.innerQuery.buildSql(sql);\n+      sql.appendExpression(this.innerQuery);\n       sql.append(') AS ');\n     }\n \n@@ -631,7 +636,7 @@ export class SelectQuery extends BaseQuery implements Expression {\n       sql.append(` ${join.joinType} `);\n       if (join.joinItem instanceof SelectQuery) {\n         sql.append('(');\n-        join.joinItem.buildSql(sql);\n+        sql.appendExpression(join.joinItem);\n         sql.append(')');\n       } else {\n         sql.appendIdentifier(join.joinItem);\n@@ -639,7 +644,7 @@ export class SelectQuery extends BaseQuery implements Expression {\n       sql.append(' AS ');\n       sql.appendIdentifier(join.joinAlias);\n       sql.append(' ON ');\n-      join.onExpression.buildSql(sql);\n+      sql.appendExpression(join.onExpression);\n     }\n   }\n \n@@ -663,11 +668,7 @@ export class SelectQuery extends BaseQuery implements Expression {\n \n     for (const orderBy of combined) {\n       sql.append(first ? ' ORDER BY ' : ', ');\n-      if (orderBy.key instanceof Column) {\n-        sql.appendColumn(orderBy.key);\n-      } else {\n-        orderBy.key.buildSql(sql);\n-      }\n+      sql.appendExpression(orderBy.key);\n       if (orderBy.descending) {\n         sql.append(' DESC');\n       }\n@@ -691,7 +692,7 @@ export class ArraySubquery implements Expression {\n     sql.append(') AS ');\n     sql.appendIdentifier(this.column.columnName);\n     sql.append(' WHERE ');\n-    this.filter.buildSql(sql);\n+    sql.appendExpression(this.filter);\n     sql.append(' LIMIT 1');\n     sql.append(')');\n   }\n@@ -779,7 +780,7 @@ export class InsertQuery extends BaseQuery {\n       return;\n     }\n     sql.append(' ');\n-    this.query.buildSql(sql);\n+    sql.appendExpression(this.query);\n   }\n \n   private appendValues(sql: SqlBuilder, columnNames: string[], values: Record<string, any>): void {\n",
    "test_patch": "diff --git a/packages/server/src/fhir/search.test.ts b/packages/server/src/fhir/search.test.ts\nindex 44fb1b3f81..b7c004ff2e 100644\n--- a/packages/server/src/fhir/search.test.ts\n+++ b/packages/server/src/fhir/search.test.ts\n@@ -1980,6 +1980,49 @@ describe('FHIR Search', () => {\n         expect(result.entry?.[0]?.resource?.id).toEqual(patient.id);\n       }));\n \n+    test('Chained search deduplication', () =>\n+      withTestContext(async () => {\n+        const code = randomUUID();\n+        const code2 = randomUUID();\n+        // Create linked resources\n+        const patient = await repo.createResource<Patient>({\n+          resourceType: 'Patient',\n+        });\n+        await repo.createResource<Observation>({\n+          resourceType: 'Observation',\n+          status: 'final',\n+          code: { coding: [{ code }], text: 'Throat culture' },\n+          subject: createReference(patient),\n+        });\n+        await repo.createResource<Observation>({\n+          resourceType: 'Observation',\n+          status: 'final',\n+          code: { coding: [{ code: code2 }], text: 'Blood test' },\n+          subject: createReference(patient),\n+        });\n+\n+        const result = await repo.search(parseSearchRequest(`Patient?_has:Observation:subject:code=${code},${code2}`));\n+        expect(result.entry).toHaveLength(1);\n+        expect(result.entry?.[0]?.resource?.id).toEqual(patient.id);\n+      }));\n+\n+    test('Token search deduplication', () =>\n+      withTestContext(async () => {\n+        const code = randomUUID();\n+        const code2 = randomUUID();\n+        // Create resource with multiple codes\n+        const observation = await repo.createResource<Observation>({\n+          resourceType: 'Observation',\n+          status: 'final',\n+          code: { text: 'Blood test' },\n+          component: [{ code: { coding: [{ code }] } }, { code: { coding: [{ code: code2 }] } }],\n+        });\n+\n+        const result = await repo.search(parseSearchRequest(`Observation?component-code=${code},${code2}`));\n+        expect(result.entry).toHaveLength(1);\n+        expect(result.entry?.[0]?.resource?.id).toEqual(observation.id);\n+      }));\n+\n     test('Include references success', () =>\n       withTestContext(async () => {\n         const patient = await repo.createResource<Patient>({ resourceType: 'Patient' });\n@@ -3175,11 +3218,11 @@ describe('FHIR Search', () => {\n           ],\n         });\n         expect(bundle.entry?.length).toEqual(2);\n-        expect(bundle.total).toEqual(2);\n         expect(bundleContains(bundle, p1)).toBeTruthy();\n         expect(bundleContains(bundle, p2)).not.toBeTruthy();\n         expect(bundleContains(bundle, p3)).toBeTruthy();\n         expect(bundleContains(bundle, p4)).not.toBeTruthy();\n+        expect(bundle.total).toEqual(2);\n       }));\n \n     test('Duplicate rows from token lookup', () =>\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5337",
    "pr_id": 5337,
    "issue_id": 4353,
    "repo": "medplum/medplum",
    "problem_statement": "Make `code` parameter from Bot/$deploy optional\nLong ago, the `Bot` resource only stored the source code, and the compiled code was set during `$deploy`\r\n\r\nNow we store both the source and compiled code as Attachments on the `Bot` resource, so the `code` parameter on the $deploy operation is unncessary. We can make it optional and then deprecate in v4",
    "issue_word_count": 60,
    "test_files_count": 3,
    "non_test_files_count": 5,
    "pr_changed_files": [
      "packages/app/src/resource/BotEditor.test.tsx",
      "packages/app/src/resource/BotEditor.tsx",
      "packages/core/src/client.test.ts",
      "packages/core/src/client.ts",
      "packages/server/src/fhir/operations/deploy.test.ts",
      "packages/server/src/fhir/operations/deploy.ts",
      "packages/server/src/fhir/operations/execute.ts",
      "packages/server/src/util/streams.ts"
    ],
    "pr_changed_test_files": [
      "packages/app/src/resource/BotEditor.test.tsx",
      "packages/core/src/client.test.ts",
      "packages/server/src/fhir/operations/deploy.test.ts"
    ],
    "base_commit": "adff7a6fd43d050e1c08ea5e49719df19cb82ddc",
    "head_commit": "dfa103a31b1d88370d596bb795d0c721ab92b8ce",
    "repo_url": "https://github.com/medplum/medplum/pull/5337",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5337",
    "dockerfile": "",
    "pr_merged_at": "2024-10-07T17:52:52.000Z",
    "patch": "diff --git a/packages/app/src/resource/BotEditor.tsx b/packages/app/src/resource/BotEditor.tsx\nindex f0797c2c0f..7d37ef39cf 100644\n--- a/packages/app/src/resource/BotEditor.tsx\n+++ b/packages/app/src/resource/BotEditor.tsx\n@@ -51,10 +51,12 @@ export function BotEditor(): JSX.Element | null {\n       .catch((err) => showNotification({ color: 'red', message: normalizeErrorString(err), autoClose: false }));\n   }, [medplum, id]);\n \n+  // Gets the uncompiled TS code\n   const getCode = useCallback(() => {\n     return sendCommand(codeFrameRef.current as HTMLIFrameElement, { command: 'getValue' });\n   }, []);\n \n+  // Gets the compiled JS output\n   const getCodeOutput = useCallback(() => {\n     return sendCommand(codeFrameRef.current as HTMLIFrameElement, { command: 'getOutput' });\n   }, []);\n@@ -74,21 +76,21 @@ export function BotEditor(): JSX.Element | null {\n       setLoading(true);\n       try {\n         const code = await getCode();\n+        const codeOutput = await getCodeOutput();\n         const sourceCode = await medplum.createAttachment(code, 'index.ts', 'text/typescript');\n-        const operations: PatchOperation[] = [];\n-        if (bot?.sourceCode) {\n-          operations.push({\n-            op: 'replace',\n-            path: '/sourceCode',\n-            value: sourceCode,\n-          });\n-        } else {\n-          operations.push({\n+        const executableCode = await medplum.createAttachment(codeOutput, 'index.js', 'text/typescript');\n+        const operations: PatchOperation[] = [\n+          {\n             op: 'add',\n             path: '/sourceCode',\n             value: sourceCode,\n-          });\n-        }\n+          },\n+          {\n+            op: 'add',\n+            path: '/executableCode',\n+            value: executableCode,\n+          },\n+        ];\n         await medplum.patchResource('Bot', id, operations);\n         showNotification({ color: 'green', message: 'Saved' });\n       } catch (err) {\n@@ -97,7 +99,7 @@ export function BotEditor(): JSX.Element | null {\n         setLoading(false);\n       }\n     },\n-    [medplum, id, bot, getCode]\n+    [medplum, id, getCode, getCodeOutput]\n   );\n \n   const deployBot = useCallback(\n@@ -106,8 +108,7 @@ export function BotEditor(): JSX.Element | null {\n       e.stopPropagation();\n       setLoading(true);\n       try {\n-        const code = await getCodeOutput();\n-        await medplum.post(medplum.fhirUrl('Bot', id, '$deploy'), { code });\n+        await medplum.post(medplum.fhirUrl('Bot', id, '$deploy'));\n         showNotification({ color: 'green', message: 'Deployed' });\n       } catch (err) {\n         showNotification({ color: 'red', message: normalizeErrorString(err), autoClose: false });\n@@ -115,7 +116,7 @@ export function BotEditor(): JSX.Element | null {\n         setLoading(false);\n       }\n     },\n-    [medplum, id, getCodeOutput]\n+    [medplum, id]\n   );\n \n   const executeBot = useCallback(\n\ndiff --git a/packages/core/src/client.ts b/packages/core/src/client.ts\nindex e73d33d9bd..01b47ffd34 100644\n--- a/packages/core/src/client.ts\n+++ b/packages/core/src/client.ts\n@@ -1056,7 +1056,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n    * @param options - Optional fetch options.\n    * @returns Promise to the response content.\n    */\n-  post(url: URL | string, body: any, contentType?: string, options: MedplumRequestOptions = {}): Promise<any> {\n+  post(url: URL | string, body?: any, contentType?: string, options: MedplumRequestOptions = {}): Promise<any> {\n     url = url.toString();\n     this.setRequestBody(options, body);\n     if (contentType) {\n@@ -3349,9 +3349,9 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n   private setRequestBody(options: MedplumRequestOptions, data: any): void {\n     if (\n       typeof data === 'string' ||\n-      (typeof Blob !== 'undefined' && (data instanceof Blob || data.constructor.name === 'Blob')) ||\n-      (typeof File !== 'undefined' && (data instanceof File || data.constructor.name === 'File')) ||\n-      (typeof Uint8Array !== 'undefined' && (data instanceof Uint8Array || data.constructor.name === 'Uint8Array'))\n+      (typeof Blob !== 'undefined' && (data instanceof Blob || data?.constructor.name === 'Blob')) ||\n+      (typeof File !== 'undefined' && (data instanceof File || data?.constructor.name === 'File')) ||\n+      (typeof Uint8Array !== 'undefined' && (data instanceof Uint8Array || data?.constructor.name === 'Uint8Array'))\n     ) {\n       options.body = data;\n     } else if (data) {\n\ndiff --git a/packages/server/src/fhir/operations/deploy.ts b/packages/server/src/fhir/operations/deploy.ts\nindex b065908cd9..6de7473975 100644\n--- a/packages/server/src/fhir/operations/deploy.ts\n+++ b/packages/server/src/fhir/operations/deploy.ts\n@@ -1,9 +1,10 @@\n import { ContentType, allOk, badRequest, getReferenceString, normalizeOperationOutcome } from '@medplum/core';\n import { FhirRequest, FhirResponse } from '@medplum/fhir-router';\n-import { Binary, Bot } from '@medplum/fhirtypes';\n-import { Readable } from 'stream';\n+import { Attachment, Binary, Bot } from '@medplum/fhirtypes';\n+import { Readable } from 'node:stream';\n import { deployLambda } from '../../cloud/aws/deploy';\n import { getAuthenticatedContext } from '../../context';\n+import { readStreamToString } from '../../util/streams';\n import { getSystemRepo } from '../repo';\n import { getBinaryStorage } from '../storage';\n import { isBotEnabled } from './execute';\n@@ -12,12 +13,6 @@ export async function deployHandler(req: FhirRequest): Promise<FhirResponse> {\n   const ctx = getAuthenticatedContext();\n   const { id } = req.params;\n \n-  // Validate that the request body has a code property\n-  const code = req.body.code as string | undefined;\n-  if (!code) {\n-    return [badRequest('Missing code')];\n-  }\n-\n   // First read the bot as the user to verify access\n   await ctx.repo.readResource<Bot>('Bot', id);\n \n@@ -25,34 +20,55 @@ export async function deployHandler(req: FhirRequest): Promise<FhirResponse> {\n   const systemRepo = getSystemRepo();\n   const bot = await systemRepo.readResource<Bot>('Bot', id);\n \n+  // Validate that the request body has a code property\n+  // Or that the Bot already has executable code attached\n+  const code = req.body.code as string | undefined;\n+  if (!code && !bot.executableCode?.url) {\n+    return [badRequest('Bot missing executable code')];\n+  }\n+\n   if (!(await isBotEnabled(bot))) {\n     return [badRequest('Bots not enabled')];\n   }\n \n   try {\n-    const filename = req.body.filename ?? 'index.js';\n-    const contentType = ContentType.JAVASCRIPT;\n-\n-    // Create a Binary for the executable code\n-    const binary = await ctx.repo.createResource<Binary>({\n-      resourceType: 'Binary',\n-      contentType,\n-    });\n-    await getBinaryStorage().writeBinary(binary, filename, contentType, Readable.from(code));\n-\n-    // Update the bot\n-    const updatedBot = await ctx.repo.updateResource<Bot>({\n-      ...bot,\n-      executableCode: {\n+    const code = req.body.code as string | undefined;\n+    let updatedBot: Bot | undefined;\n+\n+    let codeToDeploy = code;\n+    if (code) {\n+      const filename = req.body.filename ?? 'index.js';\n+      const contentType = ContentType.JAVASCRIPT;\n+\n+      // Create a Binary for the executable code\n+      const binary = await ctx.repo.createResource<Binary>({\n+        resourceType: 'Binary',\n         contentType,\n-        url: getReferenceString(binary),\n-        title: filename,\n-      },\n-    });\n+      });\n+      await getBinaryStorage().writeBinary(binary, filename, contentType, Readable.from(code));\n+\n+      // Update the bot\n+      updatedBot = await ctx.repo.updateResource<Bot>({\n+        ...bot,\n+        executableCode: {\n+          contentType,\n+          url: getReferenceString(binary),\n+          title: filename,\n+        },\n+      });\n+    } else {\n+      const binary = await systemRepo.readReference<Binary>({\n+        reference: (bot.executableCode as Attachment).url as string,\n+      });\n+      const stream = await getBinaryStorage().readBinary(binary);\n+      codeToDeploy = await readStreamToString(stream);\n+    }\n+\n+    const latestBot = updatedBot ?? bot;\n \n     // Deploy the bot\n-    if (updatedBot.runtimeVersion === 'awslambda') {\n-      await deployLambda(updatedBot, code);\n+    if (latestBot.runtimeVersion === 'awslambda') {\n+      await deployLambda(latestBot, codeToDeploy as string);\n     }\n \n     return [allOk];\n\ndiff --git a/packages/server/src/fhir/operations/execute.ts b/packages/server/src/fhir/operations/execute.ts\nindex 4b137f84e1..8d58871c47 100644\n--- a/packages/server/src/fhir/operations/execute.ts\n+++ b/packages/server/src/fhir/operations/execute.ts\n@@ -34,7 +34,6 @@ import {\n import { Request, Response } from 'express';\n import fetch from 'node-fetch';\n import { randomUUID } from 'node:crypto';\n-import { Readable } from 'node:stream';\n import vm from 'node:vm';\n import { asyncWrap } from '../../async';\n import { runInLambda } from '../../cloud/aws/execute';\n@@ -44,6 +43,7 @@ import { generateAccessToken } from '../../oauth/keys';\n import { recordHistogramValue } from '../../otel/otel';\n import { AuditEventOutcome, logAuditEvent } from '../../util/auditevent';\n import { MockConsole } from '../../util/console';\n+import { readStreamToString } from '../../util/streams';\n import { createAuditEventEntities, findProjectMembership } from '../../workers/utils';\n import { sendOutcome } from '../outcomes';\n import { getSystemRepo, Repository } from '../repo';\n@@ -615,11 +615,3 @@ async function createAuditEvent(\n     });\n   }\n }\n-\n-async function readStreamToString(stream: Readable): Promise<string> {\n-  const chunks: Uint8Array[] = [];\n-  for await (const chunk of stream) {\n-    chunks.push(chunk);\n-  }\n-  return Buffer.concat(chunks).toString('utf8');\n-}\n\ndiff --git a/packages/server/src/util/streams.ts b/packages/server/src/util/streams.ts\nnew file mode 100644\nindex 0000000000..943b7cab1d\n--- /dev/null\n+++ b/packages/server/src/util/streams.ts\n@@ -0,0 +1,9 @@\n+import stream from 'node:stream';\n+\n+export async function readStreamToString(stream: stream.Readable): Promise<string> {\n+  const chunks: Uint8Array[] = [];\n+  for await (const chunk of stream) {\n+    chunks.push(chunk);\n+  }\n+  return Buffer.concat(chunks).toString('utf8');\n+}\n",
    "test_patch": "diff --git a/packages/app/src/resource/BotEditor.test.tsx b/packages/app/src/resource/BotEditor.test.tsx\nindex 5814b4fa41..45bbbbe5dd 100644\n--- a/packages/app/src/resource/BotEditor.test.tsx\n+++ b/packages/app/src/resource/BotEditor.test.tsx\n@@ -103,15 +103,6 @@ describe('BotEditor', () => {\n     await setup('/Bot/123/editor');\n     expect(await screen.findByText('Deploy')).toBeInTheDocument();\n \n-    // Mock the code frame\n-    (screen.getByTestId<HTMLIFrameElement>('code-frame').contentWindow as Window).postMessage = (\n-      _message: any,\n-      _targetOrigin: any,\n-      transfer?: Transferable[]\n-    ) => {\n-      (transfer?.[0] as MessagePort).postMessage({ result: 'console.log(\"foo\");' });\n-    };\n-\n     await act(async () => {\n       fireEvent.click(screen.getByText('Deploy'));\n     });\n@@ -120,23 +111,17 @@ describe('BotEditor', () => {\n   });\n \n   test('Deploy error', async () => {\n-    await setup('/Bot/123/editor');\n-    expect(await screen.findByText('Deploy')).toBeInTheDocument();\n+    const medplum = new MockClient();\n+    medplum.router.router.add('POST', 'Bot/:id/$deploy', async () => [badRequest('Something went wrong')]);\n \n-    // Mock the code frame\n-    (screen.getByTestId<HTMLIFrameElement>('code-frame').contentWindow as Window).postMessage = (\n-      _message: any,\n-      _targetOrigin: any,\n-      transfer?: Transferable[]\n-    ) => {\n-      (transfer?.[0] as MessagePort).postMessage({ error: badRequest('Error') });\n-    };\n+    await setup('/Bot/123/editor', medplum);\n+    expect(await screen.findByText('Deploy')).toBeInTheDocument();\n \n     await act(async () => {\n       fireEvent.click(screen.getByText('Deploy'));\n     });\n \n-    expect(screen.getByText('Error')).toBeInTheDocument();\n+    expect(screen.getByText('Something went wrong')).toBeInTheDocument();\n   });\n \n   test('Execute success', async () => {\n\ndiff --git a/packages/core/src/client.test.ts b/packages/core/src/client.test.ts\nindex 2864002e43..9d67654d56 100644\n--- a/packages/core/src/client.test.ts\n+++ b/packages/core/src/client.test.ts\n@@ -1085,6 +1085,13 @@ describe('Client', () => {\n     expect(request3).not.toBe(request1);\n   });\n \n+  test('HTTP POST without a body', async () => {\n+    const fetch = mockFetch(201, {});\n+    const client = new MedplumClient({ fetch });\n+    const result = await client.post(client.fhirUrl('Bot', randomUUID(), '$deploy'));\n+    expect(result).toEqual({});\n+  });\n+\n   test('Read expired and refresh', async () => {\n     let tokenExpired = true;\n \n\ndiff --git a/packages/server/src/fhir/operations/deploy.test.ts b/packages/server/src/fhir/operations/deploy.test.ts\nindex d7a1f49642..321b0474a3 100644\n--- a/packages/server/src/fhir/operations/deploy.test.ts\n+++ b/packages/server/src/fhir/operations/deploy.test.ts\n@@ -1,12 +1,32 @@\n import { ContentType } from '@medplum/core';\n-import { Bot } from '@medplum/fhirtypes';\n-import { randomUUID } from 'crypto';\n+import { Binary, Bot } from '@medplum/fhirtypes';\n import express from 'express';\n+import { randomUUID } from 'node:crypto';\n+import stream from 'node:stream';\n import request from 'supertest';\n import { initApp, shutdownApp } from '../../app';\n import { registerNew } from '../../auth/register';\n+import * as awsDeploy from '../../cloud/aws/deploy';\n import { loadTestConfig } from '../../config';\n import { initTestAuth, withTestContext } from '../../test.setup';\n+import * as streamUtils from '../../util/streams';\n+import * as storage from '../storage';\n+\n+const MOCK_PRESIGNED_URL = 'https://example.com/presigned';\n+\n+class MockBinaryStorage {\n+  getPresignedUrl(): string {\n+    return MOCK_PRESIGNED_URL;\n+  }\n+\n+  writeBinary(): Promise<void> {\n+    return Promise.resolve();\n+  }\n+\n+  readBinary(): Promise<stream.Readable> {\n+    return Promise.resolve(new stream.Readable());\n+  }\n+}\n \n const app = express();\n let accessToken: string;\n@@ -22,6 +42,128 @@ describe('Deploy', () => {\n     await shutdownApp();\n   });\n \n+  afterEach(() => {\n+    jest.restoreAllMocks();\n+  });\n+\n+  test('Deploy bot with executableCode attached', async () => {\n+    const code = `\n+    export async function handler() {\n+      console.log('input', input);\n+      return input;\n+    }\n+    `;\n+\n+    const mockBinaryStorage = new MockBinaryStorage();\n+    jest\n+      .spyOn(storage, 'getBinaryStorage')\n+      .mockImplementation(() => mockBinaryStorage as unknown as storage.BinaryStorage);\n+    const binaryStorage = storage.getBinaryStorage();\n+    const readBinarySpy = jest.spyOn(binaryStorage, 'readBinary');\n+\n+    const readStreamToStringSpy = jest\n+      .spyOn(streamUtils, 'readStreamToString')\n+      .mockImplementation(() => Promise.resolve(code));\n+\n+    const deployLambdaSpy = jest.spyOn(awsDeploy, 'deployLambda').mockImplementation();\n+\n+    // Create Binary to serve as storage for code attachment\n+    const res1 = await request(app)\n+      .post(`/fhir/R4/Binary`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        resourceType: 'Binary',\n+        contentType: ContentType.JAVASCRIPT,\n+      } satisfies Binary);\n+    expect(res1.status).toBe(201);\n+\n+    const binary = res1.body as Binary;\n+\n+    // Step 2: Create a bot\n+    const res2 = await request(app)\n+      .post(`/fhir/R4/Bot`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        resourceType: 'Bot',\n+        name: 'Test Bot',\n+        runtimeVersion: 'awslambda',\n+        executableCode: { url: `Binary/${binary.id}` },\n+      } satisfies Bot);\n+    expect(res2.status).toBe(201);\n+\n+    const bot = res2.body as Bot;\n+\n+    // Step 3: Deploy the bot\n+    const res3 = await request(app)\n+      .post(`/fhir/R4/Bot/${bot.id}/$deploy`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send();\n+    expect(res3.status).toBe(200);\n+\n+    expect(readBinarySpy).toHaveBeenCalledWith(\n+      expect.objectContaining({\n+        resourceType: 'Binary',\n+        contentType: ContentType.JAVASCRIPT,\n+      } as Binary)\n+    );\n+    expect(readStreamToStringSpy).toHaveBeenCalledWith(expect.any(Object));\n+    expect(deployLambdaSpy).toHaveBeenCalledWith(\n+      expect.objectContaining({\n+        ...bot,\n+        executableCode: expect.objectContaining({ url: expect.any(String) }),\n+        meta: expect.objectContaining({ ...bot.meta, lastUpdated: expect.any(String), versionId: expect.any(String) }),\n+      }),\n+      code\n+    );\n+  });\n+\n+  test('Deploy bot with code parameter', async () => {\n+    const deployLambdaSpy = jest.spyOn(awsDeploy, 'deployLambda').mockImplementation(jest.fn());\n+\n+    const code = `\n+      export async function handler() {\n+        console.log('input', input);\n+        return input;\n+      }\n+      `;\n+\n+    // Step 1: Create a bot\n+    const res1 = await request(app)\n+      .post(`/fhir/R4/Bot`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        resourceType: 'Bot',\n+        name: 'Test Bot',\n+        runtimeVersion: 'awslambda',\n+        code,\n+      });\n+    expect(res1.status).toBe(201);\n+\n+    const bot = res1.body as Bot;\n+\n+    // Step 2: Deploy the bot with code parameter\n+    const res2 = await request(app)\n+      .post(`/fhir/R4/Bot/${bot.id}/$deploy`)\n+      .set('Content-Type', ContentType.FHIR_JSON)\n+      .set('Authorization', 'Bearer ' + accessToken)\n+      .send({\n+        code,\n+      });\n+    expect(res2.status).toBe(200);\n+    expect(deployLambdaSpy).toHaveBeenCalledWith(\n+      expect.objectContaining({\n+        ...bot,\n+        executableCode: expect.objectContaining({ url: expect.any(String) }),\n+        meta: expect.objectContaining({ ...bot.meta, lastUpdated: expect.any(String), versionId: expect.any(String) }),\n+      }),\n+      code\n+    );\n+  });\n+\n   test('Deploy bot with missing code', async () => {\n     // Step 1: Create a bot\n     const res1 = await request(app)\n@@ -50,7 +192,7 @@ describe('Deploy', () => {\n       .set('Authorization', 'Bearer ' + accessToken)\n       .send({ code: '' });\n     expect(res2.status).toBe(400);\n-    expect(res2.body.issue[0].details.text).toEqual('Missing code');\n+    expect(res2.body.issue[0].details.text).toEqual('Bot missing executable code');\n   });\n \n   test('Bots not enabled', async () => {\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5332",
    "pr_id": 5332,
    "issue_id": 5275,
    "repo": "medplum/medplum",
    "problem_statement": "npx medplum aws update-config is maybe not working?\nDuring a workshop, a developer using the `aws update-config` during a screen share pointed out that the update output wasn't picking up all of their changes. \r\n\r\n## Root Cause\r\nThere is a merging of configs that happens, but only a few values from the config that gets passed in from the command line get used.\r\n\r\nIf you were to run:\r\n\r\n```bash\r\nnpm run medplum -- aws update-config demo-ian --file medplum.demo-ian.config.json\r\n```\r\nThe script then also looks for a file name `medplum.demo-ian.config.server.json` to pull config data from\r\nand the **only** values that get pulled from the config passed on the command line are `apiPort` , `baseUrl`, `appDomainName` and `storageDomainName`.\r\n\r\n\r\n## Proposed Resolution\r\nThe documentation provided by the CLI needs to be more explicit about the naming convention for configuration files in picks ups and what values it can derive from them.  \r\n\r\nWe won't change functionality here, just update the built-in help for this command. ",
    "issue_word_count": 172,
    "test_files_count": 2,
    "non_test_files_count": 3,
    "pr_changed_files": [
      "packages/cli/src/aws/index.ts",
      "packages/cli/src/aws/update-config.test.ts",
      "packages/cli/src/aws/update-config.ts",
      "packages/cli/src/util/command.test.ts",
      "packages/cli/src/util/command.ts"
    ],
    "pr_changed_test_files": [
      "packages/cli/src/aws/update-config.test.ts",
      "packages/cli/src/util/command.test.ts"
    ],
    "base_commit": "9b57ce6744acfbe1afabee06a9ae88f114c457f3",
    "head_commit": "c6f03f02c3866a7da66bb6dfcaef1a9d186a78ff",
    "repo_url": "https://github.com/medplum/medplum/pull/5332",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5332",
    "dockerfile": "",
    "pr_merged_at": "2024-10-07T17:12:59.000Z",
    "patch": "diff --git a/packages/cli/src/aws/index.ts b/packages/cli/src/aws/index.ts\nindex ff93aed14e..4091cf8d05 100644\n--- a/packages/cli/src/aws/index.ts\n+++ b/packages/cli/src/aws/index.ts\n@@ -1,5 +1,5 @@\n import { Command } from 'commander';\n-import { createMedplumCommand } from '../util/command';\n+import { color, createMedplumCommand, processDescription } from '../util/command';\n import { describeStacksCommand } from './describe';\n import { initStackCommand } from './init';\n import { listStacksCommand } from './list';\n@@ -24,9 +24,20 @@ export function buildAwsCommand(): Command {\n   aws\n     .command('update-config')\n     .alias('deploy-config')\n-    .description('Update the AWS Parameter Store config values')\n+    .summary('Update the AWS Parameter Store config values.')\n+    .description(\n+      processDescription(\n+        'Update the AWS Parameter Store config values.\\n\\nConfiguration values come from a file named **medplum.<tag>.config.server.json** where **<tag>** is the Medplum stack tag.\\n\\n' +\n+          color.yellow('**Services must be restarted to apply changes.**')\n+      )\n+    )\n     .argument('<tag>', 'The Medplum stack tag')\n-    .option('--file [file]', 'Specifies the config file to use. If not specified, the file is based on the tag.')\n+    .option(\n+      '--file [file]',\n+      processDescription(\n+        'File to provide overrides for **apiPort**, **baseUrl**, **appDomainName** and **storageDomainName** values that appear in the config file.'\n+      )\n+    )\n     .option(\n       '--dryrun',\n       'Displays the operations that would be performed using the specified command without actually running them.'\n\ndiff --git a/packages/cli/src/aws/update-config.ts b/packages/cli/src/aws/update-config.ts\nindex 606c6ba187..2d0f8ed49c 100644\n--- a/packages/cli/src/aws/update-config.ts\n+++ b/packages/cli/src/aws/update-config.ts\n@@ -1,7 +1,8 @@\n import { MedplumInfraConfig } from '@medplum/core';\n-import { readConfig, readServerConfig } from '../utils';\n+import { readConfig, readServerConfig, getConfigFileName } from '../utils';\n import { closeTerminal, initTerminal, print, yesOrNo } from './terminal';\n import { printConfigNotFound, writeParameters } from './utils';\n+import { color } from '../util/command';\n \n export interface UpdateConfigOptions {\n   file?: string;\n@@ -26,6 +27,16 @@ export async function updateConfigCommand(tag: string, options: UpdateConfigOpti\n \n     const serverConfig = readServerConfig(tag) ?? {};\n \n+    // If the server config is empty, prompt the user to proceed\n+    if (!options.yes && Object.keys(serverConfig).length === 0) {\n+      const serverConfigFileName = getConfigFileName(tag, { server: true });\n+      console.log(color.yellow(`Config file ${serverConfigFileName} not found!`));\n+      if (!(await yesOrNo('Do you want to proceed?'))) {\n+        console.log(color.red(`Run Aborted, please ensure ${serverConfigFileName} is present and try again.`));\n+        return;\n+      }\n+    }\n+\n     checkConfigConflicts(infraConfig, serverConfig);\n     mergeConfigs(infraConfig, serverConfig);\n \n@@ -45,7 +56,9 @@ export async function updateConfigCommand(tag: string, options: UpdateConfigOpti\n       )\n     );\n \n-    if (options.yes || (await yesOrNo('Do you want to store these values in AWS Parameter Store?'))) {\n+    if (options.dryrun) {\n+      console.log(color.yellow('Dry run - skipping updates!'));\n+    } else if (options.yes || (await yesOrNo('Do you want to store these values in AWS Parameter Store?'))) {\n       await writeParameters(\n         infraConfig.region,\n         `/medplum/${infraConfig.name}/`,\n\ndiff --git a/packages/cli/src/util/command.ts b/packages/cli/src/util/command.ts\nindex adc4193276..725c54e797 100644\n--- a/packages/cli/src/util/command.ts\n+++ b/packages/cli/src/util/command.ts\n@@ -1,5 +1,26 @@\n import { Command, Option } from 'commander';\n \n+// CLI color highlighting\n+const RESET = '\\x1b[0m';\n+const BOLD = '\\x1b[1m';\n+const RED = '\\x1b[31m';\n+const GREEN = '\\x1b[32m';\n+const YELLOW = '\\x1b[33m';\n+const BLUE = '\\x1b[34m';\n+\n+export const color = {\n+  red: (text: string) => `${RED}${text}${RESET}`,\n+  green: (text: string) => `${GREEN}${text}${RESET}`,\n+  yellow: (text: string) => `${YELLOW}${text}${RESET}`,\n+  blue: (text: string) => `${BLUE}${text}${RESET}`,\n+  bold: (text: string) => `${BOLD}${text}${RESET}`,\n+};\n+\n+// Bold text wrapped in ** **\n+export const processDescription = (desc: string): string => {\n+  return desc.replace(/\\*\\*(.*?)\\*\\*/g, (_, text) => color.bold(text));\n+};\n+\n export function createMedplumCommand(name: string): Command {\n   return new Command(name)\n     .option('--client-id <clientId>', 'FHIR server client id')\n",
    "test_patch": "diff --git a/packages/cli/src/aws/update-config.test.ts b/packages/cli/src/aws/update-config.test.ts\nindex 0fcb3e7564..b50b73b1eb 100644\n--- a/packages/cli/src/aws/update-config.test.ts\n+++ b/packages/cli/src/aws/update-config.test.ts\n@@ -73,11 +73,8 @@ describe('update-config command', () => {\n       'utf8'\n     );\n \n-    readline.createInterface = jest.fn(() =>\n-      mockReadline(\n-        'y' // Yes, write to Parameter Store\n-      )\n-    );\n+    // Mock readline.createInterface for two calls\n+    (readline.createInterface as jest.Mock).mockImplementation(() => mockReadline('y', 'y'));\n \n     await main(['node', 'index.js', 'aws', 'update-config', tag]);\n     unlinkSync(infraFileName);\n\ndiff --git a/packages/cli/src/util/command.test.ts b/packages/cli/src/util/command.test.ts\nnew file mode 100644\nindex 0000000000..513bf6b536\n--- /dev/null\n+++ b/packages/cli/src/util/command.test.ts\n@@ -0,0 +1,56 @@\n+import { color, processDescription } from './command';\n+\n+describe('CLI Color Utilities', () => {\n+  // Tests for color object\n+  describe('color object', () => {\n+    test('red function adds red color codes', () => {\n+      expect(color.red('test')).toBe('\\x1b[31mtest\\x1b[0m');\n+    });\n+\n+    test('green function adds green color codes', () => {\n+      expect(color.green('test')).toBe('\\x1b[32mtest\\x1b[0m');\n+    });\n+\n+    test('yellow function adds yellow color codes', () => {\n+      expect(color.yellow('test')).toBe('\\x1b[33mtest\\x1b[0m');\n+    });\n+\n+    test('blue function adds blue color codes', () => {\n+      expect(color.blue('test')).toBe('\\x1b[34mtest\\x1b[0m');\n+    });\n+\n+    test('bold function adds bold formatting codes', () => {\n+      expect(color.bold('test')).toBe('\\x1b[1mtest\\x1b[0m');\n+    });\n+  });\n+\n+  // Tests for processDescription function\n+  describe('processDescription function', () => {\n+    test('replaces **text** with bold formatting', () => {\n+      const input = 'This is a **bold** text';\n+      const expected = `This is a ${color.bold('bold')} text`;\n+      expect(processDescription(input)).toBe(expected);\n+    });\n+\n+    test('handles multiple bold sections', () => {\n+      const input = '**Hello** world, this is **important**';\n+      const expected = `${color.bold('Hello')} world, this is ${color.bold('important')}`;\n+      expect(processDescription(input)).toBe(expected);\n+    });\n+\n+    test('returns original string if no bold markers are present', () => {\n+      const input = 'No bold text here';\n+      expect(processDescription(input)).toBe(input);\n+    });\n+\n+    test('handles empty string', () => {\n+      expect(processDescription('')).toBe('');\n+    });\n+\n+    test('handles string with only bold markers', () => {\n+      const input = '**bold**';\n+      const expected = color.bold('bold');\n+      expect(processDescription(input)).toBe(expected);\n+    });\n+  });\n+});\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5328",
    "pr_id": 5328,
    "issue_id": 5310,
    "repo": "medplum/medplum",
    "problem_statement": "Search parameters for Slot.end and Appointment.end\nUser Driven: https://medplum.slack.com/archives/C078NUJP6B1/p1727303627541449\n\nThe base FHIR spec doesn't include a search parameter for `Slot.end` or `Appointment.end`. This makes it very clunky to find out which slots/appointments overlap a given point in time. \n\nCurrently the workaround is to: \n1. Search for all slots that start in some  large time range before the current instant\n2. Filter in memory to those that also end after the current instant",
    "issue_word_count": 84,
    "test_files_count": 1,
    "non_test_files_count": 5,
    "pr_changed_files": [
      "packages/definitions/dist/fhir/r4/search-parameters-medplum.json",
      "packages/docs/static/data/resourceDefinitions/appointment.json",
      "packages/docs/static/data/resourceDefinitions/slot.json",
      "packages/server/src/fhir/search-params.test.ts",
      "packages/server/src/migrations/schema/index.ts",
      "packages/server/src/migrations/schema/v78.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/search-params.test.ts"
    ],
    "base_commit": "87df9aa06b8a5617313b70afce839ae296432303",
    "head_commit": "6342b35b14d6481986211d4f0245f5915376e61b",
    "repo_url": "https://github.com/medplum/medplum/pull/5328",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5328",
    "dockerfile": "",
    "pr_merged_at": "2024-10-01T18:57:48.000Z",
    "patch": "diff --git a/packages/definitions/dist/fhir/r4/search-parameters-medplum.json b/packages/definitions/dist/fhir/r4/search-parameters-medplum.json\nindex 6ce0b76f72..f831b563c1 100644\n--- a/packages/definitions/dist/fhir/r4/search-parameters-medplum.json\n+++ b/packages/definitions/dist/fhir/r4/search-parameters-medplum.json\n@@ -728,6 +728,42 @@\n         \"type\": \"token\",\n         \"expression\": \"Location.physicalType\"\n       }\n+    },\n+    {\n+      \"fullUrl\": \"https://medplum.com/fhir/SearchParameter/Appointment-end\",\n+      \"resource\": {\n+        \"resourceType\": \"SearchParameter\",\n+        \"id\": \"Appointment-end\",\n+        \"url\": \"https://medplum.com/fhir/SearchParameter/Appointment-end\",\n+        \"version\": \"4.0.1\",\n+        \"name\": \"end\",\n+        \"status\": \"draft\",\n+        \"publisher\": \"Medplum\",\n+        \"description\": \"The end time of the Appointment\",\n+        \"code\": \"end\",\n+        \"base\": [\"Appointment\"],\n+        \"type\": \"date\",\n+        \"expression\": \"Appointment.end\",\n+        \"target\": [\"Appointment\"]\n+      }\n+    },\n+    {\n+      \"fullUrl\": \"https://medplum.com/fhir/SearchParameter/Slot-end\",\n+      \"resource\": {\n+        \"resourceType\": \"SearchParameter\",\n+        \"id\": \"Slot-end\",\n+        \"url\": \"https://medplum.com/fhir/SearchParameter/Slot-end\",\n+        \"version\": \"4.0.1\",\n+        \"name\": \"end\",\n+        \"status\": \"draft\",\n+        \"publisher\": \"Medplum\",\n+        \"description\": \"The end time of the Slot\",\n+        \"code\": \"end\",\n+        \"base\": [\"Slot\"],\n+        \"type\": \"date\",\n+        \"expression\": \"Slot.end\",\n+        \"target\": [\"Slot\"]\n+      }\n     }\n   ]\n }\n\ndiff --git a/packages/docs/static/data/resourceDefinitions/appointment.json b/packages/docs/static/data/resourceDefinitions/appointment.json\nindex 2c5d24154c..f43648cf94 100644\n--- a/packages/docs/static/data/resourceDefinitions/appointment.json\n+++ b/packages/docs/static/data/resourceDefinitions/appointment.json\n@@ -827,6 +827,12 @@\n       \"type\": \"reference\",\n       \"description\": \"Additional information to support the appointment\",\n       \"expression\": \"Appointment.supportingInformation\"\n+    },\n+    {\n+      \"name\": \"end\",\n+      \"type\": \"date\",\n+      \"description\": \"The end time of the Appointment\",\n+      \"expression\": \"Appointment.end\"\n     }\n   ]\n }\n\ndiff --git a/packages/docs/static/data/resourceDefinitions/slot.json b/packages/docs/static/data/resourceDefinitions/slot.json\nindex ac1a697352..d4969e20b3 100644\n--- a/packages/docs/static/data/resourceDefinitions/slot.json\n+++ b/packages/docs/static/data/resourceDefinitions/slot.json\n@@ -396,6 +396,12 @@\n       \"type\": \"token\",\n       \"description\": \"The free/busy status of the appointment\",\n       \"expression\": \"Slot.status\"\n+    },\n+    {\n+      \"name\": \"end\",\n+      \"type\": \"date\",\n+      \"description\": \"The end time of the Slot\",\n+      \"expression\": \"Slot.end\"\n     }\n   ]\n }\n\ndiff --git a/packages/server/src/migrations/schema/index.ts b/packages/server/src/migrations/schema/index.ts\nindex 1efd3ecfdd..3dd73f672c 100644\n--- a/packages/server/src/migrations/schema/index.ts\n+++ b/packages/server/src/migrations/schema/index.ts\n@@ -83,3 +83,4 @@ export * as v74 from './v74';\n export * as v75 from './v75';\n export * as v76 from './v76';\n export * as v77 from './v77';\n+export * as v78 from './v78';\n\ndiff --git a/packages/server/src/migrations/schema/v78.ts b/packages/server/src/migrations/schema/v78.ts\nnew file mode 100644\nindex 0000000000..da4399a4af\n--- /dev/null\n+++ b/packages/server/src/migrations/schema/v78.ts\n@@ -0,0 +1,13 @@\n+/*\n+ * Generated by @medplum/generator\n+ * Do not edit manually.\n+ */\n+\n+import { PoolClient } from 'pg';\n+\n+export async function run(client: PoolClient): Promise<void> {\n+  await client.query('ALTER TABLE IF EXISTS \"Appointment\" ADD COLUMN IF NOT EXISTS \"end\" TIMESTAMPTZ');\n+  await client.query('CREATE INDEX CONCURRENTLY IF NOT EXISTS Appointment_end_idx ON \"Appointment\" (\"end\")');\n+  await client.query('ALTER TABLE IF EXISTS \"Slot\" ADD COLUMN IF NOT EXISTS \"end\" TIMESTAMPTZ');\n+  await client.query('CREATE INDEX CONCURRENTLY IF NOT EXISTS Slot_end_idx ON \"Slot\" (\"end\")');\n+}\n",
    "test_patch": "diff --git a/packages/server/src/fhir/search-params.test.ts b/packages/server/src/fhir/search-params.test.ts\nnew file mode 100644\nindex 0000000000..4d7ee82e3f\n--- /dev/null\n+++ b/packages/server/src/fhir/search-params.test.ts\n@@ -0,0 +1,175 @@\n+import { createReference, Operator } from '@medplum/core';\n+import { Appointment, Practitioner, Slot } from '@medplum/fhirtypes';\n+import { randomUUID } from 'node:crypto';\n+import { initAppServices, shutdownApp } from '../app';\n+import { loadTestConfig, MedplumServerConfig } from '../config';\n+import { createTestProject, withTestContext } from '../test.setup';\n+import { Repository } from './repo';\n+\n+describe('Medplum Custom Search Parameters', () => {\n+  let config: MedplumServerConfig;\n+  let repo: Repository;\n+\n+  beforeAll(async () => {\n+    config = await loadTestConfig();\n+    await initAppServices(config);\n+  });\n+\n+  beforeEach(async () => {\n+    const { project } = await createTestProject();\n+    repo = new Repository({\n+      strictMode: true,\n+      projects: [project.id as string],\n+      author: { reference: 'User/' + randomUUID() },\n+    });\n+  });\n+\n+  afterAll(async () => {\n+    await shutdownApp();\n+  });\n+\n+  test('Search by Appointment.end', () =>\n+    withTestContext(async () => {\n+      const startTime1 = new Date('1970-01-01T12:00:00.000Z').toISOString();\n+      const endTime1 = new Date('1970-01-01T13:00:00.000Z').toISOString();\n+\n+      const startTime2 = new Date('1970-01-01T13:00:00.000Z').toISOString();\n+      const endTime2 = new Date('1970-01-01T14:00:00.000Z').toISOString();\n+\n+      const practitioner = await repo.createResource<Practitioner>({\n+        resourceType: 'Practitioner',\n+        name: [{ prefix: ['Dr.'], given: ['Alice'], family: 'Smith' }],\n+      });\n+\n+      expect(practitioner).toBeDefined();\n+\n+      const baseAppointment = {\n+        resourceType: 'Appointment',\n+        status: 'booked',\n+        participant: [\n+          {\n+            type: [\n+              {\n+                coding: [\n+                  {\n+                    system: 'http://terminology.hl7.org/CodeSystem/v3-ParticipationType',\n+                    code: 'ATND',\n+                    display: 'attender',\n+                  },\n+                ],\n+              },\n+            ],\n+            actor: createReference(practitioner),\n+            status: 'accepted',\n+          },\n+        ],\n+        appointmentType: {\n+          coding: [\n+            {\n+              system: 'http://terminology.hl7.org/CodeSystem/v2-0276',\n+              code: 'FOLLOWUP',\n+              display: 'A follow up visit from a previous appointment',\n+            },\n+          ],\n+        },\n+      } satisfies Appointment;\n+\n+      const appointment1 = await repo.createResource<Appointment>({\n+        ...baseAppointment,\n+        start: startTime1,\n+        end: endTime1,\n+      });\n+\n+      const appointment2 = await repo.createResource<Appointment>({\n+        ...baseAppointment,\n+        start: startTime2,\n+        end: endTime2,\n+      });\n+\n+      expect(appointment1).toBeDefined();\n+      expect(appointment2).toBeDefined();\n+\n+      const results1 = await repo.search({\n+        resourceType: 'Appointment',\n+        filters: [\n+          { code: 'date', operator: Operator.GREATER_THAN_OR_EQUALS, value: startTime1 },\n+          { code: 'end', operator: Operator.LESS_THAN_OR_EQUALS, value: startTime2 },\n+        ],\n+      });\n+\n+      expect(results1.entry).toHaveLength(1);\n+      expect(results1.entry?.[0].resource?.resourceType).toEqual('Appointment');\n+      expect((results1.entry?.[0].resource as Appointment).id).toEqual(appointment1.id);\n+\n+      const results2 = await repo.search({\n+        resourceType: 'Appointment',\n+        filters: [\n+          { code: 'date', operator: Operator.GREATER_THAN_OR_EQUALS, value: startTime1 },\n+          { code: 'end', operator: Operator.LESS_THAN_OR_EQUALS, value: endTime2 },\n+        ],\n+      });\n+\n+      expect(results2.entry).toHaveLength(2);\n+    }));\n+\n+  test('Search by Slot.end', () =>\n+    withTestContext(async () => {\n+      const startTime1 = new Date('1970-01-01T12:00:00.000Z').toISOString();\n+      const endTime1 = new Date('1970-01-01T13:00:00.000Z').toISOString();\n+\n+      const startTime2 = new Date('1970-01-01T13:00:00.000Z').toISOString();\n+      const endTime2 = new Date('1970-01-01T14:00:00.000Z').toISOString();\n+\n+      const practitioner = await repo.createResource<Practitioner>({\n+        resourceType: 'Practitioner',\n+        name: [{ prefix: ['Dr.'], given: ['Alice'], family: 'Smith' }],\n+      });\n+\n+      expect(practitioner).toBeDefined();\n+\n+      const baseSlot = {\n+        resourceType: 'Slot',\n+        status: 'free',\n+        schedule: { reference: 'Schedule/123' },\n+        start: new Date().toISOString(),\n+        end: new Date().toISOString(),\n+      } satisfies Slot;\n+\n+      const slot1 = await repo.createResource<Slot>({\n+        ...baseSlot,\n+        start: startTime1,\n+        end: endTime1,\n+      });\n+\n+      const slot2 = await repo.createResource<Slot>({\n+        ...baseSlot,\n+        start: startTime2,\n+        end: endTime2,\n+      });\n+\n+      expect(slot1).toBeDefined();\n+      expect(slot2).toBeDefined();\n+\n+      const results1 = await repo.search({\n+        resourceType: 'Slot',\n+        filters: [\n+          { code: 'start', operator: Operator.GREATER_THAN_OR_EQUALS, value: startTime1 },\n+          { code: 'end', operator: Operator.LESS_THAN_OR_EQUALS, value: startTime2 },\n+        ],\n+      });\n+\n+      expect(results1.entry).toHaveLength(1);\n+      expect(results1.entry?.[0].resource?.resourceType).toEqual('Slot');\n+      expect((results1.entry?.[0].resource as Slot).id).toEqual(slot1.id);\n+\n+      const results2 = await repo.search({\n+        resourceType: 'Slot',\n+        filters: [\n+          { code: 'start', operator: Operator.GREATER_THAN_OR_EQUALS, value: startTime1 },\n+          { code: 'end', operator: Operator.LESS_THAN_OR_EQUALS, value: endTime2 },\n+        ],\n+      });\n+\n+      expect(results2.entry).toHaveLength(2);\n+    }));\n+});\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5317",
    "pr_id": 5317,
    "issue_id": 3084,
    "repo": "medplum/medplum",
    "problem_statement": "Add FHIRPath Patch support\nHi!\r\n\r\nI am making a PATCH request to a Patient with the following body:\r\n```json\r\n{\r\n  \"resourceType\": \"Parameters\",\r\n  \"parameter\": [\r\n    {\r\n      \"name\": \"operation\",\r\n      \"part\": [\r\n        {\r\n          \"name\": \"type\",\r\n          \"valueCode\": \"add\"\r\n        },\r\n        {\r\n          \"name\": \"path\",\r\n          \"valueString\": \"Patient\"\r\n        },\r\n        {\r\n          \"name\": \"name\",\r\n          \"valueString\": \"birthDate\"\r\n        },\r\n        {\r\n          \"name\": \"value\",\r\n          \"valueDate\": \"2021-02-01\"\r\n        }\r\n      ]\r\n    },\r\n    {\r\n      \"name\": \"operation\",\r\n      \"part\": [\r\n        {\r\n          \"name\": \"type\",\r\n          \"valueCode\": \"delete\"\r\n        },\r\n        {\r\n          \"name\": \"path\",\r\n          \"valueString\": \"Patient.active\"\r\n        }\r\n      ]\r\n    },\r\n    {\r\n      \"name\": \"operation\",\r\n      \"part\": [\r\n        {\r\n          \"name\": \"type\",\r\n          \"valueCode\": \"replace\"\r\n        },\r\n        {\r\n          \"name\": \"path\",\r\n          \"valueString\": \"Patient.gender\"\r\n        },\r\n        {\r\n          \"name\": \"value\",\r\n          \"valueCode\": \"female\"\r\n        }\r\n      ]\r\n    },\r\n    {\r\n      \"name\": \"operation\",\r\n      \"part\": [\r\n        {\r\n          \"name\": \"type\",\r\n          \"valueCode\": \"insert\"\r\n        },\r\n        {\r\n          \"name\": \"path\",\r\n          \"valueString\": \"Patient.name\"\r\n        },\r\n        {\r\n          \"name\": \"index\",\r\n          \"valueInteger\": 0\r\n        },\r\n        {\r\n          \"name\": \"value\",\r\n          \"valueHumanName\": {\r\n            \"family\": \"Family\"\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nThe Patient resource can be either empty or look as follows:\r\n```json\r\n{\r\n\t\"resourceType\": \"Patient\",\r\n\t\"active\": false,\r\n\t\"name\": [\r\n\t\t{\r\n\t\t\t\"family\": \"Test\"\r\n\t\t}\r\n\t],\r\n\t\"gender\": \"male\",\r\n\t\"id\": \"0e302b42-d9a8-468d-a5c0-dea6ade9811b\",\r\n\t\"meta\": {\r\n\t\t\"versionId\": \"16779e39-7164-4e0a-a4d8-8d00aab42426\",\r\n\t\t\"lastUpdated\": \"2023-10-19T17:03:05.835Z\"\r\n\t}\r\n}\r\n```\r\n\r\nMedplum returns the following OperationOutcome:\r\n```json\r\n{\r\n\t\"resourceType\": \"OperationOutcome\",\r\n\t\"issue\": [\r\n\t\t{\r\n\t\t\t\"severity\": \"error\",\r\n\t\t\t\"code\": \"invalid\",\r\n\t\t\t\"details\": {\r\n\t\t\t\t\"text\": \"patch.map is not a function\"\r\n\t\t\t}\r\n\t\t}\r\n\t],\r\n\t\"extension\": [\r\n\t\t{\r\n\t\t\t\"url\": \"https://medplum.com/fhir/StructureDefinition/tracing\",\r\n\t\t\t\"extension\": [\r\n\t\t\t\t{\r\n\t\t\t\t\t\"url\": \"requestId\",\r\n\t\t\t\t\t\"valueUuid\": \"57c13314-f51c-4c01-af65-be10fe2dd1bc\"\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\t\"url\": \"traceId\",\r\n\t\t\t\t\t\"valueUuid\": \"5d99bbf5-5e24-4696-8e0b-ff245f0cdbd6\"\r\n\t\t\t\t}\r\n\t\t\t]\r\n\t\t}\r\n\t]\r\n}\r\n```\r\n\r\nCould you tell me what is going wrong? Is this a bug?\r\n\r\nThe same request works with the HAPI FHIR server, so I assume the request is correct, but please tell me if it is actually incorrect.\r\n\r\nThank you!",
    "issue_word_count": 218,
    "test_files_count": 1,
    "non_test_files_count": 2,
    "pr_changed_files": [
      "packages/docs/docs/fhir-datastore/fhir-batch-requests.mdx",
      "packages/fhir-router/src/batch.test.ts",
      "packages/fhir-router/src/batch.ts"
    ],
    "pr_changed_test_files": [
      "packages/fhir-router/src/batch.test.ts"
    ],
    "base_commit": "8f0bdfdbfdc1c404306666b35e0d36777ea54973",
    "head_commit": "5b4405a6e96b6c2babf8c834f883321d3dac7202",
    "repo_url": "https://github.com/medplum/medplum/pull/5317",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5317",
    "dockerfile": "",
    "pr_merged_at": "2024-09-30T16:52:32.000Z",
    "patch": "diff --git a/packages/docs/docs/fhir-datastore/fhir-batch-requests.mdx b/packages/docs/docs/fhir-datastore/fhir-batch-requests.mdx\nindex d58b230e49..55a9523652 100644\n--- a/packages/docs/docs/fhir-datastore/fhir-batch-requests.mdx\n+++ b/packages/docs/docs/fhir-datastore/fhir-batch-requests.mdx\n@@ -127,9 +127,9 @@ to provide strong transactional guarantees around the operation in a single, sim\n \n ## PATCH actions in a Batch\n \n-Because the request body of a PATCH request is an array of JSON patch operations, not a resource, some extra conversion\n-is required to represent these actions in a batch request. The [FHIR recommended pattern](http://hl7.org/fhir/R5/http.html#jsonpatch-transaction)\n-for this use case is to [base64 encode](https://datatracker.ietf.org/doc/html/rfc4648#section-4) the JSON patch array\n+Because the request body of a PATCH request is an array of [JSON Patch](https://jsonpatch.com/) operations, not a resource,\n+some extra conversion is required to represent these actions in a batch request. The [FHIR recommended pattern](http://hl7.org/fhir/R5/http.html#jsonpatch-transaction)\n+for this use case is to [base64 encode](https://datatracker.ietf.org/doc/html/rfc4648#section-4) the JSON Patch array\n and represent it as a [Binary](/docs/api/fhir/resources/binary) resource:\n \n ```js\n@@ -147,6 +147,40 @@ and represent it as a [Binary](/docs/api/fhir/resources/binary) resource:\n }\n ```\n \n+Additionally, Medplum supports passing JSON Patch formatted as a [Parameters](/docs/api/fhir/resources/parameters)\n+resource, making it easier to see what operations are happening in the batch:\n+\n+```js\n+{\n+  \"request\": {\n+    \"method\": \"PATCH\",\n+    \"url\": \"Patient/6ffaaab4-ff7e-4416-80c7-8fce95c3e31c\"\n+  },\n+  \"resource\": {\n+    \"resourceType\": \"Parameters\",\n+    \"parameter\": [\n+      {\n+        \"name\": \"operation\",\n+        \"part\": [\n+          { \"name\": \"op\", \"valueCode\": \"test\" },\n+          { \"name\": \"path\", \"valueString\": \"/active\" },\n+          { \"name\": \"value\", \"valueString\": \"false\" }\n+        ]\n+      },\n+      {\n+        \"name\": \"operation\",\n+        \"part\": [\n+          { \"name\": \"op\", \"valueCode\": \"add\" },\n+          { \"name\": \"path\", \"valueString\": \"/name/-\" },\n+          // Note that values must be JSON encoded\n+          { \"name\": \"value\", \"valueString\": \"{\\\"given\\\":[\\\"Dave\\\"],\\\"family\\\":\\\"Smith\\\"}\" }\n+        ]\n+      }\n+    ]\n+  }\n+}\n+```\n+\n ## Medplum Autobatching\n \n The Medplum Client provides the option to automatically batch FHIR `read` and `search` requests using the `autoBatchTime` parameter. This field allows you to set a time window during which to batch up any `GET` requests. After this window expires, the `MedplumClient` will add them to a `Bundle` behind the scenes and then execute them as a batch request.\n\ndiff --git a/packages/fhir-router/src/batch.ts b/packages/fhir-router/src/batch.ts\nindex 5411abc565..6f4adf7bc0 100644\n--- a/packages/fhir-router/src/batch.ts\n+++ b/packages/fhir-router/src/batch.ts\n@@ -9,7 +9,14 @@ import {\n   normalizeOperationOutcome,\n   notFound,\n } from '@medplum/core';\n-import { Bundle, BundleEntry, BundleEntryRequest, OperationOutcome, Resource } from '@medplum/fhirtypes';\n+import {\n+  Bundle,\n+  BundleEntry,\n+  BundleEntryRequest,\n+  OperationOutcome,\n+  ParametersParameter,\n+  Resource,\n+} from '@medplum/fhirtypes';\n import { FhirRequest, FhirRouteHandler, FhirRouteMetadata, FhirRouter, RestInteraction } from './fhirrouter';\n import { FhirRepository } from './repo';\n import { HttpMethod, RouteResult } from './urlrouter';\n@@ -459,21 +466,74 @@ class BatchProcessor {\n \n   private parsePatchBody(entry: BundleEntry): any {\n     const patchResource = entry.resource;\n-    if (patchResource?.resourceType !== 'Binary') {\n-      throw new OperationOutcomeError(badRequest('Patch entry must include a Binary resource'));\n-    }\n-    if (!patchResource.data) {\n-      throw new OperationOutcomeError(badRequest('Missing entry.resource.data'));\n+    let body: any[] | undefined;\n+    if (patchResource?.resourceType === 'Binary') {\n+      if (!patchResource.data) {\n+        throw new OperationOutcomeError(badRequest('Missing entry.resource.data'));\n+      }\n+\n+      body = JSON.parse(Buffer.from(patchResource.data, 'base64').toString('utf8'));\n+    } else if (patchResource?.resourceType === 'Parameters') {\n+      if (patchResource.parameter) {\n+        body = [];\n+        for (const param of patchResource.parameter) {\n+          if (param.name === 'operation') {\n+            const op = this.parsePatchParameter(param);\n+            body.push(op);\n+          }\n+        }\n+      }\n+    } else {\n+      throw new OperationOutcomeError(badRequest('Patch entry must include a Binary or Parameters resource'));\n     }\n \n-    const body = JSON.parse(Buffer.from(patchResource.data, 'base64').toString('utf8'));\n     if (!Array.isArray(body)) {\n-      throw new OperationOutcomeError(badRequest('Patch body must be an array'));\n+      throw new OperationOutcomeError(badRequest('Decoded PATCH body must be an array'));\n     }\n \n     return this.rewriteIdsInArray(body);\n   }\n \n+  private parsePatchParameter(param: ParametersParameter): Record<string, any> {\n+    const operation = param.part?.find((p) => p.name === 'op')?.valueCode;\n+    if (!operation) {\n+      // FHIRPatch will also use Parameters; however, it uses `name = 'type'`\n+      // We can use this to disambiguate the two in the future\n+      throw new OperationOutcomeError(badRequest('PATCH Parameters missing op'));\n+    }\n+\n+    const op: Record<string, any> = { op: operation };\n+    switch (operation) {\n+      case 'add':\n+      case 'replace':\n+      case 'test':\n+        // part is guaranteed to be defined, since that's where operation was found\n+        for (const part of param.part as ParametersParameter[]) {\n+          if (part.name === 'path') {\n+            op.path = part.valueString;\n+          } else if (part.name === 'value') {\n+            op.value = JSON.parse(part.valueString ?? '');\n+          }\n+        }\n+        break;\n+      case 'copy':\n+      case 'move':\n+        for (const part of param.part as ParametersParameter[]) {\n+          if (part.name === 'path') {\n+            op.path = part.valueString;\n+          } else if (part.name === 'from') {\n+            op.from = part.valueString;\n+          }\n+        }\n+        break;\n+      case 'remove':\n+        op.path = param.part?.find((p) => p.name === 'path')?.valueString;\n+        break;\n+    }\n+\n+    return op;\n+  }\n+\n   private rewriteIds(input: any): any {\n     if (Array.isArray(input)) {\n       return this.rewriteIdsInArray(input);\n",
    "test_patch": "diff --git a/packages/fhir-router/src/batch.test.ts b/packages/fhir-router/src/batch.test.ts\nindex 99ec8c14c3..8e031d294d 100644\n--- a/packages/fhir-router/src/batch.test.ts\n+++ b/packages/fhir-router/src/batch.test.ts\n@@ -569,9 +569,79 @@ describe('Batch', () => {\n     expect(results.length).toEqual(3);\n     expect(results[0].response?.status).toEqual('200');\n     expect(results[1].response?.status).toEqual('400');\n-    expect(results[1].response?.outcome?.issue?.[0]?.details?.text).toEqual('Patch body must be an array');\n+    expect(results[1].response?.outcome?.issue?.[0]?.details?.text).toEqual('Decoded PATCH body must be an array');\n     expect(results[2].response?.status).toEqual('400');\n-    expect(results[2].response?.outcome?.issue?.[0]?.details?.text).toEqual('Patch body must be an array');\n+    expect(results[2].response?.outcome?.issue?.[0]?.details?.text).toEqual('Decoded PATCH body must be an array');\n+  });\n+\n+  test('Process batch patch Parameters', async () => {\n+    const patient = await repo.createResource<Patient>({\n+      resourceType: 'Patient',\n+      gender: 'unknown',\n+    });\n+\n+    const bundle = await processBatch(req, repo, router, {\n+      resourceType: 'Bundle',\n+      type: 'batch',\n+      entry: [\n+        {\n+          // Entry 1: Simple patch (success)\n+          request: {\n+            method: 'PATCH',\n+            url: 'Patient/' + patient.id,\n+          },\n+          resource: {\n+            resourceType: 'Parameters',\n+            parameter: [\n+              {\n+                name: 'operation',\n+                part: [\n+                  { name: 'op', valueCode: 'add' },\n+                  { name: 'path', valueString: '/name' },\n+                  { name: 'value', valueString: '[{\"given\":[\"Dave\"],\"family\":\"Smith\"}]' },\n+                ],\n+              },\n+              {\n+                name: 'operation',\n+                part: [\n+                  { name: 'op', valueCode: 'copy' },\n+                  { name: 'from', valueString: '/name/0/family' },\n+                  { name: 'path', valueString: '/name/0/given/-' },\n+                ],\n+              },\n+              {\n+                name: 'operation',\n+                part: [\n+                  { name: 'op', valueCode: 'remove' },\n+                  { name: 'path', valueString: '/gender' },\n+                ],\n+              },\n+            ],\n+          },\n+        },\n+        {\n+          // Entry 2: Empty body (error)\n+          request: {\n+            method: 'PATCH',\n+            url: 'Patient/' + patient.id,\n+          },\n+          resource: {\n+            resourceType: 'Parameters',\n+          },\n+        },\n+      ],\n+    });\n+    expect(bundle).toBeDefined();\n+    expect(bundle.entry).toBeDefined();\n+\n+    const results = bundle.entry as BundleEntry[];\n+    expect(results.length).toEqual(2);\n+    expect(results[0].response?.status).toEqual('200');\n+    const updatedPatient = results[0].resource as Patient;\n+    expect(updatedPatient.name?.[0]?.given).toEqual(['Dave', 'Smith']);\n+    expect(updatedPatient.gender).toBeUndefined();\n+    expect(results[1].response?.status).toEqual('400');\n+    expect(results[1].response?.outcome?.issue?.[0]?.details?.text).toEqual('Decoded PATCH body must be an array');\n   });\n \n   test('JSONPath error messages', async () => {\n@@ -692,7 +762,7 @@ describe('Batch', () => {\n     expect(results.length).toEqual(1);\n     expect(results[0].response?.status).toEqual('400');\n     expect((results[0].response?.outcome as OperationOutcome).issue?.[0]?.details?.text).toEqual(\n-      'Patch entry must include a Binary resource'\n+      'Patch entry must include a Binary or Parameters resource'\n     );\n   });\n \n@@ -719,7 +789,7 @@ describe('Batch', () => {\n     expect(results.length).toEqual(1);\n     expect(results[0].response?.status).toEqual('400');\n     expect((results[0].response?.outcome as OperationOutcome).issue?.[0]?.details?.text).toEqual(\n-      'Patch entry must include a Binary resource'\n+      'Patch entry must include a Binary or Parameters resource'\n     );\n   });\n \n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5307",
    "pr_id": 5307,
    "issue_id": 5304,
    "repo": "medplum/medplum",
    "problem_statement": "Profile Validation not updating after updating Structure Definition\n## Repro\r\n- I had [this structure definition](https://app.medplum.com/StructureDefinition/b429006c-eb40-4dc1-94d9-91623a76ccba/timeline) uploaded on the server\r\n- On Medplum App, create a Practitioner with 2 name entries\r\n-  Navigate to the Profiles tab\r\n- Try to conform to this profile\r\n- Output: \"Invalid number of values: expected 1..1, but found 2 (Practitioner.name)\"\r\n\r\n- Modified the cardinality of `Practitioner.name` from `1..1` to `1..*`\r\n- Update the structure definition\r\n- Navigate back to the same Profiles tab\r\n-  Navigate to the Profiles tab\r\n- Try to conform to this profile\r\n- Output: \"Invalid number of values: expected 1..1, but found 2 (Practitioner.name)\"\r\n\r\n## Expected Behavior\r\nThe 2nd pass should validate. This is important because now that users can upload their own profiles, we need a way for them to update their StructureDefinition resources in cache without needing super admin privileges",
    "issue_word_count": 146,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/server/src/fhir/repo.test.ts",
      "packages/server/src/fhir/repo.ts"
    ],
    "pr_changed_test_files": [
      "packages/server/src/fhir/repo.test.ts"
    ],
    "base_commit": "8cf0a26a4f7f98d9c238c6658311d735c5de4949",
    "head_commit": "2e84df27152fae6e0d5fa4f2d65dec1199f4f5e2",
    "repo_url": "https://github.com/medplum/medplum/pull/5307",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5307",
    "dockerfile": "",
    "pr_merged_at": "2024-09-26T18:00:40.000Z",
    "patch": "diff --git a/packages/server/src/fhir/repo.ts b/packages/server/src/fhir/repo.ts\nindex eaca52fd8f..048643be6c 100644\n--- a/packages/server/src/fhir/repo.ts\n+++ b/packages/server/src/fhir/repo.ts\n@@ -13,6 +13,7 @@ import {\n   badRequest,\n   canReadResourceType,\n   canWriteResourceType,\n+  createReference,\n   deepEquals,\n   evalFhirPath,\n   evalFhirPathTyped,\n@@ -674,20 +675,31 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     resource.data = undefined;\n   }\n \n-  private async handleStorage(result: Resource, create: boolean): Promise<void> {\n-    if (!this.isCacheOnly(result)) {\n-      await this.writeToDatabase(result, create);\n-    } else if (result.resourceType === 'Subscription' && result.channel?.type === 'websocket') {\n+  /**\n+   * Handles persisting data to at-rest storage: cache and/or database.\n+   * This method handles all the special cases for storage, including cache invalidation.\n+   * @param resource - The resource to store.\n+   * @param create - Whether the resource is being create, or updated in place.\n+   */\n+  private async handleStorage(resource: Resource, create: boolean): Promise<void> {\n+    if (!this.isCacheOnly(resource)) {\n+      await this.writeToDatabase(resource, create);\n+    }\n+    await this.setCacheEntry(resource);\n+\n+    // Handle special cases for resource caching\n+    if (resource.resourceType === 'Subscription' && resource.channel?.type === 'websocket') {\n       const redis = getRedis();\n-      const project = result?.meta?.project;\n+      const project = resource?.meta?.project;\n       if (!project) {\n         throw new OperationOutcomeError(serverError(new Error('No project connected to the specified Subscription.')));\n       }\n       // WebSocket Subscriptions are also cache-only, but also need to be added to a special cache key\n-      await redis.sadd(`medplum:subscriptions:r4:project:${project}:active`, `Subscription/${result.id}`);\n+      await redis.sadd(`medplum:subscriptions:r4:project:${project}:active`, `Subscription/${resource.id}`);\n+    }\n+    if (resource.resourceType === 'StructureDefinition') {\n+      await removeCachedProfile(resource);\n     }\n-    // Add this resource to cache\n-    await this.setCacheEntry(result);\n   }\n \n   /**\n@@ -779,12 +791,16 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n           code: 'version',\n           descending: true,\n         },\n+        {\n+          code: 'date',\n+          descending: true,\n+        },\n       ],\n     });\n \n     if (projectIds?.length && profile) {\n       // Store loaded profile in cache\n-      await setProfileCacheEntry(projectIds[0], profile);\n+      await cacheProfile(profile);\n     }\n     return profile;\n   }\n@@ -2199,9 +2215,6 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n       'EX',\n       REDIS_CACHE_EX_SECONDS\n     );\n-    if (projectId && resource.resourceType === 'StructureDefinition') {\n-      await setProfileCacheEntry(projectId, resource);\n-    }\n   }\n \n   /**\n@@ -2289,6 +2302,7 @@ export function getLookupTable(resourceType: string, searchParam: SearchParamete\n }\n \n const REDIS_CACHE_EX_SECONDS = 24 * 60 * 60; // 24 hours in seconds\n+const PROFILE_CACHE_EX_SECONDS = 5 * 60; // 5 minutes in seconds\n \n /**\n  * Returns the redis cache key for the given resource type and resource ID.\n@@ -2302,25 +2316,36 @@ function getCacheKey(resourceType: string, id: string): string {\n \n /**\n  * Writes a FHIR profile cache entry to Redis.\n- * @param projectId - The project ID.\n- * @param structureDefinition - The profile structure definition.\n+ * @param profile - The profile structure definition.\n  */\n-async function setProfileCacheEntry(projectId: string, structureDefinition: StructureDefinition): Promise<void> {\n-  if (!structureDefinition.url) {\n+async function cacheProfile(profile: StructureDefinition): Promise<void> {\n+  if (!profile.url || !profile.meta?.project) {\n     return;\n   }\n+  profile = await getSystemRepo().readReference(createReference(profile));\n   await getRedis().set(\n-    getProfileCacheKey(projectId, structureDefinition.url),\n-    JSON.stringify({ resource: structureDefinition, projectId }),\n+    getProfileCacheKey(profile.meta?.project as string, profile.url),\n+    JSON.stringify({ resource: profile, projectId: profile.meta?.project }),\n     'EX',\n-    REDIS_CACHE_EX_SECONDS\n+    PROFILE_CACHE_EX_SECONDS\n   );\n }\n \n /**\n- * Returns the redis cache key for the given project and FHIR profile URL.\n- * @param projectId - The project ID.\n- * @param url - The profile URL.\n+ * Writes a FHIR profile cache entry to Redis.\n+ * @param profile - The profile structure definition.\n+ */\n+async function removeCachedProfile(profile: StructureDefinition): Promise<void> {\n+  if (!profile.url || !profile.meta?.project) {\n+    return;\n+  }\n+  await getRedis().del(getProfileCacheKey(profile.meta.project, profile.url));\n+}\n+\n+/**\n+ * Returns the redis cache key for the given profile resource.\n+ * @param projectId - The ID of the Project to which the profile belongs.\n+ * @param url - The canonical URL of the profile.\n  * @returns The Redis cache key.\n  */\n function getProfileCacheKey(projectId: string, url: string): string {\n",
    "test_patch": "diff --git a/packages/server/src/fhir/repo.test.ts b/packages/server/src/fhir/repo.test.ts\nindex f7207cbb8b..82a5041c3c 100644\n--- a/packages/server/src/fhir/repo.test.ts\n+++ b/packages/server/src/fhir/repo.test.ts\n@@ -1204,4 +1204,50 @@ describe('FHIR Repo', () => {\n       });\n       expect(user3.meta?.project).toBeUndefined();\n     }));\n+\n+  test('Handles caching of profile from linked project', async () =>\n+    withTestContext(async () => {\n+      const { membership, project } = await registerNew({\n+        firstName: randomUUID(),\n+        lastName: randomUUID(),\n+        projectName: randomUUID(),\n+        email: randomUUID() + '@example.com',\n+        password: randomUUID(),\n+      });\n+\n+      const { membership: membership2, project: project2 } = await registerNew({\n+        firstName: randomUUID(),\n+        lastName: randomUUID(),\n+        projectName: randomUUID(),\n+        email: randomUUID() + '@example.com',\n+        password: randomUUID(),\n+      });\n+      project.link = [{ project: createReference(project2) }];\n+\n+      const repo2 = await getRepoForLogin({ login: {} as Login, membership: membership2, project: project2 });\n+      const profileJson = JSON.parse(\n+        readFileSync(resolve(__dirname, '__test__/us-core-patient.json'), 'utf8')\n+      ) as StructureDefinition;\n+      const profile = await repo2.createResource(profileJson);\n+\n+      const patientJson: Patient = {\n+        resourceType: 'Patient',\n+        meta: {\n+          profile: [profile.url],\n+        },\n+      };\n+\n+      // Resource upload should fail with profile linked\n+      let repo = await getRepoForLogin({ login: {} as Login, membership, project });\n+      await expect(repo.createResource(patientJson)).rejects.toThrow(/Missing required property/);\n+\n+      // Unlink Project and verify that profile is not cached; resource upload should succeed without access to profile\n+      project.link = undefined;\n+      repo = await getRepoForLogin({\n+        login: {} as Login,\n+        membership,\n+        project,\n+      });\n+      await expect(repo.createResource(patientJson)).resolves.toBeDefined();\n+    }));\n });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5265",
    "pr_id": 5265,
    "issue_id": 5255,
    "repo": "medplum/medplum",
    "problem_statement": "Fix hard reload of other tabs when refreshing profile\nCurrently due to [this line](https://github.com/medplum/medplum/blob/main/packages/core/src/client.ts#L3822) we hard reload the page of other open tabs on every token refresh. This was originally done in order to prevent being logged in with different profiles in multiple tabs at the same time for security reasons. \r\n\r\nThis reasoning makes sense, but we should not reload whenever the profile is the same as before the storage event was fired.",
    "issue_word_count": 86,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/core/src/client.test.ts",
      "packages/core/src/client.ts"
    ],
    "pr_changed_test_files": [
      "packages/core/src/client.test.ts"
    ],
    "base_commit": "f56578e415a73194656f16d0da67e12a05629f09",
    "head_commit": "cf1ad27435e98b4f6689253fad21431eecf65c41",
    "repo_url": "https://github.com/medplum/medplum/pull/5265",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5265",
    "dockerfile": "",
    "pr_merged_at": "2024-09-19T17:06:31.000Z",
    "patch": "diff --git a/packages/core/src/client.ts b/packages/core/src/client.ts\nindex 74e56a7d94..eb7c4cb3e1 100644\n--- a/packages/core/src/client.ts\n+++ b/packages/core/src/client.ts\n@@ -3828,7 +3828,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n         } else if (e.key === 'activeLogin') {\n           const oldState = (e.oldValue ? JSON.parse(e.oldValue) : undefined) as LoginState | undefined;\n           const newState = (e.newValue ? JSON.parse(e.newValue) : undefined) as LoginState | undefined;\n-          if (oldState?.profile.id !== newState?.profile.id) {\n+          if (oldState?.profile.reference !== newState?.profile.reference) {\n             window.location.reload();\n           }\n         }\n",
    "test_patch": "diff --git a/packages/core/src/client.test.ts b/packages/core/src/client.test.ts\nindex e14b6ae225..36a222bc1d 100644\n--- a/packages/core/src/client.test.ts\n+++ b/packages/core/src/client.test.ts\n@@ -4,6 +4,8 @@ import {\n   Identifier,\n   OperationOutcome,\n   Patient,\n+  Practitioner,\n+  Reference,\n   SearchParameter,\n   StructureDefinition,\n } from '@medplum/fhirtypes';\n@@ -2392,8 +2394,12 @@ describe('Client', () => {\n     mockReload.mockReset();\n     callback({\n       key: 'activeLogin',\n-      oldValue: JSON.stringify({ profile: { resourceType: 'Practitioner', id: practitioner1 } }),\n-      newValue: JSON.stringify({ profile: { resourceType: 'Practitioner', id: practitioner1 } }),\n+      oldValue: JSON.stringify({\n+        profile: { reference: `Practitioner/${practitioner1}` } satisfies Reference<Practitioner>,\n+      }),\n+      newValue: JSON.stringify({\n+        profile: { reference: `Practitioner/${practitioner1}` } satisfies Reference<Practitioner>,\n+      }),\n     } as StorageEvent);\n     expect(mockReload).not.toHaveBeenCalled();\n \n@@ -2401,17 +2407,23 @@ describe('Client', () => {\n     mockReload.mockReset();\n     callback({\n       key: 'activeLogin',\n-      oldValue: JSON.stringify({ profile: { resourceType: 'Practitioner', id: practitioner1 } }),\n-      newValue: JSON.stringify({ profile: { resourceType: 'Practitioner', id: practitioner2 } }),\n+      oldValue: JSON.stringify({\n+        profile: { reference: `Practitioner/${practitioner1}` } satisfies Reference<Practitioner>,\n+      }),\n+      newValue: JSON.stringify({\n+        profile: { reference: `Practitioner/${practitioner2}` } satisfies Reference<Practitioner>,\n+      }),\n     } as StorageEvent);\n     expect(mockReload).toHaveBeenCalled();\n \n-    // Should refresh when going to a new profile from no profile\n+    // Should refresh when going from no profile to a new profile\n     mockReload.mockReset();\n     callback({\n       key: 'activeLogin',\n-      oldValue: JSON.stringify({ profile: { resourceType: 'Practitioner', id: null } }),\n-      newValue: JSON.stringify({ profile: { resourceType: 'Practitioner', id: practitioner1 } }),\n+      oldValue: null,\n+      newValue: JSON.stringify({\n+        profile: { reference: `Practitioner/${practitioner1}` } satisfies Reference<Practitioner>,\n+      }),\n     } as StorageEvent);\n     expect(mockReload).toHaveBeenCalled();\n \n@@ -2419,8 +2431,10 @@ describe('Client', () => {\n     mockReload.mockReset();\n     callback({\n       key: 'activeLogin',\n-      oldValue: JSON.stringify({ profile: { resourceType: 'Practitioner', id: practitioner1 } }),\n-      newValue: JSON.stringify({ profile: { resourceType: 'Practitioner', id: null } }),\n+      oldValue: JSON.stringify({\n+        profile: { reference: `Practitioner/${practitioner1}` } satisfies Reference<Practitioner>,\n+      }),\n+      newValue: null,\n     } as StorageEvent);\n     expect(mockReload).toHaveBeenCalled();\n \n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5264",
    "pr_id": 5264,
    "issue_id": 3668,
    "repo": "medplum/medplum",
    "problem_statement": "Allow multiple values for meta.account\nHi and thanks again for your great work!\r\n\r\nI am evaluating to build some \"shared task list\" usecase and i am trying to figure out the correct concept around access policies as this is crucial.\r\n\r\nIn our usecase, we have multiple organizations with different users inside a project. The idea is to allow to share a task between organizations. Reading through the docs i thought that combining compartment & parameterized access policies might work.\r\n\r\n**Access Policy**\r\n```\r\n{\r\n  \"resourceType\": \"AccessPolicy\",\r\n  \"name\": \"Practitioner Access Policy\",\r\n  \"resource\": [\r\n    {\r\n      \"resourceType\": \"Task\",\r\n      \"criteria\": \"Task?_compartment=%organization\"\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n**ProjectMembership User of Organization 1234**\r\n\r\n```\r\n{\r\n  \"resourceType\": \"ProjectMembership\",\r\n  \"profile\": {\r\n    \"reference\": \"Practitioner/1234\",\r\n    \"display\": \"Name\"\r\n  },\r\n  \"admin\": false,\r\n  \"access\": [\r\n    {\r\n      \"parameter\": [\r\n        {\r\n          \"name\": \"organization\",\r\n          \"valueReference\": {\r\n            \"reference\": \"Organization/1234\",\r\n            \"display\": \"Organization 1234\"\r\n          }\r\n        }\r\n      ],\r\n      \"policy\": {\r\n        \"reference\": \"AccessPolicy/uuid\",\r\n        \"display\": \"Practitioner Access Policy\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n**ProjectMembership User of Organization 5678**\r\n\r\n```\r\n{\r\n  \"resourceType\": \"ProjectMembership\",\r\n  \"profile\": {\r\n    \"reference\": \"Practitioner/5678\",\r\n    \"display\": \"Name\"\r\n  },\r\n  \"admin\": false,\r\n  \"access\": [\r\n    {\r\n      \"parameter\": [\r\n        {\r\n          \"name\": \"organization\",\r\n          \"valueReference\": {\r\n            \"reference\": \"Organization/5678\",\r\n            \"display\": \"Organization 5678\"\r\n          }\r\n        }\r\n      ],\r\n      \"policy\": {\r\n        \"reference\": \"AccessPolicy/uuid\",\r\n        \"display\": \"Practitioner Access Policy\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n### Usecase\r\nThe user of `Organization 1234` creates a task and there is a bot which adds the compartment of `Organization 1234` using the `meta.account` field:\r\n\r\n```\r\n{\r\n  \"resourceType\": \"Task\",\r\n  \"status\": \"accepted\",\r\n  \"intent\": \"order\",\r\n  \"code\": {\r\n    \"coding\": [\r\n      {\r\n        \"code\": \"This is a new task\",\r\n        \"display\": \"This is a new task\"\r\n      }\r\n    ]\r\n  },\r\n  \"meta\": {\r\n    \"compartment\": [\r\n      {\r\n        \"reference\": \"Project/uuid\"\r\n      },\r\n      {\r\n        \"reference\": \"Organization/1234\",\r\n        \"display\": \"Organization 1234\"\r\n      }\r\n    ],\r\n    \"account\": {\r\n      \"reference\": \"Organization/1234\",\r\n      \"display\": \"Organization 1234\"\r\n    }\r\n  }\r\n}\r\n```\r\nAll users with the same ProjectMembership `%organization=Organization/1234` are able to access the resource. While working on the task they figured out that the task needs input from people of `Organization/5678` and want to share the task.\r\n\r\nHowever that is not possible using meta.account as this will override the current compartment of `Organization/1234` and it would be more like \"move\" of a task. Do you have any idea of how to solve the issue or do you think i am using a wrong concept around access policies for the usecase?\r\n\r\nThanks for you help\r\n\r\nBest,\r\n\r\nNiklas\r\n\r\n",
    "issue_word_count": 326,
    "test_files_count": 4,
    "non_test_files_count": 4,
    "pr_changed_files": [
      "packages/core/src/base-schema.json",
      "packages/core/src/bundle.test.ts",
      "packages/definitions/dist/fhir/r4/profiles-types.json",
      "packages/fhirtypes/dist/Meta.d.ts",
      "packages/server/src/fhir/accesspolicy.test.ts",
      "packages/server/src/fhir/repo.test.ts",
      "packages/server/src/fhir/repo.ts",
      "packages/server/src/workers/subscription.test.ts"
    ],
    "pr_changed_test_files": [
      "packages/core/src/bundle.test.ts",
      "packages/server/src/fhir/accesspolicy.test.ts",
      "packages/server/src/fhir/repo.test.ts",
      "packages/server/src/workers/subscription.test.ts"
    ],
    "base_commit": "f7552d35324d88853f01d3f245629350e54ffead",
    "head_commit": "4ff015cf3854bb126b8431d9e3ceda96a6f97ced",
    "repo_url": "https://github.com/medplum/medplum/pull/5264",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5264",
    "dockerfile": "",
    "pr_merged_at": "2024-10-04T18:19:02.000Z",
    "patch": "diff --git a/packages/core/src/base-schema.json b/packages/core/src/base-schema.json\nindex ca2024a35a..60ebd05a37 100644\n--- a/packages/core/src/base-schema.json\n+++ b/packages/core/src/base-schema.json\n@@ -2194,6 +2194,14 @@\n           }\n         ]\n       },\n+      \"accounts\": {\n+        \"max\": 9007199254740991,\n+        \"type\": [\n+          {\n+            \"code\": \"Reference\"\n+          }\n+        ]\n+      },\n       \"compartment\": {\n         \"max\": 9007199254740991,\n         \"type\": [\n\ndiff --git a/packages/definitions/dist/fhir/r4/profiles-types.json b/packages/definitions/dist/fhir/r4/profiles-types.json\nindex a2cf9f76d6..0046e72fcd 100644\n--- a/packages/definitions/dist/fhir/r4/profiles-types.json\n+++ b/packages/definitions/dist/fhir/r4/profiles-types.json\n@@ -21984,7 +21984,7 @@\n           \"id\" : \"Meta.account\",\n           \"path\" : \"Meta.account\",\n           \"short\" : \"Optional account reference that can be used for sub-project compartments.\",\n-          \"definition\" : \"@deprecated Use Meta.compartment instead\",\n+          \"definition\" : \"@deprecated Use Meta.accounts instead\",\n           \"comment\" : \"Optional account reference that can be used for sub-project compartments.\",\n           \"min\" : 0,\n           \"max\" : \"1\",\n@@ -21997,6 +21997,22 @@\n             \"code\" : \"Reference\"\n           }]\n         },\n+        {\n+          \"id\" : \"Meta.accounts\",\n+          \"path\" : \"Meta.accounts\",\n+          \"short\" : \"Optional account references that can be used for sub-project compartments.\",\n+          \"definition\" : \"Optional account references that can be used for sub-project compartments.\",\n+          \"min\" : 0,\n+          \"max\" : \"*\",\n+          \"base\" : {\n+            \"path\" : \"Meta.accounts\",\n+            \"min\" : 0,\n+            \"max\" : \"*\"\n+          },\n+          \"type\" : [{\n+            \"code\" : \"Reference\"\n+          }]\n+        },\n         {\n           \"id\" : \"Meta.compartment\",\n           \"path\" : \"Meta.compartment\",\n\ndiff --git a/packages/fhirtypes/dist/Meta.d.ts b/packages/fhirtypes/dist/Meta.d.ts\nindex 4d83e268a6..859e4b5ba3 100644\n--- a/packages/fhirtypes/dist/Meta.d.ts\n+++ b/packages/fhirtypes/dist/Meta.d.ts\n@@ -90,10 +90,16 @@ export interface Meta {\n   onBehalfOf?: Reference;\n \n   /**\n-   * @deprecated Use Meta.compartment instead\n+   * @deprecated Use Meta.accounts instead\n    */\n   account?: Reference;\n \n+  /**\n+   * Optional account references that can be used for sub-project\n+   * compartments.\n+   */\n+  accounts?: Reference[];\n+\n   /**\n    * The list of compartments containing this resource\n    */\n\ndiff --git a/packages/server/src/fhir/repo.ts b/packages/server/src/fhir/repo.ts\nindex 048643be6c..6d0e2539cf 100644\n--- a/packages/server/src/fhir/repo.ts\n+++ b/packages/server/src/fhir/repo.ts\n@@ -10,6 +10,7 @@ import {\n   SearchRequest,\n   TypedValue,\n   allOk,\n+  arrayify,\n   badRequest,\n   canReadResourceType,\n   canWriteResourceType,\n@@ -569,7 +570,7 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n \n     const existing = create ? undefined : await this.checkExistingResource<T>(resourceType, id);\n     if (existing) {\n-      (existing.meta as Meta).compartment = this.getCompartments(existing);\n+      (existing.meta as Meta).compartment = this.getCompartments(existing); // Update compartments with latest rules\n       if (!this.canWriteToResource(existing)) {\n         // Check before the update\n         throw new OperationOutcomeError(forbidden);\n@@ -601,9 +602,10 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n     if (project) {\n       resultMeta.project = project;\n     }\n-    const account = await this.getAccount(existing, updated, create);\n-    if (account) {\n-      resultMeta.account = account;\n+    const accounts = await this.getAccounts(existing, updated, create);\n+    if (accounts) {\n+      resultMeta.account = accounts[0];\n+      resultMeta.accounts = accounts;\n     }\n     resultMeta.compartment = this.getCompartments(result);\n \n@@ -1292,7 +1294,14 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n       compartments.add(resource.project.reference);\n     }\n \n-    if (resource.meta?.account && !resource.meta.account.reference?.startsWith('Project/')) {\n+    if (resource.meta?.accounts) {\n+      for (const account of resource.meta.accounts) {\n+        const id = resolveId(resource.meta.account);\n+        if (!account.reference?.startsWith('Project/') && id && validator.isUUID(id)) {\n+          compartments.add(account.reference as string);\n+        }\n+      }\n+    } else if (resource.meta?.account && !resource.meta.account.reference?.startsWith('Project/')) {\n       const id = resolveId(resource.meta.account);\n       if (id && validator.isUUID(id)) {\n         compartments.add(resource.meta.account.reference as string);\n@@ -1688,41 +1697,52 @@ export class Repository extends FhirRepository<PoolClient> implements Disposable\n    * @param create - Flag for when \"creating\" vs \"updating\".\n    * @returns The account value.\n    */\n-  private async getAccount(\n+  private async getAccounts(\n     existing: Resource | undefined,\n     updated: Resource,\n     create: boolean\n-  ): Promise<Reference | undefined> {\n-    const account = updated.meta?.account;\n-    if (account && this.canWriteAccount()) {\n+  ): Promise<Reference[] | undefined> {\n+    const updatedAccounts = this.extractAccountReferences(updated.meta);\n+    if (updatedAccounts && this.canWriteAccount()) {\n       // If the user specifies an account, allow it if they have permission.\n-      return account;\n+      return updatedAccounts;\n     }\n \n     if (create && this.context.accessPolicy?.compartment) {\n       // If the user access policy specifies a compartment, then use it as the account.\n-      return this.context.accessPolicy.compartment;\n+      return [this.context.accessPolicy.compartment];\n     }\n \n     if (updated.resourceType !== 'Patient') {\n       for (const patientRef of getPatients(updated)) {\n-        // If the resource is in a patient compartment, then lookup the patient.\n         try {\n-          const systemRepo = getSystemRepo();\n-          const patient = await systemRepo.readReference(patientRef);\n-          if (patient.meta?.account) {\n-            // If the patient has an account, then use it as the resource account.\n-            return patient.meta.account;\n-          }\n+          // If the resource is in a patient compartment, then lookup the patient.\n+          const patient = await getSystemRepo().readReference(patientRef);\n+          // If the patient has an account, then use it as the resource account.\n+          return this.extractAccountReferences(patient.meta);\n         } catch (err: any) {\n-          const ctx = getRequestContext();\n-          ctx.logger.debug('Error setting patient compartment', err);\n+          getRequestContext().logger.debug('Error setting patient compartment', err);\n         }\n       }\n     }\n \n     // Otherwise, default to the existing value.\n-    return existing?.meta?.account ?? updated.meta?.account;\n+    return this.extractAccountReferences(existing?.meta);\n+  }\n+\n+  private extractAccountReferences(meta: Meta | undefined): Reference[] | undefined {\n+    if (!meta) {\n+      return undefined;\n+    }\n+    if (meta.accounts && meta.account) {\n+      const accounts = meta.accounts;\n+      if (accounts.some((a) => a.reference === meta.account?.reference)) {\n+        return accounts;\n+      }\n+      return [meta.account, ...accounts];\n+    } else {\n+      return arrayify(meta.accounts ?? meta.account);\n+    }\n   }\n \n   /**\n",
    "test_patch": "diff --git a/packages/core/src/bundle.test.ts b/packages/core/src/bundle.test.ts\nindex 4bbfd9ba18..abcd3cc7fe 100644\n--- a/packages/core/src/bundle.test.ts\n+++ b/packages/core/src/bundle.test.ts\n@@ -224,6 +224,12 @@ describe('Bundle tests', () => {\n             reference: 'Organization/33333333-3333-3333-3333-333333333333',\n             display: 'Organization #3',\n           },\n+          accounts: [\n+            {\n+              reference: 'Organization/33333333-3333-3333-3333-333333333333',\n+              display: 'Organization #3',\n+            },\n+          ],\n           author: {\n             reference: 'Practitioner/22222222-2222-2222-2222-222222222222',\n             display: 'Doctor',\n\ndiff --git a/packages/server/src/fhir/accesspolicy.test.ts b/packages/server/src/fhir/accesspolicy.test.ts\nindex 6326d13a8d..5e12bc7555 100644\n--- a/packages/server/src/fhir/accesspolicy.test.ts\n+++ b/packages/server/src/fhir/accesspolicy.test.ts\n@@ -3,7 +3,6 @@ import {\n   getReferenceString,\n   LOINC,\n   normalizeErrorString,\n-  normalizeOperationOutcome,\n   OperationOutcomeError,\n   Operator,\n   parseSearchRequest,\n@@ -298,12 +297,14 @@ describe('AccessPolicy', () => {\n         name: [{ given: ['Alice'], family: 'Smith' }],\n         birthDate: '1970-01-01',\n       });\n-      expect(patient).toBeDefined();\n       expect(patient.meta?.account?.reference).toEqual('Organization/' + orgId);\n+      expect(patient.meta?.accounts).toHaveLength(1);\n+      expect(patient.meta?.accounts).toContainEqual({ reference: 'Organization/' + orgId });\n \n       const readPatient = await repo.readResource('Patient', patient.id as string);\n-      expect(readPatient).toBeDefined();\n       expect(readPatient.meta?.account?.reference).toEqual('Organization/' + orgId);\n+      expect(readPatient.meta?.accounts).toHaveLength(1);\n+      expect(readPatient.meta?.accounts).toContainEqual({ reference: 'Organization/' + orgId });\n     }));\n \n   test('Access policy blocks account override', () =>\n@@ -348,12 +349,14 @@ describe('AccessPolicy', () => {\n           },\n         },\n       });\n-      expect(patient.meta?.account).toBeDefined();\n       expect(patient.meta?.account?.reference).toEqual('Organization/' + orgId);\n+      expect(patient.meta?.accounts).toHaveLength(1);\n+      expect(patient.meta?.accounts).toContainEqual({ reference: 'Organization/' + orgId });\n \n       const readPatient = await repo.readResource('Patient', patient.id as string);\n-      expect(readPatient.meta?.account).toBeDefined();\n       expect(readPatient.meta?.account?.reference).toEqual('Organization/' + orgId);\n+      expect(readPatient.meta?.accounts).toHaveLength(1);\n+      expect(readPatient.meta?.accounts).toContainEqual({ reference: 'Organization/' + orgId });\n     }));\n \n   test('Access policy restrict compartment', () =>\n@@ -425,13 +428,14 @@ describe('AccessPolicy', () => {\n         name: [{ given: ['Alice'], family: 'Smith' }],\n         birthDate: '1970-01-01',\n       });\n-      expect(patient2).toBeDefined();\n-      expect(patient2.meta?.account).toBeDefined();\n       expect(patient2.meta?.account?.reference).toEqual('Organization/' + org2);\n+      expect(patient2.meta?.accounts).toHaveLength(1);\n+      expect(patient2.meta?.accounts).toContainEqual({ reference: 'Organization/' + org2 });\n \n       const readPatient2 = await repo2.readResource('Patient', patient2.id as string);\n-      expect(readPatient2).toBeDefined();\n-      expect(readPatient2.meta?.account).toBeDefined();\n+      expect(readPatient2.meta?.account?.reference).toEqual('Organization/' + org2);\n+      expect(readPatient2.meta?.accounts).toHaveLength(1);\n+      expect(readPatient2.meta?.accounts).toContainEqual({ reference: 'Organization/' + org2 });\n \n       // Try to read patient1 with repo2\n       // This should fail\n@@ -511,8 +515,9 @@ describe('AccessPolicy', () => {\n       patient = await repo2.updateResource(patient);\n \n       expect(patient).toBeDefined();\n-      expect(patient.meta?.account).toBeDefined();\n       expect(patient.meta?.account?.reference).toEqual('Organization/' + org1);\n+      expect(patient.meta?.accounts).toHaveLength(1);\n+      expect(patient.meta?.accounts).toContainEqual({ reference: 'Organization/' + org1 });\n     }));\n \n   test('Access policy restrict criteria', () =>\n@@ -567,26 +572,28 @@ describe('AccessPolicy', () => {\n         name: [{ given: ['Alice'], family: 'Smith' }],\n         birthDate: '1970-01-01',\n       });\n-      expect(patient1).toBeDefined();\n-      expect(patient1.meta?.account).toBeDefined();\n       expect(patient1.meta?.account?.reference).toEqual('Organization/' + org1);\n+      expect(patient1.meta?.accounts).toHaveLength(1);\n+      expect(patient1.meta?.accounts).toContainEqual({ reference: 'Organization/' + org1 });\n \n       const readPatient1 = await repo1.readResource('Patient', patient1.id as string);\n-      expect(readPatient1).toBeDefined();\n-      expect(readPatient1.meta?.account).toBeDefined();\n+      expect(readPatient1.meta?.account?.reference).toEqual('Organization/' + org1);\n+      expect(readPatient1.meta?.accounts).toHaveLength(1);\n+      expect(readPatient1.meta?.accounts).toContainEqual({ reference: 'Organization/' + org1 });\n \n       const patient2 = await repo2.createResource<Patient>({\n         resourceType: 'Patient',\n         name: [{ given: ['Alice'], family: 'Smith' }],\n         birthDate: '1970-01-01',\n       });\n-      expect(patient2).toBeDefined();\n-      expect(patient2.meta?.account).toBeDefined();\n       expect(patient2.meta?.account?.reference).toEqual('Organization/' + org2);\n+      expect(patient2.meta?.accounts).toHaveLength(1);\n+      expect(patient2.meta?.accounts).toContainEqual({ reference: 'Organization/' + org2 });\n \n       const readPatient2 = await repo2.readResource('Patient', patient2.id as string);\n-      expect(readPatient2).toBeDefined();\n-      expect(readPatient2.meta?.account).toBeDefined();\n+      expect(readPatient2.meta?.account?.reference).toEqual('Organization/' + org2);\n+      expect(readPatient2.meta?.accounts).toHaveLength(1);\n+      expect(readPatient2.meta?.accounts).toContainEqual({ reference: 'Organization/' + org2 });\n \n       // Try to read patient1 with repo2\n       // This should fail\n@@ -728,6 +735,8 @@ describe('AccessPolicy', () => {\n       // The Patient should have the account value set\n       const patientCheck = await systemRepo.readResource('Patient', patient.id as string);\n       expect(patientCheck.meta?.account?.reference).toEqual(account);\n+      expect(patientCheck.meta?.accounts).toHaveLength(1);\n+      expect(patientCheck.meta?.accounts).toContainEqual({ reference: account });\n \n       // Create an Observation using the ClientApplication\n       const observation = await clientRepo.createResource<Observation>({\n@@ -744,6 +753,8 @@ describe('AccessPolicy', () => {\n       // The Observation should have the account value set\n       const observationCheck = await systemRepo.readResource('Observation', observation.id as string);\n       expect(observationCheck.meta?.account?.reference).toEqual(account);\n+      expect(observationCheck.meta?.accounts).toHaveLength(1);\n+      expect(observationCheck.meta?.accounts).toContainEqual({ reference: account });\n \n       // Create a Patient outside of the account\n       const patient2 = await systemRepo.createResource<Patient>({\n@@ -1242,13 +1253,12 @@ describe('AccessPolicy', () => {\n       });\n \n       const readResource = await repo2.readResource<ServiceRequest>('ServiceRequest', serviceRequest.id as string);\n-      expect(readResource).toMatchObject({\n+      expect(readResource).toMatchObject<Partial<ServiceRequest>>({\n         resourceType: 'ServiceRequest',\n         code: {\n           text: 'test',\n         },\n       });\n-      expect(readResource.subject).toBeDefined();\n       expect(readResource.subject?.reference).toBeDefined();\n       expect(readResource.subject?.display).toBeUndefined();\n \n@@ -1689,12 +1699,7 @@ describe('AccessPolicy', () => {\n       const check2 = await repo2.readResource<Patient>('Patient', p2.id as string);\n       expect(check2.id).toBe(p2.id);\n \n-      try {\n-        await repo2.readResource<Patient>('Patient', p3.id as string);\n-        throw new Error('Should not be able to read resource');\n-      } catch (err) {\n-        expect(normalizeErrorString(err)).toEqual('Not found');\n-      }\n+      await expect(repo2.readResource<Patient>('Patient', p3.id as string)).rejects.toThrow('Not found');\n     }));\n \n   test('String parameters', () =>\n@@ -1742,12 +1747,7 @@ describe('AccessPolicy', () => {\n       const check1 = await repo2.readResource<Task>('Task', t1.id as string);\n       expect(check1.id).toBe(t1.id);\n \n-      try {\n-        await repo2.readResource<Task>('Task', t2.id as string);\n-        throw new Error('Should not be able to read resource');\n-      } catch (err) {\n-        expect(normalizeErrorString(err)).toEqual('Not found');\n-      }\n+      await expect(repo2.readResource<Task>('Task', t2.id as string)).rejects.toThrow('Not found');\n     }));\n \n   test('Project admin with access policy', () =>\n@@ -1811,15 +1811,9 @@ describe('AccessPolicy', () => {\n       expect(check3.id).toEqual(membership.id);\n \n       const check4 = await repo2.searchResources<User>({ resourceType: 'User' });\n-      expect(check4).toBeDefined();\n       expect(check4.find((u) => u.id === inviteResult.user.id)).toBeDefined();\n \n-      try {\n-        await repo2.readResource<Task>('Task', task.id as string);\n-        throw new Error('Should not be able to read resource');\n-      } catch (err) {\n-        expect(normalizeErrorString(err)).toEqual('Forbidden');\n-      }\n+      await expect(repo2.readResource<Task>('Task', task.id as string)).rejects.toThrow('Forbidden');\n \n       // Update the project membership\n       const check6 = await repo2.updateResource<ProjectMembership>({ ...check3, externalId: randomUUID() });\n@@ -1933,8 +1927,8 @@ describe('AccessPolicy', () => {\n         { login: { resourceType: 'Login' } as Login, membership: nonAdminMembership, project },\n         true\n       );\n-      const account1 = randomUUID();\n-      const account2 = randomUUID();\n+      const account1 = 'Organization/' + randomUUID();\n+      const account2 = 'Organization/' + randomUUID();\n \n       // Create a patient with account as project admin\n       // Project admin should be allowed to set account\n@@ -1942,36 +1936,124 @@ describe('AccessPolicy', () => {\n         resourceType: 'Patient',\n         meta: {\n           project: project.id,\n-          account: { reference: 'Organization/' + account1 },\n+          account: { reference: account1 },\n         },\n       });\n-      expect(patient1).toBeDefined();\n-      expect(patient1.meta?.account?.reference).toEqual('Organization/' + account1);\n+      expect(patient1.meta?.account?.reference).toEqual(account1);\n+      expect(patient1.meta?.accounts).toHaveLength(1);\n+      expect(patient1.meta?.accounts).toContainEqual({ reference: account1 });\n \n       // Update the patient with account as project admin\n       // Project admin should be allowed to set account\n       const patient2 = await adminRepo.updateResource<Patient>({\n         ...patient1,\n         meta: {\n-          ...patient1.meta,\n-          account: { reference: 'Organization/' + account2 },\n+          account: { reference: account2 },\n         },\n       });\n-      expect(patient2).toBeDefined();\n-      expect(patient2.meta?.account?.reference).toEqual('Organization/' + account2);\n+      expect(patient2.meta?.account?.reference).toEqual(account2);\n+      expect(patient2.meta?.accounts).toHaveLength(1);\n+      expect(patient2.meta?.accounts).toContainEqual({ reference: account2 });\n \n       // Attempt to change the account as non-admin\n       // This should be silently ignored\n       const patient3 = await nonAdminRepo.updateResource<Patient>({\n         ...patient2,\n         meta: {\n-          ...patient2.meta,\n           account: { reference: 'Organization/' + randomUUID() },\n         },\n       });\n-      expect(patient3).toBeDefined();\n       expect(patient3.meta?.versionId).toEqual(patient2.meta?.versionId);\n-      expect(patient3.meta?.account?.reference).toEqual('Organization/' + account2);\n+      expect(patient3.meta?.account?.reference).toEqual(account2);\n+      expect(patient3.meta?.accounts).toHaveLength(1);\n+      expect(patient3.meta?.accounts).toContainEqual({ reference: account2 });\n+    }));\n+\n+  test('Project admin can set multiple accounts', () =>\n+    withTestContext(async () => {\n+      const project = await systemRepo.createResource<Project>({ resourceType: 'Project', name: 'Test Project' });\n+\n+      const adminMembership = await systemRepo.createResource<ProjectMembership>({\n+        resourceType: 'ProjectMembership',\n+        user: { reference: 'User/' + randomUUID() },\n+        project: { reference: 'Project/' + project.id },\n+        profile: { reference: 'Practitioner/' + randomUUID() },\n+        admin: true,\n+      });\n+\n+      const nonAdminMembership = await systemRepo.createResource<ProjectMembership>({\n+        resourceType: 'ProjectMembership',\n+        user: { reference: 'User/' + randomUUID() },\n+        project: { reference: 'Project/' + project.id },\n+        profile: { reference: 'Practitioner/' + randomUUID() },\n+        admin: false,\n+      });\n+\n+      const adminRepo = await getRepoForLogin(\n+        { login: { resourceType: 'Login' } as Login, membership: adminMembership, project },\n+        true\n+      );\n+      const nonAdminRepo = await getRepoForLogin(\n+        { login: { resourceType: 'Login' } as Login, membership: nonAdminMembership, project },\n+        true\n+      );\n+      const account1 = 'Organization/' + randomUUID();\n+      const account2 = 'Organization/' + randomUUID();\n+      const account3 = 'Organization/' + randomUUID();\n+\n+      // Create a patient with multiple accounts as project admin\n+      // Project admin should be allowed to set accounts\n+      const patient1 = await adminRepo.createResource<Patient>({\n+        resourceType: 'Patient',\n+        meta: {\n+          project: project.id,\n+          accounts: [{ reference: account1 }, { reference: account2 }],\n+        },\n+      });\n+      expect(patient1.meta?.account?.reference).toEqual(account1);\n+      expect(patient1.meta?.accounts).toHaveLength(2);\n+      expect(patient1.meta?.accounts).toContainEqual({ reference: account1 });\n+      expect(patient1.meta?.accounts).toContainEqual({ reference: account2 });\n+\n+      // Update the patient accounts as project admin\n+      // Project admin should be allowed to set accounts\n+      const patient2 = await adminRepo.updateResource<Patient>({\n+        ...patient1,\n+        meta: {\n+          accounts: [{ reference: account2 }, { reference: account3 }],\n+        },\n+      });\n+      expect(patient2.meta?.account?.reference).toEqual(account2);\n+      expect(patient2.meta?.accounts).toHaveLength(2);\n+      expect(patient2.meta?.accounts).toContainEqual({ reference: account2 });\n+      expect(patient2.meta?.accounts).toContainEqual({ reference: account3 });\n+\n+      // Update both account and accounts as project admin\n+      // Project admin should be allowed to set accounts: server will take the union of both fields\n+      const patient3 = await adminRepo.updateResource<Patient>({\n+        ...patient2,\n+        meta: {\n+          ...patient2.meta, // Includes previous meta.account (account2)\n+          accounts: [{ reference: account1 }],\n+        },\n+      });\n+      expect(patient3.meta?.account?.reference).toEqual(account2);\n+      expect(patient3.meta?.accounts).toHaveLength(2);\n+      expect(patient3.meta?.accounts).toContainEqual({ reference: account1 });\n+      expect(patient3.meta?.accounts).toContainEqual({ reference: account2 });\n+\n+      // Attempt to change the account as non-admin\n+      // This should be silently ignored\n+      const patient4 = await nonAdminRepo.updateResource<Patient>({\n+        ...patient3,\n+        meta: {\n+          accounts: [{ reference: 'Organization/' + randomUUID() }],\n+        },\n+      });\n+      expect(patient4.meta?.account?.reference).toEqual(account2);\n+      expect(patient4.meta?.accounts).toHaveLength(2);\n+      expect(patient4.meta?.accounts).toContainEqual({ reference: account1 });\n+      expect(patient4.meta?.accounts).toContainEqual({ reference: account2 });\n     }));\n \n   test('Mutex resource type policies with hidden fields', () =>\n@@ -2097,12 +2179,9 @@ describe('AccessPolicy', () => {\n \n       // Try to create a Patient in Project2 that references a Practitioner in Project1\n       const practitioner = await repo1.createResource<Practitioner>({ resourceType: 'Practitioner' });\n-      try {\n-        await repo2.createResource({ resourceType: 'Patient', generalPractitioner: [createReference(practitioner)] });\n-        throw new Error('Should have failed reference check');\n-      } catch (err) {\n-        expect(normalizeErrorString(err)).toEqual('Invalid reference (Not found) (Patient.generalPractitioner[0])');\n-      }\n+      await expect(\n+        repo2.createResource({ resourceType: 'Patient', generalPractitioner: [createReference(practitioner)] })\n+      ).rejects.toThrow('Invalid reference (Not found) (Patient.generalPractitioner[0])');\n     }));\n \n   test('Empty access policy allows reading StructureDefinitions', () =>\n@@ -2139,22 +2218,10 @@ describe('AccessPolicy', () => {\n       expect(sd.resourceType).toEqual('StructureDefinition');\n \n       // Try to update StructureDefinition, should fail\n-      try {\n-        await repo.updateResource<StructureDefinition>({ ...sd, url: randomUUID() });\n-        throw new Error('Expected error');\n-      } catch (err) {\n-        const outcome = normalizeOperationOutcome(err);\n-        expect(outcome.issue?.[0]?.code).toEqual('forbidden');\n-      }\n+      await expect(repo.updateResource<StructureDefinition>({ ...sd, url: randomUUID() })).rejects.toThrow('Forbidden');\n \n       // Try to delete StructureDefinition, should fail\n-      try {\n-        await repo.deleteResource('StructureDefinition', sd.id as string);\n-        throw new Error('Expected error');\n-      } catch (err) {\n-        const outcome = normalizeOperationOutcome(err);\n-        expect(outcome.issue?.[0]?.code).toEqual('forbidden');\n-      }\n+      await expect(repo.deleteResource('StructureDefinition', sd.id as string)).rejects.toThrow('Forbidden');\n     }));\n \n   test('Shared project read only', () =>\n@@ -2176,22 +2243,10 @@ describe('AccessPolicy', () => {\n       expect(sd.resourceType).toEqual('StructureDefinition');\n \n       // Try to update StructureDefinition, should fail\n-      try {\n-        await repo.updateResource<StructureDefinition>({ ...sd, url: randomUUID() });\n-        throw new Error('Expected error');\n-      } catch (err) {\n-        const outcome = normalizeOperationOutcome(err);\n-        expect(outcome.issue?.[0]?.code).toEqual('forbidden');\n-      }\n+      await expect(repo.updateResource<StructureDefinition>({ ...sd, url: randomUUID() })).rejects.toThrow('Forbidden');\n \n       // Try to delete StructureDefinition, should fail\n-      try {\n-        await repo.deleteResource('StructureDefinition', sd.id as string);\n-        throw new Error('Expected error');\n-      } catch (err) {\n-        const outcome = normalizeOperationOutcome(err);\n-        expect(outcome.issue?.[0]?.code).toEqual('forbidden');\n-      }\n+      await expect(repo.deleteResource('StructureDefinition', sd.id as string)).rejects.toThrow('Forbidden');\n     }));\n \n   test('Repo with multiple Projects', async () =>\n\ndiff --git a/packages/server/src/fhir/repo.test.ts b/packages/server/src/fhir/repo.test.ts\nindex 82a5041c3c..db15427f7b 100644\n--- a/packages/server/src/fhir/repo.test.ts\n+++ b/packages/server/src/fhir/repo.test.ts\n@@ -3,7 +3,6 @@ import {\n   badRequest,\n   created,\n   createReference,\n-  forbidden,\n   getReferenceString,\n   isOk,\n   notFound,\n@@ -363,61 +362,6 @@ describe('FHIR Repo', () => {\n       expect(patient.meta?.author?.reference).toEqual(author);\n     }));\n \n-  test('Create resource with account', () =>\n-    withTestContext(async () => {\n-      const author = 'Practitioner/' + randomUUID();\n-      const account = 'Organization/' + randomUUID();\n-\n-      // This user does not have an access policy\n-      // So they can optionally set an account\n-      const repo = new Repository({\n-        extendedMode: true,\n-        author: {\n-          reference: author,\n-        },\n-      });\n-\n-      const patient = await repo.createResource<Patient>({\n-        resourceType: 'Patient',\n-        name: [{ given: ['Alice'], family: 'Smith' }],\n-        meta: {\n-          account: {\n-            reference: account,\n-          },\n-        },\n-      });\n-\n-      expect(patient.meta?.author?.reference).toEqual(author);\n-      expect(patient.meta?.account?.reference).toEqual(account);\n-    }));\n-\n-  test('Create resource with malformed account', () =>\n-    withTestContext(async () => {\n-      const author = 'Practitioner/' + randomUUID();\n-\n-      // This user does not have an access policy\n-      // So they can optionally set an account\n-      const repo = new Repository({\n-        extendedMode: true,\n-        author: {\n-          reference: author,\n-        },\n-      });\n-\n-      const patient = await repo.createResource<Patient>({\n-        resourceType: 'Patient',\n-        name: [{ given: ['Alice'], family: 'Smith' }],\n-        meta: {\n-          account: {\n-            reference: 'example.com/account/1',\n-          },\n-        },\n-      });\n-\n-      expect(patient.meta?.author?.reference).toEqual(author);\n-      expect(patient.meta?.account?.reference).toEqual('example.com/account/1');\n-    }));\n-\n   test('Create resource with lastUpdated', () =>\n     withTestContext(async () => {\n       const lastUpdated = '2020-01-01T12:00:00Z';\n@@ -728,12 +672,7 @@ describe('FHIR Repo', () => {\n     });\n \n     // Try to expunge as a regular user\n-    try {\n-      await repo.expungeResource('Patient', new Date().toISOString());\n-      fail('Purge should have failed');\n-    } catch (err) {\n-      expect((err as OperationOutcomeError).outcome).toMatchObject(forbidden);\n-    }\n+    await expect(repo.expungeResource('Patient', new Date().toISOString())).rejects.toThrow('Forbidden');\n   });\n \n   test('expungeResources forbidden', async () => {\n@@ -748,12 +687,7 @@ describe('FHIR Repo', () => {\n     });\n \n     // Try to expunge as a regular user\n-    try {\n-      await repo.expungeResources('Patient', [new Date().toISOString()]);\n-      fail('Purge should have failed');\n-    } catch (err) {\n-      expect((err as OperationOutcomeError).outcome).toMatchObject(forbidden);\n-    }\n+    await expect(repo.expungeResources('Patient', [new Date().toISOString()])).rejects.toThrow('Forbidden');\n   });\n \n   test('Purge forbidden', async () => {\n@@ -768,12 +702,7 @@ describe('FHIR Repo', () => {\n     });\n \n     // Try to purge as a regular user\n-    try {\n-      await repo.purgeResources('Patient', new Date().toISOString());\n-      fail('Purge should have failed');\n-    } catch (err) {\n-      expect((err as OperationOutcomeError).outcome).toMatchObject(forbidden);\n-    }\n+    await expect(repo.purgeResources('Patient', new Date().toISOString())).rejects.toThrow('Forbidden');\n   });\n \n   test('Purge Login', () =>\n@@ -1045,8 +974,11 @@ describe('FHIR Repo', () => {\n         meta: { account: conditionalReference },\n         generalPractitioner: [conditionalReference],\n       });\n-      expect(patient.generalPractitioner?.[0]?.reference).toEqual(getReferenceString(practitioner));\n-      expect(patient.meta?.account?.reference).toEqual(getReferenceString(practitioner));\n+      const expectedPractitioner = getReferenceString(practitioner);\n+      expect(patient.generalPractitioner?.[0]?.reference).toEqual(expectedPractitioner);\n+      expect(patient.meta?.account?.reference).toEqual(expectedPractitioner);\n+      expect(patient.meta?.accounts).toHaveLength(1);\n+      expect(patient.meta?.accounts).toContainEqual({ reference: expectedPractitioner });\n     }));\n \n   test('Conditional reference resolution failure', async () =>\n\ndiff --git a/packages/server/src/workers/subscription.test.ts b/packages/server/src/workers/subscription.test.ts\nindex 9712c9c404..7cda508638 100644\n--- a/packages/server/src/workers/subscription.test.ts\n+++ b/packages/server/src/workers/subscription.test.ts\n@@ -1187,8 +1187,9 @@ describe('Subscription Worker', () => {\n       expect(bundle.entry?.length).toEqual(1);\n \n       const auditEvent = bundle.entry?.[0]?.resource as AuditEvent;\n-      expect(auditEvent.meta?.account).toBeDefined();\n       expect(auditEvent.meta?.account?.reference).toEqual(account.reference);\n+      expect(auditEvent.meta?.accounts).toHaveLength(1);\n+      expect(auditEvent.meta?.accounts).toContainEqual({ reference: account.reference });\n       expect(auditEvent.entity).toHaveLength(2);\n     }));\n \n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5256",
    "pr_id": 5256,
    "issue_id": 5255,
    "repo": "medplum/medplum",
    "problem_statement": "Fix hard reload of other tabs when refreshing profile\nCurrently due to [this line](https://github.com/medplum/medplum/blob/main/packages/core/src/client.ts#L3822) we hard reload the page of other open tabs on every token refresh. This was originally done in order to prevent being logged in with different profiles in multiple tabs at the same time for security reasons. \r\n\r\nThis reasoning makes sense, but we should not reload whenever the profile is the same as before the storage event was fired.",
    "issue_word_count": 86,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/core/src/client.test.ts",
      "packages/core/src/client.ts"
    ],
    "pr_changed_test_files": [
      "packages/core/src/client.test.ts"
    ],
    "base_commit": "fadaaf2ceeff135e0889bdf21ff2cf5c4ef0a31e",
    "head_commit": "7ec1c434d31151883f30951a71a8ecf9d8ce2b10",
    "repo_url": "https://github.com/medplum/medplum/pull/5256",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5256",
    "dockerfile": "",
    "pr_merged_at": "2024-09-17T22:35:13.000Z",
    "patch": "diff --git a/packages/core/src/client.ts b/packages/core/src/client.ts\nindex b18c63227d..74e56a7d94 100644\n--- a/packages/core/src/client.ts\n+++ b/packages/core/src/client.ts\n@@ -3820,11 +3820,17 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n   private setupStorageListener(): void {\n     try {\n       window.addEventListener('storage', (e: StorageEvent) => {\n-        if (e.key === null || e.key === 'activeLogin') {\n-          // Storage events fire when different tabs make changes.\n-          // On storage clear (key === null) or activeLogin change (key === 'activeLogin')\n-          // Refresh the page to ensure the active login is up to date.\n+        // Storage events fire when different tabs make changes.\n+        // On storage clear (key === null) or profile change (key === 'activeLogin', and profile in 'activeLogin' is different)\n+        // Refresh the page to ensure the active login is up to date.\n+        if (e.key === null) {\n           window.location.reload();\n+        } else if (e.key === 'activeLogin') {\n+          const oldState = (e.oldValue ? JSON.parse(e.oldValue) : undefined) as LoginState | undefined;\n+          const newState = (e.newValue ? JSON.parse(e.newValue) : undefined) as LoginState | undefined;\n+          if (oldState?.profile.id !== newState?.profile.id) {\n+            window.location.reload();\n+          }\n         }\n       });\n     } catch (_err) {\n",
    "test_patch": "diff --git a/packages/core/src/client.test.ts b/packages/core/src/client.test.ts\nindex 1577b6126e..e14b6ae225 100644\n--- a/packages/core/src/client.test.ts\n+++ b/packages/core/src/client.test.ts\n@@ -2385,10 +2385,46 @@ describe('Client', () => {\n     callback({ key: 'randomKey' });\n     expect(mockReload).not.toHaveBeenCalled();\n \n+    const practitioner1 = randomUUID();\n+    const practitioner2 = randomUUID();\n+\n+    // Should NOT refresh when we have the same profile\n+    mockReload.mockReset();\n+    callback({\n+      key: 'activeLogin',\n+      oldValue: JSON.stringify({ profile: { resourceType: 'Practitioner', id: practitioner1 } }),\n+      newValue: JSON.stringify({ profile: { resourceType: 'Practitioner', id: practitioner1 } }),\n+    } as StorageEvent);\n+    expect(mockReload).not.toHaveBeenCalled();\n+\n+    // Should refresh when we change to a new profile\n+    mockReload.mockReset();\n+    callback({\n+      key: 'activeLogin',\n+      oldValue: JSON.stringify({ profile: { resourceType: 'Practitioner', id: practitioner1 } }),\n+      newValue: JSON.stringify({ profile: { resourceType: 'Practitioner', id: practitioner2 } }),\n+    } as StorageEvent);\n+    expect(mockReload).toHaveBeenCalled();\n+\n+    // Should refresh when going to a new profile from no profile\n+    mockReload.mockReset();\n+    callback({\n+      key: 'activeLogin',\n+      oldValue: JSON.stringify({ profile: { resourceType: 'Practitioner', id: null } }),\n+      newValue: JSON.stringify({ profile: { resourceType: 'Practitioner', id: practitioner1 } }),\n+    } as StorageEvent);\n+    expect(mockReload).toHaveBeenCalled();\n+\n+    // Should refresh when going from a profile to no profile (logged out)\n     mockReload.mockReset();\n-    callback({ key: 'activeLogin' });\n+    callback({\n+      key: 'activeLogin',\n+      oldValue: JSON.stringify({ profile: { resourceType: 'Practitioner', id: practitioner1 } }),\n+      newValue: JSON.stringify({ profile: { resourceType: 'Practitioner', id: null } }),\n+    } as StorageEvent);\n     expect(mockReload).toHaveBeenCalled();\n \n+    // Should refresh when storage is cleared\n     mockReload.mockReset();\n     callback({ key: null });\n     expect(mockReload).toHaveBeenCalled();\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5246",
    "pr_id": 5246,
    "issue_id": 5244,
    "repo": "medplum/medplum",
    "problem_statement": "Incorrect resolution of references after PUT\n\r\n## Repro\r\n\r\n```ts\r\n{\r\n      resourceType: 'Bundle',\r\n      type: 'transaction',\r\n      entry: [\r\n        {\r\n          fullUrl: 'urn:uuid:98765',\r\n          request: {\r\n            method: 'PUT',\r\n            url: 'ServiceRequest/12345',\r\n          },\r\n          resource: {\r\n            id: '12345',\r\n            resourceType: 'ServiceRequest',\r\n            intent: 'order',\r\n            status: 'active',\r\n            subject: { display: 'Test Patient' },\r\n          },\r\n        },\r\n        {\r\n          request: {\r\n            method: 'POST',\r\n            url: 'DiagnosticReport',\r\n          },\r\n          resource: {\r\n            resourceType: 'DiagnosticReport',\r\n            code: {},\r\n            status: 'amended',\r\n            basedOn: [{ reference: 'urn:uuid:98765' }],\r\n          },\r\n        },\r\n      ],\r\n    }\r\n```\r\n\r\n## Expected Behavior\r\n `report.basedOn[0].reference === 'ServiceRequest/12345'`\r\n## Observed Behavior\r\n\r\n `report.basedOn[0].reference === 'urn:uuid:98765'`\r\n",
    "issue_word_count": 69,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/fhir-router/src/batch.test.ts",
      "packages/fhir-router/src/batch.ts"
    ],
    "pr_changed_test_files": [
      "packages/fhir-router/src/batch.test.ts"
    ],
    "base_commit": "c54be5abe63728b56d0263df7c2d4c8149065c8e",
    "head_commit": "7c4cd7c0d33d760964cd9ef7ae78fc3e8b825b53",
    "repo_url": "https://github.com/medplum/medplum/pull/5246",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5246",
    "dockerfile": "",
    "pr_merged_at": "2024-09-16T22:09:34.000Z",
    "patch": "diff --git a/packages/fhir-router/src/batch.ts b/packages/fhir-router/src/batch.ts\nindex 05c943c463..5411abc565 100644\n--- a/packages/fhir-router/src/batch.ts\n+++ b/packages/fhir-router/src/batch.ts\n@@ -258,20 +258,22 @@ class BatchProcessor {\n   }\n \n   private async resolveCreateIdentity(entry: BundleEntry): Promise<BundleEntryIdentity | undefined> {\n+    if (!entry.fullUrl?.startsWith(uuidUriPrefix)) {\n+      return undefined;\n+    }\n+\n+    const placeholder = entry.fullUrl;\n     if (entry.request?.ifNoneExist) {\n       const existing = await this.repo.searchResources(\n         parseSearchRequest(entry.request.url + '?' + entry.request.ifNoneExist)\n       );\n-      if (existing.length === 1 && entry.fullUrl?.startsWith(uuidUriPrefix)) {\n-        return { placeholder: entry.fullUrl, reference: getReferenceString(existing[0]) };\n+      if (existing.length === 1) {\n+        return { placeholder, reference: getReferenceString(existing[0]) };\n       }\n     }\n-    if (entry.resource && entry.fullUrl?.startsWith(uuidUriPrefix)) {\n+    if (entry.resource) {\n       entry.resource.id = this.repo.generateId();\n-      return {\n-        placeholder: entry.fullUrl,\n-        reference: getReferenceString(entry.resource),\n-      };\n+      return { placeholder, reference: getReferenceString(entry.resource) };\n     }\n     return undefined;\n   }\n@@ -280,7 +282,12 @@ class BatchProcessor {\n     entry: BundleEntry,\n     path: string\n   ): Promise<BundleEntryIdentity | undefined> {\n-    if (entry.request?.url?.includes('?') && entry.fullUrl?.startsWith(uuidUriPrefix)) {\n+    if (!entry.fullUrl?.startsWith(uuidUriPrefix)) {\n+      return undefined;\n+    }\n+\n+    const placeholder = entry.fullUrl;\n+    if (entry.request?.url?.includes('?')) {\n       const method = entry.request.method;\n \n       // Resolve conditional update via search\n@@ -303,10 +310,7 @@ class BatchProcessor {\n               }\n \n               entry.resource.id = this.repo.generateId();\n-              return {\n-                placeholder: entry.fullUrl,\n-                reference: getReferenceString(entry.resource),\n-              };\n+              return { placeholder, reference: getReferenceString(entry.resource) };\n             }\n             return undefined;\n           default:\n@@ -326,12 +330,13 @@ class BatchProcessor {\n       if (entry.resource) {\n         entry.resource.id = resolved.id;\n       }\n-      return { placeholder: entry.fullUrl, reference };\n+      return { placeholder, reference };\n     }\n \n     if (entry.request?.url.includes('/')) {\n-      return { placeholder: entry.request.url, reference: entry.request.url };\n+      return { placeholder, reference: entry.request.url };\n     }\n+\n     return undefined;\n   }\n \n@@ -491,13 +496,13 @@ class BatchProcessor {\n   }\n \n   private rewriteIdsInString(input: string): string {\n-    const match = localBundleReference.exec(input);\n-    if (match) {\n-      const fullUrl = match[0];\n-      const referenceString = this.resolvedIdentities[fullUrl];\n-      return referenceString ? input.replaceAll(fullUrl, referenceString) : input;\n+    const rewritable = localBundleReference.exec(input)?.[0];\n+    if (!rewritable) {\n+      return input;\n     }\n-    return input;\n+\n+    const referenceString = this.resolvedIdentities[rewritable];\n+    return referenceString ? input.replaceAll(rewritable, referenceString) : input;\n   }\n \n   private isTransaction(): boolean {\n",
    "test_patch": "diff --git a/packages/fhir-router/src/batch.test.ts b/packages/fhir-router/src/batch.test.ts\nindex 5a4b624e44..99ec8c14c3 100644\n--- a/packages/fhir-router/src/batch.test.ts\n+++ b/packages/fhir-router/src/batch.test.ts\n@@ -15,6 +15,7 @@ import {\n   Bundle,\n   BundleEntry,\n   BundleEntryRequest,\n+  DiagnosticReport,\n   Observation,\n   OperationOutcome,\n   Patient,\n@@ -1207,4 +1208,42 @@ describe('Batch', () => {\n \n     await expect(processBatch(req, repo, router, tx)).resolves.toBeDefined();\n   });\n+\n+  test('Local reference resolution for update', async () => {\n+    const bundle: Bundle = {\n+      resourceType: 'Bundle',\n+      type: 'transaction',\n+      entry: [\n+        {\n+          fullUrl: 'urn:uuid:f1228716-b33c-420d-89ab-46fac9ebcc8b',\n+          request: {\n+            method: 'PUT',\n+            url: 'ServiceRequest/12345',\n+          },\n+          resource: {\n+            id: '12345',\n+            resourceType: 'ServiceRequest',\n+            intent: 'order',\n+            status: 'active',\n+            subject: { display: 'Test Patient' },\n+          },\n+        },\n+        {\n+          request: {\n+            method: 'POST',\n+            url: 'DiagnosticReport',\n+          },\n+          resource: {\n+            resourceType: 'DiagnosticReport',\n+            code: {},\n+            status: 'amended',\n+            basedOn: [{ reference: 'urn:uuid:f1228716-b33c-420d-89ab-46fac9ebcc8b' }],\n+          },\n+        },\n+      ],\n+    };\n+    const result = await processBatch(req, repo, router, bundle);\n+    const report = result.entry?.[1]?.resource as DiagnosticReport;\n+    expect(report.basedOn?.[0].reference).toEqual('ServiceRequest/12345');\n+  });\n });\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5241",
    "pr_id": 5241,
    "issue_id": 5240,
    "repo": "medplum/medplum",
    "problem_statement": "Reduce length of PKCE code verifier\nI was trying to create an example app for the Medplum Token Exchange, signing into Okta as my IDP.\r\n\r\n I used `medplum.ensureCodeChallenge` to generate the PKCE state for Okta. \r\n\r\nHowever, when I called Okta's `/token` endpoint, I got the following error\r\n```\r\n{\r\n    \"error\": \"invalid_grant\",\r\n    \"error_description\": \"PKCE verification failed: The code_verifier must have a minimum length of 43 characters and a maximum length of 128 characters..\"\r\n}\r\n```\r\n\r\n## Proposal \r\nShorten the code verifier generated to 128 characters, to be compatible with Okta",
    "issue_word_count": 86,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/core/src/client.test.ts",
      "packages/core/src/client.ts"
    ],
    "pr_changed_test_files": [
      "packages/core/src/client.test.ts"
    ],
    "base_commit": "057585d75cf86066120d2897b53196d7f2447a6a",
    "head_commit": "816f17d692f228b56d69f68f061d0fa4a9798575",
    "repo_url": "https://github.com/medplum/medplum/pull/5241",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5241",
    "dockerfile": "",
    "pr_merged_at": "2024-09-16T17:28:17.000Z",
    "patch": "diff --git a/packages/core/src/client.ts b/packages/core/src/client.ts\nindex a93116ff58..b18c63227d 100644\n--- a/packages/core/src/client.ts\n+++ b/packages/core/src/client.ts\n@@ -3387,7 +3387,7 @@ export class MedplumClient extends TypedEventTarget<MedplumClientEventMap> {\n     const pkceState = getRandomString();\n     sessionStorage.setItem('pkceState', pkceState);\n \n-    const codeVerifier = getRandomString();\n+    const codeVerifier = getRandomString().slice(0, 128);\n     sessionStorage.setItem('codeVerifier', codeVerifier);\n \n     const arrayHash = await encryptSHA256(codeVerifier);\n",
    "test_patch": "diff --git a/packages/core/src/client.test.ts b/packages/core/src/client.test.ts\nindex 2efd973980..1577b6126e 100644\n--- a/packages/core/src/client.test.ts\n+++ b/packages/core/src/client.test.ts\n@@ -569,6 +569,9 @@ describe('Client', () => {\n       );\n       expect(result).toMatch(/https:\\/\\/auth\\.example\\.com\\/authorize\\?.+scope=/);\n \n+      const codeVerifier = sessionStorage.getItem('codeVerifier');\n+      expect(codeVerifier).toHaveLength(128);\n+\n       const { searchParams } = new URL(result);\n       expect(searchParams.get('response_type')).toBe('code');\n       expect(searchParams.get('code_challenge')).not.toBeNull();\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5236",
    "pr_id": 5236,
    "issue_id": 5176,
    "repo": "medplum/medplum",
    "problem_statement": "Consider conditional rendering semantics for `useSubscription`\nWe currently lack a good way to represent the state of having no subscription temporarily, ie. clearing existing subscription without being forced to create a new one.\r\n\r\nShould we make it so that changing criteria to an empty string clears the existing subscription and prevents creating a new one? \r\n\r\nUser driven: https://medplum.slack.com/archives/C04K38ER9TR/p1725406510116549?thread_ts=1724960585.098119&cid=C04K38ER9TR",
    "issue_word_count": 69,
    "test_files_count": 1,
    "non_test_files_count": 1,
    "pr_changed_files": [
      "packages/react-hooks/src/useSubscription/useSubscription.test.tsx",
      "packages/react-hooks/src/useSubscription/useSubscription.ts"
    ],
    "pr_changed_test_files": [
      "packages/react-hooks/src/useSubscription/useSubscription.test.tsx"
    ],
    "base_commit": "00da201aa8cbc8e1edbe0539179a169a7fff63ee",
    "head_commit": "a4ebbc5c7c3ea08640ac765a0ac397a09511d394",
    "repo_url": "https://github.com/medplum/medplum/pull/5236",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5236",
    "dockerfile": "",
    "pr_merged_at": "2024-09-16T17:57:06.000Z",
    "patch": "diff --git a/packages/react-hooks/src/useSubscription/useSubscription.ts b/packages/react-hooks/src/useSubscription/useSubscription.ts\nindex bb064e5717..5284a195cc 100644\n--- a/packages/react-hooks/src/useSubscription/useSubscription.ts\n+++ b/packages/react-hooks/src/useSubscription/useSubscription.ts\n@@ -36,7 +36,7 @@ export type UseSubscriptionOptions = {\n  * - `onError` - Called whenever an error occurs during the lifecycle of the managed subscription.\n  */\n export function useSubscription(\n-  criteria: string,\n+  criteria: string | undefined,\n   callback: (bundle: Bundle) => void,\n   options?: UseSubscriptionOptions\n ): void {\n@@ -48,7 +48,7 @@ export function useSubscription(\n   const listeningRef = useRef(false);\n   const unsubTimerRef = useRef<ReturnType<typeof setTimeout>>();\n \n-  const prevCriteriaRef = useRef<string>();\n+  const prevCriteriaRef = useRef<string | undefined>();\n   const prevMemoizedSubPropsRef = useRef<UseSubscriptionOptions['subscriptionProps']>();\n \n   const callbackRef = useRef<typeof callback>();\n@@ -96,14 +96,18 @@ export function useSubscription(\n     prevMemoizedSubPropsRef.current = memoizedSubProps;\n \n     // We do this after as to not immediately trigger re-render\n-    if (shouldSubscribe) {\n+    if (shouldSubscribe && criteria) {\n       setEmitter(medplum.subscribeToCriteria(criteria, memoizedSubProps));\n+    } else if (!criteria) {\n+      setEmitter(undefined);\n     }\n \n     return () => {\n       unsubTimerRef.current = setTimeout(() => {\n         setEmitter(undefined);\n-        medplum.unsubscribeFromCriteria(criteria, memoizedSubProps);\n+        if (criteria) {\n+          medplum.unsubscribeFromCriteria(criteria, memoizedSubProps);\n+        }\n       }, SUBSCRIPTION_DEBOUNCE_MS);\n     };\n   }, [medplum, criteria, memoizedSubProps]);\n",
    "test_patch": "diff --git a/packages/react-hooks/src/useSubscription/useSubscription.test.tsx b/packages/react-hooks/src/useSubscription/useSubscription.test.tsx\nindex a9c5309b19..cfb090ed4c 100644\n--- a/packages/react-hooks/src/useSubscription/useSubscription.test.tsx\n+++ b/packages/react-hooks/src/useSubscription/useSubscription.test.tsx\n@@ -15,13 +15,13 @@ function TestComponent({\n   callback,\n   options,\n }: {\n-  criteria?: string;\n+  criteria: string | undefined;\n   callback?: (bundle: Bundle) => void;\n   options?: UseSubscriptionOptions;\n }): JSX.Element {\n   const [lastReceived, setLastReceived] = useState<Bundle>();\n   useSubscription(\n-    criteria ?? 'Communication',\n+    criteria,\n     callback ??\n       ((bundle: Bundle) => {\n         setLastReceived(bundle);\n@@ -36,7 +36,7 @@ function TestComponent({\n }\n \n function RenderToggleComponent({ render }: { render: boolean }): JSX.Element {\n-  return <>{render ? <TestComponent /> : null}</>;\n+  return <>{render ? <TestComponent criteria=\"Communication\" /> : null}</>;\n }\n \n describe('useSubscription()', () => {\n@@ -77,7 +77,7 @@ describe('useSubscription()', () => {\n   }\n \n   test('Mount and unmount completely', async () => {\n-    const { unmount } = setup(<TestComponent />);\n+    const { unmount } = setup(<TestComponent criteria=\"Communication\" />);\n \n     act(() => {\n       medplum.getSubscriptionManager().emitEventForCriteria<'message'>('Communication', {\n@@ -128,7 +128,7 @@ describe('useSubscription()', () => {\n     const emitter = medplum.getSubscriptionManager().addCriteria('Communication');\n     expect(medplum.getSubscriptionManager().getCriteriaCount()).toEqual(1);\n \n-    setup(<TestComponent />, true);\n+    setup(<TestComponent criteria=\"Communication\" />, true);\n     jest.advanceTimersByTime(5000);\n     expect(medplum.getSubscriptionManager().getCriteriaCount()).toEqual(1);\n     expect(medplum.getSubscriptionManager().getEmitter('Communication')).toBe(emitter);\n@@ -142,6 +142,7 @@ describe('useSubscription()', () => {\n \n     const { rerender } = setup(\n       <TestComponent\n+        criteria=\"Communication\"\n         callback={(bundle: Bundle) => {\n           lastFromCb1 = bundle;\n         }}\n@@ -162,6 +163,7 @@ describe('useSubscription()', () => {\n \n     rerender(\n       <TestComponent\n+        criteria=\"Communication\"\n         callback={(bundle: Bundle) => {\n           lastFromCb2 = bundle;\n         }}\n@@ -362,6 +364,120 @@ describe('useSubscription()', () => {\n     expect(lastFromCb2?.id).toEqual(id3);\n   });\n \n+  test('Empty criteria should temporarily unsubscribe', async () => {\n+    let lastFromCb1: Bundle | undefined;\n+    let lastFromCb2: Bundle | undefined;\n+    let lastFromCb3: Bundle | undefined;\n+    let lastFromCb4: Bundle | undefined;\n+\n+    const id1 = generateId();\n+    const id2 = generateId();\n+    const id3 = generateId();\n+    const id4 = generateId();\n+\n+    const { rerender } = setup(\n+      <TestComponent\n+        criteria=\"Communication\"\n+        callback={(bundle: Bundle) => {\n+          lastFromCb1 = bundle;\n+        }}\n+      />\n+    );\n+\n+    // Emit an event that would trigger the current callback to be called based on the criteria\n+    act(() => {\n+      medplum.getSubscriptionManager().emitEventForCriteria<'message'>('Communication', {\n+        type: 'message',\n+        payload: { resourceType: 'Bundle', id: id1, type: 'history' },\n+      });\n+    });\n+\n+    // Make sure it was called\n+    expect(lastFromCb1?.resourceType).toEqual('Bundle');\n+    expect(lastFromCb1?.type).toEqual('history');\n+    expect(lastFromCb1?.id).toEqual(id1);\n+    expect(lastFromCb2).not.toBeDefined();\n+    expect(lastFromCb3).not.toBeDefined();\n+\n+    // Re-render with a new empty string criteria\n+    rerender(\n+      <TestComponent\n+        criteria=\"\"\n+        callback={(bundle: Bundle) => {\n+          lastFromCb2 = bundle;\n+        }}\n+      />\n+    );\n+\n+    act(() => {\n+      medplum.getSubscriptionManager().emitEventForCriteria<'message'>('Communication', {\n+        type: 'message',\n+        payload: { resourceType: 'Bundle', id: id2, type: 'history' },\n+      });\n+    });\n+\n+    // Make sure it doesn't get called\n+    expect(lastFromCb1?.resourceType).toEqual('Bundle');\n+    expect(lastFromCb1?.type).toEqual('history');\n+    expect(lastFromCb1?.id).toEqual(id1);\n+    expect(lastFromCb2).not.toBeDefined();\n+    expect(lastFromCb3).not.toBeDefined();\n+\n+    // Re-render with undefined criteria\n+    rerender(\n+      <TestComponent\n+        criteria={undefined}\n+        callback={(bundle: Bundle) => {\n+          lastFromCb3 = bundle;\n+        }}\n+      />\n+    );\n+\n+    act(() => {\n+      medplum.getSubscriptionManager().emitEventForCriteria<'message'>('Communication', {\n+        type: 'message',\n+        payload: { resourceType: 'Bundle', id: id3, type: 'history' },\n+      });\n+    });\n+\n+    // Make sure old criteria still has first event as last received message\n+    expect(lastFromCb1?.resourceType).toEqual('Bundle');\n+    expect(lastFromCb1?.type).toEqual('history');\n+    expect(lastFromCb1?.id).toEqual(id1);\n+\n+    expect(lastFromCb2).toBeUndefined();\n+    expect(lastFromCb3).toBeUndefined();\n+\n+    // Re-render with the old criteria\n+    rerender(\n+      <TestComponent\n+        criteria=\"Communication\"\n+        callback={(bundle: Bundle) => {\n+          lastFromCb4 = bundle;\n+        }}\n+      />\n+    );\n+\n+    act(() => {\n+      medplum.getSubscriptionManager().emitEventForCriteria<'message'>('Communication', {\n+        type: 'message',\n+        payload: { resourceType: 'Bundle', id: id4, type: 'history' },\n+      });\n+    });\n+\n+    // Make sure old criteria still has first event as last received message\n+    expect(lastFromCb1?.resourceType).toEqual('Bundle');\n+    expect(lastFromCb1?.type).toEqual('history');\n+    expect(lastFromCb1?.id).toEqual(id1);\n+\n+    expect(lastFromCb2).toBeUndefined();\n+    expect(lastFromCb3).toBeUndefined();\n+\n+    expect(lastFromCb4?.resourceType).toEqual('Bundle');\n+    expect(lastFromCb4?.type).toEqual('history');\n+    expect(lastFromCb4?.id).toEqual(id4);\n+  });\n+\n   test('WebSocket disconnects and reconnects', async () => {\n     let lastFromCb: Bundle | undefined;\n     const id = generateId();\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  },
  {
    "instance_id": "medplum__medplum-5225",
    "pr_id": 5225,
    "issue_id": 5200,
    "repo": "medplum/medplum",
    "problem_statement": "[Patient Intake Sample] Add preferred pharmacy\nThis is an FAQ and should be added here: https://github.com/medplum/medplum/tree/main/examples/medplum-patient-intake-demo\n\nRelated docs: https://www.medplum.com/docs/medications/representing-prescriptions-and-medication-orders#representing-dispense-instructions\n\n> There is currently no community consensus on how to store a patient's preferred pharmacy in FHIR, but Mepdlum's guidance is to add this information to a [CareTeam](https://www.medplum.com/docs/api/fhir/resources/careteam) resource associated with the [Patient](https://www.medplum.com/docs/api/fhir/resources/patient).\n",
    "issue_word_count": 95,
    "test_files_count": 2,
    "non_test_files_count": 4,
    "pr_changed_files": [
      "examples/medplum-patient-intake-demo/data/core/patient-intake-questionnaire.json",
      "examples/medplum-patient-intake-demo/data/example/example-organization-data.json",
      "examples/medplum-patient-intake-demo/src/bots/core/intake-form.test.ts",
      "examples/medplum-patient-intake-demo/src/bots/core/intake-form.ts",
      "examples/medplum-patient-intake-demo/src/bots/core/intake-utils.ts",
      "examples/medplum-patient-intake-demo/src/bots/core/test-data/intake-form-test-data.ts"
    ],
    "pr_changed_test_files": [
      "examples/medplum-patient-intake-demo/src/bots/core/intake-form.test.ts",
      "examples/medplum-patient-intake-demo/src/bots/core/test-data/intake-form-test-data.ts"
    ],
    "base_commit": "fe04c6c51da8065fd37e847a6ec79902a4824315",
    "head_commit": "c232ea5ae191795d7674c3a0eca9be7168440933",
    "repo_url": "https://github.com/medplum/medplum/pull/5225",
    "swe_url": "https://swe-bench-plus.turing.com/repos/medplum__medplum/5225",
    "dockerfile": "",
    "pr_merged_at": "2024-09-13T17:13:55.000Z",
    "patch": "diff --git a/examples/medplum-patient-intake-demo/data/core/patient-intake-questionnaire.json b/examples/medplum-patient-intake-demo/data/core/patient-intake-questionnaire.json\nindex cb8ac84103..43f3392588 100644\n--- a/examples/medplum-patient-intake-demo/data/core/patient-intake-questionnaire.json\n+++ b/examples/medplum-patient-intake-demo/data/core/patient-intake-questionnaire.json\n@@ -239,6 +239,33 @@\n               }\n             ]\n           },\n+          {\n+            \"linkId\": \"preferred-pharmacy\",\n+            \"text\": \"Preferred Pharmacy\",\n+            \"type\": \"group\",\n+            \"item\": [\n+              {\n+                \"linkId\": \"preferred-pharmacy-reference\",\n+                \"text\": \"Pharmacy\",\n+                \"type\": \"reference\",\n+                \"extension\": [\n+                  {\n+                    \"id\": \"reference-pharmacy\",\n+                    \"url\": \"http://hl7.org/fhir/StructureDefinition/questionnaire-referenceResource\",\n+                    \"valueCodeableConcept\": {\n+                      \"coding\": [\n+                        {\n+                          \"system\": \"http://hl7.org/fhir/fhir-types\",\n+                          \"display\": \"Organizations\",\n+                          \"code\": \"Organization\"\n+                        }\n+                      ]\n+                    }\n+                  }\n+                ]\n+              }\n+            ]\n+          },\n           {\n             \"linkId\": \"coverage-information\",\n             \"text\": \"Coverage Information\",\n\ndiff --git a/examples/medplum-patient-intake-demo/data/example/example-organization-data.json b/examples/medplum-patient-intake-demo/data/example/example-organization-data.json\nindex 73dcebfb17..8fd6d77987 100644\n--- a/examples/medplum-patient-intake-demo/data/example/example-organization-data.json\n+++ b/examples/medplum-patient-intake-demo/data/example/example-organization-data.json\n@@ -3,7 +3,7 @@\n   \"type\": \"transaction\",\n   \"entry\": [\n     {\n-      \"fullUrl\": \"urn:uuid:b884050a-bc99-472c-ad66-4f903fe84aa8\",\n+      \"fullUrl\": \"urn:uuid:38bcbdea-1b0c-4e9d-9548-4711a999acf4\",\n       \"request\": {\n         \"method\": \"PUT\",\n         \"url\": \"Organization?identifier=blue-cross\"\n@@ -59,6 +59,64 @@\n           }\n         ]\n       }\n+    },\n+    {\n+      \"fullUrl\": \"urn:uuid:56867ac2-9c23-415f-a9e8-0bc95a87e986\",\n+      \"request\": {\n+        \"method\": \"PUT\",\n+        \"url\": \"Organization?identifier=cvs-pharmacy\"\n+      },\n+      \"resource\": {\n+        \"resourceType\": \"Organization\",\n+        \"name\": \"CVS Pharmacy\",\n+        \"active\": true,\n+        \"identifier\": [\n+          {\n+            \"system\": \"http://example.com/pharmacy-orgs\",\n+            \"value\": \"cvs-pharmacy\"\n+          }\n+        ],\n+        \"type\": [\n+          {\n+            \"coding\": [\n+              {\n+                \"system\": \"http://terminology.hl7.org/CodeSystem/organization-type\",\n+                \"code\": \"prov\",\n+                \"display\": \"Healthcare Provider\"\n+              }\n+            ]\n+          }\n+        ]\n+      }\n+    },\n+    {\n+      \"fullUrl\": \"urn:uuid:d8cc4839-3abf-4a58-8895-190b06551b66\",\n+      \"request\": {\n+        \"method\": \"PUT\",\n+        \"url\": \"Organization?identifier=medplum-pharmacy\"\n+      },\n+      \"resource\": {\n+        \"resourceType\": \"Organization\",\n+        \"name\": \"Medplum Pharmacy\",\n+        \"active\": true,\n+        \"identifier\": [\n+          {\n+            \"system\": \"http://example.com/pharmacy-orgs\",\n+            \"value\": \"medplum-pharmacy\"\n+          }\n+        ],\n+        \"type\": [\n+          {\n+            \"coding\": [\n+              {\n+                \"system\": \"http://terminology.hl7.org/CodeSystem/organization-type\",\n+                \"code\": \"prov\",\n+                \"display\": \"Healthcare Provider\"\n+              }\n+            ]\n+          }\n+        ]\n+      }\n     }\n   ]\n }\n\ndiff --git a/examples/medplum-patient-intake-demo/src/bots/core/intake-form.ts b/examples/medplum-patient-intake-demo/src/bots/core/intake-form.ts\nindex cd4af7d997..9e2f713c1f 100644\n--- a/examples/medplum-patient-intake-demo/src/bots/core/intake-form.ts\n+++ b/examples/medplum-patient-intake-demo/src/bots/core/intake-form.ts\n@@ -1,5 +1,5 @@\n import { BotEvent, createReference, getQuestionnaireAnswers, MedplumClient } from '@medplum/core';\n-import { Patient, Questionnaire, QuestionnaireResponse } from '@medplum/fhirtypes';\n+import { Organization, Patient, Questionnaire, QuestionnaireResponse, Reference } from '@medplum/fhirtypes';\n import {\n   addAllergy,\n   addCondition,\n@@ -9,6 +9,7 @@ import {\n   addImmunization,\n   addLanguage,\n   addMedication,\n+  addPharmacy,\n   consentCategoryMapping,\n   consentPolicyRuleMapping,\n   consentScopeMapping,\n@@ -213,6 +214,13 @@ export async function handler(medplum: MedplumClient, event: BotEvent<Questionna\n     await addCoverage(medplum, patient, provider);\n   }\n \n+  // Handle preferred pharmacy\n+\n+  const preferredPharmacyReference = answers['preferred-pharmacy-reference']?.valueReference;\n+  if (preferredPharmacyReference) {\n+    await addPharmacy(medplum, patient, preferredPharmacyReference as Reference<Organization>);\n+  }\n+\n   // Handle consents\n \n   await addConsent(\n\ndiff --git a/examples/medplum-patient-intake-demo/src/bots/core/intake-utils.ts b/examples/medplum-patient-intake-demo/src/bots/core/intake-utils.ts\nindex 05f34898b9..5041bcef8e 100644\n--- a/examples/medplum-patient-intake-demo/src/bots/core/intake-utils.ts\n+++ b/examples/medplum-patient-intake-demo/src/bots/core/intake-utils.ts\n@@ -6,6 +6,7 @@ import {\n   HTTP_TERMINOLOGY_HL7_ORG,\n   LOINC,\n   MedplumClient,\n+  SNOMED,\n } from '@medplum/core';\n import {\n   Address,\n@@ -504,6 +505,38 @@ export async function addImmunization(\n   );\n }\n \n+/**\n+ * Adds a CareTeam resource associating the patient with a pharmacy\n+ *\n+ * @param medplum - The Medplum client\n+ * @param patient - The patient beneficiary of the care team\n+ * @param pharmacy - The pharmacy to be added to the care team\n+ */\n+export async function addPharmacy(\n+  medplum: MedplumClient,\n+  patient: Patient,\n+  pharmacy: Reference<Organization>\n+): Promise<void> {\n+  await medplum.upsertResource(\n+    {\n+      resourceType: 'CareTeam',\n+      status: 'proposed',\n+      name: 'Patient Preferred Pharmacy',\n+      subject: createReference(patient),\n+      participant: [\n+        {\n+          member: pharmacy,\n+          role: [{ coding: [{ system: SNOMED, code: '76166008', display: 'Practical aid (pharmacy) (occupation)' }] }],\n+        },\n+      ],\n+    },\n+    {\n+      name: 'Patient Preferred Pharmacy',\n+      subject: getReferenceString(patient),\n+    }\n+  );\n+}\n+\n /**\n  * Adds a Coverage resource\n  *\n",
    "test_patch": "diff --git a/examples/medplum-patient-intake-demo/src/bots/core/intake-form.test.ts b/examples/medplum-patient-intake-demo/src/bots/core/intake-form.test.ts\nindex 216560aeb9..2c477ee7f5 100644\n--- a/examples/medplum-patient-intake-demo/src/bots/core/intake-form.test.ts\n+++ b/examples/medplum-patient-intake-demo/src/bots/core/intake-form.test.ts\n@@ -5,6 +5,7 @@ import {\n   intakeResponse,\n   payorOrganization1,\n   payorOrganization2,\n+  pharmacyOrganization,\n } from './test-data/intake-form-test-data';\n import {\n   Bundle,\n@@ -35,7 +36,8 @@ describe('Intake form', async () => {\n     response: QuestionnaireResponse,\n     patient: Patient | undefined,\n     payor1: Organization,\n-    payor2: Organization;\n+    payor2: Organization,\n+    pharmacy: Organization;\n   const bot = { reference: 'Bot/123' };\n   const contentType = 'application/fhir+json';\n   const ssn = '518225060';\n@@ -53,6 +55,7 @@ describe('Intake form', async () => {\n     medplum = new MockClient();\n     payor1 = await medplum.createResource(payorOrganization1);\n     payor2 = await medplum.createResource(payorOrganization2);\n+    pharmacy = await medplum.createResource(pharmacyOrganization);\n     await medplum.createResource(intakeQuestionnaire);\n     response = await medplum.createResource(intakeResponse);\n   });\n@@ -395,6 +398,26 @@ describe('Intake form', async () => {\n     });\n   });\n \n+  describe('CareTeam', async () => {\n+    test('Preferred Pharmacy', async () => {\n+      await handler(medplum, { bot, input: response, contentType, secrets: {} });\n+\n+      patient = (await medplum.searchOne('Patient', `identifier=${ssn}`)) as Patient;\n+\n+      expect(patient).toBeDefined();\n+\n+      const careTeam = await medplum.searchResources('CareTeam', {\n+        subject: getReferenceString(patient),\n+      });\n+\n+      expect(careTeam.length).toEqual(1);\n+      expect(careTeam[0].status).toEqual('proposed');\n+      expect(careTeam[0].name).toEqual('Patient Preferred Pharmacy');\n+      expect(careTeam[0].participant?.length).toEqual(1);\n+      expect(careTeam[0].participant?.[0].member?.reference).toEqual(getReferenceString(pharmacy));\n+    });\n+  });\n+\n   describe('Coverage', async () => {\n     test('adds coverage resources', async () => {\n       await handler(medplum, { bot, input: response, contentType, secrets: {} });\n@@ -408,12 +431,12 @@ describe('Intake form', async () => {\n       expect(coverages[0].beneficiary).toEqual(createReference(patient));\n       expect(coverages[0].subscriberId).toEqual('first-provider-id');\n       expect(coverages[0].relationship?.coding?.[0]?.code).toEqual('self');\n-      expect(coverages[0].payor?.[0].reference).toEqual(createReference(payor1).reference);\n+      expect(coverages[0].payor?.[0].reference).toEqual(getReferenceString(payor1));\n \n       expect(coverages[1].beneficiary).toEqual(createReference(patient));\n       expect(coverages[1].subscriberId).toEqual('second-provider-id');\n       expect(coverages[1].relationship?.coding?.[0]?.code).toEqual('child');\n-      expect(coverages[1].payor?.[0].reference).toEqual(createReference(payor2).reference);\n+      expect(coverages[1].payor?.[0].reference).toEqual(getReferenceString(payor2));\n     });\n \n     test('upsert coverage resources to ensure there is only one coverage resource per payor', async () => {\n\ndiff --git a/examples/medplum-patient-intake-demo/src/bots/core/test-data/intake-form-test-data.ts b/examples/medplum-patient-intake-demo/src/bots/core/test-data/intake-form-test-data.ts\nindex 92e465ae41..b67b92d59e 100644\n--- a/examples/medplum-patient-intake-demo/src/bots/core/test-data/intake-form-test-data.ts\n+++ b/examples/medplum-patient-intake-demo/src/bots/core/test-data/intake-form-test-data.ts\n@@ -14,6 +14,12 @@ export const payorOrganization2: Organization = {\n   name: 'Second Insurance Provider',\n };\n \n+export const pharmacyOrganization: Organization = {\n+  resourceType: 'Organization',\n+  id: 'org-id-3',\n+  name: 'Pharmacy',\n+};\n+\n export const intakeQuestionnaire: Questionnaire = coreBundle.entry[0].resource as Questionnaire;\n intakeQuestionnaire.id = 'intake-questionnaire-id';\n \n@@ -870,6 +876,23 @@ export const intakeResponse: QuestionnaireResponse = {\n         },\n       ],\n     },\n+    {\n+      linkId: 'preferred-pharmacy',\n+      text: 'Preferred Pharmacy',\n+      item: [\n+        {\n+          linkId: 'preferred-pharmacy-reference',\n+          text: 'Pharmacy',\n+          answer: [\n+            {\n+              valueReference: {\n+                reference: getReferenceString(pharmacyOrganization),\n+              },\n+            },\n+          ],\n+        },\n+      ],\n+    },\n     {\n       id: 'id-65',\n       linkId: 'consent-for-treatment',\n",
    "agent_patch": null,
    "FAIL_TO_PASS": [],
    "PASS_TO_PASS": [],
    "test_output_before": null,
    "errors_before": [],
    "failed_before": [],
    "test_output_after": null,
    "errors_after": [],
    "failed_after": []
  }
]